<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.23">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Behrouz Delfanian">

<title>Generating Time Series</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="generating_time_series_files/libs/clipboard/clipboard.min.js"></script>
<script src="generating_time_series_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="generating_time_series_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="generating_time_series_files/libs/quarto-html/popper.min.js"></script>
<script src="generating_time_series_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="generating_time_series_files/libs/quarto-html/anchor.min.js"></script>
<link href="generating_time_series_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="generating_time_series_files/libs/quarto-html/quarto-syntax-highlighting-226bd0f977fa82dfae4534cac220d79a.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="generating_time_series_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="generating_time_series_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="generating_time_series_files/libs/bootstrap/bootstrap-c55efa1fd218a545ebab9e5bcab7af02.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="generating_time_series_files/libs/kePrint-0.0.1/kePrint.js"></script>

<link href="generating_time_series_files/libs/lightable-0.0.1/lightable.css" rel="stylesheet">


  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#r-environment-setting" id="toc-r-environment-setting" class="nav-link active" data-scroll-target="#r-environment-setting"><span class="header-section-number">1</span> R environment setting</a></li>
  <li><a href="#time-series-overview" id="toc-time-series-overview" class="nav-link" data-scroll-target="#time-series-overview"><span class="header-section-number">2</span> Time series overview</a>
  <ul class="collapse">
  <li><a href="#what-is-a-time-series" id="toc-what-is-a-time-series" class="nav-link" data-scroll-target="#what-is-a-time-series"><span class="header-section-number">2.1</span> What is a time series?</a></li>
  <li><a href="#key-components" id="toc-key-components" class="nav-link" data-scroll-target="#key-components"><span class="header-section-number">2.2</span> Key components</a></li>
  <li><a href="#models-of-time-series" id="toc-models-of-time-series" class="nav-link" data-scroll-target="#models-of-time-series"><span class="header-section-number">2.3</span> Models of time series</a></li>
  <li><a href="#applications-in-supply-chain" id="toc-applications-in-supply-chain" class="nav-link" data-scroll-target="#applications-in-supply-chain"><span class="header-section-number">2.4</span> Applications in supply chain</a></li>
  </ul></li>
  <li><a href="#generating-a-ts-components" id="toc-generating-a-ts-components" class="nav-link" data-scroll-target="#generating-a-ts-components"><span class="header-section-number">3</span> Generating a TS components</a>
  <ul class="collapse">
  <li><a href="#deterministic-component" id="toc-deterministic-component" class="nav-link" data-scroll-target="#deterministic-component"><span class="header-section-number">3.1</span> Deterministic component</a>
  <ul class="collapse">
  <li><a href="#trend-component" id="toc-trend-component" class="nav-link" data-scroll-target="#trend-component"><span class="header-section-number">3.1.1</span> Trend component</a></li>
  <li><a href="#seasonality-component" id="toc-seasonality-component" class="nav-link" data-scroll-target="#seasonality-component"><span class="header-section-number">3.1.2</span> Seasonality component</a></li>
  <li><a href="#additive-model" id="toc-additive-model" class="nav-link" data-scroll-target="#additive-model"><span class="header-section-number">3.1.3</span> Additive model</a></li>
  <li><a href="#multiplicative-model" id="toc-multiplicative-model" class="nav-link" data-scroll-target="#multiplicative-model"><span class="header-section-number">3.1.4</span> Multiplicative model</a></li>
  </ul></li>
  <li><a href="#random-component" id="toc-random-component" class="nav-link" data-scroll-target="#random-component"><span class="header-section-number">3.2</span> Random component</a>
  <ul class="collapse">
  <li><a href="#gaussain-noise" id="toc-gaussain-noise" class="nav-link" data-scroll-target="#gaussain-noise"><span class="header-section-number">3.2.1</span> Gaussain noise</a></li>
  <li><a href="#poisson-noise" id="toc-poisson-noise" class="nav-link" data-scroll-target="#poisson-noise"><span class="header-section-number">3.2.2</span> Poisson Noise</a></li>
  <li><a href="#negative-binomial-noise" id="toc-negative-binomial-noise" class="nav-link" data-scroll-target="#negative-binomial-noise"><span class="header-section-number">3.2.3</span> Negative Binomial noise</a></li>
  <li><a href="#gamma-noise" id="toc-gamma-noise" class="nav-link" data-scroll-target="#gamma-noise"><span class="header-section-number">3.2.4</span> Gamma noise</a></li>
  <li><a href="#log-normal-noise" id="toc-log-normal-noise" class="nav-link" data-scroll-target="#log-normal-noise"><span class="header-section-number">3.2.5</span> Log-Normal noise</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#ts-noise-modelling" id="toc-ts-noise-modelling" class="nav-link" data-scroll-target="#ts-noise-modelling"><span class="header-section-number">4</span> TS noise modelling</a>
  <ul class="collapse">
  <li><a href="#review-of-the-additive-model" id="toc-review-of-the-additive-model" class="nav-link" data-scroll-target="#review-of-the-additive-model"><span class="header-section-number">4.1</span> Review of the additive model</a>
  <ul class="collapse">
  <li><a href="#load-the-data" id="toc-load-the-data" class="nav-link" data-scroll-target="#load-the-data"><span class="header-section-number">4.1.1</span> Load the data</a></li>
  <li><a href="#trend-component-1" id="toc-trend-component-1" class="nav-link" data-scroll-target="#trend-component-1"><span class="header-section-number">4.1.2</span> Trend component</a></li>
  <li><a href="#seasonal-component" id="toc-seasonal-component" class="nav-link" data-scroll-target="#seasonal-component"><span class="header-section-number">4.1.3</span> Seasonal component</a></li>
  <li><a href="#original-time-series" id="toc-original-time-series" class="nav-link" data-scroll-target="#original-time-series"><span class="header-section-number">4.1.4</span> Original time series</a></li>
  </ul></li>
  <li><a href="#noise-with-constant-rate" id="toc-noise-with-constant-rate" class="nav-link" data-scroll-target="#noise-with-constant-rate"><span class="header-section-number">4.2</span> Noise with constant rate</a></li>
  <li><a href="#noise-with-proportional-rate" id="toc-noise-with-proportional-rate" class="nav-link" data-scroll-target="#noise-with-proportional-rate"><span class="header-section-number">4.3</span> Noise with proportional rate</a>
  <ul class="collapse">
  <li><a href="#additive-interpretation" id="toc-additive-interpretation" class="nav-link" data-scroll-target="#additive-interpretation"><span class="header-section-number">4.3.1</span> Additive interpretation</a></li>
  <li><a href="#multiplicative-equivalence" id="toc-multiplicative-equivalence" class="nav-link" data-scroll-target="#multiplicative-equivalence"><span class="header-section-number">4.3.2</span> Multiplicative equivalence</a></li>
  <li><a href="#implementation" id="toc-implementation" class="nav-link" data-scroll-target="#implementation"><span class="header-section-number">4.3.3</span> Implementation</a></li>
  <li><a href="#interpretation" id="toc-interpretation" class="nav-link" data-scroll-target="#interpretation"><span class="header-section-number">4.3.4</span> Interpretation</a></li>
  </ul></li>
  <li><a href="#analysis" id="toc-analysis" class="nav-link" data-scroll-target="#analysis"><span class="header-section-number">4.4</span> Analysis</a>
  <ul class="collapse">
  <li><a href="#visualizing-yearly-seasonality" id="toc-visualizing-yearly-seasonality" class="nav-link" data-scroll-target="#visualizing-yearly-seasonality"><span class="header-section-number">4.4.1</span> Visualizing yearly seasonality</a></li>
  <li><a href="#trend-analysis" id="toc-trend-analysis" class="nav-link" data-scroll-target="#trend-analysis"><span class="header-section-number">4.4.2</span> Trend analysis</a></li>
  <li><a href="#seasonality" id="toc-seasonality" class="nav-link" data-scroll-target="#seasonality"><span class="header-section-number">4.4.3</span> Seasonality</a></li>
  <li><a href="#noise-extraction" id="toc-noise-extraction" class="nav-link" data-scroll-target="#noise-extraction"><span class="header-section-number">4.4.4</span> Noise extraction</a></li>
  <li><a href="#modeling-multiplicative-noise" id="toc-modeling-multiplicative-noise" class="nav-link" data-scroll-target="#modeling-multiplicative-noise"><span class="header-section-number">4.4.5</span> Modeling multiplicative noise</a></li>
  </ul></li>
  <li><a href="#modeling-wrap-up" id="toc-modeling-wrap-up" class="nav-link" data-scroll-target="#modeling-wrap-up"><span class="header-section-number">4.5</span> Modeling wrap-up</a>
  <ul class="collapse">
  <li><a href="#trend" id="toc-trend" class="nav-link" data-scroll-target="#trend"><span class="header-section-number">4.5.1</span> Trend</a></li>
  <li><a href="#seasonality-1" id="toc-seasonality-1" class="nav-link" data-scroll-target="#seasonality-1"><span class="header-section-number">4.5.2</span> Seasonality:</a></li>
  <li><a href="#noise" id="toc-noise" class="nav-link" data-scroll-target="#noise"><span class="header-section-number">4.5.3</span> Noise</a></li>
  <li><a href="#additive-vs.-multiplicative-noise" id="toc-additive-vs.-multiplicative-noise" class="nav-link" data-scroll-target="#additive-vs.-multiplicative-noise"><span class="header-section-number">4.5.4</span> Additive vs.&nbsp;multiplicative noise</a></li>
  </ul></li>
  <li><a href="#real-case-walmart-2010" id="toc-real-case-walmart-2010" class="nav-link" data-scroll-target="#real-case-walmart-2010"><span class="header-section-number">4.6</span> Real case: Walmart 2010</a>
  <ul class="collapse">
  <li><a href="#dataset" id="toc-dataset" class="nav-link" data-scroll-target="#dataset"><span class="header-section-number">4.6.1</span> Dataset</a></li>
  <li><a href="#inspecting-the-training-data" id="toc-inspecting-the-training-data" class="nav-link" data-scroll-target="#inspecting-the-training-data"><span class="header-section-number">4.6.2</span> Inspecting the training data</a></li>
  <li><a href="#year-over-year-analysis" id="toc-year-over-year-analysis" class="nav-link" data-scroll-target="#year-over-year-analysis"><span class="header-section-number">4.6.3</span> Year-over-year analysis</a></li>
  <li><a href="#trend-analysis-1" id="toc-trend-analysis-1" class="nav-link" data-scroll-target="#trend-analysis-1"><span class="header-section-number">4.6.4</span> Trend analysis</a></li>
  <li><a href="#seasonality-and-noise-analysis" id="toc-seasonality-and-noise-analysis" class="nav-link" data-scroll-target="#seasonality-and-noise-analysis"><span class="header-section-number">4.6.5</span> Seasonality and noise analysis</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#frequency-analysis-of-time-series" id="toc-frequency-analysis-of-time-series" class="nav-link" data-scroll-target="#frequency-analysis-of-time-series"><span class="header-section-number">5</span> Frequency analysis of time series</a>
  <ul class="collapse">
  <li><a href="#fourier-transform" id="toc-fourier-transform" class="nav-link" data-scroll-target="#fourier-transform"><span class="header-section-number">5.1</span> Fourier transform</a></li>
  <li><a href="#fa-of-synthetic-time-series" id="toc-fa-of-synthetic-time-series" class="nav-link" data-scroll-target="#fa-of-synthetic-time-series"><span class="header-section-number">5.2</span> FA of synthetic time series</a>
  <ul class="collapse">
  <li><a href="#loading-and-visualizing-the-data" id="toc-loading-and-visualizing-the-data" class="nav-link" data-scroll-target="#loading-and-visualizing-the-data"><span class="header-section-number">5.2.1</span> Loading and visualizing the data</a></li>
  <li><a href="#computing-the-fourier-transform" id="toc-computing-the-fourier-transform" class="nav-link" data-scroll-target="#computing-the-fourier-transform"><span class="header-section-number">5.2.2</span> Computing the Fourier transform</a></li>
  <li><a href="#plotting-frequency-magnitudes" id="toc-plotting-frequency-magnitudes" class="nav-link" data-scroll-target="#plotting-frequency-magnitudes"><span class="header-section-number">5.2.3</span> Plotting frequency magnitudes</a></li>
  <li><a href="#thresholding-and-inverse-fourier-transform" id="toc-thresholding-and-inverse-fourier-transform" class="nav-link" data-scroll-target="#thresholding-and-inverse-fourier-transform"><span class="header-section-number">5.2.4</span> Thresholding and inverse Fourier transform</a></li>
  <li><a href="#analyzing-noise" id="toc-analyzing-noise" class="nav-link" data-scroll-target="#analyzing-noise"><span class="header-section-number">5.2.5</span> Analyzing noise</a></li>
  <li><a href="#phase-analysis" id="toc-phase-analysis" class="nav-link" data-scroll-target="#phase-analysis"><span class="header-section-number">5.2.6</span> Phase analysis</a></li>
  </ul></li>
  <li><a href="#auto-correlation" id="toc-auto-correlation" class="nav-link" data-scroll-target="#auto-correlation"><span class="header-section-number">5.3</span> Auto-correlation</a></li>
  <li><a href="#real-life-data" id="toc-real-life-data" class="nav-link" data-scroll-target="#real-life-data"><span class="header-section-number">5.4</span> Real-life data</a>
  <ul class="collapse">
  <li><a href="#loading-and-visualizing-the-data-1" id="toc-loading-and-visualizing-the-data-1" class="nav-link" data-scroll-target="#loading-and-visualizing-the-data-1"><span class="header-section-number">5.4.1</span> Loading and Visualizing the Data</a></li>
  <li><a href="#smoothing-analysis" id="toc-smoothing-analysis" class="nav-link" data-scroll-target="#smoothing-analysis"><span class="header-section-number">5.4.2</span> Smoothing analysis</a></li>
  <li><a href="#fourier-analysis" id="toc-fourier-analysis" class="nav-link" data-scroll-target="#fourier-analysis"><span class="header-section-number">5.4.3</span> Fourier analysis</a></li>
  </ul></li>
  <li><a href="#homeworks" id="toc-homeworks" class="nav-link" data-scroll-target="#homeworks"><span class="header-section-number">5.5</span> Homeworks</a>
  <ul class="collapse">
  <li><a href="#homework-1-de-trending-before-fft-analysis" id="toc-homework-1-de-trending-before-fft-analysis" class="nav-link" data-scroll-target="#homework-1-de-trending-before-fft-analysis"><span class="header-section-number">5.5.1</span> Homework 1: De-trending Before FFT Analysis</a></li>
  <li><a href="#homework-2-recovering-a-poisson-like-noise-distribution-from-synthetic-data" id="toc-homework-2-recovering-a-poisson-like-noise-distribution-from-synthetic-data" class="nav-link" data-scroll-target="#homework-2-recovering-a-poisson-like-noise-distribution-from-synthetic-data"><span class="header-section-number">5.5.2</span> Homework 2: Recovering a Poisson-like Noise Distribution from Synthetic Data</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#using-libraries-for-trend-seasonality" id="toc-using-libraries-for-trend-seasonality" class="nav-link" data-scroll-target="#using-libraries-for-trend-seasonality"><span class="header-section-number">6</span> Using libraries for trend &amp; seasonality</a>
  <ul class="collapse">
  <li><a href="#univariate-time-series" id="toc-univariate-time-series" class="nav-link" data-scroll-target="#univariate-time-series"><span class="header-section-number">6.1</span> Univariate time series</a>
  <ul class="collapse">
  <li><a href="#load-synthetic-data" id="toc-load-synthetic-data" class="nav-link" data-scroll-target="#load-synthetic-data"><span class="header-section-number">6.1.1</span> Load synthetic data</a></li>
  <li><a href="#load-walmart-real-data" id="toc-load-walmart-real-data" class="nav-link" data-scroll-target="#load-walmart-real-data"><span class="header-section-number">6.1.2</span> Load Walmart (real) data</a></li>
  <li><a href="#turn-data-frames-into-tsibble-objects" id="toc-turn-data-frames-into-tsibble-objects" class="nav-link" data-scroll-target="#turn-data-frames-into-tsibble-objects"><span class="header-section-number">6.1.3</span> Turn data frames into <code>tsibble</code> objects</a></li>
  </ul></li>
  <li><a href="#classical-additive-decomposition-moving-averages" id="toc-classical-additive-decomposition-moving-averages" class="nav-link" data-scroll-target="#classical-additive-decomposition-moving-averages"><span class="header-section-number">6.2</span> Classical additive decomposition (moving averages)</a>
  <ul class="collapse">
  <li><a href="#tweaking-the-season-length" id="toc-tweaking-the-season-length" class="nav-link" data-scroll-target="#tweaking-the-season-length"><span class="header-section-number">6.2.1</span> Tweaking the season length</a></li>
  </ul></li>
  <li><a href="#stl-from-feasts-tidyverts" id="toc-stl-from-feasts-tidyverts" class="nav-link" data-scroll-target="#stl-from-feasts-tidyverts"><span class="header-section-number">6.3</span> STL from feasts (tidyverts)</a></li>
  <li><a href="#multiple-time-series" id="toc-multiple-time-series" class="nav-link" data-scroll-target="#multiple-time-series"><span class="header-section-number">6.4</span> Multiple time series</a>
  <ul class="collapse">
  <li><a href="#detect-gaps" id="toc-detect-gaps" class="nav-link" data-scroll-target="#detect-gaps"><span class="header-section-number">6.4.1</span> Detect gaps</a></li>
  <li><a href="#fill-gaps-keep-original-keys" id="toc-fill-gaps-keep-original-keys" class="nav-link" data-scroll-target="#fill-gaps-keep-original-keys"><span class="header-section-number">6.4.2</span> Fill gaps (keep original keys)</a></li>
  <li><a href="#keep-only-complete-series" id="toc-keep-only-complete-series" class="nav-link" data-scroll-target="#keep-only-complete-series"><span class="header-section-number">6.4.3</span> Keep only complete series</a></li>
  </ul></li>
  <li><a href="#stl-feature-extraction" id="toc-stl-feature-extraction" class="nav-link" data-scroll-target="#stl-feature-extraction"><span class="header-section-number">6.5</span> STL feature extraction</a></li>
  <li><a href="#python-implementation" id="toc-python-implementation" class="nav-link" data-scroll-target="#python-implementation"><span class="header-section-number">6.6</span> Python implementation</a></li>
  <li><a href="#homework" id="toc-homework" class="nav-link" data-scroll-target="#homework"><span class="header-section-number">6.7</span> Homework</a>
  <ul class="collapse">
  <li><a href="#exploratory-data-analysis" id="toc-exploratory-data-analysis" class="nav-link" data-scroll-target="#exploratory-data-analysis"><span class="header-section-number">6.7.1</span> Exploratory Data Analysis</a></li>
  <li><a href="#stl-decomposition-analysis" id="toc-stl-decomposition-analysis" class="nav-link" data-scroll-target="#stl-decomposition-analysis"><span class="header-section-number">6.7.2</span> STL Decomposition Analysis</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Generating Time Series</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Behrouz Delfanian </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="r-environment-setting" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> R environment setting</h1>
<p>Installing required libraries</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>cran_repo <span class="ot">&lt;-</span> <span class="st">"https://ftp.fau.de/cran"</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>list_Rpack2use <span class="ot">&lt;-</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"rmarkdown"</span>,</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"conflicted"</span>,</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"devtools"</span>,</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"knitr"</span>,</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"quarto"</span>,</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"bookdown"</span>,</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">#shiny,</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"DT"</span>,</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Hmisc"</span>,</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"tidyverse"</span>,</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"magrittr"</span>,</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lubridate"</span>,</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hms"</span>,</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"glue"</span>,</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"skimr"</span>,</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lobstr"</span>,</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"janitor"</span>,</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"zeallot"</span>,</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"stringi"</span>,</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lemon"</span>,</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"crayon"</span>,</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"jsonlite"</span>,</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">#"officer",</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"TSA"</span>,</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"tsibble"</span>,</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fable"</span>,</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"feasts"</span>,</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">"imputeTS"</span>,</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">"readxl"</span>,</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">"slider"</span>,</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">"reticulate"</span>,</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">"aws.s3"</span>,</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">"paws"</span>,</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">"RAthena"</span>,</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">"botor"</span>,</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>    <span class="st">"RPostgres"</span>,</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>    <span class="st">"DBI"</span>,</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>    <span class="st">"RJDBC"</span>,</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>    <span class="st">"dbplyr"</span>,</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>    <span class="st">"arrow"</span>,</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>    <span class="st">"geosphere"</span>,</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>    <span class="st">"viridis"</span>,</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>    <span class="st">"patchwork"</span>,</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>    <span class="st">"scales"</span>)</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>list_installed_packages <span class="ot">&lt;-</span> <span class="fu">names</span>(<span class="fu">installed.packages</span>()[,<span class="dv">2</span>])</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (Rpack <span class="cf">in</span> list_Rpack2use) {</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span> Rpack <span class="sc">%in%</span> list_installed_packages) {</span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"Installing"</span>, Rpack))</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">install.packages</span>(Rpack, <span class="at">repos =</span> cran_repo)</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">paste</span>(Rpack, <span class="st">"already installed."</span>))</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Loading librairies</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>list_Rpack2load_not <span class="ot">&lt;-</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"conflicted"</span>,</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"devtools"</span>,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"paws"</span>,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"RAthena"</span>,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"botor"</span>,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"arrow"</span>,</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"RPostgres"</span>,</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"DBI"</span>,</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"RJDBC"</span>,</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"dbplyr"</span>,</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"aws.s3"</span>,</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"arrow"</span>,</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"reticulate"</span>,</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"slider"</span>,</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"stringi"</span>,</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"geosphere"</span>,</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"blah"</span>)</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>list_Rpack2load <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(list_Rpack2use, list_Rpack2load_not)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>list_Rpack2load</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "rmarkdown" "knitr"     "quarto"    "bookdown"  "DT"        "Hmisc"    
 [7] "tidyverse" "magrittr"  "lubridate" "hms"       "glue"      "skimr"    
[13] "lobstr"    "janitor"   "zeallot"   "lemon"     "crayon"    "jsonlite" 
[19] "TSA"       "tsibble"   "fable"     "feasts"    "imputeTS"  "readxl"   
[25] "viridis"   "patchwork" "scales"   </code></pre>
</div>
</div>
<p>Resolving function name conflicts</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (Rpack <span class="cf">in</span> list_Rpack2load) {</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(Rpack, <span class="at">character.only =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(pillar<span class="sc">::</span>dim_desc)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(magrittr<span class="sc">::</span>extract)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(dplyr<span class="sc">::</span>filter)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(jsonlite<span class="sc">::</span>flatten)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(hms<span class="sc">::</span>hms)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(dbplyr<span class="sc">::</span>ident)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(lubridate<span class="sc">::</span>interval)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(dplyr<span class="sc">::</span>lag)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(readxl<span class="sc">::</span>read_xlsx)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(magrittr<span class="sc">::</span>set_names)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(dbplyr<span class="sc">::</span>sql)</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(Hmisc<span class="sc">::</span>src)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(dplyr<span class="sc">::</span>summarize)</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(magrittr<span class="sc">::</span>is_in)</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(stats<span class="sc">::</span>chisq.test)</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="co">#To pass if interactive</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="co">#rendering &lt;- TRUE</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="co">#time_all &lt;- proc.time()</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"./scripts_gal/misc_funs.R"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="time-series-overview" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Time series overview</h1>
<section id="what-is-a-time-series" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="what-is-a-time-series"><span class="header-section-number">2.1</span> What is a time series?</h2>
<p>A <strong>time series</strong> is a sequence of data points recorded over time at <strong>equally spaced intervals</strong> (e.g., daily sales, monthly demand, yearly GDP).<br>
It captures the <strong>temporal dynamics</strong> of a process and is central to <strong>forecasting</strong> in supply chains, finance, weather, and many other fields.</p>
</section>
<section id="key-components" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="key-components"><span class="header-section-number">2.2</span> Key components</h2>
<ol type="1">
<li><strong>Trend (T)</strong>
<ul>
<li>The <strong>long-term</strong> progression of the series (upward, downward, or stable).<br>
</li>
<li>Reflects overall growth, decline, or stagnation.<br>
</li>
<li><em>Example:</em> gradual increase in online sales over years.</li>
</ul></li>
<li><strong>Seasonality (S)</strong>
<ul>
<li><em>Regular, repeating patterns at fixed periods</em> (daily, weekly, monthly, yearly).<br>
</li>
<li><em>Example:</em> ice cream sales peaking every summer.</li>
</ul></li>
<li><strong>Cyclic component (C)</strong>
<ul>
<li>Long-term oscillations around the trend, often tied to <em>economic/business</em> cycles.<br>
</li>
<li>Unlike seasonality, cycles are <strong>irregular</strong> in <strong>length and amplitude</strong>.<br>
</li>
<li><em>Example:</em> economic boom and recession cycles.</li>
</ul></li>
<li><strong>Irregular / Random (I)</strong>
<ul>
<li>Unpredictable, residual variations after accounting for trend, seasonality, and cycles.<br>
</li>
<li><em>Example:</em> sudden demand spikes due to supply chain disruptions.</li>
</ul></li>
</ol>
</section>
<section id="models-of-time-series" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="models-of-time-series"><span class="header-section-number">2.3</span> Models of time series</h2>
<ul>
<li><p><strong>Additive model:</strong><br>
<span class="math display">\[
Y_t = T_t + S_t + C_t + I_t
\]</span><br>
Suitable when <strong>seasonal variations</strong> remain <strong>constant in magnitude</strong>.</p></li>
<li><p><strong>Multiplicative model:</strong><br>
<span class="math display">\[
Y_t = T_t \times S_t \times C_t \times I_t
\]</span><br>
Suitable when <strong>seasonal variations</strong> change <strong>proportionally</strong> with the level of the series.</p></li>
</ul>
</section>
<section id="applications-in-supply-chain" class="level2" data-number="2.4">
<h2 data-number="2.4" class="anchored" data-anchor-id="applications-in-supply-chain"><span class="header-section-number">2.4</span> Applications in supply chain</h2>
<ul>
<li><strong>Demand forecasting</strong> → anticipating future <em>product demand</em>.<br>
</li>
<li><strong>Inventory control</strong> → optimizing <em>stock</em> based on demand variability.<br>
</li>
<li><strong>Capacity planning</strong> → adjusting <em>workforce</em> or <em>production</em> to meet seasonal/cyclic needs.</li>
</ul>
</section>
</section>
<section id="generating-a-ts-components" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Generating a TS components</h1>
<p>A TS has some <strong>deterministic</strong> components (the “signal”) and some <strong>random</strong> component (the “noise”).<br>
</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Usually we want to <strong>extract the signal</strong>, and <strong>model the noise</strong>.<br>
</p>
</div>
</div>
<p>Here, since we are generating a TS, we start with some signal and then add the noise.<br>
</p>
<section id="deterministic-component" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="deterministic-component"><span class="header-section-number">3.1</span> Deterministic component</h2>
<p>When building or simulating a time series, it is useful to separate <strong>deterministic components</strong> (signal) from <strong>stochastic components</strong> (noise).</p>
<p>The deterministic part can include:</p>
<ul>
<li><strong>Trend</strong> — a systematic long-term increase or decrease in the series.</li>
<li><strong>Seasonality</strong> — <em>recurring fluctuations</em> tied to the calendar (daily, weekly, yearly, etc.).</li>
<li>Other <strong>structural components</strong> — for example, cycles linked to macroeconomic factors.</li>
</ul>
<section id="trend-component" class="level3" data-number="3.1.1">
<h3 data-number="3.1.1" class="anchored" data-anchor-id="trend-component"><span class="header-section-number">3.1.1</span> Trend component</h3>
<p>We start simple with a linear trend. We’ll be optimistic and assume we have a steady trend of <span class="math inline">\(\alpha= 0.5\)</span> per year starting from a number of units (say thousands of items) of <span class="math inline">\(y_0 = 5\)</span>.</p>
<section id="linear-trend" class="level4" data-number="3.1.1.1">
<h4 data-number="3.1.1.1" class="anchored" data-anchor-id="linear-trend"><span class="header-section-number">3.1.1.1</span> Linear trend</h4>
<p><span class="math display">\[
tr(t) = y_0 + \alpha*\frac{t}{365}
\]</span></p>
</section>
<section id="exponential-trend" class="level4" data-number="3.1.1.2">
<h4 data-number="3.1.1.2" class="anchored" data-anchor-id="exponential-trend"><span class="header-section-number">3.1.1.2</span> Exponential trend</h4>
<p>If instead of a linear trend we assume a <strong>constant proportional daily growth rate (<span class="math inline">\(1 + \beta_d\)</span>)</strong>, then the trend is exponential.</p>
<p>After <strong>one day</strong>, the demand’s trend would be <span class="math inline">\(y_0*(1 + \beta_d)\)</span>, and after <span class="math inline">\(t\)</span> days, the demand’s trend would be <span class="math inline">\(y_0*(1 + \beta_d)^t\)</span>.</p>
<p>The daily growth rate can be derived from the yearly one:</p>
<p><span class="math display">\[
1 + \beta_d = 1 + \frac{\beta_y}{365} \approx e^{\frac{\beta_y}{365}}
\]</span></p>
<p>Consequently:</p>
<p><span class="math display">\[
tr(t) = y_0*(1 + \beta_d)^t \approx y_0*(e^{\frac{\beta_y}{365}})^t
\]</span> For <span class="math inline">\(\beta_y = 0.1\)</span>:</p>
<p><span class="math display">\[
tr(t) = y_0 * (e^{\frac{0.1}{365}})^t
\]</span></p>
</section>
</section>
<section id="seasonality-component" class="level3" data-number="3.1.2">
<h3 data-number="3.1.2" class="anchored" data-anchor-id="seasonality-component"><span class="header-section-number">3.1.2</span> Seasonality component</h3>
<p>Seasonality captures <strong>repeated, systematic fluctuations</strong> that recur with a fixed period.<br>
</p>
<ul>
<li><p>Example: retail sales increase every December (yearly seasonality).<br>
</p></li>
<li><p>In our toy model, we assume <strong>only one yearly seasonal effect</strong>.<br>
</p></li>
<li><p>Later, this framework can be extended to <strong>multiple overlapping seasonalities</strong> (e.g., weekly + yearly).</p></li>
</ul>
<p>Here, we start with only one yearly seasonality <strong><span class="math inline">\(s(t)\)</span></strong> (with yearly period).</p>
<p>We smooth the raw seasonal pattern and normalize it so that it has mean zero, ensuring the trend drives the long-run growth.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>trend_y <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"># yearly trend</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>start_ts <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># starting value of the series</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>sea_0 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">10</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co"># sea_0 contains a seasonal adjustment for each month. </span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co"># These values represent typical deviations from the trend for each month.</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>df_sea <span class="ot">&lt;-</span> </span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">day =</span> <span class="fu">seq</span>(<span class="fu">as_date</span>(<span class="st">"2022-12-28"</span>), <span class="fu">today</span>() <span class="sc">+</span> <span class="fu">days</span>(<span class="dv">3</span>), <span class="at">by =</span> <span class="st">"day"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generates a daily sequence of dates</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mon =</span> <span class="fu">month</span>(day),</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">sea =</span> <span class="fu">map2_dbl</span>(mon, day, <span class="sc">~</span> <span class="fu">if_else</span>((<span class="fu">str_split</span>(.y, <span class="at">pattern =</span> <span class="st">"-"</span>) <span class="sc">%&gt;%</span> <span class="fu">extract2</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> <span class="fu">extract</span>(<span class="dv">3</span>) <span class="sc">%&gt;%</span> as.numeric) <span class="sc">==</span> <span class="dv">15</span>, sea_0[.x], <span class="cn">NA</span>)),</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Map monthly seasonal values to the middle of each month</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>         <span class="co"># This creates monthly anchor points for the seasonal component.</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>         <span class="at">sea =</span> <span class="fu">na_interpolation</span>(sea, <span class="at">option =</span> <span class="st">"spline"</span>),</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Interpolate missing seasonal values</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Fills in the NA values using spline interpolation, creating a smooth seasonal curve.</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>         <span class="at">sea =</span> zoo<span class="sc">::</span><span class="fu">rollmean</span>(sea, <span class="at">k =</span> <span class="dv">7</span>, <span class="at">fill =</span> <span class="cn">TRUE</span>),</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Smooth the seasonal curve further</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Applies a 7-day rolling mean to smooth short-term fluctuations.</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>         <span class="at">sea =</span> sea <span class="sc">-</span> <span class="fu">mean</span>(sea)) <span class="sc">%&gt;%</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Center the seasonal component around zero</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(day <span class="sc">&gt;=</span> <span class="st">"2023-01-01"</span>,</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>         day <span class="sc">&lt;=</span> <span class="fu">today</span>())</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&gt;%</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> sea)) <span class="sc">+</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"#00BFC4"</span>, <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Seasonality component"</span>,</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Value"</span>, <span class="at">x =</span> <span class="st">"Day"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/seasonality_def_plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="additive-model" class="level3" data-number="3.1.3">
<h3 data-number="3.1.3" class="anchored" data-anchor-id="additive-model"><span class="header-section-number">3.1.3</span> Additive model</h3>
<p>Let’s focus on one item and write <span class="math inline">\(y_t\)</span> for counts of orders for this item, and assume we have daily counts since <strong>January 1st, 2023</strong>, with no missing data.</p>
<p>We can put together the <strong>trend</strong> and the <strong>seasonality</strong> in an <strong>additive</strong> way to get the time series’ deterministic component:</p>
<p><span class="math display">\[
y_t^{\text{(d)}} = tr(t) + S(t)
\]</span></p>
<ul>
<li>With the linear trend<br>
</li>
</ul>
<p><span class="math display">\[
tr(t) = y_0 + \alpha*\frac{t}{365}
\]</span></p>
<p><span class="math display">\[
S(t) = s(t)
\]</span></p>
<p><span class="math display">\[
y_t^{\text{(d)}} = y_0 + \alpha*\frac{t}{365} + s(t)
\]</span></p>
<ul>
<li>With the exponential trend<br>
</li>
</ul>
<p>It would also make sense to <strong>multiply the seasonality by the growth rate</strong>. So, after <span class="math inline">\(t\)</span> days, the deterministic component would be:</p>
<p><span class="math display">\[
tr(t) = y_0*(e^{\frac{\beta_y}{365}})^t
\]</span></p>
<p><span class="math display">\[
S(t) = s(t)*(e^{\frac{\beta_y}{365}})^t
\]</span></p>
<p><span class="math display">\[
y_t^{\text{(d)}} = (y_0 + s(t))*(e^{\frac{\beta_y}{365}})^t
\]</span></p>
<p>For <span class="math inline">\(\beta_y = 0.1\)</span>:</p>
<p><span class="math display">\[
y_t^{\text{(d)}} = (y_0 + s(t))*(e^{\frac{0.1}{365}})^t
\]</span></p>
<section id="plotting-the-deterministic-component" class="level4" data-number="3.1.3.1">
<h4 data-number="3.1.3.1" class="anchored" data-anchor-id="plotting-the-deterministic-component"><span class="header-section-number">3.1.3.1</span> Plotting the deterministic component</h4>
<p>Here we can visualize how the trend and seasonality combine over time to form the deterministic part of the time series.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&lt;&gt;%</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tr_lin =</span> start_ts <span class="sc">+</span> trend_y <span class="sc">*</span> <span class="fu">row_number</span>() <span class="sc">/</span> <span class="dv">365</span>,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">tr_exp =</span> start_ts <span class="sc">*</span> <span class="fu">exp</span>(<span class="fl">0.1</span> <span class="sc">/</span> <span class="dv">365</span>)<span class="sc">^</span><span class="fu">row_number</span>(),</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">yd_lin =</span> tr_lin <span class="sc">+</span> sea,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">yd_exp =</span> (start_ts <span class="sc">+</span> sea) <span class="sc">*</span> <span class="fu">exp</span>(<span class="fl">0.1</span> <span class="sc">/</span> <span class="dv">365</span>)<span class="sc">^</span><span class="fu">row_number</span>())</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&gt;%</span> </span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(tr_lin, tr_exp, yd_lin, yd_exp), </span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">"func"</span>, <span class="st">"method"</span>), </span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_sep =</span> <span class="st">"_"</span>, </span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">func =</span> <span class="fu">factor</span>(func, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"yd"</span>, <span class="st">"tr"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> method,</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>                  <span class="at">linetype =</span> func), <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Additive Deterministic Component"</span>,</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Value"</span>, <span class="at">x =</span> <span class="st">"Date"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/deterministic_comp-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="multiplicative-model" class="level3" data-number="3.1.4">
<h3 data-number="3.1.4" class="anchored" data-anchor-id="multiplicative-model"><span class="header-section-number">3.1.4</span> Multiplicative model</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Multiplicative deterministic component</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&lt;&gt;%</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Linear trend (for comparison)</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">tr_lin =</span> start_ts <span class="sc">+</span> trend_y <span class="sc">*</span> <span class="fu">row_number</span>() <span class="sc">/</span> <span class="dv">365</span>,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Exponential trend</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">tr_exp =</span> start_ts <span class="sc">*</span> <span class="fu">exp</span>(<span class="fl">0.1</span> <span class="sc">/</span> <span class="dv">365</span>)<span class="sc">^</span><span class="fu">row_number</span>(),</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Multiplicative seasonal component</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">yd_lin_mul =</span> tr_lin <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> sea),        <span class="co"># linear trend * (1 + seasonality)</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">yd_exp_mul =</span> tr_exp <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> sea)         <span class="co"># exponential trend * (1 + seasonality)</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Reshape for plotting</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&gt;%</span> </span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(tr_lin, tr_exp, yd_lin_mul, yd_exp_mul), </span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">"func"</span>, <span class="st">"method"</span>), </span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_sep =</span> <span class="st">"_"</span>, </span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"value"</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">func =</span> <span class="fu">factor</span>(func, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"yd"</span>, <span class="st">"tr"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> method, <span class="at">linetype =</span> func), <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Multiplicative Deterministic Component"</span>,</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Value"</span>, <span class="at">x =</span> <span class="st">"Date"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/multiplicative_deterministic_comp-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="random-component" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="random-component"><span class="header-section-number">3.2</span> Random component</h2>
<p>So far, we have modeled only the signal. But in reality, time series always contain noise, capturing <strong>unpredictable factors</strong> such as weather, strikes, promotions, or random shocks.</p>
<section id="gaussain-noise" class="level3" data-number="3.2.1">
<h3 data-number="3.2.1" class="anchored" data-anchor-id="gaussain-noise"><span class="header-section-number">3.2.1</span> Gaussain noise</h3>
<p>A simple first assumption is <strong>additive Gaussian noise</strong> with zero mean (<span class="math inline">\(\mu = 0\)</span>) and variance <span class="math inline">\(\sigma^2\)</span>.</p>
<div style="text-align: center;">
<p><img src="/images/normal_distribution_pdf.png" alt="Poisson Distribution" width="75%"></p>
</div>
<p><strong>Distribution:</strong></p>
<p><span class="math display">\[
\epsilon_t \sim \mathcal{N}(0, \sigma^2)
\]</span></p>
<p><span class="math display">\[
f(x) = \frac{1}{\sqrt{2\pi\sigma^2}} \, \exp\left(-\frac{x^2}{2\sigma^2}\right)
\]</span></p>
<p><strong>Parameters:</strong> <span class="math inline">\(\mu = 0\)</span>, <span class="math inline">\(\sigma^2\)</span></p>
<p><strong>Mean:</strong> <span class="math inline">\(\mu = 0\)</span></p>
<p><strong>Variance:</strong> <span class="math inline">\(\sigma^2\)</span></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>sig_1 <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">102938</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&lt;&gt;%</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">noi =</span> <span class="fu">rnorm</span>(<span class="fu">nrow</span>(df_sea), <span class="dv">0</span>, sig_1),</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_lin =</span> yd_lin <span class="sc">+</span> noi,</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_exp =</span> (start_ts <span class="sc">+</span> sea <span class="sc">+</span> noi) <span class="sc">*</span> <span class="fu">exp</span>(<span class="fl">0.1</span> <span class="sc">/</span> <span class="dv">365</span>)<span class="sc">^</span><span class="fu">row_number</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s start simple and assume we have additive Gaussian noise with mean zero and variance <span class="math inline">\(\sigma ^2 = 1\)</span>.<br>
Now we have the complete additive time series:</p>
<p>And the complete multiplicative time series:</p>
<p><span class="math display">\[
y(t) = tr(t) + S_t + \epsilon
\]</span></p>
<p>And the complete multiplicative time series:</p>
<p><span class="math display">\[
y(t) = (tr(t) + S_t + \epsilon) * exp(\beta_d * t)
\]</span></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&gt;%</span> </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(tr_lin, tr_exp, y_lin, y_exp), </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">"func"</span>, <span class="st">"method"</span>), </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_sep =</span> <span class="st">"_"</span>, </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">func =</span> <span class="fu">factor</span>(func, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"y"</span>, <span class="st">"tr"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> method,</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>                  <span class="at">linetype =</span> func),</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Additive Gaussian Noise"</span>,</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Value"</span>, <span class="at">x =</span> <span class="st">"Date"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/noisy_ts_plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We see here some negative values. That’s not consistent with counts. Counts are never negative. This means that our model is not quite right. We used Gaussian noise. But <strong>Gaussian noise is unlimited in the positive as well as in the negative</strong>. What other noise distribution can we use?</p>
<p>Since demand is count-based, a more natural choice is a discrete distribution.</p>
</section>
<section id="poisson-noise" class="level3" data-number="3.2.2">
<h3 data-number="3.2.2" class="anchored" data-anchor-id="poisson-noise"><span class="header-section-number">3.2.2</span> Poisson Noise</h3>
<p>Suitable when <strong>variance ≈ mean</strong>.<br>
It is simple and widely used for <strong>rare-event counts</strong>.</p>
<div style="text-align: center;">
<p><img src="/images/poisson_distribution_PMF.png" alt="Poisson Distribution" width="75%"></p>
</div>
<p><strong>Distribution:</strong></p>
<p><span class="math display">\[
\epsilon_t \sim \mathcal{Poisson}(\lambda)
\]</span> <span class="math display">\[
P(X = k) = \frac{\lambda^k e^{-\lambda}}{k!}, \quad k = 0, 1, 2, \ldots
\]</span></p>
<p><strong>Parameters:</strong> <span class="math inline">\(\lambda\)</span></p>
<p><strong>Mean:</strong> <span class="math inline">\(\lambda\)</span></p>
<p><strong>Variance:</strong> <span class="math inline">\(\lambda\)</span></p>
<p><strong>Notes:</strong><br>
Common in modeling <strong>count data</strong> and <strong>discrete random events</strong> (e.g., photon counts, arrivals, or defect occurrences).</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">102938</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">&lt;-</span> <span class="dv">2</span>  <span class="co"># mean noise level</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&lt;&gt;%</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">noi_pois =</span> <span class="fu">rpois</span>(<span class="fu">nrow</span>(df_sea), lambda),</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_lin_pois =</span> yd_lin <span class="sc">+</span> noi_pois,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_exp_pois =</span> (start_ts <span class="sc">+</span> sea <span class="sc">+</span> noi_pois) <span class="sc">*</span> <span class="fu">exp</span>(<span class="fl">0.1</span> <span class="sc">/</span> <span class="dv">365</span>)<span class="sc">^</span><span class="fu">row_number</span>())</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&gt;%</span> </span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(tr_lin, tr_exp, y_lin_pois, y_exp_pois), </span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">"func"</span>, <span class="st">"method"</span>), </span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_sep =</span> <span class="st">"_"</span>, </span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">func =</span> <span class="fu">factor</span>(func, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"y"</span>, <span class="st">"tr"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> method,</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>                  <span class="at">linetype =</span> func),</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Additive Poisson Noise"</span>,</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Value"</span>, <span class="at">x =</span> <span class="st">"Date"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/noisy_ts_poisson_plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="negative-binomial-noise" class="level3" data-number="3.2.3">
<h3 data-number="3.2.3" class="anchored" data-anchor-id="negative-binomial-noise"><span class="header-section-number">3.2.3</span> Negative Binomial noise</h3>
<p>When the <strong>variance of counts is larger than the mean</strong>, the Poisson assumption is too restrictive. The Negative Binomial distribution <strong>generalizes the Poisson</strong> by introducing an <strong>overdispersion parameter r</strong>.</p>
<div style="text-align: center;">
<p><img src="/images/negative_binomial.png" alt="Negative-Binomial Distribution" width="100%"></p>
</div>
<p><strong>Distribution:</strong></p>
<p><span class="math display">\[
\epsilon_t \sim NB(r, p)
\]</span> <span class="math display">\[
P(X = k) = \binom{k + r - 1}{k} (1 - p)^r p^k, \quad k = 0, 1, 2, \ldots
\]</span></p>
<p><strong>Parameters:</strong><br>
- <span class="math inline">\(r &gt; 0\)</span> is the number of successes,<br>
- <span class="math inline">\(p \in (0,1)\)</span> is the probability of failure (per trial),<br>
- <span class="math inline">\(k\)</span> is the number of failures before achieving <span class="math inline">\(r\)</span> successes.</p>
<p><strong>Mean:</strong> <span class="math inline">\(\mu = r\frac{1-p}{p}\)</span>&nbsp;</p>
<p><strong>Variance:</strong> <span class="math inline">\(\mu + \frac{\mu^2}{r}\)</span>, which is <strong>larger than the mean</strong> when r is finite.</p>
<p>This makes it much more flexible than the Poisson for real-world data.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">102938</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>size <span class="ot">&lt;-</span> <span class="dv">5</span>    <span class="co"># dispersion parameter (higher = closer to Poisson)</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>mu   <span class="ot">&lt;-</span> <span class="dv">2</span>    <span class="co"># mean of noise</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&lt;&gt;%</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">noi_nb =</span> <span class="fu">rnbinom</span>(<span class="fu">nrow</span>(df_sea), <span class="at">size =</span> size, <span class="at">mu =</span> mu),</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_lin_nb =</span> yd_lin <span class="sc">+</span> noi_nb,</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_exp_nb =</span> (start_ts <span class="sc">+</span> sea <span class="sc">+</span> noi_nb) <span class="sc">*</span> <span class="fu">exp</span>(<span class="fl">0.1</span> <span class="sc">/</span> <span class="dv">365</span>)<span class="sc">^</span><span class="fu">row_number</span>())</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&gt;%</span> </span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(tr_lin, tr_exp, y_lin_nb, y_exp_nb), </span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">"func"</span>, <span class="st">"method"</span>), </span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_sep =</span> <span class="st">"_"</span>, </span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">func =</span> <span class="fu">factor</span>(func, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"y"</span>, <span class="st">"tr"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> method,</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>                  <span class="at">linetype =</span> func),</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Additive Negative Binomial Noise"</span>,</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Value"</span>, <span class="at">x =</span> <span class="st">"Date"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/noisy_ts_negbin_plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="gamma-noise" class="level3" data-number="3.2.4">
<h3 data-number="3.2.4" class="anchored" data-anchor-id="gamma-noise"><span class="header-section-number">3.2.4</span> Gamma noise</h3>
<p>Gamma and Log-Normal are popular for modeling <strong>positive continuous noise</strong>—especially when counts or demand cannot be negative and may have <strong>skewness</strong>.</p>
<div style="text-align: center;">
<p><img src="/images/gamma_distribution_pdf.png" alt="Gamma Distribution" width="75%"></p>
</div>
<p><strong>Distribution:</strong></p>
<p><span class="math display">\[
f(x; k, \theta) =
\frac{1}{\Gamma(k)\,\theta^{k}}\,x^{k - 1} e^{-x / \theta},
\quad x &gt; 0
\]</span></p>
<p><strong>Parameters:</strong> <strong>shape</strong> <span class="math inline">\(k\)</span>, <strong>scale</strong> <span class="math inline">\(\theta\)</span>, and <span class="math inline">\(\Gamma(k)\)</span> is the Gamma function defined as</p>
<p><span class="math display">\[
\Gamma(k) = \int_0^\infty t^{k - 1} e^{-t} dt
\]</span></p>
<p><strong>Mean:</strong><br>
<span class="math inline">\(kθ\)</span></p>
<p><strong>Variance:</strong><br>
<span class="math inline">\(kθ^2\)</span></p>
<p><strong>Notes:</strong><br>
Often used for modeling <strong>waiting times</strong> or <strong>non-negative skewed demand</strong>.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">102938</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>shape_gamma <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>scale_gamma <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&lt;&gt;%</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">noi_gamma =</span> <span class="fu">rgamma</span>(<span class="fu">nrow</span>(df_sea), <span class="at">shape =</span> shape_gamma, <span class="at">scale =</span> scale_gamma),</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_lin_gamma =</span> yd_lin <span class="sc">+</span> noi_gamma,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_exp_gamma =</span> (start_ts <span class="sc">+</span> sea <span class="sc">+</span> noi_gamma) <span class="sc">*</span> <span class="fu">exp</span>(<span class="fl">0.1</span> <span class="sc">/</span> <span class="dv">365</span>)<span class="sc">^</span><span class="fu">row_number</span>())</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&gt;%</span> </span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(tr_lin, tr_exp, y_lin_gamma, y_exp_gamma), </span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">"func"</span>, <span class="st">"method"</span>), </span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_sep =</span> <span class="st">"_"</span>, </span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">func =</span> <span class="fu">factor</span>(func, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"y"</span>, <span class="st">"tr"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> method,</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>                  <span class="at">linetype =</span> func),</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Additive Gamma Noise"</span>,</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Value"</span>, <span class="at">x =</span> <span class="st">"Date"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/noisy_ts_gamma_plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="log-normal-noise" class="level3" data-number="3.2.5">
<h3 data-number="3.2.5" class="anchored" data-anchor-id="log-normal-noise"><span class="header-section-number">3.2.5</span> Log-Normal noise</h3>
<p>A <strong>strictly positive</strong>, <strong>skewed</strong> distribution.</p>
<div style="text-align: center;">
<p><img src="/images/log_normal_distribution.png" alt="Log-normal Distribution" width="75%"></p>
</div>
<p><strong>Distribution:</strong></p>
<p><span class="math display">\[
f(x; \mu, \sigma) =
\frac{1}{x\,\sigma\,\sqrt{2\pi}}
\exp\left( -\frac{(\ln x - \mu)^2}{2\sigma^2} \right),
\quad x &gt; 0
\]</span></p>
<p><strong>Parameters:</strong> log-mean <span class="math inline">\(\mu\)</span>, log-standard deviation <span class="math inline">\(\sigma\)</span></p>
<p><strong>Mean:</strong><br>
<span class="math display">\[
\ E(X) = exp(\mu + \sigma^2 / 2)
\]</span></p>
<p><strong>Variance:</strong><br>
<span class="math display">\[
Var(X) = (\exp(\sigma^2) - 1) \exp(2\mu + \sigma^2)
\]</span></p>
<p><strong>Notes:</strong><br>
Often used when noise <strong>multiplicatively affects the signal</strong>.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">102938</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>mu_lognorm <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>sigma_lognorm <span class="ot">&lt;-</span> <span class="fl">0.3</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&lt;&gt;%</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">noi_lognorm =</span> <span class="fu">rlnorm</span>(<span class="fu">nrow</span>(df_sea), <span class="at">meanlog =</span> mu_lognorm, <span class="at">sdlog =</span> sigma_lognorm),</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_lin_lognorm =</span> yd_lin <span class="sc">+</span> noi_lognorm,</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_exp_lognorm =</span> (start_ts <span class="sc">+</span> sea <span class="sc">+</span> noi_lognorm) <span class="sc">*</span> <span class="fu">exp</span>(<span class="fl">0.1</span> <span class="sc">/</span> <span class="dv">365</span>)<span class="sc">^</span><span class="fu">row_number</span>())</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&gt;%</span> </span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(tr_lin, tr_exp, y_lin_lognorm, y_exp_lognorm), </span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">"func"</span>, <span class="st">"method"</span>), </span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_sep =</span> <span class="st">"_"</span>, </span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">func =</span> <span class="fu">factor</span>(func, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"y"</span>, <span class="st">"tr"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> method,</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>                  <span class="at">linetype =</span> func),</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Additive Log-Normal Noise"</span>,</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Value"</span>, <span class="at">x =</span> <span class="st">"Date"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/noisy_ts_lognorm_plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="ts-noise-modelling" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> TS noise modelling</h1>
<section id="review-of-the-additive-model" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="review-of-the-additive-model"><span class="header-section-number">4.1</span> Review of the additive model</h2>
<p>We re-use the synthetic data from last week, which follows an <strong>additive decomposition</strong> of the form:</p>
<p><span class="math display">\[
y(t) = tr(t) + s(t) + \epsilon_t
\]</span></p>
<section id="load-the-data" class="level3" data-number="4.1.1">
<h3 data-number="4.1.1" class="anchored" data-anchor-id="load-the-data"><span class="header-section-number">4.1.1</span> Load the data</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>data_dir <span class="ot">&lt;-</span> <span class="st">"./data"</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>fpath_df_ts1 <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{data_dir}/synthetic_TS_01.tsv"</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="ot">&lt;-</span> </span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_tsv</span>(fpath_df_ts1) <span class="sc">%&gt;%</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(day, mon, sea, tr_lin, yd_lin, noi, y_lin) <span class="sc">%&gt;%</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">tr =</span> tr_lin, <span class="at">yd =</span> yd_lin, <span class="at">y =</span> y_lin) <span class="sc">%&gt;%</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">year</span>(day)) <span class="sc">%&gt;%</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(year)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="trend-component-1" class="level3" data-number="4.1.2">
<h3 data-number="4.1.2" class="anchored" data-anchor-id="trend-component-1"><span class="header-section-number">4.1.2</span> Trend component</h3>
<p>The trend is modeled as a linear function of time:</p>
<p><span class="math display">\[
tr(t) = y_0 + \alpha.\frac{t}{365}
\]</span> We can recover the parameters <span class="math inline">\(y_0\)</span> (intercept) and <span class="math inline">\(\alpha\)</span> (slope) as follows:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>y0_o   <span class="ot">&lt;-</span> df_ts1<span class="sc">$</span>tr[<span class="dv">1</span>] <span class="sc">%&gt;%</span> round</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>alfa_o <span class="ot">&lt;-</span> df_ts1<span class="sc">$</span>tr[<span class="dv">366</span>] <span class="sc">-</span> df_ts1<span class="sc">$</span>tr[<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Hence<br>
- <span class="math inline">\(y_0 =\)</span> 5.<br>
- <span class="math inline">\(\alpha =\)</span> 0.5</p>
</section>
<section id="seasonal-component" class="level3" data-number="4.1.3">
<h3 data-number="4.1.3" class="anchored" data-anchor-id="seasonal-component"><span class="header-section-number">4.1.3</span> Seasonal component</h3>
<p>The seasonality is defined by a smooth repeating curve, shown below for the first year:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">==</span> <span class="fu">min</span>(<span class="fu">as.numeric</span>(<span class="fu">as.character</span>(year)))) <span class="sc">%&gt;%</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> sea)) <span class="sc">+</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Seasonal Component (First Year)"</span>,</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Day"</span>, <span class="at">y =</span> <span class="st">"Seasonal Effect"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/plot-sea-actual-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="original-time-series" class="level3" data-number="4.1.4">
<h3 data-number="4.1.4" class="anchored" data-anchor-id="original-time-series"><span class="header-section-number">4.1.4</span> Original time series</h3>
<p>The full modeled series, including the original Gaussian noise, is shown below:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span> </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day)) <span class="sc">+</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> y), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> yd), <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Synthetic Time Series with Gaussian Noise"</span>,</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Day"</span>, <span class="at">y =</span> <span class="st">"Value"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/plot-df-ts1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Note that normal noise may be inappropriate for <em>count-type data</em>, since it can generate negative forecasts—an issue that motivates the following noise models.</p>
</section>
</section>
<section id="noise-with-constant-rate" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="noise-with-constant-rate"><span class="header-section-number">4.2</span> Noise with constant rate</h2>
<p>Let the noise follow a Poisson distribution with constant rate <span class="math inline">\(\lambda_0 = 2\)</span></p>
<p>Because the Poisson mean equals its variance, we re-center the generated noise to preserve a mean of zero and avoid negative forecasts.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2831</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>lam_0 <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">noi_cnst =</span> <span class="fu">rpois</span>(<span class="at">n =</span> <span class="fu">nrow</span>(.), <span class="at">lambda =</span> lam_0) <span class="sc">-</span> <span class="fu">min</span>(<span class="fu">c</span>(lam_0, <span class="fu">min</span>(yd))),</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_1 =</span> yd <span class="sc">+</span> noi_cnst)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">|&gt;</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day)) <span class="sc">+</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> y_1), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> yd), <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Time Series with Constant-Rate Poisson Noise"</span>,</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Day"</span>, <span class="at">y =</span> <span class="st">"Value"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/generate-constant-pois-noise-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="noise-with-proportional-rate" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="noise-with-proportional-rate"><span class="header-section-number">4.3</span> Noise with proportional rate</h2>
<p>In many real-world processes, <strong>noise magnitude increases with the signal level</strong>. This can be the case for sales, demand, or production volumes, where fluctuations scale with the size of operations.</p>
<p>For example:<br>
If one trailer delivery is missed due to a strike when demand is low, a tenfold demand would imply a missed delivery of ten trailers — illustrating proportional noise.</p>
<section id="additive-interpretation" class="level3" data-number="4.3.1">
<h3 data-number="4.3.1" class="anchored" data-anchor-id="additive-interpretation"><span class="header-section-number">4.3.1</span> Additive interpretation</h3>
<p>We can still express the model additively as:</p>
<p><span class="math display">\[
y(t) = tr(t) + s(t) + \epsilon_t
\]</span></p>
<p>where</p>
<p><span class="math display">\[
\epsilon_t \sim \mathrm{Pois}(\lambda_t), \quad \lambda_t \propto y_t^{\text{(d)}} = tr(t) + s(t)
\]</span></p>
</section>
<section id="multiplicative-equivalence" class="level3" data-number="4.3.2">
<h3 data-number="4.3.2" class="anchored" data-anchor-id="multiplicative-equivalence"><span class="header-section-number">4.3.2</span> Multiplicative equivalence</h3>
<p>This is equivalent to a multiplicative noise model:</p>
<p><span class="math display">\[
y(t) = (tr(t) + s(t)).\eta_t
\]</span> where <span class="math inline">\(\eta_t\)</span> is a Poisson-like random multiplier with constant mean.</p>
</section>
<section id="implementation" class="level3" data-number="4.3.3">
<h3 data-number="4.3.3" class="anchored" data-anchor-id="implementation"><span class="header-section-number">4.3.3</span> Implementation</h3>
<p>We simulate proportional noise with a constant scaling factor <span class="math inline">\(c_\lambda = 0.4\)</span>:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>const_lam <span class="ot">&lt;-</span> <span class="fl">0.4</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123098</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">lam      =</span> const_lam <span class="sc">*</span> yd,</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">noi_prop =</span> <span class="fu">map_dbl</span>(lam, <span class="sc">~</span> <span class="fu">rpois</span>(<span class="dv">1</span>, <span class="at">lambda =</span> .x) <span class="sc">-</span> .x),</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_2      =</span> yd <span class="sc">+</span> noi_prop)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(day, yd, y_1, y_2) <span class="sc">%&gt;%</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(y_1, y_2),</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"method"</span>,</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"TS_value"</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">method =</span> <span class="fu">recode</span>(</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    method,</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">y_1 =</span> <span class="st">"Constant-rate Poisson noise"</span>,</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">y_2 =</span> <span class="st">"Proportional-rate Poisson noise"</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> TS_value)) <span class="sc">+</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> method), <span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> yd), <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> method, <span class="at">ncol =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Constant vs Proportional Poisson Noise"</span>,</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Day"</span>,</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Value"</span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/generate-proportional-pois-noise-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="interpretation" class="level3" data-number="4.3.4">
<h3 data-number="4.3.4" class="anchored" data-anchor-id="interpretation"><span class="header-section-number">4.3.4</span> Interpretation</h3>
<ul>
<li>The constant-rate noise adds fluctuations of fixed variance, independent of the signal.</li>
<li>The proportional-rate noise scales with the signal amplitude, resembling multiplicative variability commonly seen in business and supply-chain processes.</li>
</ul>
</section>
</section>
<section id="analysis" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="analysis"><span class="header-section-number">4.4</span> Analysis</h2>
<section id="visualizing-yearly-seasonality" class="level3" data-number="4.4.1">
<h3 data-number="4.4.1" class="anchored" data-anchor-id="visualizing-yearly-seasonality"><span class="header-section-number">4.4.1</span> Visualizing yearly seasonality</h3>
<p>When we suspect seasonality, such as yearly patterns, it can be insightful to overlay the time series data by year. This allows us to visually compare the dynamics of each year and identify recurring seasonal behaviors.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">year =</span> <span class="fu">factor</span>(<span class="fu">year</span>(day)),</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">date_no_year =</span> day</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(<span class="fu">c</span>(year, date_no_year), <span class="at">.after =</span> day)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="fu">year</span>(df_ts1<span class="sc">$</span>date_no_year) <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date_no_year, <span class="at">y =</span> y_2)) <span class="sc">+</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> year, <span class="at">color =</span> year), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Overlay of Yearly Time Series"</span>,</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Day (within year)"</span>,</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Value"</span>,</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Year"</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/overlay-yearly-ts-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We already observe a recurring yearly pattern, especially toward the end of the year. This suggests a combination of trend and seasonality in the data, which we now aim to analyze more formally.</p>
</section>
<section id="trend-analysis" class="level3" data-number="4.4.2">
<h3 data-number="4.4.2" class="anchored" data-anchor-id="trend-analysis"><span class="header-section-number">4.4.2</span> Trend analysis</h3>
<p>We begin by estimating the trend component, since it represents the longer-term structure of the series.<br>
Seasonality can then be analyzed more effectively once the trend has been accounted for.</p>
<p>We compare different <strong>trend modeling</strong> approaches:</p>
<ul>
<li>Linear Trend: the simplest baseline model.</li>
<li>Nonlinear Trends using flexible smoothers:
<ul>
<li>LOESS (Locally Weighted Scatterplot Smoothing)</li>
<li>GAM (Generalized Additive Model)</li>
</ul></li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>loess_span_high <span class="ot">&lt;-</span> <span class="fl">0.75</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>(<span class="at">data =</span> <span class="sc">-</span>year)  <span class="sc">%&gt;%</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">lm_tr =</span> <span class="fu">map</span>(</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>      year,</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>      <span class="sc">~</span> <span class="fu">lm</span>(y_2 <span class="sc">~</span> day, <span class="at">data =</span> df_ts1  <span class="sc">%&gt;%</span> <span class="fu">filter</span>(year <span class="sc">==</span> .x))</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">loes_tr =</span> <span class="fu">map</span>(</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>      year,</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>      <span class="sc">~</span> <span class="fu">loess</span>(y_2 <span class="sc">~</span> <span class="fu">as.numeric</span>(day),</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>              <span class="at">data =</span> df_ts1  <span class="sc">%&gt;%</span> <span class="fu">filter</span>(year <span class="sc">==</span> .x),</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>              <span class="at">span =</span> loess_span_high)</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">map2</span>(data, lm_tr, <span class="sc">~</span> <span class="fu">mutate</span>(.x, <span class="at">try_lm =</span> .y<span class="sc">$</span>fitted)),</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">map2</span>(data, loes_tr, <span class="sc">~</span> <span class="fu">mutate</span>(.x, <span class="at">try_lo =</span> .y<span class="sc">$</span>fitted))</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>  )  <span class="sc">%&gt;%</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(lm_tr, loes_tr))  <span class="sc">%&gt;%</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(data)</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>df_ts1  <span class="sc">%&gt;%</span></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date_no_year, <span class="at">y =</span> y_2)) <span class="sc">+</span></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> year, <span class="at">color =</span> year), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> try_lm, <span class="at">group =</span> year), <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> try_lo, <span class="at">group =</span> year), <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Yearly Trend Fitting: Linear (Blue) vs LOESS (Red)"</span>,</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Day (within year)"</span>,</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Value"</span>,</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Year"</span></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/fitting-yearly-trend-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Here,</p>
<ul>
<li>Blue lines represent the fitted linear trends, and</li>
<li>Red curves show the LOESS-smoothed trends (with span = 0.75).</li>
</ul>
<p>We see a reasonable degree of consistency across years, though some discrepancies appear in incomplete years (e.g., 2025).<br>
However, analyzing each year independently is not ideal for identifying the overall trend, since the yearly boundaries do not necessarily align smoothly from one year to the next.</p>
<section id="continuous-trend-estimation" class="level4" data-number="4.4.2.1">
<h4 data-number="4.4.2.1" class="anchored" data-anchor-id="continuous-trend-estimation"><span class="header-section-number">4.4.2.1</span> Continuous trend estimation</h4>
<p>To capture a coherent view of the long-term evolution, we re-estimate the trend over the entire time span.</p>
<p>We compare:</p>
<ul>
<li>Linear trend (black)</li>
<li>LOESS smoothing with:
<ul>
<li>Medium span (<code>0.5</code>) — blue curve</li>
<li>Low span (<code>0.1</code>) — red curve</li>
</ul></li>
<li>GAM smoothing (dark green), with automatic smoothing and confidence bands</li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>loess_span_med  <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>loess_span_low <span class="ot">&lt;-</span> <span class="fl">0.1</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>lm_tr <span class="ot">&lt;-</span> <span class="fu">lm</span>(y_2 <span class="sc">~</span> day, <span class="at">data =</span> df_ts1)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>lo_tr_1 <span class="ot">&lt;-</span> <span class="fu">loess</span>(y_2 <span class="sc">~</span> <span class="fu">as.numeric</span>(day),</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> df_ts1,</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>                 <span class="at">span =</span> loess_span_med)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>lo_tr_2 <span class="ot">&lt;-</span> <span class="fu">loess</span>(y_2 <span class="sc">~</span> <span class="fu">as.numeric</span>(day),</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> df_ts1,</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>                 <span class="at">span =</span> loess_span_low)</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">tr_lm   =</span> lm_tr<span class="sc">$</span>fitted,</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">tr_lo_1 =</span> lo_tr_1<span class="sc">$</span>fitted,</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">tr_lo_2 =</span> lo_tr_2<span class="sc">$</span>fitted</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> y_2)) <span class="sc">+</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> year, <span class="at">color =</span> year), <span class="at">alpha =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tr_lm), <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tr_lo_1), <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">linewidth =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tr_lo_2), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"gam"</span>, <span class="at">color =</span> <span class="st">"darkgreen"</span>, <span class="at">linewidth =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Global Trend Estimation with Various Smoothers"</span>,</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Day"</span>,</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Value"</span>,</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Year"</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/plot-overoll-smoothing-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="interpretation-1" class="level4" data-number="4.4.2.2">
<h4 data-number="4.4.2.2" class="anchored" data-anchor-id="interpretation-1"><span class="header-section-number">4.4.2.2</span> Interpretation</h4>
<ul>
<li><p>The linear trend (black) provides a clear, interpretable long-term direction and fits the overall data well.</p></li>
<li><p>The LOESS (low span, red) captures short-term fluctuations, overlapping with the seasonal pattern rather than isolating the true trend.</p></li>
<li><p>The LOESS (medium span, blue) and GAM (dark green) curves strike a balance but tend to capture both slow seasonal and trend components simultaneously.</p></li>
</ul>
<p>Hence, while linear smoothing suffices to characterize the long-term drift, nonlinear smoothers such as LOESS or GAM can help diagnose residual structure — valuable when refining the decomposition into trend, seasonality, and irregular components.</p>
</section>
</section>
<section id="seasonality" class="level3" data-number="4.4.3">
<h3 data-number="4.4.3" class="anchored" data-anchor-id="seasonality"><span class="header-section-number">4.4.3</span> Seasonality</h3>
<p>After identifying the trend, the next step is to investigate seasonality.<br>
To do this, we can overlay the estimated seasonal curves for each year and look for repeating or shifting patterns.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date_no_year, <span class="at">y =</span> y_2)) <span class="sc">+</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> year, <span class="at">color =</span> year), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tr_lo_2, <span class="at">color =</span> year, <span class="at">group =</span> year))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/seasonlity-curve-yoy-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Indeed, there appears to be a <strong>phase shift</strong> across years — that is, the peaks and troughs of the seasonal pattern occur slightly earlier or later depending on the year.</p>
<section id="de-trending-and-centering-seasonality" class="level4" data-number="4.4.3.1">
<h4 data-number="4.4.3.1" class="anchored" data-anchor-id="de-trending-and-centering-seasonality"><span class="header-section-number">4.4.3.1</span> De-trending and centering seasonality</h4>
<p>To analyze seasonality more clearly, we should first remove the trend component so that the seasonal variation is centered around zero.<br>
This can be done by subtracting the estimated trend from the original time series:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y_notr =</span> y_2 <span class="sc">-</span> tr_lm)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>sea_1 <span class="ot">&lt;-</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">loess</span>(df_ts1 <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">day =</span> <span class="fu">as.numeric</span>(day)),</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">formula =</span> y_notr <span class="sc">~</span> day,</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">span =</span> loess_span_low)</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sea_lo =</span> sea_1<span class="sc">$</span>fitted)</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date_no_year, <span class="at">y =</span> y_2)) <span class="sc">+</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> year, <span class="at">color =</span> year), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> sea_lo, <span class="at">color =</span> year, <span class="at">group =</span> year), <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tr_lm, <span class="at">group =</span> year, <span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"black"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/seasonality-minus-trend-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Once the trend is removed, the seasonal pattern becomes much more evident — confirming the phase shift between years.</p>
</section>
</section>
<section id="noise-extraction" class="level3" data-number="4.4.4">
<h3 data-number="4.4.4" class="anchored" data-anchor-id="noise-extraction"><span class="header-section-number">4.4.4</span> Noise extraction</h3>
<p>Having decomposed the time series into trend and seasonality, the remaining residual component represents the noise:</p>
<p><span class="math display">\[
y(t) = tr(t) + s(t) + \epsilon_t
\]</span></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y_noi =</span> y_2 <span class="sc">-</span> tr_lm <span class="sc">-</span> sea_lo)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> y_noi)) <span class="sc">+</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">as_date</span>(<span class="fu">c</span>(<span class="st">"2023-12-31"</span>, <span class="st">"2024-12-31"</span>))) <span class="sc">+</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/remove-trend-season-form-ts-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>noi_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(df_ts1<span class="sc">$</span>y_noi)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>noi_var  <span class="ot">&lt;-</span> <span class="fu">var</span>(df_ts1<span class="sc">$</span>y_noi)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We find the following centered moments for the noise:</p>
<ul>
<li>Mean: 0</li>
<li>Var: 2.76</li>
</ul>
<p>The residuals still exhibit some <strong>heteroscedasticity</strong> — the variance is not constant across time. For instance, spikes tend to occur near the end of each year, suggesting a link with the seasonal component.</p>
<section id="noiseseasonality-interaction" class="level4" data-number="4.4.4.1">
<h4 data-number="4.4.4.1" class="anchored" data-anchor-id="noiseseasonality-interaction"><span class="header-section-number">4.4.4.1</span> Noise–seasonality interaction</h4>
<p>To visualize this interaction, we can overlay the deterministic component (trend + seasonality, shifted to start at zero) onto the noise:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> y_noi)) <span class="sc">+</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tr_lm <span class="sc">+</span> sea_lo <span class="sc">-</span> <span class="fu">min</span>(tr_lm))) <span class="sc">+</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">as_date</span>(<span class="fu">c</span>(<span class="st">"2023-12-31"</span>, <span class="st">"2024-12-31"</span>))) <span class="sc">+</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/plot-noise-overlay-seas-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We observe a clear correlation between the amplitude of the noise and the level of the deterministic component, indicating that the noise may be multiplicative rather than purely additive.</p>
</section>
<section id="noise-distribution" class="level4" data-number="4.4.4.2">
<h4 data-number="4.4.4.2" class="anchored" data-anchor-id="noise-distribution"><span class="header-section-number">4.4.4.2</span> Noise distribution</h4>
<p>For now, we continue under the additive noise assumption.<br>
We visualize the noise distribution and overlay a Poisson density with parameter <span class="math inline">\(\lambda = 2.76\)</span>:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">noi_pois =</span> <span class="fu">dpois</span>(<span class="fu">round</span>(y_noi <span class="sc">+</span> noi_var), <span class="at">lambda =</span> noi_var)) <span class="sc">%&gt;%</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> y_noi <span class="sc">+</span> noi_var)) <span class="sc">+</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), <span class="at">bins =</span> <span class="dv">100</span>) <span class="sc">+</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> noi_pois), <span class="at">color =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/plot-noise-histog-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The histogram reveals deviations from the ideal Poisson shape — consistent with the observed heteroscedasticity — reinforcing the idea that a multiplicative noise model could be a better fit for this time series.</p>
</section>
</section>
<section id="modeling-multiplicative-noise" class="level3" data-number="4.4.5">
<h3 data-number="4.4.5" class="anchored" data-anchor-id="modeling-multiplicative-noise"><span class="header-section-number">4.4.5</span> Modeling multiplicative noise</h3>
<p>The previous analysis indicated that the variance of the residuals (noise) increases with the magnitude of the deterministic component — suggesting that the noise is multiplicative rather than additive.</p>
<p>In an additive noise model, we write:</p>
<p><span class="math display">\[
y(t) = tr(t) + s(t) + \epsilon_t
\]</span></p>
<p>In contrast, a multiplicative noise model assumes:</p>
<p><span class="math display">\[
y(t) = [tr(t) + s(t)]*[1 + \epsilon_t]
\]</span></p>
<p>or equivalently,</p>
<p><span class="math display">\[
\epsilon_t = \frac{y(t) - [tr(t) + s(t)]}{[tr(t) + s(t)]}
\]</span></p>
<p>This formulation implies that the magnitude of the fluctuations (noise) scales with the level of the signal — a realistic assumption for many economic and natural time series.</p>
<section id="extracting-multiplicative-noise" class="level4" data-number="4.4.5.1">
<h4 data-number="4.4.5.1" class="anchored" data-anchor-id="extracting-multiplicative-noise"><span class="header-section-number">4.4.5.1</span> Extracting multiplicative noise</h4>
<p>Let’s compute the multiplicative residuals based on our fitted deterministic component <span class="math inline">\(tr(t) + s(t)\)</span>:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">y_det  =</span> tr_lm <span class="sc">+</span> sea_lo,</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">eps_mul =</span> (y_2 <span class="sc">-</span> y_det) <span class="sc">/</span> y_det</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> eps_mul)) <span class="sc">+</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">as_date</span>(<span class="fu">c</span>(<span class="st">"2023-12-31"</span>, <span class="st">"2024-12-31"</span>))) <span class="sc">+</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can now inspect whether these normalized residuals appear <strong>homoscedastic</strong> (i.e., constant variance) over time. If the variance stabilizes, that confirms that the multiplicative model is indeed more appropriate.</p>
</section>
<section id="analyzing-the-multiplicative-residuals" class="level4" data-number="4.4.5.2">
<h4 data-number="4.4.5.2" class="anchored" data-anchor-id="analyzing-the-multiplicative-residuals"><span class="header-section-number">4.4.5.2</span> Analyzing the multiplicative residuals</h4>
<p>Compute basic moments of the multiplicative residuals:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>noi_mul_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(df_ts1<span class="sc">$</span>eps_mul)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>noi_mul_var  <span class="ot">&lt;-</span> <span class="fu">var</span>(df_ts1<span class="sc">$</span>eps_mul)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We obtain:</p>
<ul>
<li><p>Mean: -0.009</p></li>
<li><p>Variance: 0.089</p></li>
</ul>
<p>The mean is close to zero, as expected, and the variance is stable across time — confirming that the <strong>scaled residuals are stationary</strong>.</p>
</section>
<section id="distribution-of-multiplicative-noise" class="level4" data-number="4.4.5.3">
<h4 data-number="4.4.5.3" class="anchored" data-anchor-id="distribution-of-multiplicative-noise"><span class="header-section-number">4.4.5.3</span> Distribution of multiplicative noise</h4>
<p>Next, let’s examine whether the multiplicative residuals follow a Poisson, Gaussian, or log-normal distribution.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> eps_mul)) <span class="sc">+</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), <span class="at">bins =</span> <span class="dv">100</span>, <span class="at">fill =</span> <span class="st">"lightblue"</span>) <span class="sc">+</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_function</span>(<span class="at">fun =</span> dnorm,</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">args =</span> <span class="fu">list</span>(<span class="at">mean =</span> noi_mul_mean, <span class="at">sd =</span> <span class="fu">sqrt</span>(noi_mul_var)),</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Distribution of Multiplicative Noise"</span>,</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="fu">expression</span>(epsilon[t]),</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Density"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The red curve corresponds to a normal distribution fitted with the same mean and variance as the empirical residuals.<br>
If the histogram closely follows this curve, the multiplicative noise can be approximated as Gaussian — a common assumption in log-transformed time series models.</p>
</section>
<section id="alternative-representation-log-transformation" class="level4" data-number="4.4.5.4">
<h4 data-number="4.4.5.4" class="anchored" data-anchor-id="alternative-representation-log-transformation"><span class="header-section-number">4.4.5.4</span> Alternative representation (log transformation)</h4>
<p>Since multiplicative models can be expressed additively in the logarithmic domain, we can apply a log transformation:</p>
<p><span class="math display">\[
log(y(t)) = log[tr(t) + s(t)] + log[1 + \epsilon_t]
\]</span> For small noise <span class="math inline">\((\epsilon_t \ll 1)\)</span>, the term <span class="math inline">\(\log(1 + \epsilon_t) \approx \epsilon_t\)</span>,<br>
so the model becomes approximately additive in log-space.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">log_y =</span> <span class="fu">log</span>(y_2),</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">log_det =</span> <span class="fu">log</span>(y_det),</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">log_eps =</span> log_y <span class="sc">-</span> log_det</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> log_eps)) <span class="sc">+</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Log-Transformed Residuals (Approx. Additive)"</span>,</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="fu">expression</span>(<span class="fu">log</span>(epsilon[t])))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This transformation stabilizes the variance even further and simplifies future modeling (e.g., ARIMA or state-space models).</p>
<p>We obtain:</p>
<ul>
<li><p>Mean: -0.054</p></li>
<li><p>Variance: 0.093</p></li>
</ul>
</section>
</section>
</section>
<section id="modeling-wrap-up" class="level2" data-number="4.5">
<h2 data-number="4.5" class="anchored" data-anchor-id="modeling-wrap-up"><span class="header-section-number">4.5</span> Modeling wrap-up</h2>
<section id="trend" class="level3" data-number="4.5.1">
<h3 data-number="4.5.1" class="anchored" data-anchor-id="trend"><span class="header-section-number">4.5.1</span> Trend</h3>
<p>We start by comparing the <strong>original</strong> and <strong>inferred</strong> trend parameters.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>y0_a   <span class="ot">&lt;-</span> lm_tr<span class="sc">$</span>coefficients[<span class="dv">1</span>] <span class="sc">+</span> (df_ts1<span class="sc">$</span>day <span class="sc">%&gt;%</span> <span class="fu">min</span>() <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">*</span> lm_tr<span class="sc">$</span>coefficients[<span class="dv">2</span>]</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>alfa_a <span class="ot">&lt;-</span> lm_tr<span class="sc">$</span>coefficients[<span class="dv">2</span>] <span class="sc">*</span> <span class="dv">365</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="fu">tribble</span>(</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>Trend_Parameter, <span class="sc">~</span>Original, <span class="sc">~</span>Inferred,</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"y₀"</span>,   y0_o,   y0_a,</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"α"</span>,    alfa_o, alfa_a</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 3
  Trend_Parameter Original Inferred
  &lt;chr&gt;              &lt;dbl&gt;    &lt;dbl&gt;
1 y₀                   5      4.91 
2 α                    0.5    0.598</code></pre>
</div>
</div>
<p>The inferred trend parameters are close to the original values, indicating that the linear model successfully recovered the overall trend structure.</p>
</section>
<section id="seasonality-1" class="level3" data-number="4.5.2">
<h3 data-number="4.5.2" class="anchored" data-anchor-id="seasonality-1"><span class="header-section-number">4.5.2</span> Seasonality:</h3>
<p>Next, we compare the original and inferred seasonal components.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> sea)) <span class="sc">+</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> sea_lo), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Comparison of Original and Inferred Seasonality"</span>,</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Day"</span>,</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Seasonal Component"</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/compare-season-orig-inferred-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Here, the black curve represents the original seasonal pattern, while the red dashed curve shows the inferred seasonality. The two align quite well overall, although a small phase shift can be observed — likely due to interactions between trend and noise, or numerical effects in the decomposition.</p>
</section>
<section id="noise" class="level3" data-number="4.5.3">
<h3 data-number="4.5.3" class="anchored" data-anchor-id="noise"><span class="header-section-number">4.5.3</span> Noise</h3>
<p>Finally, we compare the Poisson noise parameter <span class="math inline">\(\lambda_t\)</span>:</p>
<ul>
<li>Original: <span class="math inline">\(\lambda =\)</span> 2</li>
<li>Inferred: <span class="math inline">\(\lambda =\)</span> 2.76</li>
</ul>
<p>The inferred value is somewhat different from the true parameter, which is expected since noise estimation is often sensitive to model specification and the chosen decomposition method.</p>
<p>Still, the inferred variance remains within a reasonable range.<br>
</p>
<p>In the next step, we’ll explore the case with multiplicative noise, which often provides a more realistic representation of many real-world time series.</p>
</section>
<section id="additive-vs.-multiplicative-noise" class="level3" data-number="4.5.4">
<h3 data-number="4.5.4" class="anchored" data-anchor-id="additive-vs.-multiplicative-noise"><span class="header-section-number">4.5.4</span> Additive vs.&nbsp;multiplicative noise</h3>
<p>In the additive model, the observed time series is expressed as:</p>
<p><span class="math display">\[
y_t = tr(t) + s(t) + \varepsilon_t
\]</span></p>
<p>where <span class="math inline">\(\varepsilon_t\)</span> represents random fluctuations around the deterministic trend–seasonality structure.</p>
<p>However, if the amplitude of the noise appears to grow or shrink with the level of the signal (as we observed in our plots), a <strong>multiplicative model</strong> may be more appropriate:</p>
<p><span class="math display">\[
y_t = [tr(t) + s(t)] \times (1 + \varepsilon_t)
\]</span></p>
<section id="log-transformation" class="level4" data-number="4.5.4.1">
<h4 data-number="4.5.4.1" class="anchored" data-anchor-id="log-transformation"><span class="header-section-number">4.5.4.1</span> Log-transformation</h4>
<p>Taking logarithms linearizes the multiplicative model:</p>
<p><span class="math display">\[
\log(y_t) = \log(tr(t) + s(t)) + \log(1 + \varepsilon_t)
\]</span></p>
<p>For small noise (<span class="math inline">\(\varepsilon_t \ll 1\)</span>), we can use the approximation:</p>
<p><span class="math display">\[
\log(1 + \varepsilon_t) \approx \varepsilon_t
\]</span></p>
<p>which means the model becomes approximately <strong>additive in log-space</strong>.<br>
This transformation stabilizes the variance and often results in more homogeneous residuals.</p>
</section>
<section id="procedure" class="level4" data-number="4.5.4.2">
<h4 data-number="4.5.4.2" class="anchored" data-anchor-id="procedure"><span class="header-section-number">4.5.4.2</span> Procedure</h4>
<p>To assess whether the multiplicative model is better, we can follow these steps:</p>
<ol type="1">
<li><strong>Log-transform the series</strong><br>
<span class="math display">\[
y'_t = \log(y_t)
\]</span></li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="ot">&lt;-</span> df_ts1 <span class="sc">|&gt;</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y_log =</span> <span class="fu">log</span>(y_2))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="2" type="1">
<li><strong>Re-estimate</strong> trend and seasonality using the same LOESS or regression techniques on <span class="math inline">\(y'_t\)</span>.</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Trend estimation using linear model</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>lm_tr_log <span class="ot">&lt;-</span> <span class="fu">lm</span>(y_log <span class="sc">~</span> <span class="fu">as.numeric</span>(day), <span class="at">data =</span> df_ts1)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Trend prediction</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="ot">&lt;-</span> df_ts1 <span class="sc">|&gt;</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tr_log =</span> <span class="fu">predict</span>(lm_tr_log))</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Seasonality estimation using LOESS</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>sea_log <span class="ot">&lt;-</span> <span class="fu">loess</span>(y_log <span class="sc">-</span> tr_log <span class="sc">~</span> <span class="fu">as.numeric</span>(day),</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> df_ts1,</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>                 <span class="at">span =</span> loess_span_low)</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="ot">&lt;-</span> df_ts1 <span class="sc">|&gt;</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sea_log =</span> sea_log<span class="sc">$</span>fitted)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="3" type="1">
<li><strong>Extract residuals</strong> in log-space: <span class="math display">\[
\varepsilon'_t = y'_t - tr'(t) - s'(t)
\]</span></li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="ot">&lt;-</span> df_ts1 <span class="sc">|&gt;</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">eps_log =</span> y_log <span class="sc">-</span> tr_log <span class="sc">-</span> sea_log)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="4" type="1">
<li><strong>Evaluate residual properties</strong>:
<ul>
<li>Mean ≈ 0 (centered)</li>
<li>Homoscedasticity (constant variance)</li>
<li>Independence over time</li>
<li>Normality (histogram or QQ-plot)</li>
</ul></li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Variances of additive and multiplicative residuals</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>var_add <span class="ot">&lt;-</span> <span class="fu">var</span>(df_ts1<span class="sc">$</span>y_noi, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>var_mul <span class="ot">&lt;-</span> <span class="fu">var</span>(df_ts1<span class="sc">$</span>eps_log, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="fu">tribble</span>(<span class="sc">~</span>Model, <span class="sc">~</span>Residual_Variance,</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Additive"</span>, <span class="fu">round</span>(var_add, <span class="dv">4</span>),</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Multiplicative (log-space)"</span>, <span class="fu">round</span>(var_mul, <span class="dv">4</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 2
  Model                      Residual_Variance
  &lt;chr&gt;                                  &lt;dbl&gt;
1 Additive                              2.76  
2 Multiplicative (log-space)            0.0906</code></pre>
</div>
</div>
<ol start="5" type="1">
<li><strong>Compare fit metrics</strong> between additive and multiplicative models:
<ul>
<li>Residual variance</li>
<li>AIC / BIC (if fitting parametric trend models)</li>
<li>Predictive performance (e.g., RMSE on holdout data)</li>
</ul></li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">|&gt;</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(day, eps_log, y_noi) <span class="sc">|&gt;</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(y_noi, eps_log),</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"model_type"</span>,</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"residual"</span>) <span class="sc">|&gt;</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> residual, <span class="at">color =</span> model_type)) <span class="sc">+</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span> model_type, <span class="at">ncol =</span> <span class="dv">1</span>, <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Comparison of Residuals: Additive vs. Multiplicative"</span>,</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Day"</span>, <span class="at">y =</span> <span class="st">"Residual"</span>, <span class="at">color =</span> <span class="st">"Model Type"</span>) <span class="sc">+</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define file path</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>output_path <span class="ot">&lt;-</span> <span class="st">"./data/synthetic_TS_02.tsv"</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Write to TSV</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="fu">write_tsv</span>(df_ts1, <span class="at">file =</span> output_path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
</section>
<section id="real-case-walmart-2010" class="level2" data-number="4.6">
<h2 data-number="4.6" class="anchored" data-anchor-id="real-case-walmart-2010"><span class="header-section-number">4.6</span> Real case: Walmart 2010</h2>
<p>Having validated our approach on synthetic data, we now test it on <strong>real-world data</strong>.</p>
<section id="dataset" class="level3" data-number="4.6.1">
<h3 data-number="4.6.1" class="anchored" data-anchor-id="dataset"><span class="header-section-number">4.6.1</span> Dataset</h3>
<p>We extracted data from the Walmart Kaggle competition.<br>
Here we focus on <strong>store 2, department 2</strong>.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>fpath_tra <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{data_dir}/Walmart/train.csv"</span>)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>df_tra <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(fpath_tra) <span class="sc">%&gt;%</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_all</span>(tolower) <span class="sc">%&gt;%</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">is_holiday =</span> isholiday)</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="ot">&lt;-</span> df_tra <span class="sc">%&gt;%</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(store <span class="sc">==</span> <span class="dv">2</span>, dept <span class="sc">==</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="inspecting-the-training-data" class="level3" data-number="4.6.2">
<h3 data-number="4.6.2" class="anchored" data-anchor-id="inspecting-the-training-data"><span class="header-section-number">4.6.2</span> Inspecting the training data</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">is_holiday =</span> <span class="fu">ifelse</span>(is_holiday, <span class="cn">TRUE</span>, <span class="cn">NA</span>),</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">store =</span> <span class="fu">factor</span>(store)) <span class="sc">%&gt;%</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> weekly_sales)) <span class="sc">+</span> </span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> store, <span class="at">color =</span> store)) <span class="sc">+</span> </span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">data =</span> df_tra <span class="sc">%&gt;%</span> <span class="fu">filter</span>(is_holiday) <span class="sc">%&gt;%</span> <span class="fu">distinct</span>(date), </span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>               <span class="fu">aes</span>(<span class="at">xintercept =</span> date), </span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">color =</span> <span class="st">"grey50"</span>, </span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>               <span class="at">alpha =</span> <span class="fl">0.5</span>, </span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>               <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span> </span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span> dept, <span class="at">scale =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Weekly Sales: Store 2, Department 2"</span>,</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Weekly Sales"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/restrict-to-1-store-1-dpt-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can already see seasonal patterns, particularly spikes at the end of each year.</p>
</section>
<section id="year-over-year-analysis" class="level3" data-number="4.6.3">
<h3 data-number="4.6.3" class="anchored" data-anchor-id="year-over-year-analysis"><span class="header-section-number">4.6.3</span> Year-over-year analysis</h3>
<p>To highlight seasonal effects, we overlay data year-over-year:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">factor</span>(<span class="fu">year</span>(date)),</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">date_no_year =</span> date) <span class="sc">%&gt;%</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(year, <span class="at">.before =</span> date)</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="fu">year</span>(df_tra_2<span class="sc">$</span>date_no_year) <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date_no_year, <span class="at">y =</span> weekly_sales, <span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Year-over-Year Weekly Sales"</span>,</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Day of Year"</span>,</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Weekly Sales"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/add-years-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Seasonality is evident, with noticeable correlations at year-end. Some mid-year dips in 2011 suggest year-specific effects.</p>
</section>
<section id="trend-analysis-1" class="level3" data-number="4.6.4">
<h3 data-number="4.6.4" class="anchored" data-anchor-id="trend-analysis-1"><span class="header-section-number">4.6.4</span> Trend analysis</h3>
<p><strong>Yearly Trend:</strong><br>
We first estimate the trend within each year, using both linear regression and LOESS smoothing:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>(<span class="at">data =</span> <span class="sc">-</span>year) <span class="sc">%&gt;%</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">lm_tr  =</span> <span class="fu">map</span>(year, <span class="sc">~</span> <span class="fu">lm</span>(df_tra_2 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(year <span class="sc">==</span> .x), <span class="at">formula =</span> weekly_sales <span class="sc">~</span> date)),</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">loes_tr =</span> <span class="fu">map</span>(year, <span class="sc">~</span> <span class="fu">loess</span>(df_tra_2 <span class="sc">%&gt;%</span> </span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">filter</span>(year <span class="sc">==</span> .x) <span class="sc">%&gt;%</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">as.numeric</span>(date)),</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>                                <span class="at">formula =</span> weekly_sales <span class="sc">~</span> date,</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>                                <span class="at">span =</span> loess_span_high)),</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">data    =</span> <span class="fu">map2</span>(data, lm_tr, <span class="sc">~</span> <span class="fu">mutate</span>(.x, <span class="at">try_lm =</span> .y<span class="sc">$</span>fitted)),</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">data    =</span> <span class="fu">map2</span>(data, loes_tr, <span class="sc">~</span> <span class="fu">mutate</span>(.x, <span class="at">try_lo =</span> .y<span class="sc">$</span>fitted))</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(lm_tr, loes_tr)) <span class="sc">%&gt;%</span></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(data)</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date_no_year, <span class="at">y =</span> weekly_sales, <span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> try_lm), <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> try_lo), <span class="at">linetype =</span> <span class="st">"longdash"</span>) <span class="sc">+</span></span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Yearly Trend: Linear vs. LOESS"</span>,</span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Day of Year"</span>,</span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Weekly Sales"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/add-trend-yoy-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The LOESS curves capture more of the seasonal variation than linear trends alone. Notice mid-year dips in 2011 that are not captured perfectly.</p>
<p><strong>Overall Trend:</strong><br>
Next, we estimate a trend across the entire period:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>lm_tr <span class="ot">&lt;-</span> <span class="fu">lm</span>(weekly_sales <span class="sc">~</span> date, <span class="at">data =</span> df_tra_2)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>lo_tr <span class="ot">&lt;-</span> <span class="fu">loess</span>(weekly_sales <span class="sc">~</span> <span class="fu">as.numeric</span>(date), <span class="at">data =</span> df_tra_2, <span class="at">span =</span> loess_span_high)</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tr_lm =</span> lm_tr<span class="sc">$</span>fitted,</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">tr_lo =</span> lo_tr<span class="sc">$</span>fitted)</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> weekly_sales, <span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tr_lo), <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tr_lm), <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Overall Trend: Linear vs. LOESS"</span>,</span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Weekly Sales"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/add-trend-overall-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Here, the LOESS trend better captures the variability, especially around peaks and troughs, compared to the linear fit.</p>
</section>
<section id="seasonality-and-noise-analysis" class="level3" data-number="4.6.5">
<h3 data-number="4.6.5" class="anchored" data-anchor-id="seasonality-and-noise-analysis"><span class="header-section-number">4.6.5</span> Seasonality and noise analysis</h3>
<section id="step-1-remove-overall-trend" class="level4" data-number="4.6.5.1">
<h4 data-number="4.6.5.1" class="anchored" data-anchor-id="step-1-remove-overall-trend"><span class="header-section-number">4.6.5.1</span> Step 1: remove overall trend</h4>
<p>We start by subtracting the overall trend (LOESS, with a high span) from the weekly sales to isolate the seasonal component plus noise:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">weekly_notr =</span> weekly_sales <span class="sc">-</span> tr_lo)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="step-2-estimate-seasonality" class="level4" data-number="4.6.5.2">
<h4 data-number="4.6.5.2" class="anchored" data-anchor-id="step-2-estimate-seasonality"><span class="header-section-number">4.6.5.2</span> Step 2: estimate seasonality</h4>
<p>We compute a LOESS-smoothed curve on the detrended series to approximate seasonality, setting a <strong>lower span</strong> to capture finer yearly patterns:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>sea_lo <span class="ot">&lt;-</span> <span class="fu">loess</span>(weekly_notr <span class="sc">~</span> <span class="fu">as.numeric</span>(date), <span class="at">data =</span> df_tra_2, <span class="at">span =</span> loess_span_low)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sea_lo =</span> sea_lo<span class="sc">$</span>fitted)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="step-3-visualize-seasonality-year-over-year" class="level4" data-number="4.6.5.3">
<h4 data-number="4.6.5.3" class="anchored" data-anchor-id="step-3-visualize-seasonality-year-over-year"><span class="header-section-number">4.6.5.3</span> Step 3: visualize seasonality year-over-year</h4>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date_no_year, <span class="at">y =</span> weekly_notr, <span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> sea_lo, <span class="at">group =</span> year), <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Detrended Weekly Sales: Seasonality (LOESS)"</span>,</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Day of Year"</span>,</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Detrended Sales"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can now clearly see the yearly seasonal pattern, including spikes around holidays and end-of-year peaks.</p>
</section>
<section id="step-4-extract-noise" class="level4" data-number="4.6.5.4">
<h4 data-number="4.6.5.4" class="anchored" data-anchor-id="step-4-extract-noise"><span class="header-section-number">4.6.5.4</span> Step 4: extract noise</h4>
<p>Subtracting the seasonal component from the detrended series gives us the residuals (noise):</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">weekly_noise =</span> weekly_notr <span class="sc">-</span> sea_lo)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="step-5-inspect-noise-properties" class="level4" data-number="4.6.5.5">
<h4 data-number="4.6.5.5" class="anchored" data-anchor-id="step-5-inspect-noise-properties"><span class="header-section-number">4.6.5.5</span> Step 5: inspect noise properties</h4>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>noi_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(df_tra_2<span class="sc">$</span>weekly_noise, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>noi_var  <span class="ot">&lt;-</span> <span class="fu">var</span>(df_tra_2<span class="sc">$</span>weekly_noise, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> weekly_noise)) <span class="sc">+</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), <span class="at">bins =</span> <span class="dv">100</span>, <span class="at">fill =</span> <span class="st">"lightblue"</span>) <span class="sc">+</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">"Histogram of Residual Noise</span><span class="sc">\n</span><span class="st">Mean = "</span>, <span class="fu">round</span>(noi_mean,<span class="dv">2</span>),</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>                        <span class="st">", Variance = "</span>, <span class="fu">round</span>(noi_var,<span class="dv">2</span>)),</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Residual Noise"</span>,</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Density"</span>) <span class="sc">+</span></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="step-6-overlay-noise-vs.-deterministic-component" class="level4" data-number="4.6.5.6">
<h4 data-number="4.6.5.6" class="anchored" data-anchor-id="step-6-overlay-noise-vs.-deterministic-component"><span class="header-section-number">4.6.5.6</span> Step 6: overlay noise vs.&nbsp;deterministic component</h4>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> weekly_noise)) <span class="sc">+</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> year), <span class="at">alpha =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tr_lo <span class="sc">+</span> sea_lo <span class="sc">-</span> <span class="fu">min</span>(tr_lo)), <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Residual Noise vs. Deterministic Component"</span>,</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Residual Noise"</span>) <span class="sc">+</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This helps check whether noise amplitude scales with signal, which would indicate multiplicative effects.</p>
</section>
<section id="step-7-normalize-noise-by-deterministic-component" class="level4" data-number="4.6.5.7">
<h4 data-number="4.6.5.7" class="anchored" data-anchor-id="step-7-normalize-noise-by-deterministic-component"><span class="header-section-number">4.6.5.7</span> Step 7: normalize noise by deterministic component</h4>
<p>Compute a relative noise, dividing the residual by the deterministic component (trend + seasonality):</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">deterministic =</span> tr_lo <span class="sc">+</span> sea_lo,</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">rel_noise =</span> weekly_noise <span class="sc">/</span> deterministic)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ul>
<li><p>This gives an approximate multiplicative residual, which should have roughly constant variance if the multiplicative model is appropriate.</p></li>
<li><p>Values are interpretable as “fractional deviation from expected sales.</p></li>
</ul>
</section>
<section id="step-8-compare-additive-vs.-multiplicative-noise-variance" class="level4" data-number="4.6.5.8">
<h4 data-number="4.6.5.8" class="anchored" data-anchor-id="step-8-compare-additive-vs.-multiplicative-noise-variance"><span class="header-section-number">4.6.5.8</span> Step 8: compare additive vs.&nbsp;multiplicative noise variance</h4>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute standard deviation</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>additive_var <span class="ot">&lt;-</span> <span class="fu">var</span>(df_tra_2<span class="sc">$</span>weekly_noise, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>multiplicative_var <span class="ot">&lt;-</span> <span class="fu">var</span>(df_tra_2<span class="sc">$</span>rel_noise, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a><span class="fu">tribble</span>(</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>model, <span class="sc">~</span>residual_variance,</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Additive"</span>, additive_var,</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Multiplicative"</span>, multiplicative_var</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 2
  model          residual_variance
  &lt;chr&gt;                      &lt;dbl&gt;
1 Additive                 1.40e+7
2 Multiplicative           2.97e-3</code></pre>
</div>
</div>
<p>Since the multiplicative variance is smaller, the multiplicative model stabilizes the residuals.</p>
</section>
<section id="step-9-visualize-relative-noise-over-time" class="level4" data-number="4.6.5.9">
<h4 data-number="4.6.5.9" class="anchored" data-anchor-id="step-9-visualize-relative-noise-over-time"><span class="header-section-number">4.6.5.9</span> Step 9: visualize relative noise over time</h4>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> rel_noise, <span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Relative (Multiplicative) Residuals"</span>,</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Fractional Residual"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This highlights whether the multiplicative model reduces the amplitude variation over the year.</p>
</section>
<section id="step-10-histogram-and-normality-check" class="level4" data-number="4.6.5.10">
<h4 data-number="4.6.5.10" class="anchored" data-anchor-id="step-10-histogram-and-normality-check"><span class="header-section-number">4.6.5.10</span> Step 10: histogram and normality check</h4>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>rel_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(df_tra_2<span class="sc">$</span>rel_noise, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>rel_var  <span class="ot">&lt;-</span> <span class="fu">var</span>(df_tra_2<span class="sc">$</span>rel_noise, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> rel_noise)) <span class="sc">+</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), <span class="at">bins =</span> <span class="dv">100</span>, <span class="at">fill =</span> <span class="st">"lightblue"</span>) <span class="sc">+</span></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">"Histogram of Relative Noise</span><span class="sc">\n</span><span class="st">Mean = "</span>, <span class="fu">round</span>(rel_mean,<span class="dv">2</span>),</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>                        <span class="st">", Variance = "</span>, <span class="fu">round</span>(rel_var,<span class="dv">2</span>)),</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Relative Residual"</span>,</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Density"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="step-11-log-transform-for-multiplicative-model" class="level4" data-number="4.6.5.11">
<h4 data-number="4.6.5.11" class="anchored" data-anchor-id="step-11-log-transform-for-multiplicative-model"><span class="header-section-number">4.6.5.11</span> Step 11: log-transform for multiplicative model</h4>
<p>Another way to handle multiplicative noise is to log-transform the data, which converts multiplicative effects into additive ones:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">log_weekly =</span> <span class="fu">log</span>(weekly_sales),</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">log_tr_lo  =</span> <span class="fu">log</span>(tr_lo),</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">log_resid  =</span> log_weekly <span class="sc">-</span> log_tr_lo)</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> log_weekly, <span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> log_tr_lo), <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Log-Transformed Weekly Sales with LOESS Trend"</span>,</span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"log(Weekly Sales)"</span></span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="step-12-examine-the-log-residuals" class="level4" data-number="4.6.5.12">
<h4 data-number="4.6.5.12" class="anchored" data-anchor-id="step-12-examine-the-log-residuals"><span class="header-section-number">4.6.5.12</span> Step 12: examine the log residuals</h4>
<p>Visualize the residuals in log-space to check if they’re roughly centered around zero and stationary.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> log_resid, <span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Residuals in Log-Space (Multiplicative Noise)"</span>,</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="fu">expression</span>(<span class="fu">log</span>(epsilon[t]))</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>If the multiplicative model is appropriate, the residuals should have:<br>
- constant variance over time, and - no clear seasonal pattern.</p>
</section>
<section id="step-13-distribution-of-log-residuals" class="level4" data-number="4.6.5.13">
<h4 data-number="4.6.5.13" class="anchored" data-anchor-id="step-13-distribution-of-log-residuals"><span class="header-section-number">4.6.5.13</span> Step 13: distribution of log residuals</h4>
<p>Check the shape of the distribution (for normality):</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>log_resid_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(df_tra_2<span class="sc">$</span>log_resid, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>log_resid_var  <span class="ot">&lt;-</span> <span class="fu">var</span>(df_tra_2<span class="sc">$</span>log_resid, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> log_resid)) <span class="sc">+</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), <span class="at">bins =</span> <span class="dv">100</span>, <span class="at">fill =</span> <span class="st">"lightblue"</span>) <span class="sc">+</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_function</span>(<span class="at">fun =</span> dnorm,</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>                  <span class="at">args =</span> <span class="fu">list</span>(<span class="at">mean =</span> log_resid_mean, <span class="at">sd =</span> <span class="fu">sqrt</span>(log_resid_var)),</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>                  <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Distribution of Log Residuals (Multiplicative Model)"</span>,</span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="fu">expression</span>(<span class="fu">log</span>(epsilon[t])),</span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Density"</span></span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>If the histogram closely follows the red curve (normal fit), the multiplicative model provides a valid Gaussian approximation in log-space.</p>
</section>
<section id="step-14-quantitative-comparison-with-additive-model" class="level4" data-number="4.6.5.14">
<h4 data-number="4.6.5.14" class="anchored" data-anchor-id="step-14-quantitative-comparison-with-additive-model"><span class="header-section-number">4.6.5.14</span> Step 14: quantitative comparison with additive model</h4>
<p>To summarize model performance, compare residual moments and normality:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tribble</span>(</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>Criterion, <span class="sc">~</span>Additive_Model, <span class="sc">~</span>Multiplicative_Model,</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Mean"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(df_tra_2<span class="sc">$</span>weekly_noise, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">4</span>), <span class="fu">round</span>(<span class="fu">mean</span>(df_tra_2<span class="sc">$</span>log_resid, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">4</span>),</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Variance"</span>, <span class="fu">round</span>(<span class="fu">var</span>(df_tra_2<span class="sc">$</span>weekly_noise, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">4</span>), <span class="fu">round</span>(<span class="fu">var</span>(df_tra_2<span class="sc">$</span>log_resid, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">4</span>),</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Shapiro-Wilk p-value"</span>,</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">signif</span>(<span class="fu">shapiro.test</span>(df_tra_2<span class="sc">$</span>weekly_noise)<span class="sc">$</span>p.value, <span class="dv">3</span>),</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">signif</span>(<span class="fu">shapiro.test</span>(df_tra_2<span class="sc">$</span>log_resid)<span class="sc">$</span>p.value, <span class="dv">3</span>)</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 3
  Criterion            Additive_Model Multiplicative_Model
  &lt;chr&gt;                         &lt;dbl&gt;                &lt;dbl&gt;
1 Mean                      -8.31e+ 0             -7   e-4
2 Variance                   1.40e+ 7              4.5 e-3
3 Shapiro-Wilk p-value       1.87e-13              1.18e-9</code></pre>
</div>
</div>
</section>
</section>
</section>
</section>
<section id="frequency-analysis-of-time-series" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Frequency analysis of time series</h1>
<p>This module explores <strong>frequency analysis</strong> to decompose a time series into its <strong>trend</strong>, <strong>seasonality</strong>, and <strong>noise</strong> components:</p>
<p><span class="math display">\[
y(t) = \mathrm{tr}(t) + s(t) + \epsilon_t
\]</span></p>
<p>Here, <span class="math inline">\(\mathrm{tr}(t)\)</span> represents the trend (long-term behavior), <span class="math inline">\(s(t)\)</span> represents seasonality (periodic patterns), and <span class="math inline">\(\epsilon_t\)</span> represents noise (random fluctuations). Typically, noise exhibits higher frequencies than seasonality, and seasonality has higher frequencies than the trend. This section introduces the <strong>Fourier Transform</strong> to analyze these components in the <strong>frequency domain</strong>.</p>
<section id="fourier-transform" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="fourier-transform"><span class="header-section-number">5.1</span> Fourier transform</h2>
<p>A time series can be represented as a sum of sine and cosine waves <strong>with varying frequencies, amplitudes, and phases</strong>:</p>
<p><span class="math display">\[
y(t) = x(0) + \sum_{k=1}^{n-1} x(k) \cos(k \omega t + \phi_k)
\]</span></p>
<p>where:<br>
- <span class="math inline">\(t\)</span> is the <strong>sampling interval</strong> (e.g., 1 day for daily data),<br>
- <span class="math inline">\(\omega = \frac{2\pi}{n}\)</span> is the <strong>frequency scaling factor</strong> (for daily data with <span class="math inline">\(n=365\)</span>),<br>
- <span class="math inline">\(x(k)\)</span> is the amplitude of the <span class="math inline">\(k\)</span>-th frequency component,<br>
- <span class="math inline">\(\phi_k\)</span> is the phase shift.</p>
<p>This is known as a <strong>cosine transform</strong>. Alternatively, we can use a <strong>complex representation</strong> combining sine and cosine terms:</p>
<p><span class="math display">\[
y(t) = \sum_{k=0}^{n-1} x(k) e^{ik\omega t}
\]</span></p>
<p>where <span class="math inline">\(e^{ik\omega t} = \cos(k\omega t) + i \sin(k\omega t)\)</span>, and the coefficients <span class="math inline">\(x(k)\)</span> are computed via the <strong>Fourier Transform</strong>:</p>
<p><span class="math display">\[
x(k) = \sum_{t=0}^{n-1} y(t) e^{-ik\omega t}
\]</span></p>
<p>For a real-valued time series <span class="math inline">\(y(t)\)</span>, the Fourier coefficients <span class="math inline">\(x(k)\)</span> are <strong>conjugate symmetric</strong>:</p>
<p><span class="math display">\[
x(k) = {x(n-k)}
\]</span></p>
<p>This ensures the imaginary parts cancel out in the inverse transform, yielding a real-valued time series. The first coefficient, <span class="math inline">\(x(0)\)</span>, represents the <strong>mean of the signal</strong>.</p>
</section>
<section id="fa-of-synthetic-time-series" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="fa-of-synthetic-time-series"><span class="header-section-number">5.2</span> FA of synthetic time series</h2>
<p>We begin with a synthetic time series dataset to illustrate Fourier analysis.</p>
<section id="loading-and-visualizing-the-data" class="level3" data-number="5.2.1">
<h3 data-number="5.2.1" class="anchored" data-anchor-id="loading-and-visualizing-the-data"><span class="header-section-number">5.2.1</span> Loading and visualizing the data</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>fpath_ts2 <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{data_dir}/synthetic_TS_02.tsv"</span>)</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="ot">&lt;-</span> <span class="fu">read_tsv</span>(fpath_ts2)</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>df_ts2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,008 × 31
    year day        date_no_year   mon   sea    tr    yd      noi     y noi_cnst
   &lt;dbl&gt; &lt;date&gt;     &lt;chr&gt;        &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;
 1  2023 2023-01-01 0-01-01          1 -2.20  5.00  2.80  0.108    2.91       -1
 2  2023 2023-01-02 0-01-02          1 -2.14  5.00  2.86 -0.00275  2.86        1
 3  2023 2023-01-03 0-01-03          1 -2.08  5.00  2.92 -0.780    2.14       -1
 4  2023 2023-01-04 0-01-04          1 -2.03  5.01  2.98  1.37     4.35       -1
 5  2023 2023-01-05 0-01-05          1 -1.98  5.01  3.03 -1.42     1.61        0
 6  2023 2023-01-06 0-01-06          1 -1.93  5.01  3.08  1.32     4.40       -1
 7  2023 2023-01-07 0-01-07          1 -1.88  5.01  3.13 -0.920    2.21        2
 8  2023 2023-01-08 0-01-08          1 -1.84  5.01  3.17  0.00859  3.18       -2
 9  2023 2023-01-09 0-01-09          1 -1.80  5.01  3.22 -0.155    3.06        1
10  2023 2023-01-10 0-01-10          1 -1.76  5.01  3.26  0.904    4.16       -1
# ℹ 998 more rows
# ℹ 21 more variables: y_1 &lt;dbl&gt;, lam &lt;dbl&gt;, noi_prop &lt;dbl&gt;, y_2 &lt;dbl&gt;,
#   try_lm &lt;dbl&gt;, try_lo &lt;dbl&gt;, tr_lm &lt;dbl&gt;, tr_lo_1 &lt;dbl&gt;, tr_lo_2 &lt;dbl&gt;,
#   y_notr &lt;dbl&gt;, sea_lo &lt;dbl&gt;, y_noi &lt;dbl&gt;, y_det &lt;dbl&gt;, eps_mul &lt;dbl&gt;,
#   log_y &lt;dbl&gt;, log_det &lt;dbl&gt;, log_eps &lt;dbl&gt;, y_log &lt;dbl&gt;, tr_log &lt;dbl&gt;,
#   sea_log &lt;dbl&gt;, eps_log &lt;dbl&gt;</code></pre>
</div>
</div>
<p>The dataset contains the time series <span class="math inline">\(y_2\)</span>, trend (<span class="math inline">\(tr(t)\)</span>), and deterministic component (<span class="math inline">\(y_d(t) = tr(t) + s(t)\)</span>). Let’s plot the time series with its trend (blue) and deterministic component (red):</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&gt;%</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">str_replace</span>(year, <span class="st">"$"</span>, <span class="st">"-01-01"</span>) <span class="sc">%&gt;%</span> as_date) <span class="sc">%&gt;%</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> y_2)) <span class="sc">+</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tr), <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> yd), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept =</span> year), <span class="at">color =</span> <span class="st">"grey50"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="computing-the-fourier-transform" class="level3" data-number="5.2.2">
<h3 data-number="5.2.2" class="anchored" data-anchor-id="computing-the-fourier-transform"><span class="header-section-number">5.2.2</span> Computing the Fourier transform</h3>
<p>We use the <strong>Fast Fourier Transform (FFT)</strong> to compute the Fourier coefficients, their magnitudes, and phases:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fft      =</span> <span class="fu">fft</span>(y_2),</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">freq     =</span> <span class="dv">0</span><span class="sc">:</span>(<span class="fu">nrow</span>(df_ts2)<span class="sc">-</span><span class="dv">1</span>) <span class="sc">*</span> <span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">/</span> <span class="dv">365</span>,</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">freq_mag =</span> <span class="fu">Mod</span>(fft) <span class="sc">/</span> <span class="fu">nrow</span>(df_ts2),</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">freq_pha =</span> <span class="fu">Arg</span>(fft))</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&gt;%</span></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(day, y_2, fft, freq, freq_mag, freq_pha)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,008 × 6
   day          y_2 fft                     freq freq_mag freq_pha
   &lt;date&gt;     &lt;dbl&gt; &lt;cpl&gt;                  &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
 1 2023-01-01  2.68 5784.041602+  0.0000i 0         5.74     0    
 2 2023-01-02  1.72 -279.085337+135.6503i 0.0172    0.308    2.69 
 3 2023-01-03  3.75 -412.705801+ 49.3987i 0.0344    0.412    3.02 
 4 2023-01-04  3.79  353.656316+266.1060i 0.0516    0.439    0.645
 5 2023-01-05  4.82    6.137246+115.7878i 0.0689    0.115    1.52 
 6 2023-01-06  1.85 -345.788543+447.4623i 0.0861    0.561    2.23 
 7 2023-01-07  2.88  116.566775-199.2687i 0.103     0.229   -1.04 
 8 2023-01-08  2.90  -29.909432-188.2257i 0.120     0.189   -1.73 
 9 2023-01-09  2.93   87.171826+656.2244i 0.138     0.657    1.44 
10 2023-01-10  1.95  -36.504022-205.5806i 0.155     0.207   -1.75 
# ℹ 998 more rows</code></pre>
</div>
</div>
<p>The first coefficient (<span class="math inline">\(x(0)\)</span>) corresponds to the mean of the signal. For our data, <span class="math inline">\(x(0) \approx\)</span> 6.</p>
</section>
<section id="plotting-frequency-magnitudes" class="level3" data-number="5.2.3">
<h3 data-number="5.2.3" class="anchored" data-anchor-id="plotting-frequency-magnitudes"><span class="header-section-number">5.2.3</span> Plotting frequency magnitudes</h3>
<p>We plot the magnitudes of the Fourier coefficients to <strong>identify dominant frequencies</strong>:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>thresh_mag <span class="ot">&lt;-</span> <span class="fl">0.14</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&gt;%</span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> freq, <span class="at">y =</span> freq_mag)) <span class="sc">+</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">mean</span>(df_ts2<span class="sc">$</span>freq), <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> thresh_mag, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylim</span>(<span class="cn">NA</span>, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The plot shows symmetry due to the real-valued nature of the time series. Alternatively, we can use the <code>periodogram()</code> function from the <code>TSA</code> package in R to compute the same:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="fu">periodogram</span>(df_ts2<span class="sc">$</span>y_2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Dominant frequencies</strong> appear at the <strong>lower end</strong>, corresponding to <strong>trend and seasonality</strong>.</p>
</section>
<section id="thresholding-and-inverse-fourier-transform" class="level3" data-number="5.2.4">
<h3 data-number="5.2.4" class="anchored" data-anchor-id="thresholding-and-inverse-fourier-transform"><span class="header-section-number">5.2.4</span> Thresholding and inverse Fourier transform</h3>
<p>We threshold the Fourier coefficients by setting those with magnitudes below <code>thresh_mag = 0.14</code> to zero, then apply the inverse Fourier transform to recover the signal:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fft_hi  =</span> <span class="fu">if_else</span>(freq_mag <span class="sc">&gt;</span> thresh_mag, fft, <span class="dv">0</span>),</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">pha_hi  =</span> <span class="fu">if_else</span>(freq_mag <span class="sc">&gt;</span> thresh_mag, freq_pha, <span class="dv">0</span>),</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">fft_lo  =</span> <span class="fu">if_else</span>(freq_mag <span class="sc">&lt;=</span> thresh_mag, fft, <span class="dv">0</span>),</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">fft_max =</span> <span class="fu">ifelse</span>(<span class="fu">row_number</span>() <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="fu">nrow</span>(df_ts2)), freq_mag, <span class="dv">0</span>),</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_hi    =</span> <span class="fu">fft</span>(fft_hi, <span class="at">inverse =</span> <span class="cn">TRUE</span>),</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_lo    =</span> <span class="fu">fft</span>(fft_lo, <span class="at">inverse =</span> <span class="cn">TRUE</span>),</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_max   =</span> <span class="fu">fft</span>(fft_max, <span class="at">inverse =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Verify that the recovered signal is real (imaginary parts are negligible):</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&gt;%</span> </span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(y_2, y_hi) <span class="sc">%&gt;%</span> </span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">im_hi =</span> <span class="fu">Im</span>(y_hi)) <span class="sc">%&gt;%</span> </span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(im_hi)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 956 × 2
       im_hi     n
       &lt;dbl&gt; &lt;int&gt;
 1 -3.27e-12     1
 2 -2.95e-12     1
 3 -2.90e-12     1
 4 -2.77e-12     1
 5 -2.76e-12     1
 6 -2.71e-12     1
 7 -2.70e-12     1
 8 -2.68e-12     1
 9 -2.51e-12     1
10 -2.47e-12     1
# ℹ 946 more rows</code></pre>
</div>
</div>
<p>Now, we scale the high-frequency component to match the seasonality (<span class="math inline">\(sea\)</span>) and plot:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y_hi =</span> <span class="fu">Re</span>(y_hi),</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_lo =</span> <span class="fu">Re</span>(y_lo),</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_max =</span> <span class="fu">Re</span>(y_max),</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_hi =</span> y_hi <span class="sc">-</span> <span class="fu">mean</span>(y_hi),</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_hi =</span> y_hi <span class="sc">/</span> <span class="fu">max</span>(<span class="fu">abs</span>(y_hi)) <span class="sc">*</span> <span class="fu">max</span>(<span class="fu">abs</span>(sea)))</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&gt;%</span></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">str_replace</span>(year, <span class="st">"$"</span>, <span class="st">"-01-01"</span>) <span class="sc">%&gt;%</span> as_date) <span class="sc">%&gt;%</span></span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> y_hi)) <span class="sc">+</span></span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> sea), <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept =</span> year), <span class="at">color =</span> <span class="st">"grey50"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="analyzing-noise" class="level3" data-number="5.2.5">
<h3 data-number="5.2.5" class="anchored" data-anchor-id="analyzing-noise"><span class="header-section-number">5.2.5</span> Analyzing noise</h3>
<p>The low-magnitude frequencies represent noise. Let’s plot them:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&gt;%</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> y_lo)) <span class="sc">+</span> </span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Compute the mean and variance of the noise:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>mean_y_lo <span class="ot">&lt;-</span> <span class="fu">mean</span>(df_ts2<span class="sc">$</span>y_lo)</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>var_y_lo <span class="ot">&lt;-</span> <span class="fu">var</span>(df_ts2<span class="sc">$</span>y_lo)</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Mean:"</span>, mean_y_lo, <span class="st">"</span><span class="sc">\n</span><span class="st">Variance:"</span>, var_y_lo)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Mean: -9.441301e-16 
Variance: 2740216</code></pre>
</div>
</div>
<p><strong>Homework 2</strong>: Can we recover a Poisson-like noise distribution from the synthetic data? Investigate whether scaling is needed and estimate the Poisson parameter. Plot the histogram of (y_lo) and overlay a Poisson distribution.</p>
</section>
<section id="phase-analysis" class="level3" data-number="5.2.6">
<h3 data-number="5.2.6" class="anchored" data-anchor-id="phase-analysis"><span class="header-section-number">5.2.6</span> Phase analysis</h3>
<p>We plot the phases for high-amplitude frequencies (first half of the data):</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&gt;%</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">row_number</span>() <span class="sc">&lt;=</span> <span class="fu">nrow</span>(df_ts2) <span class="sc">/</span> <span class="dv">2</span>, freq_mag <span class="sc">&gt;</span> thresh_mag) <span class="sc">%&gt;%</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> freq, <span class="at">y =</span> pha_hi)) <span class="sc">+</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>To analyze <strong>phase shifts across years</strong>, consider extracting seasonality for each year and comparing <strong>phases of dominant frequencies</strong>.</p>
</section>
</section>
<section id="auto-correlation" class="level2" data-number="5.3">
<h2 data-number="5.3" class="anchored" data-anchor-id="auto-correlation"><span class="header-section-number">5.3</span> Auto-correlation</h2>
<p>Auto-correlation measures the <strong>correlation of the time series with itself at different lags</strong>:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>acf_ts2 <span class="ot">&lt;-</span> <span class="fu">acf</span>(df_ts2<span class="sc">$</span>y_2, <span class="at">lag.max =</span> <span class="fu">nrow</span>(df_ts2)<span class="sc">/</span><span class="dv">2</span>, <span class="at">plot =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>df_acf <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">lag =</span> acf_ts2<span class="sc">$</span>lag[,<span class="dv">1</span>,<span class="dv">1</span>],</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">acf =</span> acf_ts2<span class="sc">$</span>acf[,<span class="dv">1</span>,<span class="dv">1</span>])</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>lag_year <span class="ot">&lt;-</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>  df_acf <span class="sc">%&gt;%</span></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(lag <span class="sc">&gt;</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(acf <span class="sc">&lt;</span> <span class="fu">max</span>(acf) <span class="sc">+</span> <span class="fl">0.01</span>,</span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>         acf <span class="sc">&gt;</span> <span class="fu">max</span>(acf) <span class="sc">-</span> <span class="fl">0.01</span>) <span class="sc">%&gt;%</span></span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract2</span>(<span class="st">"lag"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>  mean</span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a>df_acf <span class="sc">%&gt;%</span> </span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(lag <span class="sc">&gt;</span> <span class="dv">340</span>,</span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a>         lag <span class="sc">&lt;</span> <span class="dv">430</span>) <span class="sc">%&gt;%</span></span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> lag, <span class="at">y =</span> acf)) <span class="sc">+</span></span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> lag_year, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-34-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This helps <strong>identify the periodicity</strong> (e.g., yearly cycles).</p>
</section>
<section id="real-life-data" class="level2" data-number="5.4">
<h2 data-number="5.4" class="anchored" data-anchor-id="real-life-data"><span class="header-section-number">5.4</span> Real-life data</h2>
<p>We now apply Fourier analysis to real-world supply chain data from Walmart.</p>
<section id="loading-and-visualizing-the-data-1" class="level3" data-number="5.4.1">
<h3 data-number="5.4.1" class="anchored" data-anchor-id="loading-and-visualizing-the-data-1"><span class="header-section-number">5.4.1</span> Loading and Visualizing the Data</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>fpath_tra <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{data_dir}/Walmart/train.csv"</span>)</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>df_tra <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(fpath_tra) <span class="sc">%&gt;%</span> </span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_all</span>(tolower) <span class="sc">%&gt;%</span> </span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">is_holiday =</span> isholiday)</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="ot">&lt;-</span> df_tra <span class="sc">%&gt;%</span> </span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(dept <span class="sc">==</span> <span class="dv">2</span>, store <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">ws =</span> weekly_sales, <span class="at">is_hday =</span> is_holiday)</span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> ws)) <span class="sc">+</span></span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="smoothing-analysis" class="level3" data-number="5.4.2">
<h3 data-number="5.4.2" class="anchored" data-anchor-id="smoothing-analysis"><span class="header-section-number">5.4.2</span> Smoothing analysis</h3>
<section id="trend-1" class="level4" data-number="5.4.2.1">
<h4 data-number="5.4.2.1" class="anchored" data-anchor-id="trend-1"><span class="header-section-number">5.4.2.1</span> Trend</h4>
<p>The linear trend may not capture non-linear patterns (e.g., a dip in 2011). We first remove the linear trend and then fit a LOESS smoother with a high span (<span class="math inline">\(span = 0.7\)</span>):</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>loess_span_hi <span class="ot">&lt;-</span> <span class="fl">0.70</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>lm_tr <span class="ot">&lt;-</span> <span class="fu">lm</span>(ws <span class="sc">~</span> date, <span class="at">data =</span> df_tra_2)</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tr_lm =</span> lm_tr<span class="sc">$</span>fitted,</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">ws_1  =</span> ws <span class="sc">-</span> tr_lm)</span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>lo_tr_1 <span class="ot">&lt;-</span> <span class="fu">loess</span>(ws_1 <span class="sc">~</span> <span class="fu">as.numeric</span>(date), <span class="at">data =</span> df_tra_2, <span class="at">span =</span> loess_span_hi)</span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tr_lo_1 =</span> lo_tr_1<span class="sc">$</span>fitted,</span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">ws_2  =</span> ws_1 <span class="sc">-</span> tr_lo_1)</span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> ws_1)) <span class="sc">+</span></span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb82-16"><a href="#cb82-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tr_lo_1), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="seasonality-2" class="level4" data-number="5.4.2.2">
<h4 data-number="5.4.2.2" class="anchored" data-anchor-id="seasonality-2"><span class="header-section-number">5.4.2.2</span> Seasonality</h4>
<p>We fit a LOESS smoother with a lower span (<span class="math inline">\(span = 0.1\)</span>) to capture seasonality:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>loess_span_lo <span class="ot">&lt;-</span> <span class="fl">0.1</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>lo_tr_2 <span class="ot">&lt;-</span> <span class="fu">loess</span>(ws_2 <span class="sc">~</span> <span class="fu">as.numeric</span>(date), <span class="at">data =</span> df_tra_2, <span class="at">span =</span> loess_span_lo)</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tr_lo_2 =</span> lo_tr_2<span class="sc">$</span>fitted,</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">ws_3    =</span> ws_2 <span class="sc">-</span> tr_lo_2)</span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> ws_2)) <span class="sc">+</span></span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tr_lo_2), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="fourier-analysis" class="level3" data-number="5.4.3">
<h3 data-number="5.4.3" class="anchored" data-anchor-id="fourier-analysis"><span class="header-section-number">5.4.3</span> Fourier analysis</h3>
<p>We compute the Fourier transform for the real-life data:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fft_ws   =</span> <span class="fu">fft</span>(ws),</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">freq     =</span> <span class="dv">0</span><span class="sc">:</span>(<span class="fu">nrow</span>(df_tra_2)<span class="sc">-</span><span class="dv">1</span>) <span class="sc">*</span> <span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">/</span> <span class="dv">365</span>,</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">freq_mag =</span> <span class="fu">Mod</span>(fft_ws) <span class="sc">/</span> <span class="fu">nrow</span>(df_ts2),</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">freq_pha =</span> <span class="fu">Arg</span>(fft_ws))</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> freq, <span class="at">y =</span> freq_mag)) <span class="sc">+</span></span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="cn">NA</span>, <span class="dv">150</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-38-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The <code>periodogram</code> is more complex due to weekly data, where <strong>noise and seasonality frequencies are less distinct than in daily data</strong>.</p>
<p>We separate frequencies into three groups:<br>
- <strong>Lowest frequency</strong>: Trend/cycle.<br>
- <strong>Low frequencies</strong>: Seasonality.<br>
- <strong>High frequencies</strong>: Noise.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>thresh_mag_ws <span class="ot">&lt;-</span> <span class="dv">120</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>freq_last_lof <span class="ot">&lt;-</span> df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">row_number</span>() <span class="sc">&lt;</span> <span class="fu">nrow</span>(df_tra_2) <span class="sc">/</span> <span class="dv">2</span>, freq_mag <span class="sc">&gt;=</span> thresh_mag_ws) <span class="sc">%&gt;%</span></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(freq) <span class="sc">%&gt;%</span></span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>  last</span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a>idx_last_lof <span class="ot">&lt;-</span> <span class="fu">which</span>(df_tra_2<span class="sc">$</span>freq <span class="sc">==</span> freq_last_lof)</span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a>n_tra_2 <span class="ot">&lt;-</span> <span class="fu">nrow</span>(df_tra_2)</span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a>list_idx_minf <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, n_tra_2)</span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a>list_idx_lof <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span>idx_last_lof, (n_tra_2 <span class="sc">-</span> idx_last_lof <span class="sc">+</span> <span class="dv">2</span>)<span class="sc">:</span>n_tra_2) <span class="sc">%&gt;%</span></span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setdiff</span>(list_idx_minf) <span class="sc">%&gt;%</span></span>
<span id="cb85-14"><a href="#cb85-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">union</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb85-15"><a href="#cb85-15" aria-hidden="true" tabindex="-1"></a>  sort</span>
<span id="cb85-16"><a href="#cb85-16" aria-hidden="true" tabindex="-1"></a>list_idx_hif <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, (idx_last_lof <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(n_tra_2 <span class="sc">-</span> idx_last_lof <span class="sc">+</span> <span class="dv">1</span>))</span>
<span id="cb85-17"><a href="#cb85-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-18"><a href="#cb85-18" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb85-19"><a href="#cb85-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fft_lof  =</span> <span class="fu">if_else</span>(<span class="fu">row_number</span>() <span class="sc">%in%</span> list_idx_lof, fft_ws, <span class="dv">0</span>),</span>
<span id="cb85-20"><a href="#cb85-20" aria-hidden="true" tabindex="-1"></a>         <span class="at">fft_hif  =</span> <span class="fu">if_else</span>(<span class="fu">row_number</span>() <span class="sc">%in%</span> list_idx_hif, fft_ws, <span class="dv">0</span>),</span>
<span id="cb85-21"><a href="#cb85-21" aria-hidden="true" tabindex="-1"></a>         <span class="at">fft_minf =</span> <span class="fu">if_else</span>(<span class="fu">row_number</span>() <span class="sc">%in%</span> list_idx_minf, fft_ws, <span class="dv">0</span>),</span>
<span id="cb85-22"><a href="#cb85-22" aria-hidden="true" tabindex="-1"></a>         <span class="at">ws_lof   =</span> <span class="fu">fft</span>(fft_lof, <span class="at">inverse =</span> <span class="cn">TRUE</span>),</span>
<span id="cb85-23"><a href="#cb85-23" aria-hidden="true" tabindex="-1"></a>         <span class="at">ws_hif   =</span> <span class="fu">fft</span>(fft_hif, <span class="at">inverse =</span> <span class="cn">TRUE</span>),</span>
<span id="cb85-24"><a href="#cb85-24" aria-hidden="true" tabindex="-1"></a>         <span class="at">ws_minf  =</span> <span class="fu">fft</span>(fft_minf, <span class="at">inverse =</span> <span class="cn">TRUE</span>))</span>
<span id="cb85-25"><a href="#cb85-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-26"><a href="#cb85-26" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb85-27"><a href="#cb85-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ws_lof  =</span> <span class="fu">Re</span>(ws_lof),</span>
<span id="cb85-28"><a href="#cb85-28" aria-hidden="true" tabindex="-1"></a>         <span class="at">ws_hif  =</span> <span class="fu">Re</span>(ws_hif),</span>
<span id="cb85-29"><a href="#cb85-29" aria-hidden="true" tabindex="-1"></a>         <span class="at">ws_minf =</span> <span class="fu">Re</span>(ws_minf))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="trendcycle" class="level4" data-number="5.4.3.1">
<h4 data-number="5.4.3.1" class="anchored" data-anchor-id="trendcycle"><span class="header-section-number">5.4.3.1</span> Trend/cycle</h4>
<p>Compare the LOESS trend (red) with the lowest-frequency component (blue):</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ws_minf =</span> (ws_minf <span class="sc">-</span> <span class="fu">mean</span>(ws_minf)) <span class="sc">/</span> <span class="fu">sd</span>(ws_minf) <span class="sc">*</span> <span class="dv">1200</span>)</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> ws_1)) <span class="sc">+</span></span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tr_lo_1), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> ws_minf), <span class="at">color =</span> <span class="st">"blue"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-40-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="seasonality-3" class="level4" data-number="5.4.3.2">
<h4 data-number="5.4.3.2" class="anchored" data-anchor-id="seasonality-3"><span class="header-section-number">5.4.3.2</span> Seasonality</h4>
<p>Compare the LOESS seasonality (red) with the low-frequency component (blue):</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> ws_2)) <span class="sc">+</span></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tr_lo_2), <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> ws_lof), <span class="at">color =</span> <span class="st">"blue"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-41-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="noise-1" class="level4" data-number="5.4.3.3">
<h4 data-number="5.4.3.3" class="anchored" data-anchor-id="noise-1"><span class="header-section-number">5.4.3.3</span> Noise</h4>
<p>Analyze the high-frequency component:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ws_hif =</span> (ws_hif <span class="sc">-</span> <span class="fu">median</span>(ws_hif)) <span class="sc">/</span> <span class="fu">sd</span>(ws_hif))</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> ws_hif)) <span class="sc">+</span></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-42-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> ws_hif)) <span class="sc">+</span></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_histogram</span>() <span class="sc">+</span></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-42-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="homeworks" class="level2" data-number="5.5">
<h2 data-number="5.5" class="anchored" data-anchor-id="homeworks"><span class="header-section-number">5.5</span> Homeworks</h2>
<section id="homework-1-de-trending-before-fft-analysis" class="level3" data-number="5.5.1">
<h3 data-number="5.5.1" class="anchored" data-anchor-id="homework-1-de-trending-before-fft-analysis"><span class="header-section-number">5.5.1</span> Homework 1: De-trending Before FFT Analysis</h3>
<p>The goal is to investigate whether de-trending the synthetic time series ( y_2(t) ) before applying the Fast Fourier Transform (FFT) improves the separation and recovery of the seasonality component. We will: 1. Remove the trend (()) from ( y_2(t) ) to obtain a de-trended series. 2. Perform Fourier analysis on the de-trended series. 3. Compare the recovered seasonality with the original seasonality (()) from the dataset.</p>
<section id="step-1-load-and-de-trend-the-time-series" class="level4" data-number="5.5.1.1">
<h4 data-number="5.5.1.1" class="anchored" data-anchor-id="step-1-load-and-de-trend-the-time-series"><span class="header-section-number">5.5.1.1</span> Step 1: Load and De-trend the Time Series</h4>
<p>We start by loading the synthetic time series data and subtracting the trend component (()) from ( y_2 ).</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the data</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>fpath_ts2 <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{data_dir}/synthetic_TS_02.tsv"</span>)</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="ot">&lt;-</span> <span class="fu">read_tsv</span>(fpath_ts2)</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a><span class="co"># De-trend the time series</span></span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y_detrended =</span> y_2 <span class="sc">-</span> tr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The de-trended series ( y_ = y_2 - ) should primarily contain seasonality (()) and noise (()).</p>
</section>
<section id="step-2-visualize-the-de-trended-time-series" class="level4" data-number="5.5.1.2">
<h4 data-number="5.5.1.2" class="anchored" data-anchor-id="step-2-visualize-the-de-trended-time-series"><span class="header-section-number">5.5.1.2</span> Step 2: Visualize the De-trended Time Series</h4>
<p>Let’s plot the de-trended series alongside the original seasonality to visually inspect the effect of de-trending:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&gt;%</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">str_replace</span>(year, <span class="st">"$"</span>, <span class="st">"-01-01"</span>) <span class="sc">%&gt;%</span> as_date) <span class="sc">%&gt;%</span></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> y_detrended)) <span class="sc">+</span></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> sea), <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept =</span> year), <span class="at">color =</span> <span class="st">"grey50"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"De-trended Time Series vs. Original Seasonality"</span>,</span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Day"</span>, <span class="at">y =</span> <span class="st">"Value"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-44-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This plot helps us confirm that the de-trended series resembles the seasonality component, with noise superimposed.</p>
</section>
<section id="step-3-fourier-analysis-on-de-trended-series" class="level4" data-number="5.5.1.3">
<h4 data-number="5.5.1.3" class="anchored" data-anchor-id="step-3-fourier-analysis-on-de-trended-series"><span class="header-section-number">5.5.1.3</span> Step 3: Fourier Analysis on De-trended Series</h4>
<p>We apply the FFT to the de-trended series, compute the frequency magnitudes and phases, and threshold the coefficients to isolate seasonality.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute FFT on de-trended series</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fft_detrended =</span> <span class="fu">fft</span>(y_detrended),</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">freq =</span> <span class="dv">0</span><span class="sc">:</span>(<span class="fu">nrow</span>(df_ts2)<span class="sc">-</span><span class="dv">1</span>) <span class="sc">*</span> <span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">/</span> <span class="dv">365</span>,</span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">freq_mag_detrended =</span> <span class="fu">Mod</span>(fft_detrended) <span class="sc">/</span> <span class="fu">nrow</span>(df_ts2),</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">freq_pha_detrended =</span> <span class="fu">Arg</span>(fft_detrended))</span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot frequency magnitudes</span></span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>thresh_mag <span class="ot">&lt;-</span> <span class="fl">0.14</span></span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&gt;%</span></span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> freq, <span class="at">y =</span> freq_mag_detrended)) <span class="sc">+</span></span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> thresh_mag, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb92-15"><a href="#cb92-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylim</span>(<span class="cn">NA</span>, <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb92-16"><a href="#cb92-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Frequency Magnitudes of De-trended Time Series"</span>,</span>
<span id="cb92-17"><a href="#cb92-17" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Frequency"</span>, <span class="at">y =</span> <span class="st">"Magnitude"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-45-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The threshold (( = 0.14)) is reused from the original analysis for consistency. We expect the frequency spectrum to show prominent peaks corresponding to seasonal frequencies, with the trend-related low frequencies diminished.</p>
</section>
<section id="step-4-thresholding-and-inverse-fourier-transform" class="level4" data-number="5.5.1.4">
<h4 data-number="5.5.1.4" class="anchored" data-anchor-id="step-4-thresholding-and-inverse-fourier-transform"><span class="header-section-number">5.5.1.4</span> Step 4: Thresholding and Inverse Fourier Transform</h4>
<p>We threshold the Fourier coefficients to retain only those with magnitudes above (), which should correspond to seasonality, and compute the inverse FFT to recover the seasonality component:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fft_hi_detrended =</span> <span class="fu">if_else</span>(freq_mag_detrended <span class="sc">&gt;</span> thresh_mag, fft_detrended, <span class="dv">0</span>),</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">pha_hi_detrended =</span> <span class="fu">if_else</span>(freq_mag_detrended <span class="sc">&gt;</span> thresh_mag, freq_pha_detrended, <span class="dv">0</span>),</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_hi_detrended =</span> <span class="fu">fft</span>(fft_hi_detrended, <span class="at">inverse =</span> <span class="cn">TRUE</span>))</span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify the recovered signal is real</span></span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&gt;%</span></span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(y_detrended, y_hi_detrended) <span class="sc">%&gt;%</span></span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">im_hi_detrended =</span> <span class="fu">Im</span>(y_hi_detrended)) <span class="sc">%&gt;%</span></span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(im_hi_detrended)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 951 × 2
   im_hi_detrended     n
             &lt;dbl&gt; &lt;int&gt;
 1       -3.42e-12     1
 2       -3.27e-12     1
 3       -3.23e-12     1
 4       -3.09e-12     1
 5       -3.07e-12     1
 6       -3.04e-12     1
 7       -3.00e-12     1
 8       -2.90e-12     1
 9       -2.80e-12     1
10       -2.79e-12     1
# ℹ 941 more rows</code></pre>
</div>
</div>
<p>The imaginary parts should be negligible, confirming a real-valued recovered signal.</p>
</section>
<section id="step-5-scale-and-compare-recovered-seasonality" class="level4" data-number="5.5.1.5">
<h4 data-number="5.5.1.5" class="anchored" data-anchor-id="step-5-scale-and-compare-recovered-seasonality"><span class="header-section-number">5.5.1.5</span> Step 5: Scale and Compare Recovered Seasonality</h4>
<p>We scale the recovered seasonality (()) to match the amplitude of the original seasonality (()) and plot them for comparison:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y_hi_detrended =</span> <span class="fu">Re</span>(y_hi_detrended),</span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_hi_detrended =</span> y_hi_detrended <span class="sc">-</span> <span class="fu">mean</span>(y_hi_detrended),</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_hi_detrended =</span> y_hi_detrended <span class="sc">/</span> <span class="fu">max</span>(<span class="fu">abs</span>(y_hi_detrended)) <span class="sc">*</span> <span class="fu">max</span>(<span class="fu">abs</span>(sea)))</span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&gt;%</span></span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">str_replace</span>(year, <span class="st">"$"</span>, <span class="st">"-01-01"</span>) <span class="sc">%&gt;%</span> as_date) <span class="sc">%&gt;%</span></span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> y_hi_detrended)) <span class="sc">+</span></span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"red"</span>, <span class="fu">aes</span>(<span class="at">linetype =</span> <span class="st">"Recovered Seasonality"</span>)) <span class="sc">+</span></span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> sea), <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linetype =</span> <span class="st">"solid"</span>) <span class="sc">+</span></span>
<span id="cb95-11"><a href="#cb95-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept =</span> year), <span class="at">color =</span> <span class="st">"grey50"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb95-12"><a href="#cb95-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Recovered Seasonality (De-trended) vs. Original Seasonality"</span>,</span>
<span id="cb95-13"><a href="#cb95-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Day"</span>, <span class="at">y =</span> <span class="st">"Value"</span>) <span class="sc">+</span></span>
<span id="cb95-14"><a href="#cb95-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_linetype_manual</span>(<span class="at">name =</span> <span class="st">"Component"</span>, <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Recovered Seasonality"</span> <span class="ot">=</span> <span class="st">"dashed"</span>, <span class="st">"solid"</span> <span class="ot">=</span> <span class="st">"solid"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-47-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="step-6-comparison-with-original-analysis" class="level4" data-number="5.5.1.6">
<h4 data-number="5.5.1.6" class="anchored" data-anchor-id="step-6-comparison-with-original-analysis"><span class="header-section-number">5.5.1.6</span> Step 6: Comparison with Original Analysis</h4>
<p>In the original analysis (without de-trending), the FFT was applied directly to ( y_2 ), which included the trend. The trend contributes low-frequency components that may overlap with seasonal frequencies, potentially complicating the separation of seasonality and noise. By removing the trend first, we expect: - <strong>Cleaner frequency spectrum</strong>: Low-frequency components associated with the trend are eliminated, making seasonal frequencies more distinct. - <strong>Improved seasonality recovery</strong>: The thresholding process should better isolate seasonal frequencies, leading to a recovered seasonality (()) that more closely matches (). - <strong>Reduced noise interference</strong>: Noise frequencies are less likely to be confounded with trend-related frequencies.</p>
<p>To quantify the improvement, we compute the mean squared error (MSE) between the recovered seasonality and the original seasonality for both approaches:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co"># MSE for de-trended analysis</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>mse_detrended <span class="ot">&lt;-</span> <span class="fu">mean</span>((df_ts2<span class="sc">$</span>y_hi_detrended <span class="sc">-</span> df_ts2<span class="sc">$</span>sea)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a><span class="co"># MSE for original analysis (using y_hi from original analysis)</span></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>mse_original <span class="ot">&lt;-</span> <span class="fu">mean</span>((df_ts2<span class="sc">$</span>y_hi <span class="sc">-</span> df_ts2<span class="sc">$</span>sea)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"MSE (De-trended):"</span>, mse_detrended, <span class="st">"</span><span class="sc">\n</span><span class="st">MSE (Original):"</span>, mse_original)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>MSE (De-trended): 0.1796208 
MSE (Original): NaN</code></pre>
</div>
</div>
</section>
<section id="conclusion" class="level4" data-number="5.5.1.7">
<h4 data-number="5.5.1.7" class="anchored" data-anchor-id="conclusion"><span class="header-section-number">5.5.1.7</span> Conclusion</h4>
<p>De-trending the time series before applying the FFT likely improves the results if the MSE for the de-trended analysis is lower than that for the original analysis. This suggests better separation of the seasonality component, as the trend’s low-frequency components no longer interfere with the Fourier analysis. The visual comparison in the plot should show that the recovered seasonality (()) aligns more closely with () in terms of amplitude and phase, especially if the trend was a significant component in the original series.</p>
<p><strong>Key Observations</strong>: - If the trend is strong, de-trending reduces the amplitude of low-frequency components in the FFT, making it easier to isolate seasonal frequencies. - The threshold (( = 0.14)) may need adjustment for the de-trended series, as the frequency magnitudes are scaled differently without the trend. - If the MSE is similar or higher, it may indicate that the trend was not a significant factor, or the thresholding process needs optimization.</p>
<p><strong>Recommendation</strong>: Adjust the threshold () for the de-trended series if the recovered seasonality does not align well with (). Experiment with values around 0.14 to optimize the separation of seasonality and noise.</p>
</section>
</section>
<section id="homework-2-recovering-a-poisson-like-noise-distribution-from-synthetic-data" class="level3" data-number="5.5.2">
<h3 data-number="5.5.2" class="anchored" data-anchor-id="homework-2-recovering-a-poisson-like-noise-distribution-from-synthetic-data"><span class="header-section-number">5.5.2</span> Homework 2: Recovering a Poisson-like Noise Distribution from Synthetic Data</h3>
<p>The goal is to determine whether the noise component (( y_lo )) from the synthetic time series can be modeled as a Poisson distribution. We will: 1. Analyze the noise component (( y_lo )) obtained from the Fourier analysis. 2. Investigate whether scaling is needed to make ( y_lo ) resemble a Poisson distribution. 3. Estimate the Poisson parameter (()). 4. Plot the histogram of ( y_lo ) with an overlaid Poisson distribution.</p>
<section id="step-1-load-and-extract-noise-component" class="level4" data-number="5.5.2.1">
<h4 data-number="5.5.2.1" class="anchored" data-anchor-id="step-1-load-and-extract-noise-component"><span class="header-section-number">5.5.2.1</span> Step 1: Load and Extract Noise Component</h4>
<p>We assume the synthetic time series dataset has been processed as in the original course material, where ( y_lo ) represents the noise component obtained by thresholding the Fourier coefficients with ( = 0.14). If not already computed, we include the relevant code:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the data</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>fpath_ts2 <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{data_dir}/synthetic_TS_02.tsv"</span>)</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="ot">&lt;-</span> <span class="fu">read_tsv</span>(fpath_ts2)</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute FFT and threshold to extract noise</span></span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fft =</span> <span class="fu">fft</span>(y_2),</span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">freq =</span> <span class="dv">0</span><span class="sc">:</span>(<span class="fu">nrow</span>(df_ts2)<span class="sc">-</span><span class="dv">1</span>) <span class="sc">*</span> <span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">/</span> <span class="dv">365</span>,</span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">freq_mag =</span> <span class="fu">Mod</span>(fft) <span class="sc">/</span> <span class="fu">nrow</span>(df_ts2),</span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">freq_pha =</span> <span class="fu">Arg</span>(fft),</span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">fft_lo =</span> <span class="fu">if_else</span>(freq_mag <span class="sc">&lt;=</span> <span class="fl">0.14</span>, fft, <span class="dv">0</span>),</span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_lo =</span> <span class="fu">Re</span>(<span class="fu">fft</span>(fft_lo, <span class="at">inverse =</span> <span class="cn">TRUE</span>)))</span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-14"><a href="#cb98-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the noise component</span></span>
<span id="cb98-15"><a href="#cb98-15" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&gt;%</span></span>
<span id="cb98-16"><a href="#cb98-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> y_lo)) <span class="sc">+</span></span>
<span id="cb98-17"><a href="#cb98-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb98-18"><a href="#cb98-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Noise Component (y_lo)"</span>, <span class="at">x =</span> <span class="st">"Day"</span>, <span class="at">y =</span> <span class="st">"Value"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-49-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The noise component ( y_lo ) represents the high-frequency residuals after removing the trend and seasonality via Fourier thresholding.</p>
</section>
<section id="step-2-analyze-the-noise-distribution" class="level4" data-number="5.5.2.2">
<h4 data-number="5.5.2.2" class="anchored" data-anchor-id="step-2-analyze-the-noise-distribution"><span class="header-section-number">5.5.2.2</span> Step 2: Analyze the Noise Distribution</h4>
<p>A Poisson distribution models count data and has the following properties: - Non-negative integer values. - Mean equals variance ((= = )). - Probability mass function: ( P(X = k) = ), for ( k = 0, 1, 2, ).</p>
<p>First, we compute the mean and variance of ( y_lo ):</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>mean_y_lo <span class="ot">&lt;-</span> <span class="fu">mean</span>(df_ts2<span class="sc">$</span>y_lo)</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>var_y_lo <span class="ot">&lt;-</span> <span class="fu">var</span>(df_ts2<span class="sc">$</span>y_lo)</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Mean of y_lo:"</span>, mean_y_lo, <span class="st">"</span><span class="sc">\n</span><span class="st">Variance of y_lo:"</span>, var_y_lo)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Mean of y_lo: -9.441301e-16 
Variance of y_lo: 2740216</code></pre>
</div>
</div>
<p>In the original course material, the mean and variance of ( y_lo ) were reported (values not explicitly provided here but can be computed). For a Poisson distribution, we expect ( ). If the variance significantly exceeds the mean, the distribution may be overdispersed, requiring scaling or transformation.</p>
</section>
<section id="step-3-investigate-scaling" class="level4" data-number="5.5.2.3">
<h4 data-number="5.5.2.3" class="anchored" data-anchor-id="step-3-investigate-scaling"><span class="header-section-number">5.5.2.3</span> Step 3: Investigate Scaling</h4>
<p>Since Poisson distributions require non-negative integer values, we inspect the range of ( y_lo ):</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>summary_y_lo <span class="ot">&lt;-</span> <span class="fu">summary</span>(df_ts2<span class="sc">$</span>y_lo)</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Summary of y_lo:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Summary of y_lo:</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(summary_y_lo)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
-4808.7 -1173.7  -152.4     0.0   975.3  7600.8 </code></pre>
</div>
</div>
<p>The noise component ( y_lo ) from the inverse FFT is typically continuous and may include negative values due to the Fourier reconstruction. To model it as Poisson-like, we need to: 1. Shift the data to ensure non-negative values (e.g., add a constant to make all values ()). 2. Scale the data to approximate integer values. 3. Adjust the scale to align the mean and variance with a Poisson distribution.</p>
<p>Let’s try shifting and scaling:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Shift to non-negative</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>shift_constant <span class="ot">&lt;-</span> <span class="fu">abs</span>(<span class="fu">min</span>(df_ts2<span class="sc">$</span>y_lo)) <span class="sc">+</span> <span class="fl">1e-6</span>  <span class="co"># Small offset to avoid zero</span></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y_lo_shifted =</span> y_lo <span class="sc">+</span> shift_constant)</span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Check mean and variance of shifted data</span></span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>mean_y_lo_shifted <span class="ot">&lt;-</span> <span class="fu">mean</span>(df_ts2<span class="sc">$</span>y_lo_shifted)</span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a>var_y_lo_shifted <span class="ot">&lt;-</span> <span class="fu">var</span>(df_ts2<span class="sc">$</span>y_lo_shifted)</span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Mean of shifted y_lo:"</span>, mean_y_lo_shifted, <span class="st">"</span><span class="sc">\n</span><span class="st">Variance of shifted y_lo:"</span>, var_y_lo_shifted)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Mean of shifted y_lo: 4808.718 
Variance of shifted y_lo: 2740216</code></pre>
</div>
</div>
<p>If the variance is still much larger than the mean, we can apply a scaling factor to reduce the spread:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Scale to reduce variance (e.g., divide by standard deviation or a factor)</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>scaling_factor <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(var_y_lo_shifted <span class="sc">/</span> mean_y_lo_shifted)  <span class="co"># Approximate scaling to match mean and variance</span></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y_lo_scaled =</span> y_lo_shifted <span class="sc">/</span> scaling_factor)</span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Round to nearest integer for Poisson-like distribution</span></span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y_lo_rounded =</span> <span class="fu">round</span>(y_lo_scaled))</span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Recalculate mean and variance</span></span>
<span id="cb107-11"><a href="#cb107-11" aria-hidden="true" tabindex="-1"></a>mean_y_lo_rounded <span class="ot">&lt;-</span> <span class="fu">mean</span>(df_ts2<span class="sc">$</span>y_lo_rounded)</span>
<span id="cb107-12"><a href="#cb107-12" aria-hidden="true" tabindex="-1"></a>var_y_lo_rounded <span class="ot">&lt;-</span> <span class="fu">var</span>(df_ts2<span class="sc">$</span>y_lo_rounded)</span>
<span id="cb107-13"><a href="#cb107-13" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Mean of rounded y_lo:"</span>, mean_y_lo_rounded, <span class="st">"</span><span class="sc">\n</span><span class="st">Variance of rounded y_lo:"</span>, var_y_lo_rounded)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Mean of rounded y_lo: 201.4504 
Variance of rounded y_lo: 4810.464</code></pre>
</div>
</div>
</section>
<section id="step-4-estimate-poisson-parameter" class="level4" data-number="5.5.2.4">
<h4 data-number="5.5.2.4" class="anchored" data-anchor-id="step-4-estimate-poisson-parameter"><span class="header-section-number">5.5.2.4</span> Step 4: Estimate Poisson Parameter</h4>
<p>For a Poisson distribution, the parameter () is the mean of the distribution. We use the mean of the rounded, scaled noise:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>lambda_est <span class="ot">&lt;-</span> mean_y_lo_rounded</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Estimated Poisson parameter (lambda):"</span>, lambda_est)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Estimated Poisson parameter (lambda): 201.4504</code></pre>
</div>
</div>
</section>
<section id="step-5-plot-histogram-with-poisson-overlay" class="level4" data-number="5.5.2.5">
<h4 data-number="5.5.2.5" class="anchored" data-anchor-id="step-5-plot-histogram-with-poisson-overlay"><span class="header-section-number">5.5.2.5</span> Step 5: Plot Histogram with Poisson Overlay</h4>
<p>We plot the histogram of the scaled and rounded noise (()) and overlay a Poisson distribution with parameter (= ):</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute histogram and Poisson probabilities</span></span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>max_value <span class="ot">&lt;-</span> <span class="fu">max</span>(df_ts2<span class="sc">$</span>y_lo_rounded)</span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>poisson_probs <span class="ot">&lt;-</span> <span class="fu">dpois</span>(<span class="dv">0</span><span class="sc">:</span>max_value, <span class="at">lambda =</span> lambda_est)</span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create data frame for Poisson overlay</span></span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>df_pois <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> <span class="dv">0</span><span class="sc">:</span>max_value,</span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">prob =</span> poisson_probs <span class="sc">*</span> <span class="fu">nrow</span>(df_ts2) <span class="sc">*</span> <span class="fu">diff</span>(<span class="fu">hist</span>(df_ts2<span class="sc">$</span>y_lo_rounded, <span class="at">plot =</span> <span class="cn">FALSE</span>)<span class="sc">$</span>breaks)[<span class="dv">1</span>]</span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-11"><a href="#cb111-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot histogram with Poisson overlay</span></span>
<span id="cb111-12"><a href="#cb111-12" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&gt;%</span></span>
<span id="cb111-13"><a href="#cb111-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> y_lo_rounded)) <span class="sc">+</span></span>
<span id="cb111-14"><a href="#cb111-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="dv">1</span>, <span class="at">fill =</span> <span class="st">"lightblue"</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb111-15"><a href="#cb111-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">data =</span> df_pois, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> prob), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb111-16"><a href="#cb111-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Histogram of Scaled Noise with Poisson Overlay"</span>,</span>
<span id="cb111-17"><a href="#cb111-17" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Scaled Noise (Rounded)"</span>, <span class="at">y =</span> <span class="st">"Count"</span>) <span class="sc">+</span></span>
<span id="cb111-18"><a href="#cb111-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-55-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The red line represents the Poisson distribution with (= ). The histogram should show whether the scaled noise resembles a Poisson distribution.</p>
</section>
<section id="step-6-evaluate-poisson-fit" class="level4" data-number="5.5.2.6">
<h4 data-number="5.5.2.6" class="anchored" data-anchor-id="step-6-evaluate-poisson-fit"><span class="header-section-number">5.5.2.6</span> Step 6: Evaluate Poisson Fit</h4>
<p>To assess whether ( y_lo ) (after scaling) follows a Poisson distribution, we: 1. <strong>Compare Mean and Variance</strong>: Check if ( ). 2. <strong>Visual Inspection</strong>: Evaluate the histogram and Poisson overlay for visual similarity. 3. <strong>Statistical Test</strong>: Optionally, perform a goodness-of-fit test (e.g., Chi-squared test) to compare the observed distribution to a Poisson distribution.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Chi-squared goodness-of-fit test</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>hist_data <span class="ot">&lt;-</span> <span class="fu">hist</span>(df_ts2<span class="sc">$</span>y_lo_rounded, <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">0.5</span>, max_value <span class="sc">+</span> <span class="fl">0.5</span>, <span class="at">by =</span> <span class="dv">1</span>), <span class="at">plot =</span> <span class="cn">FALSE</span>)</span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>observed <span class="ot">&lt;-</span> hist_data<span class="sc">$</span>counts</span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>expected <span class="ot">&lt;-</span> <span class="fu">dpois</span>(<span class="dv">0</span><span class="sc">:</span>max_value, <span class="at">lambda =</span> lambda_est) <span class="sc">*</span> <span class="fu">sum</span>(observed)</span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>chi_test <span class="ot">&lt;-</span> <span class="fu">chisq.test</span>(observed, <span class="at">p =</span> expected <span class="sc">/</span> <span class="fu">sum</span>(expected), <span class="at">rescale.p =</span> <span class="cn">TRUE</span>)</span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Chi-squared test p-value:"</span>, chi_test<span class="sc">$</span>p.value)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Chi-squared test p-value: 0</code></pre>
</div>
</div>
<p>A p-value &gt; 0.05 suggests the scaled noise is consistent with a Poisson distribution.</p>
</section>
<section id="conclusion-1" class="level4" data-number="5.5.2.7">
<h4 data-number="5.5.2.7" class="anchored" data-anchor-id="conclusion-1"><span class="header-section-number">5.5.2.7</span> Conclusion</h4>
<ul>
<li><strong>Scaling Necessity</strong>: The original ( y_lo ) likely required shifting (to ensure non-negativity) and scaling (to align mean and variance) to resemble a Poisson distribution. Rounding to integers further aligns the data with Poisson characteristics.</li>
<li><strong>Poisson Parameter</strong>: The estimated () provides a reasonable fit if the mean and variance are similar post-scaling.</li>
<li><strong>Fit Quality</strong>: If the histogram aligns closely with the Poisson overlay and the Chi-squared test yields a high p-value, ( y_lo ) can be modeled as Poisson-like after appropriate transformations. If the fit is poor, the noise may follow a different distribution (e.g., Gaussian or overdispersed).</li>
</ul>
<p><strong>Challenges</strong>: - The continuous nature of ( y_lo ) from the FFT makes direct Poisson modeling difficult without transformation. - If the variance remains significantly larger than the mean after scaling, the noise may not be Poisson-like, suggesting a need for alternative distributions (e.g., negative binomial for overdispersion).</p>
<p><strong>Recommendation</strong>: If the Poisson fit is inadequate, experiment with different scaling factors or consider alternative distributions. Adjust the scaling factor iteratively to minimize the difference between mean and variance.</p>
</section>
</section>
</section>
</section>
<section id="using-libraries-for-trend-seasonality" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Using libraries for trend &amp; seasonality</h1>
<p>We have already seen how to extract <strong>trend</strong>, <strong>seasonality</strong>, and the <strong>remainder</strong> “by hand”. The <strong>tidyverts</strong> collection (<code>tsibble</code>, <code>feasts</code>, <code>fabletools</code>) does it in a tidy, pipe-friendly way. The workhorse is <strong>STL</strong> (Seasonal-Trend decomposition using LOESS) – the same method presented in <a href="https://otexts.com/fpp3/">Forecasting: Principles and Practice (3rd ed.)</a>.<br>
For Python users, the same ideas are available in <code>statsmodels.tsa.seasonal.STL</code> or via feature-extraction packages such as <code>tsfresh</code>.</p>
<section id="univariate-time-series" class="level2" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="univariate-time-series"><span class="header-section-number">6.1</span> Univariate time series</h2>
<section id="load-synthetic-data" class="level3" data-number="6.1.1">
<h3 data-number="6.1.1" class="anchored" data-anchor-id="load-synthetic-data"><span class="header-section-number">6.1.1</span> Load synthetic data</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>fpath_ts2 <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{data_dir}/synthetic_TS_02.tsv"</span>)</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>df_ts2    <span class="ot">&lt;-</span> <span class="fu">read_tsv</span>(fpath_ts2)</span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>df_ts2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,008 × 31
    year day        date_no_year   mon   sea    tr    yd      noi     y noi_cnst
   &lt;dbl&gt; &lt;date&gt;     &lt;chr&gt;        &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;
 1  2023 2023-01-01 0-01-01          1 -2.20  5.00  2.80  0.108    2.91       -1
 2  2023 2023-01-02 0-01-02          1 -2.14  5.00  2.86 -0.00275  2.86        1
 3  2023 2023-01-03 0-01-03          1 -2.08  5.00  2.92 -0.780    2.14       -1
 4  2023 2023-01-04 0-01-04          1 -2.03  5.01  2.98  1.37     4.35       -1
 5  2023 2023-01-05 0-01-05          1 -1.98  5.01  3.03 -1.42     1.61        0
 6  2023 2023-01-06 0-01-06          1 -1.93  5.01  3.08  1.32     4.40       -1
 7  2023 2023-01-07 0-01-07          1 -1.88  5.01  3.13 -0.920    2.21        2
 8  2023 2023-01-08 0-01-08          1 -1.84  5.01  3.17  0.00859  3.18       -2
 9  2023 2023-01-09 0-01-09          1 -1.80  5.01  3.22 -0.155    3.06        1
10  2023 2023-01-10 0-01-10          1 -1.76  5.01  3.26  0.904    4.16       -1
# ℹ 998 more rows
# ℹ 21 more variables: y_1 &lt;dbl&gt;, lam &lt;dbl&gt;, noi_prop &lt;dbl&gt;, y_2 &lt;dbl&gt;,
#   try_lm &lt;dbl&gt;, try_lo &lt;dbl&gt;, tr_lm &lt;dbl&gt;, tr_lo_1 &lt;dbl&gt;, tr_lo_2 &lt;dbl&gt;,
#   y_notr &lt;dbl&gt;, sea_lo &lt;dbl&gt;, y_noi &lt;dbl&gt;, y_det &lt;dbl&gt;, eps_mul &lt;dbl&gt;,
#   log_y &lt;dbl&gt;, log_det &lt;dbl&gt;, log_eps &lt;dbl&gt;, y_log &lt;dbl&gt;, tr_log &lt;dbl&gt;,
#   sea_log &lt;dbl&gt;, eps_log &lt;dbl&gt;</code></pre>
</div>
</div>
</section>
<section id="load-walmart-real-data" class="level3" data-number="6.1.2">
<h3 data-number="6.1.2" class="anchored" data-anchor-id="load-walmart-real-data"><span class="header-section-number">6.1.2</span> Load Walmart (real) data</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>fpath_wws <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{data_dir}/Walmart/train.csv"</span>)</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>df_wws <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(fpath_wws) <span class="sc">%&gt;%</span></span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_with</span>(tolower) <span class="sc">%&gt;%</span></span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">is_holiday =</span> isholiday,</span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">weekly_sales =</span> weekly_sales)</span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a>df_wws</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 421,570 × 5
   store  dept date       weekly_sales is_holiday
   &lt;dbl&gt; &lt;dbl&gt; &lt;date&gt;            &lt;dbl&gt; &lt;lgl&gt;     
 1     1     1 2010-02-05       24924. FALSE     
 2     1     1 2010-02-12       46039. TRUE      
 3     1     1 2010-02-19       41596. FALSE     
 4     1     1 2010-02-26       19404. FALSE     
 5     1     1 2010-03-05       21828. FALSE     
 6     1     1 2010-03-12       21043. FALSE     
 7     1     1 2010-03-19       22137. FALSE     
 8     1     1 2010-03-26       26229. FALSE     
 9     1     1 2010-04-02       57258. FALSE     
10     1     1 2010-04-09       42961. FALSE     
# ℹ 421,560 more rows</code></pre>
</div>
</div>
</section>
<section id="turn-data-frames-into-tsibble-objects" class="level3" data-number="6.1.3">
<h3 data-number="6.1.3" class="anchored" data-anchor-id="turn-data-frames-into-tsibble-objects"><span class="header-section-number">6.1.3</span> Turn data frames into <code>tsibble</code> objects</h3>
<p>We first need to transform our data frames into Time Series objects. We use the library <code>tsibble</code> for that and quickly have a look at the data using the <code>autoplot</code> function.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>ts_ts2 <span class="ot">&lt;-</span> df_ts2 <span class="sc">%&gt;%</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(day, y_2) <span class="sc">%&gt;%</span></span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">day =</span> <span class="fu">as_date</span>(day)) <span class="sc">%&gt;%</span>           <span class="co"># ensure Date class</span></span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tsibble</span>(<span class="at">index =</span> day)</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>ts_ts2 <span class="sc">%&gt;%</span> <span class="fu">autoplot</span>(y_2) <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Synthetic series (y_2)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/transform-df-to-ts-ts2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>ts_wws <span class="ot">&lt;-</span> df_wws <span class="sc">%&gt;%</span></span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">yweek =</span> <span class="fu">yearweek</span>(date)) <span class="sc">%&gt;%</span></span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tsibble</span>(<span class="at">index =</span> yweek, <span class="at">key =</span> <span class="fu">c</span>(store, dept))</span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Quick sanity check: day-of-week distribution</span></span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a>df_wws <span class="sc">%&gt;%</span></span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dow =</span> <span class="fu">wday</span>(date, <span class="at">label =</span> <span class="cn">TRUE</span>, <span class="at">abbr =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(dow)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 2
  dow        n
  &lt;ord&gt;  &lt;int&gt;
1 Fri   421570</code></pre>
</div>
</div>
<p>Plot a few store-department combos.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>ts_wws <span class="sc">%&gt;%</span></span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(store <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), dept <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>(weekly_sales) <span class="sc">+</span></span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(store <span class="sc">~</span> dept, <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Weekly sales – stores 1-2, departments 1 &amp; 3"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/transform-df-to-ts-wws-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="classical-additive-decomposition-moving-averages" class="level2" data-number="6.2">
<h2 data-number="6.2" class="anchored" data-anchor-id="classical-additive-decomposition-moving-averages"><span class="header-section-number">6.2</span> Classical additive decomposition (moving averages)</h2>
<p>Next, we’ll use the <strong>classical_decomposition</strong> from the <code>feasts</code> package. It uses Moving Averages optimized in some ways.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>ts_ts2 <span class="sc">%&gt;%</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model</span>(<span class="fu">classical_decomposition</span>(y_2, <span class="at">type =</span> <span class="st">"additive"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">components</span>() <span class="sc">%&gt;%</span></span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>() <span class="sc">+</span></span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Classical additive decomposition (default MA)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/default-classical-decomposition-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<section id="tweaking-the-season-length" class="level3" data-number="6.2.1">
<h3 data-number="6.2.1" class="anchored" data-anchor-id="tweaking-the-season-length"><span class="header-section-number">6.2.1</span> Tweaking the season length</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>ts_ts2 <span class="sc">%&gt;%</span></span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model</span>(<span class="fu">classical_decomposition</span>(y_2 <span class="sc">~</span> <span class="fu">season</span>(<span class="at">period =</span> <span class="st">"365 days"</span>),</span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>                                <span class="at">type =</span> <span class="st">"additive"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">components</span>() <span class="sc">%&gt;%</span></span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>() <span class="sc">+</span></span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Classical decomposition – explicit 365-day season"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/experiement-classical-decomposition-with-params-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="stl-from-feasts-tidyverts" class="level2" data-number="6.3">
<h2 data-number="6.3" class="anchored" data-anchor-id="stl-from-feasts-tidyverts"><span class="header-section-number">6.3</span> STL from feasts (tidyverts)</h2>
<p>The <code>STL()</code> model in <strong>feasts</strong> is a thin wrapper around <code>stats::stl()</code> but works inside the <code>model()</code> pipeline.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>ts_ts2 <span class="sc">%&gt;%</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model</span>(</span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">STL</span>(y_2 <span class="sc">~</span> <span class="fu">trend</span>(<span class="at">window =</span> <span class="dv">381</span>, <span class="at">degree =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>              <span class="fu">season</span>(<span class="at">period =</span> <span class="st">"1 year"</span>, <span class="at">window =</span> <span class="dv">33</span>, <span class="at">degree =</span> <span class="dv">1</span>),</span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">robust =</span> <span class="cn">TRUE</span>)</span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">components</span>() <span class="sc">%&gt;%</span></span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>() <span class="sc">+</span></span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"STL (feasts) – robust, custom windows"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-57-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>ts_ts2_stl <span class="ot">&lt;-</span> </span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>  ts_ts2 <span class="sc">%&gt;%</span> </span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stl</span>(<span class="at">s.window =</span> <span class="st">"periodic"</span>,</span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">s.degree =</span> <span class="dv">1</span>,</span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">t.window =</span> <span class="dv">380</span>,</span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">t.degree =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract2</span>(<span class="st">"time.series"</span>)</span>
<span id="cb125-8"><a href="#cb125-8" aria-hidden="true" tabindex="-1"></a>ts_ts2_stl <span class="sc">%&gt;%</span> autoplot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/stats-base-stl-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>ts_ts2_stl <span class="ot">&lt;-</span> </span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>  ts_ts2 <span class="sc">%&gt;%</span> </span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stl</span>(<span class="at">s.window =</span> <span class="dv">33</span>,</span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">s.degree =</span> <span class="dv">1</span>,</span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">t.window =</span> <span class="dv">751</span>,</span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">t.degree =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract2</span>(<span class="st">"time.series"</span>)</span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a>ts_ts2_stl <span class="sc">%&gt;%</span> autoplot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/stats-base-stl-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The <strong>model</strong> function from package <code>fabletools</code> also has a STL model:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>ts_ts2 <span class="sc">%&gt;%</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model</span>(<span class="fu">STL</span>(y_2 <span class="sc">~</span> <span class="fu">trend</span>(<span class="at">window =</span> <span class="fl">0.75</span> <span class="sc">*</span> <span class="fu">nrow</span>(ts_ts2), </span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">degree =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">season</span>(<span class="at">window =</span> <span class="fl">0.1</span> <span class="sc">*</span> <span class="fu">nrow</span>(ts_ts2), </span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>                         <span class="at">period =</span> <span class="st">"1 year"</span>, </span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a>                         <span class="at">degree =</span> <span class="dv">1</span>),</span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">robust =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb127-8"><a href="#cb127-8" aria-hidden="true" tabindex="-1"></a>  components <span class="sc">%&gt;%</span></span>
<span id="cb127-9"><a href="#cb127-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/experiment-with-STL-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="multiple-time-series" class="level2" data-number="6.4">
<h2 data-number="6.4" class="anchored" data-anchor-id="multiple-time-series"><span class="header-section-number">6.4</span> Multiple time series</h2>
<section id="detect-gaps" class="level3" data-number="6.4.1">
<h3 data-number="6.4.1" class="anchored" data-anchor-id="detect-gaps"><span class="header-section-number">6.4.1</span> Detect gaps</h3>
<p>Tools from <code>tsibble</code> for detecting gaps:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>ts_wws <span class="sc">%&gt;%</span> has_gaps</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,331 × 3
   store  dept .gaps
   &lt;dbl&gt; &lt;dbl&gt; &lt;lgl&gt;
 1     1     1 FALSE
 2     1     2 FALSE
 3     1     3 FALSE
 4     1     4 FALSE
 5     1     5 FALSE
 6     1     6 FALSE
 7     1     7 FALSE
 8     1     8 FALSE
 9     1     9 FALSE
10     1    10 FALSE
# ℹ 3,321 more rows</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>ts_wws <span class="sc">%&gt;%</span> has_gaps <span class="sc">%&gt;%</span> <span class="fu">filter</span>(.gaps <span class="sc">==</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 605 × 3
   store  dept .gaps
   &lt;dbl&gt; &lt;dbl&gt; &lt;lgl&gt;
 1     1    18 TRUE 
 2     1    45 TRUE 
 3     1    47 TRUE 
 4     1    48 TRUE 
 5     1    51 TRUE 
 6     1    54 TRUE 
 7     1    77 TRUE 
 8     1    78 TRUE 
 9     1    99 TRUE 
10     2    18 TRUE 
# ℹ 595 more rows</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>ts_wws <span class="sc">%&gt;%</span> <span class="fu">count_gaps</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5,447 × 5
   store  dept    .from      .to    .n
   &lt;dbl&gt; &lt;dbl&gt;   &lt;week&gt;   &lt;week&gt; &lt;int&gt;
 1     1    18 2010 W17 2010 W18     2
 2     1    18 2010 W20 2010 W21     2
 3     1    18 2010 W24 2010 W32     9
 4     1    18 2011 W22 2011 W22     1
 5     1    18 2011 W25 2011 W25     1
 6     1    18 2011 W27 2011 W27     1
 7     1    18 2011 W29 2011 W33     5
 8     1    18 2012 W20 2012 W20     1
 9     1    18 2012 W24 2012 W28     5
10     1    18 2012 W30 2012 W32     3
# ℹ 5,437 more rows</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>ts_wws <span class="sc">%&gt;%</span></span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(store <span class="sc">==</span> <span class="dv">1</span>, dept <span class="sc">==</span> <span class="dv">18</span>) <span class="sc">%&gt;%</span></span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="at">n =</span> <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tsibble: 113 x 6 [1W]
# Key:       store, dept [1]
   store  dept date       weekly_sales is_holiday    yweek
   &lt;dbl&gt; &lt;dbl&gt; &lt;date&gt;            &lt;dbl&gt; &lt;lgl&gt;        &lt;week&gt;
 1     1    18 2010-02-05      4730.   FALSE      2010 W05
 2     1    18 2010-02-12     19006.   TRUE       2010 W06
 3     1    18 2010-02-19     17624.   FALSE      2010 W07
 4     1    18 2010-02-26       545.   FALSE      2010 W08
 5     1    18 2010-03-05       635.   FALSE      2010 W09
 6     1    18 2010-03-12      1275.   FALSE      2010 W10
 7     1    18 2010-03-19      2303.   FALSE      2010 W11
 8     1    18 2010-03-26      4037.   FALSE      2010 W12
 9     1    18 2010-04-02     17916.   FALSE      2010 W13
10     1    18 2010-04-09      8668.   FALSE      2010 W14
11     1    18 2010-04-16       585.   FALSE      2010 W15
12     1    18 2010-04-23        65.2  FALSE      2010 W16
13     1    18 2010-05-14         0.5  FALSE      2010 W19
14     1    18 2010-06-04         4.1  FALSE      2010 W22
15     1    18 2010-06-11         0.15 FALSE      2010 W23
16     1    18 2010-08-20         1    FALSE      2010 W33
17     1    18 2010-08-27        23    FALSE      2010 W34
18     1    18 2010-09-03       132    FALSE      2010 W35
19     1    18 2010-09-10       246    TRUE       2010 W36
20     1    18 2010-09-17      1584.   FALSE      2010 W37
# ℹ 93 more rows</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>ts_wws <span class="sc">%&gt;%</span> <span class="fu">scan_gaps</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tsibble: 27,667 x 3 [1W]
# Key:       store, dept [605]
   store  dept    yweek
   &lt;dbl&gt; &lt;dbl&gt;   &lt;week&gt;
 1     1    18 2010 W17
 2     1    18 2010 W18
 3     1    18 2010 W20
 4     1    18 2010 W21
 5     1    18 2010 W24
 6     1    18 2010 W25
 7     1    18 2010 W26
 8     1    18 2010 W27
 9     1    18 2010 W28
10     1    18 2010 W29
# ℹ 27,657 more rows</code></pre>
</div>
</div>
</section>
<section id="fill-gaps-keep-original-keys" class="level3" data-number="6.4.2">
<h3 data-number="6.4.2" class="anchored" data-anchor-id="fill-gaps-keep-original-keys"><span class="header-section-number">6.4.2</span> Fill gaps (keep original keys)</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a>ts_wws <span class="sc">%&gt;%</span>  <span class="fu">fill_gaps</span>(<span class="at">.full =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tsibble: 476,333 x 6 [1W]
# Key:       store, dept [3,331]
   store  dept date       weekly_sales is_holiday    yweek
   &lt;dbl&gt; &lt;dbl&gt; &lt;date&gt;            &lt;dbl&gt; &lt;lgl&gt;        &lt;week&gt;
 1     1     1 2010-02-05       24924. FALSE      2010 W05
 2     1     1 2010-02-12       46039. TRUE       2010 W06
 3     1     1 2010-02-19       41596. FALSE      2010 W07
 4     1     1 2010-02-26       19404. FALSE      2010 W08
 5     1     1 2010-03-05       21828. FALSE      2010 W09
 6     1     1 2010-03-12       21043. FALSE      2010 W10
 7     1     1 2010-03-19       22137. FALSE      2010 W11
 8     1     1 2010-03-26       26229. FALSE      2010 W12
 9     1     1 2010-04-02       57258. FALSE      2010 W13
10     1     1 2010-04-09       42961. FALSE      2010 W14
# ℹ 476,323 more rows</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a>ts_wws <span class="sc">%&gt;%</span>  <span class="fu">fill_gaps</span>(<span class="at">.full =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tsibble: 449,237 x 6 [1W]
# Key:       store, dept [3,331]
   store  dept date       weekly_sales is_holiday    yweek
   &lt;dbl&gt; &lt;dbl&gt; &lt;date&gt;            &lt;dbl&gt; &lt;lgl&gt;        &lt;week&gt;
 1     1     1 2010-02-05       24924. FALSE      2010 W05
 2     1     1 2010-02-12       46039. TRUE       2010 W06
 3     1     1 2010-02-19       41596. FALSE      2010 W07
 4     1     1 2010-02-26       19404. FALSE      2010 W08
 5     1     1 2010-03-05       21828. FALSE      2010 W09
 6     1     1 2010-03-12       21043. FALSE      2010 W10
 7     1     1 2010-03-19       22137. FALSE      2010 W11
 8     1     1 2010-03-26       26229. FALSE      2010 W12
 9     1     1 2010-04-02       57258. FALSE      2010 W13
10     1     1 2010-04-09       42961. FALSE      2010 W14
# ℹ 449,227 more rows</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a>ts_wws <span class="sc">%&lt;&gt;%</span>  <span class="fu">fill_gaps</span>(<span class="at">.full =</span> <span class="cn">FALSE</span>)</span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a>ts_wws <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(store) <span class="sc">%&gt;%</span> <span class="fu">reframe</span>(<span class="at">n_na =</span> <span class="fu">sum</span>(<span class="fu">is.na</span>(weekly_sales)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 45 × 2
   store  n_na
   &lt;dbl&gt; &lt;int&gt;
 1     1   414
 2     2   436
 3     3   499
 4     4   450
 5     5   643
 6     6   420
 7     7   565
 8     8   514
 9     9   658
10    10   388
# ℹ 35 more rows</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a>ts_wws <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(dept) <span class="sc">%&gt;%</span> <span class="fu">reframe</span>(<span class="at">n_na =</span> <span class="fu">sum</span>(<span class="fu">is.na</span>(weekly_sales)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 81 × 2
    dept  n_na
   &lt;dbl&gt; &lt;int&gt;
 1     1     0
 2     2     0
 3     3     0
 4     4     0
 5     5    88
 6     6   193
 7     7     0
 8     8     0
 9     9    67
10    10     0
# ℹ 71 more rows</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a>df_na_wws <span class="ot">&lt;-</span></span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>  ts_wws <span class="sc">%&gt;%</span> </span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by_key</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reframe</span>(<span class="at">n_na =</span> <span class="fu">sum</span>(<span class="fu">is.na</span>(weekly_sales)))</span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a>df_na_wws</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,331 × 3
   store  dept  n_na
   &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt;
 1     1     1     0
 2     1     2     0
 3     1     3     0
 4     1     4     0
 5     1     5     0
 6     1     6     0
 7     1     7     0
 8     1     8     0
 9     1     9     0
10     1    10     0
# ℹ 3,321 more rows</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a>df_na_wws <span class="sc">%&gt;%</span></span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">has_na =</span> n_na <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(has_na) <span class="sc">%&gt;%</span></span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pct_na =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n) <span class="sc">*</span> <span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 3
  has_na     n pct_na
  &lt;lgl&gt;  &lt;int&gt;  &lt;dbl&gt;
1 FALSE   2726   81.8
2 TRUE     605   18.2</code></pre>
</div>
</div>
<p>We see that only <em>~18%</em> of the time series have missing data.</p>
</section>
<section id="keep-only-complete-series" class="level3" data-number="6.4.3">
<h3 data-number="6.4.3" class="anchored" data-anchor-id="keep-only-complete-series"><span class="header-section-number">6.4.3</span> Keep only complete series</h3>
<p>Let’s take only the data with non-missing values.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a>ts_wws_2 <span class="ot">&lt;-</span></span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>  ts_wws <span class="sc">%&gt;%</span> </span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by_key</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reframe</span>(<span class="at">n_na =</span> <span class="fu">sum</span>(<span class="fu">is.na</span>(weekly_sales))) <span class="sc">%&gt;%</span></span>
<span id="cb150-5"><a href="#cb150-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n_na <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb150-6"><a href="#cb150-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>n_na) <span class="sc">%&gt;%</span></span>
<span id="cb150-7"><a href="#cb150-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(ts_wws) <span class="sc">%&gt;%</span></span>
<span id="cb150-8"><a href="#cb150-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tsibble</span>(<span class="at">index =</span> yweek, <span class="at">key =</span> <span class="fu">c</span>(store, dept))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Example: one store, several departments:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a>ts_wws_2 <span class="sc">%&gt;%</span></span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(store <span class="sc">==</span> <span class="dv">2</span>,</span>
<span id="cb151-3"><a href="#cb151-3" aria-hidden="true" tabindex="-1"></a>         dept <span class="sc">&lt;=</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb151-4"><a href="#cb151-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model</span>(<span class="fu">STL</span>(weekly_sales <span class="sc">~</span> <span class="fu">trend</span>() <span class="sc">+</span> <span class="fu">season</span>(), <span class="at">robust =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb151-5"><a href="#cb151-5" aria-hidden="true" tabindex="-1"></a>  components <span class="sc">%&gt;%</span></span>
<span id="cb151-6"><a href="#cb151-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/exple-1-store-few-dept-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Let’s check dept 3 for the same store:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a>ts_wws_2 <span class="sc">%&gt;%</span></span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(store <span class="sc">==</span> <span class="dv">2</span>,</span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a>         dept <span class="sc">==</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb152-4"><a href="#cb152-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model</span>(<span class="fu">STL</span>(weekly_sales <span class="sc">~</span> <span class="fu">trend</span>() <span class="sc">+</span> <span class="fu">season</span>(), <span class="at">robust =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb152-5"><a href="#cb152-5" aria-hidden="true" tabindex="-1"></a>  components <span class="sc">%&gt;%</span></span>
<span id="cb152-6"><a href="#cb152-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/exple-1-store-1-dept-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Let’s check all the stores for dept 3:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a>ts_wws_2 <span class="sc">%&gt;%</span></span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(dept <span class="sc">==</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb153-3"><a href="#cb153-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(store) <span class="sc">%&gt;%</span></span>
<span id="cb153-4"><a href="#cb153-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reframe</span>(<span class="at">n_na =</span> <span class="fu">sum</span>(<span class="fu">is.na</span>(weekly_sales))) <span class="sc">%&gt;%</span></span>
<span id="cb153-5"><a href="#cb153-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n_na <span class="sc">==</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 45 × 2
   store  n_na
   &lt;dbl&gt; &lt;int&gt;
 1     1     0
 2     2     0
 3     3     0
 4     4     0
 5     5     0
 6     6     0
 7     7     0
 8     8     0
 9     9     0
10    10     0
# ℹ 35 more rows</code></pre>
</div>
</div>
<p>Aggregate all stores by department:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a>ts_wws_3 <span class="ot">&lt;-</span></span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a>  df_wws <span class="sc">%&gt;%</span></span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(dept, date) <span class="sc">%&gt;%</span></span>
<span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reframe</span>(<span class="at">weekly_sales =</span> <span class="fu">sum</span>(weekly_sales)) <span class="sc">%&gt;%</span></span>
<span id="cb155-5"><a href="#cb155-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">yweek =</span> <span class="fu">yearweek</span>(date)) <span class="sc">%&gt;%</span></span>
<span id="cb155-6"><a href="#cb155-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tsibble</span>(<span class="at">index =</span> yweek,</span>
<span id="cb155-7"><a href="#cb155-7" aria-hidden="true" tabindex="-1"></a>          <span class="at">key =</span> dept)</span>
<span id="cb155-8"><a href="#cb155-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-9"><a href="#cb155-9" aria-hidden="true" tabindex="-1"></a>ts_wws_3 <span class="sc">%&gt;%</span></span>
<span id="cb155-10"><a href="#cb155-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(dept <span class="sc">==</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb155-11"><a href="#cb155-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model</span>(<span class="fu">STL</span>(weekly_sales <span class="sc">~</span> <span class="fu">trend</span>() <span class="sc">+</span> <span class="fu">season</span>(), <span class="at">robust =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb155-12"><a href="#cb155-12" aria-hidden="true" tabindex="-1"></a>  components <span class="sc">%&gt;%</span></span>
<span id="cb155-13"><a href="#cb155-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/aggregation-of-stores-by-dept-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="stl-feature-extraction" class="level2" data-number="6.5">
<h2 data-number="6.5" class="anchored" data-anchor-id="stl-feature-extraction"><span class="header-section-number">6.5</span> STL feature extraction</h2>
<p><code>feasts</code> ships dozens of summary statistics, many derived from an STL decomposition.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a>ts_ts2 <span class="sc">%&gt;%</span> <span class="fu">features</span>(<span class="at">.var =</span> y_2, <span class="at">features =</span> <span class="fu">list</span>(<span class="at">mean =</span> mean, <span class="at">med =</span> median, <span class="at">min =</span> min, <span class="at">max =</span> max))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 4
   mean   med   min   max
  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1  5.74  5.10  1.21  20.3</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a>ts_ts2 <span class="sc">%&gt;%</span> <span class="fu">features</span>(<span class="at">.var =</span> y_2, quantile)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 5
   `0%` `25%` `50%` `75%` `100%`
  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
1  1.21  3.75  5.10  7.09   20.3</code></pre>
</div>
</div>
<p>STL-specific features:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a>ts_ts2 <span class="sc">%&gt;%</span> <span class="fu">features</span>(<span class="at">.var =</span> y_2, <span class="at">features =</span> <span class="fu">feature_set</span>(<span class="at">tags =</span> <span class="st">"stl"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 9
  trend_strength seasonal_strength_week seasonal_peak_week seasonal_trough_week
           &lt;dbl&gt;                  &lt;dbl&gt;              &lt;dbl&gt;                &lt;dbl&gt;
1          0.783                  0.199                  5                    3
# ℹ 5 more variables: spikiness &lt;dbl&gt;, linearity &lt;dbl&gt;, curvature &lt;dbl&gt;,
#   stl_e_acf1 &lt;dbl&gt;, stl_e_acf10 &lt;dbl&gt;</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a>ts_wws <span class="sc">%&gt;%</span> <span class="fu">features</span>(<span class="at">.var =</span> weekly_sales, <span class="at">features =</span> feat_stl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,331 × 11
   store  dept trend_strength seasonal_strength_year seasonal_peak_year
   &lt;dbl&gt; &lt;dbl&gt;          &lt;dbl&gt;                  &lt;dbl&gt;              &lt;dbl&gt;
 1     1     1       0.000670                  0.786                 47
 2     1     2       0.191                     0.868                 47
 3     1     3       0.0614                    0.927                 30
 4     1     4       0.458                     0.881                 47
 5     1     5       0.0370                    0.907                 43
 6     1     6       0.243                     0.925                 47
 7     1     7       0.127                     0.954                 47
 8     1     8       0.756                     0.806                 47
 9     1     9       0.450                     0.928                 40
10     1    10       0.233                     0.712                  5
# ℹ 3,321 more rows
# ℹ 6 more variables: seasonal_trough_year &lt;dbl&gt;, spikiness &lt;dbl&gt;,
#   linearity &lt;dbl&gt;, curvature &lt;dbl&gt;, stl_e_acf1 &lt;dbl&gt;, stl_e_acf10 &lt;dbl&gt;</code></pre>
</div>
</div>
<p>Let’s focus on trend strength for example (see a description in the chapter <a href="https://otexts.com/fpp3/stlfeatures.html">STL features</a>). Let’s re-arrange the data frame with the higher trend strength on top.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb164"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a>ts_wws_3 <span class="sc">%&gt;%</span> <span class="fu">features</span>(<span class="at">.var =</span> weekly_sales, <span class="at">features =</span> feat_stl) <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(<span class="fu">desc</span>(trend_strength))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 81 × 10
    dept trend_strength seasonal_strength_year seasonal_peak_year
   &lt;dbl&gt;          &lt;dbl&gt;                  &lt;dbl&gt;              &lt;dbl&gt;
 1    54          0.932                  0.667                 47
 2    87          0.921                  0.888                 47
 3    51          0.868                  0.533                 47
 4    92          0.813                  0.939                 47
 5    48          0.784                  0.830                 47
 6    90          0.773                  0.896                 47
 7    96          0.760                  0.939                 23
 8    30          0.757                  0.950                 18
 9    28          0.740                  0.979                 47
10    85          0.690                  0.976                 47
# ℹ 71 more rows
# ℹ 6 more variables: seasonal_trough_year &lt;dbl&gt;, spikiness &lt;dbl&gt;,
#   linearity &lt;dbl&gt;, curvature &lt;dbl&gt;, stl_e_acf1 &lt;dbl&gt;, stl_e_acf10 &lt;dbl&gt;</code></pre>
</div>
</div>
<p>Plot a department with high trend strength:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb166"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a>ts_wws_3 <span class="sc">%&gt;%</span></span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(dept <span class="sc">==</span> <span class="dv">87</span>) <span class="sc">%&gt;%</span></span>
<span id="cb166-3"><a href="#cb166-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model</span>(<span class="fu">STL</span>(weekly_sales <span class="sc">~</span> <span class="fu">trend</span>() <span class="sc">+</span> <span class="fu">season</span>(), <span class="at">robust =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb166-4"><a href="#cb166-4" aria-hidden="true" tabindex="-1"></a>  components <span class="sc">%&gt;%</span></span>
<span id="cb166-5"><a href="#cb166-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/exple-dept-high-trend-strength-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="python-implementation" class="level2" data-number="6.6">
<h2 data-number="6.6" class="anchored" data-anchor-id="python-implementation"><span class="header-section-number">6.6</span> Python implementation</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb167"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb167-2"><a href="#cb167-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsmodels.tsa.seasonal <span class="im">import</span> STL</span>
<span id="cb167-3"><a href="#cb167-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-4"><a href="#cb167-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Load synthetic data (same TSV)</span></span>
<span id="cb167-5"><a href="#cb167-5" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">"data/synthetic_TS_02.tsv"</span>, sep<span class="op">=</span><span class="st">"</span><span class="ch">\t</span><span class="st">"</span>, parse_dates<span class="op">=</span>[<span class="st">"day"</span>])</span>
<span id="cb167-6"><a href="#cb167-6" aria-hidden="true" tabindex="-1"></a>ts <span class="op">=</span> df.set_index(<span class="st">"day"</span>)[<span class="st">"y_2"</span>]</span>
<span id="cb167-7"><a href="#cb167-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-8"><a href="#cb167-8" aria-hidden="true" tabindex="-1"></a><span class="co"># STL (period = 365)</span></span>
<span id="cb167-9"><a href="#cb167-9" aria-hidden="true" tabindex="-1"></a>stl <span class="op">=</span> STL(ts, period<span class="op">=</span><span class="dv">365</span>, robust<span class="op">=</span><span class="va">True</span>).fit()</span>
<span id="cb167-10"><a href="#cb167-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-11"><a href="#cb167-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb167-12"><a href="#cb167-12" aria-hidden="true" tabindex="-1"></a>stl.plot()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-58-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="homework" class="level2" data-number="6.7">
<h2 data-number="6.7" class="anchored" data-anchor-id="homework"><span class="header-section-number">6.7</span> Homework</h2>
<div id="imp-hwk1" class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important&nbsp;1: To do at home
</div>
</div>
<div class="callout-body-container callout-body">
<p>Review the Time Series Analysis we have seen so far and read the Time Series chapters (1-4) of <a href="https://otexts.com/fpp3/">Forecasting: Principles and Practice (3rd ed.)</a> (or another book you might like better).</p>
</div>
</div>
<div id="imp-hwk2" class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important&nbsp;2: To do at home (will be checked directly in class and in the quiz)
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Download the “Supply Chain” Time Series data from Moodle on your laptop.</li>
<li>Look for some Time Series Analysis packages, in Python or R (there are several), choose one, and install it on your laptop. You should also have a library that does smoothing, including LOESS, for “manual” analysis.</li>
<li>Analyze the Time Series with the library tools in a notebook. For the analysis, you can get inspired by this notebook, and go beyond (ask new questions and try to answer them, find new problems and try to solve them, …).</li>
<li>Prepare to present you analysis insights on your notebook in class.</li>
</ol>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb168"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set data directory</span></span>
<span id="cb168-2"><a href="#cb168-2" aria-hidden="true" tabindex="-1"></a>data_dir <span class="ot">&lt;-</span> <span class="st">"data/Walmart"</span></span>
<span id="cb168-3"><a href="#cb168-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4"><a href="#cb168-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Load Walmart data</span></span>
<span id="cb168-5"><a href="#cb168-5" aria-hidden="true" tabindex="-1"></a>fpath_wws <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{data_dir}/train.csv"</span>)</span>
<span id="cb168-6"><a href="#cb168-6" aria-hidden="true" tabindex="-1"></a>df_wws_raw <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(fpath_wws, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb168-7"><a href="#cb168-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-8"><a href="#cb168-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Pretty print summary</span></span>
<span id="cb168-9"><a href="#cb168-9" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"</span></span>
<span id="cb168-10"><a href="#cb168-10" aria-hidden="true" tabindex="-1"></a><span class="st">=== WALMART DATA LOADED ===</span></span>
<span id="cb168-11"><a href="#cb168-11" aria-hidden="true" tabindex="-1"></a><span class="st">Dimensions: {nrow(df_wws_raw)} rows × {ncol(df_wws_raw)} columns</span></span>
<span id="cb168-12"><a href="#cb168-12" aria-hidden="true" tabindex="-1"></a><span class="st">Date range: {min(df_wws_raw$date)} to {max(df_wws_raw$date)}</span></span>
<span id="cb168-13"><a href="#cb168-13" aria-hidden="true" tabindex="-1"></a><span class="st">Stores: {length(unique(df_wws_raw$Store))}</span></span>
<span id="cb168-14"><a href="#cb168-14" aria-hidden="true" tabindex="-1"></a><span class="st">Departments: {length(unique(df_wws_raw$Dept))}</span></span>
<span id="cb168-15"><a href="#cb168-15" aria-hidden="true" tabindex="-1"></a><span class="sc">\n</span><span class="st">"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>=== WALMART DATA LOADED ===
Dimensions: 421570 rows × 5 columns
Date range: Inf to -Inf
Stores: 45
Departments: 81</code></pre>
</div>
</div>
<section id="exploratory-data-analysis" class="level3" data-number="6.7.1">
<h3 data-number="6.7.1" class="anchored" data-anchor-id="exploratory-data-analysis"><span class="header-section-number">6.7.1</span> Exploratory Data Analysis</h3>
<section id="data-preparation" class="level4" data-number="6.7.1.1">
<h4 data-number="6.7.1.1" class="anchored" data-anchor-id="data-preparation"><span class="header-section-number">6.7.1.1</span> Data Preparation</h4>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb170"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Clean and prepare data</span></span>
<span id="cb170-2"><a href="#cb170-2" aria-hidden="true" tabindex="-1"></a>df_wws <span class="ot">&lt;-</span> df_wws_raw <span class="sc">%&gt;%</span></span>
<span id="cb170-3"><a href="#cb170-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_with</span>(tolower) <span class="sc">%&gt;%</span></span>
<span id="cb170-4"><a href="#cb170-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(</span>
<span id="cb170-5"><a href="#cb170-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">store =</span> store,</span>
<span id="cb170-6"><a href="#cb170-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">dept =</span> dept,</span>
<span id="cb170-7"><a href="#cb170-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">weekly_sales =</span> weekly_sales,</span>
<span id="cb170-8"><a href="#cb170-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_holiday =</span> isholiday,</span>
<span id="cb170-9"><a href="#cb170-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">date =</span> date</span>
<span id="cb170-10"><a href="#cb170-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb170-11"><a href="#cb170-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb170-12"><a href="#cb170-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_holiday =</span> <span class="fu">as.logical</span>(is_holiday),</span>
<span id="cb170-13"><a href="#cb170-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">date =</span> <span class="fu">as_date</span>(date),</span>
<span id="cb170-14"><a href="#cb170-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">year =</span> <span class="fu">year</span>(date),</span>
<span id="cb170-15"><a href="#cb170-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">month =</span> <span class="fu">month</span>(date),</span>
<span id="cb170-16"><a href="#cb170-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">week_of_year =</span> <span class="fu">week</span>(date)</span>
<span id="cb170-17"><a href="#cb170-17" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb170-18"><a href="#cb170-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(date, store, dept)</span>
<span id="cb170-19"><a href="#cb170-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-20"><a href="#cb170-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Create tsibble</span></span>
<span id="cb170-21"><a href="#cb170-21" aria-hidden="true" tabindex="-1"></a>ts_wws <span class="ot">&lt;-</span> df_wws <span class="sc">%&gt;%</span></span>
<span id="cb170-22"><a href="#cb170-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">yweek =</span> <span class="fu">yearweek</span>(date)) <span class="sc">%&gt;%</span></span>
<span id="cb170-23"><a href="#cb170-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tsibble</span>(<span class="at">index =</span> yweek, <span class="at">key =</span> <span class="fu">c</span>(store, dept))</span>
<span id="cb170-24"><a href="#cb170-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-25"><a href="#cb170-25" aria-hidden="true" tabindex="-1"></a>gap_info <span class="ot">&lt;-</span> ts_wws <span class="sc">%&gt;%</span> <span class="fu">has_gaps</span>()</span>
<span id="cb170-26"><a href="#cb170-26" aria-hidden="true" tabindex="-1"></a>n_with_gaps <span class="ot">&lt;-</span> <span class="fu">sum</span>(gap_info<span class="sc">$</span>.gaps)</span>
<span id="cb170-27"><a href="#cb170-27" aria-hidden="true" tabindex="-1"></a>n_total <span class="ot">&lt;-</span> <span class="fu">nrow</span>(gap_info)</span>
<span id="cb170-28"><a href="#cb170-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-29"><a href="#cb170-29" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"</span></span>
<span id="cb170-30"><a href="#cb170-30" aria-hidden="true" tabindex="-1"></a><span class="st">=== GAP ANALYSIS ===</span></span>
<span id="cb170-31"><a href="#cb170-31" aria-hidden="true" tabindex="-1"></a><span class="st">Total (store, dept) series: {n_total}</span></span>
<span id="cb170-32"><a href="#cb170-32" aria-hidden="true" tabindex="-1"></a><span class="st">Series with at least one missing week: {n_with_gaps}</span></span>
<span id="cb170-33"><a href="#cb170-33" aria-hidden="true" tabindex="-1"></a><span class="st">Percentage with gaps: {round(100 * n_with_gaps / n_total, 2)}%</span></span>
<span id="cb170-34"><a href="#cb170-34" aria-hidden="true" tabindex="-1"></a><span class="sc">\n</span><span class="st">"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>=== GAP ANALYSIS ===
Total (store, dept) series: 3331
Series with at least one missing week: 605
Percentage with gaps: 18.16%</code></pre>
</div>
</div>
</section>
<section id="basic-descriptive-statistics" class="level4" data-number="6.7.1.2">
<h4 data-number="6.7.1.2" class="anchored" data-anchor-id="basic-descriptive-statistics"><span class="header-section-number">6.7.1.2</span> Basic Descriptive Statistics</h4>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb172"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Overall summary</span></span>
<span id="cb172-2"><a href="#cb172-2" aria-hidden="true" tabindex="-1"></a>summary_stats <span class="ot">&lt;-</span> df_wws <span class="sc">%&gt;%</span></span>
<span id="cb172-3"><a href="#cb172-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb172-4"><a href="#cb172-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_obs =</span> <span class="fu">n</span>(),</span>
<span id="cb172-5"><a href="#cb172-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_stores =</span> <span class="fu">n_distinct</span>(store),</span>
<span id="cb172-6"><a href="#cb172-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_depts =</span> <span class="fu">n_distinct</span>(dept),</span>
<span id="cb172-7"><a href="#cb172-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">date_range =</span> <span class="fu">paste</span>(<span class="fu">min</span>(date), <span class="st">"to"</span>, <span class="fu">max</span>(date)),</span>
<span id="cb172-8"><a href="#cb172-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">sales_mean =</span> <span class="fu">mean</span>(weekly_sales, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb172-9"><a href="#cb172-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">sales_median =</span> <span class="fu">median</span>(weekly_sales, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb172-10"><a href="#cb172-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">sales_sd =</span> <span class="fu">sd</span>(weekly_sales, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb172-11"><a href="#cb172-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_holidays =</span> <span class="fu">mean</span>(is_holiday) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb172-12"><a href="#cb172-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb172-13"><a href="#cb172-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-14"><a href="#cb172-14" aria-hidden="true" tabindex="-1"></a>summary_stats</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 8
   n_obs n_stores n_depts date_range            sales_mean sales_median sales_sd
   &lt;int&gt;    &lt;int&gt;   &lt;int&gt; &lt;chr&gt;                      &lt;dbl&gt;        &lt;dbl&gt;    &lt;dbl&gt;
1 421570       45      81 2010-02-05 to 2012-1…     15981.        7612.   22711.
# ℹ 1 more variable: pct_holidays &lt;dbl&gt;</code></pre>
</div>
</div>
</section>
<section id="sales-distribution-by-store-type" class="level4" data-number="6.7.1.3">
<h4 data-number="6.7.1.3" class="anchored" data-anchor-id="sales-distribution-by-store-type"><span class="header-section-number">6.7.1.3</span> Sales Distribution by Store Type</h4>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb174"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Top 10 stores by total sales</span></span>
<span id="cb174-2"><a href="#cb174-2" aria-hidden="true" tabindex="-1"></a>top_stores <span class="ot">&lt;-</span> df_wws <span class="sc">%&gt;%</span></span>
<span id="cb174-3"><a href="#cb174-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(store) <span class="sc">%&gt;%</span></span>
<span id="cb174-4"><a href="#cb174-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_sales =</span> <span class="fu">sum</span>(weekly_sales, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb174-5"><a href="#cb174-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(total_sales)) <span class="sc">%&gt;%</span></span>
<span id="cb174-6"><a href="#cb174-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">10</span>)</span>
<span id="cb174-7"><a href="#cb174-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-8"><a href="#cb174-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot sales distribution</span></span>
<span id="cb174-9"><a href="#cb174-9" aria-hidden="true" tabindex="-1"></a>df_wws <span class="sc">%&gt;%</span></span>
<span id="cb174-10"><a href="#cb174-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(store) <span class="sc">%&gt;%</span></span>
<span id="cb174-11"><a href="#cb174-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb174-12"><a href="#cb174-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_sales =</span> <span class="fu">mean</span>(weekly_sales, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb174-13"><a href="#cb174-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_sales =</span> <span class="fu">sum</span>(weekly_sales, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb174-14"><a href="#cb174-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_weeks =</span> <span class="fu">n</span>(),</span>
<span id="cb174-15"><a href="#cb174-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb174-16"><a href="#cb174-16" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb174-17"><a href="#cb174-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(store, total_sales), <span class="at">y =</span> total_sales <span class="sc">/</span> <span class="fl">1e6</span>)) <span class="sc">+</span></span>
<span id="cb174-18"><a href="#cb174-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">fill =</span> <span class="st">"steelblue"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb174-19"><a href="#cb174-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb174-20"><a href="#cb174-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb174-21"><a href="#cb174-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Total Sales by Store (Millions USD)"</span>,</span>
<span id="cb174-22"><a href="#cb174-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Store ID"</span>,</span>
<span id="cb174-23"><a href="#cb174-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Total Sales (M USD)"</span></span>
<span id="cb174-24"><a href="#cb174-24" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb174-25"><a href="#cb174-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> <span class="fu">dollar_format</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-62-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="holiday-impact-analysis" class="level4" data-number="6.7.1.4">
<h4 data-number="6.7.1.4" class="anchored" data-anchor-id="holiday-impact-analysis"><span class="header-section-number">6.7.1.4</span> Holiday Impact Analysis</h4>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb175"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Holiday effect</span></span>
<span id="cb175-2"><a href="#cb175-2" aria-hidden="true" tabindex="-1"></a>holiday_effect <span class="ot">&lt;-</span> df_wws <span class="sc">%&gt;%</span></span>
<span id="cb175-3"><a href="#cb175-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(is_holiday) <span class="sc">%&gt;%</span></span>
<span id="cb175-4"><a href="#cb175-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb175-5"><a href="#cb175-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_sales =</span> <span class="fu">mean</span>(weekly_sales, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb175-6"><a href="#cb175-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">median_sales =</span> <span class="fu">median</span>(weekly_sales, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb175-7"><a href="#cb175-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_obs =</span> <span class="fu">n</span>(),</span>
<span id="cb175-8"><a href="#cb175-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb175-9"><a href="#cb175-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb175-10"><a href="#cb175-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-11"><a href="#cb175-11" aria-hidden="true" tabindex="-1"></a>holiday_effect <span class="sc">%&gt;%</span></span>
<span id="cb175-12"><a href="#cb175-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb175-13"><a href="#cb175-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">holiday_label =</span> <span class="fu">ifelse</span>(is_holiday, <span class="st">"Holiday Week"</span>, <span class="st">"Regular Week"</span>),</span>
<span id="cb175-14"><a href="#cb175-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">sales_increase_pct =</span> (mean_sales <span class="sc">/</span> <span class="fu">lag</span>(mean_sales) <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb175-15"><a href="#cb175-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb175-16"><a href="#cb175-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(holiday_label, mean_sales, sales_increase_pct)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 3
  holiday_label mean_sales sales_increase_pct
  &lt;chr&gt;              &lt;dbl&gt;              &lt;dbl&gt;
1 Regular Week      15901.              NA   
2 Holiday Week      17036.               7.13</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb177"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize holiday impact</span></span>
<span id="cb177-2"><a href="#cb177-2" aria-hidden="true" tabindex="-1"></a>df_wws <span class="sc">%&gt;%</span></span>
<span id="cb177-3"><a href="#cb177-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(date, is_holiday) <span class="sc">%&gt;%</span></span>
<span id="cb177-4"><a href="#cb177-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean_sales_all =</span> <span class="fu">mean</span>(weekly_sales, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb177-5"><a href="#cb177-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> mean_sales_all, <span class="at">color =</span> is_holiday)) <span class="sc">+</span></span>
<span id="cb177-6"><a href="#cb177-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb177-7"><a href="#cb177-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> . <span class="sc">%&gt;%</span> <span class="fu">filter</span>(is_holiday), <span class="at">size =</span> <span class="dv">2</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb177-8"><a href="#cb177-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb177-9"><a href="#cb177-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Average Weekly Sales Across All Stores"</span>,</span>
<span id="cb177-10"><a href="#cb177-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Red dots indicate holiday weeks"</span>,</span>
<span id="cb177-11"><a href="#cb177-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb177-12"><a href="#cb177-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Average Weekly Sales (USD)"</span>,</span>
<span id="cb177-13"><a href="#cb177-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Holiday Week"</span></span>
<span id="cb177-14"><a href="#cb177-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb177-15"><a href="#cb177-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> <span class="fu">dollar_format</span>()) <span class="sc">+</span></span>
<span id="cb177-16"><a href="#cb177-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-63-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="stl-decomposition-analysis" class="level3" data-number="6.7.2">
<h3 data-number="6.7.2" class="anchored" data-anchor-id="stl-decomposition-analysis"><span class="header-section-number">6.7.2</span> STL Decomposition Analysis</h3>
<section id="handling-missing-values" class="level4" data-number="6.7.2.1">
<h4 data-number="6.7.2.1" class="anchored" data-anchor-id="handling-missing-values"><span class="header-section-number">6.7.2.1</span> Handling Missing Values</h4>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb178"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Analyze missing values</span></span>
<span id="cb178-2"><a href="#cb178-2" aria-hidden="true" tabindex="-1"></a>na_analysis <span class="ot">&lt;-</span> ts_wws <span class="sc">%&gt;%</span></span>
<span id="cb178-3"><a href="#cb178-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(store, dept) <span class="sc">%&gt;%</span></span>
<span id="cb178-4"><a href="#cb178-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb178-5"><a href="#cb178-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_missing =</span> <span class="fu">sum</span>(<span class="fu">is.na</span>(weekly_sales)),</span>
<span id="cb178-6"><a href="#cb178-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_total =</span> <span class="fu">n</span>(),</span>
<span id="cb178-7"><a href="#cb178-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_missing =</span> n_missing <span class="sc">/</span> n_total <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb178-8"><a href="#cb178-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb178-9"><a href="#cb178-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb178-10"><a href="#cb178-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-11"><a href="#cb178-11" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Series with missing values:"</span>, <span class="fu">sum</span>(na_analysis<span class="sc">$</span>pct_missing <span class="sc">&gt;</span> <span class="dv">0</span>), <span class="st">"out of"</span>, <span class="fu">nrow</span>(na_analysis), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Series with missing values: 0 out of 421570 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb180"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Average missing percentage:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(na_analysis<span class="sc">$</span>pct_missing[na_analysis<span class="sc">$</span>pct_missing <span class="sc">&gt;</span> <span class="dv">0</span>]), <span class="dv">2</span>), <span class="st">"%</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Average missing percentage: NaN %</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb182"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create complete dataset (fill gaps with NA, then filter complete series)</span></span>
<span id="cb182-2"><a href="#cb182-2" aria-hidden="true" tabindex="-1"></a>ts_wws_complete <span class="ot">&lt;-</span> ts_wws <span class="sc">%&gt;%</span></span>
<span id="cb182-3"><a href="#cb182-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fill_gaps</span>(<span class="at">.full =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb182-4"><a href="#cb182-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(store, dept) <span class="sc">%&gt;%</span></span>
<span id="cb182-5"><a href="#cb182-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">sum</span>(<span class="fu">is.na</span>(weekly_sales)) <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb182-6"><a href="#cb182-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb182-7"><a href="#cb182-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-8"><a href="#cb182-8" aria-hidden="true" tabindex="-1"></a>n_complete <span class="ot">&lt;-</span> ts_wws_complete <span class="sc">%&gt;%</span></span>
<span id="cb182-9"><a href="#cb182-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(store, dept) <span class="sc">%&gt;%</span></span>
<span id="cb182-10"><a href="#cb182-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nrow</span>()</span>
<span id="cb182-11"><a href="#cb182-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-12"><a href="#cb182-12" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"Complete series retained: {n_complete}</span><span class="sc">\n</span><span class="st">"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Complete series retained: 2660</code></pre>
</div>
</div>
</section>
<section id="single-series-stl-decomposition" class="level4" data-number="6.7.2.2">
<h4 data-number="6.7.2.2" class="anchored" data-anchor-id="single-series-stl-decomposition"><span class="header-section-number">6.7.2.2</span> Single Series STL Decomposition</h4>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb184"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Select a representative store-department combination (Store 1, Dept 1)</span></span>
<span id="cb184-2"><a href="#cb184-2" aria-hidden="true" tabindex="-1"></a>single_series <span class="ot">&lt;-</span> ts_wws_complete <span class="sc">%&gt;%</span></span>
<span id="cb184-3"><a href="#cb184-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(store <span class="sc">==</span> <span class="dv">1</span>, dept <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb184-4"><a href="#cb184-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-5"><a href="#cb184-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply STL decomposition</span></span>
<span id="cb184-6"><a href="#cb184-6" aria-hidden="true" tabindex="-1"></a>stl_single <span class="ot">&lt;-</span> single_series <span class="sc">%&gt;%</span></span>
<span id="cb184-7"><a href="#cb184-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model</span>(</span>
<span id="cb184-8"><a href="#cb184-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">STL</span>(weekly_sales <span class="sc">~</span> <span class="fu">trend</span>(<span class="at">window =</span> <span class="dv">21</span>, <span class="at">degree =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb184-9"><a href="#cb184-9" aria-hidden="true" tabindex="-1"></a>              <span class="fu">season</span>(<span class="at">period =</span> <span class="dv">52</span>, <span class="at">window =</span> <span class="dv">13</span>, <span class="at">degree =</span> <span class="dv">1</span>),</span>
<span id="cb184-10"><a href="#cb184-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">robust =</span> <span class="cn">TRUE</span>)</span>
<span id="cb184-11"><a href="#cb184-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb184-12"><a href="#cb184-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">components</span>()</span>
<span id="cb184-13"><a href="#cb184-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-14"><a href="#cb184-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot decomposition</span></span>
<span id="cb184-15"><a href="#cb184-15" aria-hidden="true" tabindex="-1"></a>stl_single <span class="sc">%&gt;%</span></span>
<span id="cb184-16"><a href="#cb184-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>() <span class="sc">+</span></span>
<span id="cb184-17"><a href="#cb184-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb184-18"><a href="#cb184-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"STL Decomposition: Store 1, Department 1"</span>,</span>
<span id="cb184-19"><a href="#cb184-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Weekly Sales with Trend, Seasonal, and Remainder Components"</span></span>
<span id="cb184-20"><a href="#cb184-20" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb184-21"><a href="#cb184-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-65-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="multiple-series-comparison" class="level4" data-number="6.7.2.3">
<h4 data-number="6.7.2.3" class="anchored" data-anchor-id="multiple-series-comparison"><span class="header-section-number">6.7.2.3</span> Multiple Series Comparison</h4>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb185"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare multiple departments in Store 1</span></span>
<span id="cb185-2"><a href="#cb185-2" aria-hidden="true" tabindex="-1"></a>store1_depts <span class="ot">&lt;-</span> ts_wws_complete <span class="sc">%&gt;%</span></span>
<span id="cb185-3"><a href="#cb185-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(store <span class="sc">==</span> <span class="dv">1</span>, dept <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">10</span>))</span>
<span id="cb185-4"><a href="#cb185-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-5"><a href="#cb185-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply STL to multiple series</span></span>
<span id="cb185-6"><a href="#cb185-6" aria-hidden="true" tabindex="-1"></a>stl_multiple <span class="ot">&lt;-</span> store1_depts <span class="sc">%&gt;%</span></span>
<span id="cb185-7"><a href="#cb185-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model</span>(<span class="fu">STL</span>(weekly_sales <span class="sc">~</span> <span class="fu">trend</span>() <span class="sc">+</span> <span class="fu">season</span>(), <span class="at">robust =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb185-8"><a href="#cb185-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">components</span>()</span>
<span id="cb185-9"><a href="#cb185-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-10"><a href="#cb185-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize</span></span>
<span id="cb185-11"><a href="#cb185-11" aria-hidden="true" tabindex="-1"></a>stl_multiple <span class="sc">%&gt;%</span></span>
<span id="cb185-12"><a href="#cb185-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>() <span class="sc">+</span></span>
<span id="cb185-13"><a href="#cb185-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> dept, <span class="at">scales =</span> <span class="st">"free_y"</span>, <span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb185-14"><a href="#cb185-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb185-15"><a href="#cb185-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"STL Decomposition: Store 1, Multiple Departments"</span>,</span>
<span id="cb185-16"><a href="#cb185-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Comparing trend and seasonal patterns across departments"</span></span>
<span id="cb185-17"><a href="#cb185-17" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb185-18"><a href="#cb185-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-66-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="aggregated-analysis-by-department" class="level4" data-number="6.7.2.4">
<h4 data-number="6.7.2.4" class="anchored" data-anchor-id="aggregated-analysis-by-department"><span class="header-section-number">6.7.2.4</span> Aggregated Analysis by Department</h4>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb186"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Aggregate sales by department across all stores</span></span>
<span id="cb186-2"><a href="#cb186-2" aria-hidden="true" tabindex="-1"></a>ts_dept_agg <span class="ot">&lt;-</span> df_wws <span class="sc">%&gt;%</span></span>
<span id="cb186-3"><a href="#cb186-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(weekly_sales)) <span class="sc">%&gt;%</span></span>
<span id="cb186-4"><a href="#cb186-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(dept, date) <span class="sc">%&gt;%</span></span>
<span id="cb186-5"><a href="#cb186-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb186-6"><a href="#cb186-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">weekly_sales =</span> <span class="fu">sum</span>(weekly_sales),</span>
<span id="cb186-7"><a href="#cb186-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_stores =</span> <span class="fu">n_distinct</span>(store),</span>
<span id="cb186-8"><a href="#cb186-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb186-9"><a href="#cb186-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb186-10"><a href="#cb186-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">yweek =</span> <span class="fu">yearweek</span>(date)) <span class="sc">%&gt;%</span></span>
<span id="cb186-11"><a href="#cb186-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tsibble</span>(<span class="at">index =</span> yweek, <span class="at">key =</span> dept)</span>
<span id="cb186-12"><a href="#cb186-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-13"><a href="#cb186-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Select top departments by total sales</span></span>
<span id="cb186-14"><a href="#cb186-14" aria-hidden="true" tabindex="-1"></a>top_depts <span class="ot">&lt;-</span> ts_dept_agg <span class="sc">%&gt;%</span></span>
<span id="cb186-15"><a href="#cb186-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(dept) <span class="sc">%&gt;%</span></span>
<span id="cb186-16"><a href="#cb186-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_sales =</span> <span class="fu">sum</span>(weekly_sales), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb186-17"><a href="#cb186-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(total_sales, <span class="at">n =</span> <span class="dv">5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb186-18"><a href="#cb186-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(dept)</span>
<span id="cb186-19"><a href="#cb186-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-20"><a href="#cb186-20" aria-hidden="true" tabindex="-1"></a><span class="co"># STL for top departments</span></span>
<span id="cb186-21"><a href="#cb186-21" aria-hidden="true" tabindex="-1"></a>top_dept_stl <span class="ot">&lt;-</span> ts_dept_agg <span class="sc">%&gt;%</span></span>
<span id="cb186-22"><a href="#cb186-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(dept <span class="sc">%in%</span> top_depts) <span class="sc">%&gt;%</span></span>
<span id="cb186-23"><a href="#cb186-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model</span>(<span class="fu">STL</span>(weekly_sales <span class="sc">~</span> <span class="fu">trend</span>() <span class="sc">+</span> <span class="fu">season</span>(<span class="at">period =</span> <span class="dv">52</span>), <span class="at">robust =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb186-24"><a href="#cb186-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">components</span>()</span>
<span id="cb186-25"><a href="#cb186-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-26"><a href="#cb186-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb186-27"><a href="#cb186-27" aria-hidden="true" tabindex="-1"></a>top_dept_stl <span class="sc">%&gt;%</span></span>
<span id="cb186-28"><a href="#cb186-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>() <span class="sc">+</span></span>
<span id="cb186-29"><a href="#cb186-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> dept, <span class="at">scales =</span> <span class="st">"free_y"</span>, <span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb186-30"><a href="#cb186-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb186-31"><a href="#cb186-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"STL Decomposition: Top 5 Departments (Aggregated)"</span>,</span>
<span id="cb186-32"><a href="#cb186-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Department-level sales patterns across all stores"</span></span>
<span id="cb186-33"><a href="#cb186-33" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb186-34"><a href="#cb186-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-67-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="which-departments-show-the-strongest-seasonal-patterns" class="level4" data-number="6.7.2.5">
<h4 data-number="6.7.2.5" class="anchored" data-anchor-id="which-departments-show-the-strongest-seasonal-patterns"><span class="header-section-number">6.7.2.5</span> Which departments show the strongest seasonal patterns?</h4>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb187"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === STL Feature Extraction (Correct Names) ===</span></span>
<span id="cb187-2"><a href="#cb187-2" aria-hidden="true" tabindex="-1"></a>stl_features <span class="ot">&lt;-</span> ts_dept_agg <span class="sc">%&gt;%</span></span>
<span id="cb187-3"><a href="#cb187-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">features</span>(weekly_sales, feat_stl)</span>
<span id="cb187-4"><a href="#cb187-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-5"><a href="#cb187-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Inspect once (uncomment to debug)</span></span>
<span id="cb187-6"><a href="#cb187-6" aria-hidden="true" tabindex="-1"></a>stl_features <span class="sc">%&gt;%</span> <span class="fu">glimpse</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 81
Columns: 10
$ dept                   &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, …
$ trend_strength         &lt;dbl&gt; 0.005592931, 0.303991851, 0.079329994, 0.421525…
$ seasonal_strength_year &lt;dbl&gt; 0.7377809, 0.9299872, 0.9870966, 0.9050760, 0.9…
$ seasonal_peak_year     &lt;dbl&gt; 47, 47, 30, 47, 47, 43, 47, 47, 47, 47, 18, 18,…
$ seasonal_trough_year   &lt;dbl&gt; 49, 48, 21, 0, 17, 50, 50, 48, 0, 0, 34, 48, 48…
$ spikiness              &lt;dbl&gt; 1.285507e+18, 1.939917e+14, 3.246378e+15, 3.021…
$ linearity              &lt;dbl&gt; 64200.987, 184450.888, 72334.920, 185163.640, -…
$ curvature              &lt;dbl&gt; -12335.654, 73010.122, 90895.850, 45702.875, 15…
$ stl_e_acf1             &lt;dbl&gt; 0.29858745, 0.22534639, 0.36252956, -0.20602030…
$ stl_e_acf10            &lt;dbl&gt; 0.28591029, 0.68878752, 0.19397557, 0.25052626,…</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb189"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a>dept_features <span class="ot">&lt;-</span> stl_features <span class="sc">%&gt;%</span></span>
<span id="cb189-2"><a href="#cb189-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(seasonal_strength_year)) <span class="sc">%&gt;%</span></span>
<span id="cb189-3"><a href="#cb189-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">10</span>)</span>
<span id="cb189-4"><a href="#cb189-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-5"><a href="#cb189-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Pretty table</span></span>
<span id="cb189-6"><a href="#cb189-6" aria-hidden="true" tabindex="-1"></a>dept_features <span class="sc">%&gt;%</span></span>
<span id="cb189-7"><a href="#cb189-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(dept, seasonal_strength_year, trend_strength, seasonal_peak_year, seasonal_trough_year) <span class="sc">%&gt;%</span></span>
<span id="cb189-8"><a href="#cb189-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb189-9"><a href="#cb189-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">dept =</span> <span class="fu">glue</span>(<span class="st">"Dept {dept}"</span>),</span>
<span id="cb189-10"><a href="#cb189-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">seasonal_strength_year =</span> <span class="fu">percent</span>(seasonal_strength_year, <span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb189-11"><a href="#cb189-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb189-12"><a href="#cb189-12" aria-hidden="true" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable</span>(</span>
<span id="cb189-13"><a href="#cb189-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Department"</span>, <span class="st">"Seasonal Strength"</span>, <span class="st">"Trend Strength"</span>, <span class="st">"Peak Week"</span>, <span class="st">"Trough Week"</span>),</span>
<span id="cb189-14"><a href="#cb189-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">digits =</span> <span class="dv">3</span></span>
<span id="cb189-15"><a href="#cb189-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb189-16"><a href="#cb189-16" aria-hidden="true" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-striped table-hover caption-top table-sm small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Department</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Seasonal Strength</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Trend Strength</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Peak Week</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Trough Week</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Dept 14</td>
<td style="text-align: left;">98.9%</td>
<td style="text-align: right;">0.271</td>
<td style="text-align: right;">47</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">Dept 27</td>
<td style="text-align: left;">98.7%</td>
<td style="text-align: right;">0.284</td>
<td style="text-align: right;">47</td>
<td style="text-align: right;">24</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Dept 3</td>
<td style="text-align: left;">98.7%</td>
<td style="text-align: right;">0.079</td>
<td style="text-align: right;">30</td>
<td style="text-align: right;">21</td>
</tr>
<tr class="even">
<td style="text-align: left;">Dept 16</td>
<td style="text-align: left;">98.3%</td>
<td style="text-align: right;">0.151</td>
<td style="text-align: right;">18</td>
<td style="text-align: right;">44</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Dept 82</td>
<td style="text-align: left;">98.3%</td>
<td style="text-align: right;">0.656</td>
<td style="text-align: right;">47</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">Dept 72</td>
<td style="text-align: left;">98.3%</td>
<td style="text-align: right;">0.080</td>
<td style="text-align: right;">43</td>
<td style="text-align: right;">17</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Dept 46</td>
<td style="text-align: left;">98.3%</td>
<td style="text-align: right;">0.582</td>
<td style="text-align: right;">47</td>
<td style="text-align: right;">50</td>
</tr>
<tr class="even">
<td style="text-align: left;">Dept 7</td>
<td style="text-align: left;">98.2%</td>
<td style="text-align: right;">0.026</td>
<td style="text-align: right;">47</td>
<td style="text-align: right;">50</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Dept 23</td>
<td style="text-align: left;">98.1%</td>
<td style="text-align: right;">0.200</td>
<td style="text-align: right;">47</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">Dept 28</td>
<td style="text-align: left;">97.9%</td>
<td style="text-align: right;">0.740</td>
<td style="text-align: right;">47</td>
<td style="text-align: right;">23</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="can-we-detect-structural-breaks-in-the-trend-component" class="level4" data-number="6.7.2.6">
<h4 data-number="6.7.2.6" class="anchored" data-anchor-id="can-we-detect-structural-breaks-in-the-trend-component"><span class="header-section-number">6.7.2.6</span> Can we detect structural breaks in the trend component?</h4>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb190"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract trend component and test for breaks</span></span>
<span id="cb190-2"><a href="#cb190-2" aria-hidden="true" tabindex="-1"></a>trend_analysis <span class="ot">&lt;-</span> ts_dept_agg <span class="sc">%&gt;%</span></span>
<span id="cb190-3"><a href="#cb190-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(dept <span class="sc">%in%</span> top_depts) <span class="sc">%&gt;%</span></span>
<span id="cb190-4"><a href="#cb190-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model</span>(<span class="fu">STL</span>(weekly_sales <span class="sc">~</span> <span class="fu">trend</span>(<span class="at">window =</span> <span class="dv">21</span>) <span class="sc">+</span> <span class="fu">season</span>(), <span class="at">robust =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb190-5"><a href="#cb190-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">components</span>() <span class="sc">%&gt;%</span></span>
<span id="cb190-6"><a href="#cb190-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb190-7"><a href="#cb190-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">trend_change =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">diff</span>(trend)),</span>
<span id="cb190-8"><a href="#cb190-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">trend_acceleration =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">diff</span>(trend_change)),</span>
<span id="cb190-9"><a href="#cb190-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">year_quarter =</span> <span class="fu">yearquarter</span>(yweek)</span>
<span id="cb190-10"><a href="#cb190-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb190-11"><a href="#cb190-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-12"><a href="#cb190-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify potential structural breaks (large trend changes)</span></span>
<span id="cb190-13"><a href="#cb190-13" aria-hidden="true" tabindex="-1"></a>trend_breaks <span class="ot">&lt;-</span> trend_analysis <span class="sc">%&gt;%</span></span>
<span id="cb190-14"><a href="#cb190-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(dept) <span class="sc">%&gt;%</span></span>
<span id="cb190-15"><a href="#cb190-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">abs</span>(trend_change) <span class="sc">&gt;</span> <span class="fu">quantile</span>(<span class="fu">abs</span>(trend_change), <span class="fl">0.95</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb190-16"><a href="#cb190-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb190-17"><a href="#cb190-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-18"><a href="#cb190-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize trend with break points</span></span>
<span id="cb190-19"><a href="#cb190-19" aria-hidden="true" tabindex="-1"></a>trend_analysis <span class="sc">%&gt;%</span></span>
<span id="cb190-20"><a href="#cb190-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> yweek, <span class="at">y =</span> trend)) <span class="sc">+</span></span>
<span id="cb190-21"><a href="#cb190-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"steelblue"</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb190-22"><a href="#cb190-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> trend_breaks, </span>
<span id="cb190-23"><a href="#cb190-23" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">color =</span> <span class="st">"Potential Break"</span>), <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb190-24"><a href="#cb190-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> dept, <span class="at">scales =</span> <span class="st">"free_y"</span>, <span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb190-25"><a href="#cb190-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb190-26"><a href="#cb190-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Trend Component with Potential Structural Breaks"</span>,</span>
<span id="cb190-27"><a href="#cb190-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Points indicate weeks with unusually large trend changes"</span>,</span>
<span id="cb190-28"><a href="#cb190-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Year-Week"</span>,</span>
<span id="cb190-29"><a href="#cb190-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Trend Component"</span>,</span>
<span id="cb190-30"><a href="#cb190-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">""</span></span>
<span id="cb190-31"><a href="#cb190-31" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb190-32"><a href="#cb190-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-69-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<!-- -->

</section>
</section>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb191" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb191-2"><a href="#cb191-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Generating Time Series"</span></span>
<span id="cb191-3"><a href="#cb191-3" aria-hidden="true" tabindex="-1"></a><span class="an">editor:</span><span class="co"> source</span></span>
<span id="cb191-4"><a href="#cb191-4" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> Behrouz Delfanian</span></span>
<span id="cb191-5"><a href="#cb191-5" aria-hidden="true" tabindex="-1"></a><span class="an">affiliation:</span><span class="co"> University of Luxembourg</span></span>
<span id="cb191-6"><a href="#cb191-6" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb191-7"><a href="#cb191-7" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb191-8"><a href="#cb191-8" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb191-9"><a href="#cb191-9" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-depth: 3</span></span>
<span id="cb191-10"><a href="#cb191-10" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-location: left</span></span>
<span id="cb191-11"><a href="#cb191-11" aria-hidden="true" tabindex="-1"></a><span class="co">    smooth_scroll: true</span></span>
<span id="cb191-12"><a href="#cb191-12" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb191-13"><a href="#cb191-13" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb191-14"><a href="#cb191-14" aria-hidden="true" tabindex="-1"></a><span class="co">    code-overflow: scroll</span></span>
<span id="cb191-15"><a href="#cb191-15" aria-hidden="true" tabindex="-1"></a><span class="co">    execute:</span></span>
<span id="cb191-16"><a href="#cb191-16" aria-hidden="true" tabindex="-1"></a><span class="co">      enabled: true</span></span>
<span id="cb191-17"><a href="#cb191-17" aria-hidden="true" tabindex="-1"></a><span class="an">engine:</span><span class="co"> knitr</span></span>
<span id="cb191-18"><a href="#cb191-18" aria-hidden="true" tabindex="-1"></a><span class="an">filters:</span></span>
<span id="cb191-19"><a href="#cb191-19" aria-hidden="true" tabindex="-1"></a><span class="co">  - webr</span></span>
<span id="cb191-20"><a href="#cb191-20" aria-hidden="true" tabindex="-1"></a><span class="an">webr:</span></span>
<span id="cb191-21"><a href="#cb191-21" aria-hidden="true" tabindex="-1"></a><span class="co">  show-editor: true</span></span>
<span id="cb191-22"><a href="#cb191-22" aria-hidden="true" tabindex="-1"></a><span class="co">  show-startup-message: false</span></span>
<span id="cb191-23"><a href="#cb191-23" aria-hidden="true" tabindex="-1"></a><span class="co">  autorun: true</span></span>
<span id="cb191-24"><a href="#cb191-24" aria-hidden="true" tabindex="-1"></a><span class="an">resources:</span></span>
<span id="cb191-25"><a href="#cb191-25" aria-hidden="true" tabindex="-1"></a><span class="co">  - webr-worker.js</span></span>
<span id="cb191-26"><a href="#cb191-26" aria-hidden="true" tabindex="-1"></a><span class="co">  - webr-serviceworker.js</span></span>
<span id="cb191-27"><a href="#cb191-27" aria-hidden="true" tabindex="-1"></a><span class="an">number-sections:</span><span class="co"> true</span></span>
<span id="cb191-28"><a href="#cb191-28" aria-hidden="true" tabindex="-1"></a><span class="an">message:</span><span class="co"> false</span></span>
<span id="cb191-29"><a href="#cb191-29" aria-hidden="true" tabindex="-1"></a><span class="an">warning:</span><span class="co"> false</span></span>
<span id="cb191-30"><a href="#cb191-30" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb191-31"><a href="#cb191-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-32"><a href="#cb191-32" aria-hidden="true" tabindex="-1"></a><span class="fu"># R environment setting</span></span>
<span id="cb191-33"><a href="#cb191-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-34"><a href="#cb191-34" aria-hidden="true" tabindex="-1"></a>Installing required libraries</span>
<span id="cb191-35"><a href="#cb191-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-38"><a href="#cb191-38" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-39"><a href="#cb191-39" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: installing_libraries</span></span>
<span id="cb191-40"><a href="#cb191-40" aria-hidden="true" tabindex="-1"></a><span class="co">#| cache: true</span></span>
<span id="cb191-41"><a href="#cb191-41" aria-hidden="true" tabindex="-1"></a><span class="co">#| results: hide</span></span>
<span id="cb191-42"><a href="#cb191-42" aria-hidden="true" tabindex="-1"></a>cran_repo <span class="ot">&lt;-</span> <span class="st">"https://ftp.fau.de/cran"</span></span>
<span id="cb191-43"><a href="#cb191-43" aria-hidden="true" tabindex="-1"></a>list_Rpack2use <span class="ot">&lt;-</span></span>
<span id="cb191-44"><a href="#cb191-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"rmarkdown"</span>,</span>
<span id="cb191-45"><a href="#cb191-45" aria-hidden="true" tabindex="-1"></a>    <span class="st">"conflicted"</span>,</span>
<span id="cb191-46"><a href="#cb191-46" aria-hidden="true" tabindex="-1"></a>    <span class="st">"devtools"</span>,</span>
<span id="cb191-47"><a href="#cb191-47" aria-hidden="true" tabindex="-1"></a>    <span class="st">"knitr"</span>,</span>
<span id="cb191-48"><a href="#cb191-48" aria-hidden="true" tabindex="-1"></a>    <span class="st">"quarto"</span>,</span>
<span id="cb191-49"><a href="#cb191-49" aria-hidden="true" tabindex="-1"></a>    <span class="st">"bookdown"</span>,</span>
<span id="cb191-50"><a href="#cb191-50" aria-hidden="true" tabindex="-1"></a>    <span class="co">#shiny,</span></span>
<span id="cb191-51"><a href="#cb191-51" aria-hidden="true" tabindex="-1"></a>    <span class="st">"DT"</span>,</span>
<span id="cb191-52"><a href="#cb191-52" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Hmisc"</span>,</span>
<span id="cb191-53"><a href="#cb191-53" aria-hidden="true" tabindex="-1"></a>    <span class="st">"tidyverse"</span>,</span>
<span id="cb191-54"><a href="#cb191-54" aria-hidden="true" tabindex="-1"></a>    <span class="st">"magrittr"</span>,</span>
<span id="cb191-55"><a href="#cb191-55" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lubridate"</span>,</span>
<span id="cb191-56"><a href="#cb191-56" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hms"</span>,</span>
<span id="cb191-57"><a href="#cb191-57" aria-hidden="true" tabindex="-1"></a>    <span class="st">"glue"</span>,</span>
<span id="cb191-58"><a href="#cb191-58" aria-hidden="true" tabindex="-1"></a>    <span class="st">"skimr"</span>,</span>
<span id="cb191-59"><a href="#cb191-59" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lobstr"</span>,</span>
<span id="cb191-60"><a href="#cb191-60" aria-hidden="true" tabindex="-1"></a>    <span class="st">"janitor"</span>,</span>
<span id="cb191-61"><a href="#cb191-61" aria-hidden="true" tabindex="-1"></a>    <span class="st">"zeallot"</span>,</span>
<span id="cb191-62"><a href="#cb191-62" aria-hidden="true" tabindex="-1"></a>    <span class="st">"stringi"</span>,</span>
<span id="cb191-63"><a href="#cb191-63" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lemon"</span>,</span>
<span id="cb191-64"><a href="#cb191-64" aria-hidden="true" tabindex="-1"></a>    <span class="st">"crayon"</span>,</span>
<span id="cb191-65"><a href="#cb191-65" aria-hidden="true" tabindex="-1"></a>    <span class="st">"jsonlite"</span>,</span>
<span id="cb191-66"><a href="#cb191-66" aria-hidden="true" tabindex="-1"></a>    <span class="co">#"officer",</span></span>
<span id="cb191-67"><a href="#cb191-67" aria-hidden="true" tabindex="-1"></a>    <span class="st">"TSA"</span>,</span>
<span id="cb191-68"><a href="#cb191-68" aria-hidden="true" tabindex="-1"></a>    <span class="st">"tsibble"</span>,</span>
<span id="cb191-69"><a href="#cb191-69" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fable"</span>,</span>
<span id="cb191-70"><a href="#cb191-70" aria-hidden="true" tabindex="-1"></a>    <span class="st">"feasts"</span>,</span>
<span id="cb191-71"><a href="#cb191-71" aria-hidden="true" tabindex="-1"></a>    <span class="st">"imputeTS"</span>,</span>
<span id="cb191-72"><a href="#cb191-72" aria-hidden="true" tabindex="-1"></a>    <span class="st">"readxl"</span>,</span>
<span id="cb191-73"><a href="#cb191-73" aria-hidden="true" tabindex="-1"></a>    <span class="st">"slider"</span>,</span>
<span id="cb191-74"><a href="#cb191-74" aria-hidden="true" tabindex="-1"></a>    <span class="st">"reticulate"</span>,</span>
<span id="cb191-75"><a href="#cb191-75" aria-hidden="true" tabindex="-1"></a>    <span class="st">"aws.s3"</span>,</span>
<span id="cb191-76"><a href="#cb191-76" aria-hidden="true" tabindex="-1"></a>    <span class="st">"paws"</span>,</span>
<span id="cb191-77"><a href="#cb191-77" aria-hidden="true" tabindex="-1"></a>    <span class="st">"RAthena"</span>,</span>
<span id="cb191-78"><a href="#cb191-78" aria-hidden="true" tabindex="-1"></a>    <span class="st">"botor"</span>,</span>
<span id="cb191-79"><a href="#cb191-79" aria-hidden="true" tabindex="-1"></a>    <span class="st">"RPostgres"</span>,</span>
<span id="cb191-80"><a href="#cb191-80" aria-hidden="true" tabindex="-1"></a>    <span class="st">"DBI"</span>,</span>
<span id="cb191-81"><a href="#cb191-81" aria-hidden="true" tabindex="-1"></a>    <span class="st">"RJDBC"</span>,</span>
<span id="cb191-82"><a href="#cb191-82" aria-hidden="true" tabindex="-1"></a>    <span class="st">"dbplyr"</span>,</span>
<span id="cb191-83"><a href="#cb191-83" aria-hidden="true" tabindex="-1"></a>    <span class="st">"arrow"</span>,</span>
<span id="cb191-84"><a href="#cb191-84" aria-hidden="true" tabindex="-1"></a>    <span class="st">"geosphere"</span>,</span>
<span id="cb191-85"><a href="#cb191-85" aria-hidden="true" tabindex="-1"></a>    <span class="st">"viridis"</span>,</span>
<span id="cb191-86"><a href="#cb191-86" aria-hidden="true" tabindex="-1"></a>    <span class="st">"patchwork"</span>,</span>
<span id="cb191-87"><a href="#cb191-87" aria-hidden="true" tabindex="-1"></a>    <span class="st">"scales"</span>)</span>
<span id="cb191-88"><a href="#cb191-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-89"><a href="#cb191-89" aria-hidden="true" tabindex="-1"></a>list_installed_packages <span class="ot">&lt;-</span> <span class="fu">names</span>(<span class="fu">installed.packages</span>()[,<span class="dv">2</span>])</span>
<span id="cb191-90"><a href="#cb191-90" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (Rpack <span class="cf">in</span> list_Rpack2use) {</span>
<span id="cb191-91"><a href="#cb191-91" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span> Rpack <span class="sc">%in%</span> list_installed_packages) {</span>
<span id="cb191-92"><a href="#cb191-92" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"Installing"</span>, Rpack))</span>
<span id="cb191-93"><a href="#cb191-93" aria-hidden="true" tabindex="-1"></a>    <span class="fu">install.packages</span>(Rpack, <span class="at">repos =</span> cran_repo)</span>
<span id="cb191-94"><a href="#cb191-94" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb191-95"><a href="#cb191-95" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">paste</span>(Rpack, <span class="st">"already installed."</span>))</span>
<span id="cb191-96"><a href="#cb191-96" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb191-97"><a href="#cb191-97" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb191-98"><a href="#cb191-98" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-99"><a href="#cb191-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-100"><a href="#cb191-100" aria-hidden="true" tabindex="-1"></a>Loading librairies</span>
<span id="cb191-101"><a href="#cb191-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-104"><a href="#cb191-104" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-105"><a href="#cb191-105" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: loading_libraries</span></span>
<span id="cb191-106"><a href="#cb191-106" aria-hidden="true" tabindex="-1"></a>list_Rpack2load_not <span class="ot">&lt;-</span></span>
<span id="cb191-107"><a href="#cb191-107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"conflicted"</span>,</span>
<span id="cb191-108"><a href="#cb191-108" aria-hidden="true" tabindex="-1"></a>    <span class="st">"devtools"</span>,</span>
<span id="cb191-109"><a href="#cb191-109" aria-hidden="true" tabindex="-1"></a>    <span class="st">"paws"</span>,</span>
<span id="cb191-110"><a href="#cb191-110" aria-hidden="true" tabindex="-1"></a>    <span class="st">"RAthena"</span>,</span>
<span id="cb191-111"><a href="#cb191-111" aria-hidden="true" tabindex="-1"></a>    <span class="st">"botor"</span>,</span>
<span id="cb191-112"><a href="#cb191-112" aria-hidden="true" tabindex="-1"></a>    <span class="st">"arrow"</span>,</span>
<span id="cb191-113"><a href="#cb191-113" aria-hidden="true" tabindex="-1"></a>    <span class="st">"RPostgres"</span>,</span>
<span id="cb191-114"><a href="#cb191-114" aria-hidden="true" tabindex="-1"></a>    <span class="st">"DBI"</span>,</span>
<span id="cb191-115"><a href="#cb191-115" aria-hidden="true" tabindex="-1"></a>    <span class="st">"RJDBC"</span>,</span>
<span id="cb191-116"><a href="#cb191-116" aria-hidden="true" tabindex="-1"></a>    <span class="st">"dbplyr"</span>,</span>
<span id="cb191-117"><a href="#cb191-117" aria-hidden="true" tabindex="-1"></a>    <span class="st">"aws.s3"</span>,</span>
<span id="cb191-118"><a href="#cb191-118" aria-hidden="true" tabindex="-1"></a>    <span class="st">"arrow"</span>,</span>
<span id="cb191-119"><a href="#cb191-119" aria-hidden="true" tabindex="-1"></a>    <span class="st">"reticulate"</span>,</span>
<span id="cb191-120"><a href="#cb191-120" aria-hidden="true" tabindex="-1"></a>    <span class="st">"slider"</span>,</span>
<span id="cb191-121"><a href="#cb191-121" aria-hidden="true" tabindex="-1"></a>    <span class="st">"stringi"</span>,</span>
<span id="cb191-122"><a href="#cb191-122" aria-hidden="true" tabindex="-1"></a>    <span class="st">"geosphere"</span>,</span>
<span id="cb191-123"><a href="#cb191-123" aria-hidden="true" tabindex="-1"></a>    <span class="st">"blah"</span>)</span>
<span id="cb191-124"><a href="#cb191-124" aria-hidden="true" tabindex="-1"></a>list_Rpack2load <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(list_Rpack2use, list_Rpack2load_not)</span>
<span id="cb191-125"><a href="#cb191-125" aria-hidden="true" tabindex="-1"></a>list_Rpack2load</span>
<span id="cb191-126"><a href="#cb191-126" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-127"><a href="#cb191-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-128"><a href="#cb191-128" aria-hidden="true" tabindex="-1"></a>Resolving function name conflicts</span>
<span id="cb191-129"><a href="#cb191-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-132"><a href="#cb191-132" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-133"><a href="#cb191-133" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: resolving_conflicts</span></span>
<span id="cb191-134"><a href="#cb191-134" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (Rpack <span class="cf">in</span> list_Rpack2load) {</span>
<span id="cb191-135"><a href="#cb191-135" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(Rpack, <span class="at">character.only =</span> <span class="cn">TRUE</span>)</span>
<span id="cb191-136"><a href="#cb191-136" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb191-137"><a href="#cb191-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-138"><a href="#cb191-138" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(pillar<span class="sc">::</span>dim_desc)</span>
<span id="cb191-139"><a href="#cb191-139" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(magrittr<span class="sc">::</span>extract)</span>
<span id="cb191-140"><a href="#cb191-140" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(dplyr<span class="sc">::</span>filter)</span>
<span id="cb191-141"><a href="#cb191-141" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(jsonlite<span class="sc">::</span>flatten)</span>
<span id="cb191-142"><a href="#cb191-142" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(hms<span class="sc">::</span>hms)</span>
<span id="cb191-143"><a href="#cb191-143" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(dbplyr<span class="sc">::</span>ident)</span>
<span id="cb191-144"><a href="#cb191-144" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(lubridate<span class="sc">::</span>interval)</span>
<span id="cb191-145"><a href="#cb191-145" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(dplyr<span class="sc">::</span>lag)</span>
<span id="cb191-146"><a href="#cb191-146" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(readxl<span class="sc">::</span>read_xlsx)</span>
<span id="cb191-147"><a href="#cb191-147" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(magrittr<span class="sc">::</span>set_names)</span>
<span id="cb191-148"><a href="#cb191-148" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(dbplyr<span class="sc">::</span>sql)</span>
<span id="cb191-149"><a href="#cb191-149" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(Hmisc<span class="sc">::</span>src)</span>
<span id="cb191-150"><a href="#cb191-150" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(dplyr<span class="sc">::</span>summarize)</span>
<span id="cb191-151"><a href="#cb191-151" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(magrittr<span class="sc">::</span>is_in)</span>
<span id="cb191-152"><a href="#cb191-152" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(stats<span class="sc">::</span>chisq.test)</span>
<span id="cb191-153"><a href="#cb191-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-154"><a href="#cb191-154" aria-hidden="true" tabindex="-1"></a><span class="co">#To pass if interactive</span></span>
<span id="cb191-155"><a href="#cb191-155" aria-hidden="true" tabindex="-1"></a><span class="co">#rendering &lt;- TRUE</span></span>
<span id="cb191-156"><a href="#cb191-156" aria-hidden="true" tabindex="-1"></a><span class="co">#time_all &lt;- proc.time()</span></span>
<span id="cb191-157"><a href="#cb191-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-158"><a href="#cb191-158" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"./scripts_gal/misc_funs.R"</span>)</span>
<span id="cb191-159"><a href="#cb191-159" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-160"><a href="#cb191-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-161"><a href="#cb191-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-162"><a href="#cb191-162" aria-hidden="true" tabindex="-1"></a><span class="fu"># Time series overview</span></span>
<span id="cb191-163"><a href="#cb191-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-164"><a href="#cb191-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-165"><a href="#cb191-165" aria-hidden="true" tabindex="-1"></a><span class="fu">## What is a time series?</span></span>
<span id="cb191-166"><a href="#cb191-166" aria-hidden="true" tabindex="-1"></a>A **time series** is a sequence of data points recorded over time at **equally spaced intervals** (e.g., daily sales, monthly demand, yearly GDP).  </span>
<span id="cb191-167"><a href="#cb191-167" aria-hidden="true" tabindex="-1"></a>It captures the **temporal dynamics** of a process and is central to **forecasting** in supply chains, finance, weather, and many other fields.</span>
<span id="cb191-168"><a href="#cb191-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-169"><a href="#cb191-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-170"><a href="#cb191-170" aria-hidden="true" tabindex="-1"></a><span class="fu">## Key components</span></span>
<span id="cb191-171"><a href="#cb191-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-172"><a href="#cb191-172" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Trend (T)**  </span>
<span id="cb191-173"><a href="#cb191-173" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>The **long-term** progression of the series (upward, downward, or stable).  </span>
<span id="cb191-174"><a href="#cb191-174" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Reflects overall growth, decline, or stagnation.  </span>
<span id="cb191-175"><a href="#cb191-175" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>*Example:* gradual increase in online sales over years.  </span>
<span id="cb191-176"><a href="#cb191-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-177"><a href="#cb191-177" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Seasonality (S)**  </span>
<span id="cb191-178"><a href="#cb191-178" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>*Regular, repeating patterns at fixed periods* (daily, weekly, monthly, yearly).  </span>
<span id="cb191-179"><a href="#cb191-179" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>*Example:* ice cream sales peaking every summer.  </span>
<span id="cb191-180"><a href="#cb191-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-181"><a href="#cb191-181" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Cyclic component (C)**  </span>
<span id="cb191-182"><a href="#cb191-182" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Long-term oscillations around the trend, often tied to _economic/business_ cycles.  </span>
<span id="cb191-183"><a href="#cb191-183" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Unlike seasonality, cycles are **irregular** in **length and amplitude**.  </span>
<span id="cb191-184"><a href="#cb191-184" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>*Example:* economic boom and recession cycles.  </span>
<span id="cb191-185"><a href="#cb191-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-186"><a href="#cb191-186" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Irregular / Random (I)**  </span>
<span id="cb191-187"><a href="#cb191-187" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Unpredictable, residual variations after accounting for trend, seasonality, and cycles.  </span>
<span id="cb191-188"><a href="#cb191-188" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>*Example:* sudden demand spikes due to supply chain disruptions.  </span>
<span id="cb191-189"><a href="#cb191-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-190"><a href="#cb191-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-191"><a href="#cb191-191" aria-hidden="true" tabindex="-1"></a><span class="fu">## Models of time series</span></span>
<span id="cb191-192"><a href="#cb191-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-193"><a href="#cb191-193" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Additive model:**  </span>
<span id="cb191-194"><a href="#cb191-194" aria-hidden="true" tabindex="-1"></a>  $$</span>
<span id="cb191-195"><a href="#cb191-195" aria-hidden="true" tabindex="-1"></a>  Y_t = T_t + S_t + C_t + I_t</span>
<span id="cb191-196"><a href="#cb191-196" aria-hidden="true" tabindex="-1"></a>  $$  </span>
<span id="cb191-197"><a href="#cb191-197" aria-hidden="true" tabindex="-1"></a>  Suitable when **seasonal variations** remain **constant in magnitude**.  </span>
<span id="cb191-198"><a href="#cb191-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-199"><a href="#cb191-199" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Multiplicative model:**  </span>
<span id="cb191-200"><a href="#cb191-200" aria-hidden="true" tabindex="-1"></a>  $$</span>
<span id="cb191-201"><a href="#cb191-201" aria-hidden="true" tabindex="-1"></a>  Y_t = T_t \times S_t \times C_t \times I_t</span>
<span id="cb191-202"><a href="#cb191-202" aria-hidden="true" tabindex="-1"></a>  $$  </span>
<span id="cb191-203"><a href="#cb191-203" aria-hidden="true" tabindex="-1"></a>  Suitable when **seasonal variations** change **proportionally** with the level of the series.  </span>
<span id="cb191-204"><a href="#cb191-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-205"><a href="#cb191-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-206"><a href="#cb191-206" aria-hidden="true" tabindex="-1"></a><span class="fu">## Applications in supply chain</span></span>
<span id="cb191-207"><a href="#cb191-207" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Demand forecasting** → anticipating future _product demand_.  </span>
<span id="cb191-208"><a href="#cb191-208" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Inventory control** → optimizing _stock_ based on demand variability.  </span>
<span id="cb191-209"><a href="#cb191-209" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Capacity planning** → adjusting _workforce_ or _production_ to meet seasonal/cyclic needs.  </span>
<span id="cb191-210"><a href="#cb191-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-211"><a href="#cb191-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-212"><a href="#cb191-212" aria-hidden="true" tabindex="-1"></a><span class="fu"># Generating a TS components</span></span>
<span id="cb191-213"><a href="#cb191-213" aria-hidden="true" tabindex="-1"></a>A TS has some **deterministic** components (the “signal”) and some **random** component (the “noise”).\</span>
<span id="cb191-214"><a href="#cb191-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-215"><a href="#cb191-215" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb191-216"><a href="#cb191-216" aria-hidden="true" tabindex="-1"></a>Usually we want to **extract the signal**, and **model the noise**.\</span>
<span id="cb191-217"><a href="#cb191-217" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb191-218"><a href="#cb191-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-219"><a href="#cb191-219" aria-hidden="true" tabindex="-1"></a>Here, since we are generating a TS, we start with some signal and then add the noise.\</span>
<span id="cb191-220"><a href="#cb191-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-221"><a href="#cb191-221" aria-hidden="true" tabindex="-1"></a><span class="fu">## Deterministic component</span></span>
<span id="cb191-222"><a href="#cb191-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-223"><a href="#cb191-223" aria-hidden="true" tabindex="-1"></a>When building or simulating a time series, it is useful to separate **deterministic components** (signal) from **stochastic components** (noise).</span>
<span id="cb191-224"><a href="#cb191-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-225"><a href="#cb191-225" aria-hidden="true" tabindex="-1"></a>The deterministic part can include:</span>
<span id="cb191-226"><a href="#cb191-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-227"><a href="#cb191-227" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Trend** — a systematic long-term increase or decrease in the series.</span>
<span id="cb191-228"><a href="#cb191-228" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Seasonality** — _recurring fluctuations_ tied to the calendar (daily, weekly, yearly, etc.).</span>
<span id="cb191-229"><a href="#cb191-229" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Other **structural components** — for example, cycles linked to macroeconomic factors.</span>
<span id="cb191-230"><a href="#cb191-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-231"><a href="#cb191-231" aria-hidden="true" tabindex="-1"></a><span class="fu">### Trend component</span></span>
<span id="cb191-232"><a href="#cb191-232" aria-hidden="true" tabindex="-1"></a>We start simple with a linear trend. We’ll be optimistic and assume we have a steady trend of $\alpha= 0.5$ per year starting from a number of units (say thousands of items) of $y_0 = 5$.</span>
<span id="cb191-233"><a href="#cb191-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-234"><a href="#cb191-234" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Linear trend</span></span>
<span id="cb191-235"><a href="#cb191-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-236"><a href="#cb191-236" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-237"><a href="#cb191-237" aria-hidden="true" tabindex="-1"></a>tr(t) = y_0 + \alpha*\frac{t}{365}</span>
<span id="cb191-238"><a href="#cb191-238" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-239"><a href="#cb191-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-240"><a href="#cb191-240" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Exponential trend</span></span>
<span id="cb191-241"><a href="#cb191-241" aria-hidden="true" tabindex="-1"></a>If instead of a linear trend we assume a **constant proportional daily growth rate ($1 + \beta_d$)**, then the trend is exponential. </span>
<span id="cb191-242"><a href="#cb191-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-243"><a href="#cb191-243" aria-hidden="true" tabindex="-1"></a>After **one day**, the demand’s trend would be $y_0*(1 + \beta_d)$, and after $t$ days, the demand’s trend would be $y_0*(1 + \beta_d)^t$.</span>
<span id="cb191-244"><a href="#cb191-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-245"><a href="#cb191-245" aria-hidden="true" tabindex="-1"></a>The daily growth rate can be derived from the yearly one:</span>
<span id="cb191-246"><a href="#cb191-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-247"><a href="#cb191-247" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-248"><a href="#cb191-248" aria-hidden="true" tabindex="-1"></a>1 + \beta_d = 1 + \frac{\beta_y}{365} \approx e^{\frac{\beta_y}{365}}</span>
<span id="cb191-249"><a href="#cb191-249" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-250"><a href="#cb191-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-251"><a href="#cb191-251" aria-hidden="true" tabindex="-1"></a>Consequently:</span>
<span id="cb191-252"><a href="#cb191-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-253"><a href="#cb191-253" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-254"><a href="#cb191-254" aria-hidden="true" tabindex="-1"></a>tr(t) = y_0*(1 + \beta_d)^t \approx y_0*(e^{\frac{\beta_y}{365}})^t</span>
<span id="cb191-255"><a href="#cb191-255" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-256"><a href="#cb191-256" aria-hidden="true" tabindex="-1"></a>For $\beta_y = 0.1$:</span>
<span id="cb191-257"><a href="#cb191-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-258"><a href="#cb191-258" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-259"><a href="#cb191-259" aria-hidden="true" tabindex="-1"></a>tr(t) = y_0 * (e^{\frac{0.1}{365}})^t</span>
<span id="cb191-260"><a href="#cb191-260" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-261"><a href="#cb191-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-262"><a href="#cb191-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-263"><a href="#cb191-263" aria-hidden="true" tabindex="-1"></a><span class="fu">### Seasonality component</span></span>
<span id="cb191-264"><a href="#cb191-264" aria-hidden="true" tabindex="-1"></a>Seasonality captures **repeated, systematic fluctuations** that recur with a fixed period.\</span>
<span id="cb191-265"><a href="#cb191-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-266"><a href="#cb191-266" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Example: retail sales increase every December (yearly seasonality).\</span>
<span id="cb191-267"><a href="#cb191-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-268"><a href="#cb191-268" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>In our toy model, we assume **only one yearly seasonal effect**.\</span>
<span id="cb191-269"><a href="#cb191-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-270"><a href="#cb191-270" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Later, this framework can be extended to **multiple overlapping seasonalities** (e.g., weekly + yearly).</span>
<span id="cb191-271"><a href="#cb191-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-272"><a href="#cb191-272" aria-hidden="true" tabindex="-1"></a>Here, we start with only one yearly seasonality **$s(t)$** (with yearly period).</span>
<span id="cb191-273"><a href="#cb191-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-274"><a href="#cb191-274" aria-hidden="true" tabindex="-1"></a>We smooth the raw seasonal pattern and normalize it so that it has mean zero, ensuring the trend drives the long-run growth.</span>
<span id="cb191-275"><a href="#cb191-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-278"><a href="#cb191-278" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-279"><a href="#cb191-279" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: seasonality_def_plot</span></span>
<span id="cb191-280"><a href="#cb191-280" aria-hidden="true" tabindex="-1"></a>trend_y <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb191-281"><a href="#cb191-281" aria-hidden="true" tabindex="-1"></a><span class="co"># yearly trend</span></span>
<span id="cb191-282"><a href="#cb191-282" aria-hidden="true" tabindex="-1"></a>start_ts <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb191-283"><a href="#cb191-283" aria-hidden="true" tabindex="-1"></a><span class="co"># starting value of the series</span></span>
<span id="cb191-284"><a href="#cb191-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-285"><a href="#cb191-285" aria-hidden="true" tabindex="-1"></a>sea_0 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">10</span>)</span>
<span id="cb191-286"><a href="#cb191-286" aria-hidden="true" tabindex="-1"></a><span class="co"># sea_0 contains a seasonal adjustment for each month. </span></span>
<span id="cb191-287"><a href="#cb191-287" aria-hidden="true" tabindex="-1"></a><span class="co"># These values represent typical deviations from the trend for each month.</span></span>
<span id="cb191-288"><a href="#cb191-288" aria-hidden="true" tabindex="-1"></a>df_sea <span class="ot">&lt;-</span> </span>
<span id="cb191-289"><a href="#cb191-289" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">day =</span> <span class="fu">seq</span>(<span class="fu">as_date</span>(<span class="st">"2022-12-28"</span>), <span class="fu">today</span>() <span class="sc">+</span> <span class="fu">days</span>(<span class="dv">3</span>), <span class="at">by =</span> <span class="st">"day"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb191-290"><a href="#cb191-290" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generates a daily sequence of dates</span></span>
<span id="cb191-291"><a href="#cb191-291" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mon =</span> <span class="fu">month</span>(day),</span>
<span id="cb191-292"><a href="#cb191-292" aria-hidden="true" tabindex="-1"></a>         <span class="at">sea =</span> <span class="fu">map2_dbl</span>(mon, day, <span class="sc">~</span> <span class="fu">if_else</span>((<span class="fu">str_split</span>(.y, <span class="at">pattern =</span> <span class="st">"-"</span>) <span class="sc">%&gt;%</span> <span class="fu">extract2</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> <span class="fu">extract</span>(<span class="dv">3</span>) <span class="sc">%&gt;%</span> as.numeric) <span class="sc">==</span> <span class="dv">15</span>, sea_0[.x], <span class="cn">NA</span>)),</span>
<span id="cb191-293"><a href="#cb191-293" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Map monthly seasonal values to the middle of each month</span></span>
<span id="cb191-294"><a href="#cb191-294" aria-hidden="true" tabindex="-1"></a>         <span class="co"># This creates monthly anchor points for the seasonal component.</span></span>
<span id="cb191-295"><a href="#cb191-295" aria-hidden="true" tabindex="-1"></a>         <span class="at">sea =</span> <span class="fu">na_interpolation</span>(sea, <span class="at">option =</span> <span class="st">"spline"</span>),</span>
<span id="cb191-296"><a href="#cb191-296" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Interpolate missing seasonal values</span></span>
<span id="cb191-297"><a href="#cb191-297" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Fills in the NA values using spline interpolation, creating a smooth seasonal curve.</span></span>
<span id="cb191-298"><a href="#cb191-298" aria-hidden="true" tabindex="-1"></a>         <span class="at">sea =</span> zoo<span class="sc">::</span><span class="fu">rollmean</span>(sea, <span class="at">k =</span> <span class="dv">7</span>, <span class="at">fill =</span> <span class="cn">TRUE</span>),</span>
<span id="cb191-299"><a href="#cb191-299" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Smooth the seasonal curve further</span></span>
<span id="cb191-300"><a href="#cb191-300" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Applies a 7-day rolling mean to smooth short-term fluctuations.</span></span>
<span id="cb191-301"><a href="#cb191-301" aria-hidden="true" tabindex="-1"></a>         <span class="at">sea =</span> sea <span class="sc">-</span> <span class="fu">mean</span>(sea)) <span class="sc">%&gt;%</span></span>
<span id="cb191-302"><a href="#cb191-302" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Center the seasonal component around zero</span></span>
<span id="cb191-303"><a href="#cb191-303" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(day <span class="sc">&gt;=</span> <span class="st">"2023-01-01"</span>,</span>
<span id="cb191-304"><a href="#cb191-304" aria-hidden="true" tabindex="-1"></a>         day <span class="sc">&lt;=</span> <span class="fu">today</span>())</span>
<span id="cb191-305"><a href="#cb191-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-306"><a href="#cb191-306" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&gt;%</span></span>
<span id="cb191-307"><a href="#cb191-307" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> sea)) <span class="sc">+</span></span>
<span id="cb191-308"><a href="#cb191-308" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb191-309"><a href="#cb191-309" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"#00BFC4"</span>, <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb191-310"><a href="#cb191-310" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Seasonality component"</span>,</span>
<span id="cb191-311"><a href="#cb191-311" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Value"</span>, <span class="at">x =</span> <span class="st">"Day"</span>)</span>
<span id="cb191-312"><a href="#cb191-312" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-313"><a href="#cb191-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-314"><a href="#cb191-314" aria-hidden="true" tabindex="-1"></a><span class="fu">### Additive model</span></span>
<span id="cb191-315"><a href="#cb191-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-316"><a href="#cb191-316" aria-hidden="true" tabindex="-1"></a>Let’s focus on one item and write $y_t$ for counts of orders for this item, and assume we have daily counts since **January 1st, 2023**, with no missing data.  </span>
<span id="cb191-317"><a href="#cb191-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-318"><a href="#cb191-318" aria-hidden="true" tabindex="-1"></a>We can put together the **trend** and the **seasonality** in an **additive** way to get the time series’ deterministic component:</span>
<span id="cb191-319"><a href="#cb191-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-320"><a href="#cb191-320" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-321"><a href="#cb191-321" aria-hidden="true" tabindex="-1"></a>y_t^{\text{(d)}} = tr(t) + S(t)</span>
<span id="cb191-322"><a href="#cb191-322" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-323"><a href="#cb191-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-324"><a href="#cb191-324" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>With the linear trend\</span>
<span id="cb191-325"><a href="#cb191-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-326"><a href="#cb191-326" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-327"><a href="#cb191-327" aria-hidden="true" tabindex="-1"></a>tr(t) = y_0 + \alpha*\frac{t}{365}</span>
<span id="cb191-328"><a href="#cb191-328" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-329"><a href="#cb191-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-330"><a href="#cb191-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-331"><a href="#cb191-331" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-332"><a href="#cb191-332" aria-hidden="true" tabindex="-1"></a>S(t) = s(t)</span>
<span id="cb191-333"><a href="#cb191-333" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-334"><a href="#cb191-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-335"><a href="#cb191-335" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-336"><a href="#cb191-336" aria-hidden="true" tabindex="-1"></a>y_t^{\text{(d)}} = y_0 + \alpha*\frac{t}{365} + s(t)</span>
<span id="cb191-337"><a href="#cb191-337" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-338"><a href="#cb191-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-339"><a href="#cb191-339" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>With the exponential trend\</span>
<span id="cb191-340"><a href="#cb191-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-341"><a href="#cb191-341" aria-hidden="true" tabindex="-1"></a>It would also make sense to **multiply the seasonality by the growth rate**. So, after $t$ days, the deterministic component would be:</span>
<span id="cb191-342"><a href="#cb191-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-343"><a href="#cb191-343" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-344"><a href="#cb191-344" aria-hidden="true" tabindex="-1"></a>tr(t) = y_0*(e^{\frac{\beta_y}{365}})^t</span>
<span id="cb191-345"><a href="#cb191-345" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-346"><a href="#cb191-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-347"><a href="#cb191-347" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-348"><a href="#cb191-348" aria-hidden="true" tabindex="-1"></a>S(t) = s(t)*(e^{\frac{\beta_y}{365}})^t</span>
<span id="cb191-349"><a href="#cb191-349" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-350"><a href="#cb191-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-351"><a href="#cb191-351" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-352"><a href="#cb191-352" aria-hidden="true" tabindex="-1"></a>y_t^{\text{(d)}} = (y_0 + s(t))*(e^{\frac{\beta_y}{365}})^t</span>
<span id="cb191-353"><a href="#cb191-353" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-354"><a href="#cb191-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-355"><a href="#cb191-355" aria-hidden="true" tabindex="-1"></a>For $\beta_y = 0.1$:</span>
<span id="cb191-356"><a href="#cb191-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-357"><a href="#cb191-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-358"><a href="#cb191-358" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-359"><a href="#cb191-359" aria-hidden="true" tabindex="-1"></a>y_t^{\text{(d)}} = (y_0 + s(t))*(e^{\frac{0.1}{365}})^t</span>
<span id="cb191-360"><a href="#cb191-360" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-361"><a href="#cb191-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-362"><a href="#cb191-362" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Plotting the deterministic component</span></span>
<span id="cb191-363"><a href="#cb191-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-364"><a href="#cb191-364" aria-hidden="true" tabindex="-1"></a>Here we can visualize how the trend and seasonality combine over time to form the deterministic part of the time series.</span>
<span id="cb191-365"><a href="#cb191-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-368"><a href="#cb191-368" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-369"><a href="#cb191-369" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: deterministic_comp</span></span>
<span id="cb191-370"><a href="#cb191-370" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&lt;&gt;%</span></span>
<span id="cb191-371"><a href="#cb191-371" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tr_lin =</span> start_ts <span class="sc">+</span> trend_y <span class="sc">*</span> <span class="fu">row_number</span>() <span class="sc">/</span> <span class="dv">365</span>,</span>
<span id="cb191-372"><a href="#cb191-372" aria-hidden="true" tabindex="-1"></a>         <span class="at">tr_exp =</span> start_ts <span class="sc">*</span> <span class="fu">exp</span>(<span class="fl">0.1</span> <span class="sc">/</span> <span class="dv">365</span>)<span class="sc">^</span><span class="fu">row_number</span>(),</span>
<span id="cb191-373"><a href="#cb191-373" aria-hidden="true" tabindex="-1"></a>         <span class="at">yd_lin =</span> tr_lin <span class="sc">+</span> sea,</span>
<span id="cb191-374"><a href="#cb191-374" aria-hidden="true" tabindex="-1"></a>         <span class="at">yd_exp =</span> (start_ts <span class="sc">+</span> sea) <span class="sc">*</span> <span class="fu">exp</span>(<span class="fl">0.1</span> <span class="sc">/</span> <span class="dv">365</span>)<span class="sc">^</span><span class="fu">row_number</span>())</span>
<span id="cb191-375"><a href="#cb191-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-376"><a href="#cb191-376" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&gt;%</span> </span>
<span id="cb191-377"><a href="#cb191-377" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(tr_lin, tr_exp, yd_lin, yd_exp), </span>
<span id="cb191-378"><a href="#cb191-378" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">"func"</span>, <span class="st">"method"</span>), </span>
<span id="cb191-379"><a href="#cb191-379" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_sep =</span> <span class="st">"_"</span>, </span>
<span id="cb191-380"><a href="#cb191-380" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb191-381"><a href="#cb191-381" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">func =</span> <span class="fu">factor</span>(func, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"yd"</span>, <span class="st">"tr"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb191-382"><a href="#cb191-382" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb191-383"><a href="#cb191-383" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> method,</span>
<span id="cb191-384"><a href="#cb191-384" aria-hidden="true" tabindex="-1"></a>                  <span class="at">linetype =</span> func), <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb191-385"><a href="#cb191-385" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Additive Deterministic Component"</span>,</span>
<span id="cb191-386"><a href="#cb191-386" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Value"</span>, <span class="at">x =</span> <span class="st">"Date"</span>)</span>
<span id="cb191-387"><a href="#cb191-387" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-388"><a href="#cb191-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-389"><a href="#cb191-389" aria-hidden="true" tabindex="-1"></a><span class="fu">### Multiplicative model</span></span>
<span id="cb191-390"><a href="#cb191-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-393"><a href="#cb191-393" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-394"><a href="#cb191-394" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: multiplicative_deterministic_comp</span></span>
<span id="cb191-395"><a href="#cb191-395" aria-hidden="true" tabindex="-1"></a><span class="co"># Multiplicative deterministic component</span></span>
<span id="cb191-396"><a href="#cb191-396" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&lt;&gt;%</span></span>
<span id="cb191-397"><a href="#cb191-397" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb191-398"><a href="#cb191-398" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Linear trend (for comparison)</span></span>
<span id="cb191-399"><a href="#cb191-399" aria-hidden="true" tabindex="-1"></a>    <span class="at">tr_lin =</span> start_ts <span class="sc">+</span> trend_y <span class="sc">*</span> <span class="fu">row_number</span>() <span class="sc">/</span> <span class="dv">365</span>,</span>
<span id="cb191-400"><a href="#cb191-400" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Exponential trend</span></span>
<span id="cb191-401"><a href="#cb191-401" aria-hidden="true" tabindex="-1"></a>    <span class="at">tr_exp =</span> start_ts <span class="sc">*</span> <span class="fu">exp</span>(<span class="fl">0.1</span> <span class="sc">/</span> <span class="dv">365</span>)<span class="sc">^</span><span class="fu">row_number</span>(),</span>
<span id="cb191-402"><a href="#cb191-402" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb191-403"><a href="#cb191-403" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Multiplicative seasonal component</span></span>
<span id="cb191-404"><a href="#cb191-404" aria-hidden="true" tabindex="-1"></a>    <span class="at">yd_lin_mul =</span> tr_lin <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> sea),        <span class="co"># linear trend * (1 + seasonality)</span></span>
<span id="cb191-405"><a href="#cb191-405" aria-hidden="true" tabindex="-1"></a>    <span class="at">yd_exp_mul =</span> tr_exp <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> sea)         <span class="co"># exponential trend * (1 + seasonality)</span></span>
<span id="cb191-406"><a href="#cb191-406" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb191-407"><a href="#cb191-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-408"><a href="#cb191-408" aria-hidden="true" tabindex="-1"></a><span class="co"># Reshape for plotting</span></span>
<span id="cb191-409"><a href="#cb191-409" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&gt;%</span> </span>
<span id="cb191-410"><a href="#cb191-410" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb191-411"><a href="#cb191-411" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(tr_lin, tr_exp, yd_lin_mul, yd_exp_mul), </span>
<span id="cb191-412"><a href="#cb191-412" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">"func"</span>, <span class="st">"method"</span>), </span>
<span id="cb191-413"><a href="#cb191-413" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_sep =</span> <span class="st">"_"</span>, </span>
<span id="cb191-414"><a href="#cb191-414" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"value"</span></span>
<span id="cb191-415"><a href="#cb191-415" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb191-416"><a href="#cb191-416" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">func =</span> <span class="fu">factor</span>(func, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"yd"</span>, <span class="st">"tr"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb191-417"><a href="#cb191-417" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb191-418"><a href="#cb191-418" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> method, <span class="at">linetype =</span> func), <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb191-419"><a href="#cb191-419" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Multiplicative Deterministic Component"</span>,</span>
<span id="cb191-420"><a href="#cb191-420" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Value"</span>, <span class="at">x =</span> <span class="st">"Date"</span>)</span>
<span id="cb191-421"><a href="#cb191-421" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-422"><a href="#cb191-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-423"><a href="#cb191-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-424"><a href="#cb191-424" aria-hidden="true" tabindex="-1"></a><span class="fu">## Random component</span></span>
<span id="cb191-425"><a href="#cb191-425" aria-hidden="true" tabindex="-1"></a>So far, we have modeled only the signal. But in reality, time series always contain noise, capturing **unpredictable factors** such as weather, strikes, promotions, or random shocks.</span>
<span id="cb191-426"><a href="#cb191-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-427"><a href="#cb191-427" aria-hidden="true" tabindex="-1"></a><span class="fu">### Gaussain noise</span></span>
<span id="cb191-428"><a href="#cb191-428" aria-hidden="true" tabindex="-1"></a>A simple first assumption is **additive Gaussian noise** with zero mean ($\mu = 0$) and variance $\sigma^2$.</span>
<span id="cb191-429"><a href="#cb191-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-430"><a href="#cb191-430" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> style</span><span class="op">=</span><span class="st">"text-align: center;"</span><span class="dt">&gt;</span></span>
<span id="cb191-431"><a href="#cb191-431" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">img</span><span class="ot"> src</span><span class="op">=</span><span class="st">"/images/normal_distribution_pdf.png"</span><span class="ot"> alt</span><span class="op">=</span><span class="st">"Poisson Distribution"</span><span class="ot"> width</span><span class="op">=</span><span class="st">"75%"</span><span class="dt">&gt;</span></span>
<span id="cb191-432"><a href="#cb191-432" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb191-433"><a href="#cb191-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-434"><a href="#cb191-434" aria-hidden="true" tabindex="-1"></a>**Distribution:**  </span>
<span id="cb191-435"><a href="#cb191-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-436"><a href="#cb191-436" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-437"><a href="#cb191-437" aria-hidden="true" tabindex="-1"></a>\epsilon_t \sim \mathcal{N}(0, \sigma^2)</span>
<span id="cb191-438"><a href="#cb191-438" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-439"><a href="#cb191-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-440"><a href="#cb191-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-441"><a href="#cb191-441" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-442"><a href="#cb191-442" aria-hidden="true" tabindex="-1"></a>f(x) = \frac{1}{\sqrt{2\pi\sigma^2}} \, \exp\left(-\frac{x^2}{2\sigma^2}\right)</span>
<span id="cb191-443"><a href="#cb191-443" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-444"><a href="#cb191-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-445"><a href="#cb191-445" aria-hidden="true" tabindex="-1"></a>**Parameters:** $\mu = 0$, $\sigma^2$</span>
<span id="cb191-446"><a href="#cb191-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-447"><a href="#cb191-447" aria-hidden="true" tabindex="-1"></a>**Mean:** $\mu = 0$</span>
<span id="cb191-448"><a href="#cb191-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-449"><a href="#cb191-449" aria-hidden="true" tabindex="-1"></a>**Variance:** $\sigma^2$</span>
<span id="cb191-450"><a href="#cb191-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-451"><a href="#cb191-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-454"><a href="#cb191-454" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-455"><a href="#cb191-455" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: gaussian_noise_added</span></span>
<span id="cb191-456"><a href="#cb191-456" aria-hidden="true" tabindex="-1"></a>sig_1 <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb191-457"><a href="#cb191-457" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">102938</span>)</span>
<span id="cb191-458"><a href="#cb191-458" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&lt;&gt;%</span></span>
<span id="cb191-459"><a href="#cb191-459" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">noi =</span> <span class="fu">rnorm</span>(<span class="fu">nrow</span>(df_sea), <span class="dv">0</span>, sig_1),</span>
<span id="cb191-460"><a href="#cb191-460" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_lin =</span> yd_lin <span class="sc">+</span> noi,</span>
<span id="cb191-461"><a href="#cb191-461" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_exp =</span> (start_ts <span class="sc">+</span> sea <span class="sc">+</span> noi) <span class="sc">*</span> <span class="fu">exp</span>(<span class="fl">0.1</span> <span class="sc">/</span> <span class="dv">365</span>)<span class="sc">^</span><span class="fu">row_number</span>())</span>
<span id="cb191-462"><a href="#cb191-462" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-463"><a href="#cb191-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-464"><a href="#cb191-464" aria-hidden="true" tabindex="-1"></a>Let’s start simple and assume we have additive Gaussian noise with mean zero and variance $\sigma ^2 = 1$.\</span>
<span id="cb191-465"><a href="#cb191-465" aria-hidden="true" tabindex="-1"></a>Now we have the complete additive time series:</span>
<span id="cb191-466"><a href="#cb191-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-467"><a href="#cb191-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-468"><a href="#cb191-468" aria-hidden="true" tabindex="-1"></a>And the complete multiplicative time series:</span>
<span id="cb191-469"><a href="#cb191-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-470"><a href="#cb191-470" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-471"><a href="#cb191-471" aria-hidden="true" tabindex="-1"></a>y(t) = tr(t) + S_t + \epsilon</span>
<span id="cb191-472"><a href="#cb191-472" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-473"><a href="#cb191-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-474"><a href="#cb191-474" aria-hidden="true" tabindex="-1"></a>And the complete multiplicative time series:</span>
<span id="cb191-475"><a href="#cb191-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-476"><a href="#cb191-476" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-477"><a href="#cb191-477" aria-hidden="true" tabindex="-1"></a>y(t) = (tr(t) + S_t + \epsilon) * exp(\beta_d * t)</span>
<span id="cb191-478"><a href="#cb191-478" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-481"><a href="#cb191-481" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-482"><a href="#cb191-482" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: noisy_ts_plot</span></span>
<span id="cb191-483"><a href="#cb191-483" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&gt;%</span> </span>
<span id="cb191-484"><a href="#cb191-484" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(tr_lin, tr_exp, y_lin, y_exp), </span>
<span id="cb191-485"><a href="#cb191-485" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">"func"</span>, <span class="st">"method"</span>), </span>
<span id="cb191-486"><a href="#cb191-486" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_sep =</span> <span class="st">"_"</span>, </span>
<span id="cb191-487"><a href="#cb191-487" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb191-488"><a href="#cb191-488" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">func =</span> <span class="fu">factor</span>(func, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"y"</span>, <span class="st">"tr"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb191-489"><a href="#cb191-489" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb191-490"><a href="#cb191-490" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb191-491"><a href="#cb191-491" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> method,</span>
<span id="cb191-492"><a href="#cb191-492" aria-hidden="true" tabindex="-1"></a>                  <span class="at">linetype =</span> func),</span>
<span id="cb191-493"><a href="#cb191-493" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb191-494"><a href="#cb191-494" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Additive Gaussian Noise"</span>,</span>
<span id="cb191-495"><a href="#cb191-495" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Value"</span>, <span class="at">x =</span> <span class="st">"Date"</span>)</span>
<span id="cb191-496"><a href="#cb191-496" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-497"><a href="#cb191-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-498"><a href="#cb191-498" aria-hidden="true" tabindex="-1"></a>We see here some negative values. That’s not consistent with counts. Counts are never negative. This means that our model is not quite right. We used Gaussian noise. But **Gaussian noise is unlimited in the positive as well as in the negative**. What other noise distribution can we use?</span>
<span id="cb191-499"><a href="#cb191-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-500"><a href="#cb191-500" aria-hidden="true" tabindex="-1"></a>Since demand is count-based, a more natural choice is a discrete distribution.</span>
<span id="cb191-501"><a href="#cb191-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-502"><a href="#cb191-502" aria-hidden="true" tabindex="-1"></a><span class="fu">### Poisson Noise</span></span>
<span id="cb191-503"><a href="#cb191-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-504"><a href="#cb191-504" aria-hidden="true" tabindex="-1"></a>Suitable when **variance ≈ mean**.  </span>
<span id="cb191-505"><a href="#cb191-505" aria-hidden="true" tabindex="-1"></a>It is simple and widely used for **rare-event counts**.</span>
<span id="cb191-506"><a href="#cb191-506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-507"><a href="#cb191-507" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> style</span><span class="op">=</span><span class="st">"text-align: center;"</span><span class="dt">&gt;</span></span>
<span id="cb191-508"><a href="#cb191-508" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">img</span><span class="ot"> src</span><span class="op">=</span><span class="st">"/images/poisson_distribution_PMF.png"</span><span class="ot"> alt</span><span class="op">=</span><span class="st">"Poisson Distribution"</span><span class="ot"> width</span><span class="op">=</span><span class="st">"75%"</span><span class="dt">&gt;</span></span>
<span id="cb191-509"><a href="#cb191-509" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb191-510"><a href="#cb191-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-511"><a href="#cb191-511" aria-hidden="true" tabindex="-1"></a>**Distribution:**  </span>
<span id="cb191-512"><a href="#cb191-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-513"><a href="#cb191-513" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-514"><a href="#cb191-514" aria-hidden="true" tabindex="-1"></a>\epsilon_t \sim \mathcal{Poisson}(\lambda)</span>
<span id="cb191-515"><a href="#cb191-515" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-516"><a href="#cb191-516" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-517"><a href="#cb191-517" aria-hidden="true" tabindex="-1"></a>P(X = k) = \frac{\lambda^k e^{-\lambda}}{k!}, \quad k = 0, 1, 2, \ldots</span>
<span id="cb191-518"><a href="#cb191-518" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-519"><a href="#cb191-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-520"><a href="#cb191-520" aria-hidden="true" tabindex="-1"></a>**Parameters:** $\lambda$  </span>
<span id="cb191-521"><a href="#cb191-521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-522"><a href="#cb191-522" aria-hidden="true" tabindex="-1"></a>**Mean:** $\lambda$  </span>
<span id="cb191-523"><a href="#cb191-523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-524"><a href="#cb191-524" aria-hidden="true" tabindex="-1"></a>**Variance:** $\lambda$  </span>
<span id="cb191-525"><a href="#cb191-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-526"><a href="#cb191-526" aria-hidden="true" tabindex="-1"></a>**Notes:**  </span>
<span id="cb191-527"><a href="#cb191-527" aria-hidden="true" tabindex="-1"></a>Common in modeling **count data** and **discrete random events** (e.g., photon counts, arrivals, or defect occurrences).</span>
<span id="cb191-528"><a href="#cb191-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-531"><a href="#cb191-531" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-532"><a href="#cb191-532" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: noisy_ts_poisson_plot</span></span>
<span id="cb191-533"><a href="#cb191-533" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">102938</span>)</span>
<span id="cb191-534"><a href="#cb191-534" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">&lt;-</span> <span class="dv">2</span>  <span class="co"># mean noise level</span></span>
<span id="cb191-535"><a href="#cb191-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-536"><a href="#cb191-536" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&lt;&gt;%</span></span>
<span id="cb191-537"><a href="#cb191-537" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">noi_pois =</span> <span class="fu">rpois</span>(<span class="fu">nrow</span>(df_sea), lambda),</span>
<span id="cb191-538"><a href="#cb191-538" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_lin_pois =</span> yd_lin <span class="sc">+</span> noi_pois,</span>
<span id="cb191-539"><a href="#cb191-539" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_exp_pois =</span> (start_ts <span class="sc">+</span> sea <span class="sc">+</span> noi_pois) <span class="sc">*</span> <span class="fu">exp</span>(<span class="fl">0.1</span> <span class="sc">/</span> <span class="dv">365</span>)<span class="sc">^</span><span class="fu">row_number</span>())</span>
<span id="cb191-540"><a href="#cb191-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-541"><a href="#cb191-541" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&gt;%</span> </span>
<span id="cb191-542"><a href="#cb191-542" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(tr_lin, tr_exp, y_lin_pois, y_exp_pois), </span>
<span id="cb191-543"><a href="#cb191-543" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">"func"</span>, <span class="st">"method"</span>), </span>
<span id="cb191-544"><a href="#cb191-544" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_sep =</span> <span class="st">"_"</span>, </span>
<span id="cb191-545"><a href="#cb191-545" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb191-546"><a href="#cb191-546" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">func =</span> <span class="fu">factor</span>(func, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"y"</span>, <span class="st">"tr"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb191-547"><a href="#cb191-547" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb191-548"><a href="#cb191-548" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb191-549"><a href="#cb191-549" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> method,</span>
<span id="cb191-550"><a href="#cb191-550" aria-hidden="true" tabindex="-1"></a>                  <span class="at">linetype =</span> func),</span>
<span id="cb191-551"><a href="#cb191-551" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb191-552"><a href="#cb191-552" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Additive Poisson Noise"</span>,</span>
<span id="cb191-553"><a href="#cb191-553" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Value"</span>, <span class="at">x =</span> <span class="st">"Date"</span>)</span>
<span id="cb191-554"><a href="#cb191-554" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-555"><a href="#cb191-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-556"><a href="#cb191-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-557"><a href="#cb191-557" aria-hidden="true" tabindex="-1"></a><span class="fu">### Negative Binomial noise</span></span>
<span id="cb191-558"><a href="#cb191-558" aria-hidden="true" tabindex="-1"></a>When the **variance of counts is larger than the mean**, the Poisson assumption is too restrictive.</span>
<span id="cb191-559"><a href="#cb191-559" aria-hidden="true" tabindex="-1"></a>The Negative Binomial distribution **generalizes the Poisson** by introducing an **overdispersion parameter r**.</span>
<span id="cb191-560"><a href="#cb191-560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-561"><a href="#cb191-561" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> style</span><span class="op">=</span><span class="st">"text-align: center;"</span><span class="dt">&gt;</span></span>
<span id="cb191-562"><a href="#cb191-562" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">img</span><span class="ot"> src</span><span class="op">=</span><span class="st">"/images/negative_binomial.png"</span><span class="ot"> alt</span><span class="op">=</span><span class="st">"Negative-Binomial Distribution"</span><span class="ot"> width</span><span class="op">=</span><span class="st">"100%"</span><span class="dt">&gt;</span></span>
<span id="cb191-563"><a href="#cb191-563" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb191-564"><a href="#cb191-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-565"><a href="#cb191-565" aria-hidden="true" tabindex="-1"></a>**Distribution:** </span>
<span id="cb191-566"><a href="#cb191-566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-567"><a href="#cb191-567" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-568"><a href="#cb191-568" aria-hidden="true" tabindex="-1"></a>\epsilon_t \sim NB(r, p)</span>
<span id="cb191-569"><a href="#cb191-569" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-570"><a href="#cb191-570" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-571"><a href="#cb191-571" aria-hidden="true" tabindex="-1"></a>P(X = k) = \binom{k + r - 1}{k} (1 - p)^r p^k, \quad k = 0, 1, 2, \ldots</span>
<span id="cb191-572"><a href="#cb191-572" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-573"><a href="#cb191-573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-574"><a href="#cb191-574" aria-hidden="true" tabindex="-1"></a>**Parameters:**  </span>
<span id="cb191-575"><a href="#cb191-575" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$r &gt; 0$ is the number of successes,  </span>
<span id="cb191-576"><a href="#cb191-576" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$p \in (0,1)$ is the probability of failure (per trial),  </span>
<span id="cb191-577"><a href="#cb191-577" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$k$ is the number of failures before achieving $r$ successes.</span>
<span id="cb191-578"><a href="#cb191-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-579"><a href="#cb191-579" aria-hidden="true" tabindex="-1"></a>**Mean:** $\mu = r\frac{1-p}{p}$\  </span>
<span id="cb191-580"><a href="#cb191-580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-581"><a href="#cb191-581" aria-hidden="true" tabindex="-1"></a>**Variance:** $\mu + \frac{\mu^2}{r}$, which is **larger than the mean** when r is finite.</span>
<span id="cb191-582"><a href="#cb191-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-583"><a href="#cb191-583" aria-hidden="true" tabindex="-1"></a>This makes it much more flexible than the Poisson for real-world data.</span>
<span id="cb191-584"><a href="#cb191-584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-587"><a href="#cb191-587" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-588"><a href="#cb191-588" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: noisy_ts_negbin_plot</span></span>
<span id="cb191-589"><a href="#cb191-589" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">102938</span>)</span>
<span id="cb191-590"><a href="#cb191-590" aria-hidden="true" tabindex="-1"></a>size <span class="ot">&lt;-</span> <span class="dv">5</span>    <span class="co"># dispersion parameter (higher = closer to Poisson)</span></span>
<span id="cb191-591"><a href="#cb191-591" aria-hidden="true" tabindex="-1"></a>mu   <span class="ot">&lt;-</span> <span class="dv">2</span>    <span class="co"># mean of noise</span></span>
<span id="cb191-592"><a href="#cb191-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-593"><a href="#cb191-593" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&lt;&gt;%</span></span>
<span id="cb191-594"><a href="#cb191-594" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">noi_nb =</span> <span class="fu">rnbinom</span>(<span class="fu">nrow</span>(df_sea), <span class="at">size =</span> size, <span class="at">mu =</span> mu),</span>
<span id="cb191-595"><a href="#cb191-595" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_lin_nb =</span> yd_lin <span class="sc">+</span> noi_nb,</span>
<span id="cb191-596"><a href="#cb191-596" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_exp_nb =</span> (start_ts <span class="sc">+</span> sea <span class="sc">+</span> noi_nb) <span class="sc">*</span> <span class="fu">exp</span>(<span class="fl">0.1</span> <span class="sc">/</span> <span class="dv">365</span>)<span class="sc">^</span><span class="fu">row_number</span>())</span>
<span id="cb191-597"><a href="#cb191-597" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-598"><a href="#cb191-598" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&gt;%</span> </span>
<span id="cb191-599"><a href="#cb191-599" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(tr_lin, tr_exp, y_lin_nb, y_exp_nb), </span>
<span id="cb191-600"><a href="#cb191-600" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">"func"</span>, <span class="st">"method"</span>), </span>
<span id="cb191-601"><a href="#cb191-601" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_sep =</span> <span class="st">"_"</span>, </span>
<span id="cb191-602"><a href="#cb191-602" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb191-603"><a href="#cb191-603" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">func =</span> <span class="fu">factor</span>(func, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"y"</span>, <span class="st">"tr"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb191-604"><a href="#cb191-604" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb191-605"><a href="#cb191-605" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb191-606"><a href="#cb191-606" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> method,</span>
<span id="cb191-607"><a href="#cb191-607" aria-hidden="true" tabindex="-1"></a>                  <span class="at">linetype =</span> func),</span>
<span id="cb191-608"><a href="#cb191-608" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb191-609"><a href="#cb191-609" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Additive Negative Binomial Noise"</span>,</span>
<span id="cb191-610"><a href="#cb191-610" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Value"</span>, <span class="at">x =</span> <span class="st">"Date"</span>)</span>
<span id="cb191-611"><a href="#cb191-611" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-612"><a href="#cb191-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-613"><a href="#cb191-613" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-614"><a href="#cb191-614" aria-hidden="true" tabindex="-1"></a><span class="fu">### Gamma noise</span></span>
<span id="cb191-615"><a href="#cb191-615" aria-hidden="true" tabindex="-1"></a>Gamma and Log-Normal are popular for modeling **positive continuous noise**—especially when counts or demand cannot be negative and may have **skewness**.</span>
<span id="cb191-616"><a href="#cb191-616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-617"><a href="#cb191-617" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> style</span><span class="op">=</span><span class="st">"text-align: center;"</span><span class="dt">&gt;</span></span>
<span id="cb191-618"><a href="#cb191-618" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">img</span><span class="ot"> src</span><span class="op">=</span><span class="st">"/images/gamma_distribution_pdf.png"</span><span class="ot"> alt</span><span class="op">=</span><span class="st">"Gamma Distribution"</span><span class="ot"> width</span><span class="op">=</span><span class="st">"75%"</span><span class="dt">&gt;</span></span>
<span id="cb191-619"><a href="#cb191-619" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb191-620"><a href="#cb191-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-621"><a href="#cb191-621" aria-hidden="true" tabindex="-1"></a>**Distribution:**  </span>
<span id="cb191-622"><a href="#cb191-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-623"><a href="#cb191-623" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-624"><a href="#cb191-624" aria-hidden="true" tabindex="-1"></a>f(x; k, \theta) = </span>
<span id="cb191-625"><a href="#cb191-625" aria-hidden="true" tabindex="-1"></a>\frac{1}{\Gamma(k)\,\theta^{k}}\,x^{k - 1} e^{-x / \theta}, </span>
<span id="cb191-626"><a href="#cb191-626" aria-hidden="true" tabindex="-1"></a>\quad x &gt; 0</span>
<span id="cb191-627"><a href="#cb191-627" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-628"><a href="#cb191-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-629"><a href="#cb191-629" aria-hidden="true" tabindex="-1"></a>**Parameters:** **shape** $k$, **scale** $\theta$, and $\Gamma(k)$ is the Gamma function defined as  </span>
<span id="cb191-630"><a href="#cb191-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-631"><a href="#cb191-631" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-632"><a href="#cb191-632" aria-hidden="true" tabindex="-1"></a>\Gamma(k) = \int_0^\infty t^{k - 1} e^{-t} dt</span>
<span id="cb191-633"><a href="#cb191-633" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-634"><a href="#cb191-634" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-635"><a href="#cb191-635" aria-hidden="true" tabindex="-1"></a>**Mean:**  </span>
<span id="cb191-636"><a href="#cb191-636" aria-hidden="true" tabindex="-1"></a>$kθ$</span>
<span id="cb191-637"><a href="#cb191-637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-638"><a href="#cb191-638" aria-hidden="true" tabindex="-1"></a>**Variance:**  </span>
<span id="cb191-639"><a href="#cb191-639" aria-hidden="true" tabindex="-1"></a>$kθ^2$</span>
<span id="cb191-640"><a href="#cb191-640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-641"><a href="#cb191-641" aria-hidden="true" tabindex="-1"></a>**Notes:**  </span>
<span id="cb191-642"><a href="#cb191-642" aria-hidden="true" tabindex="-1"></a>Often used for modeling **waiting times** or **non-negative skewed demand**.</span>
<span id="cb191-643"><a href="#cb191-643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-646"><a href="#cb191-646" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-647"><a href="#cb191-647" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: noisy_ts_gamma_plot</span></span>
<span id="cb191-648"><a href="#cb191-648" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">102938</span>)</span>
<span id="cb191-649"><a href="#cb191-649" aria-hidden="true" tabindex="-1"></a>shape_gamma <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb191-650"><a href="#cb191-650" aria-hidden="true" tabindex="-1"></a>scale_gamma <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb191-651"><a href="#cb191-651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-652"><a href="#cb191-652" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&lt;&gt;%</span></span>
<span id="cb191-653"><a href="#cb191-653" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">noi_gamma =</span> <span class="fu">rgamma</span>(<span class="fu">nrow</span>(df_sea), <span class="at">shape =</span> shape_gamma, <span class="at">scale =</span> scale_gamma),</span>
<span id="cb191-654"><a href="#cb191-654" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_lin_gamma =</span> yd_lin <span class="sc">+</span> noi_gamma,</span>
<span id="cb191-655"><a href="#cb191-655" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_exp_gamma =</span> (start_ts <span class="sc">+</span> sea <span class="sc">+</span> noi_gamma) <span class="sc">*</span> <span class="fu">exp</span>(<span class="fl">0.1</span> <span class="sc">/</span> <span class="dv">365</span>)<span class="sc">^</span><span class="fu">row_number</span>())</span>
<span id="cb191-656"><a href="#cb191-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-657"><a href="#cb191-657" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&gt;%</span> </span>
<span id="cb191-658"><a href="#cb191-658" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(tr_lin, tr_exp, y_lin_gamma, y_exp_gamma), </span>
<span id="cb191-659"><a href="#cb191-659" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">"func"</span>, <span class="st">"method"</span>), </span>
<span id="cb191-660"><a href="#cb191-660" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_sep =</span> <span class="st">"_"</span>, </span>
<span id="cb191-661"><a href="#cb191-661" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb191-662"><a href="#cb191-662" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">func =</span> <span class="fu">factor</span>(func, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"y"</span>, <span class="st">"tr"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb191-663"><a href="#cb191-663" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb191-664"><a href="#cb191-664" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb191-665"><a href="#cb191-665" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> method,</span>
<span id="cb191-666"><a href="#cb191-666" aria-hidden="true" tabindex="-1"></a>                  <span class="at">linetype =</span> func),</span>
<span id="cb191-667"><a href="#cb191-667" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb191-668"><a href="#cb191-668" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Additive Gamma Noise"</span>,</span>
<span id="cb191-669"><a href="#cb191-669" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Value"</span>, <span class="at">x =</span> <span class="st">"Date"</span>)</span>
<span id="cb191-670"><a href="#cb191-670" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-671"><a href="#cb191-671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-672"><a href="#cb191-672" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-673"><a href="#cb191-673" aria-hidden="true" tabindex="-1"></a><span class="fu">### Log-Normal noise</span></span>
<span id="cb191-674"><a href="#cb191-674" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-675"><a href="#cb191-675" aria-hidden="true" tabindex="-1"></a>A **strictly positive**, **skewed** distribution.</span>
<span id="cb191-676"><a href="#cb191-676" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-677"><a href="#cb191-677" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> style</span><span class="op">=</span><span class="st">"text-align: center;"</span><span class="dt">&gt;</span></span>
<span id="cb191-678"><a href="#cb191-678" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">img</span><span class="ot"> src</span><span class="op">=</span><span class="st">"/images/log_normal_distribution.png"</span><span class="ot"> alt</span><span class="op">=</span><span class="st">"Log-normal Distribution"</span><span class="ot"> width</span><span class="op">=</span><span class="st">"75%"</span><span class="dt">&gt;</span></span>
<span id="cb191-679"><a href="#cb191-679" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb191-680"><a href="#cb191-680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-681"><a href="#cb191-681" aria-hidden="true" tabindex="-1"></a>**Distribution:**  </span>
<span id="cb191-682"><a href="#cb191-682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-683"><a href="#cb191-683" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-684"><a href="#cb191-684" aria-hidden="true" tabindex="-1"></a>f(x; \mu, \sigma) = </span>
<span id="cb191-685"><a href="#cb191-685" aria-hidden="true" tabindex="-1"></a>\frac{1}{x\,\sigma\,\sqrt{2\pi}} </span>
<span id="cb191-686"><a href="#cb191-686" aria-hidden="true" tabindex="-1"></a>\exp\left( -\frac{(\ln x - \mu)^2}{2\sigma^2} \right),</span>
<span id="cb191-687"><a href="#cb191-687" aria-hidden="true" tabindex="-1"></a>\quad x &gt; 0</span>
<span id="cb191-688"><a href="#cb191-688" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-689"><a href="#cb191-689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-690"><a href="#cb191-690" aria-hidden="true" tabindex="-1"></a>**Parameters:** log-mean $\mu$, log-standard deviation $\sigma$  </span>
<span id="cb191-691"><a href="#cb191-691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-692"><a href="#cb191-692" aria-hidden="true" tabindex="-1"></a>**Mean:**  </span>
<span id="cb191-693"><a href="#cb191-693" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-694"><a href="#cb191-694" aria-hidden="true" tabindex="-1"></a>\ E(X) = exp(\mu + \sigma^2 / 2)</span>
<span id="cb191-695"><a href="#cb191-695" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-696"><a href="#cb191-696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-697"><a href="#cb191-697" aria-hidden="true" tabindex="-1"></a>**Variance:**  </span>
<span id="cb191-698"><a href="#cb191-698" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-699"><a href="#cb191-699" aria-hidden="true" tabindex="-1"></a>Var(X) = (\exp(\sigma^2) - 1) \exp(2\mu + \sigma^2)</span>
<span id="cb191-700"><a href="#cb191-700" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-701"><a href="#cb191-701" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-702"><a href="#cb191-702" aria-hidden="true" tabindex="-1"></a>**Notes:**  </span>
<span id="cb191-703"><a href="#cb191-703" aria-hidden="true" tabindex="-1"></a>Often used when noise **multiplicatively affects the signal**.</span>
<span id="cb191-704"><a href="#cb191-704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-707"><a href="#cb191-707" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-708"><a href="#cb191-708" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: noisy_ts_lognorm_plot</span></span>
<span id="cb191-709"><a href="#cb191-709" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">102938</span>)</span>
<span id="cb191-710"><a href="#cb191-710" aria-hidden="true" tabindex="-1"></a>mu_lognorm <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb191-711"><a href="#cb191-711" aria-hidden="true" tabindex="-1"></a>sigma_lognorm <span class="ot">&lt;-</span> <span class="fl">0.3</span></span>
<span id="cb191-712"><a href="#cb191-712" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-713"><a href="#cb191-713" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&lt;&gt;%</span></span>
<span id="cb191-714"><a href="#cb191-714" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">noi_lognorm =</span> <span class="fu">rlnorm</span>(<span class="fu">nrow</span>(df_sea), <span class="at">meanlog =</span> mu_lognorm, <span class="at">sdlog =</span> sigma_lognorm),</span>
<span id="cb191-715"><a href="#cb191-715" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_lin_lognorm =</span> yd_lin <span class="sc">+</span> noi_lognorm,</span>
<span id="cb191-716"><a href="#cb191-716" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_exp_lognorm =</span> (start_ts <span class="sc">+</span> sea <span class="sc">+</span> noi_lognorm) <span class="sc">*</span> <span class="fu">exp</span>(<span class="fl">0.1</span> <span class="sc">/</span> <span class="dv">365</span>)<span class="sc">^</span><span class="fu">row_number</span>())</span>
<span id="cb191-717"><a href="#cb191-717" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-718"><a href="#cb191-718" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&gt;%</span> </span>
<span id="cb191-719"><a href="#cb191-719" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(tr_lin, tr_exp, y_lin_lognorm, y_exp_lognorm), </span>
<span id="cb191-720"><a href="#cb191-720" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">"func"</span>, <span class="st">"method"</span>), </span>
<span id="cb191-721"><a href="#cb191-721" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_sep =</span> <span class="st">"_"</span>, </span>
<span id="cb191-722"><a href="#cb191-722" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb191-723"><a href="#cb191-723" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">func =</span> <span class="fu">factor</span>(func, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"y"</span>, <span class="st">"tr"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb191-724"><a href="#cb191-724" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb191-725"><a href="#cb191-725" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb191-726"><a href="#cb191-726" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> method,</span>
<span id="cb191-727"><a href="#cb191-727" aria-hidden="true" tabindex="-1"></a>                  <span class="at">linetype =</span> func),</span>
<span id="cb191-728"><a href="#cb191-728" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb191-729"><a href="#cb191-729" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Additive Log-Normal Noise"</span>,</span>
<span id="cb191-730"><a href="#cb191-730" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Value"</span>, <span class="at">x =</span> <span class="st">"Date"</span>)</span>
<span id="cb191-731"><a href="#cb191-731" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-732"><a href="#cb191-732" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-733"><a href="#cb191-733" aria-hidden="true" tabindex="-1"></a><span class="fu"># TS noise modelling</span></span>
<span id="cb191-734"><a href="#cb191-734" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-735"><a href="#cb191-735" aria-hidden="true" tabindex="-1"></a><span class="fu">## Review of the additive model</span></span>
<span id="cb191-736"><a href="#cb191-736" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-737"><a href="#cb191-737" aria-hidden="true" tabindex="-1"></a>We re-use the synthetic data from last week, which follows an **additive decomposition** of the form:</span>
<span id="cb191-738"><a href="#cb191-738" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-739"><a href="#cb191-739" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-740"><a href="#cb191-740" aria-hidden="true" tabindex="-1"></a>y(t) = tr(t) + s(t) + \epsilon_t</span>
<span id="cb191-741"><a href="#cb191-741" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-742"><a href="#cb191-742" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-743"><a href="#cb191-743" aria-hidden="true" tabindex="-1"></a><span class="fu">### Load the data</span></span>
<span id="cb191-744"><a href="#cb191-744" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-747"><a href="#cb191-747" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-748"><a href="#cb191-748" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: load-df-ts1</span></span>
<span id="cb191-749"><a href="#cb191-749" aria-hidden="true" tabindex="-1"></a>data_dir <span class="ot">&lt;-</span> <span class="st">"./data"</span></span>
<span id="cb191-750"><a href="#cb191-750" aria-hidden="true" tabindex="-1"></a>fpath_df_ts1 <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{data_dir}/synthetic_TS_01.tsv"</span>)</span>
<span id="cb191-751"><a href="#cb191-751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-752"><a href="#cb191-752" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="ot">&lt;-</span> </span>
<span id="cb191-753"><a href="#cb191-753" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_tsv</span>(fpath_df_ts1) <span class="sc">%&gt;%</span></span>
<span id="cb191-754"><a href="#cb191-754" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(day, mon, sea, tr_lin, yd_lin, noi, y_lin) <span class="sc">%&gt;%</span></span>
<span id="cb191-755"><a href="#cb191-755" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">tr =</span> tr_lin, <span class="at">yd =</span> yd_lin, <span class="at">y =</span> y_lin) <span class="sc">%&gt;%</span></span>
<span id="cb191-756"><a href="#cb191-756" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">year</span>(day)) <span class="sc">%&gt;%</span></span>
<span id="cb191-757"><a href="#cb191-757" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(year)</span>
<span id="cb191-758"><a href="#cb191-758" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-759"><a href="#cb191-759" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-760"><a href="#cb191-760" aria-hidden="true" tabindex="-1"></a><span class="fu">### Trend component</span></span>
<span id="cb191-761"><a href="#cb191-761" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-762"><a href="#cb191-762" aria-hidden="true" tabindex="-1"></a>The trend is modeled as a linear function of time:</span>
<span id="cb191-763"><a href="#cb191-763" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-764"><a href="#cb191-764" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-765"><a href="#cb191-765" aria-hidden="true" tabindex="-1"></a>tr(t) = y_0 + \alpha.\frac{t}{365}</span>
<span id="cb191-766"><a href="#cb191-766" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-767"><a href="#cb191-767" aria-hidden="true" tabindex="-1"></a>We can recover the parameters $y_0$ (intercept) and $\alpha$ (slope) as follows:</span>
<span id="cb191-768"><a href="#cb191-768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-771"><a href="#cb191-771" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-772"><a href="#cb191-772" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: recover-trend-params</span></span>
<span id="cb191-773"><a href="#cb191-773" aria-hidden="true" tabindex="-1"></a>y0_o   <span class="ot">&lt;-</span> df_ts1<span class="sc">$</span>tr[<span class="dv">1</span>] <span class="sc">%&gt;%</span> round</span>
<span id="cb191-774"><a href="#cb191-774" aria-hidden="true" tabindex="-1"></a>alfa_o <span class="ot">&lt;-</span> df_ts1<span class="sc">$</span>tr[<span class="dv">366</span>] <span class="sc">-</span> df_ts1<span class="sc">$</span>tr[<span class="dv">1</span>]</span>
<span id="cb191-775"><a href="#cb191-775" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-776"><a href="#cb191-776" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-777"><a href="#cb191-777" aria-hidden="true" tabindex="-1"></a>Hence  </span>
<span id="cb191-778"><a href="#cb191-778" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$y_0 =$ <span class="in">`r y0_o`</span>.  </span>
<span id="cb191-779"><a href="#cb191-779" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\alpha =$ <span class="in">`r alfa_o`</span></span>
<span id="cb191-780"><a href="#cb191-780" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-781"><a href="#cb191-781" aria-hidden="true" tabindex="-1"></a><span class="fu">### Seasonal component</span></span>
<span id="cb191-782"><a href="#cb191-782" aria-hidden="true" tabindex="-1"></a>The seasonality is defined by a smooth repeating curve, shown below for the first year:</span>
<span id="cb191-783"><a href="#cb191-783" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-786"><a href="#cb191-786" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-787"><a href="#cb191-787" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: plot-sea-actual</span></span>
<span id="cb191-788"><a href="#cb191-788" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb191-789"><a href="#cb191-789" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">==</span> <span class="fu">min</span>(<span class="fu">as.numeric</span>(<span class="fu">as.character</span>(year)))) <span class="sc">%&gt;%</span></span>
<span id="cb191-790"><a href="#cb191-790" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> sea)) <span class="sc">+</span></span>
<span id="cb191-791"><a href="#cb191-791" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb191-792"><a href="#cb191-792" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Seasonal Component (First Year)"</span>,</span>
<span id="cb191-793"><a href="#cb191-793" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Day"</span>, <span class="at">y =</span> <span class="st">"Seasonal Effect"</span>)</span>
<span id="cb191-794"><a href="#cb191-794" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-795"><a href="#cb191-795" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-796"><a href="#cb191-796" aria-hidden="true" tabindex="-1"></a><span class="fu">### Original time series</span></span>
<span id="cb191-797"><a href="#cb191-797" aria-hidden="true" tabindex="-1"></a>The full modeled series, including the original Gaussian noise, is shown below:</span>
<span id="cb191-798"><a href="#cb191-798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-801"><a href="#cb191-801" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-802"><a href="#cb191-802" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: plot-df-ts1</span></span>
<span id="cb191-803"><a href="#cb191-803" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span> </span>
<span id="cb191-804"><a href="#cb191-804" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day)) <span class="sc">+</span></span>
<span id="cb191-805"><a href="#cb191-805" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> y), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb191-806"><a href="#cb191-806" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> yd), <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb191-807"><a href="#cb191-807" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb191-808"><a href="#cb191-808" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Synthetic Time Series with Gaussian Noise"</span>,</span>
<span id="cb191-809"><a href="#cb191-809" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Day"</span>, <span class="at">y =</span> <span class="st">"Value"</span>)</span>
<span id="cb191-810"><a href="#cb191-810" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-811"><a href="#cb191-811" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-812"><a href="#cb191-812" aria-hidden="true" tabindex="-1"></a>Note that normal noise may be inappropriate for _count-type data_, since it can generate negative forecasts—an issue that motivates the following noise models.</span>
<span id="cb191-813"><a href="#cb191-813" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-814"><a href="#cb191-814" aria-hidden="true" tabindex="-1"></a><span class="fu">## Noise with constant rate</span></span>
<span id="cb191-815"><a href="#cb191-815" aria-hidden="true" tabindex="-1"></a>Let the noise follow a Poisson distribution with constant rate $\lambda_0 = 2$</span>
<span id="cb191-816"><a href="#cb191-816" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-817"><a href="#cb191-817" aria-hidden="true" tabindex="-1"></a>Because the Poisson mean equals its variance, we re-center the generated noise to preserve a mean of zero and avoid negative forecasts.</span>
<span id="cb191-818"><a href="#cb191-818" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-821"><a href="#cb191-821" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-822"><a href="#cb191-822" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: generate-constant-pois-noise</span></span>
<span id="cb191-823"><a href="#cb191-823" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2831</span>)</span>
<span id="cb191-824"><a href="#cb191-824" aria-hidden="true" tabindex="-1"></a>lam_0 <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb191-825"><a href="#cb191-825" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-826"><a href="#cb191-826" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb191-827"><a href="#cb191-827" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">noi_cnst =</span> <span class="fu">rpois</span>(<span class="at">n =</span> <span class="fu">nrow</span>(.), <span class="at">lambda =</span> lam_0) <span class="sc">-</span> <span class="fu">min</span>(<span class="fu">c</span>(lam_0, <span class="fu">min</span>(yd))),</span>
<span id="cb191-828"><a href="#cb191-828" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_1 =</span> yd <span class="sc">+</span> noi_cnst)</span>
<span id="cb191-829"><a href="#cb191-829" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-830"><a href="#cb191-830" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">|&gt;</span></span>
<span id="cb191-831"><a href="#cb191-831" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day)) <span class="sc">+</span></span>
<span id="cb191-832"><a href="#cb191-832" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> y_1), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb191-833"><a href="#cb191-833" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> yd), <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb191-834"><a href="#cb191-834" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb191-835"><a href="#cb191-835" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Time Series with Constant-Rate Poisson Noise"</span>,</span>
<span id="cb191-836"><a href="#cb191-836" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Day"</span>, <span class="at">y =</span> <span class="st">"Value"</span>)</span>
<span id="cb191-837"><a href="#cb191-837" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-838"><a href="#cb191-838" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-839"><a href="#cb191-839" aria-hidden="true" tabindex="-1"></a><span class="fu">## Noise with proportional rate</span></span>
<span id="cb191-840"><a href="#cb191-840" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-841"><a href="#cb191-841" aria-hidden="true" tabindex="-1"></a>In many real-world processes, **noise magnitude increases with the signal level**. This can be the case for sales, demand, or production volumes, where fluctuations scale with the size of operations.</span>
<span id="cb191-842"><a href="#cb191-842" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-843"><a href="#cb191-843" aria-hidden="true" tabindex="-1"></a>For example:\</span>
<span id="cb191-844"><a href="#cb191-844" aria-hidden="true" tabindex="-1"></a>If one trailer delivery is missed due to a strike when demand is low, a tenfold demand would imply a missed delivery of ten trailers — illustrating proportional noise.</span>
<span id="cb191-845"><a href="#cb191-845" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-846"><a href="#cb191-846" aria-hidden="true" tabindex="-1"></a><span class="fu">### Additive interpretation</span></span>
<span id="cb191-847"><a href="#cb191-847" aria-hidden="true" tabindex="-1"></a>We can still express the model additively as:</span>
<span id="cb191-848"><a href="#cb191-848" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-849"><a href="#cb191-849" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-850"><a href="#cb191-850" aria-hidden="true" tabindex="-1"></a>y(t) = tr(t) + s(t) + \epsilon_t</span>
<span id="cb191-851"><a href="#cb191-851" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-852"><a href="#cb191-852" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-853"><a href="#cb191-853" aria-hidden="true" tabindex="-1"></a>where  </span>
<span id="cb191-854"><a href="#cb191-854" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-855"><a href="#cb191-855" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-856"><a href="#cb191-856" aria-hidden="true" tabindex="-1"></a>\epsilon_t \sim \mathrm{Pois}(\lambda_t), \quad \lambda_t \propto y_t^{\text{(d)}} = tr(t) + s(t)</span>
<span id="cb191-857"><a href="#cb191-857" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-858"><a href="#cb191-858" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-859"><a href="#cb191-859" aria-hidden="true" tabindex="-1"></a><span class="fu">### Multiplicative equivalence</span></span>
<span id="cb191-860"><a href="#cb191-860" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-861"><a href="#cb191-861" aria-hidden="true" tabindex="-1"></a>This is equivalent to a multiplicative noise model:</span>
<span id="cb191-862"><a href="#cb191-862" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-863"><a href="#cb191-863" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-864"><a href="#cb191-864" aria-hidden="true" tabindex="-1"></a>y(t) = (tr(t) + s(t)).\eta_t</span>
<span id="cb191-865"><a href="#cb191-865" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-866"><a href="#cb191-866" aria-hidden="true" tabindex="-1"></a>where $\eta_t$ is a Poisson-like random multiplier with constant mean.</span>
<span id="cb191-867"><a href="#cb191-867" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb191-868"><a href="#cb191-868" aria-hidden="true" tabindex="-1"></a><span class="fu">### Implementation</span></span>
<span id="cb191-869"><a href="#cb191-869" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-870"><a href="#cb191-870" aria-hidden="true" tabindex="-1"></a>We simulate proportional noise with a constant scaling factor $c_\lambda = 0.4$:</span>
<span id="cb191-871"><a href="#cb191-871" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-874"><a href="#cb191-874" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-875"><a href="#cb191-875" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: generate-proportional-pois-noise</span></span>
<span id="cb191-876"><a href="#cb191-876" aria-hidden="true" tabindex="-1"></a>const_lam <span class="ot">&lt;-</span> <span class="fl">0.4</span></span>
<span id="cb191-877"><a href="#cb191-877" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-878"><a href="#cb191-878" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123098</span>)</span>
<span id="cb191-879"><a href="#cb191-879" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb191-880"><a href="#cb191-880" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">lam      =</span> const_lam <span class="sc">*</span> yd,</span>
<span id="cb191-881"><a href="#cb191-881" aria-hidden="true" tabindex="-1"></a>         <span class="at">noi_prop =</span> <span class="fu">map_dbl</span>(lam, <span class="sc">~</span> <span class="fu">rpois</span>(<span class="dv">1</span>, <span class="at">lambda =</span> .x) <span class="sc">-</span> .x),</span>
<span id="cb191-882"><a href="#cb191-882" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_2      =</span> yd <span class="sc">+</span> noi_prop)</span>
<span id="cb191-883"><a href="#cb191-883" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-884"><a href="#cb191-884" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb191-885"><a href="#cb191-885" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(day, yd, y_1, y_2) <span class="sc">%&gt;%</span></span>
<span id="cb191-886"><a href="#cb191-886" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb191-887"><a href="#cb191-887" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(y_1, y_2),</span>
<span id="cb191-888"><a href="#cb191-888" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"method"</span>,</span>
<span id="cb191-889"><a href="#cb191-889" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"TS_value"</span></span>
<span id="cb191-890"><a href="#cb191-890" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb191-891"><a href="#cb191-891" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">method =</span> <span class="fu">recode</span>(</span>
<span id="cb191-892"><a href="#cb191-892" aria-hidden="true" tabindex="-1"></a>    method,</span>
<span id="cb191-893"><a href="#cb191-893" aria-hidden="true" tabindex="-1"></a>    <span class="at">y_1 =</span> <span class="st">"Constant-rate Poisson noise"</span>,</span>
<span id="cb191-894"><a href="#cb191-894" aria-hidden="true" tabindex="-1"></a>    <span class="at">y_2 =</span> <span class="st">"Proportional-rate Poisson noise"</span></span>
<span id="cb191-895"><a href="#cb191-895" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb191-896"><a href="#cb191-896" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> TS_value)) <span class="sc">+</span></span>
<span id="cb191-897"><a href="#cb191-897" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> method), <span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb191-898"><a href="#cb191-898" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> yd), <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb191-899"><a href="#cb191-899" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb191-900"><a href="#cb191-900" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> method, <span class="at">ncol =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb191-901"><a href="#cb191-901" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb191-902"><a href="#cb191-902" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Constant vs Proportional Poisson Noise"</span>,</span>
<span id="cb191-903"><a href="#cb191-903" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Day"</span>,</span>
<span id="cb191-904"><a href="#cb191-904" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Value"</span></span>
<span id="cb191-905"><a href="#cb191-905" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb191-906"><a href="#cb191-906" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb191-907"><a href="#cb191-907" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-908"><a href="#cb191-908" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-909"><a href="#cb191-909" aria-hidden="true" tabindex="-1"></a><span class="fu">### Interpretation</span></span>
<span id="cb191-910"><a href="#cb191-910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-911"><a href="#cb191-911" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The constant-rate noise adds fluctuations of fixed variance, independent of the signal.</span>
<span id="cb191-912"><a href="#cb191-912" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The proportional-rate noise scales with the signal amplitude, resembling multiplicative variability commonly seen in business and supply-chain processes.</span>
<span id="cb191-913"><a href="#cb191-913" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-914"><a href="#cb191-914" aria-hidden="true" tabindex="-1"></a><span class="fu">## Analysis</span></span>
<span id="cb191-915"><a href="#cb191-915" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-916"><a href="#cb191-916" aria-hidden="true" tabindex="-1"></a><span class="fu">### Visualizing yearly seasonality</span></span>
<span id="cb191-917"><a href="#cb191-917" aria-hidden="true" tabindex="-1"></a>When we suspect seasonality, such as yearly patterns, it can be insightful to overlay the time series data by year.</span>
<span id="cb191-918"><a href="#cb191-918" aria-hidden="true" tabindex="-1"></a>This allows us to visually compare the dynamics of each year and identify recurring seasonal behaviors.</span>
<span id="cb191-919"><a href="#cb191-919" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-920"><a href="#cb191-920" aria-hidden="true" tabindex="-1"></a><span class="in">```{r overlay-yearly-ts}</span></span>
<span id="cb191-921"><a href="#cb191-921" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb191-922"><a href="#cb191-922" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb191-923"><a href="#cb191-923" aria-hidden="true" tabindex="-1"></a>    <span class="at">year =</span> <span class="fu">factor</span>(<span class="fu">year</span>(day)),</span>
<span id="cb191-924"><a href="#cb191-924" aria-hidden="true" tabindex="-1"></a>    <span class="at">date_no_year =</span> day</span>
<span id="cb191-925"><a href="#cb191-925" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb191-926"><a href="#cb191-926" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(<span class="fu">c</span>(year, date_no_year), <span class="at">.after =</span> day)</span>
<span id="cb191-927"><a href="#cb191-927" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-928"><a href="#cb191-928" aria-hidden="true" tabindex="-1"></a><span class="fu">year</span>(df_ts1<span class="sc">$</span>date_no_year) <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb191-929"><a href="#cb191-929" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-930"><a href="#cb191-930" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb191-931"><a href="#cb191-931" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date_no_year, <span class="at">y =</span> y_2)) <span class="sc">+</span></span>
<span id="cb191-932"><a href="#cb191-932" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> year, <span class="at">color =</span> year), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb191-933"><a href="#cb191-933" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb191-934"><a href="#cb191-934" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Overlay of Yearly Time Series"</span>,</span>
<span id="cb191-935"><a href="#cb191-935" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Day (within year)"</span>,</span>
<span id="cb191-936"><a href="#cb191-936" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Value"</span>,</span>
<span id="cb191-937"><a href="#cb191-937" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Year"</span></span>
<span id="cb191-938"><a href="#cb191-938" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb191-939"><a href="#cb191-939" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-940"><a href="#cb191-940" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-941"><a href="#cb191-941" aria-hidden="true" tabindex="-1"></a>We already observe a recurring yearly pattern, especially toward the end of the year.</span>
<span id="cb191-942"><a href="#cb191-942" aria-hidden="true" tabindex="-1"></a>This suggests a combination of trend and seasonality in the data, which we now aim to analyze more formally.</span>
<span id="cb191-943"><a href="#cb191-943" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-944"><a href="#cb191-944" aria-hidden="true" tabindex="-1"></a><span class="fu">###  Trend analysis</span></span>
<span id="cb191-945"><a href="#cb191-945" aria-hidden="true" tabindex="-1"></a>We begin by estimating the trend component, since it represents the longer-term structure of the series.\</span>
<span id="cb191-946"><a href="#cb191-946" aria-hidden="true" tabindex="-1"></a>Seasonality can then be analyzed more effectively once the trend has been accounted for.</span>
<span id="cb191-947"><a href="#cb191-947" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-948"><a href="#cb191-948" aria-hidden="true" tabindex="-1"></a>We compare different **trend modeling** approaches:</span>
<span id="cb191-949"><a href="#cb191-949" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-950"><a href="#cb191-950" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Linear Trend: the simplest baseline model.</span>
<span id="cb191-951"><a href="#cb191-951" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Nonlinear Trends using flexible smoothers:</span>
<span id="cb191-952"><a href="#cb191-952" aria-hidden="true" tabindex="-1"></a><span class="ss">  + </span>LOESS (Locally Weighted Scatterplot Smoothing)</span>
<span id="cb191-953"><a href="#cb191-953" aria-hidden="true" tabindex="-1"></a><span class="ss">  + </span>GAM (Generalized Additive Model)</span>
<span id="cb191-954"><a href="#cb191-954" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-955"><a href="#cb191-955" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fitting-yearly-trend}</span></span>
<span id="cb191-956"><a href="#cb191-956" aria-hidden="true" tabindex="-1"></a>loess_span_high <span class="ot">&lt;-</span> <span class="fl">0.75</span></span>
<span id="cb191-957"><a href="#cb191-957" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-958"><a href="#cb191-958" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb191-959"><a href="#cb191-959" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>(<span class="at">data =</span> <span class="sc">-</span>year)  <span class="sc">%&gt;%</span></span>
<span id="cb191-960"><a href="#cb191-960" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb191-961"><a href="#cb191-961" aria-hidden="true" tabindex="-1"></a>    <span class="at">lm_tr =</span> <span class="fu">map</span>(</span>
<span id="cb191-962"><a href="#cb191-962" aria-hidden="true" tabindex="-1"></a>      year,</span>
<span id="cb191-963"><a href="#cb191-963" aria-hidden="true" tabindex="-1"></a>      <span class="sc">~</span> <span class="fu">lm</span>(y_2 <span class="sc">~</span> day, <span class="at">data =</span> df_ts1  <span class="sc">%&gt;%</span> <span class="fu">filter</span>(year <span class="sc">==</span> .x))</span>
<span id="cb191-964"><a href="#cb191-964" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb191-965"><a href="#cb191-965" aria-hidden="true" tabindex="-1"></a>    <span class="at">loes_tr =</span> <span class="fu">map</span>(</span>
<span id="cb191-966"><a href="#cb191-966" aria-hidden="true" tabindex="-1"></a>      year,</span>
<span id="cb191-967"><a href="#cb191-967" aria-hidden="true" tabindex="-1"></a>      <span class="sc">~</span> <span class="fu">loess</span>(y_2 <span class="sc">~</span> <span class="fu">as.numeric</span>(day),</span>
<span id="cb191-968"><a href="#cb191-968" aria-hidden="true" tabindex="-1"></a>              <span class="at">data =</span> df_ts1  <span class="sc">%&gt;%</span> <span class="fu">filter</span>(year <span class="sc">==</span> .x),</span>
<span id="cb191-969"><a href="#cb191-969" aria-hidden="true" tabindex="-1"></a>              <span class="at">span =</span> loess_span_high)</span>
<span id="cb191-970"><a href="#cb191-970" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb191-971"><a href="#cb191-971" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">map2</span>(data, lm_tr, <span class="sc">~</span> <span class="fu">mutate</span>(.x, <span class="at">try_lm =</span> .y<span class="sc">$</span>fitted)),</span>
<span id="cb191-972"><a href="#cb191-972" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">map2</span>(data, loes_tr, <span class="sc">~</span> <span class="fu">mutate</span>(.x, <span class="at">try_lo =</span> .y<span class="sc">$</span>fitted))</span>
<span id="cb191-973"><a href="#cb191-973" aria-hidden="true" tabindex="-1"></a>  )  <span class="sc">%&gt;%</span></span>
<span id="cb191-974"><a href="#cb191-974" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(lm_tr, loes_tr))  <span class="sc">%&gt;%</span></span>
<span id="cb191-975"><a href="#cb191-975" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(data)</span>
<span id="cb191-976"><a href="#cb191-976" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-977"><a href="#cb191-977" aria-hidden="true" tabindex="-1"></a>df_ts1  <span class="sc">%&gt;%</span></span>
<span id="cb191-978"><a href="#cb191-978" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date_no_year, <span class="at">y =</span> y_2)) <span class="sc">+</span></span>
<span id="cb191-979"><a href="#cb191-979" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> year, <span class="at">color =</span> year), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb191-980"><a href="#cb191-980" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> try_lm, <span class="at">group =</span> year), <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb191-981"><a href="#cb191-981" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> try_lo, <span class="at">group =</span> year), <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb191-982"><a href="#cb191-982" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb191-983"><a href="#cb191-983" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Yearly Trend Fitting: Linear (Blue) vs LOESS (Red)"</span>,</span>
<span id="cb191-984"><a href="#cb191-984" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Day (within year)"</span>,</span>
<span id="cb191-985"><a href="#cb191-985" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Value"</span>,</span>
<span id="cb191-986"><a href="#cb191-986" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Year"</span></span>
<span id="cb191-987"><a href="#cb191-987" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb191-988"><a href="#cb191-988" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-989"><a href="#cb191-989" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-990"><a href="#cb191-990" aria-hidden="true" tabindex="-1"></a>Here,</span>
<span id="cb191-991"><a href="#cb191-991" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-992"><a href="#cb191-992" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Blue lines represent the fitted linear trends, and</span>
<span id="cb191-993"><a href="#cb191-993" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Red curves show the LOESS-smoothed trends (with span = <span class="in">`r loess_span_high`</span>).</span>
<span id="cb191-994"><a href="#cb191-994" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-995"><a href="#cb191-995" aria-hidden="true" tabindex="-1"></a>We see a reasonable degree of consistency across years, though some discrepancies appear in incomplete years (e.g., 2025).\</span>
<span id="cb191-996"><a href="#cb191-996" aria-hidden="true" tabindex="-1"></a>However, analyzing each year independently is not ideal for identifying the overall trend, since the yearly boundaries do not necessarily align smoothly from one year to the next.</span>
<span id="cb191-997"><a href="#cb191-997" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-998"><a href="#cb191-998" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Continuous trend estimation</span></span>
<span id="cb191-999"><a href="#cb191-999" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1000"><a href="#cb191-1000" aria-hidden="true" tabindex="-1"></a>To capture a coherent view of the long-term evolution, we re-estimate the trend over the entire time span.</span>
<span id="cb191-1001"><a href="#cb191-1001" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1002"><a href="#cb191-1002" aria-hidden="true" tabindex="-1"></a>We compare:</span>
<span id="cb191-1003"><a href="#cb191-1003" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1004"><a href="#cb191-1004" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Linear trend (black)</span>
<span id="cb191-1005"><a href="#cb191-1005" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>LOESS smoothing with:</span>
<span id="cb191-1006"><a href="#cb191-1006" aria-hidden="true" tabindex="-1"></a><span class="ss">  + </span>Medium span (<span class="in">`0.5`</span>) — blue curve</span>
<span id="cb191-1007"><a href="#cb191-1007" aria-hidden="true" tabindex="-1"></a><span class="ss">  + </span>Low span (<span class="in">`0.1`</span>) — red curve</span>
<span id="cb191-1008"><a href="#cb191-1008" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>GAM smoothing (dark green), with automatic smoothing and confidence bands</span>
<span id="cb191-1009"><a href="#cb191-1009" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1010"><a href="#cb191-1010" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-overoll-smoothing}</span></span>
<span id="cb191-1011"><a href="#cb191-1011" aria-hidden="true" tabindex="-1"></a>loess_span_med  <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb191-1012"><a href="#cb191-1012" aria-hidden="true" tabindex="-1"></a>loess_span_low <span class="ot">&lt;-</span> <span class="fl">0.1</span></span>
<span id="cb191-1013"><a href="#cb191-1013" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1014"><a href="#cb191-1014" aria-hidden="true" tabindex="-1"></a>lm_tr <span class="ot">&lt;-</span> <span class="fu">lm</span>(y_2 <span class="sc">~</span> day, <span class="at">data =</span> df_ts1)</span>
<span id="cb191-1015"><a href="#cb191-1015" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1016"><a href="#cb191-1016" aria-hidden="true" tabindex="-1"></a>lo_tr_1 <span class="ot">&lt;-</span> <span class="fu">loess</span>(y_2 <span class="sc">~</span> <span class="fu">as.numeric</span>(day),</span>
<span id="cb191-1017"><a href="#cb191-1017" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> df_ts1,</span>
<span id="cb191-1018"><a href="#cb191-1018" aria-hidden="true" tabindex="-1"></a>                 <span class="at">span =</span> loess_span_med)</span>
<span id="cb191-1019"><a href="#cb191-1019" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1020"><a href="#cb191-1020" aria-hidden="true" tabindex="-1"></a>lo_tr_2 <span class="ot">&lt;-</span> <span class="fu">loess</span>(y_2 <span class="sc">~</span> <span class="fu">as.numeric</span>(day),</span>
<span id="cb191-1021"><a href="#cb191-1021" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> df_ts1,</span>
<span id="cb191-1022"><a href="#cb191-1022" aria-hidden="true" tabindex="-1"></a>                 <span class="at">span =</span> loess_span_low)</span>
<span id="cb191-1023"><a href="#cb191-1023" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1024"><a href="#cb191-1024" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb191-1025"><a href="#cb191-1025" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb191-1026"><a href="#cb191-1026" aria-hidden="true" tabindex="-1"></a>    <span class="at">tr_lm   =</span> lm_tr<span class="sc">$</span>fitted,</span>
<span id="cb191-1027"><a href="#cb191-1027" aria-hidden="true" tabindex="-1"></a>    <span class="at">tr_lo_1 =</span> lo_tr_1<span class="sc">$</span>fitted,</span>
<span id="cb191-1028"><a href="#cb191-1028" aria-hidden="true" tabindex="-1"></a>    <span class="at">tr_lo_2 =</span> lo_tr_2<span class="sc">$</span>fitted</span>
<span id="cb191-1029"><a href="#cb191-1029" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb191-1030"><a href="#cb191-1030" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1031"><a href="#cb191-1031" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb191-1032"><a href="#cb191-1032" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> y_2)) <span class="sc">+</span></span>
<span id="cb191-1033"><a href="#cb191-1033" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> year, <span class="at">color =</span> year), <span class="at">alpha =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb191-1034"><a href="#cb191-1034" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tr_lm), <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb191-1035"><a href="#cb191-1035" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tr_lo_1), <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">linewidth =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb191-1036"><a href="#cb191-1036" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tr_lo_2), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb191-1037"><a href="#cb191-1037" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"gam"</span>, <span class="at">color =</span> <span class="st">"darkgreen"</span>, <span class="at">linewidth =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb191-1038"><a href="#cb191-1038" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb191-1039"><a href="#cb191-1039" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Global Trend Estimation with Various Smoothers"</span>,</span>
<span id="cb191-1040"><a href="#cb191-1040" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Day"</span>,</span>
<span id="cb191-1041"><a href="#cb191-1041" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Value"</span>,</span>
<span id="cb191-1042"><a href="#cb191-1042" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Year"</span></span>
<span id="cb191-1043"><a href="#cb191-1043" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb191-1044"><a href="#cb191-1044" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1045"><a href="#cb191-1045" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-1046"><a href="#cb191-1046" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1047"><a href="#cb191-1047" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Interpretation</span></span>
<span id="cb191-1048"><a href="#cb191-1048" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1049"><a href="#cb191-1049" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The linear trend (black) provides a clear, interpretable long-term direction and fits the overall data well.</span>
<span id="cb191-1050"><a href="#cb191-1050" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1051"><a href="#cb191-1051" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The LOESS (low span, red) captures short-term fluctuations, overlapping with the seasonal pattern rather than isolating the true trend.</span>
<span id="cb191-1052"><a href="#cb191-1052" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1053"><a href="#cb191-1053" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The LOESS (medium span, blue) and GAM (dark green) curves strike a balance but tend to capture both slow seasonal and trend components simultaneously.</span>
<span id="cb191-1054"><a href="#cb191-1054" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1055"><a href="#cb191-1055" aria-hidden="true" tabindex="-1"></a>Hence, while linear smoothing suffices to characterize the long-term drift, nonlinear smoothers such as LOESS or GAM can help diagnose residual structure — valuable when refining the decomposition into trend, seasonality, and irregular components.</span>
<span id="cb191-1056"><a href="#cb191-1056" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1057"><a href="#cb191-1057" aria-hidden="true" tabindex="-1"></a><span class="fu">### Seasonality</span></span>
<span id="cb191-1058"><a href="#cb191-1058" aria-hidden="true" tabindex="-1"></a>After identifying the trend, the next step is to investigate seasonality.\</span>
<span id="cb191-1059"><a href="#cb191-1059" aria-hidden="true" tabindex="-1"></a>To do this, we can overlay the estimated seasonal curves for each year and look for repeating or shifting patterns.</span>
<span id="cb191-1060"><a href="#cb191-1060" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1061"><a href="#cb191-1061" aria-hidden="true" tabindex="-1"></a><span class="in">```{r seasonlity-curve-yoy}</span></span>
<span id="cb191-1062"><a href="#cb191-1062" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1063"><a href="#cb191-1063" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb191-1064"><a href="#cb191-1064" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date_no_year, <span class="at">y =</span> y_2)) <span class="sc">+</span></span>
<span id="cb191-1065"><a href="#cb191-1065" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> year, <span class="at">color =</span> year), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb191-1066"><a href="#cb191-1066" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tr_lo_2, <span class="at">color =</span> year, <span class="at">group =</span> year))</span>
<span id="cb191-1067"><a href="#cb191-1067" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1068"><a href="#cb191-1068" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-1069"><a href="#cb191-1069" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1070"><a href="#cb191-1070" aria-hidden="true" tabindex="-1"></a>Indeed, there appears to be a **phase shift** across years — that is, the peaks and troughs of the seasonal pattern occur slightly earlier or later depending on the year.</span>
<span id="cb191-1071"><a href="#cb191-1071" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1072"><a href="#cb191-1072" aria-hidden="true" tabindex="-1"></a><span class="fu">#### De-trending and centering seasonality</span></span>
<span id="cb191-1073"><a href="#cb191-1073" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1074"><a href="#cb191-1074" aria-hidden="true" tabindex="-1"></a>To analyze seasonality more clearly, we should first remove the trend component so that the seasonal variation is centered around zero.\</span>
<span id="cb191-1075"><a href="#cb191-1075" aria-hidden="true" tabindex="-1"></a>This can be done by subtracting the estimated trend from the original time series:</span>
<span id="cb191-1076"><a href="#cb191-1076" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1077"><a href="#cb191-1077" aria-hidden="true" tabindex="-1"></a><span class="in">```{r seasonality-minus-trend}</span></span>
<span id="cb191-1078"><a href="#cb191-1078" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1079"><a href="#cb191-1079" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb191-1080"><a href="#cb191-1080" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y_notr =</span> y_2 <span class="sc">-</span> tr_lm)</span>
<span id="cb191-1081"><a href="#cb191-1081" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1082"><a href="#cb191-1082" aria-hidden="true" tabindex="-1"></a>sea_1 <span class="ot">&lt;-</span></span>
<span id="cb191-1083"><a href="#cb191-1083" aria-hidden="true" tabindex="-1"></a>  <span class="fu">loess</span>(df_ts1 <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">day =</span> <span class="fu">as.numeric</span>(day)),</span>
<span id="cb191-1084"><a href="#cb191-1084" aria-hidden="true" tabindex="-1"></a>        <span class="at">formula =</span> y_notr <span class="sc">~</span> day,</span>
<span id="cb191-1085"><a href="#cb191-1085" aria-hidden="true" tabindex="-1"></a>        <span class="at">span =</span> loess_span_low)</span>
<span id="cb191-1086"><a href="#cb191-1086" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1087"><a href="#cb191-1087" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb191-1088"><a href="#cb191-1088" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sea_lo =</span> sea_1<span class="sc">$</span>fitted)</span>
<span id="cb191-1089"><a href="#cb191-1089" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1090"><a href="#cb191-1090" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb191-1091"><a href="#cb191-1091" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date_no_year, <span class="at">y =</span> y_2)) <span class="sc">+</span></span>
<span id="cb191-1092"><a href="#cb191-1092" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> year, <span class="at">color =</span> year), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb191-1093"><a href="#cb191-1093" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> sea_lo, <span class="at">color =</span> year, <span class="at">group =</span> year), <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb191-1094"><a href="#cb191-1094" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tr_lm, <span class="at">group =</span> year, <span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb191-1095"><a href="#cb191-1095" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"black"</span>)</span>
<span id="cb191-1096"><a href="#cb191-1096" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-1097"><a href="#cb191-1097" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1098"><a href="#cb191-1098" aria-hidden="true" tabindex="-1"></a>Once the trend is removed, the seasonal pattern becomes much more evident — confirming the phase shift between years.</span>
<span id="cb191-1099"><a href="#cb191-1099" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1100"><a href="#cb191-1100" aria-hidden="true" tabindex="-1"></a><span class="fu">### Noise extraction</span></span>
<span id="cb191-1101"><a href="#cb191-1101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1102"><a href="#cb191-1102" aria-hidden="true" tabindex="-1"></a>Having decomposed the time series into trend and seasonality, the remaining residual component represents the noise:</span>
<span id="cb191-1103"><a href="#cb191-1103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1104"><a href="#cb191-1104" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-1105"><a href="#cb191-1105" aria-hidden="true" tabindex="-1"></a>y(t) = tr(t) + s(t) + \epsilon_t</span>
<span id="cb191-1106"><a href="#cb191-1106" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-1107"><a href="#cb191-1107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1108"><a href="#cb191-1108" aria-hidden="true" tabindex="-1"></a><span class="in">```{r remove-trend-season-form-ts}</span></span>
<span id="cb191-1109"><a href="#cb191-1109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1110"><a href="#cb191-1110" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb191-1111"><a href="#cb191-1111" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y_noi =</span> y_2 <span class="sc">-</span> tr_lm <span class="sc">-</span> sea_lo)</span>
<span id="cb191-1112"><a href="#cb191-1112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1113"><a href="#cb191-1113" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb191-1114"><a href="#cb191-1114" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> y_noi)) <span class="sc">+</span></span>
<span id="cb191-1115"><a href="#cb191-1115" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb191-1116"><a href="#cb191-1116" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">as_date</span>(<span class="fu">c</span>(<span class="st">"2023-12-31"</span>, <span class="st">"2024-12-31"</span>))) <span class="sc">+</span></span>
<span id="cb191-1117"><a href="#cb191-1117" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>)</span>
<span id="cb191-1118"><a href="#cb191-1118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1119"><a href="#cb191-1119" aria-hidden="true" tabindex="-1"></a>noi_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(df_ts1<span class="sc">$</span>y_noi)</span>
<span id="cb191-1120"><a href="#cb191-1120" aria-hidden="true" tabindex="-1"></a>noi_var  <span class="ot">&lt;-</span> <span class="fu">var</span>(df_ts1<span class="sc">$</span>y_noi)</span>
<span id="cb191-1121"><a href="#cb191-1121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1122"><a href="#cb191-1122" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-1123"><a href="#cb191-1123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1124"><a href="#cb191-1124" aria-hidden="true" tabindex="-1"></a>We find the following centered moments for the noise:</span>
<span id="cb191-1125"><a href="#cb191-1125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1126"><a href="#cb191-1126" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Mean: <span class="in">`r round(noi_mean, digits = 2)`</span></span>
<span id="cb191-1127"><a href="#cb191-1127" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Var: <span class="in">`r round(noi_var, digits = 2)`</span></span>
<span id="cb191-1128"><a href="#cb191-1128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1129"><a href="#cb191-1129" aria-hidden="true" tabindex="-1"></a>The residuals still exhibit some **heteroscedasticity** — the variance is not constant across time.</span>
<span id="cb191-1130"><a href="#cb191-1130" aria-hidden="true" tabindex="-1"></a>For instance, spikes tend to occur near the end of each year, suggesting a link with the seasonal component.</span>
<span id="cb191-1131"><a href="#cb191-1131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1132"><a href="#cb191-1132" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Noise–seasonality interaction</span></span>
<span id="cb191-1133"><a href="#cb191-1133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1134"><a href="#cb191-1134" aria-hidden="true" tabindex="-1"></a>To visualize this interaction, we can overlay the deterministic component (trend + seasonality, shifted to start at zero) onto the noise:</span>
<span id="cb191-1135"><a href="#cb191-1135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1136"><a href="#cb191-1136" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-noise-overlay-seas}</span></span>
<span id="cb191-1137"><a href="#cb191-1137" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb191-1138"><a href="#cb191-1138" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> y_noi)) <span class="sc">+</span></span>
<span id="cb191-1139"><a href="#cb191-1139" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb191-1140"><a href="#cb191-1140" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tr_lm <span class="sc">+</span> sea_lo <span class="sc">-</span> <span class="fu">min</span>(tr_lm))) <span class="sc">+</span></span>
<span id="cb191-1141"><a href="#cb191-1141" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">as_date</span>(<span class="fu">c</span>(<span class="st">"2023-12-31"</span>, <span class="st">"2024-12-31"</span>))) <span class="sc">+</span></span>
<span id="cb191-1142"><a href="#cb191-1142" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>)</span>
<span id="cb191-1143"><a href="#cb191-1143" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-1144"><a href="#cb191-1144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1145"><a href="#cb191-1145" aria-hidden="true" tabindex="-1"></a>We observe a clear correlation between the amplitude of the noise and the level of the deterministic component, indicating that the noise may be multiplicative rather than purely additive.</span>
<span id="cb191-1146"><a href="#cb191-1146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1147"><a href="#cb191-1147" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Noise distribution</span></span>
<span id="cb191-1148"><a href="#cb191-1148" aria-hidden="true" tabindex="-1"></a>For now, we continue under the additive noise assumption.\</span>
<span id="cb191-1149"><a href="#cb191-1149" aria-hidden="true" tabindex="-1"></a>We visualize the noise distribution and overlay a Poisson density with parameter $\lambda = <span class="in">`r round(noi_var, digits = 2)`</span>$:</span>
<span id="cb191-1150"><a href="#cb191-1150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1151"><a href="#cb191-1151" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-noise-histog}</span></span>
<span id="cb191-1152"><a href="#cb191-1152" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb191-1153"><a href="#cb191-1153" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">noi_pois =</span> <span class="fu">dpois</span>(<span class="fu">round</span>(y_noi <span class="sc">+</span> noi_var), <span class="at">lambda =</span> noi_var)) <span class="sc">%&gt;%</span></span>
<span id="cb191-1154"><a href="#cb191-1154" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> y_noi <span class="sc">+</span> noi_var)) <span class="sc">+</span></span>
<span id="cb191-1155"><a href="#cb191-1155" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), <span class="at">bins =</span> <span class="dv">100</span>) <span class="sc">+</span></span>
<span id="cb191-1156"><a href="#cb191-1156" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> noi_pois), <span class="at">color =</span> <span class="st">"red"</span>)</span>
<span id="cb191-1157"><a href="#cb191-1157" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-1158"><a href="#cb191-1158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1159"><a href="#cb191-1159" aria-hidden="true" tabindex="-1"></a>The histogram reveals deviations from the ideal Poisson shape — consistent with the observed heteroscedasticity — reinforcing the idea that a multiplicative noise model could be a better fit for this time series.</span>
<span id="cb191-1160"><a href="#cb191-1160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1161"><a href="#cb191-1161" aria-hidden="true" tabindex="-1"></a><span class="fu">### Modeling multiplicative noise</span></span>
<span id="cb191-1162"><a href="#cb191-1162" aria-hidden="true" tabindex="-1"></a>The previous analysis indicated that the variance of the residuals (noise) increases with the magnitude of the deterministic component — suggesting that the noise is multiplicative rather than additive.</span>
<span id="cb191-1163"><a href="#cb191-1163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1164"><a href="#cb191-1164" aria-hidden="true" tabindex="-1"></a>In an additive noise model, we write:</span>
<span id="cb191-1165"><a href="#cb191-1165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1166"><a href="#cb191-1166" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-1167"><a href="#cb191-1167" aria-hidden="true" tabindex="-1"></a>y(t) = tr(t) + s(t) + \epsilon_t</span>
<span id="cb191-1168"><a href="#cb191-1168" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-1169"><a href="#cb191-1169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1170"><a href="#cb191-1170" aria-hidden="true" tabindex="-1"></a>In contrast, a multiplicative noise model assumes:</span>
<span id="cb191-1171"><a href="#cb191-1171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1172"><a href="#cb191-1172" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-1173"><a href="#cb191-1173" aria-hidden="true" tabindex="-1"></a>y(t) = <span class="co">[</span><span class="ot">tr(t) + s(t)</span><span class="co">]</span>*<span class="co">[</span><span class="ot">1 + \epsilon_t</span><span class="co">]</span></span>
<span id="cb191-1174"><a href="#cb191-1174" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-1175"><a href="#cb191-1175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1176"><a href="#cb191-1176" aria-hidden="true" tabindex="-1"></a>or equivalently,</span>
<span id="cb191-1177"><a href="#cb191-1177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1178"><a href="#cb191-1178" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-1179"><a href="#cb191-1179" aria-hidden="true" tabindex="-1"></a>\epsilon_t = \frac{y(t) - <span class="co">[</span><span class="ot">tr(t) + s(t)</span><span class="co">]</span>}{<span class="co">[</span><span class="ot">tr(t) + s(t)</span><span class="co">]</span>}</span>
<span id="cb191-1180"><a href="#cb191-1180" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-1181"><a href="#cb191-1181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1182"><a href="#cb191-1182" aria-hidden="true" tabindex="-1"></a>This formulation implies that the magnitude of the fluctuations (noise) scales with the level of the signal — a realistic assumption for many economic and natural time series.</span>
<span id="cb191-1183"><a href="#cb191-1183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1184"><a href="#cb191-1184" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Extracting multiplicative noise</span></span>
<span id="cb191-1185"><a href="#cb191-1185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1186"><a href="#cb191-1186" aria-hidden="true" tabindex="-1"></a>Let’s compute the multiplicative residuals based on our fitted deterministic component $tr(t) + s(t)$:</span>
<span id="cb191-1187"><a href="#cb191-1187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1190"><a href="#cb191-1190" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-1191"><a href="#cb191-1191" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb191-1192"><a href="#cb191-1192" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb191-1193"><a href="#cb191-1193" aria-hidden="true" tabindex="-1"></a>    <span class="at">y_det  =</span> tr_lm <span class="sc">+</span> sea_lo,</span>
<span id="cb191-1194"><a href="#cb191-1194" aria-hidden="true" tabindex="-1"></a>    <span class="at">eps_mul =</span> (y_2 <span class="sc">-</span> y_det) <span class="sc">/</span> y_det</span>
<span id="cb191-1195"><a href="#cb191-1195" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb191-1196"><a href="#cb191-1196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1197"><a href="#cb191-1197" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb191-1198"><a href="#cb191-1198" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> eps_mul)) <span class="sc">+</span></span>
<span id="cb191-1199"><a href="#cb191-1199" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb191-1200"><a href="#cb191-1200" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">as_date</span>(<span class="fu">c</span>(<span class="st">"2023-12-31"</span>, <span class="st">"2024-12-31"</span>))) <span class="sc">+</span></span>
<span id="cb191-1201"><a href="#cb191-1201" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>)</span>
<span id="cb191-1202"><a href="#cb191-1202" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-1203"><a href="#cb191-1203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1204"><a href="#cb191-1204" aria-hidden="true" tabindex="-1"></a>We can now inspect whether these normalized residuals appear **homoscedastic** (i.e., constant variance) over time.</span>
<span id="cb191-1205"><a href="#cb191-1205" aria-hidden="true" tabindex="-1"></a>If the variance stabilizes, that confirms that the multiplicative model is indeed more appropriate.</span>
<span id="cb191-1206"><a href="#cb191-1206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1207"><a href="#cb191-1207" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Analyzing the multiplicative residuals</span></span>
<span id="cb191-1208"><a href="#cb191-1208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1209"><a href="#cb191-1209" aria-hidden="true" tabindex="-1"></a>Compute basic moments of the multiplicative residuals:</span>
<span id="cb191-1210"><a href="#cb191-1210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1213"><a href="#cb191-1213" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-1214"><a href="#cb191-1214" aria-hidden="true" tabindex="-1"></a>noi_mul_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(df_ts1<span class="sc">$</span>eps_mul)</span>
<span id="cb191-1215"><a href="#cb191-1215" aria-hidden="true" tabindex="-1"></a>noi_mul_var  <span class="ot">&lt;-</span> <span class="fu">var</span>(df_ts1<span class="sc">$</span>eps_mul)</span>
<span id="cb191-1216"><a href="#cb191-1216" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-1217"><a href="#cb191-1217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1218"><a href="#cb191-1218" aria-hidden="true" tabindex="-1"></a>We obtain:</span>
<span id="cb191-1219"><a href="#cb191-1219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1220"><a href="#cb191-1220" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Mean: <span class="in">`r round(noi_mul_mean, 3)`</span></span>
<span id="cb191-1221"><a href="#cb191-1221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1222"><a href="#cb191-1222" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Variance: <span class="in">`r round(noi_mul_var, 3)`</span></span>
<span id="cb191-1223"><a href="#cb191-1223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1224"><a href="#cb191-1224" aria-hidden="true" tabindex="-1"></a>The mean is close to zero, as expected, and the variance is stable across time — confirming that the **scaled residuals are stationary**.</span>
<span id="cb191-1225"><a href="#cb191-1225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1226"><a href="#cb191-1226" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Distribution of multiplicative noise</span></span>
<span id="cb191-1227"><a href="#cb191-1227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1228"><a href="#cb191-1228" aria-hidden="true" tabindex="-1"></a>Next, let’s examine whether the multiplicative residuals follow a Poisson, Gaussian, or log-normal distribution.</span>
<span id="cb191-1229"><a href="#cb191-1229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1232"><a href="#cb191-1232" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-1233"><a href="#cb191-1233" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb191-1234"><a href="#cb191-1234" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> eps_mul)) <span class="sc">+</span></span>
<span id="cb191-1235"><a href="#cb191-1235" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), <span class="at">bins =</span> <span class="dv">100</span>, <span class="at">fill =</span> <span class="st">"lightblue"</span>) <span class="sc">+</span></span>
<span id="cb191-1236"><a href="#cb191-1236" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_function</span>(<span class="at">fun =</span> dnorm,</span>
<span id="cb191-1237"><a href="#cb191-1237" aria-hidden="true" tabindex="-1"></a>                  <span class="at">args =</span> <span class="fu">list</span>(<span class="at">mean =</span> noi_mul_mean, <span class="at">sd =</span> <span class="fu">sqrt</span>(noi_mul_var)),</span>
<span id="cb191-1238"><a href="#cb191-1238" aria-hidden="true" tabindex="-1"></a>                  <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb191-1239"><a href="#cb191-1239" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Distribution of Multiplicative Noise"</span>,</span>
<span id="cb191-1240"><a href="#cb191-1240" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="fu">expression</span>(epsilon[t]),</span>
<span id="cb191-1241"><a href="#cb191-1241" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Density"</span>)</span>
<span id="cb191-1242"><a href="#cb191-1242" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-1243"><a href="#cb191-1243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1244"><a href="#cb191-1244" aria-hidden="true" tabindex="-1"></a>The red curve corresponds to a normal distribution fitted with the same mean and variance as the empirical residuals.\</span>
<span id="cb191-1245"><a href="#cb191-1245" aria-hidden="true" tabindex="-1"></a>If the histogram closely follows this curve, the multiplicative noise can be approximated as Gaussian — a common assumption in log-transformed time series models.</span>
<span id="cb191-1246"><a href="#cb191-1246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1247"><a href="#cb191-1247" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Alternative representation (log transformation)</span></span>
<span id="cb191-1248"><a href="#cb191-1248" aria-hidden="true" tabindex="-1"></a>Since multiplicative models can be expressed additively in the logarithmic domain, we can apply a log transformation:</span>
<span id="cb191-1249"><a href="#cb191-1249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1250"><a href="#cb191-1250" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-1251"><a href="#cb191-1251" aria-hidden="true" tabindex="-1"></a>log(y(t)) = log<span class="co">[</span><span class="ot">tr(t) + s(t)</span><span class="co">]</span> + log<span class="co">[</span><span class="ot">1 + \epsilon_t</span><span class="co">]</span></span>
<span id="cb191-1252"><a href="#cb191-1252" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-1253"><a href="#cb191-1253" aria-hidden="true" tabindex="-1"></a>For small noise $(\epsilon_t \ll 1)$, the term $\log(1 + \epsilon_t) \approx \epsilon_t$,\</span>
<span id="cb191-1254"><a href="#cb191-1254" aria-hidden="true" tabindex="-1"></a>so the model becomes approximately additive in log-space.</span>
<span id="cb191-1255"><a href="#cb191-1255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1258"><a href="#cb191-1258" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-1259"><a href="#cb191-1259" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb191-1260"><a href="#cb191-1260" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb191-1261"><a href="#cb191-1261" aria-hidden="true" tabindex="-1"></a>    <span class="at">log_y =</span> <span class="fu">log</span>(y_2),</span>
<span id="cb191-1262"><a href="#cb191-1262" aria-hidden="true" tabindex="-1"></a>    <span class="at">log_det =</span> <span class="fu">log</span>(y_det),</span>
<span id="cb191-1263"><a href="#cb191-1263" aria-hidden="true" tabindex="-1"></a>    <span class="at">log_eps =</span> log_y <span class="sc">-</span> log_det</span>
<span id="cb191-1264"><a href="#cb191-1264" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb191-1265"><a href="#cb191-1265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1266"><a href="#cb191-1266" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb191-1267"><a href="#cb191-1267" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> log_eps)) <span class="sc">+</span></span>
<span id="cb191-1268"><a href="#cb191-1268" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb191-1269"><a href="#cb191-1269" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb191-1270"><a href="#cb191-1270" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Log-Transformed Residuals (Approx. Additive)"</span>,</span>
<span id="cb191-1271"><a href="#cb191-1271" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="fu">expression</span>(<span class="fu">log</span>(epsilon[t])))</span>
<span id="cb191-1272"><a href="#cb191-1272" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-1273"><a href="#cb191-1273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1274"><a href="#cb191-1274" aria-hidden="true" tabindex="-1"></a>This transformation stabilizes the variance even further and simplifies future modeling (e.g., ARIMA or state-space models).</span>
<span id="cb191-1275"><a href="#cb191-1275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1276"><a href="#cb191-1276" aria-hidden="true" tabindex="-1"></a>We obtain:</span>
<span id="cb191-1277"><a href="#cb191-1277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1278"><a href="#cb191-1278" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Mean: <span class="in">`r round(mean(df_ts1$log_eps), 3)`</span></span>
<span id="cb191-1279"><a href="#cb191-1279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1280"><a href="#cb191-1280" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Variance: <span class="in">`r round(var(df_ts1$log_eps), 3)`</span></span>
<span id="cb191-1281"><a href="#cb191-1281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1282"><a href="#cb191-1282" aria-hidden="true" tabindex="-1"></a><span class="fu">## Modeling wrap-up</span></span>
<span id="cb191-1283"><a href="#cb191-1283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1284"><a href="#cb191-1284" aria-hidden="true" tabindex="-1"></a><span class="fu">### Trend</span></span>
<span id="cb191-1285"><a href="#cb191-1285" aria-hidden="true" tabindex="-1"></a>We start by comparing the **original** and **inferred** trend parameters.</span>
<span id="cb191-1286"><a href="#cb191-1286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1287"><a href="#cb191-1287" aria-hidden="true" tabindex="-1"></a><span class="in">```{r compare-trend-orig-inferred}</span></span>
<span id="cb191-1288"><a href="#cb191-1288" aria-hidden="true" tabindex="-1"></a>y0_a   <span class="ot">&lt;-</span> lm_tr<span class="sc">$</span>coefficients[<span class="dv">1</span>] <span class="sc">+</span> (df_ts1<span class="sc">$</span>day <span class="sc">%&gt;%</span> <span class="fu">min</span>() <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">*</span> lm_tr<span class="sc">$</span>coefficients[<span class="dv">2</span>]</span>
<span id="cb191-1289"><a href="#cb191-1289" aria-hidden="true" tabindex="-1"></a>alfa_a <span class="ot">&lt;-</span> lm_tr<span class="sc">$</span>coefficients[<span class="dv">2</span>] <span class="sc">*</span> <span class="dv">365</span></span>
<span id="cb191-1290"><a href="#cb191-1290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1291"><a href="#cb191-1291" aria-hidden="true" tabindex="-1"></a><span class="fu">tribble</span>(</span>
<span id="cb191-1292"><a href="#cb191-1292" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>Trend_Parameter, <span class="sc">~</span>Original, <span class="sc">~</span>Inferred,</span>
<span id="cb191-1293"><a href="#cb191-1293" aria-hidden="true" tabindex="-1"></a>  <span class="st">"y₀"</span>,   y0_o,   y0_a,</span>
<span id="cb191-1294"><a href="#cb191-1294" aria-hidden="true" tabindex="-1"></a>  <span class="st">"α"</span>,    alfa_o, alfa_a</span>
<span id="cb191-1295"><a href="#cb191-1295" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb191-1296"><a href="#cb191-1296" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-1297"><a href="#cb191-1297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1298"><a href="#cb191-1298" aria-hidden="true" tabindex="-1"></a>The inferred trend parameters are close to the original values, indicating that the linear model successfully recovered the overall trend structure.</span>
<span id="cb191-1299"><a href="#cb191-1299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1300"><a href="#cb191-1300" aria-hidden="true" tabindex="-1"></a><span class="fu">### Seasonality:</span></span>
<span id="cb191-1301"><a href="#cb191-1301" aria-hidden="true" tabindex="-1"></a>Next, we compare the original and inferred seasonal components.</span>
<span id="cb191-1302"><a href="#cb191-1302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1303"><a href="#cb191-1303" aria-hidden="true" tabindex="-1"></a><span class="in">```{r compare-season-orig-inferred}</span></span>
<span id="cb191-1304"><a href="#cb191-1304" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb191-1305"><a href="#cb191-1305" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> sea)) <span class="sc">+</span></span>
<span id="cb191-1306"><a href="#cb191-1306" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb191-1307"><a href="#cb191-1307" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> sea_lo), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb191-1308"><a href="#cb191-1308" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb191-1309"><a href="#cb191-1309" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Comparison of Original and Inferred Seasonality"</span>,</span>
<span id="cb191-1310"><a href="#cb191-1310" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Day"</span>,</span>
<span id="cb191-1311"><a href="#cb191-1311" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Seasonal Component"</span></span>
<span id="cb191-1312"><a href="#cb191-1312" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb191-1313"><a href="#cb191-1313" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span>
<span id="cb191-1314"><a href="#cb191-1314" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-1315"><a href="#cb191-1315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1316"><a href="#cb191-1316" aria-hidden="true" tabindex="-1"></a>Here, the black curve represents the original seasonal pattern, while the red dashed curve shows the inferred seasonality.</span>
<span id="cb191-1317"><a href="#cb191-1317" aria-hidden="true" tabindex="-1"></a>The two align quite well overall, although a small phase shift can be observed — likely due to interactions between trend and noise, or numerical effects in the decomposition.</span>
<span id="cb191-1318"><a href="#cb191-1318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1319"><a href="#cb191-1319" aria-hidden="true" tabindex="-1"></a><span class="fu">### Noise</span></span>
<span id="cb191-1320"><a href="#cb191-1320" aria-hidden="true" tabindex="-1"></a>Finally, we compare the Poisson noise parameter $\lambda_t$:</span>
<span id="cb191-1321"><a href="#cb191-1321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1322"><a href="#cb191-1322" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Original: $\lambda =$ <span class="in">`r lam_0`</span></span>
<span id="cb191-1323"><a href="#cb191-1323" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Inferred: $\lambda =$ <span class="in">`r round(noi_var, digits = 2)`</span></span>
<span id="cb191-1324"><a href="#cb191-1324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1325"><a href="#cb191-1325" aria-hidden="true" tabindex="-1"></a>The inferred value is somewhat different from the true parameter, which is expected since noise estimation is often sensitive to model specification and the chosen decomposition method.</span>
<span id="cb191-1326"><a href="#cb191-1326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1327"><a href="#cb191-1327" aria-hidden="true" tabindex="-1"></a>Still, the inferred variance remains within a reasonable range.\</span>
<span id="cb191-1328"><a href="#cb191-1328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1329"><a href="#cb191-1329" aria-hidden="true" tabindex="-1"></a>In the next step, we’ll explore the case with multiplicative noise, which often provides a more realistic representation of many real-world time series.</span>
<span id="cb191-1330"><a href="#cb191-1330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1331"><a href="#cb191-1331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1332"><a href="#cb191-1332" aria-hidden="true" tabindex="-1"></a><span class="fu">### Additive vs. multiplicative noise</span></span>
<span id="cb191-1333"><a href="#cb191-1333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1334"><a href="#cb191-1334" aria-hidden="true" tabindex="-1"></a>In the additive model, the observed time series is expressed as:</span>
<span id="cb191-1335"><a href="#cb191-1335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1336"><a href="#cb191-1336" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-1337"><a href="#cb191-1337" aria-hidden="true" tabindex="-1"></a>y_t = tr(t) + s(t) + \varepsilon_t</span>
<span id="cb191-1338"><a href="#cb191-1338" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-1339"><a href="#cb191-1339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1340"><a href="#cb191-1340" aria-hidden="true" tabindex="-1"></a>where $\varepsilon_t$ represents random fluctuations around the deterministic trend–seasonality structure.</span>
<span id="cb191-1341"><a href="#cb191-1341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1342"><a href="#cb191-1342" aria-hidden="true" tabindex="-1"></a>However, if the amplitude of the noise appears to grow or shrink with the level of the signal (as we observed in our plots), a **multiplicative model** may be more appropriate:</span>
<span id="cb191-1343"><a href="#cb191-1343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1344"><a href="#cb191-1344" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-1345"><a href="#cb191-1345" aria-hidden="true" tabindex="-1"></a>y_t = <span class="co">[</span><span class="ot">tr(t) + s(t)</span><span class="co">]</span> \times (1 + \varepsilon_t)</span>
<span id="cb191-1346"><a href="#cb191-1346" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-1347"><a href="#cb191-1347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1348"><a href="#cb191-1348" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Log-transformation</span></span>
<span id="cb191-1349"><a href="#cb191-1349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1350"><a href="#cb191-1350" aria-hidden="true" tabindex="-1"></a>Taking logarithms linearizes the multiplicative model:</span>
<span id="cb191-1351"><a href="#cb191-1351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1352"><a href="#cb191-1352" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-1353"><a href="#cb191-1353" aria-hidden="true" tabindex="-1"></a>\log(y_t) = \log(tr(t) + s(t)) + \log(1 + \varepsilon_t)</span>
<span id="cb191-1354"><a href="#cb191-1354" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-1355"><a href="#cb191-1355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1356"><a href="#cb191-1356" aria-hidden="true" tabindex="-1"></a>For small noise ($\varepsilon_t \ll 1$), we can use the approximation:</span>
<span id="cb191-1357"><a href="#cb191-1357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1358"><a href="#cb191-1358" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-1359"><a href="#cb191-1359" aria-hidden="true" tabindex="-1"></a>\log(1 + \varepsilon_t) \approx \varepsilon_t</span>
<span id="cb191-1360"><a href="#cb191-1360" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-1361"><a href="#cb191-1361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1362"><a href="#cb191-1362" aria-hidden="true" tabindex="-1"></a>which means the model becomes approximately **additive in log-space**.  </span>
<span id="cb191-1363"><a href="#cb191-1363" aria-hidden="true" tabindex="-1"></a>This transformation stabilizes the variance and often results in more homogeneous residuals.</span>
<span id="cb191-1364"><a href="#cb191-1364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1365"><a href="#cb191-1365" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Procedure</span></span>
<span id="cb191-1366"><a href="#cb191-1366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1367"><a href="#cb191-1367" aria-hidden="true" tabindex="-1"></a>To assess whether the multiplicative model is better, we can follow these steps:</span>
<span id="cb191-1368"><a href="#cb191-1368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1369"><a href="#cb191-1369" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Log-transform the series**  </span>
<span id="cb191-1370"><a href="#cb191-1370" aria-hidden="true" tabindex="-1"></a>   $$</span>
<span id="cb191-1371"><a href="#cb191-1371" aria-hidden="true" tabindex="-1"></a>   y'_t = \log(y_t)</span>
<span id="cb191-1372"><a href="#cb191-1372" aria-hidden="true" tabindex="-1"></a>   $$</span>
<span id="cb191-1373"><a href="#cb191-1373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1374"><a href="#cb191-1374" aria-hidden="true" tabindex="-1"></a><span class="in">```{r log-transform}</span></span>
<span id="cb191-1375"><a href="#cb191-1375" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="ot">&lt;-</span> df_ts1 <span class="sc">|&gt;</span></span>
<span id="cb191-1376"><a href="#cb191-1376" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y_log =</span> <span class="fu">log</span>(y_2))</span>
<span id="cb191-1377"><a href="#cb191-1377" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-1378"><a href="#cb191-1378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1379"><a href="#cb191-1379" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Re-estimate** trend and seasonality using the same LOESS or regression techniques on $y'_t$.</span>
<span id="cb191-1380"><a href="#cb191-1380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1383"><a href="#cb191-1383" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-1384"><a href="#cb191-1384" aria-hidden="true" tabindex="-1"></a><span class="co"># Trend estimation using linear model</span></span>
<span id="cb191-1385"><a href="#cb191-1385" aria-hidden="true" tabindex="-1"></a>lm_tr_log <span class="ot">&lt;-</span> <span class="fu">lm</span>(y_log <span class="sc">~</span> <span class="fu">as.numeric</span>(day), <span class="at">data =</span> df_ts1)</span>
<span id="cb191-1386"><a href="#cb191-1386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1387"><a href="#cb191-1387" aria-hidden="true" tabindex="-1"></a><span class="co"># Trend prediction</span></span>
<span id="cb191-1388"><a href="#cb191-1388" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="ot">&lt;-</span> df_ts1 <span class="sc">|&gt;</span></span>
<span id="cb191-1389"><a href="#cb191-1389" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tr_log =</span> <span class="fu">predict</span>(lm_tr_log))</span>
<span id="cb191-1390"><a href="#cb191-1390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1391"><a href="#cb191-1391" aria-hidden="true" tabindex="-1"></a><span class="co"># Seasonality estimation using LOESS</span></span>
<span id="cb191-1392"><a href="#cb191-1392" aria-hidden="true" tabindex="-1"></a>sea_log <span class="ot">&lt;-</span> <span class="fu">loess</span>(y_log <span class="sc">-</span> tr_log <span class="sc">~</span> <span class="fu">as.numeric</span>(day),</span>
<span id="cb191-1393"><a href="#cb191-1393" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> df_ts1,</span>
<span id="cb191-1394"><a href="#cb191-1394" aria-hidden="true" tabindex="-1"></a>                 <span class="at">span =</span> loess_span_low)</span>
<span id="cb191-1395"><a href="#cb191-1395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1396"><a href="#cb191-1396" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="ot">&lt;-</span> df_ts1 <span class="sc">|&gt;</span></span>
<span id="cb191-1397"><a href="#cb191-1397" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sea_log =</span> sea_log<span class="sc">$</span>fitted)</span>
<span id="cb191-1398"><a href="#cb191-1398" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-1399"><a href="#cb191-1399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1400"><a href="#cb191-1400" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Extract residuals** in log-space:</span>
<span id="cb191-1401"><a href="#cb191-1401" aria-hidden="true" tabindex="-1"></a>   $$</span>
<span id="cb191-1402"><a href="#cb191-1402" aria-hidden="true" tabindex="-1"></a>   \varepsilon'_t = y'_t - tr'(t) - s'(t)</span>
<span id="cb191-1403"><a href="#cb191-1403" aria-hidden="true" tabindex="-1"></a>   $$</span>
<span id="cb191-1404"><a href="#cb191-1404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1407"><a href="#cb191-1407" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-1408"><a href="#cb191-1408" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="ot">&lt;-</span> df_ts1 <span class="sc">|&gt;</span></span>
<span id="cb191-1409"><a href="#cb191-1409" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">eps_log =</span> y_log <span class="sc">-</span> tr_log <span class="sc">-</span> sea_log)</span>
<span id="cb191-1410"><a href="#cb191-1410" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-1411"><a href="#cb191-1411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1412"><a href="#cb191-1412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1413"><a href="#cb191-1413" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Evaluate residual properties**:</span>
<span id="cb191-1414"><a href="#cb191-1414" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Mean ≈ 0 (centered)</span>
<span id="cb191-1415"><a href="#cb191-1415" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Homoscedasticity (constant variance)</span>
<span id="cb191-1416"><a href="#cb191-1416" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Independence over time</span>
<span id="cb191-1417"><a href="#cb191-1417" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Normality (histogram or QQ-plot)</span>
<span id="cb191-1418"><a href="#cb191-1418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1421"><a href="#cb191-1421" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-1422"><a href="#cb191-1422" aria-hidden="true" tabindex="-1"></a><span class="co"># Variances of additive and multiplicative residuals</span></span>
<span id="cb191-1423"><a href="#cb191-1423" aria-hidden="true" tabindex="-1"></a>var_add <span class="ot">&lt;-</span> <span class="fu">var</span>(df_ts1<span class="sc">$</span>y_noi, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb191-1424"><a href="#cb191-1424" aria-hidden="true" tabindex="-1"></a>var_mul <span class="ot">&lt;-</span> <span class="fu">var</span>(df_ts1<span class="sc">$</span>eps_log, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb191-1425"><a href="#cb191-1425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1426"><a href="#cb191-1426" aria-hidden="true" tabindex="-1"></a><span class="fu">tribble</span>(<span class="sc">~</span>Model, <span class="sc">~</span>Residual_Variance,</span>
<span id="cb191-1427"><a href="#cb191-1427" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Additive"</span>, <span class="fu">round</span>(var_add, <span class="dv">4</span>),</span>
<span id="cb191-1428"><a href="#cb191-1428" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Multiplicative (log-space)"</span>, <span class="fu">round</span>(var_mul, <span class="dv">4</span>))</span>
<span id="cb191-1429"><a href="#cb191-1429" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-1430"><a href="#cb191-1430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1431"><a href="#cb191-1431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1432"><a href="#cb191-1432" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**Compare fit metrics** between additive and multiplicative models:</span>
<span id="cb191-1433"><a href="#cb191-1433" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Residual variance</span>
<span id="cb191-1434"><a href="#cb191-1434" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>AIC / BIC (if fitting parametric trend models)</span>
<span id="cb191-1435"><a href="#cb191-1435" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Predictive performance (e.g., RMSE on holdout data)</span>
<span id="cb191-1436"><a href="#cb191-1436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1439"><a href="#cb191-1439" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-1440"><a href="#cb191-1440" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">|&gt;</span></span>
<span id="cb191-1441"><a href="#cb191-1441" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(day, eps_log, y_noi) <span class="sc">|&gt;</span></span>
<span id="cb191-1442"><a href="#cb191-1442" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(y_noi, eps_log),</span>
<span id="cb191-1443"><a href="#cb191-1443" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"model_type"</span>,</span>
<span id="cb191-1444"><a href="#cb191-1444" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"residual"</span>) <span class="sc">|&gt;</span></span>
<span id="cb191-1445"><a href="#cb191-1445" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> residual, <span class="at">color =</span> model_type)) <span class="sc">+</span></span>
<span id="cb191-1446"><a href="#cb191-1446" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb191-1447"><a href="#cb191-1447" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb191-1448"><a href="#cb191-1448" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span> model_type, <span class="at">ncol =</span> <span class="dv">1</span>, <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb191-1449"><a href="#cb191-1449" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Comparison of Residuals: Additive vs. Multiplicative"</span>,</span>
<span id="cb191-1450"><a href="#cb191-1450" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Day"</span>, <span class="at">y =</span> <span class="st">"Residual"</span>, <span class="at">color =</span> <span class="st">"Model Type"</span>) <span class="sc">+</span></span>
<span id="cb191-1451"><a href="#cb191-1451" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb191-1452"><a href="#cb191-1452" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-1453"><a href="#cb191-1453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1456"><a href="#cb191-1456" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-1457"><a href="#cb191-1457" aria-hidden="true" tabindex="-1"></a><span class="co"># Define file path</span></span>
<span id="cb191-1458"><a href="#cb191-1458" aria-hidden="true" tabindex="-1"></a>output_path <span class="ot">&lt;-</span> <span class="st">"./data/synthetic_TS_02.tsv"</span></span>
<span id="cb191-1459"><a href="#cb191-1459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1460"><a href="#cb191-1460" aria-hidden="true" tabindex="-1"></a><span class="co"># Write to TSV</span></span>
<span id="cb191-1461"><a href="#cb191-1461" aria-hidden="true" tabindex="-1"></a><span class="fu">write_tsv</span>(df_ts1, <span class="at">file =</span> output_path)</span>
<span id="cb191-1462"><a href="#cb191-1462" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-1463"><a href="#cb191-1463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1464"><a href="#cb191-1464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1465"><a href="#cb191-1465" aria-hidden="true" tabindex="-1"></a><span class="fu">## Real case: Walmart 2010</span></span>
<span id="cb191-1466"><a href="#cb191-1466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1467"><a href="#cb191-1467" aria-hidden="true" tabindex="-1"></a>Having validated our approach on synthetic data, we now test it on **real-world data**.</span>
<span id="cb191-1468"><a href="#cb191-1468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1469"><a href="#cb191-1469" aria-hidden="true" tabindex="-1"></a><span class="fu">### Dataset</span></span>
<span id="cb191-1470"><a href="#cb191-1470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1471"><a href="#cb191-1471" aria-hidden="true" tabindex="-1"></a>We extracted data from the Walmart Kaggle competition.  </span>
<span id="cb191-1472"><a href="#cb191-1472" aria-hidden="true" tabindex="-1"></a>Here we focus on **store 2, department 2**.</span>
<span id="cb191-1473"><a href="#cb191-1473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1474"><a href="#cb191-1474" aria-hidden="true" tabindex="-1"></a><span class="in">```{r load-data}</span></span>
<span id="cb191-1475"><a href="#cb191-1475" aria-hidden="true" tabindex="-1"></a>fpath_tra <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{data_dir}/Walmart/train.csv"</span>)</span>
<span id="cb191-1476"><a href="#cb191-1476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1477"><a href="#cb191-1477" aria-hidden="true" tabindex="-1"></a>df_tra <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(fpath_tra) <span class="sc">%&gt;%</span></span>
<span id="cb191-1478"><a href="#cb191-1478" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_all</span>(tolower) <span class="sc">%&gt;%</span></span>
<span id="cb191-1479"><a href="#cb191-1479" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">is_holiday =</span> isholiday)</span>
<span id="cb191-1480"><a href="#cb191-1480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1481"><a href="#cb191-1481" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="ot">&lt;-</span> df_tra <span class="sc">%&gt;%</span></span>
<span id="cb191-1482"><a href="#cb191-1482" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(store <span class="sc">==</span> <span class="dv">2</span>, dept <span class="sc">==</span> <span class="dv">2</span>)</span>
<span id="cb191-1483"><a href="#cb191-1483" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-1484"><a href="#cb191-1484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1485"><a href="#cb191-1485" aria-hidden="true" tabindex="-1"></a><span class="fu">### Inspecting the training data</span></span>
<span id="cb191-1486"><a href="#cb191-1486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1487"><a href="#cb191-1487" aria-hidden="true" tabindex="-1"></a><span class="in">```{r restrict-to-1-store-1-dpt}</span></span>
<span id="cb191-1488"><a href="#cb191-1488" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb191-1489"><a href="#cb191-1489" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">is_holiday =</span> <span class="fu">ifelse</span>(is_holiday, <span class="cn">TRUE</span>, <span class="cn">NA</span>),</span>
<span id="cb191-1490"><a href="#cb191-1490" aria-hidden="true" tabindex="-1"></a>         <span class="at">store =</span> <span class="fu">factor</span>(store)) <span class="sc">%&gt;%</span></span>
<span id="cb191-1491"><a href="#cb191-1491" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> weekly_sales)) <span class="sc">+</span> </span>
<span id="cb191-1492"><a href="#cb191-1492" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> store, <span class="at">color =</span> store)) <span class="sc">+</span> </span>
<span id="cb191-1493"><a href="#cb191-1493" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">data =</span> df_tra <span class="sc">%&gt;%</span> <span class="fu">filter</span>(is_holiday) <span class="sc">%&gt;%</span> <span class="fu">distinct</span>(date), </span>
<span id="cb191-1494"><a href="#cb191-1494" aria-hidden="true" tabindex="-1"></a>               <span class="fu">aes</span>(<span class="at">xintercept =</span> date), </span>
<span id="cb191-1495"><a href="#cb191-1495" aria-hidden="true" tabindex="-1"></a>               <span class="at">color =</span> <span class="st">"grey50"</span>, </span>
<span id="cb191-1496"><a href="#cb191-1496" aria-hidden="true" tabindex="-1"></a>               <span class="at">alpha =</span> <span class="fl">0.5</span>, </span>
<span id="cb191-1497"><a href="#cb191-1497" aria-hidden="true" tabindex="-1"></a>               <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span> </span>
<span id="cb191-1498"><a href="#cb191-1498" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span> dept, <span class="at">scale =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb191-1499"><a href="#cb191-1499" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Weekly Sales: Store 2, Department 2"</span>,</span>
<span id="cb191-1500"><a href="#cb191-1500" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb191-1501"><a href="#cb191-1501" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Weekly Sales"</span>)</span>
<span id="cb191-1502"><a href="#cb191-1502" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-1503"><a href="#cb191-1503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1504"><a href="#cb191-1504" aria-hidden="true" tabindex="-1"></a>We can already see seasonal patterns, particularly spikes at the end of each year.</span>
<span id="cb191-1505"><a href="#cb191-1505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1506"><a href="#cb191-1506" aria-hidden="true" tabindex="-1"></a><span class="fu">### Year-over-year analysis</span></span>
<span id="cb191-1507"><a href="#cb191-1507" aria-hidden="true" tabindex="-1"></a>To highlight seasonal effects, we overlay data year-over-year:</span>
<span id="cb191-1508"><a href="#cb191-1508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1509"><a href="#cb191-1509" aria-hidden="true" tabindex="-1"></a><span class="in">```{r add-years}</span></span>
<span id="cb191-1510"><a href="#cb191-1510" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb191-1511"><a href="#cb191-1511" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">factor</span>(<span class="fu">year</span>(date)),</span>
<span id="cb191-1512"><a href="#cb191-1512" aria-hidden="true" tabindex="-1"></a>         <span class="at">date_no_year =</span> date) <span class="sc">%&gt;%</span></span>
<span id="cb191-1513"><a href="#cb191-1513" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(year, <span class="at">.before =</span> date)</span>
<span id="cb191-1514"><a href="#cb191-1514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1515"><a href="#cb191-1515" aria-hidden="true" tabindex="-1"></a><span class="fu">year</span>(df_tra_2<span class="sc">$</span>date_no_year) <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb191-1516"><a href="#cb191-1516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1517"><a href="#cb191-1517" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb191-1518"><a href="#cb191-1518" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date_no_year, <span class="at">y =</span> weekly_sales, <span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb191-1519"><a href="#cb191-1519" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb191-1520"><a href="#cb191-1520" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Year-over-Year Weekly Sales"</span>,</span>
<span id="cb191-1521"><a href="#cb191-1521" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Day of Year"</span>,</span>
<span id="cb191-1522"><a href="#cb191-1522" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Weekly Sales"</span>)</span>
<span id="cb191-1523"><a href="#cb191-1523" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-1524"><a href="#cb191-1524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1525"><a href="#cb191-1525" aria-hidden="true" tabindex="-1"></a>Seasonality is evident, with noticeable correlations at year-end. Some mid-year dips in 2011 suggest year-specific effects.</span>
<span id="cb191-1526"><a href="#cb191-1526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1527"><a href="#cb191-1527" aria-hidden="true" tabindex="-1"></a><span class="fu">### Trend analysis</span></span>
<span id="cb191-1528"><a href="#cb191-1528" aria-hidden="true" tabindex="-1"></a>**Yearly Trend:**  </span>
<span id="cb191-1529"><a href="#cb191-1529" aria-hidden="true" tabindex="-1"></a>We first estimate the trend within each year, using both linear regression and LOESS smoothing:</span>
<span id="cb191-1530"><a href="#cb191-1530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1531"><a href="#cb191-1531" aria-hidden="true" tabindex="-1"></a><span class="in">```{r add-trend-yoy}</span></span>
<span id="cb191-1532"><a href="#cb191-1532" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb191-1533"><a href="#cb191-1533" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>(<span class="at">data =</span> <span class="sc">-</span>year) <span class="sc">%&gt;%</span></span>
<span id="cb191-1534"><a href="#cb191-1534" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb191-1535"><a href="#cb191-1535" aria-hidden="true" tabindex="-1"></a>    <span class="at">lm_tr  =</span> <span class="fu">map</span>(year, <span class="sc">~</span> <span class="fu">lm</span>(df_tra_2 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(year <span class="sc">==</span> .x), <span class="at">formula =</span> weekly_sales <span class="sc">~</span> date)),</span>
<span id="cb191-1536"><a href="#cb191-1536" aria-hidden="true" tabindex="-1"></a>    <span class="at">loes_tr =</span> <span class="fu">map</span>(year, <span class="sc">~</span> <span class="fu">loess</span>(df_tra_2 <span class="sc">%&gt;%</span> </span>
<span id="cb191-1537"><a href="#cb191-1537" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">filter</span>(year <span class="sc">==</span> .x) <span class="sc">%&gt;%</span></span>
<span id="cb191-1538"><a href="#cb191-1538" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">as.numeric</span>(date)),</span>
<span id="cb191-1539"><a href="#cb191-1539" aria-hidden="true" tabindex="-1"></a>                                <span class="at">formula =</span> weekly_sales <span class="sc">~</span> date,</span>
<span id="cb191-1540"><a href="#cb191-1540" aria-hidden="true" tabindex="-1"></a>                                <span class="at">span =</span> loess_span_high)),</span>
<span id="cb191-1541"><a href="#cb191-1541" aria-hidden="true" tabindex="-1"></a>    <span class="at">data    =</span> <span class="fu">map2</span>(data, lm_tr, <span class="sc">~</span> <span class="fu">mutate</span>(.x, <span class="at">try_lm =</span> .y<span class="sc">$</span>fitted)),</span>
<span id="cb191-1542"><a href="#cb191-1542" aria-hidden="true" tabindex="-1"></a>    <span class="at">data    =</span> <span class="fu">map2</span>(data, loes_tr, <span class="sc">~</span> <span class="fu">mutate</span>(.x, <span class="at">try_lo =</span> .y<span class="sc">$</span>fitted))</span>
<span id="cb191-1543"><a href="#cb191-1543" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb191-1544"><a href="#cb191-1544" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(lm_tr, loes_tr)) <span class="sc">%&gt;%</span></span>
<span id="cb191-1545"><a href="#cb191-1545" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(data)</span>
<span id="cb191-1546"><a href="#cb191-1546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1547"><a href="#cb191-1547" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb191-1548"><a href="#cb191-1548" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date_no_year, <span class="at">y =</span> weekly_sales, <span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb191-1549"><a href="#cb191-1549" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb191-1550"><a href="#cb191-1550" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> try_lm), <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb191-1551"><a href="#cb191-1551" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> try_lo), <span class="at">linetype =</span> <span class="st">"longdash"</span>) <span class="sc">+</span></span>
<span id="cb191-1552"><a href="#cb191-1552" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Yearly Trend: Linear vs. LOESS"</span>,</span>
<span id="cb191-1553"><a href="#cb191-1553" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Day of Year"</span>,</span>
<span id="cb191-1554"><a href="#cb191-1554" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Weekly Sales"</span>)</span>
<span id="cb191-1555"><a href="#cb191-1555" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-1556"><a href="#cb191-1556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1557"><a href="#cb191-1557" aria-hidden="true" tabindex="-1"></a>The LOESS curves capture more of the seasonal variation than linear trends alone. Notice mid-year dips in 2011 that are not captured perfectly.</span>
<span id="cb191-1558"><a href="#cb191-1558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1559"><a href="#cb191-1559" aria-hidden="true" tabindex="-1"></a>**Overall Trend:**  </span>
<span id="cb191-1560"><a href="#cb191-1560" aria-hidden="true" tabindex="-1"></a>Next, we estimate a trend across the entire period:</span>
<span id="cb191-1561"><a href="#cb191-1561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1562"><a href="#cb191-1562" aria-hidden="true" tabindex="-1"></a><span class="in">```{r add-trend-overall}</span></span>
<span id="cb191-1563"><a href="#cb191-1563" aria-hidden="true" tabindex="-1"></a>lm_tr <span class="ot">&lt;-</span> <span class="fu">lm</span>(weekly_sales <span class="sc">~</span> date, <span class="at">data =</span> df_tra_2)</span>
<span id="cb191-1564"><a href="#cb191-1564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1565"><a href="#cb191-1565" aria-hidden="true" tabindex="-1"></a>lo_tr <span class="ot">&lt;-</span> <span class="fu">loess</span>(weekly_sales <span class="sc">~</span> <span class="fu">as.numeric</span>(date), <span class="at">data =</span> df_tra_2, <span class="at">span =</span> loess_span_high)</span>
<span id="cb191-1566"><a href="#cb191-1566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1567"><a href="#cb191-1567" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb191-1568"><a href="#cb191-1568" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tr_lm =</span> lm_tr<span class="sc">$</span>fitted,</span>
<span id="cb191-1569"><a href="#cb191-1569" aria-hidden="true" tabindex="-1"></a>         <span class="at">tr_lo =</span> lo_tr<span class="sc">$</span>fitted)</span>
<span id="cb191-1570"><a href="#cb191-1570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1571"><a href="#cb191-1571" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb191-1572"><a href="#cb191-1572" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> weekly_sales, <span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb191-1573"><a href="#cb191-1573" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb191-1574"><a href="#cb191-1574" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tr_lo), <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb191-1575"><a href="#cb191-1575" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tr_lm), <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb191-1576"><a href="#cb191-1576" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Overall Trend: Linear vs. LOESS"</span>,</span>
<span id="cb191-1577"><a href="#cb191-1577" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb191-1578"><a href="#cb191-1578" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Weekly Sales"</span>)</span>
<span id="cb191-1579"><a href="#cb191-1579" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-1580"><a href="#cb191-1580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1581"><a href="#cb191-1581" aria-hidden="true" tabindex="-1"></a>Here, the LOESS trend better captures the variability, especially around peaks and troughs, compared to the linear fit.</span>
<span id="cb191-1582"><a href="#cb191-1582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1583"><a href="#cb191-1583" aria-hidden="true" tabindex="-1"></a><span class="fu">### Seasonality and noise analysis</span></span>
<span id="cb191-1584"><a href="#cb191-1584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1585"><a href="#cb191-1585" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 1: remove overall trend</span></span>
<span id="cb191-1586"><a href="#cb191-1586" aria-hidden="true" tabindex="-1"></a>We start by subtracting the overall trend (LOESS, with a high span) from the weekly sales to isolate the seasonal component plus noise:</span>
<span id="cb191-1587"><a href="#cb191-1587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1588"><a href="#cb191-1588" aria-hidden="true" tabindex="-1"></a><span class="in">```{r detrend-data}</span></span>
<span id="cb191-1589"><a href="#cb191-1589" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb191-1590"><a href="#cb191-1590" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">weekly_notr =</span> weekly_sales <span class="sc">-</span> tr_lo)</span>
<span id="cb191-1591"><a href="#cb191-1591" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-1592"><a href="#cb191-1592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1593"><a href="#cb191-1593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1594"><a href="#cb191-1594" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 2: estimate seasonality</span></span>
<span id="cb191-1595"><a href="#cb191-1595" aria-hidden="true" tabindex="-1"></a>We compute a LOESS-smoothed curve on the detrended series to approximate seasonality, setting a **lower span** to capture finer yearly patterns:</span>
<span id="cb191-1596"><a href="#cb191-1596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1599"><a href="#cb191-1599" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-1600"><a href="#cb191-1600" aria-hidden="true" tabindex="-1"></a>sea_lo <span class="ot">&lt;-</span> <span class="fu">loess</span>(weekly_notr <span class="sc">~</span> <span class="fu">as.numeric</span>(date), <span class="at">data =</span> df_tra_2, <span class="at">span =</span> loess_span_low)</span>
<span id="cb191-1601"><a href="#cb191-1601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1602"><a href="#cb191-1602" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb191-1603"><a href="#cb191-1603" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sea_lo =</span> sea_lo<span class="sc">$</span>fitted)</span>
<span id="cb191-1604"><a href="#cb191-1604" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-1605"><a href="#cb191-1605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1606"><a href="#cb191-1606" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 3: visualize seasonality year-over-year</span></span>
<span id="cb191-1607"><a href="#cb191-1607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1610"><a href="#cb191-1610" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-1611"><a href="#cb191-1611" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb191-1612"><a href="#cb191-1612" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date_no_year, <span class="at">y =</span> weekly_notr, <span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb191-1613"><a href="#cb191-1613" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb191-1614"><a href="#cb191-1614" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> sea_lo, <span class="at">group =</span> year), <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb191-1615"><a href="#cb191-1615" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb191-1616"><a href="#cb191-1616" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Detrended Weekly Sales: Seasonality (LOESS)"</span>,</span>
<span id="cb191-1617"><a href="#cb191-1617" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Day of Year"</span>,</span>
<span id="cb191-1618"><a href="#cb191-1618" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Detrended Sales"</span>)</span>
<span id="cb191-1619"><a href="#cb191-1619" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-1620"><a href="#cb191-1620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1621"><a href="#cb191-1621" aria-hidden="true" tabindex="-1"></a>We can now clearly see the yearly seasonal pattern, including spikes around holidays and end-of-year peaks.</span>
<span id="cb191-1622"><a href="#cb191-1622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1623"><a href="#cb191-1623" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 4: extract noise</span></span>
<span id="cb191-1624"><a href="#cb191-1624" aria-hidden="true" tabindex="-1"></a>Subtracting the seasonal component from the detrended series gives us the residuals (noise):</span>
<span id="cb191-1625"><a href="#cb191-1625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1628"><a href="#cb191-1628" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-1629"><a href="#cb191-1629" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb191-1630"><a href="#cb191-1630" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">weekly_noise =</span> weekly_notr <span class="sc">-</span> sea_lo)</span>
<span id="cb191-1631"><a href="#cb191-1631" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-1632"><a href="#cb191-1632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1633"><a href="#cb191-1633" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 5: inspect noise properties</span></span>
<span id="cb191-1634"><a href="#cb191-1634" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1637"><a href="#cb191-1637" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-1638"><a href="#cb191-1638" aria-hidden="true" tabindex="-1"></a>noi_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(df_tra_2<span class="sc">$</span>weekly_noise, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb191-1639"><a href="#cb191-1639" aria-hidden="true" tabindex="-1"></a>noi_var  <span class="ot">&lt;-</span> <span class="fu">var</span>(df_tra_2<span class="sc">$</span>weekly_noise, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb191-1640"><a href="#cb191-1640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1641"><a href="#cb191-1641" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb191-1642"><a href="#cb191-1642" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> weekly_noise)) <span class="sc">+</span></span>
<span id="cb191-1643"><a href="#cb191-1643" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), <span class="at">bins =</span> <span class="dv">100</span>, <span class="at">fill =</span> <span class="st">"lightblue"</span>) <span class="sc">+</span></span>
<span id="cb191-1644"><a href="#cb191-1644" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb191-1645"><a href="#cb191-1645" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">"Histogram of Residual Noise</span><span class="sc">\n</span><span class="st">Mean = "</span>, <span class="fu">round</span>(noi_mean,<span class="dv">2</span>),</span>
<span id="cb191-1646"><a href="#cb191-1646" aria-hidden="true" tabindex="-1"></a>                        <span class="st">", Variance = "</span>, <span class="fu">round</span>(noi_var,<span class="dv">2</span>)),</span>
<span id="cb191-1647"><a href="#cb191-1647" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Residual Noise"</span>,</span>
<span id="cb191-1648"><a href="#cb191-1648" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Density"</span>) <span class="sc">+</span></span>
<span id="cb191-1649"><a href="#cb191-1649" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span>
<span id="cb191-1650"><a href="#cb191-1650" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-1651"><a href="#cb191-1651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1652"><a href="#cb191-1652" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 6: overlay noise vs. deterministic component</span></span>
<span id="cb191-1653"><a href="#cb191-1653" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1656"><a href="#cb191-1656" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-1657"><a href="#cb191-1657" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb191-1658"><a href="#cb191-1658" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> weekly_noise)) <span class="sc">+</span></span>
<span id="cb191-1659"><a href="#cb191-1659" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> year), <span class="at">alpha =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb191-1660"><a href="#cb191-1660" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tr_lo <span class="sc">+</span> sea_lo <span class="sc">-</span> <span class="fu">min</span>(tr_lo)), <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb191-1661"><a href="#cb191-1661" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb191-1662"><a href="#cb191-1662" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Residual Noise vs. Deterministic Component"</span>,</span>
<span id="cb191-1663"><a href="#cb191-1663" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb191-1664"><a href="#cb191-1664" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Residual Noise"</span>) <span class="sc">+</span></span>
<span id="cb191-1665"><a href="#cb191-1665" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span>
<span id="cb191-1666"><a href="#cb191-1666" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-1667"><a href="#cb191-1667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1668"><a href="#cb191-1668" aria-hidden="true" tabindex="-1"></a>This helps check whether noise amplitude scales with signal, which would indicate multiplicative effects.</span>
<span id="cb191-1669"><a href="#cb191-1669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1670"><a href="#cb191-1670" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 7: normalize noise by deterministic component</span></span>
<span id="cb191-1671"><a href="#cb191-1671" aria-hidden="true" tabindex="-1"></a>Compute a relative noise, dividing the residual by the deterministic component (trend + seasonality):</span>
<span id="cb191-1672"><a href="#cb191-1672" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1675"><a href="#cb191-1675" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-1676"><a href="#cb191-1676" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb191-1677"><a href="#cb191-1677" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">deterministic =</span> tr_lo <span class="sc">+</span> sea_lo,</span>
<span id="cb191-1678"><a href="#cb191-1678" aria-hidden="true" tabindex="-1"></a>         <span class="at">rel_noise =</span> weekly_noise <span class="sc">/</span> deterministic)</span>
<span id="cb191-1679"><a href="#cb191-1679" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-1680"><a href="#cb191-1680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1681"><a href="#cb191-1681" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>This gives an approximate multiplicative residual, which should have roughly constant variance if the multiplicative model is appropriate.</span>
<span id="cb191-1682"><a href="#cb191-1682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1683"><a href="#cb191-1683" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Values are interpretable as “fractional deviation from expected sales.</span>
<span id="cb191-1684"><a href="#cb191-1684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1685"><a href="#cb191-1685" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 8: compare additive vs. multiplicative noise variance</span></span>
<span id="cb191-1686"><a href="#cb191-1686" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1689"><a href="#cb191-1689" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-1690"><a href="#cb191-1690" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute standard deviation</span></span>
<span id="cb191-1691"><a href="#cb191-1691" aria-hidden="true" tabindex="-1"></a>additive_var <span class="ot">&lt;-</span> <span class="fu">var</span>(df_tra_2<span class="sc">$</span>weekly_noise, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb191-1692"><a href="#cb191-1692" aria-hidden="true" tabindex="-1"></a>multiplicative_var <span class="ot">&lt;-</span> <span class="fu">var</span>(df_tra_2<span class="sc">$</span>rel_noise, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb191-1693"><a href="#cb191-1693" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1694"><a href="#cb191-1694" aria-hidden="true" tabindex="-1"></a><span class="fu">tribble</span>(</span>
<span id="cb191-1695"><a href="#cb191-1695" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>model, <span class="sc">~</span>residual_variance,</span>
<span id="cb191-1696"><a href="#cb191-1696" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Additive"</span>, additive_var,</span>
<span id="cb191-1697"><a href="#cb191-1697" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Multiplicative"</span>, multiplicative_var</span>
<span id="cb191-1698"><a href="#cb191-1698" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb191-1699"><a href="#cb191-1699" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-1700"><a href="#cb191-1700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1701"><a href="#cb191-1701" aria-hidden="true" tabindex="-1"></a>Since the multiplicative variance is smaller, the multiplicative model stabilizes the residuals.</span>
<span id="cb191-1702"><a href="#cb191-1702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1703"><a href="#cb191-1703" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 9: visualize relative noise over time</span></span>
<span id="cb191-1704"><a href="#cb191-1704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1707"><a href="#cb191-1707" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-1708"><a href="#cb191-1708" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb191-1709"><a href="#cb191-1709" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> rel_noise, <span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb191-1710"><a href="#cb191-1710" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb191-1711"><a href="#cb191-1711" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb191-1712"><a href="#cb191-1712" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Relative (Multiplicative) Residuals"</span>,</span>
<span id="cb191-1713"><a href="#cb191-1713" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb191-1714"><a href="#cb191-1714" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Fractional Residual"</span>)</span>
<span id="cb191-1715"><a href="#cb191-1715" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-1716"><a href="#cb191-1716" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1717"><a href="#cb191-1717" aria-hidden="true" tabindex="-1"></a>This highlights whether the multiplicative model reduces the amplitude variation over the year.</span>
<span id="cb191-1718"><a href="#cb191-1718" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1719"><a href="#cb191-1719" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 10: histogram and normality check</span></span>
<span id="cb191-1720"><a href="#cb191-1720" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1723"><a href="#cb191-1723" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-1724"><a href="#cb191-1724" aria-hidden="true" tabindex="-1"></a>rel_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(df_tra_2<span class="sc">$</span>rel_noise, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb191-1725"><a href="#cb191-1725" aria-hidden="true" tabindex="-1"></a>rel_var  <span class="ot">&lt;-</span> <span class="fu">var</span>(df_tra_2<span class="sc">$</span>rel_noise, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb191-1726"><a href="#cb191-1726" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1727"><a href="#cb191-1727" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb191-1728"><a href="#cb191-1728" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> rel_noise)) <span class="sc">+</span></span>
<span id="cb191-1729"><a href="#cb191-1729" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), <span class="at">bins =</span> <span class="dv">100</span>, <span class="at">fill =</span> <span class="st">"lightblue"</span>) <span class="sc">+</span></span>
<span id="cb191-1730"><a href="#cb191-1730" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb191-1731"><a href="#cb191-1731" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">"Histogram of Relative Noise</span><span class="sc">\n</span><span class="st">Mean = "</span>, <span class="fu">round</span>(rel_mean,<span class="dv">2</span>),</span>
<span id="cb191-1732"><a href="#cb191-1732" aria-hidden="true" tabindex="-1"></a>                        <span class="st">", Variance = "</span>, <span class="fu">round</span>(rel_var,<span class="dv">2</span>)),</span>
<span id="cb191-1733"><a href="#cb191-1733" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Relative Residual"</span>,</span>
<span id="cb191-1734"><a href="#cb191-1734" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Density"</span>)</span>
<span id="cb191-1735"><a href="#cb191-1735" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-1736"><a href="#cb191-1736" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1737"><a href="#cb191-1737" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 11: log-transform for multiplicative model</span></span>
<span id="cb191-1738"><a href="#cb191-1738" aria-hidden="true" tabindex="-1"></a>Another way to handle multiplicative noise is to log-transform the data, which converts multiplicative effects into additive ones:</span>
<span id="cb191-1739"><a href="#cb191-1739" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1742"><a href="#cb191-1742" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-1743"><a href="#cb191-1743" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb191-1744"><a href="#cb191-1744" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">log_weekly =</span> <span class="fu">log</span>(weekly_sales),</span>
<span id="cb191-1745"><a href="#cb191-1745" aria-hidden="true" tabindex="-1"></a>         <span class="at">log_tr_lo  =</span> <span class="fu">log</span>(tr_lo),</span>
<span id="cb191-1746"><a href="#cb191-1746" aria-hidden="true" tabindex="-1"></a>         <span class="at">log_resid  =</span> log_weekly <span class="sc">-</span> log_tr_lo)</span>
<span id="cb191-1747"><a href="#cb191-1747" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1748"><a href="#cb191-1748" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb191-1749"><a href="#cb191-1749" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> log_weekly, <span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb191-1750"><a href="#cb191-1750" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb191-1751"><a href="#cb191-1751" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> log_tr_lo), <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb191-1752"><a href="#cb191-1752" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb191-1753"><a href="#cb191-1753" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Log-Transformed Weekly Sales with LOESS Trend"</span>,</span>
<span id="cb191-1754"><a href="#cb191-1754" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb191-1755"><a href="#cb191-1755" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"log(Weekly Sales)"</span></span>
<span id="cb191-1756"><a href="#cb191-1756" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb191-1757"><a href="#cb191-1757" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-1758"><a href="#cb191-1758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1759"><a href="#cb191-1759" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 12: examine the log residuals</span></span>
<span id="cb191-1760"><a href="#cb191-1760" aria-hidden="true" tabindex="-1"></a>Visualize the residuals in log-space to check if they’re roughly centered around zero and stationary.</span>
<span id="cb191-1761"><a href="#cb191-1761" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1764"><a href="#cb191-1764" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-1765"><a href="#cb191-1765" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb191-1766"><a href="#cb191-1766" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> log_resid, <span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb191-1767"><a href="#cb191-1767" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb191-1768"><a href="#cb191-1768" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb191-1769"><a href="#cb191-1769" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb191-1770"><a href="#cb191-1770" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Residuals in Log-Space (Multiplicative Noise)"</span>,</span>
<span id="cb191-1771"><a href="#cb191-1771" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb191-1772"><a href="#cb191-1772" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="fu">expression</span>(<span class="fu">log</span>(epsilon[t]))</span>
<span id="cb191-1773"><a href="#cb191-1773" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb191-1774"><a href="#cb191-1774" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-1775"><a href="#cb191-1775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1776"><a href="#cb191-1776" aria-hidden="true" tabindex="-1"></a>If the multiplicative model is appropriate, the residuals should have:  </span>
<span id="cb191-1777"><a href="#cb191-1777" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>constant variance over time, and</span>
<span id="cb191-1778"><a href="#cb191-1778" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>no clear seasonal pattern.</span>
<span id="cb191-1779"><a href="#cb191-1779" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1780"><a href="#cb191-1780" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 13: distribution of log residuals</span></span>
<span id="cb191-1781"><a href="#cb191-1781" aria-hidden="true" tabindex="-1"></a>Check the shape of the distribution (for normality):</span>
<span id="cb191-1782"><a href="#cb191-1782" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1785"><a href="#cb191-1785" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-1786"><a href="#cb191-1786" aria-hidden="true" tabindex="-1"></a>log_resid_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(df_tra_2<span class="sc">$</span>log_resid, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb191-1787"><a href="#cb191-1787" aria-hidden="true" tabindex="-1"></a>log_resid_var  <span class="ot">&lt;-</span> <span class="fu">var</span>(df_tra_2<span class="sc">$</span>log_resid, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb191-1788"><a href="#cb191-1788" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1789"><a href="#cb191-1789" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb191-1790"><a href="#cb191-1790" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> log_resid)) <span class="sc">+</span></span>
<span id="cb191-1791"><a href="#cb191-1791" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), <span class="at">bins =</span> <span class="dv">100</span>, <span class="at">fill =</span> <span class="st">"lightblue"</span>) <span class="sc">+</span></span>
<span id="cb191-1792"><a href="#cb191-1792" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_function</span>(<span class="at">fun =</span> dnorm,</span>
<span id="cb191-1793"><a href="#cb191-1793" aria-hidden="true" tabindex="-1"></a>                  <span class="at">args =</span> <span class="fu">list</span>(<span class="at">mean =</span> log_resid_mean, <span class="at">sd =</span> <span class="fu">sqrt</span>(log_resid_var)),</span>
<span id="cb191-1794"><a href="#cb191-1794" aria-hidden="true" tabindex="-1"></a>                  <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb191-1795"><a href="#cb191-1795" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb191-1796"><a href="#cb191-1796" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Distribution of Log Residuals (Multiplicative Model)"</span>,</span>
<span id="cb191-1797"><a href="#cb191-1797" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="fu">expression</span>(<span class="fu">log</span>(epsilon[t])),</span>
<span id="cb191-1798"><a href="#cb191-1798" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Density"</span></span>
<span id="cb191-1799"><a href="#cb191-1799" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb191-1800"><a href="#cb191-1800" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-1801"><a href="#cb191-1801" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1802"><a href="#cb191-1802" aria-hidden="true" tabindex="-1"></a>If the histogram closely follows the red curve (normal fit), the multiplicative model provides a valid Gaussian approximation in log-space.</span>
<span id="cb191-1803"><a href="#cb191-1803" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1804"><a href="#cb191-1804" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 14: quantitative comparison with additive model</span></span>
<span id="cb191-1805"><a href="#cb191-1805" aria-hidden="true" tabindex="-1"></a>To summarize model performance, compare residual moments and normality:</span>
<span id="cb191-1806"><a href="#cb191-1806" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1809"><a href="#cb191-1809" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-1810"><a href="#cb191-1810" aria-hidden="true" tabindex="-1"></a><span class="fu">tribble</span>(</span>
<span id="cb191-1811"><a href="#cb191-1811" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>Criterion, <span class="sc">~</span>Additive_Model, <span class="sc">~</span>Multiplicative_Model,</span>
<span id="cb191-1812"><a href="#cb191-1812" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Mean"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(df_tra_2<span class="sc">$</span>weekly_noise, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">4</span>), <span class="fu">round</span>(<span class="fu">mean</span>(df_tra_2<span class="sc">$</span>log_resid, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">4</span>),</span>
<span id="cb191-1813"><a href="#cb191-1813" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Variance"</span>, <span class="fu">round</span>(<span class="fu">var</span>(df_tra_2<span class="sc">$</span>weekly_noise, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">4</span>), <span class="fu">round</span>(<span class="fu">var</span>(df_tra_2<span class="sc">$</span>log_resid, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">4</span>),</span>
<span id="cb191-1814"><a href="#cb191-1814" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Shapiro-Wilk p-value"</span>,</span>
<span id="cb191-1815"><a href="#cb191-1815" aria-hidden="true" tabindex="-1"></a>  <span class="fu">signif</span>(<span class="fu">shapiro.test</span>(df_tra_2<span class="sc">$</span>weekly_noise)<span class="sc">$</span>p.value, <span class="dv">3</span>),</span>
<span id="cb191-1816"><a href="#cb191-1816" aria-hidden="true" tabindex="-1"></a>  <span class="fu">signif</span>(<span class="fu">shapiro.test</span>(df_tra_2<span class="sc">$</span>log_resid)<span class="sc">$</span>p.value, <span class="dv">3</span>)</span>
<span id="cb191-1817"><a href="#cb191-1817" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb191-1818"><a href="#cb191-1818" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-1819"><a href="#cb191-1819" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1820"><a href="#cb191-1820" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1821"><a href="#cb191-1821" aria-hidden="true" tabindex="-1"></a><span class="fu"># Frequency analysis of time series</span></span>
<span id="cb191-1822"><a href="#cb191-1822" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1823"><a href="#cb191-1823" aria-hidden="true" tabindex="-1"></a>This module explores **frequency analysis** to decompose a time series into its **trend**, **seasonality**, and **noise** components:</span>
<span id="cb191-1824"><a href="#cb191-1824" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1825"><a href="#cb191-1825" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-1826"><a href="#cb191-1826" aria-hidden="true" tabindex="-1"></a>y(t) = \mathrm{tr}(t) + s(t) + \epsilon_t</span>
<span id="cb191-1827"><a href="#cb191-1827" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-1828"><a href="#cb191-1828" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1829"><a href="#cb191-1829" aria-hidden="true" tabindex="-1"></a>Here, $\mathrm{tr}(t)$ represents the trend (long-term behavior), $s(t)$ represents seasonality (periodic patterns), and $\epsilon_t$ represents noise (random fluctuations). Typically, noise exhibits higher frequencies than seasonality, and seasonality has higher frequencies than the trend. This section introduces the **Fourier Transform** to analyze these components in the **frequency domain**.</span>
<span id="cb191-1830"><a href="#cb191-1830" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1831"><a href="#cb191-1831" aria-hidden="true" tabindex="-1"></a><span class="fu">## Fourier transform</span></span>
<span id="cb191-1832"><a href="#cb191-1832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1833"><a href="#cb191-1833" aria-hidden="true" tabindex="-1"></a>A time series can be represented as a sum of sine and cosine waves **with varying frequencies, amplitudes, and phases**:</span>
<span id="cb191-1834"><a href="#cb191-1834" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1835"><a href="#cb191-1835" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-1836"><a href="#cb191-1836" aria-hidden="true" tabindex="-1"></a>y(t) = x(0) + \sum_{k=1}^{n-1} x(k) \cos(k \omega t + \phi_k)</span>
<span id="cb191-1837"><a href="#cb191-1837" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-1838"><a href="#cb191-1838" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1839"><a href="#cb191-1839" aria-hidden="true" tabindex="-1"></a>where:  </span>
<span id="cb191-1840"><a href="#cb191-1840" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$t$ is the **sampling interval** (e.g., 1 day for daily data),  </span>
<span id="cb191-1841"><a href="#cb191-1841" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\omega = \frac{2\pi}{n}$ is the **frequency scaling factor** (for daily data with $n=365$),  </span>
<span id="cb191-1842"><a href="#cb191-1842" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$x(k)$ is the amplitude of the $k$-th frequency component,  </span>
<span id="cb191-1843"><a href="#cb191-1843" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\phi_k$ is the phase shift.</span>
<span id="cb191-1844"><a href="#cb191-1844" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1845"><a href="#cb191-1845" aria-hidden="true" tabindex="-1"></a>This is known as a **cosine transform**. Alternatively, we can use a **complex representation** combining sine and cosine terms:</span>
<span id="cb191-1846"><a href="#cb191-1846" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1847"><a href="#cb191-1847" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-1848"><a href="#cb191-1848" aria-hidden="true" tabindex="-1"></a>y(t) = \sum_{k=0}^{n-1} x(k) e^{ik\omega t}</span>
<span id="cb191-1849"><a href="#cb191-1849" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-1850"><a href="#cb191-1850" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1851"><a href="#cb191-1851" aria-hidden="true" tabindex="-1"></a>where $e^{ik\omega t} = \cos(k\omega t) + i \sin(k\omega t)$, and the coefficients $x(k)$ are computed via the **Fourier Transform**:</span>
<span id="cb191-1852"><a href="#cb191-1852" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1853"><a href="#cb191-1853" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-1854"><a href="#cb191-1854" aria-hidden="true" tabindex="-1"></a>x(k) = \sum_{t=0}^{n-1} y(t) e^{-ik\omega t}</span>
<span id="cb191-1855"><a href="#cb191-1855" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-1856"><a href="#cb191-1856" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1857"><a href="#cb191-1857" aria-hidden="true" tabindex="-1"></a>For a real-valued time series $y(t)$, the Fourier coefficients $x(k)$ are **conjugate symmetric**:</span>
<span id="cb191-1858"><a href="#cb191-1858" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1859"><a href="#cb191-1859" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-1860"><a href="#cb191-1860" aria-hidden="true" tabindex="-1"></a>x(k) = {x(n-k)}</span>
<span id="cb191-1861"><a href="#cb191-1861" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb191-1862"><a href="#cb191-1862" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1863"><a href="#cb191-1863" aria-hidden="true" tabindex="-1"></a>This ensures the imaginary parts cancel out in the inverse transform, yielding a real-valued time series. The first coefficient, $x(0)$, represents the **mean of the signal**.</span>
<span id="cb191-1864"><a href="#cb191-1864" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1865"><a href="#cb191-1865" aria-hidden="true" tabindex="-1"></a><span class="fu">## FA of synthetic time series</span></span>
<span id="cb191-1866"><a href="#cb191-1866" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1867"><a href="#cb191-1867" aria-hidden="true" tabindex="-1"></a>We begin with a synthetic time series dataset to illustrate Fourier analysis.</span>
<span id="cb191-1868"><a href="#cb191-1868" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1869"><a href="#cb191-1869" aria-hidden="true" tabindex="-1"></a><span class="fu">### Loading and visualizing the data</span></span>
<span id="cb191-1870"><a href="#cb191-1870" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1873"><a href="#cb191-1873" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-1874"><a href="#cb191-1874" aria-hidden="true" tabindex="-1"></a>fpath_ts2 <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{data_dir}/synthetic_TS_02.tsv"</span>)</span>
<span id="cb191-1875"><a href="#cb191-1875" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="ot">&lt;-</span> <span class="fu">read_tsv</span>(fpath_ts2)</span>
<span id="cb191-1876"><a href="#cb191-1876" aria-hidden="true" tabindex="-1"></a>df_ts2</span>
<span id="cb191-1877"><a href="#cb191-1877" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-1878"><a href="#cb191-1878" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1879"><a href="#cb191-1879" aria-hidden="true" tabindex="-1"></a>The dataset contains the time series $y_2$, trend ($tr(t)$), and deterministic component ($y_d(t) = tr(t) + s(t)$). Let's plot the time series with its trend (blue) and deterministic component (red):</span>
<span id="cb191-1880"><a href="#cb191-1880" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1883"><a href="#cb191-1883" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-1884"><a href="#cb191-1884" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&gt;%</span></span>
<span id="cb191-1885"><a href="#cb191-1885" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">str_replace</span>(year, <span class="st">"$"</span>, <span class="st">"-01-01"</span>) <span class="sc">%&gt;%</span> as_date) <span class="sc">%&gt;%</span></span>
<span id="cb191-1886"><a href="#cb191-1886" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> y_2)) <span class="sc">+</span></span>
<span id="cb191-1887"><a href="#cb191-1887" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb191-1888"><a href="#cb191-1888" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tr), <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb191-1889"><a href="#cb191-1889" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> yd), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb191-1890"><a href="#cb191-1890" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept =</span> year), <span class="at">color =</span> <span class="st">"grey50"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>)</span>
<span id="cb191-1891"><a href="#cb191-1891" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-1892"><a href="#cb191-1892" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1893"><a href="#cb191-1893" aria-hidden="true" tabindex="-1"></a><span class="fu">### Computing the Fourier transform</span></span>
<span id="cb191-1894"><a href="#cb191-1894" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1895"><a href="#cb191-1895" aria-hidden="true" tabindex="-1"></a>We use the **Fast Fourier Transform (FFT)** to compute the Fourier coefficients, their magnitudes, and phases:</span>
<span id="cb191-1896"><a href="#cb191-1896" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1899"><a href="#cb191-1899" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-1900"><a href="#cb191-1900" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb191-1901"><a href="#cb191-1901" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fft      =</span> <span class="fu">fft</span>(y_2),</span>
<span id="cb191-1902"><a href="#cb191-1902" aria-hidden="true" tabindex="-1"></a>         <span class="at">freq     =</span> <span class="dv">0</span><span class="sc">:</span>(<span class="fu">nrow</span>(df_ts2)<span class="sc">-</span><span class="dv">1</span>) <span class="sc">*</span> <span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">/</span> <span class="dv">365</span>,</span>
<span id="cb191-1903"><a href="#cb191-1903" aria-hidden="true" tabindex="-1"></a>         <span class="at">freq_mag =</span> <span class="fu">Mod</span>(fft) <span class="sc">/</span> <span class="fu">nrow</span>(df_ts2),</span>
<span id="cb191-1904"><a href="#cb191-1904" aria-hidden="true" tabindex="-1"></a>         <span class="at">freq_pha =</span> <span class="fu">Arg</span>(fft))</span>
<span id="cb191-1905"><a href="#cb191-1905" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1906"><a href="#cb191-1906" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&gt;%</span></span>
<span id="cb191-1907"><a href="#cb191-1907" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(day, y_2, fft, freq, freq_mag, freq_pha)</span>
<span id="cb191-1908"><a href="#cb191-1908" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-1909"><a href="#cb191-1909" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1910"><a href="#cb191-1910" aria-hidden="true" tabindex="-1"></a>The first coefficient ($x(0)$) corresponds to the mean of the signal. For our data, $x(0) \approx$ <span class="in">`r round(mean(df_ts2$y_2, digits = 3))`</span>.</span>
<span id="cb191-1911"><a href="#cb191-1911" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1912"><a href="#cb191-1912" aria-hidden="true" tabindex="-1"></a><span class="fu">### Plotting frequency magnitudes</span></span>
<span id="cb191-1913"><a href="#cb191-1913" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1914"><a href="#cb191-1914" aria-hidden="true" tabindex="-1"></a>We plot the magnitudes of the Fourier coefficients to **identify dominant frequencies**:</span>
<span id="cb191-1915"><a href="#cb191-1915" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1918"><a href="#cb191-1918" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-1919"><a href="#cb191-1919" aria-hidden="true" tabindex="-1"></a>thresh_mag <span class="ot">&lt;-</span> <span class="fl">0.14</span></span>
<span id="cb191-1920"><a href="#cb191-1920" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1921"><a href="#cb191-1921" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&gt;%</span></span>
<span id="cb191-1922"><a href="#cb191-1922" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> freq, <span class="at">y =</span> freq_mag)) <span class="sc">+</span></span>
<span id="cb191-1923"><a href="#cb191-1923" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb191-1924"><a href="#cb191-1924" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">mean</span>(df_ts2<span class="sc">$</span>freq), <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb191-1925"><a href="#cb191-1925" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> thresh_mag, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb191-1926"><a href="#cb191-1926" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylim</span>(<span class="cn">NA</span>, <span class="dv">1</span>)</span>
<span id="cb191-1927"><a href="#cb191-1927" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-1928"><a href="#cb191-1928" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1929"><a href="#cb191-1929" aria-hidden="true" tabindex="-1"></a>The plot shows symmetry due to the real-valued nature of the time series. Alternatively, we can use the <span class="in">`periodogram()`</span> function from the <span class="in">`TSA`</span> package in R to compute the same:</span>
<span id="cb191-1930"><a href="#cb191-1930" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1933"><a href="#cb191-1933" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-1934"><a href="#cb191-1934" aria-hidden="true" tabindex="-1"></a><span class="fu">periodogram</span>(df_ts2<span class="sc">$</span>y_2)</span>
<span id="cb191-1935"><a href="#cb191-1935" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-1936"><a href="#cb191-1936" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1937"><a href="#cb191-1937" aria-hidden="true" tabindex="-1"></a>**Dominant frequencies** appear at the **lower end**, corresponding to **trend and seasonality**.</span>
<span id="cb191-1938"><a href="#cb191-1938" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1939"><a href="#cb191-1939" aria-hidden="true" tabindex="-1"></a><span class="fu">### Thresholding and inverse Fourier transform</span></span>
<span id="cb191-1940"><a href="#cb191-1940" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1941"><a href="#cb191-1941" aria-hidden="true" tabindex="-1"></a>We threshold the Fourier coefficients by setting those with magnitudes below <span class="in">`thresh_mag = 0.14`</span> to zero, then apply the inverse Fourier transform to recover the signal:</span>
<span id="cb191-1942"><a href="#cb191-1942" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1945"><a href="#cb191-1945" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-1946"><a href="#cb191-1946" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb191-1947"><a href="#cb191-1947" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fft_hi  =</span> <span class="fu">if_else</span>(freq_mag <span class="sc">&gt;</span> thresh_mag, fft, <span class="dv">0</span>),</span>
<span id="cb191-1948"><a href="#cb191-1948" aria-hidden="true" tabindex="-1"></a>         <span class="at">pha_hi  =</span> <span class="fu">if_else</span>(freq_mag <span class="sc">&gt;</span> thresh_mag, freq_pha, <span class="dv">0</span>),</span>
<span id="cb191-1949"><a href="#cb191-1949" aria-hidden="true" tabindex="-1"></a>         <span class="at">fft_lo  =</span> <span class="fu">if_else</span>(freq_mag <span class="sc">&lt;=</span> thresh_mag, fft, <span class="dv">0</span>),</span>
<span id="cb191-1950"><a href="#cb191-1950" aria-hidden="true" tabindex="-1"></a>         <span class="at">fft_max =</span> <span class="fu">ifelse</span>(<span class="fu">row_number</span>() <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="fu">nrow</span>(df_ts2)), freq_mag, <span class="dv">0</span>),</span>
<span id="cb191-1951"><a href="#cb191-1951" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_hi    =</span> <span class="fu">fft</span>(fft_hi, <span class="at">inverse =</span> <span class="cn">TRUE</span>),</span>
<span id="cb191-1952"><a href="#cb191-1952" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_lo    =</span> <span class="fu">fft</span>(fft_lo, <span class="at">inverse =</span> <span class="cn">TRUE</span>),</span>
<span id="cb191-1953"><a href="#cb191-1953" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_max   =</span> <span class="fu">fft</span>(fft_max, <span class="at">inverse =</span> <span class="cn">TRUE</span>))</span>
<span id="cb191-1954"><a href="#cb191-1954" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-1955"><a href="#cb191-1955" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1956"><a href="#cb191-1956" aria-hidden="true" tabindex="-1"></a>Verify that the recovered signal is real (imaginary parts are negligible):</span>
<span id="cb191-1957"><a href="#cb191-1957" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1960"><a href="#cb191-1960" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-1961"><a href="#cb191-1961" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&gt;%</span> </span>
<span id="cb191-1962"><a href="#cb191-1962" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(y_2, y_hi) <span class="sc">%&gt;%</span> </span>
<span id="cb191-1963"><a href="#cb191-1963" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">im_hi =</span> <span class="fu">Im</span>(y_hi)) <span class="sc">%&gt;%</span> </span>
<span id="cb191-1964"><a href="#cb191-1964" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(im_hi)</span>
<span id="cb191-1965"><a href="#cb191-1965" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-1966"><a href="#cb191-1966" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1967"><a href="#cb191-1967" aria-hidden="true" tabindex="-1"></a>Now, we scale the high-frequency component to match the seasonality ($sea$) and plot:</span>
<span id="cb191-1968"><a href="#cb191-1968" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1971"><a href="#cb191-1971" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-1972"><a href="#cb191-1972" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb191-1973"><a href="#cb191-1973" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y_hi =</span> <span class="fu">Re</span>(y_hi),</span>
<span id="cb191-1974"><a href="#cb191-1974" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_lo =</span> <span class="fu">Re</span>(y_lo),</span>
<span id="cb191-1975"><a href="#cb191-1975" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_max =</span> <span class="fu">Re</span>(y_max),</span>
<span id="cb191-1976"><a href="#cb191-1976" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_hi =</span> y_hi <span class="sc">-</span> <span class="fu">mean</span>(y_hi),</span>
<span id="cb191-1977"><a href="#cb191-1977" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_hi =</span> y_hi <span class="sc">/</span> <span class="fu">max</span>(<span class="fu">abs</span>(y_hi)) <span class="sc">*</span> <span class="fu">max</span>(<span class="fu">abs</span>(sea)))</span>
<span id="cb191-1978"><a href="#cb191-1978" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1979"><a href="#cb191-1979" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&gt;%</span></span>
<span id="cb191-1980"><a href="#cb191-1980" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">str_replace</span>(year, <span class="st">"$"</span>, <span class="st">"-01-01"</span>) <span class="sc">%&gt;%</span> as_date) <span class="sc">%&gt;%</span></span>
<span id="cb191-1981"><a href="#cb191-1981" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> y_hi)) <span class="sc">+</span></span>
<span id="cb191-1982"><a href="#cb191-1982" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb191-1983"><a href="#cb191-1983" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> sea), <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb191-1984"><a href="#cb191-1984" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept =</span> year), <span class="at">color =</span> <span class="st">"grey50"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>)</span>
<span id="cb191-1985"><a href="#cb191-1985" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-1986"><a href="#cb191-1986" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1987"><a href="#cb191-1987" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1988"><a href="#cb191-1988" aria-hidden="true" tabindex="-1"></a><span class="fu">### Analyzing noise</span></span>
<span id="cb191-1989"><a href="#cb191-1989" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1990"><a href="#cb191-1990" aria-hidden="true" tabindex="-1"></a>The low-magnitude frequencies represent noise. Let's plot them:</span>
<span id="cb191-1991"><a href="#cb191-1991" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-1994"><a href="#cb191-1994" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-1995"><a href="#cb191-1995" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&gt;%</span></span>
<span id="cb191-1996"><a href="#cb191-1996" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> y_lo)) <span class="sc">+</span> </span>
<span id="cb191-1997"><a href="#cb191-1997" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>()</span>
<span id="cb191-1998"><a href="#cb191-1998" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-1999"><a href="#cb191-1999" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2000"><a href="#cb191-2000" aria-hidden="true" tabindex="-1"></a>Compute the mean and variance of the noise:</span>
<span id="cb191-2001"><a href="#cb191-2001" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2004"><a href="#cb191-2004" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-2005"><a href="#cb191-2005" aria-hidden="true" tabindex="-1"></a>mean_y_lo <span class="ot">&lt;-</span> <span class="fu">mean</span>(df_ts2<span class="sc">$</span>y_lo)</span>
<span id="cb191-2006"><a href="#cb191-2006" aria-hidden="true" tabindex="-1"></a>var_y_lo <span class="ot">&lt;-</span> <span class="fu">var</span>(df_ts2<span class="sc">$</span>y_lo)</span>
<span id="cb191-2007"><a href="#cb191-2007" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Mean:"</span>, mean_y_lo, <span class="st">"</span><span class="sc">\n</span><span class="st">Variance:"</span>, var_y_lo)</span>
<span id="cb191-2008"><a href="#cb191-2008" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2009"><a href="#cb191-2009" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2010"><a href="#cb191-2010" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2011"><a href="#cb191-2011" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2012"><a href="#cb191-2012" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2013"><a href="#cb191-2013" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2014"><a href="#cb191-2014" aria-hidden="true" tabindex="-1"></a>**Homework 2**: Can we recover a Poisson-like noise distribution from the synthetic data? Investigate whether scaling is needed and estimate the Poisson parameter. Plot the histogram of <span class="sc">\(</span>y_lo<span class="sc">\)</span> and overlay a Poisson distribution.</span>
<span id="cb191-2015"><a href="#cb191-2015" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2016"><a href="#cb191-2016" aria-hidden="true" tabindex="-1"></a><span class="fu">### Phase analysis</span></span>
<span id="cb191-2017"><a href="#cb191-2017" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2018"><a href="#cb191-2018" aria-hidden="true" tabindex="-1"></a>We plot the phases for high-amplitude frequencies (first half of the data):</span>
<span id="cb191-2019"><a href="#cb191-2019" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2022"><a href="#cb191-2022" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-2023"><a href="#cb191-2023" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&gt;%</span></span>
<span id="cb191-2024"><a href="#cb191-2024" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">row_number</span>() <span class="sc">&lt;=</span> <span class="fu">nrow</span>(df_ts2) <span class="sc">/</span> <span class="dv">2</span>, freq_mag <span class="sc">&gt;</span> thresh_mag) <span class="sc">%&gt;%</span></span>
<span id="cb191-2025"><a href="#cb191-2025" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> freq, <span class="at">y =</span> pha_hi)) <span class="sc">+</span></span>
<span id="cb191-2026"><a href="#cb191-2026" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb191-2027"><a href="#cb191-2027" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb191-2028"><a href="#cb191-2028" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>)</span>
<span id="cb191-2029"><a href="#cb191-2029" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2030"><a href="#cb191-2030" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2031"><a href="#cb191-2031" aria-hidden="true" tabindex="-1"></a>To analyze **phase shifts across years**, consider extracting seasonality for each year and comparing **phases of dominant frequencies**.</span>
<span id="cb191-2032"><a href="#cb191-2032" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2033"><a href="#cb191-2033" aria-hidden="true" tabindex="-1"></a><span class="fu">## Auto-correlation</span></span>
<span id="cb191-2034"><a href="#cb191-2034" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2035"><a href="#cb191-2035" aria-hidden="true" tabindex="-1"></a>Auto-correlation measures the **correlation of the time series with itself at different lags**:</span>
<span id="cb191-2036"><a href="#cb191-2036" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2039"><a href="#cb191-2039" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-2040"><a href="#cb191-2040" aria-hidden="true" tabindex="-1"></a>acf_ts2 <span class="ot">&lt;-</span> <span class="fu">acf</span>(df_ts2<span class="sc">$</span>y_2, <span class="at">lag.max =</span> <span class="fu">nrow</span>(df_ts2)<span class="sc">/</span><span class="dv">2</span>, <span class="at">plot =</span> <span class="cn">TRUE</span>)</span>
<span id="cb191-2041"><a href="#cb191-2041" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2042"><a href="#cb191-2042" aria-hidden="true" tabindex="-1"></a>df_acf <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">lag =</span> acf_ts2<span class="sc">$</span>lag[,<span class="dv">1</span>,<span class="dv">1</span>],</span>
<span id="cb191-2043"><a href="#cb191-2043" aria-hidden="true" tabindex="-1"></a>                 <span class="at">acf =</span> acf_ts2<span class="sc">$</span>acf[,<span class="dv">1</span>,<span class="dv">1</span>])</span>
<span id="cb191-2044"><a href="#cb191-2044" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2045"><a href="#cb191-2045" aria-hidden="true" tabindex="-1"></a>lag_year <span class="ot">&lt;-</span></span>
<span id="cb191-2046"><a href="#cb191-2046" aria-hidden="true" tabindex="-1"></a>  df_acf <span class="sc">%&gt;%</span></span>
<span id="cb191-2047"><a href="#cb191-2047" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(lag <span class="sc">&gt;</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span></span>
<span id="cb191-2048"><a href="#cb191-2048" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(acf <span class="sc">&lt;</span> <span class="fu">max</span>(acf) <span class="sc">+</span> <span class="fl">0.01</span>,</span>
<span id="cb191-2049"><a href="#cb191-2049" aria-hidden="true" tabindex="-1"></a>         acf <span class="sc">&gt;</span> <span class="fu">max</span>(acf) <span class="sc">-</span> <span class="fl">0.01</span>) <span class="sc">%&gt;%</span></span>
<span id="cb191-2050"><a href="#cb191-2050" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract2</span>(<span class="st">"lag"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb191-2051"><a href="#cb191-2051" aria-hidden="true" tabindex="-1"></a>  mean</span>
<span id="cb191-2052"><a href="#cb191-2052" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2053"><a href="#cb191-2053" aria-hidden="true" tabindex="-1"></a>df_acf <span class="sc">%&gt;%</span> </span>
<span id="cb191-2054"><a href="#cb191-2054" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(lag <span class="sc">&gt;</span> <span class="dv">340</span>,</span>
<span id="cb191-2055"><a href="#cb191-2055" aria-hidden="true" tabindex="-1"></a>         lag <span class="sc">&lt;</span> <span class="dv">430</span>) <span class="sc">%&gt;%</span></span>
<span id="cb191-2056"><a href="#cb191-2056" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> lag, <span class="at">y =</span> acf)) <span class="sc">+</span></span>
<span id="cb191-2057"><a href="#cb191-2057" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb191-2058"><a href="#cb191-2058" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> lag_year, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>)</span>
<span id="cb191-2059"><a href="#cb191-2059" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2060"><a href="#cb191-2060" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2061"><a href="#cb191-2061" aria-hidden="true" tabindex="-1"></a>This helps **identify the periodicity** (e.g., yearly cycles).</span>
<span id="cb191-2062"><a href="#cb191-2062" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2063"><a href="#cb191-2063" aria-hidden="true" tabindex="-1"></a><span class="fu">## Real-life data</span></span>
<span id="cb191-2064"><a href="#cb191-2064" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2065"><a href="#cb191-2065" aria-hidden="true" tabindex="-1"></a>We now apply Fourier analysis to real-world supply chain data from Walmart.</span>
<span id="cb191-2066"><a href="#cb191-2066" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2067"><a href="#cb191-2067" aria-hidden="true" tabindex="-1"></a><span class="fu">### Loading and Visualizing the Data</span></span>
<span id="cb191-2068"><a href="#cb191-2068" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2071"><a href="#cb191-2071" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-2072"><a href="#cb191-2072" aria-hidden="true" tabindex="-1"></a>fpath_tra <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{data_dir}/Walmart/train.csv"</span>)</span>
<span id="cb191-2073"><a href="#cb191-2073" aria-hidden="true" tabindex="-1"></a>df_tra <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(fpath_tra) <span class="sc">%&gt;%</span> </span>
<span id="cb191-2074"><a href="#cb191-2074" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_all</span>(tolower) <span class="sc">%&gt;%</span> </span>
<span id="cb191-2075"><a href="#cb191-2075" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">is_holiday =</span> isholiday)</span>
<span id="cb191-2076"><a href="#cb191-2076" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2077"><a href="#cb191-2077" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="ot">&lt;-</span> df_tra <span class="sc">%&gt;%</span> </span>
<span id="cb191-2078"><a href="#cb191-2078" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(dept <span class="sc">==</span> <span class="dv">2</span>, store <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb191-2079"><a href="#cb191-2079" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">ws =</span> weekly_sales, <span class="at">is_hday =</span> is_holiday)</span>
<span id="cb191-2080"><a href="#cb191-2080" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2081"><a href="#cb191-2081" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb191-2082"><a href="#cb191-2082" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> ws)) <span class="sc">+</span></span>
<span id="cb191-2083"><a href="#cb191-2083" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb191-2084"><a href="#cb191-2084" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>()</span>
<span id="cb191-2085"><a href="#cb191-2085" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2086"><a href="#cb191-2086" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2087"><a href="#cb191-2087" aria-hidden="true" tabindex="-1"></a><span class="fu">### Smoothing analysis</span></span>
<span id="cb191-2088"><a href="#cb191-2088" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2089"><a href="#cb191-2089" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Trend</span></span>
<span id="cb191-2090"><a href="#cb191-2090" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2091"><a href="#cb191-2091" aria-hidden="true" tabindex="-1"></a>The linear trend may not capture non-linear patterns (e.g., a dip in 2011). We first remove the linear trend and then fit a LOESS smoother with a high span ($span = 0.7$):</span>
<span id="cb191-2092"><a href="#cb191-2092" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2095"><a href="#cb191-2095" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-2096"><a href="#cb191-2096" aria-hidden="true" tabindex="-1"></a>loess_span_hi <span class="ot">&lt;-</span> <span class="fl">0.70</span></span>
<span id="cb191-2097"><a href="#cb191-2097" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2098"><a href="#cb191-2098" aria-hidden="true" tabindex="-1"></a>lm_tr <span class="ot">&lt;-</span> <span class="fu">lm</span>(ws <span class="sc">~</span> date, <span class="at">data =</span> df_tra_2)</span>
<span id="cb191-2099"><a href="#cb191-2099" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb191-2100"><a href="#cb191-2100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tr_lm =</span> lm_tr<span class="sc">$</span>fitted,</span>
<span id="cb191-2101"><a href="#cb191-2101" aria-hidden="true" tabindex="-1"></a>         <span class="at">ws_1  =</span> ws <span class="sc">-</span> tr_lm)</span>
<span id="cb191-2102"><a href="#cb191-2102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2103"><a href="#cb191-2103" aria-hidden="true" tabindex="-1"></a>lo_tr_1 <span class="ot">&lt;-</span> <span class="fu">loess</span>(ws_1 <span class="sc">~</span> <span class="fu">as.numeric</span>(date), <span class="at">data =</span> df_tra_2, <span class="at">span =</span> loess_span_hi)</span>
<span id="cb191-2104"><a href="#cb191-2104" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb191-2105"><a href="#cb191-2105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tr_lo_1 =</span> lo_tr_1<span class="sc">$</span>fitted,</span>
<span id="cb191-2106"><a href="#cb191-2106" aria-hidden="true" tabindex="-1"></a>         <span class="at">ws_2  =</span> ws_1 <span class="sc">-</span> tr_lo_1)</span>
<span id="cb191-2107"><a href="#cb191-2107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2108"><a href="#cb191-2108" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb191-2109"><a href="#cb191-2109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> ws_1)) <span class="sc">+</span></span>
<span id="cb191-2110"><a href="#cb191-2110" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb191-2111"><a href="#cb191-2111" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tr_lo_1), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>)</span>
<span id="cb191-2112"><a href="#cb191-2112" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2113"><a href="#cb191-2113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2114"><a href="#cb191-2114" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Seasonality</span></span>
<span id="cb191-2115"><a href="#cb191-2115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2116"><a href="#cb191-2116" aria-hidden="true" tabindex="-1"></a>We fit a LOESS smoother with a lower span ($span = 0.1$) to capture seasonality:</span>
<span id="cb191-2117"><a href="#cb191-2117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2120"><a href="#cb191-2120" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-2121"><a href="#cb191-2121" aria-hidden="true" tabindex="-1"></a>loess_span_lo <span class="ot">&lt;-</span> <span class="fl">0.1</span></span>
<span id="cb191-2122"><a href="#cb191-2122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2123"><a href="#cb191-2123" aria-hidden="true" tabindex="-1"></a>lo_tr_2 <span class="ot">&lt;-</span> <span class="fu">loess</span>(ws_2 <span class="sc">~</span> <span class="fu">as.numeric</span>(date), <span class="at">data =</span> df_tra_2, <span class="at">span =</span> loess_span_lo)</span>
<span id="cb191-2124"><a href="#cb191-2124" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb191-2125"><a href="#cb191-2125" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tr_lo_2 =</span> lo_tr_2<span class="sc">$</span>fitted,</span>
<span id="cb191-2126"><a href="#cb191-2126" aria-hidden="true" tabindex="-1"></a>         <span class="at">ws_3    =</span> ws_2 <span class="sc">-</span> tr_lo_2)</span>
<span id="cb191-2127"><a href="#cb191-2127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2128"><a href="#cb191-2128" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb191-2129"><a href="#cb191-2129" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> ws_2)) <span class="sc">+</span></span>
<span id="cb191-2130"><a href="#cb191-2130" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb191-2131"><a href="#cb191-2131" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tr_lo_2), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>)</span>
<span id="cb191-2132"><a href="#cb191-2132" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2133"><a href="#cb191-2133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2134"><a href="#cb191-2134" aria-hidden="true" tabindex="-1"></a><span class="fu">### Fourier analysis</span></span>
<span id="cb191-2135"><a href="#cb191-2135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2136"><a href="#cb191-2136" aria-hidden="true" tabindex="-1"></a>We compute the Fourier transform for the real-life data:</span>
<span id="cb191-2137"><a href="#cb191-2137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2140"><a href="#cb191-2140" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-2141"><a href="#cb191-2141" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb191-2142"><a href="#cb191-2142" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fft_ws   =</span> <span class="fu">fft</span>(ws),</span>
<span id="cb191-2143"><a href="#cb191-2143" aria-hidden="true" tabindex="-1"></a>         <span class="at">freq     =</span> <span class="dv">0</span><span class="sc">:</span>(<span class="fu">nrow</span>(df_tra_2)<span class="sc">-</span><span class="dv">1</span>) <span class="sc">*</span> <span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">/</span> <span class="dv">365</span>,</span>
<span id="cb191-2144"><a href="#cb191-2144" aria-hidden="true" tabindex="-1"></a>         <span class="at">freq_mag =</span> <span class="fu">Mod</span>(fft_ws) <span class="sc">/</span> <span class="fu">nrow</span>(df_ts2),</span>
<span id="cb191-2145"><a href="#cb191-2145" aria-hidden="true" tabindex="-1"></a>         <span class="at">freq_pha =</span> <span class="fu">Arg</span>(fft_ws))</span>
<span id="cb191-2146"><a href="#cb191-2146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2147"><a href="#cb191-2147" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb191-2148"><a href="#cb191-2148" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> freq, <span class="at">y =</span> freq_mag)) <span class="sc">+</span></span>
<span id="cb191-2149"><a href="#cb191-2149" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb191-2150"><a href="#cb191-2150" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="cn">NA</span>, <span class="dv">150</span>)</span>
<span id="cb191-2151"><a href="#cb191-2151" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2152"><a href="#cb191-2152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2153"><a href="#cb191-2153" aria-hidden="true" tabindex="-1"></a>The <span class="in">`periodogram`</span> is more complex due to weekly data, where **noise and seasonality frequencies are less distinct than in daily data**.</span>
<span id="cb191-2154"><a href="#cb191-2154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2155"><a href="#cb191-2155" aria-hidden="true" tabindex="-1"></a>We separate frequencies into three groups:  </span>
<span id="cb191-2156"><a href="#cb191-2156" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Lowest frequency**: Trend/cycle.  </span>
<span id="cb191-2157"><a href="#cb191-2157" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Low frequencies**: Seasonality.  </span>
<span id="cb191-2158"><a href="#cb191-2158" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**High frequencies**: Noise.</span>
<span id="cb191-2159"><a href="#cb191-2159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2162"><a href="#cb191-2162" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-2163"><a href="#cb191-2163" aria-hidden="true" tabindex="-1"></a>thresh_mag_ws <span class="ot">&lt;-</span> <span class="dv">120</span></span>
<span id="cb191-2164"><a href="#cb191-2164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2165"><a href="#cb191-2165" aria-hidden="true" tabindex="-1"></a>freq_last_lof <span class="ot">&lt;-</span> df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb191-2166"><a href="#cb191-2166" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">row_number</span>() <span class="sc">&lt;</span> <span class="fu">nrow</span>(df_tra_2) <span class="sc">/</span> <span class="dv">2</span>, freq_mag <span class="sc">&gt;=</span> thresh_mag_ws) <span class="sc">%&gt;%</span></span>
<span id="cb191-2167"><a href="#cb191-2167" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(freq) <span class="sc">%&gt;%</span></span>
<span id="cb191-2168"><a href="#cb191-2168" aria-hidden="true" tabindex="-1"></a>  last</span>
<span id="cb191-2169"><a href="#cb191-2169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2170"><a href="#cb191-2170" aria-hidden="true" tabindex="-1"></a>idx_last_lof <span class="ot">&lt;-</span> <span class="fu">which</span>(df_tra_2<span class="sc">$</span>freq <span class="sc">==</span> freq_last_lof)</span>
<span id="cb191-2171"><a href="#cb191-2171" aria-hidden="true" tabindex="-1"></a>n_tra_2 <span class="ot">&lt;-</span> <span class="fu">nrow</span>(df_tra_2)</span>
<span id="cb191-2172"><a href="#cb191-2172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2173"><a href="#cb191-2173" aria-hidden="true" tabindex="-1"></a>list_idx_minf <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, n_tra_2)</span>
<span id="cb191-2174"><a href="#cb191-2174" aria-hidden="true" tabindex="-1"></a>list_idx_lof <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span>idx_last_lof, (n_tra_2 <span class="sc">-</span> idx_last_lof <span class="sc">+</span> <span class="dv">2</span>)<span class="sc">:</span>n_tra_2) <span class="sc">%&gt;%</span></span>
<span id="cb191-2175"><a href="#cb191-2175" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setdiff</span>(list_idx_minf) <span class="sc">%&gt;%</span></span>
<span id="cb191-2176"><a href="#cb191-2176" aria-hidden="true" tabindex="-1"></a>  <span class="fu">union</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb191-2177"><a href="#cb191-2177" aria-hidden="true" tabindex="-1"></a>  sort</span>
<span id="cb191-2178"><a href="#cb191-2178" aria-hidden="true" tabindex="-1"></a>list_idx_hif <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, (idx_last_lof <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(n_tra_2 <span class="sc">-</span> idx_last_lof <span class="sc">+</span> <span class="dv">1</span>))</span>
<span id="cb191-2179"><a href="#cb191-2179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2180"><a href="#cb191-2180" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb191-2181"><a href="#cb191-2181" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fft_lof  =</span> <span class="fu">if_else</span>(<span class="fu">row_number</span>() <span class="sc">%in%</span> list_idx_lof, fft_ws, <span class="dv">0</span>),</span>
<span id="cb191-2182"><a href="#cb191-2182" aria-hidden="true" tabindex="-1"></a>         <span class="at">fft_hif  =</span> <span class="fu">if_else</span>(<span class="fu">row_number</span>() <span class="sc">%in%</span> list_idx_hif, fft_ws, <span class="dv">0</span>),</span>
<span id="cb191-2183"><a href="#cb191-2183" aria-hidden="true" tabindex="-1"></a>         <span class="at">fft_minf =</span> <span class="fu">if_else</span>(<span class="fu">row_number</span>() <span class="sc">%in%</span> list_idx_minf, fft_ws, <span class="dv">0</span>),</span>
<span id="cb191-2184"><a href="#cb191-2184" aria-hidden="true" tabindex="-1"></a>         <span class="at">ws_lof   =</span> <span class="fu">fft</span>(fft_lof, <span class="at">inverse =</span> <span class="cn">TRUE</span>),</span>
<span id="cb191-2185"><a href="#cb191-2185" aria-hidden="true" tabindex="-1"></a>         <span class="at">ws_hif   =</span> <span class="fu">fft</span>(fft_hif, <span class="at">inverse =</span> <span class="cn">TRUE</span>),</span>
<span id="cb191-2186"><a href="#cb191-2186" aria-hidden="true" tabindex="-1"></a>         <span class="at">ws_minf  =</span> <span class="fu">fft</span>(fft_minf, <span class="at">inverse =</span> <span class="cn">TRUE</span>))</span>
<span id="cb191-2187"><a href="#cb191-2187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2188"><a href="#cb191-2188" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb191-2189"><a href="#cb191-2189" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ws_lof  =</span> <span class="fu">Re</span>(ws_lof),</span>
<span id="cb191-2190"><a href="#cb191-2190" aria-hidden="true" tabindex="-1"></a>         <span class="at">ws_hif  =</span> <span class="fu">Re</span>(ws_hif),</span>
<span id="cb191-2191"><a href="#cb191-2191" aria-hidden="true" tabindex="-1"></a>         <span class="at">ws_minf =</span> <span class="fu">Re</span>(ws_minf))</span>
<span id="cb191-2192"><a href="#cb191-2192" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2193"><a href="#cb191-2193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2194"><a href="#cb191-2194" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Trend/cycle</span></span>
<span id="cb191-2195"><a href="#cb191-2195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2196"><a href="#cb191-2196" aria-hidden="true" tabindex="-1"></a>Compare the LOESS trend (red) with the lowest-frequency component (blue):</span>
<span id="cb191-2197"><a href="#cb191-2197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2200"><a href="#cb191-2200" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-2201"><a href="#cb191-2201" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb191-2202"><a href="#cb191-2202" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ws_minf =</span> (ws_minf <span class="sc">-</span> <span class="fu">mean</span>(ws_minf)) <span class="sc">/</span> <span class="fu">sd</span>(ws_minf) <span class="sc">*</span> <span class="dv">1200</span>)</span>
<span id="cb191-2203"><a href="#cb191-2203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2204"><a href="#cb191-2204" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb191-2205"><a href="#cb191-2205" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> ws_1)) <span class="sc">+</span></span>
<span id="cb191-2206"><a href="#cb191-2206" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb191-2207"><a href="#cb191-2207" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tr_lo_1), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb191-2208"><a href="#cb191-2208" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> ws_minf), <span class="at">color =</span> <span class="st">"blue"</span>)</span>
<span id="cb191-2209"><a href="#cb191-2209" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2210"><a href="#cb191-2210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2211"><a href="#cb191-2211" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Seasonality</span></span>
<span id="cb191-2212"><a href="#cb191-2212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2213"><a href="#cb191-2213" aria-hidden="true" tabindex="-1"></a>Compare the LOESS seasonality (red) with the low-frequency component (blue):</span>
<span id="cb191-2214"><a href="#cb191-2214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2217"><a href="#cb191-2217" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-2218"><a href="#cb191-2218" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb191-2219"><a href="#cb191-2219" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> ws_2)) <span class="sc">+</span></span>
<span id="cb191-2220"><a href="#cb191-2220" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb191-2221"><a href="#cb191-2221" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tr_lo_2), <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb191-2222"><a href="#cb191-2222" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> ws_lof), <span class="at">color =</span> <span class="st">"blue"</span>)</span>
<span id="cb191-2223"><a href="#cb191-2223" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2224"><a href="#cb191-2224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2225"><a href="#cb191-2225" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Noise</span></span>
<span id="cb191-2226"><a href="#cb191-2226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2227"><a href="#cb191-2227" aria-hidden="true" tabindex="-1"></a>Analyze the high-frequency component:</span>
<span id="cb191-2228"><a href="#cb191-2228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2231"><a href="#cb191-2231" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-2232"><a href="#cb191-2232" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb191-2233"><a href="#cb191-2233" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ws_hif =</span> (ws_hif <span class="sc">-</span> <span class="fu">median</span>(ws_hif)) <span class="sc">/</span> <span class="fu">sd</span>(ws_hif))</span>
<span id="cb191-2234"><a href="#cb191-2234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2235"><a href="#cb191-2235" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb191-2236"><a href="#cb191-2236" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> ws_hif)) <span class="sc">+</span></span>
<span id="cb191-2237"><a href="#cb191-2237" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>()</span>
<span id="cb191-2238"><a href="#cb191-2238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2239"><a href="#cb191-2239" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb191-2240"><a href="#cb191-2240" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> ws_hif)) <span class="sc">+</span></span>
<span id="cb191-2241"><a href="#cb191-2241" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_histogram</span>() <span class="sc">+</span></span>
<span id="cb191-2242"><a href="#cb191-2242" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>)</span>
<span id="cb191-2243"><a href="#cb191-2243" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2244"><a href="#cb191-2244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2245"><a href="#cb191-2245" aria-hidden="true" tabindex="-1"></a><span class="fu">## Homeworks</span></span>
<span id="cb191-2246"><a href="#cb191-2246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2247"><a href="#cb191-2247" aria-hidden="true" tabindex="-1"></a><span class="fu">### Homework 1: De-trending Before FFT Analysis</span></span>
<span id="cb191-2248"><a href="#cb191-2248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2249"><a href="#cb191-2249" aria-hidden="true" tabindex="-1"></a>The goal is to investigate whether de-trending the synthetic time series <span class="sc">\(</span> y_2(t) <span class="sc">\)</span> before applying the Fast Fourier Transform (FFT) improves the separation and recovery of the seasonality component. We will:</span>
<span id="cb191-2250"><a href="#cb191-2250" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Remove the trend (<span class="sc">\(</span>\mathrm{tr}<span class="sc">\)</span>) from <span class="sc">\(</span> y_2(t) <span class="sc">\)</span> to obtain a de-trended series.</span>
<span id="cb191-2251"><a href="#cb191-2251" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Perform Fourier analysis on the de-trended series.</span>
<span id="cb191-2252"><a href="#cb191-2252" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Compare the recovered seasonality with the original seasonality (<span class="sc">\(</span>\mathrm{sea}<span class="sc">\)</span>) from the dataset.</span>
<span id="cb191-2253"><a href="#cb191-2253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2254"><a href="#cb191-2254" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 1: Load and De-trend the Time Series</span></span>
<span id="cb191-2255"><a href="#cb191-2255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2256"><a href="#cb191-2256" aria-hidden="true" tabindex="-1"></a>We start by loading the synthetic time series data and subtracting the trend component (<span class="sc">\(</span>\mathrm{tr}<span class="sc">\)</span>) from <span class="sc">\(</span> y_2 <span class="sc">\)</span>.</span>
<span id="cb191-2257"><a href="#cb191-2257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2260"><a href="#cb191-2260" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-2261"><a href="#cb191-2261" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the data</span></span>
<span id="cb191-2262"><a href="#cb191-2262" aria-hidden="true" tabindex="-1"></a>fpath_ts2 <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{data_dir}/synthetic_TS_02.tsv"</span>)</span>
<span id="cb191-2263"><a href="#cb191-2263" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="ot">&lt;-</span> <span class="fu">read_tsv</span>(fpath_ts2)</span>
<span id="cb191-2264"><a href="#cb191-2264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2265"><a href="#cb191-2265" aria-hidden="true" tabindex="-1"></a><span class="co"># De-trend the time series</span></span>
<span id="cb191-2266"><a href="#cb191-2266" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb191-2267"><a href="#cb191-2267" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y_detrended =</span> y_2 <span class="sc">-</span> tr)</span>
<span id="cb191-2268"><a href="#cb191-2268" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2269"><a href="#cb191-2269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2270"><a href="#cb191-2270" aria-hidden="true" tabindex="-1"></a>The de-trended series <span class="sc">\(</span> y_\text{detrended} = y_2 - \mathrm{tr} <span class="sc">\)</span> should primarily contain seasonality (<span class="sc">\(</span>\mathrm{sea}<span class="sc">\)</span>) and noise (<span class="sc">\(</span>\epsilon<span class="sc">\)</span>).</span>
<span id="cb191-2271"><a href="#cb191-2271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2272"><a href="#cb191-2272" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 2: Visualize the De-trended Time Series</span></span>
<span id="cb191-2273"><a href="#cb191-2273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2274"><a href="#cb191-2274" aria-hidden="true" tabindex="-1"></a>Let's plot the de-trended series alongside the original seasonality to visually inspect the effect of de-trending:</span>
<span id="cb191-2275"><a href="#cb191-2275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2278"><a href="#cb191-2278" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-2279"><a href="#cb191-2279" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&gt;%</span></span>
<span id="cb191-2280"><a href="#cb191-2280" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">str_replace</span>(year, <span class="st">"$"</span>, <span class="st">"-01-01"</span>) <span class="sc">%&gt;%</span> as_date) <span class="sc">%&gt;%</span></span>
<span id="cb191-2281"><a href="#cb191-2281" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> y_detrended)) <span class="sc">+</span></span>
<span id="cb191-2282"><a href="#cb191-2282" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb191-2283"><a href="#cb191-2283" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> sea), <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb191-2284"><a href="#cb191-2284" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept =</span> year), <span class="at">color =</span> <span class="st">"grey50"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb191-2285"><a href="#cb191-2285" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"De-trended Time Series vs. Original Seasonality"</span>,</span>
<span id="cb191-2286"><a href="#cb191-2286" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Day"</span>, <span class="at">y =</span> <span class="st">"Value"</span>)</span>
<span id="cb191-2287"><a href="#cb191-2287" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2288"><a href="#cb191-2288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2289"><a href="#cb191-2289" aria-hidden="true" tabindex="-1"></a>This plot helps us confirm that the de-trended series resembles the seasonality component, with noise superimposed.</span>
<span id="cb191-2290"><a href="#cb191-2290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2291"><a href="#cb191-2291" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 3: Fourier Analysis on De-trended Series</span></span>
<span id="cb191-2292"><a href="#cb191-2292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2293"><a href="#cb191-2293" aria-hidden="true" tabindex="-1"></a>We apply the FFT to the de-trended series, compute the frequency magnitudes and phases, and threshold the coefficients to isolate seasonality.</span>
<span id="cb191-2294"><a href="#cb191-2294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2297"><a href="#cb191-2297" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-2298"><a href="#cb191-2298" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute FFT on de-trended series</span></span>
<span id="cb191-2299"><a href="#cb191-2299" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb191-2300"><a href="#cb191-2300" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fft_detrended =</span> <span class="fu">fft</span>(y_detrended),</span>
<span id="cb191-2301"><a href="#cb191-2301" aria-hidden="true" tabindex="-1"></a>         <span class="at">freq =</span> <span class="dv">0</span><span class="sc">:</span>(<span class="fu">nrow</span>(df_ts2)<span class="sc">-</span><span class="dv">1</span>) <span class="sc">*</span> <span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">/</span> <span class="dv">365</span>,</span>
<span id="cb191-2302"><a href="#cb191-2302" aria-hidden="true" tabindex="-1"></a>         <span class="at">freq_mag_detrended =</span> <span class="fu">Mod</span>(fft_detrended) <span class="sc">/</span> <span class="fu">nrow</span>(df_ts2),</span>
<span id="cb191-2303"><a href="#cb191-2303" aria-hidden="true" tabindex="-1"></a>         <span class="at">freq_pha_detrended =</span> <span class="fu">Arg</span>(fft_detrended))</span>
<span id="cb191-2304"><a href="#cb191-2304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2305"><a href="#cb191-2305" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot frequency magnitudes</span></span>
<span id="cb191-2306"><a href="#cb191-2306" aria-hidden="true" tabindex="-1"></a>thresh_mag <span class="ot">&lt;-</span> <span class="fl">0.14</span></span>
<span id="cb191-2307"><a href="#cb191-2307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2308"><a href="#cb191-2308" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&gt;%</span></span>
<span id="cb191-2309"><a href="#cb191-2309" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> freq, <span class="at">y =</span> freq_mag_detrended)) <span class="sc">+</span></span>
<span id="cb191-2310"><a href="#cb191-2310" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb191-2311"><a href="#cb191-2311" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> thresh_mag, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb191-2312"><a href="#cb191-2312" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylim</span>(<span class="cn">NA</span>, <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb191-2313"><a href="#cb191-2313" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Frequency Magnitudes of De-trended Time Series"</span>,</span>
<span id="cb191-2314"><a href="#cb191-2314" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Frequency"</span>, <span class="at">y =</span> <span class="st">"Magnitude"</span>)</span>
<span id="cb191-2315"><a href="#cb191-2315" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2316"><a href="#cb191-2316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2317"><a href="#cb191-2317" aria-hidden="true" tabindex="-1"></a>The threshold (<span class="sc">\(</span>\text{thresh_mag} = 0.14<span class="sc">\)</span>) is reused from the original analysis for consistency. We expect the frequency spectrum to show prominent peaks corresponding to seasonal frequencies, with the trend-related low frequencies diminished.</span>
<span id="cb191-2318"><a href="#cb191-2318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2319"><a href="#cb191-2319" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 4: Thresholding and Inverse Fourier Transform</span></span>
<span id="cb191-2320"><a href="#cb191-2320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2321"><a href="#cb191-2321" aria-hidden="true" tabindex="-1"></a>We threshold the Fourier coefficients to retain only those with magnitudes above <span class="sc">\(</span>\text{thresh_mag}<span class="sc">\)</span>, which should correspond to seasonality, and compute the inverse FFT to recover the seasonality component:</span>
<span id="cb191-2322"><a href="#cb191-2322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2325"><a href="#cb191-2325" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-2326"><a href="#cb191-2326" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb191-2327"><a href="#cb191-2327" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fft_hi_detrended =</span> <span class="fu">if_else</span>(freq_mag_detrended <span class="sc">&gt;</span> thresh_mag, fft_detrended, <span class="dv">0</span>),</span>
<span id="cb191-2328"><a href="#cb191-2328" aria-hidden="true" tabindex="-1"></a>         <span class="at">pha_hi_detrended =</span> <span class="fu">if_else</span>(freq_mag_detrended <span class="sc">&gt;</span> thresh_mag, freq_pha_detrended, <span class="dv">0</span>),</span>
<span id="cb191-2329"><a href="#cb191-2329" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_hi_detrended =</span> <span class="fu">fft</span>(fft_hi_detrended, <span class="at">inverse =</span> <span class="cn">TRUE</span>))</span>
<span id="cb191-2330"><a href="#cb191-2330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2331"><a href="#cb191-2331" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify the recovered signal is real</span></span>
<span id="cb191-2332"><a href="#cb191-2332" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&gt;%</span></span>
<span id="cb191-2333"><a href="#cb191-2333" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(y_detrended, y_hi_detrended) <span class="sc">%&gt;%</span></span>
<span id="cb191-2334"><a href="#cb191-2334" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">im_hi_detrended =</span> <span class="fu">Im</span>(y_hi_detrended)) <span class="sc">%&gt;%</span></span>
<span id="cb191-2335"><a href="#cb191-2335" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(im_hi_detrended)</span>
<span id="cb191-2336"><a href="#cb191-2336" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2337"><a href="#cb191-2337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2338"><a href="#cb191-2338" aria-hidden="true" tabindex="-1"></a>The imaginary parts should be negligible, confirming a real-valued recovered signal.</span>
<span id="cb191-2339"><a href="#cb191-2339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2340"><a href="#cb191-2340" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 5: Scale and Compare Recovered Seasonality</span></span>
<span id="cb191-2341"><a href="#cb191-2341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2342"><a href="#cb191-2342" aria-hidden="true" tabindex="-1"></a>We scale the recovered seasonality (<span class="sc">\(</span>\mathrm{y_hi_detrended}<span class="sc">\)</span>) to match the amplitude of the original seasonality (<span class="sc">\(</span>\mathrm{sea}<span class="sc">\)</span>) and plot them for comparison:</span>
<span id="cb191-2343"><a href="#cb191-2343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2346"><a href="#cb191-2346" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-2347"><a href="#cb191-2347" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb191-2348"><a href="#cb191-2348" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y_hi_detrended =</span> <span class="fu">Re</span>(y_hi_detrended),</span>
<span id="cb191-2349"><a href="#cb191-2349" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_hi_detrended =</span> y_hi_detrended <span class="sc">-</span> <span class="fu">mean</span>(y_hi_detrended),</span>
<span id="cb191-2350"><a href="#cb191-2350" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_hi_detrended =</span> y_hi_detrended <span class="sc">/</span> <span class="fu">max</span>(<span class="fu">abs</span>(y_hi_detrended)) <span class="sc">*</span> <span class="fu">max</span>(<span class="fu">abs</span>(sea)))</span>
<span id="cb191-2351"><a href="#cb191-2351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2352"><a href="#cb191-2352" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&gt;%</span></span>
<span id="cb191-2353"><a href="#cb191-2353" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">str_replace</span>(year, <span class="st">"$"</span>, <span class="st">"-01-01"</span>) <span class="sc">%&gt;%</span> as_date) <span class="sc">%&gt;%</span></span>
<span id="cb191-2354"><a href="#cb191-2354" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> y_hi_detrended)) <span class="sc">+</span></span>
<span id="cb191-2355"><a href="#cb191-2355" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"red"</span>, <span class="fu">aes</span>(<span class="at">linetype =</span> <span class="st">"Recovered Seasonality"</span>)) <span class="sc">+</span></span>
<span id="cb191-2356"><a href="#cb191-2356" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> sea), <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linetype =</span> <span class="st">"solid"</span>) <span class="sc">+</span></span>
<span id="cb191-2357"><a href="#cb191-2357" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept =</span> year), <span class="at">color =</span> <span class="st">"grey50"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb191-2358"><a href="#cb191-2358" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Recovered Seasonality (De-trended) vs. Original Seasonality"</span>,</span>
<span id="cb191-2359"><a href="#cb191-2359" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Day"</span>, <span class="at">y =</span> <span class="st">"Value"</span>) <span class="sc">+</span></span>
<span id="cb191-2360"><a href="#cb191-2360" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_linetype_manual</span>(<span class="at">name =</span> <span class="st">"Component"</span>, <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Recovered Seasonality"</span> <span class="ot">=</span> <span class="st">"dashed"</span>, <span class="st">"solid"</span> <span class="ot">=</span> <span class="st">"solid"</span>))</span>
<span id="cb191-2361"><a href="#cb191-2361" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2362"><a href="#cb191-2362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2363"><a href="#cb191-2363" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 6: Comparison with Original Analysis</span></span>
<span id="cb191-2364"><a href="#cb191-2364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2365"><a href="#cb191-2365" aria-hidden="true" tabindex="-1"></a>In the original analysis (without de-trending), the FFT was applied directly to <span class="sc">\(</span> y_2 <span class="sc">\)</span>, which included the trend. The trend contributes low-frequency components that may overlap with seasonal frequencies, potentially complicating the separation of seasonality and noise. By removing the trend first, we expect:</span>
<span id="cb191-2366"><a href="#cb191-2366" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Cleaner frequency spectrum**: Low-frequency components associated with the trend are eliminated, making seasonal frequencies more distinct.</span>
<span id="cb191-2367"><a href="#cb191-2367" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Improved seasonality recovery**: The thresholding process should better isolate seasonal frequencies, leading to a recovered seasonality (<span class="sc">\(</span>\mathrm{y_hi_detrended}<span class="sc">\)</span>) that more closely matches <span class="sc">\(</span>\mathrm{sea}<span class="sc">\)</span>.</span>
<span id="cb191-2368"><a href="#cb191-2368" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Reduced noise interference**: Noise frequencies are less likely to be confounded with trend-related frequencies.</span>
<span id="cb191-2369"><a href="#cb191-2369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2370"><a href="#cb191-2370" aria-hidden="true" tabindex="-1"></a>To quantify the improvement, we compute the mean squared error (MSE) between the recovered seasonality and the original seasonality for both approaches:</span>
<span id="cb191-2371"><a href="#cb191-2371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2374"><a href="#cb191-2374" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-2375"><a href="#cb191-2375" aria-hidden="true" tabindex="-1"></a><span class="co"># MSE for de-trended analysis</span></span>
<span id="cb191-2376"><a href="#cb191-2376" aria-hidden="true" tabindex="-1"></a>mse_detrended <span class="ot">&lt;-</span> <span class="fu">mean</span>((df_ts2<span class="sc">$</span>y_hi_detrended <span class="sc">-</span> df_ts2<span class="sc">$</span>sea)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb191-2377"><a href="#cb191-2377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2378"><a href="#cb191-2378" aria-hidden="true" tabindex="-1"></a><span class="co"># MSE for original analysis (using y_hi from original analysis)</span></span>
<span id="cb191-2379"><a href="#cb191-2379" aria-hidden="true" tabindex="-1"></a>mse_original <span class="ot">&lt;-</span> <span class="fu">mean</span>((df_ts2<span class="sc">$</span>y_hi <span class="sc">-</span> df_ts2<span class="sc">$</span>sea)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb191-2380"><a href="#cb191-2380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2381"><a href="#cb191-2381" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"MSE (De-trended):"</span>, mse_detrended, <span class="st">"</span><span class="sc">\n</span><span class="st">MSE (Original):"</span>, mse_original)</span>
<span id="cb191-2382"><a href="#cb191-2382" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2383"><a href="#cb191-2383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2384"><a href="#cb191-2384" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Conclusion</span></span>
<span id="cb191-2385"><a href="#cb191-2385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2386"><a href="#cb191-2386" aria-hidden="true" tabindex="-1"></a>De-trending the time series before applying the FFT likely improves the results if the MSE for the de-trended analysis is lower than that for the original analysis. This suggests better separation of the seasonality component, as the trend's low-frequency components no longer interfere with the Fourier analysis. The visual comparison in the plot should show that the recovered seasonality (<span class="sc">\(</span>\mathrm{y_hi_detrended}<span class="sc">\)</span>) aligns more closely with <span class="sc">\(</span>\mathrm{sea}<span class="sc">\)</span> in terms of amplitude and phase, especially if the trend was a significant component in the original series.</span>
<span id="cb191-2387"><a href="#cb191-2387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2388"><a href="#cb191-2388" aria-hidden="true" tabindex="-1"></a>**Key Observations**:</span>
<span id="cb191-2389"><a href="#cb191-2389" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>If the trend is strong, de-trending reduces the amplitude of low-frequency components in the FFT, making it easier to isolate seasonal frequencies.</span>
<span id="cb191-2390"><a href="#cb191-2390" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The threshold (<span class="sc">\(</span>\text{thresh_mag} = 0.14<span class="sc">\)</span>) may need adjustment for the de-trended series, as the frequency magnitudes are scaled differently without the trend.</span>
<span id="cb191-2391"><a href="#cb191-2391" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>If the MSE is similar or higher, it may indicate that the trend was not a significant factor, or the thresholding process needs optimization.</span>
<span id="cb191-2392"><a href="#cb191-2392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2393"><a href="#cb191-2393" aria-hidden="true" tabindex="-1"></a>**Recommendation**: Adjust the threshold <span class="sc">\(</span>\text{thresh_mag}<span class="sc">\)</span> for the de-trended series if the recovered seasonality does not align well with <span class="sc">\(</span>\mathrm{sea}<span class="sc">\)</span>. Experiment with values around 0.14 to optimize the separation of seasonality and noise.</span>
<span id="cb191-2394"><a href="#cb191-2394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2395"><a href="#cb191-2395" aria-hidden="true" tabindex="-1"></a><span class="fu">### Homework 2: Recovering a Poisson-like Noise Distribution from Synthetic Data</span></span>
<span id="cb191-2396"><a href="#cb191-2396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2397"><a href="#cb191-2397" aria-hidden="true" tabindex="-1"></a>The goal is to determine whether the noise component (<span class="sc">\(</span> y_lo <span class="sc">\)</span>) from the synthetic time series can be modeled as a Poisson distribution. We will:</span>
<span id="cb191-2398"><a href="#cb191-2398" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Analyze the noise component (<span class="sc">\(</span> y_lo <span class="sc">\)</span>) obtained from the Fourier analysis.</span>
<span id="cb191-2399"><a href="#cb191-2399" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Investigate whether scaling is needed to make <span class="sc">\(</span> y_lo <span class="sc">\)</span> resemble a Poisson distribution.</span>
<span id="cb191-2400"><a href="#cb191-2400" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Estimate the Poisson parameter (<span class="sc">\(</span>\lambda<span class="sc">\)</span>).</span>
<span id="cb191-2401"><a href="#cb191-2401" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>Plot the histogram of <span class="sc">\(</span> y_lo <span class="sc">\)</span> with an overlaid Poisson distribution.</span>
<span id="cb191-2402"><a href="#cb191-2402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2403"><a href="#cb191-2403" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 1: Load and Extract Noise Component</span></span>
<span id="cb191-2404"><a href="#cb191-2404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2405"><a href="#cb191-2405" aria-hidden="true" tabindex="-1"></a>We assume the synthetic time series dataset has been processed as in the original course material, where <span class="sc">\(</span> y_lo <span class="sc">\)</span> represents the noise component obtained by thresholding the Fourier coefficients with <span class="sc">\(</span>\text{thresh_mag} = 0.14<span class="sc">\)</span>. If not already computed, we include the relevant code:</span>
<span id="cb191-2406"><a href="#cb191-2406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2409"><a href="#cb191-2409" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-2410"><a href="#cb191-2410" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the data</span></span>
<span id="cb191-2411"><a href="#cb191-2411" aria-hidden="true" tabindex="-1"></a>fpath_ts2 <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{data_dir}/synthetic_TS_02.tsv"</span>)</span>
<span id="cb191-2412"><a href="#cb191-2412" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="ot">&lt;-</span> <span class="fu">read_tsv</span>(fpath_ts2)</span>
<span id="cb191-2413"><a href="#cb191-2413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2414"><a href="#cb191-2414" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute FFT and threshold to extract noise</span></span>
<span id="cb191-2415"><a href="#cb191-2415" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb191-2416"><a href="#cb191-2416" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">fft =</span> <span class="fu">fft</span>(y_2),</span>
<span id="cb191-2417"><a href="#cb191-2417" aria-hidden="true" tabindex="-1"></a>         <span class="at">freq =</span> <span class="dv">0</span><span class="sc">:</span>(<span class="fu">nrow</span>(df_ts2)<span class="sc">-</span><span class="dv">1</span>) <span class="sc">*</span> <span class="dv">2</span> <span class="sc">*</span> pi <span class="sc">/</span> <span class="dv">365</span>,</span>
<span id="cb191-2418"><a href="#cb191-2418" aria-hidden="true" tabindex="-1"></a>         <span class="at">freq_mag =</span> <span class="fu">Mod</span>(fft) <span class="sc">/</span> <span class="fu">nrow</span>(df_ts2),</span>
<span id="cb191-2419"><a href="#cb191-2419" aria-hidden="true" tabindex="-1"></a>         <span class="at">freq_pha =</span> <span class="fu">Arg</span>(fft),</span>
<span id="cb191-2420"><a href="#cb191-2420" aria-hidden="true" tabindex="-1"></a>         <span class="at">fft_lo =</span> <span class="fu">if_else</span>(freq_mag <span class="sc">&lt;=</span> <span class="fl">0.14</span>, fft, <span class="dv">0</span>),</span>
<span id="cb191-2421"><a href="#cb191-2421" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_lo =</span> <span class="fu">Re</span>(<span class="fu">fft</span>(fft_lo, <span class="at">inverse =</span> <span class="cn">TRUE</span>)))</span>
<span id="cb191-2422"><a href="#cb191-2422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2423"><a href="#cb191-2423" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the noise component</span></span>
<span id="cb191-2424"><a href="#cb191-2424" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&gt;%</span></span>
<span id="cb191-2425"><a href="#cb191-2425" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> y_lo)) <span class="sc">+</span></span>
<span id="cb191-2426"><a href="#cb191-2426" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb191-2427"><a href="#cb191-2427" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Noise Component (y_lo)"</span>, <span class="at">x =</span> <span class="st">"Day"</span>, <span class="at">y =</span> <span class="st">"Value"</span>)</span>
<span id="cb191-2428"><a href="#cb191-2428" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2429"><a href="#cb191-2429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2430"><a href="#cb191-2430" aria-hidden="true" tabindex="-1"></a>The noise component <span class="sc">\(</span> y_lo <span class="sc">\)</span> represents the high-frequency residuals after removing the trend and seasonality via Fourier thresholding.</span>
<span id="cb191-2431"><a href="#cb191-2431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2432"><a href="#cb191-2432" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 2: Analyze the Noise Distribution</span></span>
<span id="cb191-2433"><a href="#cb191-2433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2434"><a href="#cb191-2434" aria-hidden="true" tabindex="-1"></a>A Poisson distribution models count data and has the following properties:</span>
<span id="cb191-2435"><a href="#cb191-2435" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Non-negative integer values.</span>
<span id="cb191-2436"><a href="#cb191-2436" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Mean equals variance (<span class="sc">\(</span>\lambda = \text{mean} = \text{variance}<span class="sc">\)</span>).</span>
<span id="cb191-2437"><a href="#cb191-2437" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Probability mass function: <span class="sc">\(</span> P(X = k) = \frac{\lambda^k e^{-\lambda}}{k!} <span class="sc">\)</span>, for <span class="sc">\(</span> k = 0, 1, 2, \ldots <span class="sc">\)</span>.</span>
<span id="cb191-2438"><a href="#cb191-2438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2439"><a href="#cb191-2439" aria-hidden="true" tabindex="-1"></a>First, we compute the mean and variance of <span class="sc">\(</span> y_lo <span class="sc">\)</span>:</span>
<span id="cb191-2440"><a href="#cb191-2440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2443"><a href="#cb191-2443" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-2444"><a href="#cb191-2444" aria-hidden="true" tabindex="-1"></a>mean_y_lo <span class="ot">&lt;-</span> <span class="fu">mean</span>(df_ts2<span class="sc">$</span>y_lo)</span>
<span id="cb191-2445"><a href="#cb191-2445" aria-hidden="true" tabindex="-1"></a>var_y_lo <span class="ot">&lt;-</span> <span class="fu">var</span>(df_ts2<span class="sc">$</span>y_lo)</span>
<span id="cb191-2446"><a href="#cb191-2446" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Mean of y_lo:"</span>, mean_y_lo, <span class="st">"</span><span class="sc">\n</span><span class="st">Variance of y_lo:"</span>, var_y_lo)</span>
<span id="cb191-2447"><a href="#cb191-2447" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2448"><a href="#cb191-2448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2449"><a href="#cb191-2449" aria-hidden="true" tabindex="-1"></a>In the original course material, the mean and variance of <span class="sc">\(</span> y_lo <span class="sc">\)</span> were reported (values not explicitly provided here but can be computed). For a Poisson distribution, we expect <span class="sc">\(</span>\text{mean} \approx \text{variance}<span class="sc">\)</span>. If the variance significantly exceeds the mean, the distribution may be overdispersed, requiring scaling or transformation.</span>
<span id="cb191-2450"><a href="#cb191-2450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2451"><a href="#cb191-2451" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 3: Investigate Scaling</span></span>
<span id="cb191-2452"><a href="#cb191-2452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2453"><a href="#cb191-2453" aria-hidden="true" tabindex="-1"></a>Since Poisson distributions require non-negative integer values, we inspect the range of <span class="sc">\(</span> y_lo <span class="sc">\)</span>:</span>
<span id="cb191-2454"><a href="#cb191-2454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2457"><a href="#cb191-2457" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-2458"><a href="#cb191-2458" aria-hidden="true" tabindex="-1"></a>summary_y_lo <span class="ot">&lt;-</span> <span class="fu">summary</span>(df_ts2<span class="sc">$</span>y_lo)</span>
<span id="cb191-2459"><a href="#cb191-2459" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Summary of y_lo:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb191-2460"><a href="#cb191-2460" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(summary_y_lo)</span>
<span id="cb191-2461"><a href="#cb191-2461" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2462"><a href="#cb191-2462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2463"><a href="#cb191-2463" aria-hidden="true" tabindex="-1"></a>The noise component <span class="sc">\(</span> y_lo <span class="sc">\)</span> from the inverse FFT is typically continuous and may include negative values due to the Fourier reconstruction. To model it as Poisson-like, we need to:</span>
<span id="cb191-2464"><a href="#cb191-2464" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Shift the data to ensure non-negative values (e.g., add a constant to make all values <span class="sc">\(</span>\geq 0<span class="sc">\)</span>).</span>
<span id="cb191-2465"><a href="#cb191-2465" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Scale the data to approximate integer values.</span>
<span id="cb191-2466"><a href="#cb191-2466" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Adjust the scale to align the mean and variance with a Poisson distribution.</span>
<span id="cb191-2467"><a href="#cb191-2467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2468"><a href="#cb191-2468" aria-hidden="true" tabindex="-1"></a>Let’s try shifting and scaling:</span>
<span id="cb191-2469"><a href="#cb191-2469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2472"><a href="#cb191-2472" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-2473"><a href="#cb191-2473" aria-hidden="true" tabindex="-1"></a><span class="co"># Shift to non-negative</span></span>
<span id="cb191-2474"><a href="#cb191-2474" aria-hidden="true" tabindex="-1"></a>shift_constant <span class="ot">&lt;-</span> <span class="fu">abs</span>(<span class="fu">min</span>(df_ts2<span class="sc">$</span>y_lo)) <span class="sc">+</span> <span class="fl">1e-6</span>  <span class="co"># Small offset to avoid zero</span></span>
<span id="cb191-2475"><a href="#cb191-2475" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb191-2476"><a href="#cb191-2476" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y_lo_shifted =</span> y_lo <span class="sc">+</span> shift_constant)</span>
<span id="cb191-2477"><a href="#cb191-2477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2478"><a href="#cb191-2478" aria-hidden="true" tabindex="-1"></a><span class="co"># Check mean and variance of shifted data</span></span>
<span id="cb191-2479"><a href="#cb191-2479" aria-hidden="true" tabindex="-1"></a>mean_y_lo_shifted <span class="ot">&lt;-</span> <span class="fu">mean</span>(df_ts2<span class="sc">$</span>y_lo_shifted)</span>
<span id="cb191-2480"><a href="#cb191-2480" aria-hidden="true" tabindex="-1"></a>var_y_lo_shifted <span class="ot">&lt;-</span> <span class="fu">var</span>(df_ts2<span class="sc">$</span>y_lo_shifted)</span>
<span id="cb191-2481"><a href="#cb191-2481" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Mean of shifted y_lo:"</span>, mean_y_lo_shifted, <span class="st">"</span><span class="sc">\n</span><span class="st">Variance of shifted y_lo:"</span>, var_y_lo_shifted)</span>
<span id="cb191-2482"><a href="#cb191-2482" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2483"><a href="#cb191-2483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2484"><a href="#cb191-2484" aria-hidden="true" tabindex="-1"></a>If the variance is still much larger than the mean, we can apply a scaling factor to reduce the spread:</span>
<span id="cb191-2485"><a href="#cb191-2485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2488"><a href="#cb191-2488" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-2489"><a href="#cb191-2489" aria-hidden="true" tabindex="-1"></a><span class="co"># Scale to reduce variance (e.g., divide by standard deviation or a factor)</span></span>
<span id="cb191-2490"><a href="#cb191-2490" aria-hidden="true" tabindex="-1"></a>scaling_factor <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(var_y_lo_shifted <span class="sc">/</span> mean_y_lo_shifted)  <span class="co"># Approximate scaling to match mean and variance</span></span>
<span id="cb191-2491"><a href="#cb191-2491" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb191-2492"><a href="#cb191-2492" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y_lo_scaled =</span> y_lo_shifted <span class="sc">/</span> scaling_factor)</span>
<span id="cb191-2493"><a href="#cb191-2493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2494"><a href="#cb191-2494" aria-hidden="true" tabindex="-1"></a><span class="co"># Round to nearest integer for Poisson-like distribution</span></span>
<span id="cb191-2495"><a href="#cb191-2495" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb191-2496"><a href="#cb191-2496" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y_lo_rounded =</span> <span class="fu">round</span>(y_lo_scaled))</span>
<span id="cb191-2497"><a href="#cb191-2497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2498"><a href="#cb191-2498" aria-hidden="true" tabindex="-1"></a><span class="co"># Recalculate mean and variance</span></span>
<span id="cb191-2499"><a href="#cb191-2499" aria-hidden="true" tabindex="-1"></a>mean_y_lo_rounded <span class="ot">&lt;-</span> <span class="fu">mean</span>(df_ts2<span class="sc">$</span>y_lo_rounded)</span>
<span id="cb191-2500"><a href="#cb191-2500" aria-hidden="true" tabindex="-1"></a>var_y_lo_rounded <span class="ot">&lt;-</span> <span class="fu">var</span>(df_ts2<span class="sc">$</span>y_lo_rounded)</span>
<span id="cb191-2501"><a href="#cb191-2501" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Mean of rounded y_lo:"</span>, mean_y_lo_rounded, <span class="st">"</span><span class="sc">\n</span><span class="st">Variance of rounded y_lo:"</span>, var_y_lo_rounded)</span>
<span id="cb191-2502"><a href="#cb191-2502" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2503"><a href="#cb191-2503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2504"><a href="#cb191-2504" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 4: Estimate Poisson Parameter</span></span>
<span id="cb191-2505"><a href="#cb191-2505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2506"><a href="#cb191-2506" aria-hidden="true" tabindex="-1"></a>For a Poisson distribution, the parameter <span class="sc">\(</span>\lambda<span class="sc">\)</span> is the mean of the distribution. We use the mean of the rounded, scaled noise:</span>
<span id="cb191-2507"><a href="#cb191-2507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2510"><a href="#cb191-2510" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-2511"><a href="#cb191-2511" aria-hidden="true" tabindex="-1"></a>lambda_est <span class="ot">&lt;-</span> mean_y_lo_rounded</span>
<span id="cb191-2512"><a href="#cb191-2512" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Estimated Poisson parameter (lambda):"</span>, lambda_est)</span>
<span id="cb191-2513"><a href="#cb191-2513" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2514"><a href="#cb191-2514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2515"><a href="#cb191-2515" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 5: Plot Histogram with Poisson Overlay</span></span>
<span id="cb191-2516"><a href="#cb191-2516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2517"><a href="#cb191-2517" aria-hidden="true" tabindex="-1"></a>We plot the histogram of the scaled and rounded noise (<span class="sc">\(</span>\mathrm{y_lo_rounded}<span class="sc">\)</span>) and overlay a Poisson distribution with parameter <span class="sc">\(</span>\lambda = \text{mean_y_lo_rounded}<span class="sc">\)</span>:</span>
<span id="cb191-2518"><a href="#cb191-2518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2521"><a href="#cb191-2521" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-2522"><a href="#cb191-2522" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute histogram and Poisson probabilities</span></span>
<span id="cb191-2523"><a href="#cb191-2523" aria-hidden="true" tabindex="-1"></a>max_value <span class="ot">&lt;-</span> <span class="fu">max</span>(df_ts2<span class="sc">$</span>y_lo_rounded)</span>
<span id="cb191-2524"><a href="#cb191-2524" aria-hidden="true" tabindex="-1"></a>poisson_probs <span class="ot">&lt;-</span> <span class="fu">dpois</span>(<span class="dv">0</span><span class="sc">:</span>max_value, <span class="at">lambda =</span> lambda_est)</span>
<span id="cb191-2525"><a href="#cb191-2525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2526"><a href="#cb191-2526" aria-hidden="true" tabindex="-1"></a><span class="co"># Create data frame for Poisson overlay</span></span>
<span id="cb191-2527"><a href="#cb191-2527" aria-hidden="true" tabindex="-1"></a>df_pois <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb191-2528"><a href="#cb191-2528" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> <span class="dv">0</span><span class="sc">:</span>max_value,</span>
<span id="cb191-2529"><a href="#cb191-2529" aria-hidden="true" tabindex="-1"></a>  <span class="at">prob =</span> poisson_probs <span class="sc">*</span> <span class="fu">nrow</span>(df_ts2) <span class="sc">*</span> <span class="fu">diff</span>(<span class="fu">hist</span>(df_ts2<span class="sc">$</span>y_lo_rounded, <span class="at">plot =</span> <span class="cn">FALSE</span>)<span class="sc">$</span>breaks)[<span class="dv">1</span>]</span>
<span id="cb191-2530"><a href="#cb191-2530" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb191-2531"><a href="#cb191-2531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2532"><a href="#cb191-2532" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot histogram with Poisson overlay</span></span>
<span id="cb191-2533"><a href="#cb191-2533" aria-hidden="true" tabindex="-1"></a>df_ts2 <span class="sc">%&gt;%</span></span>
<span id="cb191-2534"><a href="#cb191-2534" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> y_lo_rounded)) <span class="sc">+</span></span>
<span id="cb191-2535"><a href="#cb191-2535" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="dv">1</span>, <span class="at">fill =</span> <span class="st">"lightblue"</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb191-2536"><a href="#cb191-2536" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">data =</span> df_pois, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> prob), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb191-2537"><a href="#cb191-2537" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Histogram of Scaled Noise with Poisson Overlay"</span>,</span>
<span id="cb191-2538"><a href="#cb191-2538" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Scaled Noise (Rounded)"</span>, <span class="at">y =</span> <span class="st">"Count"</span>) <span class="sc">+</span></span>
<span id="cb191-2539"><a href="#cb191-2539" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span>
<span id="cb191-2540"><a href="#cb191-2540" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2541"><a href="#cb191-2541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2542"><a href="#cb191-2542" aria-hidden="true" tabindex="-1"></a>The red line represents the Poisson distribution with <span class="sc">\(</span>\lambda = \text{lambda_est}<span class="sc">\)</span>. The histogram should show whether the scaled noise resembles a Poisson distribution.</span>
<span id="cb191-2543"><a href="#cb191-2543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2544"><a href="#cb191-2544" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 6: Evaluate Poisson Fit</span></span>
<span id="cb191-2545"><a href="#cb191-2545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2546"><a href="#cb191-2546" aria-hidden="true" tabindex="-1"></a>To assess whether <span class="sc">\(</span> y_lo <span class="sc">\)</span> (after scaling) follows a Poisson distribution, we:</span>
<span id="cb191-2547"><a href="#cb191-2547" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Compare Mean and Variance**: Check if <span class="sc">\(</span>\text{mean_y_lo_rounded} \approx \text{var_y_lo_rounded}<span class="sc">\)</span>.</span>
<span id="cb191-2548"><a href="#cb191-2548" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Visual Inspection**: Evaluate the histogram and Poisson overlay for visual similarity.</span>
<span id="cb191-2549"><a href="#cb191-2549" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Statistical Test**: Optionally, perform a goodness-of-fit test (e.g., Chi-squared test) to compare the observed distribution to a Poisson distribution.</span>
<span id="cb191-2550"><a href="#cb191-2550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2553"><a href="#cb191-2553" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-2554"><a href="#cb191-2554" aria-hidden="true" tabindex="-1"></a><span class="co"># Chi-squared goodness-of-fit test</span></span>
<span id="cb191-2555"><a href="#cb191-2555" aria-hidden="true" tabindex="-1"></a>hist_data <span class="ot">&lt;-</span> <span class="fu">hist</span>(df_ts2<span class="sc">$</span>y_lo_rounded, <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">0.5</span>, max_value <span class="sc">+</span> <span class="fl">0.5</span>, <span class="at">by =</span> <span class="dv">1</span>), <span class="at">plot =</span> <span class="cn">FALSE</span>)</span>
<span id="cb191-2556"><a href="#cb191-2556" aria-hidden="true" tabindex="-1"></a>observed <span class="ot">&lt;-</span> hist_data<span class="sc">$</span>counts</span>
<span id="cb191-2557"><a href="#cb191-2557" aria-hidden="true" tabindex="-1"></a>expected <span class="ot">&lt;-</span> <span class="fu">dpois</span>(<span class="dv">0</span><span class="sc">:</span>max_value, <span class="at">lambda =</span> lambda_est) <span class="sc">*</span> <span class="fu">sum</span>(observed)</span>
<span id="cb191-2558"><a href="#cb191-2558" aria-hidden="true" tabindex="-1"></a>chi_test <span class="ot">&lt;-</span> <span class="fu">chisq.test</span>(observed, <span class="at">p =</span> expected <span class="sc">/</span> <span class="fu">sum</span>(expected), <span class="at">rescale.p =</span> <span class="cn">TRUE</span>)</span>
<span id="cb191-2559"><a href="#cb191-2559" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Chi-squared test p-value:"</span>, chi_test<span class="sc">$</span>p.value)</span>
<span id="cb191-2560"><a href="#cb191-2560" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2561"><a href="#cb191-2561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2562"><a href="#cb191-2562" aria-hidden="true" tabindex="-1"></a>A p-value &gt; 0.05 suggests the scaled noise is consistent with a Poisson distribution.</span>
<span id="cb191-2563"><a href="#cb191-2563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2564"><a href="#cb191-2564" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Conclusion</span></span>
<span id="cb191-2565"><a href="#cb191-2565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2566"><a href="#cb191-2566" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Scaling Necessity**: The original <span class="sc">\(</span> y_lo <span class="sc">\)</span> likely required shifting (to ensure non-negativity) and scaling (to align mean and variance) to resemble a Poisson distribution. Rounding to integers further aligns the data with Poisson characteristics.</span>
<span id="cb191-2567"><a href="#cb191-2567" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Poisson Parameter**: The estimated <span class="sc">\(</span>\lambda \approx \text{mean_y_lo_rounded}<span class="sc">\)</span> provides a reasonable fit if the mean and variance are similar post-scaling.</span>
<span id="cb191-2568"><a href="#cb191-2568" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Fit Quality**: If the histogram aligns closely with the Poisson overlay and the Chi-squared test yields a high p-value, <span class="sc">\(</span> y_lo <span class="sc">\)</span> can be modeled as Poisson-like after appropriate transformations. If the fit is poor, the noise may follow a different distribution (e.g., Gaussian or overdispersed).</span>
<span id="cb191-2569"><a href="#cb191-2569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2570"><a href="#cb191-2570" aria-hidden="true" tabindex="-1"></a>**Challenges**:</span>
<span id="cb191-2571"><a href="#cb191-2571" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The continuous nature of <span class="sc">\(</span> y_lo <span class="sc">\)</span> from the FFT makes direct Poisson modeling difficult without transformation.</span>
<span id="cb191-2572"><a href="#cb191-2572" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>If the variance remains significantly larger than the mean after scaling, the noise may not be Poisson-like, suggesting a need for alternative distributions (e.g., negative binomial for overdispersion).</span>
<span id="cb191-2573"><a href="#cb191-2573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2574"><a href="#cb191-2574" aria-hidden="true" tabindex="-1"></a>**Recommendation**: If the Poisson fit is inadequate, experiment with different scaling factors or consider alternative distributions. Adjust the scaling factor iteratively to minimize the difference between mean and variance.</span>
<span id="cb191-2575"><a href="#cb191-2575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2576"><a href="#cb191-2576" aria-hidden="true" tabindex="-1"></a><span class="fu"># Using libraries for trend &amp; seasonality</span></span>
<span id="cb191-2577"><a href="#cb191-2577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2578"><a href="#cb191-2578" aria-hidden="true" tabindex="-1"></a>We have already seen how to extract **trend**, **seasonality**, and the **remainder** “by hand”.</span>
<span id="cb191-2579"><a href="#cb191-2579" aria-hidden="true" tabindex="-1"></a>The **tidyverts** collection (<span class="in">`tsibble`</span>, <span class="in">`feasts`</span>, <span class="in">`fabletools`</span>) does it in a tidy, pipe-friendly way.</span>
<span id="cb191-2580"><a href="#cb191-2580" aria-hidden="true" tabindex="-1"></a>The workhorse is **STL** (Seasonal-Trend decomposition using LOESS) – the same method presented in <span class="co">[</span><span class="ot">Forecasting: Principles and Practice (3rd ed.)</span><span class="co">](https://otexts.com/fpp3/)</span>.  </span>
<span id="cb191-2581"><a href="#cb191-2581" aria-hidden="true" tabindex="-1"></a>For Python users, the same ideas are available in <span class="in">`statsmodels.tsa.seasonal.STL`</span> or via feature-extraction packages such as <span class="in">`tsfresh`</span>.</span>
<span id="cb191-2582"><a href="#cb191-2582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2583"><a href="#cb191-2583" aria-hidden="true" tabindex="-1"></a><span class="fu">## Univariate time series</span></span>
<span id="cb191-2584"><a href="#cb191-2584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2585"><a href="#cb191-2585" aria-hidden="true" tabindex="-1"></a><span class="fu">### Load synthetic data</span></span>
<span id="cb191-2586"><a href="#cb191-2586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2587"><a href="#cb191-2587" aria-hidden="true" tabindex="-1"></a><span class="in">```{r load-synthetic-data}</span></span>
<span id="cb191-2588"><a href="#cb191-2588" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2589"><a href="#cb191-2589" aria-hidden="true" tabindex="-1"></a>fpath_ts2 <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{data_dir}/synthetic_TS_02.tsv"</span>)</span>
<span id="cb191-2590"><a href="#cb191-2590" aria-hidden="true" tabindex="-1"></a>df_ts2    <span class="ot">&lt;-</span> <span class="fu">read_tsv</span>(fpath_ts2)</span>
<span id="cb191-2591"><a href="#cb191-2591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2592"><a href="#cb191-2592" aria-hidden="true" tabindex="-1"></a>df_ts2</span>
<span id="cb191-2593"><a href="#cb191-2593" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2594"><a href="#cb191-2594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2595"><a href="#cb191-2595" aria-hidden="true" tabindex="-1"></a><span class="fu">### Load Walmart (real) data</span></span>
<span id="cb191-2596"><a href="#cb191-2596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2597"><a href="#cb191-2597" aria-hidden="true" tabindex="-1"></a><span class="in">```{r load-real-sc-data}</span></span>
<span id="cb191-2598"><a href="#cb191-2598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2599"><a href="#cb191-2599" aria-hidden="true" tabindex="-1"></a>fpath_wws <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{data_dir}/Walmart/train.csv"</span>)</span>
<span id="cb191-2600"><a href="#cb191-2600" aria-hidden="true" tabindex="-1"></a>df_wws <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(fpath_wws) <span class="sc">%&gt;%</span></span>
<span id="cb191-2601"><a href="#cb191-2601" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_with</span>(tolower) <span class="sc">%&gt;%</span></span>
<span id="cb191-2602"><a href="#cb191-2602" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">is_holiday =</span> isholiday,</span>
<span id="cb191-2603"><a href="#cb191-2603" aria-hidden="true" tabindex="-1"></a>         <span class="at">weekly_sales =</span> weekly_sales)</span>
<span id="cb191-2604"><a href="#cb191-2604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2605"><a href="#cb191-2605" aria-hidden="true" tabindex="-1"></a>df_wws</span>
<span id="cb191-2606"><a href="#cb191-2606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2607"><a href="#cb191-2607" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2608"><a href="#cb191-2608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2609"><a href="#cb191-2609" aria-hidden="true" tabindex="-1"></a><span class="fu">### Turn data frames into `tsibble` objects</span></span>
<span id="cb191-2610"><a href="#cb191-2610" aria-hidden="true" tabindex="-1"></a>We first need to transform our data frames into Time Series objects.</span>
<span id="cb191-2611"><a href="#cb191-2611" aria-hidden="true" tabindex="-1"></a>We use the library <span class="in">`tsibble`</span> for that and quickly have a look at the data using the <span class="in">`autoplot`</span> function.</span>
<span id="cb191-2612"><a href="#cb191-2612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2613"><a href="#cb191-2613" aria-hidden="true" tabindex="-1"></a><span class="in">```{r transform-df-to-ts-ts2}</span></span>
<span id="cb191-2614"><a href="#cb191-2614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2615"><a href="#cb191-2615" aria-hidden="true" tabindex="-1"></a>ts_ts2 <span class="ot">&lt;-</span> df_ts2 <span class="sc">%&gt;%</span></span>
<span id="cb191-2616"><a href="#cb191-2616" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(day, y_2) <span class="sc">%&gt;%</span></span>
<span id="cb191-2617"><a href="#cb191-2617" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">day =</span> <span class="fu">as_date</span>(day)) <span class="sc">%&gt;%</span>           <span class="co"># ensure Date class</span></span>
<span id="cb191-2618"><a href="#cb191-2618" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tsibble</span>(<span class="at">index =</span> day)</span>
<span id="cb191-2619"><a href="#cb191-2619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2620"><a href="#cb191-2620" aria-hidden="true" tabindex="-1"></a>ts_ts2 <span class="sc">%&gt;%</span> <span class="fu">autoplot</span>(y_2) <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Synthetic series (y_2)"</span>)</span>
<span id="cb191-2621"><a href="#cb191-2621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2622"><a href="#cb191-2622" aria-hidden="true" tabindex="-1"></a>ts_wws <span class="ot">&lt;-</span> df_wws <span class="sc">%&gt;%</span></span>
<span id="cb191-2623"><a href="#cb191-2623" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">yweek =</span> <span class="fu">yearweek</span>(date)) <span class="sc">%&gt;%</span></span>
<span id="cb191-2624"><a href="#cb191-2624" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tsibble</span>(<span class="at">index =</span> yweek, <span class="at">key =</span> <span class="fu">c</span>(store, dept))</span>
<span id="cb191-2625"><a href="#cb191-2625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2626"><a href="#cb191-2626" aria-hidden="true" tabindex="-1"></a><span class="co"># Quick sanity check: day-of-week distribution</span></span>
<span id="cb191-2627"><a href="#cb191-2627" aria-hidden="true" tabindex="-1"></a>df_wws <span class="sc">%&gt;%</span></span>
<span id="cb191-2628"><a href="#cb191-2628" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dow =</span> <span class="fu">wday</span>(date, <span class="at">label =</span> <span class="cn">TRUE</span>, <span class="at">abbr =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb191-2629"><a href="#cb191-2629" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(dow)</span>
<span id="cb191-2630"><a href="#cb191-2630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2631"><a href="#cb191-2631" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2632"><a href="#cb191-2632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2633"><a href="#cb191-2633" aria-hidden="true" tabindex="-1"></a>Plot a few store-department combos.</span>
<span id="cb191-2634"><a href="#cb191-2634" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2635"><a href="#cb191-2635" aria-hidden="true" tabindex="-1"></a><span class="in">```{r transform-df-to-ts-wws}</span></span>
<span id="cb191-2636"><a href="#cb191-2636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2637"><a href="#cb191-2637" aria-hidden="true" tabindex="-1"></a>ts_wws <span class="sc">%&gt;%</span></span>
<span id="cb191-2638"><a href="#cb191-2638" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(store <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), dept <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb191-2639"><a href="#cb191-2639" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>(weekly_sales) <span class="sc">+</span></span>
<span id="cb191-2640"><a href="#cb191-2640" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(store <span class="sc">~</span> dept, <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb191-2641"><a href="#cb191-2641" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Weekly sales – stores 1-2, departments 1 &amp; 3"</span>)</span>
<span id="cb191-2642"><a href="#cb191-2642" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2643"><a href="#cb191-2643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2644"><a href="#cb191-2644" aria-hidden="true" tabindex="-1"></a><span class="fu">## Classical additive decomposition (moving averages)</span></span>
<span id="cb191-2645"><a href="#cb191-2645" aria-hidden="true" tabindex="-1"></a>Next, we'll use the **classical_decomposition** from the <span class="in">`feasts`</span> package.</span>
<span id="cb191-2646"><a href="#cb191-2646" aria-hidden="true" tabindex="-1"></a>It uses Moving Averages optimized in some ways.</span>
<span id="cb191-2647"><a href="#cb191-2647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2648"><a href="#cb191-2648" aria-hidden="true" tabindex="-1"></a><span class="in">```{r default-classical-decomposition}</span></span>
<span id="cb191-2649"><a href="#cb191-2649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2650"><a href="#cb191-2650" aria-hidden="true" tabindex="-1"></a>ts_ts2 <span class="sc">%&gt;%</span></span>
<span id="cb191-2651"><a href="#cb191-2651" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model</span>(<span class="fu">classical_decomposition</span>(y_2, <span class="at">type =</span> <span class="st">"additive"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb191-2652"><a href="#cb191-2652" aria-hidden="true" tabindex="-1"></a>  <span class="fu">components</span>() <span class="sc">%&gt;%</span></span>
<span id="cb191-2653"><a href="#cb191-2653" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>() <span class="sc">+</span></span>
<span id="cb191-2654"><a href="#cb191-2654" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Classical additive decomposition (default MA)"</span>)</span>
<span id="cb191-2655"><a href="#cb191-2655" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2656"><a href="#cb191-2656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2657"><a href="#cb191-2657" aria-hidden="true" tabindex="-1"></a><span class="fu">### Tweaking the season length</span></span>
<span id="cb191-2658"><a href="#cb191-2658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2659"><a href="#cb191-2659" aria-hidden="true" tabindex="-1"></a><span class="in">```{r experiement-classical-decomposition-with-params}</span></span>
<span id="cb191-2660"><a href="#cb191-2660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2661"><a href="#cb191-2661" aria-hidden="true" tabindex="-1"></a>ts_ts2 <span class="sc">%&gt;%</span></span>
<span id="cb191-2662"><a href="#cb191-2662" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model</span>(<span class="fu">classical_decomposition</span>(y_2 <span class="sc">~</span> <span class="fu">season</span>(<span class="at">period =</span> <span class="st">"365 days"</span>),</span>
<span id="cb191-2663"><a href="#cb191-2663" aria-hidden="true" tabindex="-1"></a>                                <span class="at">type =</span> <span class="st">"additive"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb191-2664"><a href="#cb191-2664" aria-hidden="true" tabindex="-1"></a>  <span class="fu">components</span>() <span class="sc">%&gt;%</span></span>
<span id="cb191-2665"><a href="#cb191-2665" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>() <span class="sc">+</span></span>
<span id="cb191-2666"><a href="#cb191-2666" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Classical decomposition – explicit 365-day season"</span>)</span>
<span id="cb191-2667"><a href="#cb191-2667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2668"><a href="#cb191-2668" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2669"><a href="#cb191-2669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2670"><a href="#cb191-2670" aria-hidden="true" tabindex="-1"></a><span class="fu">## STL from feasts (tidyverts)</span></span>
<span id="cb191-2671"><a href="#cb191-2671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2672"><a href="#cb191-2672" aria-hidden="true" tabindex="-1"></a>The <span class="in">`STL()`</span> model in **feasts** is a thin wrapper around <span class="in">`stats::stl()`</span> but works inside the <span class="in">`model()`</span> pipeline.</span>
<span id="cb191-2673"><a href="#cb191-2673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2676"><a href="#cb191-2676" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-2677"><a href="#cb191-2677" aria-hidden="true" tabindex="-1"></a>ts_ts2 <span class="sc">%&gt;%</span></span>
<span id="cb191-2678"><a href="#cb191-2678" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model</span>(</span>
<span id="cb191-2679"><a href="#cb191-2679" aria-hidden="true" tabindex="-1"></a>    <span class="fu">STL</span>(y_2 <span class="sc">~</span> <span class="fu">trend</span>(<span class="at">window =</span> <span class="dv">381</span>, <span class="at">degree =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb191-2680"><a href="#cb191-2680" aria-hidden="true" tabindex="-1"></a>              <span class="fu">season</span>(<span class="at">period =</span> <span class="st">"1 year"</span>, <span class="at">window =</span> <span class="dv">33</span>, <span class="at">degree =</span> <span class="dv">1</span>),</span>
<span id="cb191-2681"><a href="#cb191-2681" aria-hidden="true" tabindex="-1"></a>        <span class="at">robust =</span> <span class="cn">TRUE</span>)</span>
<span id="cb191-2682"><a href="#cb191-2682" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb191-2683"><a href="#cb191-2683" aria-hidden="true" tabindex="-1"></a>  <span class="fu">components</span>() <span class="sc">%&gt;%</span></span>
<span id="cb191-2684"><a href="#cb191-2684" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>() <span class="sc">+</span></span>
<span id="cb191-2685"><a href="#cb191-2685" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"STL (feasts) – robust, custom windows"</span>)</span>
<span id="cb191-2686"><a href="#cb191-2686" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2687"><a href="#cb191-2687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2688"><a href="#cb191-2688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2689"><a href="#cb191-2689" aria-hidden="true" tabindex="-1"></a><span class="in">```{r stats-base-stl}</span></span>
<span id="cb191-2690"><a href="#cb191-2690" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2691"><a href="#cb191-2691" aria-hidden="true" tabindex="-1"></a>ts_ts2_stl <span class="ot">&lt;-</span> </span>
<span id="cb191-2692"><a href="#cb191-2692" aria-hidden="true" tabindex="-1"></a>  ts_ts2 <span class="sc">%&gt;%</span> </span>
<span id="cb191-2693"><a href="#cb191-2693" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stl</span>(<span class="at">s.window =</span> <span class="st">"periodic"</span>,</span>
<span id="cb191-2694"><a href="#cb191-2694" aria-hidden="true" tabindex="-1"></a>      <span class="at">s.degree =</span> <span class="dv">1</span>,</span>
<span id="cb191-2695"><a href="#cb191-2695" aria-hidden="true" tabindex="-1"></a>      <span class="at">t.window =</span> <span class="dv">380</span>,</span>
<span id="cb191-2696"><a href="#cb191-2696" aria-hidden="true" tabindex="-1"></a>      <span class="at">t.degree =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb191-2697"><a href="#cb191-2697" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract2</span>(<span class="st">"time.series"</span>)</span>
<span id="cb191-2698"><a href="#cb191-2698" aria-hidden="true" tabindex="-1"></a>ts_ts2_stl <span class="sc">%&gt;%</span> autoplot</span>
<span id="cb191-2699"><a href="#cb191-2699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2700"><a href="#cb191-2700" aria-hidden="true" tabindex="-1"></a>ts_ts2_stl <span class="ot">&lt;-</span> </span>
<span id="cb191-2701"><a href="#cb191-2701" aria-hidden="true" tabindex="-1"></a>  ts_ts2 <span class="sc">%&gt;%</span> </span>
<span id="cb191-2702"><a href="#cb191-2702" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stl</span>(<span class="at">s.window =</span> <span class="dv">33</span>,</span>
<span id="cb191-2703"><a href="#cb191-2703" aria-hidden="true" tabindex="-1"></a>      <span class="at">s.degree =</span> <span class="dv">1</span>,</span>
<span id="cb191-2704"><a href="#cb191-2704" aria-hidden="true" tabindex="-1"></a>      <span class="at">t.window =</span> <span class="dv">751</span>,</span>
<span id="cb191-2705"><a href="#cb191-2705" aria-hidden="true" tabindex="-1"></a>      <span class="at">t.degree =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb191-2706"><a href="#cb191-2706" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract2</span>(<span class="st">"time.series"</span>)</span>
<span id="cb191-2707"><a href="#cb191-2707" aria-hidden="true" tabindex="-1"></a>ts_ts2_stl <span class="sc">%&gt;%</span> autoplot</span>
<span id="cb191-2708"><a href="#cb191-2708" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2709"><a href="#cb191-2709" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2710"><a href="#cb191-2710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2711"><a href="#cb191-2711" aria-hidden="true" tabindex="-1"></a>The **model** function from package <span class="in">`fabletools`</span> also has a STL model:</span>
<span id="cb191-2712"><a href="#cb191-2712" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2713"><a href="#cb191-2713" aria-hidden="true" tabindex="-1"></a><span class="in">```{r experiment-with-STL}</span></span>
<span id="cb191-2714"><a href="#cb191-2714" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2715"><a href="#cb191-2715" aria-hidden="true" tabindex="-1"></a>ts_ts2 <span class="sc">%&gt;%</span></span>
<span id="cb191-2716"><a href="#cb191-2716" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model</span>(<span class="fu">STL</span>(y_2 <span class="sc">~</span> <span class="fu">trend</span>(<span class="at">window =</span> <span class="fl">0.75</span> <span class="sc">*</span> <span class="fu">nrow</span>(ts_ts2), </span>
<span id="cb191-2717"><a href="#cb191-2717" aria-hidden="true" tabindex="-1"></a>                        <span class="at">degree =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb191-2718"><a href="#cb191-2718" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">season</span>(<span class="at">window =</span> <span class="fl">0.1</span> <span class="sc">*</span> <span class="fu">nrow</span>(ts_ts2), </span>
<span id="cb191-2719"><a href="#cb191-2719" aria-hidden="true" tabindex="-1"></a>                         <span class="at">period =</span> <span class="st">"1 year"</span>, </span>
<span id="cb191-2720"><a href="#cb191-2720" aria-hidden="true" tabindex="-1"></a>                         <span class="at">degree =</span> <span class="dv">1</span>),</span>
<span id="cb191-2721"><a href="#cb191-2721" aria-hidden="true" tabindex="-1"></a>            <span class="at">robust =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb191-2722"><a href="#cb191-2722" aria-hidden="true" tabindex="-1"></a>  components <span class="sc">%&gt;%</span></span>
<span id="cb191-2723"><a href="#cb191-2723" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>()</span>
<span id="cb191-2724"><a href="#cb191-2724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2725"><a href="#cb191-2725" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2726"><a href="#cb191-2726" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2727"><a href="#cb191-2727" aria-hidden="true" tabindex="-1"></a><span class="fu">## Multiple time series</span></span>
<span id="cb191-2728"><a href="#cb191-2728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2729"><a href="#cb191-2729" aria-hidden="true" tabindex="-1"></a><span class="fu">### Detect gaps</span></span>
<span id="cb191-2730"><a href="#cb191-2730" aria-hidden="true" tabindex="-1"></a>Tools from <span class="in">`tsibble`</span> for detecting gaps:</span>
<span id="cb191-2731"><a href="#cb191-2731" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2732"><a href="#cb191-2732" aria-hidden="true" tabindex="-1"></a><span class="in">```{r gaps-in-ts-wws}</span></span>
<span id="cb191-2733"><a href="#cb191-2733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2734"><a href="#cb191-2734" aria-hidden="true" tabindex="-1"></a>ts_wws <span class="sc">%&gt;%</span> has_gaps</span>
<span id="cb191-2735"><a href="#cb191-2735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2736"><a href="#cb191-2736" aria-hidden="true" tabindex="-1"></a>ts_wws <span class="sc">%&gt;%</span> has_gaps <span class="sc">%&gt;%</span> <span class="fu">filter</span>(.gaps <span class="sc">==</span> <span class="cn">TRUE</span>)</span>
<span id="cb191-2737"><a href="#cb191-2737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2738"><a href="#cb191-2738" aria-hidden="true" tabindex="-1"></a>ts_wws <span class="sc">%&gt;%</span> <span class="fu">count_gaps</span>()</span>
<span id="cb191-2739"><a href="#cb191-2739" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2740"><a href="#cb191-2740" aria-hidden="true" tabindex="-1"></a>ts_wws <span class="sc">%&gt;%</span></span>
<span id="cb191-2741"><a href="#cb191-2741" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(store <span class="sc">==</span> <span class="dv">1</span>, dept <span class="sc">==</span> <span class="dv">18</span>) <span class="sc">%&gt;%</span></span>
<span id="cb191-2742"><a href="#cb191-2742" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="at">n =</span> <span class="dv">20</span>)</span>
<span id="cb191-2743"><a href="#cb191-2743" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2744"><a href="#cb191-2744" aria-hidden="true" tabindex="-1"></a>ts_wws <span class="sc">%&gt;%</span> <span class="fu">scan_gaps</span>()</span>
<span id="cb191-2745"><a href="#cb191-2745" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2746"><a href="#cb191-2746" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2747"><a href="#cb191-2747" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2748"><a href="#cb191-2748" aria-hidden="true" tabindex="-1"></a><span class="fu">### Fill gaps (keep original keys)</span></span>
<span id="cb191-2749"><a href="#cb191-2749" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2750"><a href="#cb191-2750" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fill_gaps}</span></span>
<span id="cb191-2751"><a href="#cb191-2751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2752"><a href="#cb191-2752" aria-hidden="true" tabindex="-1"></a>ts_wws <span class="sc">%&gt;%</span>  <span class="fu">fill_gaps</span>(<span class="at">.full =</span> <span class="cn">TRUE</span>)</span>
<span id="cb191-2753"><a href="#cb191-2753" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2754"><a href="#cb191-2754" aria-hidden="true" tabindex="-1"></a>ts_wws <span class="sc">%&gt;%</span>  <span class="fu">fill_gaps</span>(<span class="at">.full =</span> <span class="cn">FALSE</span>)</span>
<span id="cb191-2755"><a href="#cb191-2755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2756"><a href="#cb191-2756" aria-hidden="true" tabindex="-1"></a>ts_wws <span class="sc">%&lt;&gt;%</span>  <span class="fu">fill_gaps</span>(<span class="at">.full =</span> <span class="cn">FALSE</span>)</span>
<span id="cb191-2757"><a href="#cb191-2757" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2758"><a href="#cb191-2758" aria-hidden="true" tabindex="-1"></a>ts_wws <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(store) <span class="sc">%&gt;%</span> <span class="fu">reframe</span>(<span class="at">n_na =</span> <span class="fu">sum</span>(<span class="fu">is.na</span>(weekly_sales)))</span>
<span id="cb191-2759"><a href="#cb191-2759" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2760"><a href="#cb191-2760" aria-hidden="true" tabindex="-1"></a>ts_wws <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(dept) <span class="sc">%&gt;%</span> <span class="fu">reframe</span>(<span class="at">n_na =</span> <span class="fu">sum</span>(<span class="fu">is.na</span>(weekly_sales)))</span>
<span id="cb191-2761"><a href="#cb191-2761" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2762"><a href="#cb191-2762" aria-hidden="true" tabindex="-1"></a>df_na_wws <span class="ot">&lt;-</span></span>
<span id="cb191-2763"><a href="#cb191-2763" aria-hidden="true" tabindex="-1"></a>  ts_wws <span class="sc">%&gt;%</span> </span>
<span id="cb191-2764"><a href="#cb191-2764" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by_key</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb191-2765"><a href="#cb191-2765" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reframe</span>(<span class="at">n_na =</span> <span class="fu">sum</span>(<span class="fu">is.na</span>(weekly_sales)))</span>
<span id="cb191-2766"><a href="#cb191-2766" aria-hidden="true" tabindex="-1"></a>df_na_wws</span>
<span id="cb191-2767"><a href="#cb191-2767" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2768"><a href="#cb191-2768" aria-hidden="true" tabindex="-1"></a>df_na_wws <span class="sc">%&gt;%</span></span>
<span id="cb191-2769"><a href="#cb191-2769" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">has_na =</span> n_na <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb191-2770"><a href="#cb191-2770" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(has_na) <span class="sc">%&gt;%</span></span>
<span id="cb191-2771"><a href="#cb191-2771" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pct_na =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n) <span class="sc">*</span> <span class="dv">100</span>)</span>
<span id="cb191-2772"><a href="#cb191-2772" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2773"><a href="#cb191-2773" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2774"><a href="#cb191-2774" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2775"><a href="#cb191-2775" aria-hidden="true" tabindex="-1"></a>We see that only *~18%* of the time series have missing data.</span>
<span id="cb191-2776"><a href="#cb191-2776" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2777"><a href="#cb191-2777" aria-hidden="true" tabindex="-1"></a><span class="fu">### Keep only complete series</span></span>
<span id="cb191-2778"><a href="#cb191-2778" aria-hidden="true" tabindex="-1"></a>Let's take only the data with non-missing values.</span>
<span id="cb191-2779"><a href="#cb191-2779" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2780"><a href="#cb191-2780" aria-hidden="true" tabindex="-1"></a><span class="in">```{r restrict-wws-TSs-to-non-missing-values}</span></span>
<span id="cb191-2781"><a href="#cb191-2781" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2782"><a href="#cb191-2782" aria-hidden="true" tabindex="-1"></a>ts_wws_2 <span class="ot">&lt;-</span></span>
<span id="cb191-2783"><a href="#cb191-2783" aria-hidden="true" tabindex="-1"></a>  ts_wws <span class="sc">%&gt;%</span> </span>
<span id="cb191-2784"><a href="#cb191-2784" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by_key</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb191-2785"><a href="#cb191-2785" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reframe</span>(<span class="at">n_na =</span> <span class="fu">sum</span>(<span class="fu">is.na</span>(weekly_sales))) <span class="sc">%&gt;%</span></span>
<span id="cb191-2786"><a href="#cb191-2786" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n_na <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb191-2787"><a href="#cb191-2787" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>n_na) <span class="sc">%&gt;%</span></span>
<span id="cb191-2788"><a href="#cb191-2788" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(ts_wws) <span class="sc">%&gt;%</span></span>
<span id="cb191-2789"><a href="#cb191-2789" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tsibble</span>(<span class="at">index =</span> yweek, <span class="at">key =</span> <span class="fu">c</span>(store, dept))</span>
<span id="cb191-2790"><a href="#cb191-2790" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2791"><a href="#cb191-2791" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2792"><a href="#cb191-2792" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2793"><a href="#cb191-2793" aria-hidden="true" tabindex="-1"></a>Example: one store, several departments:</span>
<span id="cb191-2794"><a href="#cb191-2794" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2795"><a href="#cb191-2795" aria-hidden="true" tabindex="-1"></a><span class="in">```{r exple-1-store-few-dept}</span></span>
<span id="cb191-2796"><a href="#cb191-2796" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2797"><a href="#cb191-2797" aria-hidden="true" tabindex="-1"></a>ts_wws_2 <span class="sc">%&gt;%</span></span>
<span id="cb191-2798"><a href="#cb191-2798" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(store <span class="sc">==</span> <span class="dv">2</span>,</span>
<span id="cb191-2799"><a href="#cb191-2799" aria-hidden="true" tabindex="-1"></a>         dept <span class="sc">&lt;=</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb191-2800"><a href="#cb191-2800" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model</span>(<span class="fu">STL</span>(weekly_sales <span class="sc">~</span> <span class="fu">trend</span>() <span class="sc">+</span> <span class="fu">season</span>(), <span class="at">robust =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb191-2801"><a href="#cb191-2801" aria-hidden="true" tabindex="-1"></a>  components <span class="sc">%&gt;%</span></span>
<span id="cb191-2802"><a href="#cb191-2802" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>()</span>
<span id="cb191-2803"><a href="#cb191-2803" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2804"><a href="#cb191-2804" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2805"><a href="#cb191-2805" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2806"><a href="#cb191-2806" aria-hidden="true" tabindex="-1"></a>Let's check dept 3 for the same store:</span>
<span id="cb191-2807"><a href="#cb191-2807" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2808"><a href="#cb191-2808" aria-hidden="true" tabindex="-1"></a><span class="in">```{r exple-1-store-1-dept}</span></span>
<span id="cb191-2809"><a href="#cb191-2809" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2810"><a href="#cb191-2810" aria-hidden="true" tabindex="-1"></a>ts_wws_2 <span class="sc">%&gt;%</span></span>
<span id="cb191-2811"><a href="#cb191-2811" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(store <span class="sc">==</span> <span class="dv">2</span>,</span>
<span id="cb191-2812"><a href="#cb191-2812" aria-hidden="true" tabindex="-1"></a>         dept <span class="sc">==</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb191-2813"><a href="#cb191-2813" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model</span>(<span class="fu">STL</span>(weekly_sales <span class="sc">~</span> <span class="fu">trend</span>() <span class="sc">+</span> <span class="fu">season</span>(), <span class="at">robust =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb191-2814"><a href="#cb191-2814" aria-hidden="true" tabindex="-1"></a>  components <span class="sc">%&gt;%</span></span>
<span id="cb191-2815"><a href="#cb191-2815" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>()</span>
<span id="cb191-2816"><a href="#cb191-2816" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2817"><a href="#cb191-2817" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2818"><a href="#cb191-2818" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2819"><a href="#cb191-2819" aria-hidden="true" tabindex="-1"></a>Let's check all the stores for dept 3:</span>
<span id="cb191-2820"><a href="#cb191-2820" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2821"><a href="#cb191-2821" aria-hidden="true" tabindex="-1"></a><span class="in">```{r exple-1-dept-all-stores}</span></span>
<span id="cb191-2822"><a href="#cb191-2822" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2823"><a href="#cb191-2823" aria-hidden="true" tabindex="-1"></a>ts_wws_2 <span class="sc">%&gt;%</span></span>
<span id="cb191-2824"><a href="#cb191-2824" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(dept <span class="sc">==</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb191-2825"><a href="#cb191-2825" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(store) <span class="sc">%&gt;%</span></span>
<span id="cb191-2826"><a href="#cb191-2826" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reframe</span>(<span class="at">n_na =</span> <span class="fu">sum</span>(<span class="fu">is.na</span>(weekly_sales))) <span class="sc">%&gt;%</span></span>
<span id="cb191-2827"><a href="#cb191-2827" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n_na <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb191-2828"><a href="#cb191-2828" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2829"><a href="#cb191-2829" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2830"><a href="#cb191-2830" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2831"><a href="#cb191-2831" aria-hidden="true" tabindex="-1"></a>Aggregate all stores by department:</span>
<span id="cb191-2832"><a href="#cb191-2832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2833"><a href="#cb191-2833" aria-hidden="true" tabindex="-1"></a><span class="in">```{r aggregation-of-stores-by-dept}</span></span>
<span id="cb191-2834"><a href="#cb191-2834" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2835"><a href="#cb191-2835" aria-hidden="true" tabindex="-1"></a>ts_wws_3 <span class="ot">&lt;-</span></span>
<span id="cb191-2836"><a href="#cb191-2836" aria-hidden="true" tabindex="-1"></a>  df_wws <span class="sc">%&gt;%</span></span>
<span id="cb191-2837"><a href="#cb191-2837" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(dept, date) <span class="sc">%&gt;%</span></span>
<span id="cb191-2838"><a href="#cb191-2838" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reframe</span>(<span class="at">weekly_sales =</span> <span class="fu">sum</span>(weekly_sales)) <span class="sc">%&gt;%</span></span>
<span id="cb191-2839"><a href="#cb191-2839" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">yweek =</span> <span class="fu">yearweek</span>(date)) <span class="sc">%&gt;%</span></span>
<span id="cb191-2840"><a href="#cb191-2840" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tsibble</span>(<span class="at">index =</span> yweek,</span>
<span id="cb191-2841"><a href="#cb191-2841" aria-hidden="true" tabindex="-1"></a>          <span class="at">key =</span> dept)</span>
<span id="cb191-2842"><a href="#cb191-2842" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2843"><a href="#cb191-2843" aria-hidden="true" tabindex="-1"></a>ts_wws_3 <span class="sc">%&gt;%</span></span>
<span id="cb191-2844"><a href="#cb191-2844" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(dept <span class="sc">==</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb191-2845"><a href="#cb191-2845" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model</span>(<span class="fu">STL</span>(weekly_sales <span class="sc">~</span> <span class="fu">trend</span>() <span class="sc">+</span> <span class="fu">season</span>(), <span class="at">robust =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb191-2846"><a href="#cb191-2846" aria-hidden="true" tabindex="-1"></a>  components <span class="sc">%&gt;%</span></span>
<span id="cb191-2847"><a href="#cb191-2847" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>()</span>
<span id="cb191-2848"><a href="#cb191-2848" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2849"><a href="#cb191-2849" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2850"><a href="#cb191-2850" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2851"><a href="#cb191-2851" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2852"><a href="#cb191-2852" aria-hidden="true" tabindex="-1"></a><span class="fu">## STL feature extraction</span></span>
<span id="cb191-2853"><a href="#cb191-2853" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2854"><a href="#cb191-2854" aria-hidden="true" tabindex="-1"></a><span class="in">`feasts`</span> ships dozens of summary statistics, many derived from an STL decomposition.</span>
<span id="cb191-2855"><a href="#cb191-2855" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2856"><a href="#cb191-2856" aria-hidden="true" tabindex="-1"></a><span class="in">```{r features-basics}</span></span>
<span id="cb191-2857"><a href="#cb191-2857" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2858"><a href="#cb191-2858" aria-hidden="true" tabindex="-1"></a>ts_ts2 <span class="sc">%&gt;%</span> <span class="fu">features</span>(<span class="at">.var =</span> y_2, <span class="at">features =</span> <span class="fu">list</span>(<span class="at">mean =</span> mean, <span class="at">med =</span> median, <span class="at">min =</span> min, <span class="at">max =</span> max))</span>
<span id="cb191-2859"><a href="#cb191-2859" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2860"><a href="#cb191-2860" aria-hidden="true" tabindex="-1"></a>ts_ts2 <span class="sc">%&gt;%</span> <span class="fu">features</span>(<span class="at">.var =</span> y_2, quantile)</span>
<span id="cb191-2861"><a href="#cb191-2861" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2862"><a href="#cb191-2862" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2863"><a href="#cb191-2863" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2864"><a href="#cb191-2864" aria-hidden="true" tabindex="-1"></a>STL-specific features:</span>
<span id="cb191-2865"><a href="#cb191-2865" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2866"><a href="#cb191-2866" aria-hidden="true" tabindex="-1"></a><span class="in">```{r features-stl}</span></span>
<span id="cb191-2867"><a href="#cb191-2867" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2868"><a href="#cb191-2868" aria-hidden="true" tabindex="-1"></a>ts_ts2 <span class="sc">%&gt;%</span> <span class="fu">features</span>(<span class="at">.var =</span> y_2, <span class="at">features =</span> <span class="fu">feature_set</span>(<span class="at">tags =</span> <span class="st">"stl"</span>))</span>
<span id="cb191-2869"><a href="#cb191-2869" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2870"><a href="#cb191-2870" aria-hidden="true" tabindex="-1"></a>ts_wws <span class="sc">%&gt;%</span> <span class="fu">features</span>(<span class="at">.var =</span> weekly_sales, <span class="at">features =</span> feat_stl)</span>
<span id="cb191-2871"><a href="#cb191-2871" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2872"><a href="#cb191-2872" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2873"><a href="#cb191-2873" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2874"><a href="#cb191-2874" aria-hidden="true" tabindex="-1"></a>Let's focus on trend strength for example (see a description in the chapter <span class="co">[</span><span class="ot">STL features</span><span class="co">](https://otexts.com/fpp3/stlfeatures.html)</span>).</span>
<span id="cb191-2875"><a href="#cb191-2875" aria-hidden="true" tabindex="-1"></a>Let's re-arrange the data frame with the higher trend strength on top.</span>
<span id="cb191-2876"><a href="#cb191-2876" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2877"><a href="#cb191-2877" aria-hidden="true" tabindex="-1"></a><span class="in">```{r features-stl-desc-trend-strength}</span></span>
<span id="cb191-2878"><a href="#cb191-2878" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2879"><a href="#cb191-2879" aria-hidden="true" tabindex="-1"></a>ts_wws_3 <span class="sc">%&gt;%</span> <span class="fu">features</span>(<span class="at">.var =</span> weekly_sales, <span class="at">features =</span> feat_stl) <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(<span class="fu">desc</span>(trend_strength))</span>
<span id="cb191-2880"><a href="#cb191-2880" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2881"><a href="#cb191-2881" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2882"><a href="#cb191-2882" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2883"><a href="#cb191-2883" aria-hidden="true" tabindex="-1"></a>Plot a department with high trend strength:</span>
<span id="cb191-2884"><a href="#cb191-2884" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2885"><a href="#cb191-2885" aria-hidden="true" tabindex="-1"></a><span class="in">```{r exple-dept-high-trend-strength}</span></span>
<span id="cb191-2886"><a href="#cb191-2886" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2887"><a href="#cb191-2887" aria-hidden="true" tabindex="-1"></a>ts_wws_3 <span class="sc">%&gt;%</span></span>
<span id="cb191-2888"><a href="#cb191-2888" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(dept <span class="sc">==</span> <span class="dv">87</span>) <span class="sc">%&gt;%</span></span>
<span id="cb191-2889"><a href="#cb191-2889" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model</span>(<span class="fu">STL</span>(weekly_sales <span class="sc">~</span> <span class="fu">trend</span>() <span class="sc">+</span> <span class="fu">season</span>(), <span class="at">robust =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb191-2890"><a href="#cb191-2890" aria-hidden="true" tabindex="-1"></a>  components <span class="sc">%&gt;%</span></span>
<span id="cb191-2891"><a href="#cb191-2891" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>()</span>
<span id="cb191-2892"><a href="#cb191-2892" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2893"><a href="#cb191-2893" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2894"><a href="#cb191-2894" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2895"><a href="#cb191-2895" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2896"><a href="#cb191-2896" aria-hidden="true" tabindex="-1"></a><span class="fu">## Python implementation</span></span>
<span id="cb191-2897"><a href="#cb191-2897" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2900"><a href="#cb191-2900" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb191-2901"><a href="#cb191-2901" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb191-2902"><a href="#cb191-2902" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsmodels.tsa.seasonal <span class="im">import</span> STL</span>
<span id="cb191-2903"><a href="#cb191-2903" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2904"><a href="#cb191-2904" aria-hidden="true" tabindex="-1"></a><span class="co"># Load synthetic data (same TSV)</span></span>
<span id="cb191-2905"><a href="#cb191-2905" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">"data/synthetic_TS_02.tsv"</span>, sep<span class="op">=</span><span class="st">"</span><span class="ch">\t</span><span class="st">"</span>, parse_dates<span class="op">=</span>[<span class="st">"day"</span>])</span>
<span id="cb191-2906"><a href="#cb191-2906" aria-hidden="true" tabindex="-1"></a>ts <span class="op">=</span> df.set_index(<span class="st">"day"</span>)[<span class="st">"y_2"</span>]</span>
<span id="cb191-2907"><a href="#cb191-2907" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2908"><a href="#cb191-2908" aria-hidden="true" tabindex="-1"></a><span class="co"># STL (period = 365)</span></span>
<span id="cb191-2909"><a href="#cb191-2909" aria-hidden="true" tabindex="-1"></a>stl <span class="op">=</span> STL(ts, period<span class="op">=</span><span class="dv">365</span>, robust<span class="op">=</span><span class="va">True</span>).fit()</span>
<span id="cb191-2910"><a href="#cb191-2910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2911"><a href="#cb191-2911" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb191-2912"><a href="#cb191-2912" aria-hidden="true" tabindex="-1"></a>stl.plot()</span>
<span id="cb191-2913"><a href="#cb191-2913" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2914"><a href="#cb191-2914" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2915"><a href="#cb191-2915" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2916"><a href="#cb191-2916" aria-hidden="true" tabindex="-1"></a><span class="fu">## Homework</span></span>
<span id="cb191-2917"><a href="#cb191-2917" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2918"><a href="#cb191-2918" aria-hidden="true" tabindex="-1"></a>::: {#imp-hwk1 .callout-important}</span>
<span id="cb191-2919"><a href="#cb191-2919" aria-hidden="true" tabindex="-1"></a><span class="fu">## To do at home</span></span>
<span id="cb191-2920"><a href="#cb191-2920" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2921"><a href="#cb191-2921" aria-hidden="true" tabindex="-1"></a>Review the Time Series Analysis we have seen so far and read the Time Series chapters (1-4) of <span class="co">[</span><span class="ot">Forecasting: Principles and Practice (3rd ed.)</span><span class="co">](https://otexts.com/fpp3/)</span> (or another book you might like better).</span>
<span id="cb191-2922"><a href="#cb191-2922" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb191-2923"><a href="#cb191-2923" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2924"><a href="#cb191-2924" aria-hidden="true" tabindex="-1"></a>::: {#imp-hwk2 .callout-important}</span>
<span id="cb191-2925"><a href="#cb191-2925" aria-hidden="true" tabindex="-1"></a><span class="fu">### To do at home (will be checked directly in class and in the quiz)</span></span>
<span id="cb191-2926"><a href="#cb191-2926" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2927"><a href="#cb191-2927" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Download the "Supply Chain" Time Series data from Moodle on your laptop.</span>
<span id="cb191-2928"><a href="#cb191-2928" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Look for some Time Series Analysis packages, in Python or R (there are several), choose one, and install it on your laptop.</span>
<span id="cb191-2929"><a href="#cb191-2929" aria-hidden="true" tabindex="-1"></a>   You should also have a library that does smoothing, including LOESS, for "manual" analysis.</span>
<span id="cb191-2930"><a href="#cb191-2930" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Analyze the Time Series with the library tools in a notebook.</span>
<span id="cb191-2931"><a href="#cb191-2931" aria-hidden="true" tabindex="-1"></a>   For the analysis, you can get inspired by this notebook, and go beyond (ask new questions and try to answer them, find new problems and try to solve them, ...).</span>
<span id="cb191-2932"><a href="#cb191-2932" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>Prepare to present you analysis insights on your notebook in class.</span>
<span id="cb191-2933"><a href="#cb191-2933" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb191-2934"><a href="#cb191-2934" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2937"><a href="#cb191-2937" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-2938"><a href="#cb191-2938" aria-hidden="true" tabindex="-1"></a><span class="co"># Set data directory</span></span>
<span id="cb191-2939"><a href="#cb191-2939" aria-hidden="true" tabindex="-1"></a>data_dir <span class="ot">&lt;-</span> <span class="st">"data/Walmart"</span></span>
<span id="cb191-2940"><a href="#cb191-2940" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2941"><a href="#cb191-2941" aria-hidden="true" tabindex="-1"></a><span class="co"># Load Walmart data</span></span>
<span id="cb191-2942"><a href="#cb191-2942" aria-hidden="true" tabindex="-1"></a>fpath_wws <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{data_dir}/train.csv"</span>)</span>
<span id="cb191-2943"><a href="#cb191-2943" aria-hidden="true" tabindex="-1"></a>df_wws_raw <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(fpath_wws, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb191-2944"><a href="#cb191-2944" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2945"><a href="#cb191-2945" aria-hidden="true" tabindex="-1"></a><span class="co"># Pretty print summary</span></span>
<span id="cb191-2946"><a href="#cb191-2946" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"</span></span>
<span id="cb191-2947"><a href="#cb191-2947" aria-hidden="true" tabindex="-1"></a><span class="st">=== WALMART DATA LOADED ===</span></span>
<span id="cb191-2948"><a href="#cb191-2948" aria-hidden="true" tabindex="-1"></a><span class="st">Dimensions: {nrow(df_wws_raw)} rows × {ncol(df_wws_raw)} columns</span></span>
<span id="cb191-2949"><a href="#cb191-2949" aria-hidden="true" tabindex="-1"></a><span class="st">Date range: {min(df_wws_raw$date)} to {max(df_wws_raw$date)}</span></span>
<span id="cb191-2950"><a href="#cb191-2950" aria-hidden="true" tabindex="-1"></a><span class="st">Stores: {length(unique(df_wws_raw$Store))}</span></span>
<span id="cb191-2951"><a href="#cb191-2951" aria-hidden="true" tabindex="-1"></a><span class="st">Departments: {length(unique(df_wws_raw$Dept))}</span></span>
<span id="cb191-2952"><a href="#cb191-2952" aria-hidden="true" tabindex="-1"></a><span class="sc">\n</span><span class="st">"</span>))</span>
<span id="cb191-2953"><a href="#cb191-2953" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2954"><a href="#cb191-2954" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2955"><a href="#cb191-2955" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2956"><a href="#cb191-2956" aria-hidden="true" tabindex="-1"></a><span class="fu">### Exploratory Data Analysis</span></span>
<span id="cb191-2957"><a href="#cb191-2957" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2958"><a href="#cb191-2958" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Data Preparation</span></span>
<span id="cb191-2959"><a href="#cb191-2959" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2962"><a href="#cb191-2962" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-2963"><a href="#cb191-2963" aria-hidden="true" tabindex="-1"></a><span class="co"># Clean and prepare data</span></span>
<span id="cb191-2964"><a href="#cb191-2964" aria-hidden="true" tabindex="-1"></a>df_wws <span class="ot">&lt;-</span> df_wws_raw <span class="sc">%&gt;%</span></span>
<span id="cb191-2965"><a href="#cb191-2965" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_with</span>(tolower) <span class="sc">%&gt;%</span></span>
<span id="cb191-2966"><a href="#cb191-2966" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(</span>
<span id="cb191-2967"><a href="#cb191-2967" aria-hidden="true" tabindex="-1"></a>    <span class="at">store =</span> store,</span>
<span id="cb191-2968"><a href="#cb191-2968" aria-hidden="true" tabindex="-1"></a>    <span class="at">dept =</span> dept,</span>
<span id="cb191-2969"><a href="#cb191-2969" aria-hidden="true" tabindex="-1"></a>    <span class="at">weekly_sales =</span> weekly_sales,</span>
<span id="cb191-2970"><a href="#cb191-2970" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_holiday =</span> isholiday,</span>
<span id="cb191-2971"><a href="#cb191-2971" aria-hidden="true" tabindex="-1"></a>    <span class="at">date =</span> date</span>
<span id="cb191-2972"><a href="#cb191-2972" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb191-2973"><a href="#cb191-2973" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb191-2974"><a href="#cb191-2974" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_holiday =</span> <span class="fu">as.logical</span>(is_holiday),</span>
<span id="cb191-2975"><a href="#cb191-2975" aria-hidden="true" tabindex="-1"></a>    <span class="at">date =</span> <span class="fu">as_date</span>(date),</span>
<span id="cb191-2976"><a href="#cb191-2976" aria-hidden="true" tabindex="-1"></a>    <span class="at">year =</span> <span class="fu">year</span>(date),</span>
<span id="cb191-2977"><a href="#cb191-2977" aria-hidden="true" tabindex="-1"></a>    <span class="at">month =</span> <span class="fu">month</span>(date),</span>
<span id="cb191-2978"><a href="#cb191-2978" aria-hidden="true" tabindex="-1"></a>    <span class="at">week_of_year =</span> <span class="fu">week</span>(date)</span>
<span id="cb191-2979"><a href="#cb191-2979" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb191-2980"><a href="#cb191-2980" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(date, store, dept)</span>
<span id="cb191-2981"><a href="#cb191-2981" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2982"><a href="#cb191-2982" aria-hidden="true" tabindex="-1"></a><span class="co"># Create tsibble</span></span>
<span id="cb191-2983"><a href="#cb191-2983" aria-hidden="true" tabindex="-1"></a>ts_wws <span class="ot">&lt;-</span> df_wws <span class="sc">%&gt;%</span></span>
<span id="cb191-2984"><a href="#cb191-2984" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">yweek =</span> <span class="fu">yearweek</span>(date)) <span class="sc">%&gt;%</span></span>
<span id="cb191-2985"><a href="#cb191-2985" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tsibble</span>(<span class="at">index =</span> yweek, <span class="at">key =</span> <span class="fu">c</span>(store, dept))</span>
<span id="cb191-2986"><a href="#cb191-2986" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2987"><a href="#cb191-2987" aria-hidden="true" tabindex="-1"></a>gap_info <span class="ot">&lt;-</span> ts_wws <span class="sc">%&gt;%</span> <span class="fu">has_gaps</span>()</span>
<span id="cb191-2988"><a href="#cb191-2988" aria-hidden="true" tabindex="-1"></a>n_with_gaps <span class="ot">&lt;-</span> <span class="fu">sum</span>(gap_info<span class="sc">$</span>.gaps)</span>
<span id="cb191-2989"><a href="#cb191-2989" aria-hidden="true" tabindex="-1"></a>n_total <span class="ot">&lt;-</span> <span class="fu">nrow</span>(gap_info)</span>
<span id="cb191-2990"><a href="#cb191-2990" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2991"><a href="#cb191-2991" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"</span></span>
<span id="cb191-2992"><a href="#cb191-2992" aria-hidden="true" tabindex="-1"></a><span class="st">=== GAP ANALYSIS ===</span></span>
<span id="cb191-2993"><a href="#cb191-2993" aria-hidden="true" tabindex="-1"></a><span class="st">Total (store, dept) series: {n_total}</span></span>
<span id="cb191-2994"><a href="#cb191-2994" aria-hidden="true" tabindex="-1"></a><span class="st">Series with at least one missing week: {n_with_gaps}</span></span>
<span id="cb191-2995"><a href="#cb191-2995" aria-hidden="true" tabindex="-1"></a><span class="st">Percentage with gaps: {round(100 * n_with_gaps / n_total, 2)}%</span></span>
<span id="cb191-2996"><a href="#cb191-2996" aria-hidden="true" tabindex="-1"></a><span class="sc">\n</span><span class="st">"</span>))</span>
<span id="cb191-2997"><a href="#cb191-2997" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-2998"><a href="#cb191-2998" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-2999"><a href="#cb191-2999" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3000"><a href="#cb191-3000" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Basic Descriptive Statistics</span></span>
<span id="cb191-3001"><a href="#cb191-3001" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3004"><a href="#cb191-3004" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-3005"><a href="#cb191-3005" aria-hidden="true" tabindex="-1"></a><span class="co"># Overall summary</span></span>
<span id="cb191-3006"><a href="#cb191-3006" aria-hidden="true" tabindex="-1"></a>summary_stats <span class="ot">&lt;-</span> df_wws <span class="sc">%&gt;%</span></span>
<span id="cb191-3007"><a href="#cb191-3007" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb191-3008"><a href="#cb191-3008" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_obs =</span> <span class="fu">n</span>(),</span>
<span id="cb191-3009"><a href="#cb191-3009" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_stores =</span> <span class="fu">n_distinct</span>(store),</span>
<span id="cb191-3010"><a href="#cb191-3010" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_depts =</span> <span class="fu">n_distinct</span>(dept),</span>
<span id="cb191-3011"><a href="#cb191-3011" aria-hidden="true" tabindex="-1"></a>    <span class="at">date_range =</span> <span class="fu">paste</span>(<span class="fu">min</span>(date), <span class="st">"to"</span>, <span class="fu">max</span>(date)),</span>
<span id="cb191-3012"><a href="#cb191-3012" aria-hidden="true" tabindex="-1"></a>    <span class="at">sales_mean =</span> <span class="fu">mean</span>(weekly_sales, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb191-3013"><a href="#cb191-3013" aria-hidden="true" tabindex="-1"></a>    <span class="at">sales_median =</span> <span class="fu">median</span>(weekly_sales, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb191-3014"><a href="#cb191-3014" aria-hidden="true" tabindex="-1"></a>    <span class="at">sales_sd =</span> <span class="fu">sd</span>(weekly_sales, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb191-3015"><a href="#cb191-3015" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_holidays =</span> <span class="fu">mean</span>(is_holiday) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb191-3016"><a href="#cb191-3016" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb191-3017"><a href="#cb191-3017" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3018"><a href="#cb191-3018" aria-hidden="true" tabindex="-1"></a>summary_stats</span>
<span id="cb191-3019"><a href="#cb191-3019" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-3020"><a href="#cb191-3020" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3021"><a href="#cb191-3021" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3022"><a href="#cb191-3022" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Sales Distribution by Store Type</span></span>
<span id="cb191-3023"><a href="#cb191-3023" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3026"><a href="#cb191-3026" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-3027"><a href="#cb191-3027" aria-hidden="true" tabindex="-1"></a><span class="co"># Top 10 stores by total sales</span></span>
<span id="cb191-3028"><a href="#cb191-3028" aria-hidden="true" tabindex="-1"></a>top_stores <span class="ot">&lt;-</span> df_wws <span class="sc">%&gt;%</span></span>
<span id="cb191-3029"><a href="#cb191-3029" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(store) <span class="sc">%&gt;%</span></span>
<span id="cb191-3030"><a href="#cb191-3030" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_sales =</span> <span class="fu">sum</span>(weekly_sales, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb191-3031"><a href="#cb191-3031" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(total_sales)) <span class="sc">%&gt;%</span></span>
<span id="cb191-3032"><a href="#cb191-3032" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">10</span>)</span>
<span id="cb191-3033"><a href="#cb191-3033" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3034"><a href="#cb191-3034" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot sales distribution</span></span>
<span id="cb191-3035"><a href="#cb191-3035" aria-hidden="true" tabindex="-1"></a>df_wws <span class="sc">%&gt;%</span></span>
<span id="cb191-3036"><a href="#cb191-3036" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(store) <span class="sc">%&gt;%</span></span>
<span id="cb191-3037"><a href="#cb191-3037" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb191-3038"><a href="#cb191-3038" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_sales =</span> <span class="fu">mean</span>(weekly_sales, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb191-3039"><a href="#cb191-3039" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_sales =</span> <span class="fu">sum</span>(weekly_sales, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb191-3040"><a href="#cb191-3040" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_weeks =</span> <span class="fu">n</span>(),</span>
<span id="cb191-3041"><a href="#cb191-3041" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb191-3042"><a href="#cb191-3042" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb191-3043"><a href="#cb191-3043" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(store, total_sales), <span class="at">y =</span> total_sales <span class="sc">/</span> <span class="fl">1e6</span>)) <span class="sc">+</span></span>
<span id="cb191-3044"><a href="#cb191-3044" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">fill =</span> <span class="st">"steelblue"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb191-3045"><a href="#cb191-3045" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb191-3046"><a href="#cb191-3046" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb191-3047"><a href="#cb191-3047" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Total Sales by Store (Millions USD)"</span>,</span>
<span id="cb191-3048"><a href="#cb191-3048" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Store ID"</span>,</span>
<span id="cb191-3049"><a href="#cb191-3049" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Total Sales (M USD)"</span></span>
<span id="cb191-3050"><a href="#cb191-3050" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb191-3051"><a href="#cb191-3051" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> <span class="fu">dollar_format</span>())</span>
<span id="cb191-3052"><a href="#cb191-3052" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-3053"><a href="#cb191-3053" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3054"><a href="#cb191-3054" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3055"><a href="#cb191-3055" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Holiday Impact Analysis</span></span>
<span id="cb191-3056"><a href="#cb191-3056" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3059"><a href="#cb191-3059" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-3060"><a href="#cb191-3060" aria-hidden="true" tabindex="-1"></a><span class="co"># Holiday effect</span></span>
<span id="cb191-3061"><a href="#cb191-3061" aria-hidden="true" tabindex="-1"></a>holiday_effect <span class="ot">&lt;-</span> df_wws <span class="sc">%&gt;%</span></span>
<span id="cb191-3062"><a href="#cb191-3062" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(is_holiday) <span class="sc">%&gt;%</span></span>
<span id="cb191-3063"><a href="#cb191-3063" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb191-3064"><a href="#cb191-3064" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_sales =</span> <span class="fu">mean</span>(weekly_sales, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb191-3065"><a href="#cb191-3065" aria-hidden="true" tabindex="-1"></a>    <span class="at">median_sales =</span> <span class="fu">median</span>(weekly_sales, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb191-3066"><a href="#cb191-3066" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_obs =</span> <span class="fu">n</span>(),</span>
<span id="cb191-3067"><a href="#cb191-3067" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb191-3068"><a href="#cb191-3068" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb191-3069"><a href="#cb191-3069" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3070"><a href="#cb191-3070" aria-hidden="true" tabindex="-1"></a>holiday_effect <span class="sc">%&gt;%</span></span>
<span id="cb191-3071"><a href="#cb191-3071" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb191-3072"><a href="#cb191-3072" aria-hidden="true" tabindex="-1"></a>    <span class="at">holiday_label =</span> <span class="fu">ifelse</span>(is_holiday, <span class="st">"Holiday Week"</span>, <span class="st">"Regular Week"</span>),</span>
<span id="cb191-3073"><a href="#cb191-3073" aria-hidden="true" tabindex="-1"></a>    <span class="at">sales_increase_pct =</span> (mean_sales <span class="sc">/</span> <span class="fu">lag</span>(mean_sales) <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb191-3074"><a href="#cb191-3074" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb191-3075"><a href="#cb191-3075" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(holiday_label, mean_sales, sales_increase_pct)</span>
<span id="cb191-3076"><a href="#cb191-3076" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3077"><a href="#cb191-3077" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize holiday impact</span></span>
<span id="cb191-3078"><a href="#cb191-3078" aria-hidden="true" tabindex="-1"></a>df_wws <span class="sc">%&gt;%</span></span>
<span id="cb191-3079"><a href="#cb191-3079" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(date, is_holiday) <span class="sc">%&gt;%</span></span>
<span id="cb191-3080"><a href="#cb191-3080" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean_sales_all =</span> <span class="fu">mean</span>(weekly_sales, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb191-3081"><a href="#cb191-3081" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> mean_sales_all, <span class="at">color =</span> is_holiday)) <span class="sc">+</span></span>
<span id="cb191-3082"><a href="#cb191-3082" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb191-3083"><a href="#cb191-3083" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> . <span class="sc">%&gt;%</span> <span class="fu">filter</span>(is_holiday), <span class="at">size =</span> <span class="dv">2</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb191-3084"><a href="#cb191-3084" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb191-3085"><a href="#cb191-3085" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Average Weekly Sales Across All Stores"</span>,</span>
<span id="cb191-3086"><a href="#cb191-3086" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Red dots indicate holiday weeks"</span>,</span>
<span id="cb191-3087"><a href="#cb191-3087" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb191-3088"><a href="#cb191-3088" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Average Weekly Sales (USD)"</span>,</span>
<span id="cb191-3089"><a href="#cb191-3089" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Holiday Week"</span></span>
<span id="cb191-3090"><a href="#cb191-3090" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb191-3091"><a href="#cb191-3091" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> <span class="fu">dollar_format</span>()) <span class="sc">+</span></span>
<span id="cb191-3092"><a href="#cb191-3092" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb191-3093"><a href="#cb191-3093" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-3094"><a href="#cb191-3094" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3095"><a href="#cb191-3095" aria-hidden="true" tabindex="-1"></a><span class="fu">### STL Decomposition Analysis</span></span>
<span id="cb191-3096"><a href="#cb191-3096" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3097"><a href="#cb191-3097" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Handling Missing Values</span></span>
<span id="cb191-3098"><a href="#cb191-3098" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3101"><a href="#cb191-3101" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-3102"><a href="#cb191-3102" aria-hidden="true" tabindex="-1"></a><span class="co"># Analyze missing values</span></span>
<span id="cb191-3103"><a href="#cb191-3103" aria-hidden="true" tabindex="-1"></a>na_analysis <span class="ot">&lt;-</span> ts_wws <span class="sc">%&gt;%</span></span>
<span id="cb191-3104"><a href="#cb191-3104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(store, dept) <span class="sc">%&gt;%</span></span>
<span id="cb191-3105"><a href="#cb191-3105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb191-3106"><a href="#cb191-3106" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_missing =</span> <span class="fu">sum</span>(<span class="fu">is.na</span>(weekly_sales)),</span>
<span id="cb191-3107"><a href="#cb191-3107" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_total =</span> <span class="fu">n</span>(),</span>
<span id="cb191-3108"><a href="#cb191-3108" aria-hidden="true" tabindex="-1"></a>    <span class="at">pct_missing =</span> n_missing <span class="sc">/</span> n_total <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb191-3109"><a href="#cb191-3109" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb191-3110"><a href="#cb191-3110" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb191-3111"><a href="#cb191-3111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3112"><a href="#cb191-3112" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Series with missing values:"</span>, <span class="fu">sum</span>(na_analysis<span class="sc">$</span>pct_missing <span class="sc">&gt;</span> <span class="dv">0</span>), <span class="st">"out of"</span>, <span class="fu">nrow</span>(na_analysis), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb191-3113"><a href="#cb191-3113" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Average missing percentage:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(na_analysis<span class="sc">$</span>pct_missing[na_analysis<span class="sc">$</span>pct_missing <span class="sc">&gt;</span> <span class="dv">0</span>]), <span class="dv">2</span>), <span class="st">"%</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb191-3114"><a href="#cb191-3114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3115"><a href="#cb191-3115" aria-hidden="true" tabindex="-1"></a><span class="co"># Create complete dataset (fill gaps with NA, then filter complete series)</span></span>
<span id="cb191-3116"><a href="#cb191-3116" aria-hidden="true" tabindex="-1"></a>ts_wws_complete <span class="ot">&lt;-</span> ts_wws <span class="sc">%&gt;%</span></span>
<span id="cb191-3117"><a href="#cb191-3117" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fill_gaps</span>(<span class="at">.full =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb191-3118"><a href="#cb191-3118" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(store, dept) <span class="sc">%&gt;%</span></span>
<span id="cb191-3119"><a href="#cb191-3119" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">sum</span>(<span class="fu">is.na</span>(weekly_sales)) <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb191-3120"><a href="#cb191-3120" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb191-3121"><a href="#cb191-3121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3122"><a href="#cb191-3122" aria-hidden="true" tabindex="-1"></a>n_complete <span class="ot">&lt;-</span> ts_wws_complete <span class="sc">%&gt;%</span></span>
<span id="cb191-3123"><a href="#cb191-3123" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(store, dept) <span class="sc">%&gt;%</span></span>
<span id="cb191-3124"><a href="#cb191-3124" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nrow</span>()</span>
<span id="cb191-3125"><a href="#cb191-3125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3126"><a href="#cb191-3126" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">glue</span>(<span class="st">"Complete series retained: {n_complete}</span><span class="sc">\n</span><span class="st">"</span>))</span>
<span id="cb191-3127"><a href="#cb191-3127" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-3128"><a href="#cb191-3128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3129"><a href="#cb191-3129" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Single Series STL Decomposition</span></span>
<span id="cb191-3130"><a href="#cb191-3130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3133"><a href="#cb191-3133" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-3134"><a href="#cb191-3134" aria-hidden="true" tabindex="-1"></a><span class="co"># Select a representative store-department combination (Store 1, Dept 1)</span></span>
<span id="cb191-3135"><a href="#cb191-3135" aria-hidden="true" tabindex="-1"></a>single_series <span class="ot">&lt;-</span> ts_wws_complete <span class="sc">%&gt;%</span></span>
<span id="cb191-3136"><a href="#cb191-3136" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(store <span class="sc">==</span> <span class="dv">1</span>, dept <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb191-3137"><a href="#cb191-3137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3138"><a href="#cb191-3138" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply STL decomposition</span></span>
<span id="cb191-3139"><a href="#cb191-3139" aria-hidden="true" tabindex="-1"></a>stl_single <span class="ot">&lt;-</span> single_series <span class="sc">%&gt;%</span></span>
<span id="cb191-3140"><a href="#cb191-3140" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model</span>(</span>
<span id="cb191-3141"><a href="#cb191-3141" aria-hidden="true" tabindex="-1"></a>    <span class="fu">STL</span>(weekly_sales <span class="sc">~</span> <span class="fu">trend</span>(<span class="at">window =</span> <span class="dv">21</span>, <span class="at">degree =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb191-3142"><a href="#cb191-3142" aria-hidden="true" tabindex="-1"></a>              <span class="fu">season</span>(<span class="at">period =</span> <span class="dv">52</span>, <span class="at">window =</span> <span class="dv">13</span>, <span class="at">degree =</span> <span class="dv">1</span>),</span>
<span id="cb191-3143"><a href="#cb191-3143" aria-hidden="true" tabindex="-1"></a>        <span class="at">robust =</span> <span class="cn">TRUE</span>)</span>
<span id="cb191-3144"><a href="#cb191-3144" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb191-3145"><a href="#cb191-3145" aria-hidden="true" tabindex="-1"></a>  <span class="fu">components</span>()</span>
<span id="cb191-3146"><a href="#cb191-3146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3147"><a href="#cb191-3147" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot decomposition</span></span>
<span id="cb191-3148"><a href="#cb191-3148" aria-hidden="true" tabindex="-1"></a>stl_single <span class="sc">%&gt;%</span></span>
<span id="cb191-3149"><a href="#cb191-3149" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>() <span class="sc">+</span></span>
<span id="cb191-3150"><a href="#cb191-3150" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb191-3151"><a href="#cb191-3151" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"STL Decomposition: Store 1, Department 1"</span>,</span>
<span id="cb191-3152"><a href="#cb191-3152" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Weekly Sales with Trend, Seasonal, and Remainder Components"</span></span>
<span id="cb191-3153"><a href="#cb191-3153" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb191-3154"><a href="#cb191-3154" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb191-3155"><a href="#cb191-3155" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-3156"><a href="#cb191-3156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3157"><a href="#cb191-3157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3158"><a href="#cb191-3158" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Multiple Series Comparison</span></span>
<span id="cb191-3159"><a href="#cb191-3159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3162"><a href="#cb191-3162" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-3163"><a href="#cb191-3163" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare multiple departments in Store 1</span></span>
<span id="cb191-3164"><a href="#cb191-3164" aria-hidden="true" tabindex="-1"></a>store1_depts <span class="ot">&lt;-</span> ts_wws_complete <span class="sc">%&gt;%</span></span>
<span id="cb191-3165"><a href="#cb191-3165" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(store <span class="sc">==</span> <span class="dv">1</span>, dept <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">10</span>))</span>
<span id="cb191-3166"><a href="#cb191-3166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3167"><a href="#cb191-3167" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply STL to multiple series</span></span>
<span id="cb191-3168"><a href="#cb191-3168" aria-hidden="true" tabindex="-1"></a>stl_multiple <span class="ot">&lt;-</span> store1_depts <span class="sc">%&gt;%</span></span>
<span id="cb191-3169"><a href="#cb191-3169" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model</span>(<span class="fu">STL</span>(weekly_sales <span class="sc">~</span> <span class="fu">trend</span>() <span class="sc">+</span> <span class="fu">season</span>(), <span class="at">robust =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb191-3170"><a href="#cb191-3170" aria-hidden="true" tabindex="-1"></a>  <span class="fu">components</span>()</span>
<span id="cb191-3171"><a href="#cb191-3171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3172"><a href="#cb191-3172" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize</span></span>
<span id="cb191-3173"><a href="#cb191-3173" aria-hidden="true" tabindex="-1"></a>stl_multiple <span class="sc">%&gt;%</span></span>
<span id="cb191-3174"><a href="#cb191-3174" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>() <span class="sc">+</span></span>
<span id="cb191-3175"><a href="#cb191-3175" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> dept, <span class="at">scales =</span> <span class="st">"free_y"</span>, <span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb191-3176"><a href="#cb191-3176" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb191-3177"><a href="#cb191-3177" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"STL Decomposition: Store 1, Multiple Departments"</span>,</span>
<span id="cb191-3178"><a href="#cb191-3178" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Comparing trend and seasonal patterns across departments"</span></span>
<span id="cb191-3179"><a href="#cb191-3179" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb191-3180"><a href="#cb191-3180" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb191-3181"><a href="#cb191-3181" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-3182"><a href="#cb191-3182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3183"><a href="#cb191-3183" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Aggregated Analysis by Department</span></span>
<span id="cb191-3184"><a href="#cb191-3184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3187"><a href="#cb191-3187" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-3188"><a href="#cb191-3188" aria-hidden="true" tabindex="-1"></a><span class="co"># Aggregate sales by department across all stores</span></span>
<span id="cb191-3189"><a href="#cb191-3189" aria-hidden="true" tabindex="-1"></a>ts_dept_agg <span class="ot">&lt;-</span> df_wws <span class="sc">%&gt;%</span></span>
<span id="cb191-3190"><a href="#cb191-3190" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(weekly_sales)) <span class="sc">%&gt;%</span></span>
<span id="cb191-3191"><a href="#cb191-3191" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(dept, date) <span class="sc">%&gt;%</span></span>
<span id="cb191-3192"><a href="#cb191-3192" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb191-3193"><a href="#cb191-3193" aria-hidden="true" tabindex="-1"></a>    <span class="at">weekly_sales =</span> <span class="fu">sum</span>(weekly_sales),</span>
<span id="cb191-3194"><a href="#cb191-3194" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_stores =</span> <span class="fu">n_distinct</span>(store),</span>
<span id="cb191-3195"><a href="#cb191-3195" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb191-3196"><a href="#cb191-3196" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb191-3197"><a href="#cb191-3197" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">yweek =</span> <span class="fu">yearweek</span>(date)) <span class="sc">%&gt;%</span></span>
<span id="cb191-3198"><a href="#cb191-3198" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tsibble</span>(<span class="at">index =</span> yweek, <span class="at">key =</span> dept)</span>
<span id="cb191-3199"><a href="#cb191-3199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3200"><a href="#cb191-3200" aria-hidden="true" tabindex="-1"></a><span class="co"># Select top departments by total sales</span></span>
<span id="cb191-3201"><a href="#cb191-3201" aria-hidden="true" tabindex="-1"></a>top_depts <span class="ot">&lt;-</span> ts_dept_agg <span class="sc">%&gt;%</span></span>
<span id="cb191-3202"><a href="#cb191-3202" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(dept) <span class="sc">%&gt;%</span></span>
<span id="cb191-3203"><a href="#cb191-3203" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_sales =</span> <span class="fu">sum</span>(weekly_sales), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb191-3204"><a href="#cb191-3204" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(total_sales, <span class="at">n =</span> <span class="dv">5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb191-3205"><a href="#cb191-3205" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(dept)</span>
<span id="cb191-3206"><a href="#cb191-3206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3207"><a href="#cb191-3207" aria-hidden="true" tabindex="-1"></a><span class="co"># STL for top departments</span></span>
<span id="cb191-3208"><a href="#cb191-3208" aria-hidden="true" tabindex="-1"></a>top_dept_stl <span class="ot">&lt;-</span> ts_dept_agg <span class="sc">%&gt;%</span></span>
<span id="cb191-3209"><a href="#cb191-3209" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(dept <span class="sc">%in%</span> top_depts) <span class="sc">%&gt;%</span></span>
<span id="cb191-3210"><a href="#cb191-3210" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model</span>(<span class="fu">STL</span>(weekly_sales <span class="sc">~</span> <span class="fu">trend</span>() <span class="sc">+</span> <span class="fu">season</span>(<span class="at">period =</span> <span class="dv">52</span>), <span class="at">robust =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb191-3211"><a href="#cb191-3211" aria-hidden="true" tabindex="-1"></a>  <span class="fu">components</span>()</span>
<span id="cb191-3212"><a href="#cb191-3212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3213"><a href="#cb191-3213" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb191-3214"><a href="#cb191-3214" aria-hidden="true" tabindex="-1"></a>top_dept_stl <span class="sc">%&gt;%</span></span>
<span id="cb191-3215"><a href="#cb191-3215" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>() <span class="sc">+</span></span>
<span id="cb191-3216"><a href="#cb191-3216" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> dept, <span class="at">scales =</span> <span class="st">"free_y"</span>, <span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb191-3217"><a href="#cb191-3217" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb191-3218"><a href="#cb191-3218" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"STL Decomposition: Top 5 Departments (Aggregated)"</span>,</span>
<span id="cb191-3219"><a href="#cb191-3219" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Department-level sales patterns across all stores"</span></span>
<span id="cb191-3220"><a href="#cb191-3220" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb191-3221"><a href="#cb191-3221" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb191-3222"><a href="#cb191-3222" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-3223"><a href="#cb191-3223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3224"><a href="#cb191-3224" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Which departments show the strongest seasonal patterns?</span></span>
<span id="cb191-3225"><a href="#cb191-3225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3228"><a href="#cb191-3228" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-3229"><a href="#cb191-3229" aria-hidden="true" tabindex="-1"></a><span class="co"># === STL Feature Extraction (Correct Names) ===</span></span>
<span id="cb191-3230"><a href="#cb191-3230" aria-hidden="true" tabindex="-1"></a>stl_features <span class="ot">&lt;-</span> ts_dept_agg <span class="sc">%&gt;%</span></span>
<span id="cb191-3231"><a href="#cb191-3231" aria-hidden="true" tabindex="-1"></a>  <span class="fu">features</span>(weekly_sales, feat_stl)</span>
<span id="cb191-3232"><a href="#cb191-3232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3233"><a href="#cb191-3233" aria-hidden="true" tabindex="-1"></a><span class="co"># Inspect once (uncomment to debug)</span></span>
<span id="cb191-3234"><a href="#cb191-3234" aria-hidden="true" tabindex="-1"></a>stl_features <span class="sc">%&gt;%</span> <span class="fu">glimpse</span>()</span>
<span id="cb191-3235"><a href="#cb191-3235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3236"><a href="#cb191-3236" aria-hidden="true" tabindex="-1"></a>dept_features <span class="ot">&lt;-</span> stl_features <span class="sc">%&gt;%</span></span>
<span id="cb191-3237"><a href="#cb191-3237" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(seasonal_strength_year)) <span class="sc">%&gt;%</span></span>
<span id="cb191-3238"><a href="#cb191-3238" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">10</span>)</span>
<span id="cb191-3239"><a href="#cb191-3239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3240"><a href="#cb191-3240" aria-hidden="true" tabindex="-1"></a><span class="co"># Pretty table</span></span>
<span id="cb191-3241"><a href="#cb191-3241" aria-hidden="true" tabindex="-1"></a>dept_features <span class="sc">%&gt;%</span></span>
<span id="cb191-3242"><a href="#cb191-3242" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(dept, seasonal_strength_year, trend_strength, seasonal_peak_year, seasonal_trough_year) <span class="sc">%&gt;%</span></span>
<span id="cb191-3243"><a href="#cb191-3243" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb191-3244"><a href="#cb191-3244" aria-hidden="true" tabindex="-1"></a>    <span class="at">dept =</span> <span class="fu">glue</span>(<span class="st">"Dept {dept}"</span>),</span>
<span id="cb191-3245"><a href="#cb191-3245" aria-hidden="true" tabindex="-1"></a>    <span class="at">seasonal_strength_year =</span> <span class="fu">percent</span>(seasonal_strength_year, <span class="at">accuracy =</span> <span class="fl">0.1</span>)</span>
<span id="cb191-3246"><a href="#cb191-3246" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb191-3247"><a href="#cb191-3247" aria-hidden="true" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable</span>(</span>
<span id="cb191-3248"><a href="#cb191-3248" aria-hidden="true" tabindex="-1"></a>    <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Department"</span>, <span class="st">"Seasonal Strength"</span>, <span class="st">"Trend Strength"</span>, <span class="st">"Peak Week"</span>, <span class="st">"Trough Week"</span>),</span>
<span id="cb191-3249"><a href="#cb191-3249" aria-hidden="true" tabindex="-1"></a>    <span class="at">digits =</span> <span class="dv">3</span></span>
<span id="cb191-3250"><a href="#cb191-3250" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb191-3251"><a href="#cb191-3251" aria-hidden="true" tabindex="-1"></a>  kableExtra<span class="sc">::</span><span class="fu">kable_styling</span>(<span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>))</span>
<span id="cb191-3252"><a href="#cb191-3252" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-3253"><a href="#cb191-3253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3254"><a href="#cb191-3254" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Can we detect structural breaks in the trend component?</span></span>
<span id="cb191-3255"><a href="#cb191-3255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3258"><a href="#cb191-3258" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb191-3259"><a href="#cb191-3259" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract trend component and test for breaks</span></span>
<span id="cb191-3260"><a href="#cb191-3260" aria-hidden="true" tabindex="-1"></a>trend_analysis <span class="ot">&lt;-</span> ts_dept_agg <span class="sc">%&gt;%</span></span>
<span id="cb191-3261"><a href="#cb191-3261" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(dept <span class="sc">%in%</span> top_depts) <span class="sc">%&gt;%</span></span>
<span id="cb191-3262"><a href="#cb191-3262" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model</span>(<span class="fu">STL</span>(weekly_sales <span class="sc">~</span> <span class="fu">trend</span>(<span class="at">window =</span> <span class="dv">21</span>) <span class="sc">+</span> <span class="fu">season</span>(), <span class="at">robust =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb191-3263"><a href="#cb191-3263" aria-hidden="true" tabindex="-1"></a>  <span class="fu">components</span>() <span class="sc">%&gt;%</span></span>
<span id="cb191-3264"><a href="#cb191-3264" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb191-3265"><a href="#cb191-3265" aria-hidden="true" tabindex="-1"></a>    <span class="at">trend_change =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">diff</span>(trend)),</span>
<span id="cb191-3266"><a href="#cb191-3266" aria-hidden="true" tabindex="-1"></a>    <span class="at">trend_acceleration =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">diff</span>(trend_change)),</span>
<span id="cb191-3267"><a href="#cb191-3267" aria-hidden="true" tabindex="-1"></a>    <span class="at">year_quarter =</span> <span class="fu">yearquarter</span>(yweek)</span>
<span id="cb191-3268"><a href="#cb191-3268" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb191-3269"><a href="#cb191-3269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3270"><a href="#cb191-3270" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify potential structural breaks (large trend changes)</span></span>
<span id="cb191-3271"><a href="#cb191-3271" aria-hidden="true" tabindex="-1"></a>trend_breaks <span class="ot">&lt;-</span> trend_analysis <span class="sc">%&gt;%</span></span>
<span id="cb191-3272"><a href="#cb191-3272" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(dept) <span class="sc">%&gt;%</span></span>
<span id="cb191-3273"><a href="#cb191-3273" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">abs</span>(trend_change) <span class="sc">&gt;</span> <span class="fu">quantile</span>(<span class="fu">abs</span>(trend_change), <span class="fl">0.95</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb191-3274"><a href="#cb191-3274" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb191-3275"><a href="#cb191-3275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3276"><a href="#cb191-3276" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize trend with break points</span></span>
<span id="cb191-3277"><a href="#cb191-3277" aria-hidden="true" tabindex="-1"></a>trend_analysis <span class="sc">%&gt;%</span></span>
<span id="cb191-3278"><a href="#cb191-3278" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> yweek, <span class="at">y =</span> trend)) <span class="sc">+</span></span>
<span id="cb191-3279"><a href="#cb191-3279" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"steelblue"</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb191-3280"><a href="#cb191-3280" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> trend_breaks, </span>
<span id="cb191-3281"><a href="#cb191-3281" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">color =</span> <span class="st">"Potential Break"</span>), <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb191-3282"><a href="#cb191-3282" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> dept, <span class="at">scales =</span> <span class="st">"free_y"</span>, <span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb191-3283"><a href="#cb191-3283" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb191-3284"><a href="#cb191-3284" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Trend Component with Potential Structural Breaks"</span>,</span>
<span id="cb191-3285"><a href="#cb191-3285" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Points indicate weeks with unusually large trend changes"</span>,</span>
<span id="cb191-3286"><a href="#cb191-3286" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Year-Week"</span>,</span>
<span id="cb191-3287"><a href="#cb191-3287" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Trend Component"</span>,</span>
<span id="cb191-3288"><a href="#cb191-3288" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">""</span></span>
<span id="cb191-3289"><a href="#cb191-3289" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb191-3290"><a href="#cb191-3290" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb191-3291"><a href="#cb191-3291" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb191-3292"><a href="#cb191-3292" aria-hidden="true" tabindex="-1"></a></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>