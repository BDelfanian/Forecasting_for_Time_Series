<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.23">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Behrouz Delfanian">

<title>Generating Time Series</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="generating_time_series_files/libs/clipboard/clipboard.min.js"></script>
<script src="generating_time_series_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="generating_time_series_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="generating_time_series_files/libs/quarto-html/popper.min.js"></script>
<script src="generating_time_series_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="generating_time_series_files/libs/quarto-html/anchor.min.js"></script>
<link href="generating_time_series_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="generating_time_series_files/libs/quarto-html/quarto-syntax-highlighting-226bd0f977fa82dfae4534cac220d79a.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="generating_time_series_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="generating_time_series_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="generating_time_series_files/libs/bootstrap/bootstrap-c55efa1fd218a545ebab9e5bcab7af02.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#r-environment-setting" id="toc-r-environment-setting" class="nav-link active" data-scroll-target="#r-environment-setting"><span class="header-section-number">1</span> R environment setting</a></li>
  <li><a href="#time-series-overview" id="toc-time-series-overview" class="nav-link" data-scroll-target="#time-series-overview"><span class="header-section-number">2</span> Time series overview</a>
  <ul class="collapse">
  <li><a href="#what-is-a-time-series" id="toc-what-is-a-time-series" class="nav-link" data-scroll-target="#what-is-a-time-series"><span class="header-section-number">2.1</span> What is a time series?</a></li>
  <li><a href="#key-components" id="toc-key-components" class="nav-link" data-scroll-target="#key-components"><span class="header-section-number">2.2</span> Key components</a></li>
  <li><a href="#models-of-time-series" id="toc-models-of-time-series" class="nav-link" data-scroll-target="#models-of-time-series"><span class="header-section-number">2.3</span> Models of time series</a></li>
  <li><a href="#applications-in-supply-chain" id="toc-applications-in-supply-chain" class="nav-link" data-scroll-target="#applications-in-supply-chain"><span class="header-section-number">2.4</span> Applications in supply chain</a></li>
  </ul></li>
  <li><a href="#generating-a-ts-components" id="toc-generating-a-ts-components" class="nav-link" data-scroll-target="#generating-a-ts-components"><span class="header-section-number">3</span> Generating a TS components</a>
  <ul class="collapse">
  <li><a href="#deterministic-component" id="toc-deterministic-component" class="nav-link" data-scroll-target="#deterministic-component"><span class="header-section-number">3.1</span> Deterministic component</a>
  <ul class="collapse">
  <li><a href="#trend-component" id="toc-trend-component" class="nav-link" data-scroll-target="#trend-component"><span class="header-section-number">3.1.1</span> Trend component</a></li>
  <li><a href="#seasonality-component" id="toc-seasonality-component" class="nav-link" data-scroll-target="#seasonality-component"><span class="header-section-number">3.1.2</span> Seasonality component</a></li>
  <li><a href="#additive-model" id="toc-additive-model" class="nav-link" data-scroll-target="#additive-model"><span class="header-section-number">3.1.3</span> Additive model</a></li>
  <li><a href="#multiplicative-model" id="toc-multiplicative-model" class="nav-link" data-scroll-target="#multiplicative-model"><span class="header-section-number">3.1.4</span> Multiplicative model</a></li>
  </ul></li>
  <li><a href="#random-component" id="toc-random-component" class="nav-link" data-scroll-target="#random-component"><span class="header-section-number">3.2</span> Random component</a>
  <ul class="collapse">
  <li><a href="#gaussain-noise" id="toc-gaussain-noise" class="nav-link" data-scroll-target="#gaussain-noise"><span class="header-section-number">3.2.1</span> Gaussain noise</a></li>
  <li><a href="#poisson-noise" id="toc-poisson-noise" class="nav-link" data-scroll-target="#poisson-noise"><span class="header-section-number">3.2.2</span> Poisson Noise</a></li>
  <li><a href="#negative-binomial-noise" id="toc-negative-binomial-noise" class="nav-link" data-scroll-target="#negative-binomial-noise"><span class="header-section-number">3.2.3</span> Negative Binomial noise</a></li>
  <li><a href="#gamma-noise" id="toc-gamma-noise" class="nav-link" data-scroll-target="#gamma-noise"><span class="header-section-number">3.2.4</span> Gamma noise</a></li>
  <li><a href="#log-normal-noise" id="toc-log-normal-noise" class="nav-link" data-scroll-target="#log-normal-noise"><span class="header-section-number">3.2.5</span> Log-Normal noise</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#ts-noise-modelling" id="toc-ts-noise-modelling" class="nav-link" data-scroll-target="#ts-noise-modelling"><span class="header-section-number">4</span> TS noise modelling</a>
  <ul class="collapse">
  <li><a href="#review-of-the-additive-model" id="toc-review-of-the-additive-model" class="nav-link" data-scroll-target="#review-of-the-additive-model"><span class="header-section-number">4.1</span> Review of the additive model</a>
  <ul class="collapse">
  <li><a href="#load-the-data" id="toc-load-the-data" class="nav-link" data-scroll-target="#load-the-data"><span class="header-section-number">4.1.1</span> Load the data</a></li>
  <li><a href="#trend-component-1" id="toc-trend-component-1" class="nav-link" data-scroll-target="#trend-component-1"><span class="header-section-number">4.1.2</span> Trend component</a></li>
  <li><a href="#seasonal-component" id="toc-seasonal-component" class="nav-link" data-scroll-target="#seasonal-component"><span class="header-section-number">4.1.3</span> Seasonal component</a></li>
  <li><a href="#original-time-series" id="toc-original-time-series" class="nav-link" data-scroll-target="#original-time-series"><span class="header-section-number">4.1.4</span> Original time series</a></li>
  </ul></li>
  <li><a href="#noise-with-constant-rate" id="toc-noise-with-constant-rate" class="nav-link" data-scroll-target="#noise-with-constant-rate"><span class="header-section-number">4.2</span> Noise with constant rate</a></li>
  <li><a href="#noise-with-proportional-rate" id="toc-noise-with-proportional-rate" class="nav-link" data-scroll-target="#noise-with-proportional-rate"><span class="header-section-number">4.3</span> Noise with proportional rate</a>
  <ul class="collapse">
  <li><a href="#additive-interpretation" id="toc-additive-interpretation" class="nav-link" data-scroll-target="#additive-interpretation"><span class="header-section-number">4.3.1</span> Additive interpretation</a></li>
  <li><a href="#multiplicative-equivalence" id="toc-multiplicative-equivalence" class="nav-link" data-scroll-target="#multiplicative-equivalence"><span class="header-section-number">4.3.2</span> Multiplicative equivalence</a></li>
  <li><a href="#implementation" id="toc-implementation" class="nav-link" data-scroll-target="#implementation"><span class="header-section-number">4.3.3</span> Implementation</a></li>
  <li><a href="#interpretation" id="toc-interpretation" class="nav-link" data-scroll-target="#interpretation"><span class="header-section-number">4.3.4</span> Interpretation</a></li>
  </ul></li>
  <li><a href="#analysis" id="toc-analysis" class="nav-link" data-scroll-target="#analysis"><span class="header-section-number">4.4</span> Analysis</a>
  <ul class="collapse">
  <li><a href="#visualizing-yearly-seasonality" id="toc-visualizing-yearly-seasonality" class="nav-link" data-scroll-target="#visualizing-yearly-seasonality"><span class="header-section-number">4.4.1</span> Visualizing yearly seasonality</a></li>
  <li><a href="#trend-analysis" id="toc-trend-analysis" class="nav-link" data-scroll-target="#trend-analysis"><span class="header-section-number">4.4.2</span> Trend analysis</a></li>
  <li><a href="#seasonality" id="toc-seasonality" class="nav-link" data-scroll-target="#seasonality"><span class="header-section-number">4.4.3</span> Seasonality</a></li>
  <li><a href="#noise-extraction" id="toc-noise-extraction" class="nav-link" data-scroll-target="#noise-extraction"><span class="header-section-number">4.4.4</span> Noise extraction</a></li>
  <li><a href="#modeling-multiplicative-noise" id="toc-modeling-multiplicative-noise" class="nav-link" data-scroll-target="#modeling-multiplicative-noise"><span class="header-section-number">4.4.5</span> Modeling multiplicative noise</a></li>
  </ul></li>
  <li><a href="#modeling-wrap-up" id="toc-modeling-wrap-up" class="nav-link" data-scroll-target="#modeling-wrap-up"><span class="header-section-number">4.5</span> Modeling wrap-up</a>
  <ul class="collapse">
  <li><a href="#trend" id="toc-trend" class="nav-link" data-scroll-target="#trend"><span class="header-section-number">4.5.1</span> Trend</a></li>
  <li><a href="#seasonality-1" id="toc-seasonality-1" class="nav-link" data-scroll-target="#seasonality-1"><span class="header-section-number">4.5.2</span> Seasonality:</a></li>
  <li><a href="#noise" id="toc-noise" class="nav-link" data-scroll-target="#noise"><span class="header-section-number">4.5.3</span> Noise</a></li>
  <li><a href="#additive-vs.-multiplicative-noise" id="toc-additive-vs.-multiplicative-noise" class="nav-link" data-scroll-target="#additive-vs.-multiplicative-noise"><span class="header-section-number">4.5.4</span> Additive vs.&nbsp;multiplicative noise</a></li>
  </ul></li>
  <li><a href="#real-case-walmart-2010" id="toc-real-case-walmart-2010" class="nav-link" data-scroll-target="#real-case-walmart-2010"><span class="header-section-number">4.6</span> Real case: Walmart 2010</a>
  <ul class="collapse">
  <li><a href="#dataset" id="toc-dataset" class="nav-link" data-scroll-target="#dataset"><span class="header-section-number">4.6.1</span> Dataset</a></li>
  <li><a href="#inspecting-the-training-data" id="toc-inspecting-the-training-data" class="nav-link" data-scroll-target="#inspecting-the-training-data"><span class="header-section-number">4.6.2</span> Inspecting the training data</a></li>
  <li><a href="#year-over-year-analysis" id="toc-year-over-year-analysis" class="nav-link" data-scroll-target="#year-over-year-analysis"><span class="header-section-number">4.6.3</span> Year-over-year analysis</a></li>
  <li><a href="#trend-analysis-1" id="toc-trend-analysis-1" class="nav-link" data-scroll-target="#trend-analysis-1"><span class="header-section-number">4.6.4</span> Trend analysis</a></li>
  <li><a href="#seasonality-and-noise-analysis" id="toc-seasonality-and-noise-analysis" class="nav-link" data-scroll-target="#seasonality-and-noise-analysis"><span class="header-section-number">4.6.5</span> Seasonality and noise analysis</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Generating Time Series</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Behrouz Delfanian </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="r-environment-setting" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> R environment setting</h1>
<p>Installing required libraries</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>cran_repo <span class="ot">&lt;-</span> <span class="st">"https://ftp.fau.de/cran"</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>list_Rpack2use <span class="ot">&lt;-</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"rmarkdown"</span>,</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"conflicted"</span>,</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"devtools"</span>,</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"knitr"</span>,</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"quarto"</span>,</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"bookdown"</span>,</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">#shiny,</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"DT"</span>,</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Hmisc"</span>,</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"tidyverse"</span>,</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"magrittr"</span>,</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lubridate"</span>,</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hms"</span>,</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"glue"</span>,</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"skimr"</span>,</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lobstr"</span>,</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"janitor"</span>,</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"zeallot"</span>,</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"stringi"</span>,</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lemon"</span>,</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"crayon"</span>,</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"jsonlite"</span>,</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">#"officer",</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"tsibble"</span>,</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fable"</span>,</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">"feasts"</span>,</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"imputeTS"</span>,</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">"readxl"</span>,</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">"slider"</span>,</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">"reticulate"</span>,</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">"aws.s3"</span>,</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">"paws"</span>,</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">"RAthena"</span>,</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">"botor"</span>,</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">"RPostgres"</span>,</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>    <span class="st">"DBI"</span>,</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>    <span class="st">"RJDBC"</span>,</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>    <span class="st">"dbplyr"</span>,</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>    <span class="st">"arrow"</span>,</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>    <span class="st">"geosphere"</span>,</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>    <span class="st">"viridis"</span>)</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>list_installed_packages <span class="ot">&lt;-</span> <span class="fu">names</span>(<span class="fu">installed.packages</span>()[,<span class="dv">2</span>])</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (Rpack <span class="cf">in</span> list_Rpack2use) {</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span> Rpack <span class="sc">%in%</span> list_installed_packages) {</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"Installing"</span>, Rpack))</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">install.packages</span>(Rpack, <span class="at">repos =</span> cran_repo)</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">paste</span>(Rpack, <span class="st">"already installed."</span>))</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Loading librairies</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>list_Rpack2load_not <span class="ot">&lt;-</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"conflicted"</span>,</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"devtools"</span>,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"paws"</span>,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"RAthena"</span>,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"botor"</span>,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"arrow"</span>,</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"RPostgres"</span>,</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"DBI"</span>,</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"RJDBC"</span>,</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"dbplyr"</span>,</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"aws.s3"</span>,</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"arrow"</span>,</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"reticulate"</span>,</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"slider"</span>,</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"stringi"</span>,</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"geosphere"</span>,</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"blah"</span>)</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>list_Rpack2load <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(list_Rpack2use, list_Rpack2load_not)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>list_Rpack2load</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "rmarkdown" "knitr"     "quarto"    "bookdown"  "DT"        "Hmisc"    
 [7] "tidyverse" "magrittr"  "lubridate" "hms"       "glue"      "skimr"    
[13] "lobstr"    "janitor"   "zeallot"   "lemon"     "crayon"    "jsonlite" 
[19] "tsibble"   "fable"     "feasts"    "imputeTS"  "readxl"    "viridis"  </code></pre>
</div>
</div>
<p>Resolving function name conflicts</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (Rpack <span class="cf">in</span> list_Rpack2load) {</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(Rpack, <span class="at">character.only =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(pillar<span class="sc">::</span>dim_desc)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(magrittr<span class="sc">::</span>extract)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(dplyr<span class="sc">::</span>filter)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(jsonlite<span class="sc">::</span>flatten)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(hms<span class="sc">::</span>hms)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(dbplyr<span class="sc">::</span>ident)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(lubridate<span class="sc">::</span>interval)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(dplyr<span class="sc">::</span>lag)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(readxl<span class="sc">::</span>read_xlsx)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(magrittr<span class="sc">::</span>set_names)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(dbplyr<span class="sc">::</span>sql)</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(Hmisc<span class="sc">::</span>src)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(dplyr<span class="sc">::</span>summarize)</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(magrittr<span class="sc">::</span>is_in)</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="co">#To pass if interactive</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="co">#rendering &lt;- TRUE</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="co">#time_all &lt;- proc.time()</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"./scripts_gal/misc_funs.R"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="time-series-overview" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Time series overview</h1>
<section id="what-is-a-time-series" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="what-is-a-time-series"><span class="header-section-number">2.1</span> What is a time series?</h2>
<p>A <strong>time series</strong> is a sequence of data points recorded over time at <strong>equally spaced intervals</strong> (e.g., daily sales, monthly demand, yearly GDP).<br>
It captures the <strong>temporal dynamics</strong> of a process and is central to <strong>forecasting</strong> in supply chains, finance, weather, and many other fields.</p>
</section>
<section id="key-components" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="key-components"><span class="header-section-number">2.2</span> Key components</h2>
<ol type="1">
<li><strong>Trend (T)</strong>
<ul>
<li>The <strong>long-term</strong> progression of the series (upward, downward, or stable).<br>
</li>
<li>Reflects overall growth, decline, or stagnation.<br>
</li>
<li><em>Example:</em> gradual increase in online sales over years.</li>
</ul></li>
<li><strong>Seasonality (S)</strong>
<ul>
<li><em>Regular, repeating patterns at fixed periods</em> (daily, weekly, monthly, yearly).<br>
</li>
<li><em>Example:</em> ice cream sales peaking every summer.</li>
</ul></li>
<li><strong>Cyclic component (C)</strong>
<ul>
<li>Long-term oscillations around the trend, often tied to <em>economic/business</em> cycles.<br>
</li>
<li>Unlike seasonality, cycles are <strong>irregular</strong> in <strong>length and amplitude</strong>.<br>
</li>
<li><em>Example:</em> economic boom and recession cycles.</li>
</ul></li>
<li><strong>Irregular / Random (I)</strong>
<ul>
<li>Unpredictable, residual variations after accounting for trend, seasonality, and cycles.<br>
</li>
<li><em>Example:</em> sudden demand spikes due to supply chain disruptions.</li>
</ul></li>
</ol>
</section>
<section id="models-of-time-series" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="models-of-time-series"><span class="header-section-number">2.3</span> Models of time series</h2>
<ul>
<li><p><strong>Additive model:</strong><br>
<span class="math display">\[
Y_t = T_t + S_t + C_t + I_t
\]</span><br>
Suitable when <strong>seasonal variations</strong> remain <strong>constant in magnitude</strong>.</p></li>
<li><p><strong>Multiplicative model:</strong><br>
<span class="math display">\[
Y_t = T_t \times S_t \times C_t \times I_t
\]</span><br>
Suitable when <strong>seasonal variations</strong> change <strong>proportionally</strong> with the level of the series.</p></li>
</ul>
</section>
<section id="applications-in-supply-chain" class="level2" data-number="2.4">
<h2 data-number="2.4" class="anchored" data-anchor-id="applications-in-supply-chain"><span class="header-section-number">2.4</span> Applications in supply chain</h2>
<ul>
<li><strong>Demand forecasting</strong> → anticipating future <em>product demand</em>.<br>
</li>
<li><strong>Inventory control</strong> → optimizing <em>stock</em> based on demand variability.<br>
</li>
<li><strong>Capacity planning</strong> → adjusting <em>workforce</em> or <em>production</em> to meet seasonal/cyclic needs.</li>
</ul>
</section>
</section>
<section id="generating-a-ts-components" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Generating a TS components</h1>
<p>A TS has some <strong>deterministic</strong> components (the “signal”) and some <strong>random</strong> component (the “noise”).<br>
</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Usually we want to <strong>extract the signal</strong>, and <strong>model the noise</strong>.<br>
</p>
</div>
</div>
<p>Here, since we are generating a TS, we start with some signal and then add the noise.<br>
</p>
<section id="deterministic-component" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="deterministic-component"><span class="header-section-number">3.1</span> Deterministic component</h2>
<p>When building or simulating a time series, it is useful to separate <strong>deterministic components</strong> (signal) from <strong>stochastic components</strong> (noise).</p>
<p>The deterministic part can include:</p>
<ul>
<li><strong>Trend</strong> — a systematic long-term increase or decrease in the series.</li>
<li><strong>Seasonality</strong> — <em>recurring fluctuations</em> tied to the calendar (daily, weekly, yearly, etc.).</li>
<li>Other <strong>structural components</strong> — for example, cycles linked to macroeconomic factors.</li>
</ul>
<section id="trend-component" class="level3" data-number="3.1.1">
<h3 data-number="3.1.1" class="anchored" data-anchor-id="trend-component"><span class="header-section-number">3.1.1</span> Trend component</h3>
<p>We start simple with a linear trend. We’ll be optimistic and assume we have a steady trend of <span class="math inline">\(\alpha= 0.5\)</span> per year starting from a number of units (say thousands of items) of <span class="math inline">\(y_0 = 5\)</span>.</p>
<section id="linear-trend" class="level4" data-number="3.1.1.1">
<h4 data-number="3.1.1.1" class="anchored" data-anchor-id="linear-trend"><span class="header-section-number">3.1.1.1</span> Linear trend</h4>
<p><span class="math display">\[
tr(t) = y_0 + \alpha*\frac{t}{365}
\]</span></p>
</section>
<section id="exponential-trend" class="level4" data-number="3.1.1.2">
<h4 data-number="3.1.1.2" class="anchored" data-anchor-id="exponential-trend"><span class="header-section-number">3.1.1.2</span> Exponential trend</h4>
<p>If instead of a linear trend we assume a <strong>constant proportional daily growth rate (<span class="math inline">\(1 + \beta_d\)</span>)</strong>, then the trend is exponential.</p>
<p>After <strong>one day</strong>, the demand’s trend would be <span class="math inline">\(y_0*(1 + \beta_d)\)</span>, and after <span class="math inline">\(t\)</span> days, the demand’s trend would be <span class="math inline">\(y_0*(1 + \beta_d)^t\)</span>.</p>
<p>The daily growth rate can be derived from the yearly one:</p>
<p><span class="math display">\[
1 + \beta_d = 1 + \frac{\beta_y}{365} \approx e^{\frac{\beta_y}{365}}
\]</span></p>
<p>Consequently:</p>
<p><span class="math display">\[
tr(t) = y_0*(1 + \beta_d)^t \approx y_0*(e^{\frac{\beta_y}{365}})^t
\]</span> For <span class="math inline">\(\beta_y = 0.1\)</span>:</p>
<p><span class="math display">\[
tr(t) = y_0 * (e^{\frac{0.1}{365}})^t
\]</span></p>
</section>
</section>
<section id="seasonality-component" class="level3" data-number="3.1.2">
<h3 data-number="3.1.2" class="anchored" data-anchor-id="seasonality-component"><span class="header-section-number">3.1.2</span> Seasonality component</h3>
<p>Seasonality captures <strong>repeated, systematic fluctuations</strong> that recur with a fixed period.<br>
</p>
<ul>
<li><p>Example: retail sales increase every December (yearly seasonality).<br>
</p></li>
<li><p>In our toy model, we assume <strong>only one yearly seasonal effect</strong>.<br>
</p></li>
<li><p>Later, this framework can be extended to <strong>multiple overlapping seasonalities</strong> (e.g., weekly + yearly).</p></li>
</ul>
<p>Here, we start with only one yearly seasonality <strong><span class="math inline">\(s(t)\)</span></strong> (with yearly period).</p>
<p>We smooth the raw seasonal pattern and normalize it so that it has mean zero, ensuring the trend drives the long-run growth.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>trend_y <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"># yearly trend</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>start_ts <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># starting value of the series</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>sea_0 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">10</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co"># sea_0 contains a seasonal adjustment for each month. </span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co"># These values represent typical deviations from the trend for each month.</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>df_sea <span class="ot">&lt;-</span> </span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">day =</span> <span class="fu">seq</span>(<span class="fu">as_date</span>(<span class="st">"2022-12-28"</span>), <span class="fu">today</span>() <span class="sc">+</span> <span class="fu">days</span>(<span class="dv">3</span>), <span class="at">by =</span> <span class="st">"day"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generates a daily sequence of dates</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mon =</span> <span class="fu">month</span>(day),</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">sea =</span> <span class="fu">map2_dbl</span>(mon, day, <span class="sc">~</span> <span class="fu">if_else</span>((<span class="fu">str_split</span>(.y, <span class="at">pattern =</span> <span class="st">"-"</span>) <span class="sc">%&gt;%</span> <span class="fu">extract2</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> <span class="fu">extract</span>(<span class="dv">3</span>) <span class="sc">%&gt;%</span> as.numeric) <span class="sc">==</span> <span class="dv">15</span>, sea_0[.x], <span class="cn">NA</span>)),</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Map monthly seasonal values to the middle of each month</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>         <span class="co"># This creates monthly anchor points for the seasonal component.</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>         <span class="at">sea =</span> <span class="fu">na_interpolation</span>(sea, <span class="at">option =</span> <span class="st">"spline"</span>),</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Interpolate missing seasonal values</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Fills in the NA values using spline interpolation, creating a smooth seasonal curve.</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>         <span class="at">sea =</span> zoo<span class="sc">::</span><span class="fu">rollmean</span>(sea, <span class="at">k =</span> <span class="dv">7</span>, <span class="at">fill =</span> <span class="cn">TRUE</span>),</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Smooth the seasonal curve further</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Applies a 7-day rolling mean to smooth short-term fluctuations.</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>         <span class="at">sea =</span> sea <span class="sc">-</span> <span class="fu">mean</span>(sea)) <span class="sc">%&gt;%</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Center the seasonal component around zero</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(day <span class="sc">&gt;=</span> <span class="st">"2023-01-01"</span>,</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>         day <span class="sc">&lt;=</span> <span class="fu">today</span>())</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&gt;%</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> sea)) <span class="sc">+</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"#00BFC4"</span>, <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Seasonality component"</span>,</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Value"</span>, <span class="at">x =</span> <span class="st">"Day"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/seasonality_def_plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="additive-model" class="level3" data-number="3.1.3">
<h3 data-number="3.1.3" class="anchored" data-anchor-id="additive-model"><span class="header-section-number">3.1.3</span> Additive model</h3>
<p>Let’s focus on one item and write <span class="math inline">\(y_t\)</span> for counts of orders for this item, and assume we have daily counts since <strong>January 1st, 2023</strong>, with no missing data.</p>
<p>We can put together the <strong>trend</strong> and the <strong>seasonality</strong> in an <strong>additive</strong> way to get the time series’ deterministic component:</p>
<p><span class="math display">\[
y_t^{\text{(d)}} = tr(t) + S(t)
\]</span></p>
<ul>
<li>With the linear trend<br>
</li>
</ul>
<p><span class="math display">\[
tr(t) = y_0 + \alpha*\frac{t}{365}
\]</span></p>
<p><span class="math display">\[
S(t) = s(t)
\]</span></p>
<p><span class="math display">\[
y_t^{\text{(d)}} = y_0 + \alpha*\frac{t}{365} + s(t)
\]</span></p>
<ul>
<li>With the exponential trend<br>
</li>
</ul>
<p>It would also make sense to <strong>multiply the seasonality by the growth rate</strong>. So, after <span class="math inline">\(t\)</span> days, the deterministic component would be:</p>
<p><span class="math display">\[
tr(t) = y_0*(e^{\frac{\beta_y}{365}})^t
\]</span></p>
<p><span class="math display">\[
S(t) = s(t)*(e^{\frac{\beta_y}{365}})^t
\]</span></p>
<p><span class="math display">\[
y_t^{\text{(d)}} = (y_0 + s(t))*(e^{\frac{\beta_y}{365}})^t
\]</span></p>
<p>For <span class="math inline">\(\beta_y = 0.1\)</span>:</p>
<p><span class="math display">\[
y_t^{\text{(d)}} = (y_0 + s(t))*(e^{\frac{0.1}{365}})^t
\]</span></p>
<section id="plotting-the-deterministic-component" class="level4" data-number="3.1.3.1">
<h4 data-number="3.1.3.1" class="anchored" data-anchor-id="plotting-the-deterministic-component"><span class="header-section-number">3.1.3.1</span> Plotting the deterministic component</h4>
<p>Here we can visualize how the trend and seasonality combine over time to form the deterministic part of the time series.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&lt;&gt;%</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tr_lin =</span> start_ts <span class="sc">+</span> trend_y <span class="sc">*</span> <span class="fu">row_number</span>() <span class="sc">/</span> <span class="dv">365</span>,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">tr_exp =</span> start_ts <span class="sc">*</span> <span class="fu">exp</span>(<span class="fl">0.1</span> <span class="sc">/</span> <span class="dv">365</span>)<span class="sc">^</span><span class="fu">row_number</span>(),</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">yd_lin =</span> tr_lin <span class="sc">+</span> sea,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">yd_exp =</span> (start_ts <span class="sc">+</span> sea) <span class="sc">*</span> <span class="fu">exp</span>(<span class="fl">0.1</span> <span class="sc">/</span> <span class="dv">365</span>)<span class="sc">^</span><span class="fu">row_number</span>())</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&gt;%</span> </span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(tr_lin, tr_exp, yd_lin, yd_exp), </span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">"func"</span>, <span class="st">"method"</span>), </span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_sep =</span> <span class="st">"_"</span>, </span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">func =</span> <span class="fu">factor</span>(func, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"yd"</span>, <span class="st">"tr"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> method,</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>                  <span class="at">linetype =</span> func), <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Additive Deterministic Component"</span>,</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Value"</span>, <span class="at">x =</span> <span class="st">"Date"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/deterministic_comp-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="multiplicative-model" class="level3" data-number="3.1.4">
<h3 data-number="3.1.4" class="anchored" data-anchor-id="multiplicative-model"><span class="header-section-number">3.1.4</span> Multiplicative model</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Multiplicative deterministic component</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&lt;&gt;%</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Linear trend (for comparison)</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">tr_lin =</span> start_ts <span class="sc">+</span> trend_y <span class="sc">*</span> <span class="fu">row_number</span>() <span class="sc">/</span> <span class="dv">365</span>,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Exponential trend</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">tr_exp =</span> start_ts <span class="sc">*</span> <span class="fu">exp</span>(<span class="fl">0.1</span> <span class="sc">/</span> <span class="dv">365</span>)<span class="sc">^</span><span class="fu">row_number</span>(),</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Multiplicative seasonal component</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">yd_lin_mul =</span> tr_lin <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> sea),        <span class="co"># linear trend * (1 + seasonality)</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">yd_exp_mul =</span> tr_exp <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> sea)         <span class="co"># exponential trend * (1 + seasonality)</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Reshape for plotting</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&gt;%</span> </span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(tr_lin, tr_exp, yd_lin_mul, yd_exp_mul), </span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">"func"</span>, <span class="st">"method"</span>), </span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_sep =</span> <span class="st">"_"</span>, </span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"value"</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">func =</span> <span class="fu">factor</span>(func, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"yd"</span>, <span class="st">"tr"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> method, <span class="at">linetype =</span> func), <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Multiplicative Deterministic Component"</span>,</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Value"</span>, <span class="at">x =</span> <span class="st">"Date"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/multiplicative_deterministic_comp-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="random-component" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="random-component"><span class="header-section-number">3.2</span> Random component</h2>
<p>So far, we have modeled only the signal. But in reality, time series always contain noise, capturing <strong>unpredictable factors</strong> such as weather, strikes, promotions, or random shocks.</p>
<section id="gaussain-noise" class="level3" data-number="3.2.1">
<h3 data-number="3.2.1" class="anchored" data-anchor-id="gaussain-noise"><span class="header-section-number">3.2.1</span> Gaussain noise</h3>
<p>A simple first assumption is <strong>additive Gaussian noise</strong> with zero mean (<span class="math inline">\(\mu = 0\)</span>) and variance <span class="math inline">\(\sigma^2\)</span>.</p>
<div style="text-align: center;">
<p><img src="/images/normal_distribution_pdf.png" alt="Poisson Distribution" width="75%"></p>
</div>
<p><strong>Distribution:</strong></p>
<p><span class="math display">\[
\epsilon_t \sim \mathcal{N}(0, \sigma^2)
\]</span></p>
<p><span class="math display">\[
f(x) = \frac{1}{\sqrt{2\pi\sigma^2}} \, \exp\left(-\frac{x^2}{2\sigma^2}\right)
\]</span></p>
<p><strong>Parameters:</strong> <span class="math inline">\(\mu = 0\)</span>, <span class="math inline">\(\sigma^2\)</span></p>
<p><strong>Mean:</strong> <span class="math inline">\(\mu = 0\)</span></p>
<p><strong>Variance:</strong> <span class="math inline">\(\sigma^2\)</span></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>sig_1 <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">102938</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&lt;&gt;%</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">noi =</span> <span class="fu">rnorm</span>(<span class="fu">nrow</span>(df_sea), <span class="dv">0</span>, sig_1),</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_lin =</span> yd_lin <span class="sc">+</span> noi,</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_exp =</span> (start_ts <span class="sc">+</span> sea <span class="sc">+</span> noi) <span class="sc">*</span> <span class="fu">exp</span>(<span class="fl">0.1</span> <span class="sc">/</span> <span class="dv">365</span>)<span class="sc">^</span><span class="fu">row_number</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s start simple and assume we have additive Gaussian noise with mean zero and variance <span class="math inline">\(\sigma ^2 = 1\)</span>.<br>
Now we have the complete additive time series:</p>
<p>And the complete multiplicative time series:</p>
<p><span class="math display">\[
y(t) = tr(t) + S_t + \epsilon
\]</span></p>
<p>And the complete multiplicative time series:</p>
<p><span class="math display">\[
y(t) = (tr(t) + S_t + \epsilon) * exp(\beta_d * t)
\]</span></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&gt;%</span> </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(tr_lin, tr_exp, y_lin, y_exp), </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">"func"</span>, <span class="st">"method"</span>), </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_sep =</span> <span class="st">"_"</span>, </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">func =</span> <span class="fu">factor</span>(func, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"y"</span>, <span class="st">"tr"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> method,</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>                  <span class="at">linetype =</span> func),</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Additive Gaussian Noise"</span>,</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Value"</span>, <span class="at">x =</span> <span class="st">"Date"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/noisy_ts_plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We see here some negative values. That’s not consistent with counts. Counts are never negative. This means that our model is not quite right. We used Gaussian noise. But <strong>Gaussian noise is unlimited in the positive as well as in the negative</strong>. What other noise distribution can we use?</p>
<p>Since demand is count-based, a more natural choice is a discrete distribution.</p>
</section>
<section id="poisson-noise" class="level3" data-number="3.2.2">
<h3 data-number="3.2.2" class="anchored" data-anchor-id="poisson-noise"><span class="header-section-number">3.2.2</span> Poisson Noise</h3>
<p>Suitable when <strong>variance ≈ mean</strong>.<br>
It is simple and widely used for <strong>rare-event counts</strong>.</p>
<div style="text-align: center;">
<p><img src="/images/poisson_distribution_PMF.png" alt="Poisson Distribution" width="75%"></p>
</div>
<p><strong>Distribution:</strong></p>
<p><span class="math display">\[
\epsilon_t \sim \mathcal{Poisson}(\lambda)
\]</span> <span class="math display">\[
P(X = k) = \frac{\lambda^k e^{-\lambda}}{k!}, \quad k = 0, 1, 2, \ldots
\]</span></p>
<p><strong>Parameters:</strong> <span class="math inline">\(\lambda\)</span></p>
<p><strong>Mean:</strong> <span class="math inline">\(\lambda\)</span></p>
<p><strong>Variance:</strong> <span class="math inline">\(\lambda\)</span></p>
<p><strong>Notes:</strong><br>
Common in modeling <strong>count data</strong> and <strong>discrete random events</strong> (e.g., photon counts, arrivals, or defect occurrences).</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">102938</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">&lt;-</span> <span class="dv">2</span>  <span class="co"># mean noise level</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&lt;&gt;%</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">noi_pois =</span> <span class="fu">rpois</span>(<span class="fu">nrow</span>(df_sea), lambda),</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_lin_pois =</span> yd_lin <span class="sc">+</span> noi_pois,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_exp_pois =</span> (start_ts <span class="sc">+</span> sea <span class="sc">+</span> noi_pois) <span class="sc">*</span> <span class="fu">exp</span>(<span class="fl">0.1</span> <span class="sc">/</span> <span class="dv">365</span>)<span class="sc">^</span><span class="fu">row_number</span>())</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&gt;%</span> </span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(tr_lin, tr_exp, y_lin_pois, y_exp_pois), </span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">"func"</span>, <span class="st">"method"</span>), </span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_sep =</span> <span class="st">"_"</span>, </span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">func =</span> <span class="fu">factor</span>(func, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"y"</span>, <span class="st">"tr"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> method,</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>                  <span class="at">linetype =</span> func),</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Additive Poisson Noise"</span>,</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Value"</span>, <span class="at">x =</span> <span class="st">"Date"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/noisy_ts_poisson_plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="negative-binomial-noise" class="level3" data-number="3.2.3">
<h3 data-number="3.2.3" class="anchored" data-anchor-id="negative-binomial-noise"><span class="header-section-number">3.2.3</span> Negative Binomial noise</h3>
<p>When the <strong>variance of counts is larger than the mean</strong>, the Poisson assumption is too restrictive. The Negative Binomial distribution <strong>generalizes the Poisson</strong> by introducing an <strong>overdispersion parameter r</strong>.</p>
<div style="text-align: center;">
<p><img src="/images/negative_binomial.png" alt="Negative-Binomial Distribution" width="100%"></p>
</div>
<p><strong>Distribution:</strong></p>
<p><span class="math display">\[
\epsilon_t \sim NB(r, p)
\]</span> <span class="math display">\[
P(X = k) = \binom{k + r - 1}{k} (1 - p)^r p^k, \quad k = 0, 1, 2, \ldots
\]</span></p>
<p><strong>Parameters:</strong><br>
- <span class="math inline">\(r &gt; 0\)</span> is the number of successes,<br>
- <span class="math inline">\(p \in (0,1)\)</span> is the probability of failure (per trial),<br>
- <span class="math inline">\(k\)</span> is the number of failures before achieving <span class="math inline">\(r\)</span> successes.</p>
<p><strong>Mean:</strong> <span class="math inline">\(\mu = r\frac{1-p}{p}\)</span>&nbsp;</p>
<p><strong>Variance:</strong> <span class="math inline">\(\mu + \frac{\mu^2}{r}\)</span>, which is <strong>larger than the mean</strong> when r is finite.</p>
<p>This makes it much more flexible than the Poisson for real-world data.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">102938</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>size <span class="ot">&lt;-</span> <span class="dv">5</span>    <span class="co"># dispersion parameter (higher = closer to Poisson)</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>mu   <span class="ot">&lt;-</span> <span class="dv">2</span>    <span class="co"># mean of noise</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&lt;&gt;%</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">noi_nb =</span> <span class="fu">rnbinom</span>(<span class="fu">nrow</span>(df_sea), <span class="at">size =</span> size, <span class="at">mu =</span> mu),</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_lin_nb =</span> yd_lin <span class="sc">+</span> noi_nb,</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_exp_nb =</span> (start_ts <span class="sc">+</span> sea <span class="sc">+</span> noi_nb) <span class="sc">*</span> <span class="fu">exp</span>(<span class="fl">0.1</span> <span class="sc">/</span> <span class="dv">365</span>)<span class="sc">^</span><span class="fu">row_number</span>())</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&gt;%</span> </span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(tr_lin, tr_exp, y_lin_nb, y_exp_nb), </span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">"func"</span>, <span class="st">"method"</span>), </span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_sep =</span> <span class="st">"_"</span>, </span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">func =</span> <span class="fu">factor</span>(func, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"y"</span>, <span class="st">"tr"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> method,</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>                  <span class="at">linetype =</span> func),</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Additive Negative Binomial Noise"</span>,</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Value"</span>, <span class="at">x =</span> <span class="st">"Date"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/noisy_ts_negbin_plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="gamma-noise" class="level3" data-number="3.2.4">
<h3 data-number="3.2.4" class="anchored" data-anchor-id="gamma-noise"><span class="header-section-number">3.2.4</span> Gamma noise</h3>
<p>Gamma and Log-Normal are popular for modeling <strong>positive continuous noise</strong>—especially when counts or demand cannot be negative and may have <strong>skewness</strong>.</p>
<div style="text-align: center;">
<p><img src="/images/gamma_distribution_pdf.png" alt="Gamma Distribution" width="75%"></p>
</div>
<p><strong>Distribution:</strong></p>
<p><span class="math display">\[
f(x; k, \theta) =
\frac{1}{\Gamma(k)\,\theta^{k}}\,x^{k - 1} e^{-x / \theta},
\quad x &gt; 0
\]</span></p>
<p><strong>Parameters:</strong> <strong>shape</strong> <span class="math inline">\(k\)</span>, <strong>scale</strong> <span class="math inline">\(\theta\)</span>, and <span class="math inline">\(\Gamma(k)\)</span> is the Gamma function defined as</p>
<p><span class="math display">\[
\Gamma(k) = \int_0^\infty t^{k - 1} e^{-t} dt
\]</span></p>
<p><strong>Mean:</strong><br>
<span class="math inline">\(kθ\)</span></p>
<p><strong>Variance:</strong><br>
<span class="math inline">\(kθ^2\)</span></p>
<p><strong>Notes:</strong><br>
Often used for modeling <strong>waiting times</strong> or <strong>non-negative skewed demand</strong>.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">102938</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>shape_gamma <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>scale_gamma <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&lt;&gt;%</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">noi_gamma =</span> <span class="fu">rgamma</span>(<span class="fu">nrow</span>(df_sea), <span class="at">shape =</span> shape_gamma, <span class="at">scale =</span> scale_gamma),</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_lin_gamma =</span> yd_lin <span class="sc">+</span> noi_gamma,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_exp_gamma =</span> (start_ts <span class="sc">+</span> sea <span class="sc">+</span> noi_gamma) <span class="sc">*</span> <span class="fu">exp</span>(<span class="fl">0.1</span> <span class="sc">/</span> <span class="dv">365</span>)<span class="sc">^</span><span class="fu">row_number</span>())</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&gt;%</span> </span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(tr_lin, tr_exp, y_lin_gamma, y_exp_gamma), </span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">"func"</span>, <span class="st">"method"</span>), </span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_sep =</span> <span class="st">"_"</span>, </span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">func =</span> <span class="fu">factor</span>(func, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"y"</span>, <span class="st">"tr"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> method,</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>                  <span class="at">linetype =</span> func),</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Additive Gamma Noise"</span>,</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Value"</span>, <span class="at">x =</span> <span class="st">"Date"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/noisy_ts_gamma_plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="log-normal-noise" class="level3" data-number="3.2.5">
<h3 data-number="3.2.5" class="anchored" data-anchor-id="log-normal-noise"><span class="header-section-number">3.2.5</span> Log-Normal noise</h3>
<p>A <strong>strictly positive</strong>, <strong>skewed</strong> distribution.</p>
<div style="text-align: center;">
<p><img src="/images/log_normal_distribution.png" alt="Log-normal Distribution" width="75%"></p>
</div>
<p><strong>Distribution:</strong></p>
<p><span class="math display">\[
f(x; \mu, \sigma) =
\frac{1}{x\,\sigma\,\sqrt{2\pi}}
\exp\left( -\frac{(\ln x - \mu)^2}{2\sigma^2} \right),
\quad x &gt; 0
\]</span></p>
<p><strong>Parameters:</strong> log-mean <span class="math inline">\(\mu\)</span>, log-standard deviation <span class="math inline">\(\sigma\)</span></p>
<p><strong>Mean:</strong><br>
<span class="math display">\[
\ E(X) = exp(\mu + \sigma^2 / 2)
\]</span></p>
<p><strong>Variance:</strong><br>
<span class="math display">\[
Var(X) = (\exp(\sigma^2) - 1) \exp(2\mu + \sigma^2)
\]</span></p>
<p><strong>Notes:</strong><br>
Often used when noise <strong>multiplicatively affects the signal</strong>.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">102938</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>mu_lognorm <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>sigma_lognorm <span class="ot">&lt;-</span> <span class="fl">0.3</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&lt;&gt;%</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">noi_lognorm =</span> <span class="fu">rlnorm</span>(<span class="fu">nrow</span>(df_sea), <span class="at">meanlog =</span> mu_lognorm, <span class="at">sdlog =</span> sigma_lognorm),</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_lin_lognorm =</span> yd_lin <span class="sc">+</span> noi_lognorm,</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_exp_lognorm =</span> (start_ts <span class="sc">+</span> sea <span class="sc">+</span> noi_lognorm) <span class="sc">*</span> <span class="fu">exp</span>(<span class="fl">0.1</span> <span class="sc">/</span> <span class="dv">365</span>)<span class="sc">^</span><span class="fu">row_number</span>())</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&gt;%</span> </span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(tr_lin, tr_exp, y_lin_lognorm, y_exp_lognorm), </span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">"func"</span>, <span class="st">"method"</span>), </span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_sep =</span> <span class="st">"_"</span>, </span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">func =</span> <span class="fu">factor</span>(func, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"y"</span>, <span class="st">"tr"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> method,</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>                  <span class="at">linetype =</span> func),</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Additive Log-Normal Noise"</span>,</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Value"</span>, <span class="at">x =</span> <span class="st">"Date"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/noisy_ts_lognorm_plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="ts-noise-modelling" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> TS noise modelling</h1>
<section id="review-of-the-additive-model" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="review-of-the-additive-model"><span class="header-section-number">4.1</span> Review of the additive model</h2>
<p>We re-use the synthetic data from last week, which follows an <strong>additive decomposition</strong> of the form:</p>
<p><span class="math display">\[
y(t) = tr(t) + s(t) + \epsilon_t
\]</span></p>
<section id="load-the-data" class="level3" data-number="4.1.1">
<h3 data-number="4.1.1" class="anchored" data-anchor-id="load-the-data"><span class="header-section-number">4.1.1</span> Load the data</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>data_dir <span class="ot">&lt;-</span> <span class="st">"./data"</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>fpath_df_ts1 <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{data_dir}/synthetic_TS_01.tsv"</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="ot">&lt;-</span> </span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_tsv</span>(fpath_df_ts1) <span class="sc">%&gt;%</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(day, mon, sea, tr_lin, yd_lin, noi, y_lin) <span class="sc">%&gt;%</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">tr =</span> tr_lin, <span class="at">yd =</span> yd_lin, <span class="at">y =</span> y_lin) <span class="sc">%&gt;%</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">year</span>(day)) <span class="sc">%&gt;%</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(year)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="trend-component-1" class="level3" data-number="4.1.2">
<h3 data-number="4.1.2" class="anchored" data-anchor-id="trend-component-1"><span class="header-section-number">4.1.2</span> Trend component</h3>
<p>The trend is modeled as a linear function of time:</p>
<p><span class="math display">\[
tr(t) = y_0 + \alpha.\frac{t}{365}
\]</span> We can recover the parameters <span class="math inline">\(y_0\)</span> (intercept) and <span class="math inline">\(\alpha\)</span> (slope) as follows:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>y0_o   <span class="ot">&lt;-</span> df_ts1<span class="sc">$</span>tr[<span class="dv">1</span>] <span class="sc">%&gt;%</span> round</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>alfa_o <span class="ot">&lt;-</span> df_ts1<span class="sc">$</span>tr[<span class="dv">366</span>] <span class="sc">-</span> df_ts1<span class="sc">$</span>tr[<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Hence<br>
- <span class="math inline">\(y_0 =\)</span> 5.<br>
- <span class="math inline">\(\alpha =\)</span> 0.5</p>
</section>
<section id="seasonal-component" class="level3" data-number="4.1.3">
<h3 data-number="4.1.3" class="anchored" data-anchor-id="seasonal-component"><span class="header-section-number">4.1.3</span> Seasonal component</h3>
<p>The seasonality is defined by a smooth repeating curve, shown below for the first year:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">==</span> <span class="fu">min</span>(<span class="fu">as.numeric</span>(<span class="fu">as.character</span>(year)))) <span class="sc">%&gt;%</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> sea)) <span class="sc">+</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Seasonal Component (First Year)"</span>,</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Day"</span>, <span class="at">y =</span> <span class="st">"Seasonal Effect"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/plot-sea-actual-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="original-time-series" class="level3" data-number="4.1.4">
<h3 data-number="4.1.4" class="anchored" data-anchor-id="original-time-series"><span class="header-section-number">4.1.4</span> Original time series</h3>
<p>The full modeled series, including the original Gaussian noise, is shown below:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span> </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day)) <span class="sc">+</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> y), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> yd), <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Synthetic Time Series with Gaussian Noise"</span>,</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Day"</span>, <span class="at">y =</span> <span class="st">"Value"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/plot-df-ts1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Note that normal noise may be inappropriate for <em>count-type data</em>, since it can generate negative forecasts—an issue that motivates the following noise models.</p>
</section>
</section>
<section id="noise-with-constant-rate" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="noise-with-constant-rate"><span class="header-section-number">4.2</span> Noise with constant rate</h2>
<p>Let the noise follow a Poisson distribution with constant rate <span class="math inline">\(\lambda_0 = 2\)</span></p>
<p>Because the Poisson mean equals its variance, we re-center the generated noise to preserve a mean of zero and avoid negative forecasts.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2831</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>lam_0 <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">noi_cnst =</span> <span class="fu">rpois</span>(<span class="at">n =</span> <span class="fu">nrow</span>(.), <span class="at">lambda =</span> lam_0) <span class="sc">-</span> <span class="fu">min</span>(<span class="fu">c</span>(lam_0, <span class="fu">min</span>(yd))),</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_1 =</span> yd <span class="sc">+</span> noi_cnst)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">|&gt;</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day)) <span class="sc">+</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> y_1), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> yd), <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Time Series with Constant-Rate Poisson Noise"</span>,</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Day"</span>, <span class="at">y =</span> <span class="st">"Value"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/generate-constant-pois-noise-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="noise-with-proportional-rate" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="noise-with-proportional-rate"><span class="header-section-number">4.3</span> Noise with proportional rate</h2>
<p>In many real-world processes, <strong>noise magnitude increases with the signal level</strong>. This can be the case for sales, demand, or production volumes, where fluctuations scale with the size of operations.</p>
<p>For example:<br>
If one trailer delivery is missed due to a strike when demand is low, a tenfold demand would imply a missed delivery of ten trailers — illustrating proportional noise.</p>
<section id="additive-interpretation" class="level3" data-number="4.3.1">
<h3 data-number="4.3.1" class="anchored" data-anchor-id="additive-interpretation"><span class="header-section-number">4.3.1</span> Additive interpretation</h3>
<p>We can still express the model additively as:</p>
<p><span class="math display">\[
y(t) = tr(t) + s(t) + \epsilon_t
\]</span></p>
<p>where</p>
<p><span class="math display">\[
\epsilon_t \sim \mathrm{Pois}(\lambda_t), \quad \lambda_t \propto y_t^{\text{(d)}} = tr(t) + s(t)
\]</span></p>
</section>
<section id="multiplicative-equivalence" class="level3" data-number="4.3.2">
<h3 data-number="4.3.2" class="anchored" data-anchor-id="multiplicative-equivalence"><span class="header-section-number">4.3.2</span> Multiplicative equivalence</h3>
<p>This is equivalent to a multiplicative noise model:</p>
<p><span class="math display">\[
y(t) = (tr(t) + s(t)).\eta_t
\]</span> where <span class="math inline">\(\eta_t\)</span> is a Poisson-like random multiplier with constant mean.</p>
</section>
<section id="implementation" class="level3" data-number="4.3.3">
<h3 data-number="4.3.3" class="anchored" data-anchor-id="implementation"><span class="header-section-number">4.3.3</span> Implementation</h3>
<p>We simulate proportional noise with a constant scaling factor <span class="math inline">\(c_\lambda = 0.4\)</span>:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>const_lam <span class="ot">&lt;-</span> <span class="fl">0.4</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123098</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">lam      =</span> const_lam <span class="sc">*</span> yd,</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">noi_prop =</span> <span class="fu">map_dbl</span>(lam, <span class="sc">~</span> <span class="fu">rpois</span>(<span class="dv">1</span>, <span class="at">lambda =</span> .x) <span class="sc">-</span> .x),</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_2      =</span> yd <span class="sc">+</span> noi_prop)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(day, yd, y_1, y_2) <span class="sc">%&gt;%</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(y_1, y_2),</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"method"</span>,</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"TS_value"</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">method =</span> <span class="fu">recode</span>(</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    method,</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">y_1 =</span> <span class="st">"Constant-rate Poisson noise"</span>,</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">y_2 =</span> <span class="st">"Proportional-rate Poisson noise"</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> TS_value)) <span class="sc">+</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> method), <span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> yd), <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> method, <span class="at">ncol =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Constant vs Proportional Poisson Noise"</span>,</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Day"</span>,</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Value"</span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/generate-proportional-pois-noise-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="interpretation" class="level3" data-number="4.3.4">
<h3 data-number="4.3.4" class="anchored" data-anchor-id="interpretation"><span class="header-section-number">4.3.4</span> Interpretation</h3>
<ul>
<li>The constant-rate noise adds fluctuations of fixed variance, independent of the signal.</li>
<li>The proportional-rate noise scales with the signal amplitude, resembling multiplicative variability commonly seen in business and supply-chain processes.</li>
</ul>
</section>
</section>
<section id="analysis" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="analysis"><span class="header-section-number">4.4</span> Analysis</h2>
<section id="visualizing-yearly-seasonality" class="level3" data-number="4.4.1">
<h3 data-number="4.4.1" class="anchored" data-anchor-id="visualizing-yearly-seasonality"><span class="header-section-number">4.4.1</span> Visualizing yearly seasonality</h3>
<p>When we suspect seasonality, such as yearly patterns, it can be insightful to overlay the time series data by year. This allows us to visually compare the dynamics of each year and identify recurring seasonal behaviors.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">year =</span> <span class="fu">factor</span>(<span class="fu">year</span>(day)),</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">date_no_year =</span> day</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(<span class="fu">c</span>(year, date_no_year), <span class="at">.after =</span> day)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="fu">year</span>(df_ts1<span class="sc">$</span>date_no_year) <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date_no_year, <span class="at">y =</span> y_2)) <span class="sc">+</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> year, <span class="at">color =</span> year), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Overlay of Yearly Time Series"</span>,</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Day (within year)"</span>,</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Value"</span>,</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Year"</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/overlay-yearly-ts-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We already observe a recurring yearly pattern, especially toward the end of the year. This suggests a combination of trend and seasonality in the data, which we now aim to analyze more formally.</p>
</section>
<section id="trend-analysis" class="level3" data-number="4.4.2">
<h3 data-number="4.4.2" class="anchored" data-anchor-id="trend-analysis"><span class="header-section-number">4.4.2</span> Trend analysis</h3>
<p>We begin by estimating the trend component, since it represents the longer-term structure of the series.<br>
Seasonality can then be analyzed more effectively once the trend has been accounted for.</p>
<p>We compare different <strong>trend modeling</strong> approaches:</p>
<ul>
<li>Linear Trend: the simplest baseline model.</li>
<li>Nonlinear Trends using flexible smoothers:
<ul>
<li>LOESS (Locally Weighted Scatterplot Smoothing)</li>
<li>GAM (Generalized Additive Model)</li>
</ul></li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>loess_span_high <span class="ot">&lt;-</span> <span class="fl">0.75</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>(<span class="at">data =</span> <span class="sc">-</span>year)  <span class="sc">%&gt;%</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">lm_tr =</span> <span class="fu">map</span>(</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>      year,</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>      <span class="sc">~</span> <span class="fu">lm</span>(y_2 <span class="sc">~</span> day, <span class="at">data =</span> df_ts1  <span class="sc">%&gt;%</span> <span class="fu">filter</span>(year <span class="sc">==</span> .x))</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">loes_tr =</span> <span class="fu">map</span>(</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>      year,</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>      <span class="sc">~</span> <span class="fu">loess</span>(y_2 <span class="sc">~</span> <span class="fu">as.numeric</span>(day),</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>              <span class="at">data =</span> df_ts1  <span class="sc">%&gt;%</span> <span class="fu">filter</span>(year <span class="sc">==</span> .x),</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>              <span class="at">span =</span> loess_span_high)</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">map2</span>(data, lm_tr, <span class="sc">~</span> <span class="fu">mutate</span>(.x, <span class="at">try_lm =</span> .y<span class="sc">$</span>fitted)),</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">map2</span>(data, loes_tr, <span class="sc">~</span> <span class="fu">mutate</span>(.x, <span class="at">try_lo =</span> .y<span class="sc">$</span>fitted))</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>  )  <span class="sc">%&gt;%</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(lm_tr, loes_tr))  <span class="sc">%&gt;%</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(data)</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>df_ts1  <span class="sc">%&gt;%</span></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date_no_year, <span class="at">y =</span> y_2)) <span class="sc">+</span></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> year, <span class="at">color =</span> year), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> try_lm, <span class="at">group =</span> year), <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> try_lo, <span class="at">group =</span> year), <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Yearly Trend Fitting: Linear (Blue) vs LOESS (Red)"</span>,</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Day (within year)"</span>,</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Value"</span>,</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Year"</span></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/fitting-yearly-trend-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Here,</p>
<ul>
<li>Blue lines represent the fitted linear trends, and</li>
<li>Red curves show the LOESS-smoothed trends (with span = 0.75).</li>
</ul>
<p>We see a reasonable degree of consistency across years, though some discrepancies appear in incomplete years (e.g., 2025).<br>
However, analyzing each year independently is not ideal for identifying the overall trend, since the yearly boundaries do not necessarily align smoothly from one year to the next.</p>
<section id="continuous-trend-estimation" class="level4" data-number="4.4.2.1">
<h4 data-number="4.4.2.1" class="anchored" data-anchor-id="continuous-trend-estimation"><span class="header-section-number">4.4.2.1</span> Continuous trend estimation</h4>
<p>To capture a coherent view of the long-term evolution, we re-estimate the trend over the entire time span.</p>
<p>We compare:</p>
<ul>
<li>Linear trend (black)</li>
<li>LOESS smoothing with:
<ul>
<li>Medium span (<code>0.5</code>) — blue curve</li>
<li>Low span (<code>0.1</code>) — red curve</li>
</ul></li>
<li>GAM smoothing (dark green), with automatic smoothing and confidence bands</li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>loess_span_med  <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>loess_span_low <span class="ot">&lt;-</span> <span class="fl">0.1</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>lm_tr <span class="ot">&lt;-</span> <span class="fu">lm</span>(y_2 <span class="sc">~</span> day, <span class="at">data =</span> df_ts1)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>lo_tr_1 <span class="ot">&lt;-</span> <span class="fu">loess</span>(y_2 <span class="sc">~</span> <span class="fu">as.numeric</span>(day),</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> df_ts1,</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>                 <span class="at">span =</span> loess_span_med)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>lo_tr_2 <span class="ot">&lt;-</span> <span class="fu">loess</span>(y_2 <span class="sc">~</span> <span class="fu">as.numeric</span>(day),</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> df_ts1,</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>                 <span class="at">span =</span> loess_span_low)</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">tr_lm   =</span> lm_tr<span class="sc">$</span>fitted,</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">tr_lo_1 =</span> lo_tr_1<span class="sc">$</span>fitted,</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">tr_lo_2 =</span> lo_tr_2<span class="sc">$</span>fitted</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> y_2)) <span class="sc">+</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> year, <span class="at">color =</span> year), <span class="at">alpha =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tr_lm), <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tr_lo_1), <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">linewidth =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tr_lo_2), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"gam"</span>, <span class="at">color =</span> <span class="st">"darkgreen"</span>, <span class="at">linewidth =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Global Trend Estimation with Various Smoothers"</span>,</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Day"</span>,</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Value"</span>,</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Year"</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/plot-overoll-smoothing-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="interpretation-1" class="level4" data-number="4.4.2.2">
<h4 data-number="4.4.2.2" class="anchored" data-anchor-id="interpretation-1"><span class="header-section-number">4.4.2.2</span> Interpretation</h4>
<ul>
<li><p>The linear trend (black) provides a clear, interpretable long-term direction and fits the overall data well.</p></li>
<li><p>The LOESS (low span, red) captures short-term fluctuations, overlapping with the seasonal pattern rather than isolating the true trend.</p></li>
<li><p>The LOESS (medium span, blue) and GAM (dark green) curves strike a balance but tend to capture both slow seasonal and trend components simultaneously.</p></li>
</ul>
<p>Hence, while linear smoothing suffices to characterize the long-term drift, nonlinear smoothers such as LOESS or GAM can help diagnose residual structure — valuable when refining the decomposition into trend, seasonality, and irregular components.</p>
</section>
</section>
<section id="seasonality" class="level3" data-number="4.4.3">
<h3 data-number="4.4.3" class="anchored" data-anchor-id="seasonality"><span class="header-section-number">4.4.3</span> Seasonality</h3>
<p>After identifying the trend, the next step is to investigate seasonality.<br>
To do this, we can overlay the estimated seasonal curves for each year and look for repeating or shifting patterns.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date_no_year, <span class="at">y =</span> y_2)) <span class="sc">+</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> year, <span class="at">color =</span> year), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tr_lo_2, <span class="at">color =</span> year, <span class="at">group =</span> year))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/seasonlity-curve-yoy-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Indeed, there appears to be a <strong>phase shift</strong> across years — that is, the peaks and troughs of the seasonal pattern occur slightly earlier or later depending on the year.</p>
<section id="de-trending-and-centering-seasonality" class="level4" data-number="4.4.3.1">
<h4 data-number="4.4.3.1" class="anchored" data-anchor-id="de-trending-and-centering-seasonality"><span class="header-section-number">4.4.3.1</span> De-trending and centering seasonality</h4>
<p>To analyze seasonality more clearly, we should first remove the trend component so that the seasonal variation is centered around zero.<br>
This can be done by subtracting the estimated trend from the original time series:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y_notr =</span> y_2 <span class="sc">-</span> tr_lm)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>sea_1 <span class="ot">&lt;-</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">loess</span>(df_ts1 <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">day =</span> <span class="fu">as.numeric</span>(day)),</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">formula =</span> y_notr <span class="sc">~</span> day,</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">span =</span> loess_span_low)</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sea_lo =</span> sea_1<span class="sc">$</span>fitted)</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date_no_year, <span class="at">y =</span> y_2)) <span class="sc">+</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> year, <span class="at">color =</span> year), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> sea_lo, <span class="at">color =</span> year, <span class="at">group =</span> year), <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tr_lm, <span class="at">group =</span> year, <span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"black"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/seasonality-minus-trend-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Once the trend is removed, the seasonal pattern becomes much more evident — confirming the phase shift between years.</p>
</section>
</section>
<section id="noise-extraction" class="level3" data-number="4.4.4">
<h3 data-number="4.4.4" class="anchored" data-anchor-id="noise-extraction"><span class="header-section-number">4.4.4</span> Noise extraction</h3>
<p>Having decomposed the time series into trend and seasonality, the remaining residual component represents the noise:</p>
<p><span class="math display">\[
y(t) = tr(t) + s(t) + \epsilon_t
\]</span></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y_noi =</span> y_2 <span class="sc">-</span> tr_lm <span class="sc">-</span> sea_lo)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> y_noi)) <span class="sc">+</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">as_date</span>(<span class="fu">c</span>(<span class="st">"2023-12-31"</span>, <span class="st">"2024-12-31"</span>))) <span class="sc">+</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/remove-trend-season-form-ts-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>noi_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(df_ts1<span class="sc">$</span>y_noi)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>noi_var  <span class="ot">&lt;-</span> <span class="fu">var</span>(df_ts1<span class="sc">$</span>y_noi)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We find the following centered moments for the noise:</p>
<ul>
<li>Mean: 0</li>
<li>Var: 2.76</li>
</ul>
<p>The residuals still exhibit some <strong>heteroscedasticity</strong> — the variance is not constant across time. For instance, spikes tend to occur near the end of each year, suggesting a link with the seasonal component.</p>
<section id="noiseseasonality-interaction" class="level4" data-number="4.4.4.1">
<h4 data-number="4.4.4.1" class="anchored" data-anchor-id="noiseseasonality-interaction"><span class="header-section-number">4.4.4.1</span> Noise–seasonality interaction</h4>
<p>To visualize this interaction, we can overlay the deterministic component (trend + seasonality, shifted to start at zero) onto the noise:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> y_noi)) <span class="sc">+</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tr_lm <span class="sc">+</span> sea_lo <span class="sc">-</span> <span class="fu">min</span>(tr_lm))) <span class="sc">+</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">as_date</span>(<span class="fu">c</span>(<span class="st">"2023-12-31"</span>, <span class="st">"2024-12-31"</span>))) <span class="sc">+</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/plot-noise-overlay-seas-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We observe a clear correlation between the amplitude of the noise and the level of the deterministic component, indicating that the noise may be multiplicative rather than purely additive.</p>
</section>
<section id="noise-distribution" class="level4" data-number="4.4.4.2">
<h4 data-number="4.4.4.2" class="anchored" data-anchor-id="noise-distribution"><span class="header-section-number">4.4.4.2</span> Noise distribution</h4>
<p>For now, we continue under the additive noise assumption.<br>
We visualize the noise distribution and overlay a Poisson density with parameter <span class="math inline">\(\lambda = 2.76\)</span>:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">noi_pois =</span> <span class="fu">dpois</span>(<span class="fu">round</span>(y_noi <span class="sc">+</span> noi_var), <span class="at">lambda =</span> noi_var)) <span class="sc">%&gt;%</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> y_noi <span class="sc">+</span> noi_var)) <span class="sc">+</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), <span class="at">bins =</span> <span class="dv">100</span>) <span class="sc">+</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> noi_pois), <span class="at">color =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/plot-noise-histog-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The histogram reveals deviations from the ideal Poisson shape — consistent with the observed heteroscedasticity — reinforcing the idea that a multiplicative noise model could be a better fit for this time series.</p>
</section>
</section>
<section id="modeling-multiplicative-noise" class="level3" data-number="4.4.5">
<h3 data-number="4.4.5" class="anchored" data-anchor-id="modeling-multiplicative-noise"><span class="header-section-number">4.4.5</span> Modeling multiplicative noise</h3>
<p>The previous analysis indicated that the variance of the residuals (noise) increases with the magnitude of the deterministic component — suggesting that the noise is multiplicative rather than additive.</p>
<p>In an additive noise model, we write:</p>
<p><span class="math display">\[
y(t) = tr(t) + s(t) + \epsilon_t
\]</span></p>
<p>In contrast, a multiplicative noise model assumes:</p>
<p><span class="math display">\[
y(t) = [tr(t) + s(t)]*[1 + \epsilon_t]
\]</span></p>
<p>or equivalently,</p>
<p><span class="math display">\[
\epsilon_t = \frac{y(t) - [tr(t) + s(t)]}{[tr(t) + s(t)]}
\]</span></p>
<p>This formulation implies that the magnitude of the fluctuations (noise) scales with the level of the signal — a realistic assumption for many economic and natural time series.</p>
<section id="extracting-multiplicative-noise" class="level4" data-number="4.4.5.1">
<h4 data-number="4.4.5.1" class="anchored" data-anchor-id="extracting-multiplicative-noise"><span class="header-section-number">4.4.5.1</span> Extracting multiplicative noise</h4>
<p>Let’s compute the multiplicative residuals based on our fitted deterministic component <span class="math inline">\(tr(t) + s(t)\)</span>:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">y_det  =</span> tr_lm <span class="sc">+</span> sea_lo,</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">eps_mul =</span> (y_2 <span class="sc">-</span> y_det) <span class="sc">/</span> y_det</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> eps_mul)) <span class="sc">+</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">as_date</span>(<span class="fu">c</span>(<span class="st">"2023-12-31"</span>, <span class="st">"2024-12-31"</span>))) <span class="sc">+</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can now inspect whether these normalized residuals appear <strong>homoscedastic</strong> (i.e., constant variance) over time. If the variance stabilizes, that confirms that the multiplicative model is indeed more appropriate.</p>
</section>
<section id="analyzing-the-multiplicative-residuals" class="level4" data-number="4.4.5.2">
<h4 data-number="4.4.5.2" class="anchored" data-anchor-id="analyzing-the-multiplicative-residuals"><span class="header-section-number">4.4.5.2</span> Analyzing the multiplicative residuals</h4>
<p>Compute basic moments of the multiplicative residuals:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>noi_mul_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(df_ts1<span class="sc">$</span>eps_mul)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>noi_mul_var  <span class="ot">&lt;-</span> <span class="fu">var</span>(df_ts1<span class="sc">$</span>eps_mul)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We obtain:</p>
<ul>
<li><p>Mean: -0.009</p></li>
<li><p>Variance: 0.089</p></li>
</ul>
<p>The mean is close to zero, as expected, and the variance is stable across time — confirming that the <strong>scaled residuals are stationary</strong>.</p>
</section>
<section id="distribution-of-multiplicative-noise" class="level4" data-number="4.4.5.3">
<h4 data-number="4.4.5.3" class="anchored" data-anchor-id="distribution-of-multiplicative-noise"><span class="header-section-number">4.4.5.3</span> Distribution of multiplicative noise</h4>
<p>Next, let’s examine whether the multiplicative residuals follow a Poisson, Gaussian, or log-normal distribution.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> eps_mul)) <span class="sc">+</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), <span class="at">bins =</span> <span class="dv">100</span>, <span class="at">fill =</span> <span class="st">"lightblue"</span>) <span class="sc">+</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_function</span>(<span class="at">fun =</span> dnorm,</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">args =</span> <span class="fu">list</span>(<span class="at">mean =</span> noi_mul_mean, <span class="at">sd =</span> <span class="fu">sqrt</span>(noi_mul_var)),</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Distribution of Multiplicative Noise"</span>,</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="fu">expression</span>(epsilon[t]),</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Density"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The red curve corresponds to a normal distribution fitted with the same mean and variance as the empirical residuals.<br>
If the histogram closely follows this curve, the multiplicative noise can be approximated as Gaussian — a common assumption in log-transformed time series models.</p>
</section>
<section id="alternative-representation-log-transformation" class="level4" data-number="4.4.5.4">
<h4 data-number="4.4.5.4" class="anchored" data-anchor-id="alternative-representation-log-transformation"><span class="header-section-number">4.4.5.4</span> Alternative representation (log transformation)</h4>
<p>Since multiplicative models can be expressed additively in the logarithmic domain, we can apply a log transformation:</p>
<p><span class="math display">\[
log(y(t)) = log[tr(t) + s(t)] + log[1 + \epsilon_t]
\]</span> For small noise <span class="math inline">\((\epsilon_t \ll 1)\)</span>, the term <span class="math inline">\(\log(1 + \epsilon_t) \approx \epsilon_t\)</span>,<br>
so the model becomes approximately additive in log-space.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">log_y =</span> <span class="fu">log</span>(y_2),</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">log_det =</span> <span class="fu">log</span>(y_det),</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">log_eps =</span> log_y <span class="sc">-</span> log_det</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> log_eps)) <span class="sc">+</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Log-Transformed Residuals (Approx. Additive)"</span>,</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="fu">expression</span>(<span class="fu">log</span>(epsilon[t])))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This transformation stabilizes the variance even further and simplifies future modeling (e.g., ARIMA or state-space models).</p>
<p>We obtain:</p>
<ul>
<li><p>Mean: -0.054</p></li>
<li><p>Variance: 0.093</p></li>
</ul>
</section>
</section>
</section>
<section id="modeling-wrap-up" class="level2" data-number="4.5">
<h2 data-number="4.5" class="anchored" data-anchor-id="modeling-wrap-up"><span class="header-section-number">4.5</span> Modeling wrap-up</h2>
<section id="trend" class="level3" data-number="4.5.1">
<h3 data-number="4.5.1" class="anchored" data-anchor-id="trend"><span class="header-section-number">4.5.1</span> Trend</h3>
<p>We start by comparing the <strong>original</strong> and <strong>inferred</strong> trend parameters.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>y0_a   <span class="ot">&lt;-</span> lm_tr<span class="sc">$</span>coefficients[<span class="dv">1</span>] <span class="sc">+</span> (df_ts1<span class="sc">$</span>day <span class="sc">%&gt;%</span> <span class="fu">min</span>() <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">*</span> lm_tr<span class="sc">$</span>coefficients[<span class="dv">2</span>]</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>alfa_a <span class="ot">&lt;-</span> lm_tr<span class="sc">$</span>coefficients[<span class="dv">2</span>] <span class="sc">*</span> <span class="dv">365</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="fu">tribble</span>(</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>Trend_Parameter, <span class="sc">~</span>Original, <span class="sc">~</span>Inferred,</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"y₀"</span>,   y0_o,   y0_a,</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"α"</span>,    alfa_o, alfa_a</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 3
  Trend_Parameter Original Inferred
  &lt;chr&gt;              &lt;dbl&gt;    &lt;dbl&gt;
1 y₀                   5      4.91 
2 α                    0.5    0.598</code></pre>
</div>
</div>
<p>The inferred trend parameters are close to the original values, indicating that the linear model successfully recovered the overall trend structure.</p>
</section>
<section id="seasonality-1" class="level3" data-number="4.5.2">
<h3 data-number="4.5.2" class="anchored" data-anchor-id="seasonality-1"><span class="header-section-number">4.5.2</span> Seasonality:</h3>
<p>Next, we compare the original and inferred seasonal components.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> sea)) <span class="sc">+</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> sea_lo), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Comparison of Original and Inferred Seasonality"</span>,</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Day"</span>,</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Seasonal Component"</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/compare-season-orig-inferred-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Here, the black curve represents the original seasonal pattern, while the red dashed curve shows the inferred seasonality. The two align quite well overall, although a small phase shift can be observed — likely due to interactions between trend and noise, or numerical effects in the decomposition.</p>
</section>
<section id="noise" class="level3" data-number="4.5.3">
<h3 data-number="4.5.3" class="anchored" data-anchor-id="noise"><span class="header-section-number">4.5.3</span> Noise</h3>
<p>Finally, we compare the Poisson noise parameter <span class="math inline">\(\lambda_t\)</span>:</p>
<ul>
<li>Original: <span class="math inline">\(\lambda =\)</span> 2</li>
<li>Inferred: <span class="math inline">\(\lambda =\)</span> 2.76</li>
</ul>
<p>The inferred value is somewhat different from the true parameter, which is expected since noise estimation is often sensitive to model specification and the chosen decomposition method.</p>
<p>Still, the inferred variance remains within a reasonable range.<br>
</p>
<p>In the next step, we’ll explore the case with multiplicative noise, which often provides a more realistic representation of many real-world time series.</p>
</section>
<section id="additive-vs.-multiplicative-noise" class="level3" data-number="4.5.4">
<h3 data-number="4.5.4" class="anchored" data-anchor-id="additive-vs.-multiplicative-noise"><span class="header-section-number">4.5.4</span> Additive vs.&nbsp;multiplicative noise</h3>
<p>In the additive model, the observed time series is expressed as:</p>
<p><span class="math display">\[
y_t = tr(t) + s(t) + \varepsilon_t
\]</span></p>
<p>where <span class="math inline">\(\varepsilon_t\)</span> represents random fluctuations around the deterministic trend–seasonality structure.</p>
<p>However, if the amplitude of the noise appears to grow or shrink with the level of the signal (as we observed in our plots), a <strong>multiplicative model</strong> may be more appropriate:</p>
<p><span class="math display">\[
y_t = [tr(t) + s(t)] \times (1 + \varepsilon_t)
\]</span></p>
<section id="log-transformation" class="level4" data-number="4.5.4.1">
<h4 data-number="4.5.4.1" class="anchored" data-anchor-id="log-transformation"><span class="header-section-number">4.5.4.1</span> Log-transformation</h4>
<p>Taking logarithms linearizes the multiplicative model:</p>
<p><span class="math display">\[
\log(y_t) = \log(tr(t) + s(t)) + \log(1 + \varepsilon_t)
\]</span></p>
<p>For small noise (<span class="math inline">\(\varepsilon_t \ll 1\)</span>), we can use the approximation:</p>
<p><span class="math display">\[
\log(1 + \varepsilon_t) \approx \varepsilon_t
\]</span></p>
<p>which means the model becomes approximately <strong>additive in log-space</strong>.<br>
This transformation stabilizes the variance and often results in more homogeneous residuals.</p>
</section>
<section id="procedure" class="level4" data-number="4.5.4.2">
<h4 data-number="4.5.4.2" class="anchored" data-anchor-id="procedure"><span class="header-section-number">4.5.4.2</span> Procedure</h4>
<p>To assess whether the multiplicative model is better, we can follow these steps:</p>
<ol type="1">
<li><strong>Log-transform the series</strong><br>
<span class="math display">\[
y'_t = \log(y_t)
\]</span></li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="ot">&lt;-</span> df_ts1 <span class="sc">|&gt;</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y_log =</span> <span class="fu">log</span>(y_2))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="2" type="1">
<li><strong>Re-estimate</strong> trend and seasonality using the same LOESS or regression techniques on <span class="math inline">\(y'_t\)</span>.</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Trend estimation using linear model</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>lm_tr_log <span class="ot">&lt;-</span> <span class="fu">lm</span>(y_log <span class="sc">~</span> <span class="fu">as.numeric</span>(day), <span class="at">data =</span> df_ts1)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Trend prediction</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="ot">&lt;-</span> df_ts1 <span class="sc">|&gt;</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tr_log =</span> <span class="fu">predict</span>(lm_tr_log))</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Seasonality estimation using LOESS</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>sea_log <span class="ot">&lt;-</span> <span class="fu">loess</span>(y_log <span class="sc">-</span> tr_log <span class="sc">~</span> <span class="fu">as.numeric</span>(day),</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> df_ts1,</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>                 <span class="at">span =</span> loess_span_low)</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="ot">&lt;-</span> df_ts1 <span class="sc">|&gt;</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sea_log =</span> sea_log<span class="sc">$</span>fitted)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="3" type="1">
<li><strong>Extract residuals</strong> in log-space: <span class="math display">\[
\varepsilon'_t = y'_t - tr'(t) - s'(t)
\]</span></li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="ot">&lt;-</span> df_ts1 <span class="sc">|&gt;</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">eps_log =</span> y_log <span class="sc">-</span> tr_log <span class="sc">-</span> sea_log)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="4" type="1">
<li><strong>Evaluate residual properties</strong>:
<ul>
<li>Mean ≈ 0 (centered)</li>
<li>Homoscedasticity (constant variance)</li>
<li>Independence over time</li>
<li>Normality (histogram or QQ-plot)</li>
</ul></li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Variances of additive and multiplicative residuals</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>var_add <span class="ot">&lt;-</span> <span class="fu">var</span>(df_ts1<span class="sc">$</span>y_noi, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>var_mul <span class="ot">&lt;-</span> <span class="fu">var</span>(df_ts1<span class="sc">$</span>eps_log, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="fu">tribble</span>(<span class="sc">~</span>Model, <span class="sc">~</span>Residual_Variance,</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Additive"</span>, <span class="fu">round</span>(var_add, <span class="dv">4</span>),</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Multiplicative (log-space)"</span>, <span class="fu">round</span>(var_mul, <span class="dv">4</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 2
  Model                      Residual_Variance
  &lt;chr&gt;                                  &lt;dbl&gt;
1 Additive                              2.76  
2 Multiplicative (log-space)            0.0906</code></pre>
</div>
</div>
<ol start="5" type="1">
<li><strong>Compare fit metrics</strong> between additive and multiplicative models:
<ul>
<li>Residual variance</li>
<li>AIC / BIC (if fitting parametric trend models)</li>
<li>Predictive performance (e.g., RMSE on holdout data)</li>
</ul></li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">|&gt;</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(day, eps_log, y_noi) <span class="sc">|&gt;</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(y_noi, eps_log),</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"model_type"</span>,</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"residual"</span>) <span class="sc">|&gt;</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> residual, <span class="at">color =</span> model_type)) <span class="sc">+</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span> model_type, <span class="at">ncol =</span> <span class="dv">1</span>, <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Comparison of Residuals: Additive vs. Multiplicative"</span>,</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Day"</span>, <span class="at">y =</span> <span class="st">"Residual"</span>, <span class="at">color =</span> <span class="st">"Model Type"</span>) <span class="sc">+</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="real-case-walmart-2010" class="level2" data-number="4.6">
<h2 data-number="4.6" class="anchored" data-anchor-id="real-case-walmart-2010"><span class="header-section-number">4.6</span> Real case: Walmart 2010</h2>
<p>Having validated our approach on synthetic data, we now test it on <strong>real-world data</strong>.</p>
<section id="dataset" class="level3" data-number="4.6.1">
<h3 data-number="4.6.1" class="anchored" data-anchor-id="dataset"><span class="header-section-number">4.6.1</span> Dataset</h3>
<p>We extracted data from the Walmart Kaggle competition.<br>
Here we focus on <strong>store 2, department 2</strong>.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>fpath_tra <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{data_dir}/Walmart/train.csv"</span>)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>df_tra <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(fpath_tra) <span class="sc">%&gt;%</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_all</span>(tolower) <span class="sc">%&gt;%</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">is_holiday =</span> isholiday)</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="ot">&lt;-</span> df_tra <span class="sc">%&gt;%</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(store <span class="sc">==</span> <span class="dv">2</span>, dept <span class="sc">==</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="inspecting-the-training-data" class="level3" data-number="4.6.2">
<h3 data-number="4.6.2" class="anchored" data-anchor-id="inspecting-the-training-data"><span class="header-section-number">4.6.2</span> Inspecting the training data</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">is_holiday =</span> <span class="fu">ifelse</span>(is_holiday, <span class="cn">TRUE</span>, <span class="cn">NA</span>),</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">store =</span> <span class="fu">factor</span>(store)) <span class="sc">%&gt;%</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> weekly_sales)) <span class="sc">+</span> </span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> store, <span class="at">color =</span> store)) <span class="sc">+</span> </span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">data =</span> df_tra <span class="sc">%&gt;%</span> <span class="fu">filter</span>(is_holiday) <span class="sc">%&gt;%</span> <span class="fu">distinct</span>(date), </span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>               <span class="fu">aes</span>(<span class="at">xintercept =</span> date), </span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">color =</span> <span class="st">"grey50"</span>, </span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>               <span class="at">alpha =</span> <span class="fl">0.5</span>, </span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>               <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span> </span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span> dept, <span class="at">scale =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Weekly Sales: Store 2, Department 2"</span>,</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Weekly Sales"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/restrict-to-1-store-1-dpt-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can already see seasonal patterns, particularly spikes at the end of each year.</p>
</section>
<section id="year-over-year-analysis" class="level3" data-number="4.6.3">
<h3 data-number="4.6.3" class="anchored" data-anchor-id="year-over-year-analysis"><span class="header-section-number">4.6.3</span> Year-over-year analysis</h3>
<p>To highlight seasonal effects, we overlay data year-over-year:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">factor</span>(<span class="fu">year</span>(date)),</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">date_no_year =</span> date) <span class="sc">%&gt;%</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(year, <span class="at">.before =</span> date)</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="fu">year</span>(df_tra_2<span class="sc">$</span>date_no_year) <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date_no_year, <span class="at">y =</span> weekly_sales, <span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Year-over-Year Weekly Sales"</span>,</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Day of Year"</span>,</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Weekly Sales"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/add-years-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Seasonality is evident, with noticeable correlations at year-end. Some mid-year dips in 2011 suggest year-specific effects.</p>
</section>
<section id="trend-analysis-1" class="level3" data-number="4.6.4">
<h3 data-number="4.6.4" class="anchored" data-anchor-id="trend-analysis-1"><span class="header-section-number">4.6.4</span> Trend analysis</h3>
<p><strong>Yearly Trend:</strong><br>
We first estimate the trend within each year, using both linear regression and LOESS smoothing:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>(<span class="at">data =</span> <span class="sc">-</span>year) <span class="sc">%&gt;%</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">lm_tr  =</span> <span class="fu">map</span>(year, <span class="sc">~</span> <span class="fu">lm</span>(df_tra_2 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(year <span class="sc">==</span> .x), <span class="at">formula =</span> weekly_sales <span class="sc">~</span> date)),</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">loes_tr =</span> <span class="fu">map</span>(year, <span class="sc">~</span> <span class="fu">loess</span>(df_tra_2 <span class="sc">%&gt;%</span> </span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">filter</span>(year <span class="sc">==</span> .x) <span class="sc">%&gt;%</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">as.numeric</span>(date)),</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>                                <span class="at">formula =</span> weekly_sales <span class="sc">~</span> date,</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>                                <span class="at">span =</span> loess_span_high)),</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">data    =</span> <span class="fu">map2</span>(data, lm_tr, <span class="sc">~</span> <span class="fu">mutate</span>(.x, <span class="at">try_lm =</span> .y<span class="sc">$</span>fitted)),</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">data    =</span> <span class="fu">map2</span>(data, loes_tr, <span class="sc">~</span> <span class="fu">mutate</span>(.x, <span class="at">try_lo =</span> .y<span class="sc">$</span>fitted))</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(lm_tr, loes_tr)) <span class="sc">%&gt;%</span></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(data)</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date_no_year, <span class="at">y =</span> weekly_sales, <span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> try_lm), <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> try_lo), <span class="at">linetype =</span> <span class="st">"longdash"</span>) <span class="sc">+</span></span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Yearly Trend: Linear vs. LOESS"</span>,</span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Day of Year"</span>,</span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Weekly Sales"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/add-trend-yoy-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The LOESS curves capture more of the seasonal variation than linear trends alone. Notice mid-year dips in 2011 that are not captured perfectly.</p>
<p><strong>Overall Trend:</strong><br>
Next, we estimate a trend across the entire period:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>lm_tr <span class="ot">&lt;-</span> <span class="fu">lm</span>(weekly_sales <span class="sc">~</span> date, <span class="at">data =</span> df_tra_2)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>lo_tr <span class="ot">&lt;-</span> <span class="fu">loess</span>(weekly_sales <span class="sc">~</span> <span class="fu">as.numeric</span>(date), <span class="at">data =</span> df_tra_2, <span class="at">span =</span> loess_span_high)</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tr_lm =</span> lm_tr<span class="sc">$</span>fitted,</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">tr_lo =</span> lo_tr<span class="sc">$</span>fitted)</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> weekly_sales, <span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tr_lo), <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tr_lm), <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Overall Trend: Linear vs. LOESS"</span>,</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Weekly Sales"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/add-trend-overall-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Here, the LOESS trend better captures the variability, especially around peaks and troughs, compared to the linear fit.</p>
</section>
<section id="seasonality-and-noise-analysis" class="level3" data-number="4.6.5">
<h3 data-number="4.6.5" class="anchored" data-anchor-id="seasonality-and-noise-analysis"><span class="header-section-number">4.6.5</span> Seasonality and noise analysis</h3>
<section id="step-1-remove-overall-trend" class="level4" data-number="4.6.5.1">
<h4 data-number="4.6.5.1" class="anchored" data-anchor-id="step-1-remove-overall-trend"><span class="header-section-number">4.6.5.1</span> Step 1: remove overall trend</h4>
<p>We start by subtracting the overall trend (LOESS, with a high span) from the weekly sales to isolate the seasonal component plus noise:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">weekly_notr =</span> weekly_sales <span class="sc">-</span> tr_lo)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="step-2-estimate-seasonality" class="level4" data-number="4.6.5.2">
<h4 data-number="4.6.5.2" class="anchored" data-anchor-id="step-2-estimate-seasonality"><span class="header-section-number">4.6.5.2</span> Step 2: estimate seasonality</h4>
<p>We compute a LOESS-smoothed curve on the detrended series to approximate seasonality, setting a <strong>lower span</strong> to capture finer yearly patterns:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>sea_lo <span class="ot">&lt;-</span> <span class="fu">loess</span>(weekly_notr <span class="sc">~</span> <span class="fu">as.numeric</span>(date), <span class="at">data =</span> df_tra_2, <span class="at">span =</span> loess_span_low)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sea_lo =</span> sea_lo<span class="sc">$</span>fitted)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="step-3-visualize-seasonality-year-over-year" class="level4" data-number="4.6.5.3">
<h4 data-number="4.6.5.3" class="anchored" data-anchor-id="step-3-visualize-seasonality-year-over-year"><span class="header-section-number">4.6.5.3</span> Step 3: visualize seasonality year-over-year</h4>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date_no_year, <span class="at">y =</span> weekly_notr, <span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> sea_lo, <span class="at">group =</span> year), <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Detrended Weekly Sales: Seasonality (LOESS)"</span>,</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Day of Year"</span>,</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Detrended Sales"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can now clearly see the yearly seasonal pattern, including spikes around holidays and end-of-year peaks.</p>
</section>
<section id="step-4-extract-noise" class="level4" data-number="4.6.5.4">
<h4 data-number="4.6.5.4" class="anchored" data-anchor-id="step-4-extract-noise"><span class="header-section-number">4.6.5.4</span> Step 4: extract noise</h4>
<p>Subtracting the seasonal component from the detrended series gives us the residuals (noise):</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">weekly_noise =</span> weekly_notr <span class="sc">-</span> sea_lo)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="step-5-inspect-noise-properties" class="level4" data-number="4.6.5.5">
<h4 data-number="4.6.5.5" class="anchored" data-anchor-id="step-5-inspect-noise-properties"><span class="header-section-number">4.6.5.5</span> Step 5: inspect noise properties</h4>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>noi_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(df_tra_2<span class="sc">$</span>weekly_noise, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>noi_var  <span class="ot">&lt;-</span> <span class="fu">var</span>(df_tra_2<span class="sc">$</span>weekly_noise, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> weekly_noise)) <span class="sc">+</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), <span class="at">bins =</span> <span class="dv">100</span>, <span class="at">fill =</span> <span class="st">"lightblue"</span>) <span class="sc">+</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">"Histogram of Residual Noise</span><span class="sc">\n</span><span class="st">Mean = "</span>, <span class="fu">round</span>(noi_mean,<span class="dv">2</span>),</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>                        <span class="st">", Variance = "</span>, <span class="fu">round</span>(noi_var,<span class="dv">2</span>)),</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Residual Noise"</span>,</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Density"</span>) <span class="sc">+</span></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="step-6-overlay-noise-vs.-deterministic-component" class="level4" data-number="4.6.5.6">
<h4 data-number="4.6.5.6" class="anchored" data-anchor-id="step-6-overlay-noise-vs.-deterministic-component"><span class="header-section-number">4.6.5.6</span> Step 6: overlay noise vs.&nbsp;deterministic component</h4>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> weekly_noise)) <span class="sc">+</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> year), <span class="at">alpha =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tr_lo <span class="sc">+</span> sea_lo <span class="sc">-</span> <span class="fu">min</span>(tr_lo)), <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Residual Noise vs. Deterministic Component"</span>,</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Residual Noise"</span>) <span class="sc">+</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This helps check whether noise amplitude scales with signal, which would indicate multiplicative effects.</p>
</section>
<section id="step-7-normalize-noise-by-deterministic-component" class="level4" data-number="4.6.5.7">
<h4 data-number="4.6.5.7" class="anchored" data-anchor-id="step-7-normalize-noise-by-deterministic-component"><span class="header-section-number">4.6.5.7</span> Step 7: normalize noise by deterministic component</h4>
<p>Compute a relative noise, dividing the residual by the deterministic component (trend + seasonality):</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">deterministic =</span> tr_lo <span class="sc">+</span> sea_lo,</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">rel_noise =</span> weekly_noise <span class="sc">/</span> deterministic)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ul>
<li><p>This gives an approximate multiplicative residual, which should have roughly constant variance if the multiplicative model is appropriate.</p></li>
<li><p>Values are interpretable as “fractional deviation from expected sales.</p></li>
</ul>
</section>
<section id="step-8-compare-additive-vs.-multiplicative-noise-variance" class="level4" data-number="4.6.5.8">
<h4 data-number="4.6.5.8" class="anchored" data-anchor-id="step-8-compare-additive-vs.-multiplicative-noise-variance"><span class="header-section-number">4.6.5.8</span> Step 8: compare additive vs.&nbsp;multiplicative noise variance</h4>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute standard deviation</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>additive_var <span class="ot">&lt;-</span> <span class="fu">var</span>(df_tra_2<span class="sc">$</span>weekly_noise, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>multiplicative_var <span class="ot">&lt;-</span> <span class="fu">var</span>(df_tra_2<span class="sc">$</span>rel_noise, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="fu">tribble</span>(</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>model, <span class="sc">~</span>residual_variance,</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Additive"</span>, additive_var,</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Multiplicative"</span>, multiplicative_var</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 2
  model          residual_variance
  &lt;chr&gt;                      &lt;dbl&gt;
1 Additive                 1.40e+7
2 Multiplicative           2.97e-3</code></pre>
</div>
</div>
<p>Since the multiplicative variance is smaller, the multiplicative model stabilizes the residuals.</p>
</section>
<section id="step-9-visualize-relative-noise-over-time" class="level4" data-number="4.6.5.9">
<h4 data-number="4.6.5.9" class="anchored" data-anchor-id="step-9-visualize-relative-noise-over-time"><span class="header-section-number">4.6.5.9</span> Step 9: visualize relative noise over time</h4>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> rel_noise, <span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Relative (Multiplicative) Residuals"</span>,</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Fractional Residual"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This highlights whether the multiplicative model reduces the amplitude variation over the year.</p>
</section>
<section id="step-10-histogram-and-normality-check" class="level4" data-number="4.6.5.10">
<h4 data-number="4.6.5.10" class="anchored" data-anchor-id="step-10-histogram-and-normality-check"><span class="header-section-number">4.6.5.10</span> Step 10: histogram and normality check</h4>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>rel_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(df_tra_2<span class="sc">$</span>rel_noise, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>rel_var  <span class="ot">&lt;-</span> <span class="fu">var</span>(df_tra_2<span class="sc">$</span>rel_noise, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> rel_noise)) <span class="sc">+</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), <span class="at">bins =</span> <span class="dv">100</span>, <span class="at">fill =</span> <span class="st">"lightblue"</span>) <span class="sc">+</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">"Histogram of Relative Noise</span><span class="sc">\n</span><span class="st">Mean = "</span>, <span class="fu">round</span>(rel_mean,<span class="dv">2</span>),</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>                        <span class="st">", Variance = "</span>, <span class="fu">round</span>(rel_var,<span class="dv">2</span>)),</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Relative Residual"</span>,</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Density"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="step-11-log-transform-for-multiplicative-model" class="level4" data-number="4.6.5.11">
<h4 data-number="4.6.5.11" class="anchored" data-anchor-id="step-11-log-transform-for-multiplicative-model"><span class="header-section-number">4.6.5.11</span> Step 11: log-transform for multiplicative model</h4>
<p>Another way to handle multiplicative noise is to log-transform the data, which converts multiplicative effects into additive ones:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">log_weekly =</span> <span class="fu">log</span>(weekly_sales),</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">log_tr_lo  =</span> <span class="fu">log</span>(tr_lo),</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">log_resid  =</span> log_weekly <span class="sc">-</span> log_tr_lo)</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> log_weekly, <span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> log_tr_lo), <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Log-Transformed Weekly Sales with LOESS Trend"</span>,</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"log(Weekly Sales)"</span></span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="step-12-examine-the-log-residuals" class="level4" data-number="4.6.5.12">
<h4 data-number="4.6.5.12" class="anchored" data-anchor-id="step-12-examine-the-log-residuals"><span class="header-section-number">4.6.5.12</span> Step 12: examine the log residuals</h4>
<p>Visualize the residuals in log-space to check if they’re roughly centered around zero and stationary.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> log_resid, <span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Residuals in Log-Space (Multiplicative Noise)"</span>,</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="fu">expression</span>(<span class="fu">log</span>(epsilon[t]))</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>If the multiplicative model is appropriate, the residuals should have:<br>
- constant variance over time, and - no clear seasonal pattern.</p>
</section>
<section id="step-13-distribution-of-log-residuals" class="level4" data-number="4.6.5.13">
<h4 data-number="4.6.5.13" class="anchored" data-anchor-id="step-13-distribution-of-log-residuals"><span class="header-section-number">4.6.5.13</span> Step 13: distribution of log residuals</h4>
<p>Check the shape of the distribution (for normality):</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>log_resid_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(df_tra_2<span class="sc">$</span>log_resid, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>log_resid_var  <span class="ot">&lt;-</span> <span class="fu">var</span>(df_tra_2<span class="sc">$</span>log_resid, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> log_resid)) <span class="sc">+</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), <span class="at">bins =</span> <span class="dv">100</span>, <span class="at">fill =</span> <span class="st">"lightblue"</span>) <span class="sc">+</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_function</span>(<span class="at">fun =</span> dnorm,</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>                  <span class="at">args =</span> <span class="fu">list</span>(<span class="at">mean =</span> log_resid_mean, <span class="at">sd =</span> <span class="fu">sqrt</span>(log_resid_var)),</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>                  <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Distribution of Log Residuals (Multiplicative Model)"</span>,</span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="fu">expression</span>(<span class="fu">log</span>(epsilon[t])),</span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Density"</span></span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="generating_time_series_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>If the histogram closely follows the red curve (normal fit), the multiplicative model provides a valid Gaussian approximation in log-space.</p>
</section>
<section id="step-14-quantitative-comparison-with-additive-model" class="level4" data-number="4.6.5.14">
<h4 data-number="4.6.5.14" class="anchored" data-anchor-id="step-14-quantitative-comparison-with-additive-model"><span class="header-section-number">4.6.5.14</span> Step 14: quantitative comparison with additive model</h4>
<p>To summarize model performance, compare residual moments and normality:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tribble</span>(</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>Criterion, <span class="sc">~</span>Additive_Model, <span class="sc">~</span>Multiplicative_Model,</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Mean"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(df_tra_2<span class="sc">$</span>weekly_noise, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">4</span>), <span class="fu">round</span>(<span class="fu">mean</span>(df_tra_2<span class="sc">$</span>log_resid, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">4</span>),</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Variance"</span>, <span class="fu">round</span>(<span class="fu">var</span>(df_tra_2<span class="sc">$</span>weekly_noise, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">4</span>), <span class="fu">round</span>(<span class="fu">var</span>(df_tra_2<span class="sc">$</span>log_resid, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">4</span>),</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Shapiro-Wilk p-value"</span>,</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">signif</span>(<span class="fu">shapiro.test</span>(df_tra_2<span class="sc">$</span>weekly_noise)<span class="sc">$</span>p.value, <span class="dv">3</span>),</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">signif</span>(<span class="fu">shapiro.test</span>(df_tra_2<span class="sc">$</span>log_resid)<span class="sc">$</span>p.value, <span class="dv">3</span>)</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 3
  Criterion            Additive_Model Multiplicative_Model
  &lt;chr&gt;                         &lt;dbl&gt;                &lt;dbl&gt;
1 Mean                      -8.31e+ 0             -7   e-4
2 Variance                   1.40e+ 7              4.5 e-3
3 Shapiro-Wilk p-value       1.87e-13              1.18e-9</code></pre>
</div>
</div>
<!-- -->

</section>
</section>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb63" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Generating Time Series"</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a><span class="an">editor:</span><span class="co"> source</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> Behrouz Delfanian</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a><span class="an">affiliation:</span><span class="co"> University of Luxembourg</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-depth: 3</span></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-location: left</span></span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a><span class="co">    execute:</span></span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a><span class="co">      enabled: true</span></span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a><span class="an">engine:</span><span class="co"> knitr</span></span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a><span class="an">filters:</span></span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a><span class="co">  - webr</span></span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a><span class="an">webr:</span></span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a><span class="co">  show-editor: true</span></span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a><span class="co">  show-startup-message: false</span></span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true" tabindex="-1"></a><span class="co">  autorun: true</span></span>
<span id="cb63-22"><a href="#cb63-22" aria-hidden="true" tabindex="-1"></a><span class="an">resources:</span></span>
<span id="cb63-23"><a href="#cb63-23" aria-hidden="true" tabindex="-1"></a><span class="co">  - webr-worker.js</span></span>
<span id="cb63-24"><a href="#cb63-24" aria-hidden="true" tabindex="-1"></a><span class="co">  - webr-serviceworker.js</span></span>
<span id="cb63-25"><a href="#cb63-25" aria-hidden="true" tabindex="-1"></a><span class="an">number-sections:</span><span class="co"> true</span></span>
<span id="cb63-26"><a href="#cb63-26" aria-hidden="true" tabindex="-1"></a><span class="an">message:</span><span class="co"> false</span></span>
<span id="cb63-27"><a href="#cb63-27" aria-hidden="true" tabindex="-1"></a><span class="an">warning:</span><span class="co"> false</span></span>
<span id="cb63-28"><a href="#cb63-28" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb63-29"><a href="#cb63-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-30"><a href="#cb63-30" aria-hidden="true" tabindex="-1"></a><span class="fu"># R environment setting</span></span>
<span id="cb63-31"><a href="#cb63-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-32"><a href="#cb63-32" aria-hidden="true" tabindex="-1"></a>Installing required libraries</span>
<span id="cb63-33"><a href="#cb63-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-36"><a href="#cb63-36" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-37"><a href="#cb63-37" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: installing_libraries</span></span>
<span id="cb63-38"><a href="#cb63-38" aria-hidden="true" tabindex="-1"></a><span class="co">#| cache: true</span></span>
<span id="cb63-39"><a href="#cb63-39" aria-hidden="true" tabindex="-1"></a><span class="co">#| results: hide</span></span>
<span id="cb63-40"><a href="#cb63-40" aria-hidden="true" tabindex="-1"></a>cran_repo <span class="ot">&lt;-</span> <span class="st">"https://ftp.fau.de/cran"</span></span>
<span id="cb63-41"><a href="#cb63-41" aria-hidden="true" tabindex="-1"></a>list_Rpack2use <span class="ot">&lt;-</span></span>
<span id="cb63-42"><a href="#cb63-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"rmarkdown"</span>,</span>
<span id="cb63-43"><a href="#cb63-43" aria-hidden="true" tabindex="-1"></a>    <span class="st">"conflicted"</span>,</span>
<span id="cb63-44"><a href="#cb63-44" aria-hidden="true" tabindex="-1"></a>    <span class="st">"devtools"</span>,</span>
<span id="cb63-45"><a href="#cb63-45" aria-hidden="true" tabindex="-1"></a>    <span class="st">"knitr"</span>,</span>
<span id="cb63-46"><a href="#cb63-46" aria-hidden="true" tabindex="-1"></a>    <span class="st">"quarto"</span>,</span>
<span id="cb63-47"><a href="#cb63-47" aria-hidden="true" tabindex="-1"></a>    <span class="st">"bookdown"</span>,</span>
<span id="cb63-48"><a href="#cb63-48" aria-hidden="true" tabindex="-1"></a>    <span class="co">#shiny,</span></span>
<span id="cb63-49"><a href="#cb63-49" aria-hidden="true" tabindex="-1"></a>    <span class="st">"DT"</span>,</span>
<span id="cb63-50"><a href="#cb63-50" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Hmisc"</span>,</span>
<span id="cb63-51"><a href="#cb63-51" aria-hidden="true" tabindex="-1"></a>    <span class="st">"tidyverse"</span>,</span>
<span id="cb63-52"><a href="#cb63-52" aria-hidden="true" tabindex="-1"></a>    <span class="st">"magrittr"</span>,</span>
<span id="cb63-53"><a href="#cb63-53" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lubridate"</span>,</span>
<span id="cb63-54"><a href="#cb63-54" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hms"</span>,</span>
<span id="cb63-55"><a href="#cb63-55" aria-hidden="true" tabindex="-1"></a>    <span class="st">"glue"</span>,</span>
<span id="cb63-56"><a href="#cb63-56" aria-hidden="true" tabindex="-1"></a>    <span class="st">"skimr"</span>,</span>
<span id="cb63-57"><a href="#cb63-57" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lobstr"</span>,</span>
<span id="cb63-58"><a href="#cb63-58" aria-hidden="true" tabindex="-1"></a>    <span class="st">"janitor"</span>,</span>
<span id="cb63-59"><a href="#cb63-59" aria-hidden="true" tabindex="-1"></a>    <span class="st">"zeallot"</span>,</span>
<span id="cb63-60"><a href="#cb63-60" aria-hidden="true" tabindex="-1"></a>    <span class="st">"stringi"</span>,</span>
<span id="cb63-61"><a href="#cb63-61" aria-hidden="true" tabindex="-1"></a>    <span class="st">"lemon"</span>,</span>
<span id="cb63-62"><a href="#cb63-62" aria-hidden="true" tabindex="-1"></a>    <span class="st">"crayon"</span>,</span>
<span id="cb63-63"><a href="#cb63-63" aria-hidden="true" tabindex="-1"></a>    <span class="st">"jsonlite"</span>,</span>
<span id="cb63-64"><a href="#cb63-64" aria-hidden="true" tabindex="-1"></a>    <span class="co">#"officer",</span></span>
<span id="cb63-65"><a href="#cb63-65" aria-hidden="true" tabindex="-1"></a>    <span class="st">"tsibble"</span>,</span>
<span id="cb63-66"><a href="#cb63-66" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fable"</span>,</span>
<span id="cb63-67"><a href="#cb63-67" aria-hidden="true" tabindex="-1"></a>    <span class="st">"feasts"</span>,</span>
<span id="cb63-68"><a href="#cb63-68" aria-hidden="true" tabindex="-1"></a>    <span class="st">"imputeTS"</span>,</span>
<span id="cb63-69"><a href="#cb63-69" aria-hidden="true" tabindex="-1"></a>    <span class="st">"readxl"</span>,</span>
<span id="cb63-70"><a href="#cb63-70" aria-hidden="true" tabindex="-1"></a>    <span class="st">"slider"</span>,</span>
<span id="cb63-71"><a href="#cb63-71" aria-hidden="true" tabindex="-1"></a>    <span class="st">"reticulate"</span>,</span>
<span id="cb63-72"><a href="#cb63-72" aria-hidden="true" tabindex="-1"></a>    <span class="st">"aws.s3"</span>,</span>
<span id="cb63-73"><a href="#cb63-73" aria-hidden="true" tabindex="-1"></a>    <span class="st">"paws"</span>,</span>
<span id="cb63-74"><a href="#cb63-74" aria-hidden="true" tabindex="-1"></a>    <span class="st">"RAthena"</span>,</span>
<span id="cb63-75"><a href="#cb63-75" aria-hidden="true" tabindex="-1"></a>    <span class="st">"botor"</span>,</span>
<span id="cb63-76"><a href="#cb63-76" aria-hidden="true" tabindex="-1"></a>    <span class="st">"RPostgres"</span>,</span>
<span id="cb63-77"><a href="#cb63-77" aria-hidden="true" tabindex="-1"></a>    <span class="st">"DBI"</span>,</span>
<span id="cb63-78"><a href="#cb63-78" aria-hidden="true" tabindex="-1"></a>    <span class="st">"RJDBC"</span>,</span>
<span id="cb63-79"><a href="#cb63-79" aria-hidden="true" tabindex="-1"></a>    <span class="st">"dbplyr"</span>,</span>
<span id="cb63-80"><a href="#cb63-80" aria-hidden="true" tabindex="-1"></a>    <span class="st">"arrow"</span>,</span>
<span id="cb63-81"><a href="#cb63-81" aria-hidden="true" tabindex="-1"></a>    <span class="st">"geosphere"</span>,</span>
<span id="cb63-82"><a href="#cb63-82" aria-hidden="true" tabindex="-1"></a>    <span class="st">"viridis"</span>)</span>
<span id="cb63-83"><a href="#cb63-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-84"><a href="#cb63-84" aria-hidden="true" tabindex="-1"></a>list_installed_packages <span class="ot">&lt;-</span> <span class="fu">names</span>(<span class="fu">installed.packages</span>()[,<span class="dv">2</span>])</span>
<span id="cb63-85"><a href="#cb63-85" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (Rpack <span class="cf">in</span> list_Rpack2use) {</span>
<span id="cb63-86"><a href="#cb63-86" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span> Rpack <span class="sc">%in%</span> list_installed_packages) {</span>
<span id="cb63-87"><a href="#cb63-87" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"Installing"</span>, Rpack))</span>
<span id="cb63-88"><a href="#cb63-88" aria-hidden="true" tabindex="-1"></a>    <span class="fu">install.packages</span>(Rpack, <span class="at">repos =</span> cran_repo)</span>
<span id="cb63-89"><a href="#cb63-89" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb63-90"><a href="#cb63-90" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">paste</span>(Rpack, <span class="st">"already installed."</span>))</span>
<span id="cb63-91"><a href="#cb63-91" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb63-92"><a href="#cb63-92" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb63-93"><a href="#cb63-93" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-94"><a href="#cb63-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-95"><a href="#cb63-95" aria-hidden="true" tabindex="-1"></a>Loading librairies</span>
<span id="cb63-96"><a href="#cb63-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-99"><a href="#cb63-99" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-100"><a href="#cb63-100" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: loading_libraries</span></span>
<span id="cb63-101"><a href="#cb63-101" aria-hidden="true" tabindex="-1"></a>list_Rpack2load_not <span class="ot">&lt;-</span></span>
<span id="cb63-102"><a href="#cb63-102" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"conflicted"</span>,</span>
<span id="cb63-103"><a href="#cb63-103" aria-hidden="true" tabindex="-1"></a>    <span class="st">"devtools"</span>,</span>
<span id="cb63-104"><a href="#cb63-104" aria-hidden="true" tabindex="-1"></a>    <span class="st">"paws"</span>,</span>
<span id="cb63-105"><a href="#cb63-105" aria-hidden="true" tabindex="-1"></a>    <span class="st">"RAthena"</span>,</span>
<span id="cb63-106"><a href="#cb63-106" aria-hidden="true" tabindex="-1"></a>    <span class="st">"botor"</span>,</span>
<span id="cb63-107"><a href="#cb63-107" aria-hidden="true" tabindex="-1"></a>    <span class="st">"arrow"</span>,</span>
<span id="cb63-108"><a href="#cb63-108" aria-hidden="true" tabindex="-1"></a>    <span class="st">"RPostgres"</span>,</span>
<span id="cb63-109"><a href="#cb63-109" aria-hidden="true" tabindex="-1"></a>    <span class="st">"DBI"</span>,</span>
<span id="cb63-110"><a href="#cb63-110" aria-hidden="true" tabindex="-1"></a>    <span class="st">"RJDBC"</span>,</span>
<span id="cb63-111"><a href="#cb63-111" aria-hidden="true" tabindex="-1"></a>    <span class="st">"dbplyr"</span>,</span>
<span id="cb63-112"><a href="#cb63-112" aria-hidden="true" tabindex="-1"></a>    <span class="st">"aws.s3"</span>,</span>
<span id="cb63-113"><a href="#cb63-113" aria-hidden="true" tabindex="-1"></a>    <span class="st">"arrow"</span>,</span>
<span id="cb63-114"><a href="#cb63-114" aria-hidden="true" tabindex="-1"></a>    <span class="st">"reticulate"</span>,</span>
<span id="cb63-115"><a href="#cb63-115" aria-hidden="true" tabindex="-1"></a>    <span class="st">"slider"</span>,</span>
<span id="cb63-116"><a href="#cb63-116" aria-hidden="true" tabindex="-1"></a>    <span class="st">"stringi"</span>,</span>
<span id="cb63-117"><a href="#cb63-117" aria-hidden="true" tabindex="-1"></a>    <span class="st">"geosphere"</span>,</span>
<span id="cb63-118"><a href="#cb63-118" aria-hidden="true" tabindex="-1"></a>    <span class="st">"blah"</span>)</span>
<span id="cb63-119"><a href="#cb63-119" aria-hidden="true" tabindex="-1"></a>list_Rpack2load <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(list_Rpack2use, list_Rpack2load_not)</span>
<span id="cb63-120"><a href="#cb63-120" aria-hidden="true" tabindex="-1"></a>list_Rpack2load</span>
<span id="cb63-121"><a href="#cb63-121" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-122"><a href="#cb63-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-123"><a href="#cb63-123" aria-hidden="true" tabindex="-1"></a>Resolving function name conflicts</span>
<span id="cb63-124"><a href="#cb63-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-127"><a href="#cb63-127" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-128"><a href="#cb63-128" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: resolving_conflicts</span></span>
<span id="cb63-129"><a href="#cb63-129" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (Rpack <span class="cf">in</span> list_Rpack2load) {</span>
<span id="cb63-130"><a href="#cb63-130" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(Rpack, <span class="at">character.only =</span> <span class="cn">TRUE</span>)</span>
<span id="cb63-131"><a href="#cb63-131" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb63-132"><a href="#cb63-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-133"><a href="#cb63-133" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(pillar<span class="sc">::</span>dim_desc)</span>
<span id="cb63-134"><a href="#cb63-134" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(magrittr<span class="sc">::</span>extract)</span>
<span id="cb63-135"><a href="#cb63-135" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(dplyr<span class="sc">::</span>filter)</span>
<span id="cb63-136"><a href="#cb63-136" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(jsonlite<span class="sc">::</span>flatten)</span>
<span id="cb63-137"><a href="#cb63-137" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(hms<span class="sc">::</span>hms)</span>
<span id="cb63-138"><a href="#cb63-138" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(dbplyr<span class="sc">::</span>ident)</span>
<span id="cb63-139"><a href="#cb63-139" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(lubridate<span class="sc">::</span>interval)</span>
<span id="cb63-140"><a href="#cb63-140" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(dplyr<span class="sc">::</span>lag)</span>
<span id="cb63-141"><a href="#cb63-141" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(readxl<span class="sc">::</span>read_xlsx)</span>
<span id="cb63-142"><a href="#cb63-142" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(magrittr<span class="sc">::</span>set_names)</span>
<span id="cb63-143"><a href="#cb63-143" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(dbplyr<span class="sc">::</span>sql)</span>
<span id="cb63-144"><a href="#cb63-144" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(Hmisc<span class="sc">::</span>src)</span>
<span id="cb63-145"><a href="#cb63-145" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(dplyr<span class="sc">::</span>summarize)</span>
<span id="cb63-146"><a href="#cb63-146" aria-hidden="true" tabindex="-1"></a>conflicted<span class="sc">::</span><span class="fu">conflicts_prefer</span>(magrittr<span class="sc">::</span>is_in)</span>
<span id="cb63-147"><a href="#cb63-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-148"><a href="#cb63-148" aria-hidden="true" tabindex="-1"></a><span class="co">#To pass if interactive</span></span>
<span id="cb63-149"><a href="#cb63-149" aria-hidden="true" tabindex="-1"></a><span class="co">#rendering &lt;- TRUE</span></span>
<span id="cb63-150"><a href="#cb63-150" aria-hidden="true" tabindex="-1"></a><span class="co">#time_all &lt;- proc.time()</span></span>
<span id="cb63-151"><a href="#cb63-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-152"><a href="#cb63-152" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"./scripts_gal/misc_funs.R"</span>)</span>
<span id="cb63-153"><a href="#cb63-153" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-154"><a href="#cb63-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-155"><a href="#cb63-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-156"><a href="#cb63-156" aria-hidden="true" tabindex="-1"></a><span class="fu"># Time series overview</span></span>
<span id="cb63-157"><a href="#cb63-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-158"><a href="#cb63-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-159"><a href="#cb63-159" aria-hidden="true" tabindex="-1"></a><span class="fu">## What is a time series?</span></span>
<span id="cb63-160"><a href="#cb63-160" aria-hidden="true" tabindex="-1"></a>A **time series** is a sequence of data points recorded over time at **equally spaced intervals** (e.g., daily sales, monthly demand, yearly GDP).  </span>
<span id="cb63-161"><a href="#cb63-161" aria-hidden="true" tabindex="-1"></a>It captures the **temporal dynamics** of a process and is central to **forecasting** in supply chains, finance, weather, and many other fields.</span>
<span id="cb63-162"><a href="#cb63-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-163"><a href="#cb63-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-164"><a href="#cb63-164" aria-hidden="true" tabindex="-1"></a><span class="fu">## Key components</span></span>
<span id="cb63-165"><a href="#cb63-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-166"><a href="#cb63-166" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Trend (T)**  </span>
<span id="cb63-167"><a href="#cb63-167" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>The **long-term** progression of the series (upward, downward, or stable).  </span>
<span id="cb63-168"><a href="#cb63-168" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Reflects overall growth, decline, or stagnation.  </span>
<span id="cb63-169"><a href="#cb63-169" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>*Example:* gradual increase in online sales over years.  </span>
<span id="cb63-170"><a href="#cb63-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-171"><a href="#cb63-171" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Seasonality (S)**  </span>
<span id="cb63-172"><a href="#cb63-172" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>*Regular, repeating patterns at fixed periods* (daily, weekly, monthly, yearly).  </span>
<span id="cb63-173"><a href="#cb63-173" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>*Example:* ice cream sales peaking every summer.  </span>
<span id="cb63-174"><a href="#cb63-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-175"><a href="#cb63-175" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Cyclic component (C)**  </span>
<span id="cb63-176"><a href="#cb63-176" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Long-term oscillations around the trend, often tied to _economic/business_ cycles.  </span>
<span id="cb63-177"><a href="#cb63-177" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Unlike seasonality, cycles are **irregular** in **length and amplitude**.  </span>
<span id="cb63-178"><a href="#cb63-178" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>*Example:* economic boom and recession cycles.  </span>
<span id="cb63-179"><a href="#cb63-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-180"><a href="#cb63-180" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Irregular / Random (I)**  </span>
<span id="cb63-181"><a href="#cb63-181" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Unpredictable, residual variations after accounting for trend, seasonality, and cycles.  </span>
<span id="cb63-182"><a href="#cb63-182" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>*Example:* sudden demand spikes due to supply chain disruptions.  </span>
<span id="cb63-183"><a href="#cb63-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-184"><a href="#cb63-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-185"><a href="#cb63-185" aria-hidden="true" tabindex="-1"></a><span class="fu">## Models of time series</span></span>
<span id="cb63-186"><a href="#cb63-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-187"><a href="#cb63-187" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Additive model:**  </span>
<span id="cb63-188"><a href="#cb63-188" aria-hidden="true" tabindex="-1"></a>  $$</span>
<span id="cb63-189"><a href="#cb63-189" aria-hidden="true" tabindex="-1"></a>  Y_t = T_t + S_t + C_t + I_t</span>
<span id="cb63-190"><a href="#cb63-190" aria-hidden="true" tabindex="-1"></a>  $$  </span>
<span id="cb63-191"><a href="#cb63-191" aria-hidden="true" tabindex="-1"></a>  Suitable when **seasonal variations** remain **constant in magnitude**.  </span>
<span id="cb63-192"><a href="#cb63-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-193"><a href="#cb63-193" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Multiplicative model:**  </span>
<span id="cb63-194"><a href="#cb63-194" aria-hidden="true" tabindex="-1"></a>  $$</span>
<span id="cb63-195"><a href="#cb63-195" aria-hidden="true" tabindex="-1"></a>  Y_t = T_t \times S_t \times C_t \times I_t</span>
<span id="cb63-196"><a href="#cb63-196" aria-hidden="true" tabindex="-1"></a>  $$  </span>
<span id="cb63-197"><a href="#cb63-197" aria-hidden="true" tabindex="-1"></a>  Suitable when **seasonal variations** change **proportionally** with the level of the series.  </span>
<span id="cb63-198"><a href="#cb63-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-199"><a href="#cb63-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-200"><a href="#cb63-200" aria-hidden="true" tabindex="-1"></a><span class="fu">## Applications in supply chain</span></span>
<span id="cb63-201"><a href="#cb63-201" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Demand forecasting** → anticipating future _product demand_.  </span>
<span id="cb63-202"><a href="#cb63-202" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Inventory control** → optimizing _stock_ based on demand variability.  </span>
<span id="cb63-203"><a href="#cb63-203" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Capacity planning** → adjusting _workforce_ or _production_ to meet seasonal/cyclic needs.  </span>
<span id="cb63-204"><a href="#cb63-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-205"><a href="#cb63-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-206"><a href="#cb63-206" aria-hidden="true" tabindex="-1"></a><span class="fu"># Generating a TS components</span></span>
<span id="cb63-207"><a href="#cb63-207" aria-hidden="true" tabindex="-1"></a>A TS has some **deterministic** components (the “signal”) and some **random** component (the “noise”).\</span>
<span id="cb63-208"><a href="#cb63-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-209"><a href="#cb63-209" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb63-210"><a href="#cb63-210" aria-hidden="true" tabindex="-1"></a>Usually we want to **extract the signal**, and **model the noise**.\</span>
<span id="cb63-211"><a href="#cb63-211" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb63-212"><a href="#cb63-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-213"><a href="#cb63-213" aria-hidden="true" tabindex="-1"></a>Here, since we are generating a TS, we start with some signal and then add the noise.\</span>
<span id="cb63-214"><a href="#cb63-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-215"><a href="#cb63-215" aria-hidden="true" tabindex="-1"></a><span class="fu">## Deterministic component</span></span>
<span id="cb63-216"><a href="#cb63-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-217"><a href="#cb63-217" aria-hidden="true" tabindex="-1"></a>When building or simulating a time series, it is useful to separate **deterministic components** (signal) from **stochastic components** (noise).</span>
<span id="cb63-218"><a href="#cb63-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-219"><a href="#cb63-219" aria-hidden="true" tabindex="-1"></a>The deterministic part can include:</span>
<span id="cb63-220"><a href="#cb63-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-221"><a href="#cb63-221" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Trend** — a systematic long-term increase or decrease in the series.</span>
<span id="cb63-222"><a href="#cb63-222" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Seasonality** — _recurring fluctuations_ tied to the calendar (daily, weekly, yearly, etc.).</span>
<span id="cb63-223"><a href="#cb63-223" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Other **structural components** — for example, cycles linked to macroeconomic factors.</span>
<span id="cb63-224"><a href="#cb63-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-225"><a href="#cb63-225" aria-hidden="true" tabindex="-1"></a><span class="fu">### Trend component</span></span>
<span id="cb63-226"><a href="#cb63-226" aria-hidden="true" tabindex="-1"></a>We start simple with a linear trend. We’ll be optimistic and assume we have a steady trend of $\alpha= 0.5$ per year starting from a number of units (say thousands of items) of $y_0 = 5$.</span>
<span id="cb63-227"><a href="#cb63-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-228"><a href="#cb63-228" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Linear trend</span></span>
<span id="cb63-229"><a href="#cb63-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-230"><a href="#cb63-230" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-231"><a href="#cb63-231" aria-hidden="true" tabindex="-1"></a>tr(t) = y_0 + \alpha*\frac{t}{365}</span>
<span id="cb63-232"><a href="#cb63-232" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-233"><a href="#cb63-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-234"><a href="#cb63-234" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Exponential trend</span></span>
<span id="cb63-235"><a href="#cb63-235" aria-hidden="true" tabindex="-1"></a>If instead of a linear trend we assume a **constant proportional daily growth rate ($1 + \beta_d$)**, then the trend is exponential. </span>
<span id="cb63-236"><a href="#cb63-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-237"><a href="#cb63-237" aria-hidden="true" tabindex="-1"></a>After **one day**, the demand’s trend would be $y_0*(1 + \beta_d)$, and after $t$ days, the demand’s trend would be $y_0*(1 + \beta_d)^t$.</span>
<span id="cb63-238"><a href="#cb63-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-239"><a href="#cb63-239" aria-hidden="true" tabindex="-1"></a>The daily growth rate can be derived from the yearly one:</span>
<span id="cb63-240"><a href="#cb63-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-241"><a href="#cb63-241" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-242"><a href="#cb63-242" aria-hidden="true" tabindex="-1"></a>1 + \beta_d = 1 + \frac{\beta_y}{365} \approx e^{\frac{\beta_y}{365}}</span>
<span id="cb63-243"><a href="#cb63-243" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-244"><a href="#cb63-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-245"><a href="#cb63-245" aria-hidden="true" tabindex="-1"></a>Consequently:</span>
<span id="cb63-246"><a href="#cb63-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-247"><a href="#cb63-247" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-248"><a href="#cb63-248" aria-hidden="true" tabindex="-1"></a>tr(t) = y_0*(1 + \beta_d)^t \approx y_0*(e^{\frac{\beta_y}{365}})^t</span>
<span id="cb63-249"><a href="#cb63-249" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-250"><a href="#cb63-250" aria-hidden="true" tabindex="-1"></a>For $\beta_y = 0.1$:</span>
<span id="cb63-251"><a href="#cb63-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-252"><a href="#cb63-252" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-253"><a href="#cb63-253" aria-hidden="true" tabindex="-1"></a>tr(t) = y_0 * (e^{\frac{0.1}{365}})^t</span>
<span id="cb63-254"><a href="#cb63-254" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-255"><a href="#cb63-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-256"><a href="#cb63-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-257"><a href="#cb63-257" aria-hidden="true" tabindex="-1"></a><span class="fu">### Seasonality component</span></span>
<span id="cb63-258"><a href="#cb63-258" aria-hidden="true" tabindex="-1"></a>Seasonality captures **repeated, systematic fluctuations** that recur with a fixed period.\</span>
<span id="cb63-259"><a href="#cb63-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-260"><a href="#cb63-260" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Example: retail sales increase every December (yearly seasonality).\</span>
<span id="cb63-261"><a href="#cb63-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-262"><a href="#cb63-262" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>In our toy model, we assume **only one yearly seasonal effect**.\</span>
<span id="cb63-263"><a href="#cb63-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-264"><a href="#cb63-264" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Later, this framework can be extended to **multiple overlapping seasonalities** (e.g., weekly + yearly).</span>
<span id="cb63-265"><a href="#cb63-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-266"><a href="#cb63-266" aria-hidden="true" tabindex="-1"></a>Here, we start with only one yearly seasonality **$s(t)$** (with yearly period).</span>
<span id="cb63-267"><a href="#cb63-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-268"><a href="#cb63-268" aria-hidden="true" tabindex="-1"></a>We smooth the raw seasonal pattern and normalize it so that it has mean zero, ensuring the trend drives the long-run growth.</span>
<span id="cb63-269"><a href="#cb63-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-272"><a href="#cb63-272" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-273"><a href="#cb63-273" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: seasonality_def_plot</span></span>
<span id="cb63-274"><a href="#cb63-274" aria-hidden="true" tabindex="-1"></a>trend_y <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb63-275"><a href="#cb63-275" aria-hidden="true" tabindex="-1"></a><span class="co"># yearly trend</span></span>
<span id="cb63-276"><a href="#cb63-276" aria-hidden="true" tabindex="-1"></a>start_ts <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb63-277"><a href="#cb63-277" aria-hidden="true" tabindex="-1"></a><span class="co"># starting value of the series</span></span>
<span id="cb63-278"><a href="#cb63-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-279"><a href="#cb63-279" aria-hidden="true" tabindex="-1"></a>sea_0 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">10</span>)</span>
<span id="cb63-280"><a href="#cb63-280" aria-hidden="true" tabindex="-1"></a><span class="co"># sea_0 contains a seasonal adjustment for each month. </span></span>
<span id="cb63-281"><a href="#cb63-281" aria-hidden="true" tabindex="-1"></a><span class="co"># These values represent typical deviations from the trend for each month.</span></span>
<span id="cb63-282"><a href="#cb63-282" aria-hidden="true" tabindex="-1"></a>df_sea <span class="ot">&lt;-</span> </span>
<span id="cb63-283"><a href="#cb63-283" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">day =</span> <span class="fu">seq</span>(<span class="fu">as_date</span>(<span class="st">"2022-12-28"</span>), <span class="fu">today</span>() <span class="sc">+</span> <span class="fu">days</span>(<span class="dv">3</span>), <span class="at">by =</span> <span class="st">"day"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb63-284"><a href="#cb63-284" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generates a daily sequence of dates</span></span>
<span id="cb63-285"><a href="#cb63-285" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mon =</span> <span class="fu">month</span>(day),</span>
<span id="cb63-286"><a href="#cb63-286" aria-hidden="true" tabindex="-1"></a>         <span class="at">sea =</span> <span class="fu">map2_dbl</span>(mon, day, <span class="sc">~</span> <span class="fu">if_else</span>((<span class="fu">str_split</span>(.y, <span class="at">pattern =</span> <span class="st">"-"</span>) <span class="sc">%&gt;%</span> <span class="fu">extract2</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> <span class="fu">extract</span>(<span class="dv">3</span>) <span class="sc">%&gt;%</span> as.numeric) <span class="sc">==</span> <span class="dv">15</span>, sea_0[.x], <span class="cn">NA</span>)),</span>
<span id="cb63-287"><a href="#cb63-287" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Map monthly seasonal values to the middle of each month</span></span>
<span id="cb63-288"><a href="#cb63-288" aria-hidden="true" tabindex="-1"></a>         <span class="co"># This creates monthly anchor points for the seasonal component.</span></span>
<span id="cb63-289"><a href="#cb63-289" aria-hidden="true" tabindex="-1"></a>         <span class="at">sea =</span> <span class="fu">na_interpolation</span>(sea, <span class="at">option =</span> <span class="st">"spline"</span>),</span>
<span id="cb63-290"><a href="#cb63-290" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Interpolate missing seasonal values</span></span>
<span id="cb63-291"><a href="#cb63-291" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Fills in the NA values using spline interpolation, creating a smooth seasonal curve.</span></span>
<span id="cb63-292"><a href="#cb63-292" aria-hidden="true" tabindex="-1"></a>         <span class="at">sea =</span> zoo<span class="sc">::</span><span class="fu">rollmean</span>(sea, <span class="at">k =</span> <span class="dv">7</span>, <span class="at">fill =</span> <span class="cn">TRUE</span>),</span>
<span id="cb63-293"><a href="#cb63-293" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Smooth the seasonal curve further</span></span>
<span id="cb63-294"><a href="#cb63-294" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Applies a 7-day rolling mean to smooth short-term fluctuations.</span></span>
<span id="cb63-295"><a href="#cb63-295" aria-hidden="true" tabindex="-1"></a>         <span class="at">sea =</span> sea <span class="sc">-</span> <span class="fu">mean</span>(sea)) <span class="sc">%&gt;%</span></span>
<span id="cb63-296"><a href="#cb63-296" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Center the seasonal component around zero</span></span>
<span id="cb63-297"><a href="#cb63-297" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(day <span class="sc">&gt;=</span> <span class="st">"2023-01-01"</span>,</span>
<span id="cb63-298"><a href="#cb63-298" aria-hidden="true" tabindex="-1"></a>         day <span class="sc">&lt;=</span> <span class="fu">today</span>())</span>
<span id="cb63-299"><a href="#cb63-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-300"><a href="#cb63-300" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&gt;%</span></span>
<span id="cb63-301"><a href="#cb63-301" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> sea)) <span class="sc">+</span></span>
<span id="cb63-302"><a href="#cb63-302" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb63-303"><a href="#cb63-303" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"#00BFC4"</span>, <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb63-304"><a href="#cb63-304" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Seasonality component"</span>,</span>
<span id="cb63-305"><a href="#cb63-305" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Value"</span>, <span class="at">x =</span> <span class="st">"Day"</span>)</span>
<span id="cb63-306"><a href="#cb63-306" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-307"><a href="#cb63-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-308"><a href="#cb63-308" aria-hidden="true" tabindex="-1"></a><span class="fu">### Additive model</span></span>
<span id="cb63-309"><a href="#cb63-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-310"><a href="#cb63-310" aria-hidden="true" tabindex="-1"></a>Let’s focus on one item and write $y_t$ for counts of orders for this item, and assume we have daily counts since **January 1st, 2023**, with no missing data.  </span>
<span id="cb63-311"><a href="#cb63-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-312"><a href="#cb63-312" aria-hidden="true" tabindex="-1"></a>We can put together the **trend** and the **seasonality** in an **additive** way to get the time series’ deterministic component:</span>
<span id="cb63-313"><a href="#cb63-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-314"><a href="#cb63-314" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-315"><a href="#cb63-315" aria-hidden="true" tabindex="-1"></a>y_t^{\text{(d)}} = tr(t) + S(t)</span>
<span id="cb63-316"><a href="#cb63-316" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-317"><a href="#cb63-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-318"><a href="#cb63-318" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>With the linear trend\</span>
<span id="cb63-319"><a href="#cb63-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-320"><a href="#cb63-320" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-321"><a href="#cb63-321" aria-hidden="true" tabindex="-1"></a>tr(t) = y_0 + \alpha*\frac{t}{365}</span>
<span id="cb63-322"><a href="#cb63-322" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-323"><a href="#cb63-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-324"><a href="#cb63-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-325"><a href="#cb63-325" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-326"><a href="#cb63-326" aria-hidden="true" tabindex="-1"></a>S(t) = s(t)</span>
<span id="cb63-327"><a href="#cb63-327" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-328"><a href="#cb63-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-329"><a href="#cb63-329" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-330"><a href="#cb63-330" aria-hidden="true" tabindex="-1"></a>y_t^{\text{(d)}} = y_0 + \alpha*\frac{t}{365} + s(t)</span>
<span id="cb63-331"><a href="#cb63-331" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-332"><a href="#cb63-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-333"><a href="#cb63-333" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>With the exponential trend\</span>
<span id="cb63-334"><a href="#cb63-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-335"><a href="#cb63-335" aria-hidden="true" tabindex="-1"></a>It would also make sense to **multiply the seasonality by the growth rate**. So, after $t$ days, the deterministic component would be:</span>
<span id="cb63-336"><a href="#cb63-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-337"><a href="#cb63-337" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-338"><a href="#cb63-338" aria-hidden="true" tabindex="-1"></a>tr(t) = y_0*(e^{\frac{\beta_y}{365}})^t</span>
<span id="cb63-339"><a href="#cb63-339" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-340"><a href="#cb63-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-341"><a href="#cb63-341" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-342"><a href="#cb63-342" aria-hidden="true" tabindex="-1"></a>S(t) = s(t)*(e^{\frac{\beta_y}{365}})^t</span>
<span id="cb63-343"><a href="#cb63-343" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-344"><a href="#cb63-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-345"><a href="#cb63-345" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-346"><a href="#cb63-346" aria-hidden="true" tabindex="-1"></a>y_t^{\text{(d)}} = (y_0 + s(t))*(e^{\frac{\beta_y}{365}})^t</span>
<span id="cb63-347"><a href="#cb63-347" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-348"><a href="#cb63-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-349"><a href="#cb63-349" aria-hidden="true" tabindex="-1"></a>For $\beta_y = 0.1$:</span>
<span id="cb63-350"><a href="#cb63-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-351"><a href="#cb63-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-352"><a href="#cb63-352" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-353"><a href="#cb63-353" aria-hidden="true" tabindex="-1"></a>y_t^{\text{(d)}} = (y_0 + s(t))*(e^{\frac{0.1}{365}})^t</span>
<span id="cb63-354"><a href="#cb63-354" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-355"><a href="#cb63-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-356"><a href="#cb63-356" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Plotting the deterministic component</span></span>
<span id="cb63-357"><a href="#cb63-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-358"><a href="#cb63-358" aria-hidden="true" tabindex="-1"></a>Here we can visualize how the trend and seasonality combine over time to form the deterministic part of the time series.</span>
<span id="cb63-359"><a href="#cb63-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-362"><a href="#cb63-362" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-363"><a href="#cb63-363" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: deterministic_comp</span></span>
<span id="cb63-364"><a href="#cb63-364" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&lt;&gt;%</span></span>
<span id="cb63-365"><a href="#cb63-365" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tr_lin =</span> start_ts <span class="sc">+</span> trend_y <span class="sc">*</span> <span class="fu">row_number</span>() <span class="sc">/</span> <span class="dv">365</span>,</span>
<span id="cb63-366"><a href="#cb63-366" aria-hidden="true" tabindex="-1"></a>         <span class="at">tr_exp =</span> start_ts <span class="sc">*</span> <span class="fu">exp</span>(<span class="fl">0.1</span> <span class="sc">/</span> <span class="dv">365</span>)<span class="sc">^</span><span class="fu">row_number</span>(),</span>
<span id="cb63-367"><a href="#cb63-367" aria-hidden="true" tabindex="-1"></a>         <span class="at">yd_lin =</span> tr_lin <span class="sc">+</span> sea,</span>
<span id="cb63-368"><a href="#cb63-368" aria-hidden="true" tabindex="-1"></a>         <span class="at">yd_exp =</span> (start_ts <span class="sc">+</span> sea) <span class="sc">*</span> <span class="fu">exp</span>(<span class="fl">0.1</span> <span class="sc">/</span> <span class="dv">365</span>)<span class="sc">^</span><span class="fu">row_number</span>())</span>
<span id="cb63-369"><a href="#cb63-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-370"><a href="#cb63-370" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&gt;%</span> </span>
<span id="cb63-371"><a href="#cb63-371" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(tr_lin, tr_exp, yd_lin, yd_exp), </span>
<span id="cb63-372"><a href="#cb63-372" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">"func"</span>, <span class="st">"method"</span>), </span>
<span id="cb63-373"><a href="#cb63-373" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_sep =</span> <span class="st">"_"</span>, </span>
<span id="cb63-374"><a href="#cb63-374" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb63-375"><a href="#cb63-375" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">func =</span> <span class="fu">factor</span>(func, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"yd"</span>, <span class="st">"tr"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb63-376"><a href="#cb63-376" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb63-377"><a href="#cb63-377" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> method,</span>
<span id="cb63-378"><a href="#cb63-378" aria-hidden="true" tabindex="-1"></a>                  <span class="at">linetype =</span> func), <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb63-379"><a href="#cb63-379" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Additive Deterministic Component"</span>,</span>
<span id="cb63-380"><a href="#cb63-380" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Value"</span>, <span class="at">x =</span> <span class="st">"Date"</span>)</span>
<span id="cb63-381"><a href="#cb63-381" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-382"><a href="#cb63-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-383"><a href="#cb63-383" aria-hidden="true" tabindex="-1"></a><span class="fu">### Multiplicative model</span></span>
<span id="cb63-384"><a href="#cb63-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-387"><a href="#cb63-387" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-388"><a href="#cb63-388" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: multiplicative_deterministic_comp</span></span>
<span id="cb63-389"><a href="#cb63-389" aria-hidden="true" tabindex="-1"></a><span class="co"># Multiplicative deterministic component</span></span>
<span id="cb63-390"><a href="#cb63-390" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&lt;&gt;%</span></span>
<span id="cb63-391"><a href="#cb63-391" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb63-392"><a href="#cb63-392" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Linear trend (for comparison)</span></span>
<span id="cb63-393"><a href="#cb63-393" aria-hidden="true" tabindex="-1"></a>    <span class="at">tr_lin =</span> start_ts <span class="sc">+</span> trend_y <span class="sc">*</span> <span class="fu">row_number</span>() <span class="sc">/</span> <span class="dv">365</span>,</span>
<span id="cb63-394"><a href="#cb63-394" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Exponential trend</span></span>
<span id="cb63-395"><a href="#cb63-395" aria-hidden="true" tabindex="-1"></a>    <span class="at">tr_exp =</span> start_ts <span class="sc">*</span> <span class="fu">exp</span>(<span class="fl">0.1</span> <span class="sc">/</span> <span class="dv">365</span>)<span class="sc">^</span><span class="fu">row_number</span>(),</span>
<span id="cb63-396"><a href="#cb63-396" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-397"><a href="#cb63-397" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Multiplicative seasonal component</span></span>
<span id="cb63-398"><a href="#cb63-398" aria-hidden="true" tabindex="-1"></a>    <span class="at">yd_lin_mul =</span> tr_lin <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> sea),        <span class="co"># linear trend * (1 + seasonality)</span></span>
<span id="cb63-399"><a href="#cb63-399" aria-hidden="true" tabindex="-1"></a>    <span class="at">yd_exp_mul =</span> tr_exp <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> sea)         <span class="co"># exponential trend * (1 + seasonality)</span></span>
<span id="cb63-400"><a href="#cb63-400" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb63-401"><a href="#cb63-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-402"><a href="#cb63-402" aria-hidden="true" tabindex="-1"></a><span class="co"># Reshape for plotting</span></span>
<span id="cb63-403"><a href="#cb63-403" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&gt;%</span> </span>
<span id="cb63-404"><a href="#cb63-404" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb63-405"><a href="#cb63-405" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(tr_lin, tr_exp, yd_lin_mul, yd_exp_mul), </span>
<span id="cb63-406"><a href="#cb63-406" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">"func"</span>, <span class="st">"method"</span>), </span>
<span id="cb63-407"><a href="#cb63-407" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_sep =</span> <span class="st">"_"</span>, </span>
<span id="cb63-408"><a href="#cb63-408" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"value"</span></span>
<span id="cb63-409"><a href="#cb63-409" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb63-410"><a href="#cb63-410" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">func =</span> <span class="fu">factor</span>(func, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"yd"</span>, <span class="st">"tr"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb63-411"><a href="#cb63-411" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb63-412"><a href="#cb63-412" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> method, <span class="at">linetype =</span> func), <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb63-413"><a href="#cb63-413" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Multiplicative Deterministic Component"</span>,</span>
<span id="cb63-414"><a href="#cb63-414" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Value"</span>, <span class="at">x =</span> <span class="st">"Date"</span>)</span>
<span id="cb63-415"><a href="#cb63-415" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-416"><a href="#cb63-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-417"><a href="#cb63-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-418"><a href="#cb63-418" aria-hidden="true" tabindex="-1"></a><span class="fu">## Random component</span></span>
<span id="cb63-419"><a href="#cb63-419" aria-hidden="true" tabindex="-1"></a>So far, we have modeled only the signal. But in reality, time series always contain noise, capturing **unpredictable factors** such as weather, strikes, promotions, or random shocks.</span>
<span id="cb63-420"><a href="#cb63-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-421"><a href="#cb63-421" aria-hidden="true" tabindex="-1"></a><span class="fu">### Gaussain noise</span></span>
<span id="cb63-422"><a href="#cb63-422" aria-hidden="true" tabindex="-1"></a>A simple first assumption is **additive Gaussian noise** with zero mean ($\mu = 0$) and variance $\sigma^2$.</span>
<span id="cb63-423"><a href="#cb63-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-424"><a href="#cb63-424" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> style</span><span class="op">=</span><span class="st">"text-align: center;"</span><span class="dt">&gt;</span></span>
<span id="cb63-425"><a href="#cb63-425" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">img</span><span class="ot"> src</span><span class="op">=</span><span class="st">"/images/normal_distribution_pdf.png"</span><span class="ot"> alt</span><span class="op">=</span><span class="st">"Poisson Distribution"</span><span class="ot"> width</span><span class="op">=</span><span class="st">"75%"</span><span class="dt">&gt;</span></span>
<span id="cb63-426"><a href="#cb63-426" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb63-427"><a href="#cb63-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-428"><a href="#cb63-428" aria-hidden="true" tabindex="-1"></a>**Distribution:**  </span>
<span id="cb63-429"><a href="#cb63-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-430"><a href="#cb63-430" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-431"><a href="#cb63-431" aria-hidden="true" tabindex="-1"></a>\epsilon_t \sim \mathcal{N}(0, \sigma^2)</span>
<span id="cb63-432"><a href="#cb63-432" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-433"><a href="#cb63-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-434"><a href="#cb63-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-435"><a href="#cb63-435" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-436"><a href="#cb63-436" aria-hidden="true" tabindex="-1"></a>f(x) = \frac{1}{\sqrt{2\pi\sigma^2}} \, \exp\left(-\frac{x^2}{2\sigma^2}\right)</span>
<span id="cb63-437"><a href="#cb63-437" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-438"><a href="#cb63-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-439"><a href="#cb63-439" aria-hidden="true" tabindex="-1"></a>**Parameters:** $\mu = 0$, $\sigma^2$</span>
<span id="cb63-440"><a href="#cb63-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-441"><a href="#cb63-441" aria-hidden="true" tabindex="-1"></a>**Mean:** $\mu = 0$</span>
<span id="cb63-442"><a href="#cb63-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-443"><a href="#cb63-443" aria-hidden="true" tabindex="-1"></a>**Variance:** $\sigma^2$</span>
<span id="cb63-444"><a href="#cb63-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-445"><a href="#cb63-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-448"><a href="#cb63-448" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-449"><a href="#cb63-449" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: gaussian_noise_added</span></span>
<span id="cb63-450"><a href="#cb63-450" aria-hidden="true" tabindex="-1"></a>sig_1 <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb63-451"><a href="#cb63-451" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">102938</span>)</span>
<span id="cb63-452"><a href="#cb63-452" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&lt;&gt;%</span></span>
<span id="cb63-453"><a href="#cb63-453" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">noi =</span> <span class="fu">rnorm</span>(<span class="fu">nrow</span>(df_sea), <span class="dv">0</span>, sig_1),</span>
<span id="cb63-454"><a href="#cb63-454" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_lin =</span> yd_lin <span class="sc">+</span> noi,</span>
<span id="cb63-455"><a href="#cb63-455" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_exp =</span> (start_ts <span class="sc">+</span> sea <span class="sc">+</span> noi) <span class="sc">*</span> <span class="fu">exp</span>(<span class="fl">0.1</span> <span class="sc">/</span> <span class="dv">365</span>)<span class="sc">^</span><span class="fu">row_number</span>())</span>
<span id="cb63-456"><a href="#cb63-456" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-457"><a href="#cb63-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-458"><a href="#cb63-458" aria-hidden="true" tabindex="-1"></a>Let’s start simple and assume we have additive Gaussian noise with mean zero and variance $\sigma ^2 = 1$.\</span>
<span id="cb63-459"><a href="#cb63-459" aria-hidden="true" tabindex="-1"></a>Now we have the complete additive time series:</span>
<span id="cb63-460"><a href="#cb63-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-461"><a href="#cb63-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-462"><a href="#cb63-462" aria-hidden="true" tabindex="-1"></a>And the complete multiplicative time series:</span>
<span id="cb63-463"><a href="#cb63-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-464"><a href="#cb63-464" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-465"><a href="#cb63-465" aria-hidden="true" tabindex="-1"></a>y(t) = tr(t) + S_t + \epsilon</span>
<span id="cb63-466"><a href="#cb63-466" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-467"><a href="#cb63-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-468"><a href="#cb63-468" aria-hidden="true" tabindex="-1"></a>And the complete multiplicative time series:</span>
<span id="cb63-469"><a href="#cb63-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-470"><a href="#cb63-470" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-471"><a href="#cb63-471" aria-hidden="true" tabindex="-1"></a>y(t) = (tr(t) + S_t + \epsilon) * exp(\beta_d * t)</span>
<span id="cb63-472"><a href="#cb63-472" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-475"><a href="#cb63-475" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-476"><a href="#cb63-476" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: noisy_ts_plot</span></span>
<span id="cb63-477"><a href="#cb63-477" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&gt;%</span> </span>
<span id="cb63-478"><a href="#cb63-478" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(tr_lin, tr_exp, y_lin, y_exp), </span>
<span id="cb63-479"><a href="#cb63-479" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">"func"</span>, <span class="st">"method"</span>), </span>
<span id="cb63-480"><a href="#cb63-480" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_sep =</span> <span class="st">"_"</span>, </span>
<span id="cb63-481"><a href="#cb63-481" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb63-482"><a href="#cb63-482" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">func =</span> <span class="fu">factor</span>(func, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"y"</span>, <span class="st">"tr"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb63-483"><a href="#cb63-483" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb63-484"><a href="#cb63-484" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb63-485"><a href="#cb63-485" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> method,</span>
<span id="cb63-486"><a href="#cb63-486" aria-hidden="true" tabindex="-1"></a>                  <span class="at">linetype =</span> func),</span>
<span id="cb63-487"><a href="#cb63-487" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb63-488"><a href="#cb63-488" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Additive Gaussian Noise"</span>,</span>
<span id="cb63-489"><a href="#cb63-489" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Value"</span>, <span class="at">x =</span> <span class="st">"Date"</span>)</span>
<span id="cb63-490"><a href="#cb63-490" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-491"><a href="#cb63-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-492"><a href="#cb63-492" aria-hidden="true" tabindex="-1"></a>We see here some negative values. That’s not consistent with counts. Counts are never negative. This means that our model is not quite right. We used Gaussian noise. But **Gaussian noise is unlimited in the positive as well as in the negative**. What other noise distribution can we use?</span>
<span id="cb63-493"><a href="#cb63-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-494"><a href="#cb63-494" aria-hidden="true" tabindex="-1"></a>Since demand is count-based, a more natural choice is a discrete distribution.</span>
<span id="cb63-495"><a href="#cb63-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-496"><a href="#cb63-496" aria-hidden="true" tabindex="-1"></a><span class="fu">### Poisson Noise</span></span>
<span id="cb63-497"><a href="#cb63-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-498"><a href="#cb63-498" aria-hidden="true" tabindex="-1"></a>Suitable when **variance ≈ mean**.  </span>
<span id="cb63-499"><a href="#cb63-499" aria-hidden="true" tabindex="-1"></a>It is simple and widely used for **rare-event counts**.</span>
<span id="cb63-500"><a href="#cb63-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-501"><a href="#cb63-501" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> style</span><span class="op">=</span><span class="st">"text-align: center;"</span><span class="dt">&gt;</span></span>
<span id="cb63-502"><a href="#cb63-502" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">img</span><span class="ot"> src</span><span class="op">=</span><span class="st">"/images/poisson_distribution_PMF.png"</span><span class="ot"> alt</span><span class="op">=</span><span class="st">"Poisson Distribution"</span><span class="ot"> width</span><span class="op">=</span><span class="st">"75%"</span><span class="dt">&gt;</span></span>
<span id="cb63-503"><a href="#cb63-503" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb63-504"><a href="#cb63-504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-505"><a href="#cb63-505" aria-hidden="true" tabindex="-1"></a>**Distribution:**  </span>
<span id="cb63-506"><a href="#cb63-506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-507"><a href="#cb63-507" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-508"><a href="#cb63-508" aria-hidden="true" tabindex="-1"></a>\epsilon_t \sim \mathcal{Poisson}(\lambda)</span>
<span id="cb63-509"><a href="#cb63-509" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-510"><a href="#cb63-510" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-511"><a href="#cb63-511" aria-hidden="true" tabindex="-1"></a>P(X = k) = \frac{\lambda^k e^{-\lambda}}{k!}, \quad k = 0, 1, 2, \ldots</span>
<span id="cb63-512"><a href="#cb63-512" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-513"><a href="#cb63-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-514"><a href="#cb63-514" aria-hidden="true" tabindex="-1"></a>**Parameters:** $\lambda$  </span>
<span id="cb63-515"><a href="#cb63-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-516"><a href="#cb63-516" aria-hidden="true" tabindex="-1"></a>**Mean:** $\lambda$  </span>
<span id="cb63-517"><a href="#cb63-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-518"><a href="#cb63-518" aria-hidden="true" tabindex="-1"></a>**Variance:** $\lambda$  </span>
<span id="cb63-519"><a href="#cb63-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-520"><a href="#cb63-520" aria-hidden="true" tabindex="-1"></a>**Notes:**  </span>
<span id="cb63-521"><a href="#cb63-521" aria-hidden="true" tabindex="-1"></a>Common in modeling **count data** and **discrete random events** (e.g., photon counts, arrivals, or defect occurrences).</span>
<span id="cb63-522"><a href="#cb63-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-525"><a href="#cb63-525" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-526"><a href="#cb63-526" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: noisy_ts_poisson_plot</span></span>
<span id="cb63-527"><a href="#cb63-527" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">102938</span>)</span>
<span id="cb63-528"><a href="#cb63-528" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">&lt;-</span> <span class="dv">2</span>  <span class="co"># mean noise level</span></span>
<span id="cb63-529"><a href="#cb63-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-530"><a href="#cb63-530" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&lt;&gt;%</span></span>
<span id="cb63-531"><a href="#cb63-531" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">noi_pois =</span> <span class="fu">rpois</span>(<span class="fu">nrow</span>(df_sea), lambda),</span>
<span id="cb63-532"><a href="#cb63-532" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_lin_pois =</span> yd_lin <span class="sc">+</span> noi_pois,</span>
<span id="cb63-533"><a href="#cb63-533" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_exp_pois =</span> (start_ts <span class="sc">+</span> sea <span class="sc">+</span> noi_pois) <span class="sc">*</span> <span class="fu">exp</span>(<span class="fl">0.1</span> <span class="sc">/</span> <span class="dv">365</span>)<span class="sc">^</span><span class="fu">row_number</span>())</span>
<span id="cb63-534"><a href="#cb63-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-535"><a href="#cb63-535" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&gt;%</span> </span>
<span id="cb63-536"><a href="#cb63-536" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(tr_lin, tr_exp, y_lin_pois, y_exp_pois), </span>
<span id="cb63-537"><a href="#cb63-537" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">"func"</span>, <span class="st">"method"</span>), </span>
<span id="cb63-538"><a href="#cb63-538" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_sep =</span> <span class="st">"_"</span>, </span>
<span id="cb63-539"><a href="#cb63-539" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb63-540"><a href="#cb63-540" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">func =</span> <span class="fu">factor</span>(func, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"y"</span>, <span class="st">"tr"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb63-541"><a href="#cb63-541" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb63-542"><a href="#cb63-542" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb63-543"><a href="#cb63-543" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> method,</span>
<span id="cb63-544"><a href="#cb63-544" aria-hidden="true" tabindex="-1"></a>                  <span class="at">linetype =</span> func),</span>
<span id="cb63-545"><a href="#cb63-545" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb63-546"><a href="#cb63-546" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Additive Poisson Noise"</span>,</span>
<span id="cb63-547"><a href="#cb63-547" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Value"</span>, <span class="at">x =</span> <span class="st">"Date"</span>)</span>
<span id="cb63-548"><a href="#cb63-548" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-549"><a href="#cb63-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-550"><a href="#cb63-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-551"><a href="#cb63-551" aria-hidden="true" tabindex="-1"></a><span class="fu">### Negative Binomial noise</span></span>
<span id="cb63-552"><a href="#cb63-552" aria-hidden="true" tabindex="-1"></a>When the **variance of counts is larger than the mean**, the Poisson assumption is too restrictive.</span>
<span id="cb63-553"><a href="#cb63-553" aria-hidden="true" tabindex="-1"></a>The Negative Binomial distribution **generalizes the Poisson** by introducing an **overdispersion parameter r**.</span>
<span id="cb63-554"><a href="#cb63-554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-555"><a href="#cb63-555" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> style</span><span class="op">=</span><span class="st">"text-align: center;"</span><span class="dt">&gt;</span></span>
<span id="cb63-556"><a href="#cb63-556" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">img</span><span class="ot"> src</span><span class="op">=</span><span class="st">"/images/negative_binomial.png"</span><span class="ot"> alt</span><span class="op">=</span><span class="st">"Negative-Binomial Distribution"</span><span class="ot"> width</span><span class="op">=</span><span class="st">"100%"</span><span class="dt">&gt;</span></span>
<span id="cb63-557"><a href="#cb63-557" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb63-558"><a href="#cb63-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-559"><a href="#cb63-559" aria-hidden="true" tabindex="-1"></a>**Distribution:** </span>
<span id="cb63-560"><a href="#cb63-560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-561"><a href="#cb63-561" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-562"><a href="#cb63-562" aria-hidden="true" tabindex="-1"></a>\epsilon_t \sim NB(r, p)</span>
<span id="cb63-563"><a href="#cb63-563" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-564"><a href="#cb63-564" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-565"><a href="#cb63-565" aria-hidden="true" tabindex="-1"></a>P(X = k) = \binom{k + r - 1}{k} (1 - p)^r p^k, \quad k = 0, 1, 2, \ldots</span>
<span id="cb63-566"><a href="#cb63-566" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-567"><a href="#cb63-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-568"><a href="#cb63-568" aria-hidden="true" tabindex="-1"></a>**Parameters:**  </span>
<span id="cb63-569"><a href="#cb63-569" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$r &gt; 0$ is the number of successes,  </span>
<span id="cb63-570"><a href="#cb63-570" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$p \in (0,1)$ is the probability of failure (per trial),  </span>
<span id="cb63-571"><a href="#cb63-571" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$k$ is the number of failures before achieving $r$ successes.</span>
<span id="cb63-572"><a href="#cb63-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-573"><a href="#cb63-573" aria-hidden="true" tabindex="-1"></a>**Mean:** $\mu = r\frac{1-p}{p}$\  </span>
<span id="cb63-574"><a href="#cb63-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-575"><a href="#cb63-575" aria-hidden="true" tabindex="-1"></a>**Variance:** $\mu + \frac{\mu^2}{r}$, which is **larger than the mean** when r is finite.</span>
<span id="cb63-576"><a href="#cb63-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-577"><a href="#cb63-577" aria-hidden="true" tabindex="-1"></a>This makes it much more flexible than the Poisson for real-world data.</span>
<span id="cb63-578"><a href="#cb63-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-581"><a href="#cb63-581" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-582"><a href="#cb63-582" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: noisy_ts_negbin_plot</span></span>
<span id="cb63-583"><a href="#cb63-583" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">102938</span>)</span>
<span id="cb63-584"><a href="#cb63-584" aria-hidden="true" tabindex="-1"></a>size <span class="ot">&lt;-</span> <span class="dv">5</span>    <span class="co"># dispersion parameter (higher = closer to Poisson)</span></span>
<span id="cb63-585"><a href="#cb63-585" aria-hidden="true" tabindex="-1"></a>mu   <span class="ot">&lt;-</span> <span class="dv">2</span>    <span class="co"># mean of noise</span></span>
<span id="cb63-586"><a href="#cb63-586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-587"><a href="#cb63-587" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&lt;&gt;%</span></span>
<span id="cb63-588"><a href="#cb63-588" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">noi_nb =</span> <span class="fu">rnbinom</span>(<span class="fu">nrow</span>(df_sea), <span class="at">size =</span> size, <span class="at">mu =</span> mu),</span>
<span id="cb63-589"><a href="#cb63-589" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_lin_nb =</span> yd_lin <span class="sc">+</span> noi_nb,</span>
<span id="cb63-590"><a href="#cb63-590" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_exp_nb =</span> (start_ts <span class="sc">+</span> sea <span class="sc">+</span> noi_nb) <span class="sc">*</span> <span class="fu">exp</span>(<span class="fl">0.1</span> <span class="sc">/</span> <span class="dv">365</span>)<span class="sc">^</span><span class="fu">row_number</span>())</span>
<span id="cb63-591"><a href="#cb63-591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-592"><a href="#cb63-592" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&gt;%</span> </span>
<span id="cb63-593"><a href="#cb63-593" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(tr_lin, tr_exp, y_lin_nb, y_exp_nb), </span>
<span id="cb63-594"><a href="#cb63-594" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">"func"</span>, <span class="st">"method"</span>), </span>
<span id="cb63-595"><a href="#cb63-595" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_sep =</span> <span class="st">"_"</span>, </span>
<span id="cb63-596"><a href="#cb63-596" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb63-597"><a href="#cb63-597" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">func =</span> <span class="fu">factor</span>(func, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"y"</span>, <span class="st">"tr"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb63-598"><a href="#cb63-598" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb63-599"><a href="#cb63-599" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb63-600"><a href="#cb63-600" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> method,</span>
<span id="cb63-601"><a href="#cb63-601" aria-hidden="true" tabindex="-1"></a>                  <span class="at">linetype =</span> func),</span>
<span id="cb63-602"><a href="#cb63-602" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb63-603"><a href="#cb63-603" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Additive Negative Binomial Noise"</span>,</span>
<span id="cb63-604"><a href="#cb63-604" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Value"</span>, <span class="at">x =</span> <span class="st">"Date"</span>)</span>
<span id="cb63-605"><a href="#cb63-605" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-606"><a href="#cb63-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-607"><a href="#cb63-607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-608"><a href="#cb63-608" aria-hidden="true" tabindex="-1"></a><span class="fu">### Gamma noise</span></span>
<span id="cb63-609"><a href="#cb63-609" aria-hidden="true" tabindex="-1"></a>Gamma and Log-Normal are popular for modeling **positive continuous noise**—especially when counts or demand cannot be negative and may have **skewness**.</span>
<span id="cb63-610"><a href="#cb63-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-611"><a href="#cb63-611" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> style</span><span class="op">=</span><span class="st">"text-align: center;"</span><span class="dt">&gt;</span></span>
<span id="cb63-612"><a href="#cb63-612" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">img</span><span class="ot"> src</span><span class="op">=</span><span class="st">"/images/gamma_distribution_pdf.png"</span><span class="ot"> alt</span><span class="op">=</span><span class="st">"Gamma Distribution"</span><span class="ot"> width</span><span class="op">=</span><span class="st">"75%"</span><span class="dt">&gt;</span></span>
<span id="cb63-613"><a href="#cb63-613" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb63-614"><a href="#cb63-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-615"><a href="#cb63-615" aria-hidden="true" tabindex="-1"></a>**Distribution:**  </span>
<span id="cb63-616"><a href="#cb63-616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-617"><a href="#cb63-617" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-618"><a href="#cb63-618" aria-hidden="true" tabindex="-1"></a>f(x; k, \theta) = </span>
<span id="cb63-619"><a href="#cb63-619" aria-hidden="true" tabindex="-1"></a>\frac{1}{\Gamma(k)\,\theta^{k}}\,x^{k - 1} e^{-x / \theta}, </span>
<span id="cb63-620"><a href="#cb63-620" aria-hidden="true" tabindex="-1"></a>\quad x &gt; 0</span>
<span id="cb63-621"><a href="#cb63-621" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-622"><a href="#cb63-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-623"><a href="#cb63-623" aria-hidden="true" tabindex="-1"></a>**Parameters:** **shape** $k$, **scale** $\theta$, and $\Gamma(k)$ is the Gamma function defined as  </span>
<span id="cb63-624"><a href="#cb63-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-625"><a href="#cb63-625" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-626"><a href="#cb63-626" aria-hidden="true" tabindex="-1"></a>\Gamma(k) = \int_0^\infty t^{k - 1} e^{-t} dt</span>
<span id="cb63-627"><a href="#cb63-627" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-628"><a href="#cb63-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-629"><a href="#cb63-629" aria-hidden="true" tabindex="-1"></a>**Mean:**  </span>
<span id="cb63-630"><a href="#cb63-630" aria-hidden="true" tabindex="-1"></a>$kθ$</span>
<span id="cb63-631"><a href="#cb63-631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-632"><a href="#cb63-632" aria-hidden="true" tabindex="-1"></a>**Variance:**  </span>
<span id="cb63-633"><a href="#cb63-633" aria-hidden="true" tabindex="-1"></a>$kθ^2$</span>
<span id="cb63-634"><a href="#cb63-634" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-635"><a href="#cb63-635" aria-hidden="true" tabindex="-1"></a>**Notes:**  </span>
<span id="cb63-636"><a href="#cb63-636" aria-hidden="true" tabindex="-1"></a>Often used for modeling **waiting times** or **non-negative skewed demand**.</span>
<span id="cb63-637"><a href="#cb63-637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-640"><a href="#cb63-640" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-641"><a href="#cb63-641" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: noisy_ts_gamma_plot</span></span>
<span id="cb63-642"><a href="#cb63-642" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">102938</span>)</span>
<span id="cb63-643"><a href="#cb63-643" aria-hidden="true" tabindex="-1"></a>shape_gamma <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb63-644"><a href="#cb63-644" aria-hidden="true" tabindex="-1"></a>scale_gamma <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb63-645"><a href="#cb63-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-646"><a href="#cb63-646" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&lt;&gt;%</span></span>
<span id="cb63-647"><a href="#cb63-647" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">noi_gamma =</span> <span class="fu">rgamma</span>(<span class="fu">nrow</span>(df_sea), <span class="at">shape =</span> shape_gamma, <span class="at">scale =</span> scale_gamma),</span>
<span id="cb63-648"><a href="#cb63-648" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_lin_gamma =</span> yd_lin <span class="sc">+</span> noi_gamma,</span>
<span id="cb63-649"><a href="#cb63-649" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_exp_gamma =</span> (start_ts <span class="sc">+</span> sea <span class="sc">+</span> noi_gamma) <span class="sc">*</span> <span class="fu">exp</span>(<span class="fl">0.1</span> <span class="sc">/</span> <span class="dv">365</span>)<span class="sc">^</span><span class="fu">row_number</span>())</span>
<span id="cb63-650"><a href="#cb63-650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-651"><a href="#cb63-651" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&gt;%</span> </span>
<span id="cb63-652"><a href="#cb63-652" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(tr_lin, tr_exp, y_lin_gamma, y_exp_gamma), </span>
<span id="cb63-653"><a href="#cb63-653" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">"func"</span>, <span class="st">"method"</span>), </span>
<span id="cb63-654"><a href="#cb63-654" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_sep =</span> <span class="st">"_"</span>, </span>
<span id="cb63-655"><a href="#cb63-655" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb63-656"><a href="#cb63-656" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">func =</span> <span class="fu">factor</span>(func, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"y"</span>, <span class="st">"tr"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb63-657"><a href="#cb63-657" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb63-658"><a href="#cb63-658" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb63-659"><a href="#cb63-659" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> method,</span>
<span id="cb63-660"><a href="#cb63-660" aria-hidden="true" tabindex="-1"></a>                  <span class="at">linetype =</span> func),</span>
<span id="cb63-661"><a href="#cb63-661" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb63-662"><a href="#cb63-662" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Additive Gamma Noise"</span>,</span>
<span id="cb63-663"><a href="#cb63-663" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Value"</span>, <span class="at">x =</span> <span class="st">"Date"</span>)</span>
<span id="cb63-664"><a href="#cb63-664" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-665"><a href="#cb63-665" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-666"><a href="#cb63-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-667"><a href="#cb63-667" aria-hidden="true" tabindex="-1"></a><span class="fu">### Log-Normal noise</span></span>
<span id="cb63-668"><a href="#cb63-668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-669"><a href="#cb63-669" aria-hidden="true" tabindex="-1"></a>A **strictly positive**, **skewed** distribution.</span>
<span id="cb63-670"><a href="#cb63-670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-671"><a href="#cb63-671" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> style</span><span class="op">=</span><span class="st">"text-align: center;"</span><span class="dt">&gt;</span></span>
<span id="cb63-672"><a href="#cb63-672" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">img</span><span class="ot"> src</span><span class="op">=</span><span class="st">"/images/log_normal_distribution.png"</span><span class="ot"> alt</span><span class="op">=</span><span class="st">"Log-normal Distribution"</span><span class="ot"> width</span><span class="op">=</span><span class="st">"75%"</span><span class="dt">&gt;</span></span>
<span id="cb63-673"><a href="#cb63-673" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb63-674"><a href="#cb63-674" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-675"><a href="#cb63-675" aria-hidden="true" tabindex="-1"></a>**Distribution:**  </span>
<span id="cb63-676"><a href="#cb63-676" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-677"><a href="#cb63-677" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-678"><a href="#cb63-678" aria-hidden="true" tabindex="-1"></a>f(x; \mu, \sigma) = </span>
<span id="cb63-679"><a href="#cb63-679" aria-hidden="true" tabindex="-1"></a>\frac{1}{x\,\sigma\,\sqrt{2\pi}} </span>
<span id="cb63-680"><a href="#cb63-680" aria-hidden="true" tabindex="-1"></a>\exp\left( -\frac{(\ln x - \mu)^2}{2\sigma^2} \right),</span>
<span id="cb63-681"><a href="#cb63-681" aria-hidden="true" tabindex="-1"></a>\quad x &gt; 0</span>
<span id="cb63-682"><a href="#cb63-682" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-683"><a href="#cb63-683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-684"><a href="#cb63-684" aria-hidden="true" tabindex="-1"></a>**Parameters:** log-mean $\mu$, log-standard deviation $\sigma$  </span>
<span id="cb63-685"><a href="#cb63-685" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-686"><a href="#cb63-686" aria-hidden="true" tabindex="-1"></a>**Mean:**  </span>
<span id="cb63-687"><a href="#cb63-687" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-688"><a href="#cb63-688" aria-hidden="true" tabindex="-1"></a>\ E(X) = exp(\mu + \sigma^2 / 2)</span>
<span id="cb63-689"><a href="#cb63-689" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-690"><a href="#cb63-690" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-691"><a href="#cb63-691" aria-hidden="true" tabindex="-1"></a>**Variance:**  </span>
<span id="cb63-692"><a href="#cb63-692" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-693"><a href="#cb63-693" aria-hidden="true" tabindex="-1"></a>Var(X) = (\exp(\sigma^2) - 1) \exp(2\mu + \sigma^2)</span>
<span id="cb63-694"><a href="#cb63-694" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-695"><a href="#cb63-695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-696"><a href="#cb63-696" aria-hidden="true" tabindex="-1"></a>**Notes:**  </span>
<span id="cb63-697"><a href="#cb63-697" aria-hidden="true" tabindex="-1"></a>Often used when noise **multiplicatively affects the signal**.</span>
<span id="cb63-698"><a href="#cb63-698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-701"><a href="#cb63-701" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-702"><a href="#cb63-702" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: noisy_ts_lognorm_plot</span></span>
<span id="cb63-703"><a href="#cb63-703" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">102938</span>)</span>
<span id="cb63-704"><a href="#cb63-704" aria-hidden="true" tabindex="-1"></a>mu_lognorm <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb63-705"><a href="#cb63-705" aria-hidden="true" tabindex="-1"></a>sigma_lognorm <span class="ot">&lt;-</span> <span class="fl">0.3</span></span>
<span id="cb63-706"><a href="#cb63-706" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-707"><a href="#cb63-707" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&lt;&gt;%</span></span>
<span id="cb63-708"><a href="#cb63-708" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">noi_lognorm =</span> <span class="fu">rlnorm</span>(<span class="fu">nrow</span>(df_sea), <span class="at">meanlog =</span> mu_lognorm, <span class="at">sdlog =</span> sigma_lognorm),</span>
<span id="cb63-709"><a href="#cb63-709" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_lin_lognorm =</span> yd_lin <span class="sc">+</span> noi_lognorm,</span>
<span id="cb63-710"><a href="#cb63-710" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_exp_lognorm =</span> (start_ts <span class="sc">+</span> sea <span class="sc">+</span> noi_lognorm) <span class="sc">*</span> <span class="fu">exp</span>(<span class="fl">0.1</span> <span class="sc">/</span> <span class="dv">365</span>)<span class="sc">^</span><span class="fu">row_number</span>())</span>
<span id="cb63-711"><a href="#cb63-711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-712"><a href="#cb63-712" aria-hidden="true" tabindex="-1"></a>df_sea <span class="sc">%&gt;%</span> </span>
<span id="cb63-713"><a href="#cb63-713" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(tr_lin, tr_exp, y_lin_lognorm, y_exp_lognorm), </span>
<span id="cb63-714"><a href="#cb63-714" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">"func"</span>, <span class="st">"method"</span>), </span>
<span id="cb63-715"><a href="#cb63-715" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_sep =</span> <span class="st">"_"</span>, </span>
<span id="cb63-716"><a href="#cb63-716" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb63-717"><a href="#cb63-717" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">func =</span> <span class="fu">factor</span>(func, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"y"</span>, <span class="st">"tr"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb63-718"><a href="#cb63-718" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb63-719"><a href="#cb63-719" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb63-720"><a href="#cb63-720" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> method,</span>
<span id="cb63-721"><a href="#cb63-721" aria-hidden="true" tabindex="-1"></a>                  <span class="at">linetype =</span> func),</span>
<span id="cb63-722"><a href="#cb63-722" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb63-723"><a href="#cb63-723" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Additive Log-Normal Noise"</span>,</span>
<span id="cb63-724"><a href="#cb63-724" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Value"</span>, <span class="at">x =</span> <span class="st">"Date"</span>)</span>
<span id="cb63-725"><a href="#cb63-725" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-726"><a href="#cb63-726" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-727"><a href="#cb63-727" aria-hidden="true" tabindex="-1"></a><span class="fu"># TS noise modelling</span></span>
<span id="cb63-728"><a href="#cb63-728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-729"><a href="#cb63-729" aria-hidden="true" tabindex="-1"></a><span class="fu">## Review of the additive model</span></span>
<span id="cb63-730"><a href="#cb63-730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-731"><a href="#cb63-731" aria-hidden="true" tabindex="-1"></a>We re-use the synthetic data from last week, which follows an **additive decomposition** of the form:</span>
<span id="cb63-732"><a href="#cb63-732" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-733"><a href="#cb63-733" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-734"><a href="#cb63-734" aria-hidden="true" tabindex="-1"></a>y(t) = tr(t) + s(t) + \epsilon_t</span>
<span id="cb63-735"><a href="#cb63-735" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-736"><a href="#cb63-736" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-737"><a href="#cb63-737" aria-hidden="true" tabindex="-1"></a><span class="fu">### Load the data</span></span>
<span id="cb63-738"><a href="#cb63-738" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-741"><a href="#cb63-741" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-742"><a href="#cb63-742" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: load-df-ts1</span></span>
<span id="cb63-743"><a href="#cb63-743" aria-hidden="true" tabindex="-1"></a>data_dir <span class="ot">&lt;-</span> <span class="st">"./data"</span></span>
<span id="cb63-744"><a href="#cb63-744" aria-hidden="true" tabindex="-1"></a>fpath_df_ts1 <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{data_dir}/synthetic_TS_01.tsv"</span>)</span>
<span id="cb63-745"><a href="#cb63-745" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-746"><a href="#cb63-746" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="ot">&lt;-</span> </span>
<span id="cb63-747"><a href="#cb63-747" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_tsv</span>(fpath_df_ts1) <span class="sc">%&gt;%</span></span>
<span id="cb63-748"><a href="#cb63-748" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(day, mon, sea, tr_lin, yd_lin, noi, y_lin) <span class="sc">%&gt;%</span></span>
<span id="cb63-749"><a href="#cb63-749" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">tr =</span> tr_lin, <span class="at">yd =</span> yd_lin, <span class="at">y =</span> y_lin) <span class="sc">%&gt;%</span></span>
<span id="cb63-750"><a href="#cb63-750" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">year</span>(day)) <span class="sc">%&gt;%</span></span>
<span id="cb63-751"><a href="#cb63-751" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(year)</span>
<span id="cb63-752"><a href="#cb63-752" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-753"><a href="#cb63-753" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-754"><a href="#cb63-754" aria-hidden="true" tabindex="-1"></a><span class="fu">### Trend component</span></span>
<span id="cb63-755"><a href="#cb63-755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-756"><a href="#cb63-756" aria-hidden="true" tabindex="-1"></a>The trend is modeled as a linear function of time:</span>
<span id="cb63-757"><a href="#cb63-757" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-758"><a href="#cb63-758" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-759"><a href="#cb63-759" aria-hidden="true" tabindex="-1"></a>tr(t) = y_0 + \alpha.\frac{t}{365}</span>
<span id="cb63-760"><a href="#cb63-760" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-761"><a href="#cb63-761" aria-hidden="true" tabindex="-1"></a>We can recover the parameters $y_0$ (intercept) and $\alpha$ (slope) as follows:</span>
<span id="cb63-762"><a href="#cb63-762" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-765"><a href="#cb63-765" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-766"><a href="#cb63-766" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: recover-trend-params</span></span>
<span id="cb63-767"><a href="#cb63-767" aria-hidden="true" tabindex="-1"></a>y0_o   <span class="ot">&lt;-</span> df_ts1<span class="sc">$</span>tr[<span class="dv">1</span>] <span class="sc">%&gt;%</span> round</span>
<span id="cb63-768"><a href="#cb63-768" aria-hidden="true" tabindex="-1"></a>alfa_o <span class="ot">&lt;-</span> df_ts1<span class="sc">$</span>tr[<span class="dv">366</span>] <span class="sc">-</span> df_ts1<span class="sc">$</span>tr[<span class="dv">1</span>]</span>
<span id="cb63-769"><a href="#cb63-769" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-770"><a href="#cb63-770" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-771"><a href="#cb63-771" aria-hidden="true" tabindex="-1"></a>Hence  </span>
<span id="cb63-772"><a href="#cb63-772" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$y_0 =$ <span class="in">`r y0_o`</span>.  </span>
<span id="cb63-773"><a href="#cb63-773" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\alpha =$ <span class="in">`r alfa_o`</span></span>
<span id="cb63-774"><a href="#cb63-774" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-775"><a href="#cb63-775" aria-hidden="true" tabindex="-1"></a><span class="fu">### Seasonal component</span></span>
<span id="cb63-776"><a href="#cb63-776" aria-hidden="true" tabindex="-1"></a>The seasonality is defined by a smooth repeating curve, shown below for the first year:</span>
<span id="cb63-777"><a href="#cb63-777" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-780"><a href="#cb63-780" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-781"><a href="#cb63-781" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: plot-sea-actual</span></span>
<span id="cb63-782"><a href="#cb63-782" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb63-783"><a href="#cb63-783" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">==</span> <span class="fu">min</span>(<span class="fu">as.numeric</span>(<span class="fu">as.character</span>(year)))) <span class="sc">%&gt;%</span></span>
<span id="cb63-784"><a href="#cb63-784" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> sea)) <span class="sc">+</span></span>
<span id="cb63-785"><a href="#cb63-785" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb63-786"><a href="#cb63-786" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Seasonal Component (First Year)"</span>,</span>
<span id="cb63-787"><a href="#cb63-787" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Day"</span>, <span class="at">y =</span> <span class="st">"Seasonal Effect"</span>)</span>
<span id="cb63-788"><a href="#cb63-788" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-789"><a href="#cb63-789" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-790"><a href="#cb63-790" aria-hidden="true" tabindex="-1"></a><span class="fu">### Original time series</span></span>
<span id="cb63-791"><a href="#cb63-791" aria-hidden="true" tabindex="-1"></a>The full modeled series, including the original Gaussian noise, is shown below:</span>
<span id="cb63-792"><a href="#cb63-792" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-795"><a href="#cb63-795" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-796"><a href="#cb63-796" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: plot-df-ts1</span></span>
<span id="cb63-797"><a href="#cb63-797" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span> </span>
<span id="cb63-798"><a href="#cb63-798" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day)) <span class="sc">+</span></span>
<span id="cb63-799"><a href="#cb63-799" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> y), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb63-800"><a href="#cb63-800" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> yd), <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb63-801"><a href="#cb63-801" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb63-802"><a href="#cb63-802" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Synthetic Time Series with Gaussian Noise"</span>,</span>
<span id="cb63-803"><a href="#cb63-803" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Day"</span>, <span class="at">y =</span> <span class="st">"Value"</span>)</span>
<span id="cb63-804"><a href="#cb63-804" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-805"><a href="#cb63-805" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-806"><a href="#cb63-806" aria-hidden="true" tabindex="-1"></a>Note that normal noise may be inappropriate for _count-type data_, since it can generate negative forecasts—an issue that motivates the following noise models.</span>
<span id="cb63-807"><a href="#cb63-807" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-808"><a href="#cb63-808" aria-hidden="true" tabindex="-1"></a><span class="fu">## Noise with constant rate</span></span>
<span id="cb63-809"><a href="#cb63-809" aria-hidden="true" tabindex="-1"></a>Let the noise follow a Poisson distribution with constant rate $\lambda_0 = 2$</span>
<span id="cb63-810"><a href="#cb63-810" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-811"><a href="#cb63-811" aria-hidden="true" tabindex="-1"></a>Because the Poisson mean equals its variance, we re-center the generated noise to preserve a mean of zero and avoid negative forecasts.</span>
<span id="cb63-812"><a href="#cb63-812" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-815"><a href="#cb63-815" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-816"><a href="#cb63-816" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: generate-constant-pois-noise</span></span>
<span id="cb63-817"><a href="#cb63-817" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2831</span>)</span>
<span id="cb63-818"><a href="#cb63-818" aria-hidden="true" tabindex="-1"></a>lam_0 <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb63-819"><a href="#cb63-819" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-820"><a href="#cb63-820" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb63-821"><a href="#cb63-821" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">noi_cnst =</span> <span class="fu">rpois</span>(<span class="at">n =</span> <span class="fu">nrow</span>(.), <span class="at">lambda =</span> lam_0) <span class="sc">-</span> <span class="fu">min</span>(<span class="fu">c</span>(lam_0, <span class="fu">min</span>(yd))),</span>
<span id="cb63-822"><a href="#cb63-822" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_1 =</span> yd <span class="sc">+</span> noi_cnst)</span>
<span id="cb63-823"><a href="#cb63-823" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-824"><a href="#cb63-824" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">|&gt;</span></span>
<span id="cb63-825"><a href="#cb63-825" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day)) <span class="sc">+</span></span>
<span id="cb63-826"><a href="#cb63-826" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> y_1), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb63-827"><a href="#cb63-827" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> yd), <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb63-828"><a href="#cb63-828" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb63-829"><a href="#cb63-829" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Time Series with Constant-Rate Poisson Noise"</span>,</span>
<span id="cb63-830"><a href="#cb63-830" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Day"</span>, <span class="at">y =</span> <span class="st">"Value"</span>)</span>
<span id="cb63-831"><a href="#cb63-831" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-832"><a href="#cb63-832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-833"><a href="#cb63-833" aria-hidden="true" tabindex="-1"></a><span class="fu">## Noise with proportional rate</span></span>
<span id="cb63-834"><a href="#cb63-834" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-835"><a href="#cb63-835" aria-hidden="true" tabindex="-1"></a>In many real-world processes, **noise magnitude increases with the signal level**. This can be the case for sales, demand, or production volumes, where fluctuations scale with the size of operations.</span>
<span id="cb63-836"><a href="#cb63-836" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-837"><a href="#cb63-837" aria-hidden="true" tabindex="-1"></a>For example:\</span>
<span id="cb63-838"><a href="#cb63-838" aria-hidden="true" tabindex="-1"></a>If one trailer delivery is missed due to a strike when demand is low, a tenfold demand would imply a missed delivery of ten trailers — illustrating proportional noise.</span>
<span id="cb63-839"><a href="#cb63-839" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-840"><a href="#cb63-840" aria-hidden="true" tabindex="-1"></a><span class="fu">### Additive interpretation</span></span>
<span id="cb63-841"><a href="#cb63-841" aria-hidden="true" tabindex="-1"></a>We can still express the model additively as:</span>
<span id="cb63-842"><a href="#cb63-842" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-843"><a href="#cb63-843" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-844"><a href="#cb63-844" aria-hidden="true" tabindex="-1"></a>y(t) = tr(t) + s(t) + \epsilon_t</span>
<span id="cb63-845"><a href="#cb63-845" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-846"><a href="#cb63-846" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-847"><a href="#cb63-847" aria-hidden="true" tabindex="-1"></a>where  </span>
<span id="cb63-848"><a href="#cb63-848" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-849"><a href="#cb63-849" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-850"><a href="#cb63-850" aria-hidden="true" tabindex="-1"></a>\epsilon_t \sim \mathrm{Pois}(\lambda_t), \quad \lambda_t \propto y_t^{\text{(d)}} = tr(t) + s(t)</span>
<span id="cb63-851"><a href="#cb63-851" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-852"><a href="#cb63-852" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-853"><a href="#cb63-853" aria-hidden="true" tabindex="-1"></a><span class="fu">### Multiplicative equivalence</span></span>
<span id="cb63-854"><a href="#cb63-854" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-855"><a href="#cb63-855" aria-hidden="true" tabindex="-1"></a>This is equivalent to a multiplicative noise model:</span>
<span id="cb63-856"><a href="#cb63-856" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-857"><a href="#cb63-857" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-858"><a href="#cb63-858" aria-hidden="true" tabindex="-1"></a>y(t) = (tr(t) + s(t)).\eta_t</span>
<span id="cb63-859"><a href="#cb63-859" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-860"><a href="#cb63-860" aria-hidden="true" tabindex="-1"></a>where $\eta_t$ is a Poisson-like random multiplier with constant mean.</span>
<span id="cb63-861"><a href="#cb63-861" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb63-862"><a href="#cb63-862" aria-hidden="true" tabindex="-1"></a><span class="fu">### Implementation</span></span>
<span id="cb63-863"><a href="#cb63-863" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-864"><a href="#cb63-864" aria-hidden="true" tabindex="-1"></a>We simulate proportional noise with a constant scaling factor $c_\lambda = 0.4$:</span>
<span id="cb63-865"><a href="#cb63-865" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-868"><a href="#cb63-868" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-869"><a href="#cb63-869" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: generate-proportional-pois-noise</span></span>
<span id="cb63-870"><a href="#cb63-870" aria-hidden="true" tabindex="-1"></a>const_lam <span class="ot">&lt;-</span> <span class="fl">0.4</span></span>
<span id="cb63-871"><a href="#cb63-871" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-872"><a href="#cb63-872" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123098</span>)</span>
<span id="cb63-873"><a href="#cb63-873" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb63-874"><a href="#cb63-874" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">lam      =</span> const_lam <span class="sc">*</span> yd,</span>
<span id="cb63-875"><a href="#cb63-875" aria-hidden="true" tabindex="-1"></a>         <span class="at">noi_prop =</span> <span class="fu">map_dbl</span>(lam, <span class="sc">~</span> <span class="fu">rpois</span>(<span class="dv">1</span>, <span class="at">lambda =</span> .x) <span class="sc">-</span> .x),</span>
<span id="cb63-876"><a href="#cb63-876" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_2      =</span> yd <span class="sc">+</span> noi_prop)</span>
<span id="cb63-877"><a href="#cb63-877" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-878"><a href="#cb63-878" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb63-879"><a href="#cb63-879" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(day, yd, y_1, y_2) <span class="sc">%&gt;%</span></span>
<span id="cb63-880"><a href="#cb63-880" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb63-881"><a href="#cb63-881" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(y_1, y_2),</span>
<span id="cb63-882"><a href="#cb63-882" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"method"</span>,</span>
<span id="cb63-883"><a href="#cb63-883" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"TS_value"</span></span>
<span id="cb63-884"><a href="#cb63-884" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb63-885"><a href="#cb63-885" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">method =</span> <span class="fu">recode</span>(</span>
<span id="cb63-886"><a href="#cb63-886" aria-hidden="true" tabindex="-1"></a>    method,</span>
<span id="cb63-887"><a href="#cb63-887" aria-hidden="true" tabindex="-1"></a>    <span class="at">y_1 =</span> <span class="st">"Constant-rate Poisson noise"</span>,</span>
<span id="cb63-888"><a href="#cb63-888" aria-hidden="true" tabindex="-1"></a>    <span class="at">y_2 =</span> <span class="st">"Proportional-rate Poisson noise"</span></span>
<span id="cb63-889"><a href="#cb63-889" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb63-890"><a href="#cb63-890" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> TS_value)) <span class="sc">+</span></span>
<span id="cb63-891"><a href="#cb63-891" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> method), <span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb63-892"><a href="#cb63-892" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> yd), <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb63-893"><a href="#cb63-893" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb63-894"><a href="#cb63-894" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> method, <span class="at">ncol =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb63-895"><a href="#cb63-895" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb63-896"><a href="#cb63-896" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Constant vs Proportional Poisson Noise"</span>,</span>
<span id="cb63-897"><a href="#cb63-897" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Day"</span>,</span>
<span id="cb63-898"><a href="#cb63-898" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Value"</span></span>
<span id="cb63-899"><a href="#cb63-899" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb63-900"><a href="#cb63-900" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb63-901"><a href="#cb63-901" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-902"><a href="#cb63-902" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-903"><a href="#cb63-903" aria-hidden="true" tabindex="-1"></a><span class="fu">### Interpretation</span></span>
<span id="cb63-904"><a href="#cb63-904" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-905"><a href="#cb63-905" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The constant-rate noise adds fluctuations of fixed variance, independent of the signal.</span>
<span id="cb63-906"><a href="#cb63-906" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The proportional-rate noise scales with the signal amplitude, resembling multiplicative variability commonly seen in business and supply-chain processes.</span>
<span id="cb63-907"><a href="#cb63-907" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-908"><a href="#cb63-908" aria-hidden="true" tabindex="-1"></a><span class="fu">## Analysis</span></span>
<span id="cb63-909"><a href="#cb63-909" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-910"><a href="#cb63-910" aria-hidden="true" tabindex="-1"></a><span class="fu">### Visualizing yearly seasonality</span></span>
<span id="cb63-911"><a href="#cb63-911" aria-hidden="true" tabindex="-1"></a>When we suspect seasonality, such as yearly patterns, it can be insightful to overlay the time series data by year.</span>
<span id="cb63-912"><a href="#cb63-912" aria-hidden="true" tabindex="-1"></a>This allows us to visually compare the dynamics of each year and identify recurring seasonal behaviors.</span>
<span id="cb63-913"><a href="#cb63-913" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-914"><a href="#cb63-914" aria-hidden="true" tabindex="-1"></a><span class="in">```{r overlay-yearly-ts}</span></span>
<span id="cb63-915"><a href="#cb63-915" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb63-916"><a href="#cb63-916" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb63-917"><a href="#cb63-917" aria-hidden="true" tabindex="-1"></a>    <span class="at">year =</span> <span class="fu">factor</span>(<span class="fu">year</span>(day)),</span>
<span id="cb63-918"><a href="#cb63-918" aria-hidden="true" tabindex="-1"></a>    <span class="at">date_no_year =</span> day</span>
<span id="cb63-919"><a href="#cb63-919" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb63-920"><a href="#cb63-920" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(<span class="fu">c</span>(year, date_no_year), <span class="at">.after =</span> day)</span>
<span id="cb63-921"><a href="#cb63-921" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-922"><a href="#cb63-922" aria-hidden="true" tabindex="-1"></a><span class="fu">year</span>(df_ts1<span class="sc">$</span>date_no_year) <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb63-923"><a href="#cb63-923" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-924"><a href="#cb63-924" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb63-925"><a href="#cb63-925" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date_no_year, <span class="at">y =</span> y_2)) <span class="sc">+</span></span>
<span id="cb63-926"><a href="#cb63-926" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> year, <span class="at">color =</span> year), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb63-927"><a href="#cb63-927" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb63-928"><a href="#cb63-928" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Overlay of Yearly Time Series"</span>,</span>
<span id="cb63-929"><a href="#cb63-929" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Day (within year)"</span>,</span>
<span id="cb63-930"><a href="#cb63-930" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Value"</span>,</span>
<span id="cb63-931"><a href="#cb63-931" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Year"</span></span>
<span id="cb63-932"><a href="#cb63-932" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb63-933"><a href="#cb63-933" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-934"><a href="#cb63-934" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-935"><a href="#cb63-935" aria-hidden="true" tabindex="-1"></a>We already observe a recurring yearly pattern, especially toward the end of the year.</span>
<span id="cb63-936"><a href="#cb63-936" aria-hidden="true" tabindex="-1"></a>This suggests a combination of trend and seasonality in the data, which we now aim to analyze more formally.</span>
<span id="cb63-937"><a href="#cb63-937" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-938"><a href="#cb63-938" aria-hidden="true" tabindex="-1"></a><span class="fu">###  Trend analysis</span></span>
<span id="cb63-939"><a href="#cb63-939" aria-hidden="true" tabindex="-1"></a>We begin by estimating the trend component, since it represents the longer-term structure of the series.\</span>
<span id="cb63-940"><a href="#cb63-940" aria-hidden="true" tabindex="-1"></a>Seasonality can then be analyzed more effectively once the trend has been accounted for.</span>
<span id="cb63-941"><a href="#cb63-941" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-942"><a href="#cb63-942" aria-hidden="true" tabindex="-1"></a>We compare different **trend modeling** approaches:</span>
<span id="cb63-943"><a href="#cb63-943" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-944"><a href="#cb63-944" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Linear Trend: the simplest baseline model.</span>
<span id="cb63-945"><a href="#cb63-945" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Nonlinear Trends using flexible smoothers:</span>
<span id="cb63-946"><a href="#cb63-946" aria-hidden="true" tabindex="-1"></a><span class="ss">  + </span>LOESS (Locally Weighted Scatterplot Smoothing)</span>
<span id="cb63-947"><a href="#cb63-947" aria-hidden="true" tabindex="-1"></a><span class="ss">  + </span>GAM (Generalized Additive Model)</span>
<span id="cb63-948"><a href="#cb63-948" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-949"><a href="#cb63-949" aria-hidden="true" tabindex="-1"></a><span class="in">```{r fitting-yearly-trend}</span></span>
<span id="cb63-950"><a href="#cb63-950" aria-hidden="true" tabindex="-1"></a>loess_span_high <span class="ot">&lt;-</span> <span class="fl">0.75</span></span>
<span id="cb63-951"><a href="#cb63-951" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-952"><a href="#cb63-952" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb63-953"><a href="#cb63-953" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>(<span class="at">data =</span> <span class="sc">-</span>year)  <span class="sc">%&gt;%</span></span>
<span id="cb63-954"><a href="#cb63-954" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb63-955"><a href="#cb63-955" aria-hidden="true" tabindex="-1"></a>    <span class="at">lm_tr =</span> <span class="fu">map</span>(</span>
<span id="cb63-956"><a href="#cb63-956" aria-hidden="true" tabindex="-1"></a>      year,</span>
<span id="cb63-957"><a href="#cb63-957" aria-hidden="true" tabindex="-1"></a>      <span class="sc">~</span> <span class="fu">lm</span>(y_2 <span class="sc">~</span> day, <span class="at">data =</span> df_ts1  <span class="sc">%&gt;%</span> <span class="fu">filter</span>(year <span class="sc">==</span> .x))</span>
<span id="cb63-958"><a href="#cb63-958" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb63-959"><a href="#cb63-959" aria-hidden="true" tabindex="-1"></a>    <span class="at">loes_tr =</span> <span class="fu">map</span>(</span>
<span id="cb63-960"><a href="#cb63-960" aria-hidden="true" tabindex="-1"></a>      year,</span>
<span id="cb63-961"><a href="#cb63-961" aria-hidden="true" tabindex="-1"></a>      <span class="sc">~</span> <span class="fu">loess</span>(y_2 <span class="sc">~</span> <span class="fu">as.numeric</span>(day),</span>
<span id="cb63-962"><a href="#cb63-962" aria-hidden="true" tabindex="-1"></a>              <span class="at">data =</span> df_ts1  <span class="sc">%&gt;%</span> <span class="fu">filter</span>(year <span class="sc">==</span> .x),</span>
<span id="cb63-963"><a href="#cb63-963" aria-hidden="true" tabindex="-1"></a>              <span class="at">span =</span> loess_span_high)</span>
<span id="cb63-964"><a href="#cb63-964" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb63-965"><a href="#cb63-965" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">map2</span>(data, lm_tr, <span class="sc">~</span> <span class="fu">mutate</span>(.x, <span class="at">try_lm =</span> .y<span class="sc">$</span>fitted)),</span>
<span id="cb63-966"><a href="#cb63-966" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">map2</span>(data, loes_tr, <span class="sc">~</span> <span class="fu">mutate</span>(.x, <span class="at">try_lo =</span> .y<span class="sc">$</span>fitted))</span>
<span id="cb63-967"><a href="#cb63-967" aria-hidden="true" tabindex="-1"></a>  )  <span class="sc">%&gt;%</span></span>
<span id="cb63-968"><a href="#cb63-968" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(lm_tr, loes_tr))  <span class="sc">%&gt;%</span></span>
<span id="cb63-969"><a href="#cb63-969" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(data)</span>
<span id="cb63-970"><a href="#cb63-970" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-971"><a href="#cb63-971" aria-hidden="true" tabindex="-1"></a>df_ts1  <span class="sc">%&gt;%</span></span>
<span id="cb63-972"><a href="#cb63-972" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date_no_year, <span class="at">y =</span> y_2)) <span class="sc">+</span></span>
<span id="cb63-973"><a href="#cb63-973" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> year, <span class="at">color =</span> year), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb63-974"><a href="#cb63-974" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> try_lm, <span class="at">group =</span> year), <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb63-975"><a href="#cb63-975" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> try_lo, <span class="at">group =</span> year), <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb63-976"><a href="#cb63-976" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb63-977"><a href="#cb63-977" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Yearly Trend Fitting: Linear (Blue) vs LOESS (Red)"</span>,</span>
<span id="cb63-978"><a href="#cb63-978" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Day (within year)"</span>,</span>
<span id="cb63-979"><a href="#cb63-979" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Value"</span>,</span>
<span id="cb63-980"><a href="#cb63-980" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Year"</span></span>
<span id="cb63-981"><a href="#cb63-981" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb63-982"><a href="#cb63-982" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-983"><a href="#cb63-983" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-984"><a href="#cb63-984" aria-hidden="true" tabindex="-1"></a>Here,</span>
<span id="cb63-985"><a href="#cb63-985" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-986"><a href="#cb63-986" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Blue lines represent the fitted linear trends, and</span>
<span id="cb63-987"><a href="#cb63-987" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Red curves show the LOESS-smoothed trends (with span = <span class="in">`r loess_span_high`</span>).</span>
<span id="cb63-988"><a href="#cb63-988" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-989"><a href="#cb63-989" aria-hidden="true" tabindex="-1"></a>We see a reasonable degree of consistency across years, though some discrepancies appear in incomplete years (e.g., 2025).\</span>
<span id="cb63-990"><a href="#cb63-990" aria-hidden="true" tabindex="-1"></a>However, analyzing each year independently is not ideal for identifying the overall trend, since the yearly boundaries do not necessarily align smoothly from one year to the next.</span>
<span id="cb63-991"><a href="#cb63-991" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-992"><a href="#cb63-992" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Continuous trend estimation</span></span>
<span id="cb63-993"><a href="#cb63-993" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-994"><a href="#cb63-994" aria-hidden="true" tabindex="-1"></a>To capture a coherent view of the long-term evolution, we re-estimate the trend over the entire time span.</span>
<span id="cb63-995"><a href="#cb63-995" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-996"><a href="#cb63-996" aria-hidden="true" tabindex="-1"></a>We compare:</span>
<span id="cb63-997"><a href="#cb63-997" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-998"><a href="#cb63-998" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Linear trend (black)</span>
<span id="cb63-999"><a href="#cb63-999" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>LOESS smoothing with:</span>
<span id="cb63-1000"><a href="#cb63-1000" aria-hidden="true" tabindex="-1"></a><span class="ss">  + </span>Medium span (<span class="in">`0.5`</span>) — blue curve</span>
<span id="cb63-1001"><a href="#cb63-1001" aria-hidden="true" tabindex="-1"></a><span class="ss">  + </span>Low span (<span class="in">`0.1`</span>) — red curve</span>
<span id="cb63-1002"><a href="#cb63-1002" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>GAM smoothing (dark green), with automatic smoothing and confidence bands</span>
<span id="cb63-1003"><a href="#cb63-1003" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1004"><a href="#cb63-1004" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-overoll-smoothing}</span></span>
<span id="cb63-1005"><a href="#cb63-1005" aria-hidden="true" tabindex="-1"></a>loess_span_med  <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb63-1006"><a href="#cb63-1006" aria-hidden="true" tabindex="-1"></a>loess_span_low <span class="ot">&lt;-</span> <span class="fl">0.1</span></span>
<span id="cb63-1007"><a href="#cb63-1007" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1008"><a href="#cb63-1008" aria-hidden="true" tabindex="-1"></a>lm_tr <span class="ot">&lt;-</span> <span class="fu">lm</span>(y_2 <span class="sc">~</span> day, <span class="at">data =</span> df_ts1)</span>
<span id="cb63-1009"><a href="#cb63-1009" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1010"><a href="#cb63-1010" aria-hidden="true" tabindex="-1"></a>lo_tr_1 <span class="ot">&lt;-</span> <span class="fu">loess</span>(y_2 <span class="sc">~</span> <span class="fu">as.numeric</span>(day),</span>
<span id="cb63-1011"><a href="#cb63-1011" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> df_ts1,</span>
<span id="cb63-1012"><a href="#cb63-1012" aria-hidden="true" tabindex="-1"></a>                 <span class="at">span =</span> loess_span_med)</span>
<span id="cb63-1013"><a href="#cb63-1013" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1014"><a href="#cb63-1014" aria-hidden="true" tabindex="-1"></a>lo_tr_2 <span class="ot">&lt;-</span> <span class="fu">loess</span>(y_2 <span class="sc">~</span> <span class="fu">as.numeric</span>(day),</span>
<span id="cb63-1015"><a href="#cb63-1015" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> df_ts1,</span>
<span id="cb63-1016"><a href="#cb63-1016" aria-hidden="true" tabindex="-1"></a>                 <span class="at">span =</span> loess_span_low)</span>
<span id="cb63-1017"><a href="#cb63-1017" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1018"><a href="#cb63-1018" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb63-1019"><a href="#cb63-1019" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb63-1020"><a href="#cb63-1020" aria-hidden="true" tabindex="-1"></a>    <span class="at">tr_lm   =</span> lm_tr<span class="sc">$</span>fitted,</span>
<span id="cb63-1021"><a href="#cb63-1021" aria-hidden="true" tabindex="-1"></a>    <span class="at">tr_lo_1 =</span> lo_tr_1<span class="sc">$</span>fitted,</span>
<span id="cb63-1022"><a href="#cb63-1022" aria-hidden="true" tabindex="-1"></a>    <span class="at">tr_lo_2 =</span> lo_tr_2<span class="sc">$</span>fitted</span>
<span id="cb63-1023"><a href="#cb63-1023" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb63-1024"><a href="#cb63-1024" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1025"><a href="#cb63-1025" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb63-1026"><a href="#cb63-1026" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> y_2)) <span class="sc">+</span></span>
<span id="cb63-1027"><a href="#cb63-1027" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> year, <span class="at">color =</span> year), <span class="at">alpha =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb63-1028"><a href="#cb63-1028" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tr_lm), <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb63-1029"><a href="#cb63-1029" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tr_lo_1), <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">linewidth =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb63-1030"><a href="#cb63-1030" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tr_lo_2), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb63-1031"><a href="#cb63-1031" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"gam"</span>, <span class="at">color =</span> <span class="st">"darkgreen"</span>, <span class="at">linewidth =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb63-1032"><a href="#cb63-1032" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb63-1033"><a href="#cb63-1033" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Global Trend Estimation with Various Smoothers"</span>,</span>
<span id="cb63-1034"><a href="#cb63-1034" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Day"</span>,</span>
<span id="cb63-1035"><a href="#cb63-1035" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Value"</span>,</span>
<span id="cb63-1036"><a href="#cb63-1036" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Year"</span></span>
<span id="cb63-1037"><a href="#cb63-1037" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb63-1038"><a href="#cb63-1038" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1039"><a href="#cb63-1039" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1040"><a href="#cb63-1040" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1041"><a href="#cb63-1041" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Interpretation</span></span>
<span id="cb63-1042"><a href="#cb63-1042" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1043"><a href="#cb63-1043" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The linear trend (black) provides a clear, interpretable long-term direction and fits the overall data well.</span>
<span id="cb63-1044"><a href="#cb63-1044" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1045"><a href="#cb63-1045" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The LOESS (low span, red) captures short-term fluctuations, overlapping with the seasonal pattern rather than isolating the true trend.</span>
<span id="cb63-1046"><a href="#cb63-1046" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1047"><a href="#cb63-1047" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The LOESS (medium span, blue) and GAM (dark green) curves strike a balance but tend to capture both slow seasonal and trend components simultaneously.</span>
<span id="cb63-1048"><a href="#cb63-1048" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1049"><a href="#cb63-1049" aria-hidden="true" tabindex="-1"></a>Hence, while linear smoothing suffices to characterize the long-term drift, nonlinear smoothers such as LOESS or GAM can help diagnose residual structure — valuable when refining the decomposition into trend, seasonality, and irregular components.</span>
<span id="cb63-1050"><a href="#cb63-1050" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1051"><a href="#cb63-1051" aria-hidden="true" tabindex="-1"></a><span class="fu">### Seasonality</span></span>
<span id="cb63-1052"><a href="#cb63-1052" aria-hidden="true" tabindex="-1"></a>After identifying the trend, the next step is to investigate seasonality.\</span>
<span id="cb63-1053"><a href="#cb63-1053" aria-hidden="true" tabindex="-1"></a>To do this, we can overlay the estimated seasonal curves for each year and look for repeating or shifting patterns.</span>
<span id="cb63-1054"><a href="#cb63-1054" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1055"><a href="#cb63-1055" aria-hidden="true" tabindex="-1"></a><span class="in">```{r seasonlity-curve-yoy}</span></span>
<span id="cb63-1056"><a href="#cb63-1056" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1057"><a href="#cb63-1057" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb63-1058"><a href="#cb63-1058" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date_no_year, <span class="at">y =</span> y_2)) <span class="sc">+</span></span>
<span id="cb63-1059"><a href="#cb63-1059" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> year, <span class="at">color =</span> year), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb63-1060"><a href="#cb63-1060" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tr_lo_2, <span class="at">color =</span> year, <span class="at">group =</span> year))</span>
<span id="cb63-1061"><a href="#cb63-1061" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1062"><a href="#cb63-1062" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1063"><a href="#cb63-1063" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1064"><a href="#cb63-1064" aria-hidden="true" tabindex="-1"></a>Indeed, there appears to be a **phase shift** across years — that is, the peaks and troughs of the seasonal pattern occur slightly earlier or later depending on the year.</span>
<span id="cb63-1065"><a href="#cb63-1065" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1066"><a href="#cb63-1066" aria-hidden="true" tabindex="-1"></a><span class="fu">#### De-trending and centering seasonality</span></span>
<span id="cb63-1067"><a href="#cb63-1067" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1068"><a href="#cb63-1068" aria-hidden="true" tabindex="-1"></a>To analyze seasonality more clearly, we should first remove the trend component so that the seasonal variation is centered around zero.\</span>
<span id="cb63-1069"><a href="#cb63-1069" aria-hidden="true" tabindex="-1"></a>This can be done by subtracting the estimated trend from the original time series:</span>
<span id="cb63-1070"><a href="#cb63-1070" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1071"><a href="#cb63-1071" aria-hidden="true" tabindex="-1"></a><span class="in">```{r seasonality-minus-trend}</span></span>
<span id="cb63-1072"><a href="#cb63-1072" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1073"><a href="#cb63-1073" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb63-1074"><a href="#cb63-1074" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y_notr =</span> y_2 <span class="sc">-</span> tr_lm)</span>
<span id="cb63-1075"><a href="#cb63-1075" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1076"><a href="#cb63-1076" aria-hidden="true" tabindex="-1"></a>sea_1 <span class="ot">&lt;-</span></span>
<span id="cb63-1077"><a href="#cb63-1077" aria-hidden="true" tabindex="-1"></a>  <span class="fu">loess</span>(df_ts1 <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">day =</span> <span class="fu">as.numeric</span>(day)),</span>
<span id="cb63-1078"><a href="#cb63-1078" aria-hidden="true" tabindex="-1"></a>        <span class="at">formula =</span> y_notr <span class="sc">~</span> day,</span>
<span id="cb63-1079"><a href="#cb63-1079" aria-hidden="true" tabindex="-1"></a>        <span class="at">span =</span> loess_span_low)</span>
<span id="cb63-1080"><a href="#cb63-1080" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1081"><a href="#cb63-1081" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb63-1082"><a href="#cb63-1082" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sea_lo =</span> sea_1<span class="sc">$</span>fitted)</span>
<span id="cb63-1083"><a href="#cb63-1083" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1084"><a href="#cb63-1084" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb63-1085"><a href="#cb63-1085" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date_no_year, <span class="at">y =</span> y_2)) <span class="sc">+</span></span>
<span id="cb63-1086"><a href="#cb63-1086" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> year, <span class="at">color =</span> year), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb63-1087"><a href="#cb63-1087" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> sea_lo, <span class="at">color =</span> year, <span class="at">group =</span> year), <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb63-1088"><a href="#cb63-1088" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tr_lm, <span class="at">group =</span> year, <span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb63-1089"><a href="#cb63-1089" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"black"</span>)</span>
<span id="cb63-1090"><a href="#cb63-1090" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1091"><a href="#cb63-1091" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1092"><a href="#cb63-1092" aria-hidden="true" tabindex="-1"></a>Once the trend is removed, the seasonal pattern becomes much more evident — confirming the phase shift between years.</span>
<span id="cb63-1093"><a href="#cb63-1093" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1094"><a href="#cb63-1094" aria-hidden="true" tabindex="-1"></a><span class="fu">### Noise extraction</span></span>
<span id="cb63-1095"><a href="#cb63-1095" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1096"><a href="#cb63-1096" aria-hidden="true" tabindex="-1"></a>Having decomposed the time series into trend and seasonality, the remaining residual component represents the noise:</span>
<span id="cb63-1097"><a href="#cb63-1097" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1098"><a href="#cb63-1098" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-1099"><a href="#cb63-1099" aria-hidden="true" tabindex="-1"></a>y(t) = tr(t) + s(t) + \epsilon_t</span>
<span id="cb63-1100"><a href="#cb63-1100" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-1101"><a href="#cb63-1101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1102"><a href="#cb63-1102" aria-hidden="true" tabindex="-1"></a><span class="in">```{r remove-trend-season-form-ts}</span></span>
<span id="cb63-1103"><a href="#cb63-1103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1104"><a href="#cb63-1104" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb63-1105"><a href="#cb63-1105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y_noi =</span> y_2 <span class="sc">-</span> tr_lm <span class="sc">-</span> sea_lo)</span>
<span id="cb63-1106"><a href="#cb63-1106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1107"><a href="#cb63-1107" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb63-1108"><a href="#cb63-1108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> y_noi)) <span class="sc">+</span></span>
<span id="cb63-1109"><a href="#cb63-1109" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb63-1110"><a href="#cb63-1110" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">as_date</span>(<span class="fu">c</span>(<span class="st">"2023-12-31"</span>, <span class="st">"2024-12-31"</span>))) <span class="sc">+</span></span>
<span id="cb63-1111"><a href="#cb63-1111" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>)</span>
<span id="cb63-1112"><a href="#cb63-1112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1113"><a href="#cb63-1113" aria-hidden="true" tabindex="-1"></a>noi_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(df_ts1<span class="sc">$</span>y_noi)</span>
<span id="cb63-1114"><a href="#cb63-1114" aria-hidden="true" tabindex="-1"></a>noi_var  <span class="ot">&lt;-</span> <span class="fu">var</span>(df_ts1<span class="sc">$</span>y_noi)</span>
<span id="cb63-1115"><a href="#cb63-1115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1116"><a href="#cb63-1116" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1117"><a href="#cb63-1117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1118"><a href="#cb63-1118" aria-hidden="true" tabindex="-1"></a>We find the following centered moments for the noise:</span>
<span id="cb63-1119"><a href="#cb63-1119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1120"><a href="#cb63-1120" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Mean: <span class="in">`r round(noi_mean, digits = 2)`</span></span>
<span id="cb63-1121"><a href="#cb63-1121" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Var: <span class="in">`r round(noi_var, digits = 2)`</span></span>
<span id="cb63-1122"><a href="#cb63-1122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1123"><a href="#cb63-1123" aria-hidden="true" tabindex="-1"></a>The residuals still exhibit some **heteroscedasticity** — the variance is not constant across time.</span>
<span id="cb63-1124"><a href="#cb63-1124" aria-hidden="true" tabindex="-1"></a>For instance, spikes tend to occur near the end of each year, suggesting a link with the seasonal component.</span>
<span id="cb63-1125"><a href="#cb63-1125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1126"><a href="#cb63-1126" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Noise–seasonality interaction</span></span>
<span id="cb63-1127"><a href="#cb63-1127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1128"><a href="#cb63-1128" aria-hidden="true" tabindex="-1"></a>To visualize this interaction, we can overlay the deterministic component (trend + seasonality, shifted to start at zero) onto the noise:</span>
<span id="cb63-1129"><a href="#cb63-1129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1130"><a href="#cb63-1130" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-noise-overlay-seas}</span></span>
<span id="cb63-1131"><a href="#cb63-1131" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb63-1132"><a href="#cb63-1132" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> y_noi)) <span class="sc">+</span></span>
<span id="cb63-1133"><a href="#cb63-1133" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb63-1134"><a href="#cb63-1134" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tr_lm <span class="sc">+</span> sea_lo <span class="sc">-</span> <span class="fu">min</span>(tr_lm))) <span class="sc">+</span></span>
<span id="cb63-1135"><a href="#cb63-1135" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">as_date</span>(<span class="fu">c</span>(<span class="st">"2023-12-31"</span>, <span class="st">"2024-12-31"</span>))) <span class="sc">+</span></span>
<span id="cb63-1136"><a href="#cb63-1136" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>)</span>
<span id="cb63-1137"><a href="#cb63-1137" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1138"><a href="#cb63-1138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1139"><a href="#cb63-1139" aria-hidden="true" tabindex="-1"></a>We observe a clear correlation between the amplitude of the noise and the level of the deterministic component, indicating that the noise may be multiplicative rather than purely additive.</span>
<span id="cb63-1140"><a href="#cb63-1140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1141"><a href="#cb63-1141" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Noise distribution</span></span>
<span id="cb63-1142"><a href="#cb63-1142" aria-hidden="true" tabindex="-1"></a>For now, we continue under the additive noise assumption.\</span>
<span id="cb63-1143"><a href="#cb63-1143" aria-hidden="true" tabindex="-1"></a>We visualize the noise distribution and overlay a Poisson density with parameter $\lambda = <span class="in">`r round(noi_var, digits = 2)`</span>$:</span>
<span id="cb63-1144"><a href="#cb63-1144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1145"><a href="#cb63-1145" aria-hidden="true" tabindex="-1"></a><span class="in">```{r plot-noise-histog}</span></span>
<span id="cb63-1146"><a href="#cb63-1146" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb63-1147"><a href="#cb63-1147" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">noi_pois =</span> <span class="fu">dpois</span>(<span class="fu">round</span>(y_noi <span class="sc">+</span> noi_var), <span class="at">lambda =</span> noi_var)) <span class="sc">%&gt;%</span></span>
<span id="cb63-1148"><a href="#cb63-1148" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> y_noi <span class="sc">+</span> noi_var)) <span class="sc">+</span></span>
<span id="cb63-1149"><a href="#cb63-1149" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), <span class="at">bins =</span> <span class="dv">100</span>) <span class="sc">+</span></span>
<span id="cb63-1150"><a href="#cb63-1150" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> noi_pois), <span class="at">color =</span> <span class="st">"red"</span>)</span>
<span id="cb63-1151"><a href="#cb63-1151" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1152"><a href="#cb63-1152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1153"><a href="#cb63-1153" aria-hidden="true" tabindex="-1"></a>The histogram reveals deviations from the ideal Poisson shape — consistent with the observed heteroscedasticity — reinforcing the idea that a multiplicative noise model could be a better fit for this time series.</span>
<span id="cb63-1154"><a href="#cb63-1154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1155"><a href="#cb63-1155" aria-hidden="true" tabindex="-1"></a><span class="fu">### Modeling multiplicative noise</span></span>
<span id="cb63-1156"><a href="#cb63-1156" aria-hidden="true" tabindex="-1"></a>The previous analysis indicated that the variance of the residuals (noise) increases with the magnitude of the deterministic component — suggesting that the noise is multiplicative rather than additive.</span>
<span id="cb63-1157"><a href="#cb63-1157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1158"><a href="#cb63-1158" aria-hidden="true" tabindex="-1"></a>In an additive noise model, we write:</span>
<span id="cb63-1159"><a href="#cb63-1159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1160"><a href="#cb63-1160" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-1161"><a href="#cb63-1161" aria-hidden="true" tabindex="-1"></a>y(t) = tr(t) + s(t) + \epsilon_t</span>
<span id="cb63-1162"><a href="#cb63-1162" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-1163"><a href="#cb63-1163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1164"><a href="#cb63-1164" aria-hidden="true" tabindex="-1"></a>In contrast, a multiplicative noise model assumes:</span>
<span id="cb63-1165"><a href="#cb63-1165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1166"><a href="#cb63-1166" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-1167"><a href="#cb63-1167" aria-hidden="true" tabindex="-1"></a>y(t) = <span class="co">[</span><span class="ot">tr(t) + s(t)</span><span class="co">]</span>*<span class="co">[</span><span class="ot">1 + \epsilon_t</span><span class="co">]</span></span>
<span id="cb63-1168"><a href="#cb63-1168" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-1169"><a href="#cb63-1169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1170"><a href="#cb63-1170" aria-hidden="true" tabindex="-1"></a>or equivalently,</span>
<span id="cb63-1171"><a href="#cb63-1171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1172"><a href="#cb63-1172" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-1173"><a href="#cb63-1173" aria-hidden="true" tabindex="-1"></a>\epsilon_t = \frac{y(t) - <span class="co">[</span><span class="ot">tr(t) + s(t)</span><span class="co">]</span>}{<span class="co">[</span><span class="ot">tr(t) + s(t)</span><span class="co">]</span>}</span>
<span id="cb63-1174"><a href="#cb63-1174" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-1175"><a href="#cb63-1175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1176"><a href="#cb63-1176" aria-hidden="true" tabindex="-1"></a>This formulation implies that the magnitude of the fluctuations (noise) scales with the level of the signal — a realistic assumption for many economic and natural time series.</span>
<span id="cb63-1177"><a href="#cb63-1177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1178"><a href="#cb63-1178" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Extracting multiplicative noise</span></span>
<span id="cb63-1179"><a href="#cb63-1179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1180"><a href="#cb63-1180" aria-hidden="true" tabindex="-1"></a>Let’s compute the multiplicative residuals based on our fitted deterministic component $tr(t) + s(t)$:</span>
<span id="cb63-1181"><a href="#cb63-1181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1184"><a href="#cb63-1184" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-1185"><a href="#cb63-1185" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb63-1186"><a href="#cb63-1186" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb63-1187"><a href="#cb63-1187" aria-hidden="true" tabindex="-1"></a>    <span class="at">y_det  =</span> tr_lm <span class="sc">+</span> sea_lo,</span>
<span id="cb63-1188"><a href="#cb63-1188" aria-hidden="true" tabindex="-1"></a>    <span class="at">eps_mul =</span> (y_2 <span class="sc">-</span> y_det) <span class="sc">/</span> y_det</span>
<span id="cb63-1189"><a href="#cb63-1189" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb63-1190"><a href="#cb63-1190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1191"><a href="#cb63-1191" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb63-1192"><a href="#cb63-1192" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> eps_mul)) <span class="sc">+</span></span>
<span id="cb63-1193"><a href="#cb63-1193" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb63-1194"><a href="#cb63-1194" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">as_date</span>(<span class="fu">c</span>(<span class="st">"2023-12-31"</span>, <span class="st">"2024-12-31"</span>))) <span class="sc">+</span></span>
<span id="cb63-1195"><a href="#cb63-1195" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>)</span>
<span id="cb63-1196"><a href="#cb63-1196" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1197"><a href="#cb63-1197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1198"><a href="#cb63-1198" aria-hidden="true" tabindex="-1"></a>We can now inspect whether these normalized residuals appear **homoscedastic** (i.e., constant variance) over time.</span>
<span id="cb63-1199"><a href="#cb63-1199" aria-hidden="true" tabindex="-1"></a>If the variance stabilizes, that confirms that the multiplicative model is indeed more appropriate.</span>
<span id="cb63-1200"><a href="#cb63-1200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1201"><a href="#cb63-1201" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Analyzing the multiplicative residuals</span></span>
<span id="cb63-1202"><a href="#cb63-1202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1203"><a href="#cb63-1203" aria-hidden="true" tabindex="-1"></a>Compute basic moments of the multiplicative residuals:</span>
<span id="cb63-1204"><a href="#cb63-1204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1207"><a href="#cb63-1207" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-1208"><a href="#cb63-1208" aria-hidden="true" tabindex="-1"></a>noi_mul_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(df_ts1<span class="sc">$</span>eps_mul)</span>
<span id="cb63-1209"><a href="#cb63-1209" aria-hidden="true" tabindex="-1"></a>noi_mul_var  <span class="ot">&lt;-</span> <span class="fu">var</span>(df_ts1<span class="sc">$</span>eps_mul)</span>
<span id="cb63-1210"><a href="#cb63-1210" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1211"><a href="#cb63-1211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1212"><a href="#cb63-1212" aria-hidden="true" tabindex="-1"></a>We obtain:</span>
<span id="cb63-1213"><a href="#cb63-1213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1214"><a href="#cb63-1214" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Mean: <span class="in">`r round(noi_mul_mean, 3)`</span></span>
<span id="cb63-1215"><a href="#cb63-1215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1216"><a href="#cb63-1216" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Variance: <span class="in">`r round(noi_mul_var, 3)`</span></span>
<span id="cb63-1217"><a href="#cb63-1217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1218"><a href="#cb63-1218" aria-hidden="true" tabindex="-1"></a>The mean is close to zero, as expected, and the variance is stable across time — confirming that the **scaled residuals are stationary**.</span>
<span id="cb63-1219"><a href="#cb63-1219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1220"><a href="#cb63-1220" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Distribution of multiplicative noise</span></span>
<span id="cb63-1221"><a href="#cb63-1221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1222"><a href="#cb63-1222" aria-hidden="true" tabindex="-1"></a>Next, let’s examine whether the multiplicative residuals follow a Poisson, Gaussian, or log-normal distribution.</span>
<span id="cb63-1223"><a href="#cb63-1223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1226"><a href="#cb63-1226" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-1227"><a href="#cb63-1227" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb63-1228"><a href="#cb63-1228" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> eps_mul)) <span class="sc">+</span></span>
<span id="cb63-1229"><a href="#cb63-1229" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), <span class="at">bins =</span> <span class="dv">100</span>, <span class="at">fill =</span> <span class="st">"lightblue"</span>) <span class="sc">+</span></span>
<span id="cb63-1230"><a href="#cb63-1230" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_function</span>(<span class="at">fun =</span> dnorm,</span>
<span id="cb63-1231"><a href="#cb63-1231" aria-hidden="true" tabindex="-1"></a>                  <span class="at">args =</span> <span class="fu">list</span>(<span class="at">mean =</span> noi_mul_mean, <span class="at">sd =</span> <span class="fu">sqrt</span>(noi_mul_var)),</span>
<span id="cb63-1232"><a href="#cb63-1232" aria-hidden="true" tabindex="-1"></a>                  <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb63-1233"><a href="#cb63-1233" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Distribution of Multiplicative Noise"</span>,</span>
<span id="cb63-1234"><a href="#cb63-1234" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="fu">expression</span>(epsilon[t]),</span>
<span id="cb63-1235"><a href="#cb63-1235" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Density"</span>)</span>
<span id="cb63-1236"><a href="#cb63-1236" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1237"><a href="#cb63-1237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1238"><a href="#cb63-1238" aria-hidden="true" tabindex="-1"></a>The red curve corresponds to a normal distribution fitted with the same mean and variance as the empirical residuals.\</span>
<span id="cb63-1239"><a href="#cb63-1239" aria-hidden="true" tabindex="-1"></a>If the histogram closely follows this curve, the multiplicative noise can be approximated as Gaussian — a common assumption in log-transformed time series models.</span>
<span id="cb63-1240"><a href="#cb63-1240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1241"><a href="#cb63-1241" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Alternative representation (log transformation)</span></span>
<span id="cb63-1242"><a href="#cb63-1242" aria-hidden="true" tabindex="-1"></a>Since multiplicative models can be expressed additively in the logarithmic domain, we can apply a log transformation:</span>
<span id="cb63-1243"><a href="#cb63-1243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1244"><a href="#cb63-1244" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-1245"><a href="#cb63-1245" aria-hidden="true" tabindex="-1"></a>log(y(t)) = log<span class="co">[</span><span class="ot">tr(t) + s(t)</span><span class="co">]</span> + log<span class="co">[</span><span class="ot">1 + \epsilon_t</span><span class="co">]</span></span>
<span id="cb63-1246"><a href="#cb63-1246" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-1247"><a href="#cb63-1247" aria-hidden="true" tabindex="-1"></a>For small noise $(\epsilon_t \ll 1)$, the term $\log(1 + \epsilon_t) \approx \epsilon_t$,\</span>
<span id="cb63-1248"><a href="#cb63-1248" aria-hidden="true" tabindex="-1"></a>so the model becomes approximately additive in log-space.</span>
<span id="cb63-1249"><a href="#cb63-1249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1252"><a href="#cb63-1252" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-1253"><a href="#cb63-1253" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb63-1254"><a href="#cb63-1254" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb63-1255"><a href="#cb63-1255" aria-hidden="true" tabindex="-1"></a>    <span class="at">log_y =</span> <span class="fu">log</span>(y_2),</span>
<span id="cb63-1256"><a href="#cb63-1256" aria-hidden="true" tabindex="-1"></a>    <span class="at">log_det =</span> <span class="fu">log</span>(y_det),</span>
<span id="cb63-1257"><a href="#cb63-1257" aria-hidden="true" tabindex="-1"></a>    <span class="at">log_eps =</span> log_y <span class="sc">-</span> log_det</span>
<span id="cb63-1258"><a href="#cb63-1258" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb63-1259"><a href="#cb63-1259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1260"><a href="#cb63-1260" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb63-1261"><a href="#cb63-1261" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> log_eps)) <span class="sc">+</span></span>
<span id="cb63-1262"><a href="#cb63-1262" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb63-1263"><a href="#cb63-1263" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb63-1264"><a href="#cb63-1264" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Log-Transformed Residuals (Approx. Additive)"</span>,</span>
<span id="cb63-1265"><a href="#cb63-1265" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="fu">expression</span>(<span class="fu">log</span>(epsilon[t])))</span>
<span id="cb63-1266"><a href="#cb63-1266" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1267"><a href="#cb63-1267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1268"><a href="#cb63-1268" aria-hidden="true" tabindex="-1"></a>This transformation stabilizes the variance even further and simplifies future modeling (e.g., ARIMA or state-space models).</span>
<span id="cb63-1269"><a href="#cb63-1269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1270"><a href="#cb63-1270" aria-hidden="true" tabindex="-1"></a>We obtain:</span>
<span id="cb63-1271"><a href="#cb63-1271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1272"><a href="#cb63-1272" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Mean: <span class="in">`r round(mean(df_ts1$log_eps), 3)`</span></span>
<span id="cb63-1273"><a href="#cb63-1273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1274"><a href="#cb63-1274" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Variance: <span class="in">`r round(var(df_ts1$log_eps), 3)`</span></span>
<span id="cb63-1275"><a href="#cb63-1275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1276"><a href="#cb63-1276" aria-hidden="true" tabindex="-1"></a><span class="fu">## Modeling wrap-up</span></span>
<span id="cb63-1277"><a href="#cb63-1277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1278"><a href="#cb63-1278" aria-hidden="true" tabindex="-1"></a><span class="fu">### Trend</span></span>
<span id="cb63-1279"><a href="#cb63-1279" aria-hidden="true" tabindex="-1"></a>We start by comparing the **original** and **inferred** trend parameters.</span>
<span id="cb63-1280"><a href="#cb63-1280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1281"><a href="#cb63-1281" aria-hidden="true" tabindex="-1"></a><span class="in">```{r compare-trend-orig-inferred}</span></span>
<span id="cb63-1282"><a href="#cb63-1282" aria-hidden="true" tabindex="-1"></a>y0_a   <span class="ot">&lt;-</span> lm_tr<span class="sc">$</span>coefficients[<span class="dv">1</span>] <span class="sc">+</span> (df_ts1<span class="sc">$</span>day <span class="sc">%&gt;%</span> <span class="fu">min</span>() <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()) <span class="sc">*</span> lm_tr<span class="sc">$</span>coefficients[<span class="dv">2</span>]</span>
<span id="cb63-1283"><a href="#cb63-1283" aria-hidden="true" tabindex="-1"></a>alfa_a <span class="ot">&lt;-</span> lm_tr<span class="sc">$</span>coefficients[<span class="dv">2</span>] <span class="sc">*</span> <span class="dv">365</span></span>
<span id="cb63-1284"><a href="#cb63-1284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1285"><a href="#cb63-1285" aria-hidden="true" tabindex="-1"></a><span class="fu">tribble</span>(</span>
<span id="cb63-1286"><a href="#cb63-1286" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>Trend_Parameter, <span class="sc">~</span>Original, <span class="sc">~</span>Inferred,</span>
<span id="cb63-1287"><a href="#cb63-1287" aria-hidden="true" tabindex="-1"></a>  <span class="st">"y₀"</span>,   y0_o,   y0_a,</span>
<span id="cb63-1288"><a href="#cb63-1288" aria-hidden="true" tabindex="-1"></a>  <span class="st">"α"</span>,    alfa_o, alfa_a</span>
<span id="cb63-1289"><a href="#cb63-1289" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb63-1290"><a href="#cb63-1290" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1291"><a href="#cb63-1291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1292"><a href="#cb63-1292" aria-hidden="true" tabindex="-1"></a>The inferred trend parameters are close to the original values, indicating that the linear model successfully recovered the overall trend structure.</span>
<span id="cb63-1293"><a href="#cb63-1293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1294"><a href="#cb63-1294" aria-hidden="true" tabindex="-1"></a><span class="fu">### Seasonality:</span></span>
<span id="cb63-1295"><a href="#cb63-1295" aria-hidden="true" tabindex="-1"></a>Next, we compare the original and inferred seasonal components.</span>
<span id="cb63-1296"><a href="#cb63-1296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1297"><a href="#cb63-1297" aria-hidden="true" tabindex="-1"></a><span class="in">```{r compare-season-orig-inferred}</span></span>
<span id="cb63-1298"><a href="#cb63-1298" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">%&gt;%</span></span>
<span id="cb63-1299"><a href="#cb63-1299" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> sea)) <span class="sc">+</span></span>
<span id="cb63-1300"><a href="#cb63-1300" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb63-1301"><a href="#cb63-1301" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> sea_lo), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb63-1302"><a href="#cb63-1302" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb63-1303"><a href="#cb63-1303" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Comparison of Original and Inferred Seasonality"</span>,</span>
<span id="cb63-1304"><a href="#cb63-1304" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Day"</span>,</span>
<span id="cb63-1305"><a href="#cb63-1305" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Seasonal Component"</span></span>
<span id="cb63-1306"><a href="#cb63-1306" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb63-1307"><a href="#cb63-1307" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span>
<span id="cb63-1308"><a href="#cb63-1308" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1309"><a href="#cb63-1309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1310"><a href="#cb63-1310" aria-hidden="true" tabindex="-1"></a>Here, the black curve represents the original seasonal pattern, while the red dashed curve shows the inferred seasonality.</span>
<span id="cb63-1311"><a href="#cb63-1311" aria-hidden="true" tabindex="-1"></a>The two align quite well overall, although a small phase shift can be observed — likely due to interactions between trend and noise, or numerical effects in the decomposition.</span>
<span id="cb63-1312"><a href="#cb63-1312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1313"><a href="#cb63-1313" aria-hidden="true" tabindex="-1"></a><span class="fu">### Noise</span></span>
<span id="cb63-1314"><a href="#cb63-1314" aria-hidden="true" tabindex="-1"></a>Finally, we compare the Poisson noise parameter $\lambda_t$:</span>
<span id="cb63-1315"><a href="#cb63-1315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1316"><a href="#cb63-1316" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Original: $\lambda =$ <span class="in">`r lam_0`</span></span>
<span id="cb63-1317"><a href="#cb63-1317" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Inferred: $\lambda =$ <span class="in">`r round(noi_var, digits = 2)`</span></span>
<span id="cb63-1318"><a href="#cb63-1318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1319"><a href="#cb63-1319" aria-hidden="true" tabindex="-1"></a>The inferred value is somewhat different from the true parameter, which is expected since noise estimation is often sensitive to model specification and the chosen decomposition method.</span>
<span id="cb63-1320"><a href="#cb63-1320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1321"><a href="#cb63-1321" aria-hidden="true" tabindex="-1"></a>Still, the inferred variance remains within a reasonable range.\</span>
<span id="cb63-1322"><a href="#cb63-1322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1323"><a href="#cb63-1323" aria-hidden="true" tabindex="-1"></a>In the next step, we’ll explore the case with multiplicative noise, which often provides a more realistic representation of many real-world time series.</span>
<span id="cb63-1324"><a href="#cb63-1324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1325"><a href="#cb63-1325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1326"><a href="#cb63-1326" aria-hidden="true" tabindex="-1"></a><span class="fu">### Additive vs. multiplicative noise</span></span>
<span id="cb63-1327"><a href="#cb63-1327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1328"><a href="#cb63-1328" aria-hidden="true" tabindex="-1"></a>In the additive model, the observed time series is expressed as:</span>
<span id="cb63-1329"><a href="#cb63-1329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1330"><a href="#cb63-1330" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-1331"><a href="#cb63-1331" aria-hidden="true" tabindex="-1"></a>y_t = tr(t) + s(t) + \varepsilon_t</span>
<span id="cb63-1332"><a href="#cb63-1332" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-1333"><a href="#cb63-1333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1334"><a href="#cb63-1334" aria-hidden="true" tabindex="-1"></a>where $\varepsilon_t$ represents random fluctuations around the deterministic trend–seasonality structure.</span>
<span id="cb63-1335"><a href="#cb63-1335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1336"><a href="#cb63-1336" aria-hidden="true" tabindex="-1"></a>However, if the amplitude of the noise appears to grow or shrink with the level of the signal (as we observed in our plots), a **multiplicative model** may be more appropriate:</span>
<span id="cb63-1337"><a href="#cb63-1337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1338"><a href="#cb63-1338" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-1339"><a href="#cb63-1339" aria-hidden="true" tabindex="-1"></a>y_t = <span class="co">[</span><span class="ot">tr(t) + s(t)</span><span class="co">]</span> \times (1 + \varepsilon_t)</span>
<span id="cb63-1340"><a href="#cb63-1340" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-1341"><a href="#cb63-1341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1342"><a href="#cb63-1342" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Log-transformation</span></span>
<span id="cb63-1343"><a href="#cb63-1343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1344"><a href="#cb63-1344" aria-hidden="true" tabindex="-1"></a>Taking logarithms linearizes the multiplicative model:</span>
<span id="cb63-1345"><a href="#cb63-1345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1346"><a href="#cb63-1346" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-1347"><a href="#cb63-1347" aria-hidden="true" tabindex="-1"></a>\log(y_t) = \log(tr(t) + s(t)) + \log(1 + \varepsilon_t)</span>
<span id="cb63-1348"><a href="#cb63-1348" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-1349"><a href="#cb63-1349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1350"><a href="#cb63-1350" aria-hidden="true" tabindex="-1"></a>For small noise ($\varepsilon_t \ll 1$), we can use the approximation:</span>
<span id="cb63-1351"><a href="#cb63-1351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1352"><a href="#cb63-1352" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-1353"><a href="#cb63-1353" aria-hidden="true" tabindex="-1"></a>\log(1 + \varepsilon_t) \approx \varepsilon_t</span>
<span id="cb63-1354"><a href="#cb63-1354" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-1355"><a href="#cb63-1355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1356"><a href="#cb63-1356" aria-hidden="true" tabindex="-1"></a>which means the model becomes approximately **additive in log-space**.  </span>
<span id="cb63-1357"><a href="#cb63-1357" aria-hidden="true" tabindex="-1"></a>This transformation stabilizes the variance and often results in more homogeneous residuals.</span>
<span id="cb63-1358"><a href="#cb63-1358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1359"><a href="#cb63-1359" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Procedure</span></span>
<span id="cb63-1360"><a href="#cb63-1360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1361"><a href="#cb63-1361" aria-hidden="true" tabindex="-1"></a>To assess whether the multiplicative model is better, we can follow these steps:</span>
<span id="cb63-1362"><a href="#cb63-1362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1363"><a href="#cb63-1363" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Log-transform the series**  </span>
<span id="cb63-1364"><a href="#cb63-1364" aria-hidden="true" tabindex="-1"></a>   $$</span>
<span id="cb63-1365"><a href="#cb63-1365" aria-hidden="true" tabindex="-1"></a>   y'_t = \log(y_t)</span>
<span id="cb63-1366"><a href="#cb63-1366" aria-hidden="true" tabindex="-1"></a>   $$</span>
<span id="cb63-1367"><a href="#cb63-1367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1368"><a href="#cb63-1368" aria-hidden="true" tabindex="-1"></a><span class="in">```{r log-transform}</span></span>
<span id="cb63-1369"><a href="#cb63-1369" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="ot">&lt;-</span> df_ts1 <span class="sc">|&gt;</span></span>
<span id="cb63-1370"><a href="#cb63-1370" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y_log =</span> <span class="fu">log</span>(y_2))</span>
<span id="cb63-1371"><a href="#cb63-1371" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1372"><a href="#cb63-1372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1373"><a href="#cb63-1373" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Re-estimate** trend and seasonality using the same LOESS or regression techniques on $y'_t$.</span>
<span id="cb63-1374"><a href="#cb63-1374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1377"><a href="#cb63-1377" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-1378"><a href="#cb63-1378" aria-hidden="true" tabindex="-1"></a><span class="co"># Trend estimation using linear model</span></span>
<span id="cb63-1379"><a href="#cb63-1379" aria-hidden="true" tabindex="-1"></a>lm_tr_log <span class="ot">&lt;-</span> <span class="fu">lm</span>(y_log <span class="sc">~</span> <span class="fu">as.numeric</span>(day), <span class="at">data =</span> df_ts1)</span>
<span id="cb63-1380"><a href="#cb63-1380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1381"><a href="#cb63-1381" aria-hidden="true" tabindex="-1"></a><span class="co"># Trend prediction</span></span>
<span id="cb63-1382"><a href="#cb63-1382" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="ot">&lt;-</span> df_ts1 <span class="sc">|&gt;</span></span>
<span id="cb63-1383"><a href="#cb63-1383" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tr_log =</span> <span class="fu">predict</span>(lm_tr_log))</span>
<span id="cb63-1384"><a href="#cb63-1384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1385"><a href="#cb63-1385" aria-hidden="true" tabindex="-1"></a><span class="co"># Seasonality estimation using LOESS</span></span>
<span id="cb63-1386"><a href="#cb63-1386" aria-hidden="true" tabindex="-1"></a>sea_log <span class="ot">&lt;-</span> <span class="fu">loess</span>(y_log <span class="sc">-</span> tr_log <span class="sc">~</span> <span class="fu">as.numeric</span>(day),</span>
<span id="cb63-1387"><a href="#cb63-1387" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> df_ts1,</span>
<span id="cb63-1388"><a href="#cb63-1388" aria-hidden="true" tabindex="-1"></a>                 <span class="at">span =</span> loess_span_low)</span>
<span id="cb63-1389"><a href="#cb63-1389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1390"><a href="#cb63-1390" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="ot">&lt;-</span> df_ts1 <span class="sc">|&gt;</span></span>
<span id="cb63-1391"><a href="#cb63-1391" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sea_log =</span> sea_log<span class="sc">$</span>fitted)</span>
<span id="cb63-1392"><a href="#cb63-1392" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1393"><a href="#cb63-1393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1394"><a href="#cb63-1394" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Extract residuals** in log-space:</span>
<span id="cb63-1395"><a href="#cb63-1395" aria-hidden="true" tabindex="-1"></a>   $$</span>
<span id="cb63-1396"><a href="#cb63-1396" aria-hidden="true" tabindex="-1"></a>   \varepsilon'_t = y'_t - tr'(t) - s'(t)</span>
<span id="cb63-1397"><a href="#cb63-1397" aria-hidden="true" tabindex="-1"></a>   $$</span>
<span id="cb63-1398"><a href="#cb63-1398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1401"><a href="#cb63-1401" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-1402"><a href="#cb63-1402" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="ot">&lt;-</span> df_ts1 <span class="sc">|&gt;</span></span>
<span id="cb63-1403"><a href="#cb63-1403" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">eps_log =</span> y_log <span class="sc">-</span> tr_log <span class="sc">-</span> sea_log)</span>
<span id="cb63-1404"><a href="#cb63-1404" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1405"><a href="#cb63-1405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1406"><a href="#cb63-1406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1407"><a href="#cb63-1407" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Evaluate residual properties**:</span>
<span id="cb63-1408"><a href="#cb63-1408" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Mean ≈ 0 (centered)</span>
<span id="cb63-1409"><a href="#cb63-1409" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Homoscedasticity (constant variance)</span>
<span id="cb63-1410"><a href="#cb63-1410" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Independence over time</span>
<span id="cb63-1411"><a href="#cb63-1411" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Normality (histogram or QQ-plot)</span>
<span id="cb63-1412"><a href="#cb63-1412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1415"><a href="#cb63-1415" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-1416"><a href="#cb63-1416" aria-hidden="true" tabindex="-1"></a><span class="co"># Variances of additive and multiplicative residuals</span></span>
<span id="cb63-1417"><a href="#cb63-1417" aria-hidden="true" tabindex="-1"></a>var_add <span class="ot">&lt;-</span> <span class="fu">var</span>(df_ts1<span class="sc">$</span>y_noi, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb63-1418"><a href="#cb63-1418" aria-hidden="true" tabindex="-1"></a>var_mul <span class="ot">&lt;-</span> <span class="fu">var</span>(df_ts1<span class="sc">$</span>eps_log, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb63-1419"><a href="#cb63-1419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1420"><a href="#cb63-1420" aria-hidden="true" tabindex="-1"></a><span class="fu">tribble</span>(<span class="sc">~</span>Model, <span class="sc">~</span>Residual_Variance,</span>
<span id="cb63-1421"><a href="#cb63-1421" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Additive"</span>, <span class="fu">round</span>(var_add, <span class="dv">4</span>),</span>
<span id="cb63-1422"><a href="#cb63-1422" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Multiplicative (log-space)"</span>, <span class="fu">round</span>(var_mul, <span class="dv">4</span>))</span>
<span id="cb63-1423"><a href="#cb63-1423" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1424"><a href="#cb63-1424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1425"><a href="#cb63-1425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1426"><a href="#cb63-1426" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**Compare fit metrics** between additive and multiplicative models:</span>
<span id="cb63-1427"><a href="#cb63-1427" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Residual variance</span>
<span id="cb63-1428"><a href="#cb63-1428" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>AIC / BIC (if fitting parametric trend models)</span>
<span id="cb63-1429"><a href="#cb63-1429" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Predictive performance (e.g., RMSE on holdout data)</span>
<span id="cb63-1430"><a href="#cb63-1430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1433"><a href="#cb63-1433" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-1434"><a href="#cb63-1434" aria-hidden="true" tabindex="-1"></a>df_ts1 <span class="sc">|&gt;</span></span>
<span id="cb63-1435"><a href="#cb63-1435" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(day, eps_log, y_noi) <span class="sc">|&gt;</span></span>
<span id="cb63-1436"><a href="#cb63-1436" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(y_noi, eps_log),</span>
<span id="cb63-1437"><a href="#cb63-1437" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"model_type"</span>,</span>
<span id="cb63-1438"><a href="#cb63-1438" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"residual"</span>) <span class="sc">|&gt;</span></span>
<span id="cb63-1439"><a href="#cb63-1439" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> residual, <span class="at">color =</span> model_type)) <span class="sc">+</span></span>
<span id="cb63-1440"><a href="#cb63-1440" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb63-1441"><a href="#cb63-1441" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb63-1442"><a href="#cb63-1442" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span> model_type, <span class="at">ncol =</span> <span class="dv">1</span>, <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb63-1443"><a href="#cb63-1443" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Comparison of Residuals: Additive vs. Multiplicative"</span>,</span>
<span id="cb63-1444"><a href="#cb63-1444" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Day"</span>, <span class="at">y =</span> <span class="st">"Residual"</span>, <span class="at">color =</span> <span class="st">"Model Type"</span>) <span class="sc">+</span></span>
<span id="cb63-1445"><a href="#cb63-1445" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb63-1446"><a href="#cb63-1446" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1447"><a href="#cb63-1447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1448"><a href="#cb63-1448" aria-hidden="true" tabindex="-1"></a><span class="fu">## Real case: Walmart 2010</span></span>
<span id="cb63-1449"><a href="#cb63-1449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1450"><a href="#cb63-1450" aria-hidden="true" tabindex="-1"></a>Having validated our approach on synthetic data, we now test it on **real-world data**.</span>
<span id="cb63-1451"><a href="#cb63-1451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1452"><a href="#cb63-1452" aria-hidden="true" tabindex="-1"></a><span class="fu">### Dataset</span></span>
<span id="cb63-1453"><a href="#cb63-1453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1454"><a href="#cb63-1454" aria-hidden="true" tabindex="-1"></a>We extracted data from the Walmart Kaggle competition.  </span>
<span id="cb63-1455"><a href="#cb63-1455" aria-hidden="true" tabindex="-1"></a>Here we focus on **store 2, department 2**.</span>
<span id="cb63-1456"><a href="#cb63-1456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1457"><a href="#cb63-1457" aria-hidden="true" tabindex="-1"></a><span class="in">```{r load-data}</span></span>
<span id="cb63-1458"><a href="#cb63-1458" aria-hidden="true" tabindex="-1"></a>fpath_tra <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{data_dir}/Walmart/train.csv"</span>)</span>
<span id="cb63-1459"><a href="#cb63-1459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1460"><a href="#cb63-1460" aria-hidden="true" tabindex="-1"></a>df_tra <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(fpath_tra) <span class="sc">%&gt;%</span></span>
<span id="cb63-1461"><a href="#cb63-1461" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_all</span>(tolower) <span class="sc">%&gt;%</span></span>
<span id="cb63-1462"><a href="#cb63-1462" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">is_holiday =</span> isholiday)</span>
<span id="cb63-1463"><a href="#cb63-1463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1464"><a href="#cb63-1464" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="ot">&lt;-</span> df_tra <span class="sc">%&gt;%</span></span>
<span id="cb63-1465"><a href="#cb63-1465" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(store <span class="sc">==</span> <span class="dv">2</span>, dept <span class="sc">==</span> <span class="dv">2</span>)</span>
<span id="cb63-1466"><a href="#cb63-1466" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1467"><a href="#cb63-1467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1468"><a href="#cb63-1468" aria-hidden="true" tabindex="-1"></a><span class="fu">### Inspecting the training data</span></span>
<span id="cb63-1469"><a href="#cb63-1469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1470"><a href="#cb63-1470" aria-hidden="true" tabindex="-1"></a><span class="in">```{r restrict-to-1-store-1-dpt}</span></span>
<span id="cb63-1471"><a href="#cb63-1471" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb63-1472"><a href="#cb63-1472" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">is_holiday =</span> <span class="fu">ifelse</span>(is_holiday, <span class="cn">TRUE</span>, <span class="cn">NA</span>),</span>
<span id="cb63-1473"><a href="#cb63-1473" aria-hidden="true" tabindex="-1"></a>         <span class="at">store =</span> <span class="fu">factor</span>(store)) <span class="sc">%&gt;%</span></span>
<span id="cb63-1474"><a href="#cb63-1474" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> weekly_sales)) <span class="sc">+</span> </span>
<span id="cb63-1475"><a href="#cb63-1475" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> store, <span class="at">color =</span> store)) <span class="sc">+</span> </span>
<span id="cb63-1476"><a href="#cb63-1476" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">data =</span> df_tra <span class="sc">%&gt;%</span> <span class="fu">filter</span>(is_holiday) <span class="sc">%&gt;%</span> <span class="fu">distinct</span>(date), </span>
<span id="cb63-1477"><a href="#cb63-1477" aria-hidden="true" tabindex="-1"></a>               <span class="fu">aes</span>(<span class="at">xintercept =</span> date), </span>
<span id="cb63-1478"><a href="#cb63-1478" aria-hidden="true" tabindex="-1"></a>               <span class="at">color =</span> <span class="st">"grey50"</span>, </span>
<span id="cb63-1479"><a href="#cb63-1479" aria-hidden="true" tabindex="-1"></a>               <span class="at">alpha =</span> <span class="fl">0.5</span>, </span>
<span id="cb63-1480"><a href="#cb63-1480" aria-hidden="true" tabindex="-1"></a>               <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span> </span>
<span id="cb63-1481"><a href="#cb63-1481" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span> dept, <span class="at">scale =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb63-1482"><a href="#cb63-1482" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Weekly Sales: Store 2, Department 2"</span>,</span>
<span id="cb63-1483"><a href="#cb63-1483" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb63-1484"><a href="#cb63-1484" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Weekly Sales"</span>)</span>
<span id="cb63-1485"><a href="#cb63-1485" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1486"><a href="#cb63-1486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1487"><a href="#cb63-1487" aria-hidden="true" tabindex="-1"></a>We can already see seasonal patterns, particularly spikes at the end of each year.</span>
<span id="cb63-1488"><a href="#cb63-1488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1489"><a href="#cb63-1489" aria-hidden="true" tabindex="-1"></a><span class="fu">### Year-over-year analysis</span></span>
<span id="cb63-1490"><a href="#cb63-1490" aria-hidden="true" tabindex="-1"></a>To highlight seasonal effects, we overlay data year-over-year:</span>
<span id="cb63-1491"><a href="#cb63-1491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1492"><a href="#cb63-1492" aria-hidden="true" tabindex="-1"></a><span class="in">```{r add-years}</span></span>
<span id="cb63-1493"><a href="#cb63-1493" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb63-1494"><a href="#cb63-1494" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">factor</span>(<span class="fu">year</span>(date)),</span>
<span id="cb63-1495"><a href="#cb63-1495" aria-hidden="true" tabindex="-1"></a>         <span class="at">date_no_year =</span> date) <span class="sc">%&gt;%</span></span>
<span id="cb63-1496"><a href="#cb63-1496" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(year, <span class="at">.before =</span> date)</span>
<span id="cb63-1497"><a href="#cb63-1497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1498"><a href="#cb63-1498" aria-hidden="true" tabindex="-1"></a><span class="fu">year</span>(df_tra_2<span class="sc">$</span>date_no_year) <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb63-1499"><a href="#cb63-1499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1500"><a href="#cb63-1500" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb63-1501"><a href="#cb63-1501" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date_no_year, <span class="at">y =</span> weekly_sales, <span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb63-1502"><a href="#cb63-1502" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb63-1503"><a href="#cb63-1503" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Year-over-Year Weekly Sales"</span>,</span>
<span id="cb63-1504"><a href="#cb63-1504" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Day of Year"</span>,</span>
<span id="cb63-1505"><a href="#cb63-1505" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Weekly Sales"</span>)</span>
<span id="cb63-1506"><a href="#cb63-1506" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1507"><a href="#cb63-1507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1508"><a href="#cb63-1508" aria-hidden="true" tabindex="-1"></a>Seasonality is evident, with noticeable correlations at year-end. Some mid-year dips in 2011 suggest year-specific effects.</span>
<span id="cb63-1509"><a href="#cb63-1509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1510"><a href="#cb63-1510" aria-hidden="true" tabindex="-1"></a><span class="fu">### Trend analysis</span></span>
<span id="cb63-1511"><a href="#cb63-1511" aria-hidden="true" tabindex="-1"></a>**Yearly Trend:**  </span>
<span id="cb63-1512"><a href="#cb63-1512" aria-hidden="true" tabindex="-1"></a>We first estimate the trend within each year, using both linear regression and LOESS smoothing:</span>
<span id="cb63-1513"><a href="#cb63-1513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1514"><a href="#cb63-1514" aria-hidden="true" tabindex="-1"></a><span class="in">```{r add-trend-yoy}</span></span>
<span id="cb63-1515"><a href="#cb63-1515" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb63-1516"><a href="#cb63-1516" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>(<span class="at">data =</span> <span class="sc">-</span>year) <span class="sc">%&gt;%</span></span>
<span id="cb63-1517"><a href="#cb63-1517" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb63-1518"><a href="#cb63-1518" aria-hidden="true" tabindex="-1"></a>    <span class="at">lm_tr  =</span> <span class="fu">map</span>(year, <span class="sc">~</span> <span class="fu">lm</span>(df_tra_2 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(year <span class="sc">==</span> .x), <span class="at">formula =</span> weekly_sales <span class="sc">~</span> date)),</span>
<span id="cb63-1519"><a href="#cb63-1519" aria-hidden="true" tabindex="-1"></a>    <span class="at">loes_tr =</span> <span class="fu">map</span>(year, <span class="sc">~</span> <span class="fu">loess</span>(df_tra_2 <span class="sc">%&gt;%</span> </span>
<span id="cb63-1520"><a href="#cb63-1520" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">filter</span>(year <span class="sc">==</span> .x) <span class="sc">%&gt;%</span></span>
<span id="cb63-1521"><a href="#cb63-1521" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">as.numeric</span>(date)),</span>
<span id="cb63-1522"><a href="#cb63-1522" aria-hidden="true" tabindex="-1"></a>                                <span class="at">formula =</span> weekly_sales <span class="sc">~</span> date,</span>
<span id="cb63-1523"><a href="#cb63-1523" aria-hidden="true" tabindex="-1"></a>                                <span class="at">span =</span> loess_span_high)),</span>
<span id="cb63-1524"><a href="#cb63-1524" aria-hidden="true" tabindex="-1"></a>    <span class="at">data    =</span> <span class="fu">map2</span>(data, lm_tr, <span class="sc">~</span> <span class="fu">mutate</span>(.x, <span class="at">try_lm =</span> .y<span class="sc">$</span>fitted)),</span>
<span id="cb63-1525"><a href="#cb63-1525" aria-hidden="true" tabindex="-1"></a>    <span class="at">data    =</span> <span class="fu">map2</span>(data, loes_tr, <span class="sc">~</span> <span class="fu">mutate</span>(.x, <span class="at">try_lo =</span> .y<span class="sc">$</span>fitted))</span>
<span id="cb63-1526"><a href="#cb63-1526" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb63-1527"><a href="#cb63-1527" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(lm_tr, loes_tr)) <span class="sc">%&gt;%</span></span>
<span id="cb63-1528"><a href="#cb63-1528" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(data)</span>
<span id="cb63-1529"><a href="#cb63-1529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1530"><a href="#cb63-1530" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb63-1531"><a href="#cb63-1531" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date_no_year, <span class="at">y =</span> weekly_sales, <span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb63-1532"><a href="#cb63-1532" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb63-1533"><a href="#cb63-1533" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> try_lm), <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb63-1534"><a href="#cb63-1534" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> try_lo), <span class="at">linetype =</span> <span class="st">"longdash"</span>) <span class="sc">+</span></span>
<span id="cb63-1535"><a href="#cb63-1535" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Yearly Trend: Linear vs. LOESS"</span>,</span>
<span id="cb63-1536"><a href="#cb63-1536" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Day of Year"</span>,</span>
<span id="cb63-1537"><a href="#cb63-1537" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Weekly Sales"</span>)</span>
<span id="cb63-1538"><a href="#cb63-1538" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1539"><a href="#cb63-1539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1540"><a href="#cb63-1540" aria-hidden="true" tabindex="-1"></a>The LOESS curves capture more of the seasonal variation than linear trends alone. Notice mid-year dips in 2011 that are not captured perfectly.</span>
<span id="cb63-1541"><a href="#cb63-1541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1542"><a href="#cb63-1542" aria-hidden="true" tabindex="-1"></a>**Overall Trend:**  </span>
<span id="cb63-1543"><a href="#cb63-1543" aria-hidden="true" tabindex="-1"></a>Next, we estimate a trend across the entire period:</span>
<span id="cb63-1544"><a href="#cb63-1544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1545"><a href="#cb63-1545" aria-hidden="true" tabindex="-1"></a><span class="in">```{r add-trend-overall}</span></span>
<span id="cb63-1546"><a href="#cb63-1546" aria-hidden="true" tabindex="-1"></a>lm_tr <span class="ot">&lt;-</span> <span class="fu">lm</span>(weekly_sales <span class="sc">~</span> date, <span class="at">data =</span> df_tra_2)</span>
<span id="cb63-1547"><a href="#cb63-1547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1548"><a href="#cb63-1548" aria-hidden="true" tabindex="-1"></a>lo_tr <span class="ot">&lt;-</span> <span class="fu">loess</span>(weekly_sales <span class="sc">~</span> <span class="fu">as.numeric</span>(date), <span class="at">data =</span> df_tra_2, <span class="at">span =</span> loess_span_high)</span>
<span id="cb63-1549"><a href="#cb63-1549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1550"><a href="#cb63-1550" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb63-1551"><a href="#cb63-1551" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tr_lm =</span> lm_tr<span class="sc">$</span>fitted,</span>
<span id="cb63-1552"><a href="#cb63-1552" aria-hidden="true" tabindex="-1"></a>         <span class="at">tr_lo =</span> lo_tr<span class="sc">$</span>fitted)</span>
<span id="cb63-1553"><a href="#cb63-1553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1554"><a href="#cb63-1554" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb63-1555"><a href="#cb63-1555" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> weekly_sales, <span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb63-1556"><a href="#cb63-1556" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb63-1557"><a href="#cb63-1557" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tr_lo), <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb63-1558"><a href="#cb63-1558" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tr_lm), <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb63-1559"><a href="#cb63-1559" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Overall Trend: Linear vs. LOESS"</span>,</span>
<span id="cb63-1560"><a href="#cb63-1560" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb63-1561"><a href="#cb63-1561" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Weekly Sales"</span>)</span>
<span id="cb63-1562"><a href="#cb63-1562" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1563"><a href="#cb63-1563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1564"><a href="#cb63-1564" aria-hidden="true" tabindex="-1"></a>Here, the LOESS trend better captures the variability, especially around peaks and troughs, compared to the linear fit.</span>
<span id="cb63-1565"><a href="#cb63-1565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1566"><a href="#cb63-1566" aria-hidden="true" tabindex="-1"></a><span class="fu">### Seasonality and noise analysis</span></span>
<span id="cb63-1567"><a href="#cb63-1567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1568"><a href="#cb63-1568" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 1: remove overall trend</span></span>
<span id="cb63-1569"><a href="#cb63-1569" aria-hidden="true" tabindex="-1"></a>We start by subtracting the overall trend (LOESS, with a high span) from the weekly sales to isolate the seasonal component plus noise:</span>
<span id="cb63-1570"><a href="#cb63-1570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1571"><a href="#cb63-1571" aria-hidden="true" tabindex="-1"></a><span class="in">```{r detrend-data}</span></span>
<span id="cb63-1572"><a href="#cb63-1572" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb63-1573"><a href="#cb63-1573" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">weekly_notr =</span> weekly_sales <span class="sc">-</span> tr_lo)</span>
<span id="cb63-1574"><a href="#cb63-1574" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1575"><a href="#cb63-1575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1576"><a href="#cb63-1576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1577"><a href="#cb63-1577" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 2: estimate seasonality</span></span>
<span id="cb63-1578"><a href="#cb63-1578" aria-hidden="true" tabindex="-1"></a>We compute a LOESS-smoothed curve on the detrended series to approximate seasonality, setting a **lower span** to capture finer yearly patterns:</span>
<span id="cb63-1579"><a href="#cb63-1579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1582"><a href="#cb63-1582" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-1583"><a href="#cb63-1583" aria-hidden="true" tabindex="-1"></a>sea_lo <span class="ot">&lt;-</span> <span class="fu">loess</span>(weekly_notr <span class="sc">~</span> <span class="fu">as.numeric</span>(date), <span class="at">data =</span> df_tra_2, <span class="at">span =</span> loess_span_low)</span>
<span id="cb63-1584"><a href="#cb63-1584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1585"><a href="#cb63-1585" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb63-1586"><a href="#cb63-1586" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sea_lo =</span> sea_lo<span class="sc">$</span>fitted)</span>
<span id="cb63-1587"><a href="#cb63-1587" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1588"><a href="#cb63-1588" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1589"><a href="#cb63-1589" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 3: visualize seasonality year-over-year</span></span>
<span id="cb63-1590"><a href="#cb63-1590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1593"><a href="#cb63-1593" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-1594"><a href="#cb63-1594" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb63-1595"><a href="#cb63-1595" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date_no_year, <span class="at">y =</span> weekly_notr, <span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb63-1596"><a href="#cb63-1596" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb63-1597"><a href="#cb63-1597" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> sea_lo, <span class="at">group =</span> year), <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb63-1598"><a href="#cb63-1598" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb63-1599"><a href="#cb63-1599" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Detrended Weekly Sales: Seasonality (LOESS)"</span>,</span>
<span id="cb63-1600"><a href="#cb63-1600" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Day of Year"</span>,</span>
<span id="cb63-1601"><a href="#cb63-1601" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Detrended Sales"</span>)</span>
<span id="cb63-1602"><a href="#cb63-1602" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1603"><a href="#cb63-1603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1604"><a href="#cb63-1604" aria-hidden="true" tabindex="-1"></a>We can now clearly see the yearly seasonal pattern, including spikes around holidays and end-of-year peaks.</span>
<span id="cb63-1605"><a href="#cb63-1605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1606"><a href="#cb63-1606" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 4: extract noise</span></span>
<span id="cb63-1607"><a href="#cb63-1607" aria-hidden="true" tabindex="-1"></a>Subtracting the seasonal component from the detrended series gives us the residuals (noise):</span>
<span id="cb63-1608"><a href="#cb63-1608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1611"><a href="#cb63-1611" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-1612"><a href="#cb63-1612" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb63-1613"><a href="#cb63-1613" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">weekly_noise =</span> weekly_notr <span class="sc">-</span> sea_lo)</span>
<span id="cb63-1614"><a href="#cb63-1614" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1615"><a href="#cb63-1615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1616"><a href="#cb63-1616" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 5: inspect noise properties</span></span>
<span id="cb63-1617"><a href="#cb63-1617" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1620"><a href="#cb63-1620" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-1621"><a href="#cb63-1621" aria-hidden="true" tabindex="-1"></a>noi_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(df_tra_2<span class="sc">$</span>weekly_noise, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb63-1622"><a href="#cb63-1622" aria-hidden="true" tabindex="-1"></a>noi_var  <span class="ot">&lt;-</span> <span class="fu">var</span>(df_tra_2<span class="sc">$</span>weekly_noise, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb63-1623"><a href="#cb63-1623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1624"><a href="#cb63-1624" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb63-1625"><a href="#cb63-1625" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> weekly_noise)) <span class="sc">+</span></span>
<span id="cb63-1626"><a href="#cb63-1626" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), <span class="at">bins =</span> <span class="dv">100</span>, <span class="at">fill =</span> <span class="st">"lightblue"</span>) <span class="sc">+</span></span>
<span id="cb63-1627"><a href="#cb63-1627" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb63-1628"><a href="#cb63-1628" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">"Histogram of Residual Noise</span><span class="sc">\n</span><span class="st">Mean = "</span>, <span class="fu">round</span>(noi_mean,<span class="dv">2</span>),</span>
<span id="cb63-1629"><a href="#cb63-1629" aria-hidden="true" tabindex="-1"></a>                        <span class="st">", Variance = "</span>, <span class="fu">round</span>(noi_var,<span class="dv">2</span>)),</span>
<span id="cb63-1630"><a href="#cb63-1630" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Residual Noise"</span>,</span>
<span id="cb63-1631"><a href="#cb63-1631" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Density"</span>) <span class="sc">+</span></span>
<span id="cb63-1632"><a href="#cb63-1632" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span>
<span id="cb63-1633"><a href="#cb63-1633" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1634"><a href="#cb63-1634" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1635"><a href="#cb63-1635" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 6: overlay noise vs. deterministic component</span></span>
<span id="cb63-1636"><a href="#cb63-1636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1639"><a href="#cb63-1639" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-1640"><a href="#cb63-1640" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb63-1641"><a href="#cb63-1641" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> weekly_noise)) <span class="sc">+</span></span>
<span id="cb63-1642"><a href="#cb63-1642" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> year), <span class="at">alpha =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb63-1643"><a href="#cb63-1643" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> tr_lo <span class="sc">+</span> sea_lo <span class="sc">-</span> <span class="fu">min</span>(tr_lo)), <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb63-1644"><a href="#cb63-1644" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb63-1645"><a href="#cb63-1645" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Residual Noise vs. Deterministic Component"</span>,</span>
<span id="cb63-1646"><a href="#cb63-1646" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb63-1647"><a href="#cb63-1647" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Residual Noise"</span>) <span class="sc">+</span></span>
<span id="cb63-1648"><a href="#cb63-1648" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span>
<span id="cb63-1649"><a href="#cb63-1649" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1650"><a href="#cb63-1650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1651"><a href="#cb63-1651" aria-hidden="true" tabindex="-1"></a>This helps check whether noise amplitude scales with signal, which would indicate multiplicative effects.</span>
<span id="cb63-1652"><a href="#cb63-1652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1653"><a href="#cb63-1653" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 7: normalize noise by deterministic component</span></span>
<span id="cb63-1654"><a href="#cb63-1654" aria-hidden="true" tabindex="-1"></a>Compute a relative noise, dividing the residual by the deterministic component (trend + seasonality):</span>
<span id="cb63-1655"><a href="#cb63-1655" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1658"><a href="#cb63-1658" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-1659"><a href="#cb63-1659" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb63-1660"><a href="#cb63-1660" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">deterministic =</span> tr_lo <span class="sc">+</span> sea_lo,</span>
<span id="cb63-1661"><a href="#cb63-1661" aria-hidden="true" tabindex="-1"></a>         <span class="at">rel_noise =</span> weekly_noise <span class="sc">/</span> deterministic)</span>
<span id="cb63-1662"><a href="#cb63-1662" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1663"><a href="#cb63-1663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1664"><a href="#cb63-1664" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>This gives an approximate multiplicative residual, which should have roughly constant variance if the multiplicative model is appropriate.</span>
<span id="cb63-1665"><a href="#cb63-1665" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1666"><a href="#cb63-1666" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Values are interpretable as “fractional deviation from expected sales.</span>
<span id="cb63-1667"><a href="#cb63-1667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1668"><a href="#cb63-1668" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 8: compare additive vs. multiplicative noise variance</span></span>
<span id="cb63-1669"><a href="#cb63-1669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1672"><a href="#cb63-1672" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-1673"><a href="#cb63-1673" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute standard deviation</span></span>
<span id="cb63-1674"><a href="#cb63-1674" aria-hidden="true" tabindex="-1"></a>additive_var <span class="ot">&lt;-</span> <span class="fu">var</span>(df_tra_2<span class="sc">$</span>weekly_noise, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb63-1675"><a href="#cb63-1675" aria-hidden="true" tabindex="-1"></a>multiplicative_var <span class="ot">&lt;-</span> <span class="fu">var</span>(df_tra_2<span class="sc">$</span>rel_noise, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb63-1676"><a href="#cb63-1676" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1677"><a href="#cb63-1677" aria-hidden="true" tabindex="-1"></a><span class="fu">tribble</span>(</span>
<span id="cb63-1678"><a href="#cb63-1678" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>model, <span class="sc">~</span>residual_variance,</span>
<span id="cb63-1679"><a href="#cb63-1679" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Additive"</span>, additive_var,</span>
<span id="cb63-1680"><a href="#cb63-1680" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Multiplicative"</span>, multiplicative_var</span>
<span id="cb63-1681"><a href="#cb63-1681" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb63-1682"><a href="#cb63-1682" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1683"><a href="#cb63-1683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1684"><a href="#cb63-1684" aria-hidden="true" tabindex="-1"></a>Since the multiplicative variance is smaller, the multiplicative model stabilizes the residuals.</span>
<span id="cb63-1685"><a href="#cb63-1685" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1686"><a href="#cb63-1686" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 9: visualize relative noise over time</span></span>
<span id="cb63-1687"><a href="#cb63-1687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1690"><a href="#cb63-1690" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-1691"><a href="#cb63-1691" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb63-1692"><a href="#cb63-1692" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> rel_noise, <span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb63-1693"><a href="#cb63-1693" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb63-1694"><a href="#cb63-1694" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb63-1695"><a href="#cb63-1695" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Relative (Multiplicative) Residuals"</span>,</span>
<span id="cb63-1696"><a href="#cb63-1696" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb63-1697"><a href="#cb63-1697" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Fractional Residual"</span>)</span>
<span id="cb63-1698"><a href="#cb63-1698" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1699"><a href="#cb63-1699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1700"><a href="#cb63-1700" aria-hidden="true" tabindex="-1"></a>This highlights whether the multiplicative model reduces the amplitude variation over the year.</span>
<span id="cb63-1701"><a href="#cb63-1701" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1702"><a href="#cb63-1702" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 10: histogram and normality check</span></span>
<span id="cb63-1703"><a href="#cb63-1703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1706"><a href="#cb63-1706" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-1707"><a href="#cb63-1707" aria-hidden="true" tabindex="-1"></a>rel_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(df_tra_2<span class="sc">$</span>rel_noise, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb63-1708"><a href="#cb63-1708" aria-hidden="true" tabindex="-1"></a>rel_var  <span class="ot">&lt;-</span> <span class="fu">var</span>(df_tra_2<span class="sc">$</span>rel_noise, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb63-1709"><a href="#cb63-1709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1710"><a href="#cb63-1710" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb63-1711"><a href="#cb63-1711" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> rel_noise)) <span class="sc">+</span></span>
<span id="cb63-1712"><a href="#cb63-1712" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), <span class="at">bins =</span> <span class="dv">100</span>, <span class="at">fill =</span> <span class="st">"lightblue"</span>) <span class="sc">+</span></span>
<span id="cb63-1713"><a href="#cb63-1713" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb63-1714"><a href="#cb63-1714" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">"Histogram of Relative Noise</span><span class="sc">\n</span><span class="st">Mean = "</span>, <span class="fu">round</span>(rel_mean,<span class="dv">2</span>),</span>
<span id="cb63-1715"><a href="#cb63-1715" aria-hidden="true" tabindex="-1"></a>                        <span class="st">", Variance = "</span>, <span class="fu">round</span>(rel_var,<span class="dv">2</span>)),</span>
<span id="cb63-1716"><a href="#cb63-1716" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Relative Residual"</span>,</span>
<span id="cb63-1717"><a href="#cb63-1717" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Density"</span>)</span>
<span id="cb63-1718"><a href="#cb63-1718" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1719"><a href="#cb63-1719" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1720"><a href="#cb63-1720" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 11: log-transform for multiplicative model</span></span>
<span id="cb63-1721"><a href="#cb63-1721" aria-hidden="true" tabindex="-1"></a>Another way to handle multiplicative noise is to log-transform the data, which converts multiplicative effects into additive ones:</span>
<span id="cb63-1722"><a href="#cb63-1722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1725"><a href="#cb63-1725" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-1726"><a href="#cb63-1726" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&lt;&gt;%</span></span>
<span id="cb63-1727"><a href="#cb63-1727" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">log_weekly =</span> <span class="fu">log</span>(weekly_sales),</span>
<span id="cb63-1728"><a href="#cb63-1728" aria-hidden="true" tabindex="-1"></a>         <span class="at">log_tr_lo  =</span> <span class="fu">log</span>(tr_lo),</span>
<span id="cb63-1729"><a href="#cb63-1729" aria-hidden="true" tabindex="-1"></a>         <span class="at">log_resid  =</span> log_weekly <span class="sc">-</span> log_tr_lo)</span>
<span id="cb63-1730"><a href="#cb63-1730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1731"><a href="#cb63-1731" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb63-1732"><a href="#cb63-1732" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> log_weekly, <span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb63-1733"><a href="#cb63-1733" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb63-1734"><a href="#cb63-1734" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> log_tr_lo), <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb63-1735"><a href="#cb63-1735" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb63-1736"><a href="#cb63-1736" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Log-Transformed Weekly Sales with LOESS Trend"</span>,</span>
<span id="cb63-1737"><a href="#cb63-1737" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb63-1738"><a href="#cb63-1738" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"log(Weekly Sales)"</span></span>
<span id="cb63-1739"><a href="#cb63-1739" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb63-1740"><a href="#cb63-1740" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1741"><a href="#cb63-1741" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1742"><a href="#cb63-1742" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 12: examine the log residuals</span></span>
<span id="cb63-1743"><a href="#cb63-1743" aria-hidden="true" tabindex="-1"></a>Visualize the residuals in log-space to check if they’re roughly centered around zero and stationary.</span>
<span id="cb63-1744"><a href="#cb63-1744" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1747"><a href="#cb63-1747" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-1748"><a href="#cb63-1748" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb63-1749"><a href="#cb63-1749" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> log_resid, <span class="at">color =</span> year)) <span class="sc">+</span></span>
<span id="cb63-1750"><a href="#cb63-1750" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb63-1751"><a href="#cb63-1751" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb63-1752"><a href="#cb63-1752" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb63-1753"><a href="#cb63-1753" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Residuals in Log-Space (Multiplicative Noise)"</span>,</span>
<span id="cb63-1754"><a href="#cb63-1754" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb63-1755"><a href="#cb63-1755" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="fu">expression</span>(<span class="fu">log</span>(epsilon[t]))</span>
<span id="cb63-1756"><a href="#cb63-1756" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb63-1757"><a href="#cb63-1757" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1758"><a href="#cb63-1758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1759"><a href="#cb63-1759" aria-hidden="true" tabindex="-1"></a>If the multiplicative model is appropriate, the residuals should have:  </span>
<span id="cb63-1760"><a href="#cb63-1760" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>constant variance over time, and</span>
<span id="cb63-1761"><a href="#cb63-1761" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>no clear seasonal pattern.</span>
<span id="cb63-1762"><a href="#cb63-1762" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1763"><a href="#cb63-1763" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 13: distribution of log residuals</span></span>
<span id="cb63-1764"><a href="#cb63-1764" aria-hidden="true" tabindex="-1"></a>Check the shape of the distribution (for normality):</span>
<span id="cb63-1765"><a href="#cb63-1765" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1768"><a href="#cb63-1768" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-1769"><a href="#cb63-1769" aria-hidden="true" tabindex="-1"></a>log_resid_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(df_tra_2<span class="sc">$</span>log_resid, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb63-1770"><a href="#cb63-1770" aria-hidden="true" tabindex="-1"></a>log_resid_var  <span class="ot">&lt;-</span> <span class="fu">var</span>(df_tra_2<span class="sc">$</span>log_resid, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb63-1771"><a href="#cb63-1771" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1772"><a href="#cb63-1772" aria-hidden="true" tabindex="-1"></a>df_tra_2 <span class="sc">%&gt;%</span></span>
<span id="cb63-1773"><a href="#cb63-1773" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> log_resid)) <span class="sc">+</span></span>
<span id="cb63-1774"><a href="#cb63-1774" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), <span class="at">bins =</span> <span class="dv">100</span>, <span class="at">fill =</span> <span class="st">"lightblue"</span>) <span class="sc">+</span></span>
<span id="cb63-1775"><a href="#cb63-1775" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_function</span>(<span class="at">fun =</span> dnorm,</span>
<span id="cb63-1776"><a href="#cb63-1776" aria-hidden="true" tabindex="-1"></a>                  <span class="at">args =</span> <span class="fu">list</span>(<span class="at">mean =</span> log_resid_mean, <span class="at">sd =</span> <span class="fu">sqrt</span>(log_resid_var)),</span>
<span id="cb63-1777"><a href="#cb63-1777" aria-hidden="true" tabindex="-1"></a>                  <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb63-1778"><a href="#cb63-1778" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb63-1779"><a href="#cb63-1779" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Distribution of Log Residuals (Multiplicative Model)"</span>,</span>
<span id="cb63-1780"><a href="#cb63-1780" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="fu">expression</span>(<span class="fu">log</span>(epsilon[t])),</span>
<span id="cb63-1781"><a href="#cb63-1781" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Density"</span></span>
<span id="cb63-1782"><a href="#cb63-1782" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb63-1783"><a href="#cb63-1783" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1784"><a href="#cb63-1784" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1785"><a href="#cb63-1785" aria-hidden="true" tabindex="-1"></a>If the histogram closely follows the red curve (normal fit), the multiplicative model provides a valid Gaussian approximation in log-space.</span>
<span id="cb63-1786"><a href="#cb63-1786" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1787"><a href="#cb63-1787" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Step 14: quantitative comparison with additive model</span></span>
<span id="cb63-1788"><a href="#cb63-1788" aria-hidden="true" tabindex="-1"></a>To summarize model performance, compare residual moments and normality:</span>
<span id="cb63-1789"><a href="#cb63-1789" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1792"><a href="#cb63-1792" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-1793"><a href="#cb63-1793" aria-hidden="true" tabindex="-1"></a><span class="fu">tribble</span>(</span>
<span id="cb63-1794"><a href="#cb63-1794" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>Criterion, <span class="sc">~</span>Additive_Model, <span class="sc">~</span>Multiplicative_Model,</span>
<span id="cb63-1795"><a href="#cb63-1795" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Mean"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(df_tra_2<span class="sc">$</span>weekly_noise, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">4</span>), <span class="fu">round</span>(<span class="fu">mean</span>(df_tra_2<span class="sc">$</span>log_resid, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">4</span>),</span>
<span id="cb63-1796"><a href="#cb63-1796" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Variance"</span>, <span class="fu">round</span>(<span class="fu">var</span>(df_tra_2<span class="sc">$</span>weekly_noise, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">4</span>), <span class="fu">round</span>(<span class="fu">var</span>(df_tra_2<span class="sc">$</span>log_resid, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">4</span>),</span>
<span id="cb63-1797"><a href="#cb63-1797" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Shapiro-Wilk p-value"</span>,</span>
<span id="cb63-1798"><a href="#cb63-1798" aria-hidden="true" tabindex="-1"></a>  <span class="fu">signif</span>(<span class="fu">shapiro.test</span>(df_tra_2<span class="sc">$</span>weekly_noise)<span class="sc">$</span>p.value, <span class="dv">3</span>),</span>
<span id="cb63-1799"><a href="#cb63-1799" aria-hidden="true" tabindex="-1"></a>  <span class="fu">signif</span>(<span class="fu">shapiro.test</span>(df_tra_2<span class="sc">$</span>log_resid)<span class="sc">$</span>p.value, <span class="dv">3</span>)</span>
<span id="cb63-1800"><a href="#cb63-1800" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb63-1801"><a href="#cb63-1801" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1802"><a href="#cb63-1802" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1803"><a href="#cb63-1803" aria-hidden="true" tabindex="-1"></a></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>